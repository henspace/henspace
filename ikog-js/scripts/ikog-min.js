var iKogBanner="<pre>"+"         _ _                     _     <br>"+"        (_) | _____   __ _      (_)___ <br>"+"        | | |/ / _ \\ / _` |_____| / __|<br>"+"        | |   &lt; (_) | (_| |_____| \\__ \\<br>"+"        |_|_|\\_\\___/ \\__, |    _/ |___/<br>"+"                     |___/    |__/     <br>"+"<br>"+"  _ _     _                                     <br>"+" (_) |_  | | _____  ___ _ __  ___    ___  _ __  <br>"+" | | __| | |/ / _ \\/ _ \\ '_ \\/ __|  / _ \\| '_ \\ <br>"+" | | |_  |   &lt;  __/  __/ |_) \\__ \\ | (_) | | | |<br>"+" |_|\\__| |_|\\_\\___|\\___| .__/|___/  \\___/|_| |_|<br>"+"                       |_|                      <br>"+"       __ _ _ __ _____      _(_)_ __   __ _ <br>"+"      / _` | '__/ _ \\ \\ /\\ / / | '_ \\ / _` |<br>"+"     | (_| | | | (_) \\ V  V /| | | | | (_| |<br>"+"      \\__, |_|  \\___/ \\_/\\_/ |_|_| |_|\\__, |<br>"+"      |___/                           |___/ <br>"+"</pre><br>";function Confirm(a){this.fun=null;}Confirm.prototype=new Executable();Confirm.constructor=Confirm;Confirm.prototype.process=function(a){if(/^\s*y(es)?\s*$/i.test(a)){if(this.funYes){this.funYes();}}else{if(this.funNo){this.funNo();}}this.exit();};Confirm.prototype.yesOrNo=function(c,a,b){this.funYes=a;this.funNo=b;this.run();terminal.print(c+" Yes or No?");};Confirm.prototype.wait=function(a,b){this.funYes=this.funNo=b;this.run();terminal.print(a);};function DropboxStore(){this.userName="anon";this.client=null;}DropboxStore.prototype.getUserName=function(b){var a=this;this.client.getUserInfo(function(d,c){if(d){a.showError("Error retrieving user name.",d);a.userName="anon";}else{a.userName=c.name;}if(b){b(a.userName);}});};DropboxStore.prototype.init=function(){try{this.client=new Dropbox.Client({key:"1818eal0lg8dy9t",sandbox:true});var b=location.href.replace("ikog-js.html","oauth_receiver.html");this.client.authDriver(new Dropbox.AuthDriver.Popup({receiverUrl:b}));this.client.authenticate({interactive:false});if(!this.client.isAuthenticated()){this.auth(function(c){return c;});}}catch(a){terminal.error("Unable to initialise Dropbox. On IE you need to use https.");return false;}return true;};DropboxStore.prototype.auth=function(c){console.log("DropboxStore auth");var b=this;try{this.client.authenticate(function(d){if(d){b.showError("Authentication error.",d);}if(c){c(d?false:true);}});}catch(a){terminal.error("Unable to authenticate the application. Use Firefox or Chrome.");if(c){c(false);}}};DropboxStore.prototype.showError=function(b,a){switch(a.status){case 401:terminal.error(b+" Looks like your user token expired. Refresh the page.");break;case 404:terminal.error(b+" The file does not exist.");break;case 507:terminal.error(b+" You are over your Dropbox quota. i.e it's full.");break;case 503:terminal.error(b+" Too many api calls to Dropbox. Try again later.");break;case 400:case 403:case 405:default:terminal.error(b+" Hmm.That's gone wrong. Try refreshing the page.");}};DropboxStore.prototype.load=function(a,c){var b=this;this.client.readFile(a,function(d,e){if(d){b.showError("Error loading "+a+".",d);e=null;}if(c){c(e);}});};DropboxStore.prototype.save=function(a,b,d){var c=this;this.client.writeFile(a,b,function(e,f){if(e){c.showError("Error writing "+a+".",e);}if(d){d(e?false:true);}});};DropboxStore.prototype.signOut=function(b){var a=this;this.client.signOut(function(c){if(c){a.showError("Error signing out.",c);}if(b){b(c?false:true);}});};DropboxStore.prototype.readDir=function(b){var a=this;this.client.readdir("/",function(d,c){if(d){a.showError(d);c=null;}if(b){b(c);}});};var JsonFormatter={stringify:function(a){var b={ct:a.ciphertext.toString(CryptoJS.enc.Base64)};if(a.iv){b.iv=a.iv.toString();}if(a.salt){b.s=a.salt.toString();}return JSON.stringify(b);},parse:function(a){var c=JSON.parse(a);var b=CryptoJS.lib.CipherParams.create({ciphertext:CryptoJS.enc.Base64.parse(c.ct)});if(c.iv){b.iv=CryptoJS.enc.Hex.parse(c.iv);}if(c.s){b.salt=CryptoJS.enc.Hex.parse(c.s);}return b;}};function Encryptor(){this.match=null;this.state=Encryptor.States.IDLE;this.passphrase=null;}Encryptor.prototype=new Executable();Encryptor.constructor=Encryptor;Encryptor.TAG="<secret>";Encryptor.States={IDLE:0,WAITING_KEY:1,WAITING_KEY_2:2};Encryptor.prototype.process=function(a){switch(this.state){case Encryptor.States.IDLE:if(this.match=a.match(/(.*)&lt;(?:private|p|secret|s)&gt;(.*)/i)){this.state=Encryptor.States.WAITING_KEY;this.run(null);terminal.print("Enter your passphrase.");terminal.enterPassword(true);return null;}break;case Encryptor.States.WAITING_KEY:this.passphrase=a;this.state=Encryptor.States.WAITING_KEY_2;terminal.print("Re-enter your passphrase.");return null;break;case Encryptor.States.WAITING_KEY_2:if(a!=this.passphrase){terminal.print("Passwords don't match. Try again. Enter your passphrase.");this.state=Encryptor.States.WAITING_KEY;return null;}this.state=Encryptor.States.IDLE;terminal.enterPassword(false);this.exit(this.match[1]+Encryptor.TAG+CryptoJS.AES.encrypt(this.match[2],this.passphrase,{format:JsonFormatter}).toString());}return a;};Decryptor.States={IDLE:0,WAITING_KEY:1,WAITING_END:2};Decryptor.prototype=new Executable();Decryptor.constructor=Decryptor;function Decryptor(){this.state=Decryptor.States.IDLE;this.task=null;this.passphrase;this.index=0;this.callback=null;}Decryptor.prototype.getTask=function(){return this.task;};Decryptor.prototype.getIndex=function(){return this.index;};Decryptor.prototype.getSecret=function(){if(this.task&&this.task.secret){return CryptoJS.AES.decrypt(this.task.secret,this.passphrase,{format:JsonFormatter}).toString(CryptoJS.enc.Utf8);}return"No secrets";};Decryptor.prototype.setTask=function(b,a){this.id=b;this.task=a;};Decryptor.prototype.show=function(){terminal.mark();terminal.print(new TaskRenderer(this.id,this.task).verbose(this.getSecret()));terminal.print("Press Enter to clear the secret.");};Decryptor.prototype.process=function(a){switch(this.state){case Decryptor.States.IDLE:if(typeof(a)=="function"){this.callback=a;console.log("Set callback "+a);}else{console.log("Typeof data = "+typeof(a));this.callback=null;}if(this.task&&this.task.secret){this.state=Decryptor.States.WAITING_KEY;this.run(null);terminal.print("Enter your passphrase.");terminal.enterPassword(true);return null;}else{terminal.print("Nothing secret to show.");}break;case Decryptor.States.WAITING_KEY:this.state=Decryptor.States.WAITING_END;this.passphrase=a;terminal.enterPassword(false);console.log("Callback"+this.callback);if(this.callback){console.log("Call the callback");this.callback(this.getSecret());this.task=null;this.passphrase=null;this.exit();this.state=Decryptor.States.IDLE;}else{this.show();}break;case Decryptor.States.WAITING_END:terminal.clearToMark();this.task=null;this.passphrase=null;this.exit();this.state=Decryptor.States.IDLE;break;}return a;};function Executable(){this.oldShell=null;this.caller=null;}Executable.prototype.setCaller=function(a){this.caller=a;};Executable.prototype.run=function(){terminal.runningCommand(true);this.oldShell=terminal.setShell(this);};Executable.prototype.exit=function(a){terminal.runningCommand(false);if(this.oldShell){terminal.setShell(this.oldShell);}if(this.caller&&this.caller.process){this.caller.process(a);}};function Exporter(b){this.fileField=b;var a=this;$(b+"Cancel").click(function(){a._showImporter(false);});$(this.fileField).change(function(c){console.log(c.target.files);if(c.target.files.length<1){a._showImporter(false);terminal.error("No file selected for import.");}else{a.doImport(c.target.files[0]);}});}Exporter.prototype.exportTasks=function(b){var c=JSON.stringify(b);var a="data:application/x-ikog-js,"+encodeURIComponent(c);window.open(a,"_blank");terminal.print("Export complete. NB. If you weren't presented with a "+"download dialog, this probably hasn't worked. IE users beware ;)");};Exporter.prototype.importTasks=function(a){if(!window.FileReader){teminal.error("Sorry but your browser doesn't support this feature.");return;}this.nvm=a;this._showImporter(true);$(this.fileField).click();};Exporter.prototype.doImport=function(b){terminal.print("Importing "+b.name);var c=this;var a=new FileReader();a.onload=function(){c._showImporter(false);console.log(a.result);try{var e=JSON.parse(decodeURIComponent(a.result));if(!e||!e.tasks||!e.abbreviations){terminal.error("Sorry. I couldn't understand the file.");}else{c.nvm.tasks.addTasks(e.tasks.tasks);c.nvm.abbreviations.merge(e.abbreviations.aliases);ikog.setDirty(true);terminal.print("Tasks and abbreviations have been imported.");}}catch(d){terminal.error("Sorry. I couldn't parse the imported file. "+d.message);}};a.onerror=function(){terminal.error("Sorry. A problem occurred trying to import the file.");c._showImporter(false);};a.readAsText(b);};Exporter.prototype._showImporter=function(a){if(a){terminal.block(true);$("#fileImportContainer").show();}else{terminal.block(false);$("#fileImportContainer").hide();}};Exporter.prototype.endImport=function(){$(this.fileField).hide();};function Filter(b,a){this.setFilter(b,a);}Filter.prototype.getName=function(){return this.name;};Filter.prototype.getFilter=function(){return this.filter;};Filter.States={"AND":0,"OR":1,"NOT":2};Filter.prototype._buildFilters=function(b){var f=b.match(/(\S+)/g);var d=Filter.States.AND;var c=[[],[],[]];for(var a=0;a<f.length;a++){var e=f[a].trim();if(/^and$/i.test(f[a])){d=Filter.States.AND;}else{if(/^or$/i.test(f[a])){d=Filter.States.OR;}else{if(/^not$/i.test(f[a])){d=Filter.States.NOT;}else{c[d].push(f[a]);}}}}return c;};Filter.prototype.setFilter=function(b,a){this.filter=b||"";this.name=a||b;this.filterTask=null;this.filterNotTask=null;this.filterOrTask=null;if(this.filter==""){return;}var c=this._buildFilters(this.filter);this.filterTask=c[Filter.States.AND].length>0?new Task(c[Filter.States.AND].join(" "),true):null;this.filterOrTask=c[Filter.States.OR].length>0?new Task(c[Filter.States.OR].join(" "),true):null;this.filterNotTask=c[Filter.States.NOT].length>0?new Task(c[Filter.States.NOT].join(" "),true):null;};Filter.prototype.isActive=function(){return this.filterTask!=null||this.filterOrTask!=null||this.filterNotTask!=null;};Filter.prototype.isViewable=function(a){return(this._testIsViewableAnd(this.filterTask,a,false)&&this._testIsViewableAnd(this.filterNotTask,a,true))||this._testIsViewableOr(this.filterOrTask,a);};Filter.prototype.test=function(a,b){return b?!a:a;};Filter.prototype.areDatesEqual=function(b,a){var d=b?Math.round(b.getTime()/1000):0;var c=a?Math.round(a.getTime()/1000):0;return d==c;};Filter.prototype._testIsViewableOr=function(b,a){if(b==null){return false;}if(b.dueDate){if(this.areDatesEqual(a.dueDate,b.dueDate)){return true;}}if(b.contexts&&b.contexts.length>0){if(this.contains(a.contexts,b.contexts)){return true;}}if(b.projects&&b.projects.length>0){if(this.contains(a.projects,b.projects)){return true;}}var c=b.content.match(/\S+/g);var d=a.content.match(/\S+/g);if(c&&c.length>0&&c[0].length>0&&this.contains(d,c)){return true;}return false;};Filter.prototype._testIsViewableAnd=function(b,a,e){if(b==null){return true;}if(b.dueDate){if(this.test(!(this.areDatesEqual(a.dueDate,b.dueDate)),e)){return false;}}if(b.contexts&&b.contexts.length>0){if(this.test(!this.contains(a.contexts,b.contexts),e)){return false;}}if(b.projects&&b.projects.length>0){if(this.test(!this.contains(a.projects,b.projects),e)){return false;}}var c=b.content.match(/\S+/g);var d=a.content.match(/\S+/g);if(c&&c.length>0&&c[0].length>0&&this.test(!this.contains(d,c),e)){return false;}return true;};Filter.prototype.contains=function(c,b){for(var a=0;a<b.length;a++){if(c.indexOf(b[a])<0){return false;}}return true;};function FilterRenderer(a){this.filter=a;}FilterRenderer.prototype.render=function(b){var a="";if(this.filter.getFilter()){a+="<div class='"+(b?"terse-filter":"filter")+"'>"+this.filter.getName()+"</div>";}return a;};function GtdTimer(a){this.min=a;}GtdTimer.prototype.start=function(b){var a="iKog timeout. "+this.min+" minutes have elapsed.";window.setTimeout(function(){terminal.mark();terminal.print("<div class='timeout'>"+a+"</div>");new Confirm().wait("Press any key to acknowledge.",function(){terminal.clearToMark();});if(b){b();}},this.min*60000);};function Collection(){this.items=[];}Collection.prototype.add=function(b){if(typeof b==="string"){if(this.items.indexOf(b)<0){this.items.push(b);}}else{for(var a=0;a<b.length;a++){if(this.items.indexOf(b[a])<0){this.items.push(b[a]);}}}};Collection.prototype.getItems=function(){return this.items;};Collection.prototype.get=function(a){return this.items[a];};Collection.prototype.sort=function(a){this.items.sort(a);};function Alias(a){if(a.aliases){this.aliases=a.aliases;}else{this.aliases=a||{};}}Alias.prototype.remove=function(a){a=a.toUpperCase();if(a in this.aliases){delete this.aliases[a];}};Alias.prototype.add=function(a,b){a=a.toUpperCase();if(b==""&&(a in this.aliases)){delete this.aliases[a];}else{this.aliases[a]=b;}};Alias.prototype.get=function(a){akey=a.toUpperCase();if(akey in this.aliases){return this.aliases[akey];}return a;};Alias.prototype.apply=function(b){if(typeof b==="string"){var c=this;return b.replace(/\S+/g,function(d){return c.get(d);});}else{for(var a in b){b[a]=this.get(b[a]);}return b;}};Alias.prototype.merge=function(a){for(al in a){this.add(al,a[al]);}};function AliasesRenderer(a){this.aliases=a.aliases;}AliasesRenderer.prototype.render=function(){var a="<ul class = 'alias-list bullet-free'>";for(al in this.aliases){a+="<li><span>"+al+"</span><span>"+this.aliases[al]+"</span></li>";}a+="</ul>";return a;};var iKogAboutText="<p>iKog is a deceptively powerful task list manager. It is a rewrite of my "+"original Python application but now in Javascript to allow it to run in "+"your browser.</p>"+"<p>Tasks can either be stored locally using the HTML5 localStorage, or you "+"can use Dropbox to store your tasks. If you want to find out about me "+"or what I'm currently up to, just enter <b>WEB</b> or follow me on twitter "+"@henspace.<p>"+"<ul>"+"<li>To read up on how to use iKog, enter <b>HELP ONLINE</b>."+"<li>To list all commands, enter <b>COMMANDS</b>."+"<li>To get help on a particular command, enter <b>HELP</b> followed by the command."+"</ul>";var iKogHelpIndex={"+":"add","a":"add","ab":"abbrev","as":"autosave","cls":"clearscreen","console":"console","d":"down","e":"extend","ed":"edit","f":"first","fi":"filter","g":"go","i":"immediate","k":"kill","++":"immediate","list":"list","ls":"dir","m":"mod","modify":"mod","notes":"note","n":"next","rev":"review","v0":"review","v1":"review","r":"rep","replace":"rep","sh":"show","t":"top","x":"kill",".":"this","^":"this","u":"up","logoff":"signout"};var iKogHelpText={"2":"Start a two minute timer after which a flashing message will appear.","add":"Add a task using one of the following methods:"+"<ul>"+"<li>ADD Phone up John tonight"+"<li>A Phone up John tonight"+"<li>+ Phone up John tonight"+"</ul>","abbrev":"Create your own abbreviations as follows:"+"<ul>"+"<li>ABBREV abbreviation replacement text"+"<li>AB abbreviation replacement text"+"<li>AB me Steve <em>replace me with Steve</em>"+"<li>AB ? <em>list all available abbreviations</em>"+"</ul>","autosave":"Switch autosave on or off. Note that autosave is not efficient "+"when using Dropbox and it may be faster to switch it off and manually "+"save your tasks using the SAVE command."+"<ul>"+"<li>AUTOSAVE ON"+"<li>AS ON <em>switch autosave on</em>"+"<li>AUTOSAVE OFF"+"<li>AS OFF <em>switch autosave off</em>"+"</ul>","clear":"Clear all tasks."+"<ul>"+"<li>CLEAR"+"</ul","clearscreen":"Clear the screen"+"<ul>"+"<li>CLEARSCREEN"+"<li>CLS"+"</ul","commands":"List all the available commands"+"<ul>"+"<li>COMMANDS"+"</ul>","console":"Switch console mode on or off."+"In console mode, the display simulates a terminal. When console mode is "+"off, a more conventional display is used. Switching console mode off is "+"probably better for smaller screens."+"<ul>"+"<li>CONSOLE ON <em>console simulator</em>"+"<li>CONSOLE OFF <em>conventional display</em>"+"</ul>","del":"Delete a local storage file"+"<ul>"+"<li>DEL steve <em>delete the task list with the name steve</em>"+"</ul>","down":"Move a task down the priorities."+"<ul>"+"<li>DOWN 3 <em>move task 3 down</em>"+"<li>D 4 <em>move task 4 down</em>"+"<li>DOWN ^ <em>move the current task down</em>"+"<li>DOWN . <em>move the current task down</em>"+"</ul>","dump":"Produce a JSON listing of your tasks. For debugging only."+"<ul>"+"<li>DUMP"+"</ul>","edit":"Edit a task. If it contains a secret you will be prompted for your password."+"<ul>"+"<li>EDIT 3 <em>edit task 3</em>"+"<li>ED ^ <em>edit the current task</em>"+"<li>ED . <em>edit the current task</em>"+"</ul>","export":"Export the tasks. If supported by your browser, allows you to "+"save your tasks to a file."+"<ul>"+"<li>EXPORT"+"</ul>","extend":"Extend a task."+"The selected task will have the new entries appended."+"<ul>"+"<li>EXTEND 3 Phone Jackie <em> extend the content of task 3 with phone Jackie</em>"+"<li>E 4 @Computer <em>add a new context to task 4</em>"+"<li>EXTEND ^ @Work <em>extend the current task</em>"+"<li>EXTEND . @Work <em>extend the current task</em>"+"</ul>","first":"Move a task to the top of the priorities."+"<ul>"+"<li>FIRST 3 <em>move task 3 to the top</em>"+"<li>FIRST ^ <em>move the current task to the top</em>"+"<li>FIRST . <em>move the current task to the top</em>"+"<li>F 7 <em>move the 7th task to the top</em>"+"</ul>","filter":"Apply a filter to reduce the number of tasks that are shown."+"<ul>"+"<li>FILTER @Computer<em>only show those tasks with a context of @Computer</em>"+"<li>FI @Computer @Work <em>restrict to @Computer and @Work</em>"+"<li>FI @Computer not @work <em>restrict to @Computer but not @Work</em>"+"<li>FI :pPatio or :pGarden <em>show tasks in the Patio or Garden project.</em>"+"</ul>","go":"Go to a particular task."+"<ul>"+"<li>GO 7 <em>jump to task 7</em>"+"<li>G 8 <em>jump to task 8</em>"+"</ul>","immediate":" Add a task to the top of priorities."+"<ul>"+"<li>IMMEDIATE phone Jane today."+"<li>I phone Jane today."+"<li>++ phone Jane today."+"</ul>","import":" Import a set of tasks and abbreviations from a local file."+" Note, these are merged with your current tasks."+"<ul>"+"<li>IMPORT"+"</ul>","list":" List tasks."+" List task. An optional filter can also be applied."+"<ul>"+"<li>LIST <em>list all tasks</em>"+"<li>LIST @Computer <em>list tasks with context of @Computer</em>"+"</ul>","dir":"Show the available iKog files. If you are using Dropbox, the files"+" in the ikog-js folder are listed. Otherwise the files in local"+" storage are shown."+"<ul>"+"<li>DIR"+"<li>LS"+"</ul>","kill":"Delete a task or a cache. If you delete the local cache you may lose"+" data."+"<ul>"+"<li>KILL 6 <em>remove task 6</em>"+"<li>K 6 <em>remove task 6</em>"+"<li>X 6 <em>remove task 6</em>"+"<li>KILL ^ <em>remove the current task </em>"+"<li>KILL . <em>remove the current task </em>"+"<li>KILL CACHE <em>remove the cache for the current file</em>"+"<li>KILL ALL CACHES <em>remove all caches </em>"+"</ul>","this":"The word <b>this</b>, <b>^</b> or <b>.</b> can be used to refer to"+" the current task."+"<ul>"+"<li> MOD this @Work <em>adds the @Work context to the current task.</em>"+"<li> KILL ^ <em>deletes the current task.</em>"+"<li> KILL . <em>deletes the current task.</em>"+"</ul>","terms":"Displays the terms and conditions, acknowledgements and privacy"+"statements."+"<ul>"+"<li>TERMS <em>open terms and other legal stuff in a new window</em>"+"</ul>","mod":"Modify a task."+"The selected task will have the selected entries replaced by your new entry."+"<ul>"+"<li>MOD 3 Phone Jackie <em> replace the content of task 3 with phone Jackie</em>"+"<li>M 4 @Computer <em>change the context of task 4</em>"+"<li>MOD ^ Order stationary <em>modify the current task</em>"+"<li>MOD . Order stationary <em>modify the current task</em>"+"</ul>","note":"Create a task with the @Note context. This always appears at the"+" bottom of the priorities."+"<ul>"+"<li>NOTE This is a note."+"<li>NOTES This is a note."+"</ul>","next":"Move to the next task in the list. Note that if you have a filter"+" applied, the next task will be the next visible task."+"<ul>"+"<li>NEXT"+"<li>N"+"</ul>","open":"Open a new task list file. If your are using Dropbox, file will"+" will opened from the Dropbox ikog-js folder. Otherwise it will be"+" taken from the files in local storage."+"<ul>"+"<li>OPEN steve <em>Open a file called steve</em>"+"<li>O steve <em>Open a file called steve</em>"+"</ul>","prev":"Move to the previoius task in the list. Note that if you have a filter"+" applied, the previous task will be the previous visible task."+"<ul>"+"<li>PREV"+"<li>P"+"</ul>","review":"Switch review mode on and off. When review mode is on, just"+" pressing enter moves to the next task."+"<ul>"+"<li>REVIEW ON <em>switch review mode on</em>"+"<li>REVIEW OFF <em>switch review mode off</em>"+"<li>REV ON <em>switch review mode on</em>"+"<li>V0 <em>switch review mode off</em>"+"<li>V1 <em>switch review mode on</em>"+"</ul>","save":"Save the task list. If you are using Dropbox, the file will"+" will saved to the Dropbox ikog-js folder. Otherwise it will be"+" saved to the files in local storage."+"<ul>"+"<li>SAVE <em>Save the tasks to the current file</em>"+"<li>SAVE steve <em>Save the tasks to a file called steve</em>"+"</ul>","show":"Show the text that has been encrypted in a task. You will be"+" prompted to enter your password."+"<ul>"+"<li>SHOW 8 <em>reveal the secret text in task 8</em>"+"<li>S 7 <em>reveal the text in task 7</em>"+"<li>SHOW ^ <em>show the secret text for the current task</em>"+"<li>SHOW . <em>show the secret text for the current task</em>"+"</ul>","top":"Show the top N tasks."+"<ul>"+"<li>TOP 8 <em>list the top 8 tasks</em>"+"<li>T 4 <em>list the top 4 tasks</em>"+"</ul>","up":"Move a task up the priorities."+"<ul>"+"<li>UP 3 <em>move task 3 up</em>"+"<li>U 5 <em>move task 5 up</em>"+"<li>UP ^ <em>move the current task up</em>"+"<li>UP . <em>move the current task up</em>"+"</ul>","use":"Select local storage or Dropbox."+"<ul>"+"<li>USE local <em>use local storage</em>"+"<li>USE dropbox <em>use dropbox</em>"+"</ul>","rep":"Replace a task."+"The selected task will be replaced by your new entry."+"<ul>"+"<li>REP 3 Phone Jackie <em> replace task 3 with phone Jackie</em>"+"<li>R 4 Send report to head office <em>replace task 4</em>"+"<li>REP ^ Order stationary <em>replace the current task</em>"+"<li>REP . Order stationary <em>replace the current task</em>"+"</ul>","signout":"This only applies to Dropbox. If you sign out you will need"+" reauthorise ikog-js next time you reload the web page."+"<ul>"+"<li>SIGNOUT"+"<li>LOGOUT"+"</ul>","web":"Just a shortcut to go to my blog."+"<ul>"+"<li>WEB"+"</ul>","help":"This help"+"<ul>"+"<li>HELP add <em>get help about the add command"+"<li>? top <em>get help about the top command"+"<li>HELP online <em>open the full online guide</em>"+"</ul>"};function iKogHelp(){this.index=iKogHelpIndex;this.text=iKogHelpText;}iKogHelp.prototype.render=function(c){var b="<div class='help'>";if(/^online$/i.test(c)){window.open("http://henspace.com/wiki/pmwiki.php?n=Ikog-js.Ikog-js","_blank");b+="Online help opened in new window.";}else{if(c&&c!=""){c=c.toLowerCase();var a=c;if(c in this.index){a=this.index[c];}if(a in this.text){b+=this.text[a];}else{b+="No help available for "+c;}}else{b+=iKogVersion+iKogAboutText;}}return b+"</div>";};function Parser(){}Parser.prototype.makeSafe=function(a){a=a.replace(/&/gi,"&amp;");a=a.replace(/</gi,"&lt;");a=a.replace(/>/gi,"&gt;");a=a.replace(/"/gi,"&quot;");a=a.replace(/'/gi,"&apos;");return a;};Parser.prototype.enhance=function(a){a=a.replace(/\[a\\\]/g,"&#224;");a=a.replace(/\[a\/\]/g,"&#225;");a=a.replace(/\[a\^\]/g,"&#226;");a=a.replace(/\[e\\\]/g,"&#232;");a=a.replace(/\[e\/\]/g,"&#233;");a=a.replace(/\[e\^]/g,"&#234;");a=a.replace(/\[e\.\.\]/g,"&#235;");a=a.replace(/\[i\.\.\]/g,"&#239;");a=a.replace(/\[o\/\]/g,"&#243;");a=a.replace(/\[u\.\.\]/g,"&#252;");a=a.replace(/\[\[(https?\:)\/\/(.+?)\]\]/g,"<a href='$1\\/\\/$2' target='_blank'>$2</a>");a=a.replace(/\[\[([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4})\]\]/,"<a href='mailto:$1' target='_blank'>Email $1</a>");a=a.replace(/\^(.+?)\^/gi,"<sup>$1</sup>");a=a.replace(/,,(.+?),,/gi,"<sub>$1</sub>");a=a.replace(/\*\*(.+?)\*\*/gi,"<strong>$1</strong>");a=a.replace(/\/\/(.+?)\/\//gi,"<em>$1</em>");a=a.replace(/__(.+?)__/gi,"<u>$1</u>");a=a.replace(/(\d+?) (\d+?)/gi,"$1&thinsp;$2");a=a.replace(/(\d+?) (\w)/gi,"$1&nbsp;$2");a=a.replace(/\[(#?\w+);\]/g,"&$1;");a=a.replace(/\\(.)/g,"$1");return a;};function DataStoreFactory(a){this.useDropbox=a;}DataStoreFactory.prototype.getDataStore=function(b){if(!this.useDropbox){a=new DataStoreLocal();a.init(function(c){if(c){b(a);}else{return null;}});return null;}var a=new DataStoreDropbox();a.init(function(c){if(c){b(a);}else{a=new DataStoreLocal();a.init(function(d){if(d){b(a);}else{return null;}});}});};function DataStoreFile(a,b,c){this.name=a;this.path=c;this.size=b;}function DataStore(a){this.user="anon";this.root=a||"ikog";this.storeName=null;this.available=false;this.fileName="tasks";this.cached=false;this.cacheTag="ikog-cache";}DataStore.prototype.signOut=function(a){};DataStore.prototype.init=function(a){};DataStore.prototype.load=function(a,b,c){};DataStore.prototype.save=function(a,b,c){};DataStore.prototype.del=function(a){};DataStore.prototype.getFiles=function(){};DataStore.prototype.getUser=function(){return this.user;};DataStore.prototype.setUser=function(a){this.user=a;};DataStore.prototype.getPath=function(a){return this.root+"."+this.user+"."+(a?a:this.fileName);};DataStore.prototype.getId=function(){return this.fileName+"@"+this.storeName;};DataStore.prototype.getStoreName=function(){return this.storeName;};DataStore.prototype.getFileName=function(){return this.fileName;};DataStore.prototype.isCached=function(){return this.cached;};DataStore.prototype.killCache=function(){return;};DataStore.prototype.forcedSave=function(a,b,c){this.save(a,b,c);};DataStore.prototype.killAllCaches=function(){if(localStorage){var a=new RegExp("^"+this.cacheTag);for(item in localStorage){if(a.test(item)){delete localStorage[item];terminal.print("Deleted cache "+item);}}}};function DataStoreLocal(a){this.storeName="localStorage";if(a){this.root=a;}}DataStoreLocal.prototype=new DataStore();DataStoreLocal.constructor=DataStoreLocal;DataStoreLocal.prototype.init=function(a){this.available=typeof(Storage);if(a){a(this.available);}};DataStoreLocal.prototype.signOut=function(a){terminal.print("Signing out is not applicable to local storage.");if(a){a(false);}};DataStoreLocal.prototype.getFiles=function(e){var d=[];for(var a in localStorage){var b=/^(\S+)\.\S+\.(\S+)/.exec(a);if(b&&b[1]==this.root){var c=new DataStoreFile(b?b[2]:"-",localStorage[a].length,a);d.push(c);}}if(e){e(d);}};DataStoreLocal.prototype.load=function(b,d,e){var c;this.fileName=b;try{c=localStorage[this.getPath(b)];if(c){c=JSON.parse(c);}else{c=d;}}catch(a){terminal.error("Unable to load "+b+": "+a);terminal.error(c);c=d;}if(e){e(c);}};DataStoreLocal.prototype.save=function(c,d,e){var a=false;if(this.available){try{localStorage[this.getPath(c)]=JSON.stringify(d);a=true;}catch(b){terminal.error("Error saving "+c+": "+b);}}if(e){e(a);}};DataStoreLocal.prototype.del=function(a){var b=this.getPath(a);if(!localStorage.hasOwnProperty(b)){terminal.error("local storage does not have store "+a);return false;}delete localStorage[b];return true;};function DataStoreDropbox(a){this.storeName="Dropbox";if(a){this.root=a;}this.cache=new DataStoreLocal(this.cacheTag+"."+this.root);this.dropbox=new DropboxStore();}DataStoreDropbox.prototype=new DataStore();DataStoreDropbox.constructor=DataStoreDropbox;DataStoreDropbox.prototype.init=function(b){this.cache.init();if(!this.cache.available){terminal.error("Unable to set up local storage which is required to cache Dropbox.");if(b){b(false);}}if(!this.dropbox.init()){if(b){b(false);}}var a=this;this.dropbox.auth(function(c){a.available=c;if(!c){b(c);return;}a.dropbox.getUserName(function(d){a.user=d;if(b){b(c);}});});};DataStoreDropbox.prototype.signOut=function(a){this.dropbox.signOut(a);};DataStoreDropbox.prototype.getFiles=function(a){this.dropbox.readDir(function(b){var d=[];for(var e=0;e<b.length;e++){var c=new DataStoreFile(b[e],"","ikog.js/"+b[e]);d.push(c);}if(a){a(d);}});return[];};DataStoreDropbox.prototype.load=function(a,c,d){console.log("Loading "+a);var b=this;this.fileName=a;if(this.cached){this.killCache();}this.cache.load(a,null,function(e){if(e!=null){terminal.error("A cached entry has been found so data will not be "+"restored from Dropbox. If this is wrong, you will need to "+"delete the cache and reload. Enter <em>KILL CACHE</em> to "+"remove the cached entries.");b.cached=true;if(d){d(e);}}else{b.dropbox.load(a,function(f){if(f){f=JSON.parse(f);}else{f=c;}b.cache.save(a,null,function(){b.cached=false;if(d){d(f);}});b.cached=false;});}});};DataStoreDropbox.prototype.killCache=function(){if(this.cache){this.cache.del(this.cache.getFileName());this.cached=false;}return;};DataStoreDropbox.prototype.save=function(a,b,c){this.cache.save(a,b,c);this.cached=true;};DataStoreDropbox.prototype.forcedSave=function(c,e,f){var a=false;var d=this;if(this.available){try{this.dropbox.save(c,JSON.stringify(e),function(g){if(g){d.cache.save(c,null);d.cached=false;}if(f){f(g);}});return;}catch(b){terminal.error("Error saving "+c+": "+b);}}if(f){f(a);}};DataStoreDropbox.prototype.del=function(a){terminal.error("Deleting Dropbox files is not supported.");return false;};function DataStoreRenderer(){}DataStoreRenderer.prototype.render=function(a,c){var b="<div class='storage-list-title'>"+"File list for "+a.getStoreName()+"</div>";b+="<ul class='storage-list bullet-free'>";a.getFiles(function(e){for(var d=0;d<e.length;d++){b+="<li><span class='store-name'>"+e[d].name+"</span><span class='store-size'>"+e[d].size+"</span><span class='store-path'>"+e[d].path;}b+="</ul>";if(c){c(b);}});};function TaskList(b){this.tasks=[];if(b&&b.tasks){for(var a=0;a<b.tasks.length;a++){this.tasks.push(new Task(b.tasks[a]));}}}TaskList.prototype.modify=function(a,b){if(b>=0&&b<this.tasks.length){this.tasks[b].modifyExtend(a,false);this.sort();}};TaskList.prototype.extend=function(a,b){if(b>=0&&b<this.tasks.length){this.tasks[b].modifyExtend(a,true);this.sort();}};TaskList.prototype.replace=function(a,b){if(b>=0&&b<this.tasks.length){this.tasks[b]=a;this.sort();}};TaskList.prototype.add=function(a){this.tasks.push(a);this.sort();};TaskList.prototype.insert=function(a,b){this.tasks.splice(b,0,a);this.sort();};TaskList.prototype.remove=function(a){if(a>=0&&a<this.tasks.length){this.tasks.splice(a,1);this.sort();}};TaskList.prototype.move=function(a,c){if(a<0||a>=this.tasks.length||c<0||c>=this.tasks.length){return;}var b=this.tasks[c];this.tasks.splice(c,1);this.tasks.splice(a,0,b);};TaskList.prototype.getAt=function(a){return this.tasks[a];};TaskList.prototype.getAll=function(a){return this.tasks;};TaskList.prototype.getLength=function(){return this.tasks.length;};TaskList.prototype.sort=function(){var a=new Date();a.setHours(0,0,0,0);this.tasks.sort(function(d,c){return c.effectivePriority(a)-d.effectivePriority(a);});};TaskList.prototype.clear=function(){this.tasks=[];};TaskList.prototype.addTasks=function(a){for(var b=0;b<a.length;b++){this.tasks.push(new Task(a[b]));console.log("add "+a[b].content);}this.sort();};function Task(c,a){this.content="";this.secret="";this.contexts=[];this.projects=[];this.priority=5;this.dueDate=null;this.created=new Date();this.isMeeting=false;if(typeof c==="string"){this._build(c,a);this.created=new Date();}else{for(var b in c){if(b=="dueDate"||b=="created"){this[b]=c[b]?new Date(c[b]):null;}else{this[b]=c[b];}}}if(this.contexts==null){this.contexts=[];}if(this.projects==null){this.projects=[];}}Task.prototype.modifyExtend=function(b,d){if(b.content&&b.content.length>0){this.content=d?this.content+" "+b.content:b.content;}if(b.secret&&b.secret.length>0){if(!d||!this.hasSecret()){this.secret=b.secret;}else{terminal.error("You cannot extend a secret text. Your new secret will be ignored.");}}if(b.priority){this.priority=b.priority;}if(b.contexts&&b.contexts.length>0){if(d){for(var a=0;a<b.contexts.length;a++){if(this.contexts.indexOf(b.contexts[a])<0){this.contexts.push(b.contexts[a]);}}}else{this.contexts=b.contexts;}}if(b.projects&&b.projects.length>0){if(d){for(var c=0;c<b.projects.length;c++){if(this.projects.indexOf(b.projects[c])<0){this.projects.push(b.projects[c]);}}}else{this.projects=b.projects;}}if(b.dueDate){this.dueDate=b.dueDate;}if(!this.contexts){this.contexts=noAutoContext?[]:["@Anywhere"];}if(this.contexts.indexOf("@Meeting")>=0){this.isMeeting=true;}};Task.prototype.effectivePriority=function(a){var b=this.priority;if(this.contexts.indexOf("@Note")>=0){return 0;}if(this.dueDate){if(this.dueDate>a){return 0;}else{b+=this.isMeeting?12:11;}}return b;};Task.prototype._extract=function(d){var a=this.content.match(d);var b="";if(a&&a.length>0){for(var c=0;c<a.length;c++){if(/ $/.test(a[c])){b=" ";}a[c]=a[c].trim();}this.content=this.content.replace(d,b).trim();}return a;};Task.prototype.hasSecret=function(){return(this.secret&&this.secret.length>0);};Task.prototype.properCase=function(a,b){return a.substring(0,b)+a.charAt(b).toUpperCase()+a.substring(b+1).toLowerCase();};Task.prototype._build=function(d,c){var g=d.split("<secret>");this.content=g[0];this.secret=g.length>1?g[1]:"";this.contexts=this._extract(/(?:^|\s)@\w+?\b/g);this.projects=this._extract(/(?:^|\s)\:p\w+?\b/g);var b=this._extract(/(?:^|\s)#\d+?\b/);var f=this._extract(/(?:^|\s)\:d[-+\/\d]+?(?:$|\s)/);if(!this.projects){this.projects=[];}else{for(var e=0;e<this.projects.length;e++){this.projects[e]=this.properCase(this.projects[e],2);}}if(!this.contexts){this.contexts=c?[]:["@Anywhere"];}if(this.contexts.indexOf("@Meeting")>=0){this.isMeeting=true;}for(var a=0;a<this.contexts.length;a++){this.contexts[a]=this.properCase(this.contexts[a],1);}if(b){this.priority=parseInt(b[0].substring(1),10);if(this.priority<0){this.priority=0;}else{if(this.priority>10){this.priority=10;}}}if(f){this.dueDate=this.parseDate(f[0].substring(2));this.dueDate.setHours(0,0,0,0);if(this.contexts.indexOf("@Date")<0){this.contexts.push("@Date");}}};Task.prototype.parseDate=function(g){var b=new Date();try{if(/^\+\d+/.test(g)){return new Date(b.getTime()+24*3600000*parseInt(g.substring(1)));}else{var d=g.match(/(\d+?)(?:(?:-|\/)(\d+?))?(?:(?:-|\/)(\d+))?$/);var e=b.getFullYear();var h=b.getMonth();var a=b.getDate();if(d[3]){a=parseInt(d[3],10);h=parseInt(d[2],10)-1;e=parseInt(d[1],10);}else{if(d[2]){a=parseInt(d[2],10);h=parseInt(d[1],10)-1;}else{var c=parseInt(d[1],10);if(c<a){h++;}a=c;}}return new Date(e,h,a);}}catch(f){terminal.error("Unable to parse date "+g+": "+f);return null;}};Task.prototype.toString=function(){var a=this.content+" #"+this.priority;for(var b=0;b<this.contexts.length;b++){a+=" "+this.contexts[b];}if(this.projects&&this.projects.length>0){a+=" Projects: ";for(var b=0;b<this.projects.length;b++){a+=" "+this.projects[b];}}return a;};Task.prototype.toLine=function(){var a="";for(var b=0;b<this.contexts;b++){a+=this.contexts[b]+" ";}a+=this.content;return a;};Task.prototype.getContexts=function(){return this.contexts;};function TaskListRenderer(b,a){this.tasks=b.getAll();this.filter=a;}TaskListRenderer.prototype.render=function(b,e){var d="";d+=new FilterRenderer(this.filter).render(e);d+="<ul class='task-list bullet-free'>";var a=b==undefined||b<0?this.tasks.length:b;for(var f=0;f<a;f++){var c=this.tasks[f];if(this.filter.isViewable(c)){d+="<li>"+new TaskRenderer(f,c).terse();}}d+="</ul>";return d;};function TaskRenderer(b,a){this.id=b;this.task=a;}TaskRenderer.prototype.editable=function(b){var a="M "+this.id;a+=" "+this.task.content;a+=" #"+this.task.priority;for(var e=0;e<this.task.contexts.length;e++){a+=" "+this.task.contexts[e];}for(var d=0;d<this.task.projects;d++){a+=" "+this.task.projects[d];}if(this.task.dueDate){a+=" :d"+this.task.dueDate.toISOString().substring(0,10);}if(this.task.secret&&b){a+=" <s>"+b;}return a;};TaskRenderer.prototype.terse=function(a){return this.render("terse-task",a);};TaskRenderer.prototype.verbose=function(a){return this.render("verbose-task",a);};TaskRenderer.prototype.render=function(b,a){var e="<div class = '"+b+"'>";e+="<div class='task-id'>"+(this.id<10?"0":"")+this.id+"</div>";e+="<div class='description'>"+new Parser().enhance(this.task.content)+"</div>";e+="<div class='secret'>";if(a){e+=new Parser().enhance(a);}else{e+=this.task.secret?"***":"";}e+="</div>";e+="<div class='priority'>"+(this.task.priority<10?"0":"")+this.task.priority+"</div>";e+="<ul class='contexts bullet-free'>";for(var f=0;f<this.task.contexts.length;f++){e+="<li>"+this.task.contexts[f]+" ";}e+="</ul>";e+="<ul class='projects bullet-free'>";for(var d=0;d<this.task.projects.length;d++){e+="<li>"+this.task.projects[d].substring(2)+" ";}e+="</ul>";if(this.task.dueDate){e+="<div class='due-date'>"+this.task.dueDate.toDateString()+"</div>";}e+="<div class='created-date'>"+this.task.created.toDateString()+"</div>";e+="</div>";return e;};var terminal=(function(){var r=null;var o=">>>";var s="";var j=-1;var k=false;var t=20000;var w="<!--#-->";function l(){$("#mockScreenContainerEnd")[0].scrollIntoView(false);$("#commandEntryContainer")[0].scrollIntoView(false);if(k){$("#pwEntry").focus();}else{$("#commandLineEntry").focus();}}function q(y){var x=$("#mockScreen").html();if(x.length>t){x=x.substring(x.indexOf(w)+w.length);}$("#mockScreen").html(x+y+"<br>"+w);l();}function d(){$("#mockScreen").html("");$("#commandLineEntry").val("");}function i(y){var x=r;r=y;return x;}function n(x){o=x;$("#prompt-text").html(x);}function g(x){q("<span class='error'>"+x+"</span>");}function h(){var y;if(k){y=$("#pwEntry").val();y=new Parser().makeSafe(y);var x=new Array(y.length+1);terminal.print(o+" "+x.join("*"));}else{y=$("#commandLineEntry").val();y=new Parser().makeSafe(y);terminal.print("<span class='prompt'>"+o+"</span>"+y);}$("#commandLineEntry, #pwEntry").val("");if(r){r.process(y);}}function m(x){if(x){$("#prompt").hide();s=o;n("");}else{$("#prompt").show();n(s);}}function f(){return o=="";}function a(){j=$("#mockScreen").html().length;}function c(){if(j>=0){$("#mockScreen").html($("#mockScreen").html().substring(0,j));}j=-1;}function p(){return k;}function e(x){k=x;if(x){$("#commandLineEntry").hide();$("#pwEntry").show();$("#pwEntry").focus();}else{$("#commandLineEntry").show();$("#pwEntry").hide();$("#commandLineEntry").focus();}}function v(x){$("#commandLineEntry, #pwEntry").prop("readonly",x);}function b(x){if(k){$("#pwEntry").val(x);}else{$("#commandLineEntry").val(x);}}function u(x){$("#dirty").html(x?"!":" ");}return{setShell:i,print:q,clear:d,enter:h,setPrompt:n,error:g,runningCommand:m,isRunningCommand:f,mark:a,clearToMark:c,isPassword:p,enterPassword:e,block:v,setInput:b,setDirty:u,scrollIntoView:l};})();var iKogVersion="iKog2 v2.0.32 2014-11-29 &copy;2014 Steve Butler";if(!window.console){window.console={};window.console.log=function(){};}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(c,d){for(var b=(d||0),a=this.length;b<a;b++){if(this[b]===c){return b;}}return -1;};}$(document).ready(function(){if(!String.prototype.trim){String.prototype.trim=function(){return $.trim(this);};}terminal.clear();$(window).click(function(){if(terminal.isPassword()){$("#pwEntry").focus();}else{$("#commandLineEntry").focus();}});$("#commandLineEntry").focus();$("#commandLineEntry, #pwEntry").keypress(function(a){if(a.keyCode==13){a.preventDefault();terminal.enter();}});terminal.setPrompt("root@ikog:~ > ");terminal.enterPassword(false);terminal.print(iKogBanner);terminal.print(iKogVersion);terminal.print("");$("#nonConsoleHeader").html("iKog-js");$("#nonConsoleFooter").html(iKogVersion);ikog.init();$(window).on("beforeunload",function(){if(ikog.isDirty()){console.log("Reckon page is dirty.");return"Are you sure you want to leave?";}});$(window).on("unload",function(){if(!ikog.isDirty()){ikog.killCache();}});});var ikog=(function(){var at={tasks:null,abbreviations:null};var S,O,s,j,G,e,x,k,ah,aJ,V;var aI={firstUse:true,useDropbox:false,reviewMode:false,autosave:false,lastLocal:null,lastDropbox:null,console:true};var o;var i=false;var aF=true;function an(){o=new DataStoreLocal("ikog-config");o.init();o.load("configuration",aI,function(aM){aI=aM;aC(aI.console);});V=new Exporter("#importFile");ah=new Encryptor();ah.setCaller(this);aJ=new Decryptor();j=new Collection();G=new Collection();e=new Collection();O=new Alias({"+":"ADD","A":"ADD","AB":"ABBREV","AS":"AUTOSAVE","CLS":"CLEARSCREEN","D":"DOWN","E":"EXTEND","ED":"EDIT","F":"FIRST","FI":"FILTER","G":"GO","++":"IMMEDIATE","I":"IMMEDIATE","K":"KILL","LS":"DIR","L":"LIST","M":"MOD","NOTES":"NOTE","N":"NEXT","O":"OPEN","P":"PREV","R":"REP","REV":"REVIEW","SH":"SHOW","T":"TOP","U":"UP","SIGNOFF":"SIGNOUT","LOGOFF":"SIGNOUT","X":"KILL","?":"HELP"});s={"@":ak,":D":aK,":P":aD,"2":L,"ABBREV":E,"ADD":aq,"AUTOSAVE":n,"CLEAR":P,"CLEARSCREEN":Y,"COMMANDS":T,"CONSOLE":ag,"DEL":R,"DIR":ar,"DOWN":p,"DUMP":ad,"EDIT":ax,"EXTEND":D,"EXPORT":m,"FILTER":c,"FIRST":ab,"GO":ao,"HELP":M,"IMMEDIATE":am,"IMPORT":aG,"KILL":J,"LIST":q,"MOD":ac,"NEXT":aa,"NOTE":b,"OPEN":K,"PREV":B,"REP":a,"REVIEW":r,"SAVE":t,"SHOW":g,"SIGNOUT":W,"TERMS":az,"TOP":C,"UP":Q,"USE":aj,"V0":z,"V1":ai,"WEB":aH};x=new Filter();k=0;if(aI.firstUse){aC(false);terminal.print("As this is your first use, I need to know where to"+" store your data.<br>If you choose Dropbox, then your"+" data will be in the cloud and accessible wherever you"+" are.<br>If you don't select Dropbox, your browser's"+" local storage will be used.");new Confirm().yesOrNo("Do you want to use Dropbox for online"+" storage?",function(){aI.useDropbox=true;aI.firstUse=false;o.save("configuration",aI);d();},function(){aI.useDropbox=false;aI.firstUse=false;o.save("configuration",aI);d();});}else{d();}}function au(){if(aI.autosave&&S.storeName=="Dropbox"){terminal.print("Autosave is on. When using Dropbox, this means "+"data is written to the local cache automatically. To save "+"back to Dropbox you will still need to use the <em>SAVE</em> "+"command.");}}function d(){terminal.block(true);terminal.print("Configuring storage.");new DataStoreFactory(aI.useDropbox).getDataStore(function(aM){if(aM){S=aM;var aN=S.getStoreName()=="Dropbox"?aI.lastDropbox:aI.lastLocal;if(!aN){aN=S.getFileName();}ay(aN,function(){au();terminal.print("Enter <em>HELP ONLINE</em> to read the manual "+"or enter <em>TERMS</em> to see the terms of use.");if(aI.console){terminal.print("Enter <em>console off</em> for conventional display.");}else{terminal.print("Enter <em>console on</em> for original console mode.");}terminal.setShell(ikog);terminal.block(false);});}else{terminal.error("Dropbox not available and your browser does "+"support local storage. There's nothing I can do. "+" Sorry :(");}});}function ay(aM,aN){terminal.block(true);S.load(aM||"default",null,function(aQ){var aP=aI.autosave;aI.autosave=false;l(S.isCached());aI.autosave=aP;var aR=S.getFileName();if(S.getStoreName()=="Dropbox"){if(aR!=aI.lastDropbox){aI.lastDropbox=aR;o.save("configuration",aI);}}else{if(aR!=aI.lastLocal){aI.lastLocal=aR;o.save("configuration",aI);}}if(aQ){at.tasks=new TaskList(aQ.tasks);at.abbreviations=new Alias(aQ.abbreviations);}else{at.tasks=new TaskList();at.abbreviations=new Alias({"@C":"@Computer","@D":"@Desk","@E":"@Errand","@H":"@Home","@I":"@Internet","@L":"@Lunch","@M":"@Meeting","@N":"@Next","@O":"@Other","@P":"@Phone","@PW":"@Password","@S":"@Someday/maybe","@W4":"@Waiting_for","@W":"@Work"});}at.tasks.sort();for(var aO=0;aO<at.tasks.tasks.length;aO++){A(at.tasks.tasks[aO]);}terminal.print("Using "+S.getStoreName()+":"+S.getPath());v();aw();terminal.block(false);if(aN){aN();}});}function ap(aM,aO){var aN=false;terminal.block(true);S.save(aM||S.getFileName(),at,function(aP){if(!aP){terminal.error("Problem caching data");}else{if(!S.isCached){terminal.print("Save complete.");l(false);}else{terminal.print("Cached.");}aN=true;}terminal.block(false);if(aO){aO(aP);}});}function h(aM){return aM.replace(/[^\w\.]/g,"_");}function X(aN,aP){var aO=false;terminal.print("Saving data.");terminal.block(true);var aM=aN||S.getFileName();aM=h(aM);S.forcedSave(aM,at,function(aQ){if(!aQ){terminal.error("Problem saving data");}else{terminal.print(aM+" saved.");aO=true;l(false);}terminal.block(false);if(aP){aP(aQ);}});}function v(){if(aI.console){if(S&&S.getId){terminal.setPrompt(S.getId()+":~ >");}else{terminal.setPrompt("root@ikog:~ >");}}else{terminal.setPrompt("Task/command:");}}function aB(aM){if(aM===""){$("#styleOverride").text("");terminal.scrollIntoView("");}else{$.get(aM,function(aN){$("#styleOverride").text(aN);terminal.scrollIntoView("");});}}function aC(aM){if(aM){aB("styles/ikog.css");}else{aB("styles/ikog_conventional.css");}aI.console=aM;o.save("configuration",aI);v();}function ag(aN){var aM=false;if(aN.match(/on/i)){aM=true;}else{if(aN.match(/off/i)){aM=false;}else{terminal.error("Bad command use Console on or Console off.");return;}}if(aI.console==aM){terminal.print("Already in that mode.");}else{aC(aM);}}function m(aM){new Confirm().wait("The export function should open up a dialog asking if you want "+"to open or save the file. Select save. Note that this probably "+"won't work with IE. Also Firefox seems not to save the file if "+"you don't include the file extension - browsers eh. :). Press "+"enter to give it a go.",function(){V.exportTasks(at);});}function aG(aM){V.importTasks(at);}function n(aN){var aM=false;if(aN.match(/on/i)){aM=true;}else{if(aN.match(/off/i)){aM=false;}else{terminal.error("Bad command use Autosave on or Autosave off.");return;}}if(aI.autosave==aM){terminal.print("Autosave is already "+(aM?"on":"off"));return;}aI.autosave=aM;o.save("configuration",aI);terminal.print("Autosave is now "+(aM?"on":"off"));au();l(i);}function P(aM){if(aM&&aM.length>0){terminal.error("Incorrect use. CLEAR");return;}new Confirm().yesOrNo("Are you sure you want to delete all your tasks?",function(){at.tasks.clear();k=0;},function(){terminal.print("Your tasks have been left untouched.");});}function az(aM){window.open("terms.html","_blank");}function aH(aM){window.open("http://cuckooswearblack.com","_blank");}function Y(aM){if(aM&&aM.length>0){terminal.error("Incorrect use. CLEARSCREEN");return;}terminal.clear();}function L(aM){if(aM&&aM.length>0){aq("2 "+aM);}else{new GtdTimer(2).start();}}function w(aO,aN,aM){terminal.setInput(new TaskRenderer(aO,aN).editable(aM));}function ax(aN){var aO=f(aN);if(aO<0){terminal.error("Incorrect use. EDIT N");}else{var aM=at.tasks.getAt(aO);if(aM.hasSecret()){aJ.setTask(aO,aM);aJ.process(function(aP){w(aO,aM,aP);});}else{w(aO,aM,null);}}}function a(aO){var aN=aO.match(/(.+?)\s+(.*)/);if(!aN){terminal.error("Incorrect use. REP N new task");return;}var aP=f(aN[1],false);if(aP>=0){var aM=new Task(at.abbreviations.apply(aN[2]));at.tasks.replace(aM,aP);A(at.tasks.tasks[aP]);l(true);}}function D(aO){var aN=aO.match(/(.+?)\s+(.*)/);if(!aN){terminal.error("Incorrect use. EXTEND N modifications");return;}var aP=f(aN[1]);if(aP>=0){var aM=new Task(at.abbreviations.apply(aN[2]),true);at.tasks.extend(aM,aP);A(at.tasks.tasks[aP]);l(true);}}function ac(aO){var aN=aO.match(/(.+?)\s+(.*)/);if(!aN){terminal.error("Incorrect use. MOD N modifications");return;}var aP=f(aN[1]);if(aP>=0){var aM=new Task(at.abbreviations.apply(aN[2]),true);at.tasks.modify(aM,aP);A(at.tasks.tasks[aP]);l(true);}}function aj(aM){if(/^local$/i.test(aM)){if(!aI.useDropbox){terminal.error("The application is already configured to use"+" local storage.");}else{aE(false);}}else{if(/^dropbox$/i.test(aM)){if(aI.useDropbox){terminal.error("The application is already configured to use"+" Dropbox.");}else{aE(true);}}else{terminal.error("Incorrect use. USE local | dropbox");}}}function aE(aM){if(i){new Confirm().yesOrNo("You have unsaved changes. Save now?",function(){X(name,function(aN){if(aN){U(aM);}});},function(){F();U(aM);});}else{U(aM);}}function U(aM){aI.useDropbox=aM;o.save("configuration",aI);terminal.print("Reloading");var aN=window.location.href.match(/[^#?]*/)[0];window.location.replace(aN);}function M(aM){terminal.print(new iKogHelp().render(aM));}function W(aM){S.signOut(function(aN){terminal.print(aN?"You have been logged out.":"You remain logged in.");});}function R(aM){new Confirm().yesOrNo("Are you sure you want to delete store "+aM,function(){if(S.del(aM)){terminal.print("Removed store "+aM);}});}function ar(aM){new DataStoreRenderer().render(S,function(aN){terminal.print(aN);});}function K(aM){aM=h(aM);if(S.getFileName()==aM){terminal.print(aM+" is already loaded.");return;}aF=false;if(i){new Confirm().yesOrNo("You have unsaved changes. Save now?",function(){X(name,function(aN){if(aN){ay(aM);}});},function(){F();ay(aM);});}else{F();ay(aM);}}function aA(aO,aN){var aP=f(aO);if(aP>=0){var aM=aN==0?0:aP+aN;at.tasks.move(aM,aP);l(true);}}function c(aM){x.setFilter(at.abbreviations.apply(aM));u();}function ab(aM){aA(aM,0);}function Q(aM){aA(aM,-1);}function p(aM){aA(aM,+1);}function ai(){if(aI.reviewMode){terminal.print("You are already in review mode.");}else{terminal.print("In review mode. Enter advances to next task.");aI.reviewMode=true;o.save("configuration",aI);}}function z(){if(!aI.reviewMode){terminal.print("Review mode is already off.");}else{terminal.print("Review mode off. Enter does not advance to next task.");aI.reviewMode=false;o.save("configuration",aI);}}function r(aM){if(aM.match(/on/i)){ai();}else{if(aM.match(/off/i)){z();}else{terminal.error("Bad command use Review on or Review off.");}}}function aa(){av(false);u(false);}function B(){av(true);u(true);}function C(aM){aM=I(aM,0);if(aM>0){terminal.print(new TaskListRenderer(at.tasks,x).render(aM));}k=0;u(false);}function ao(aM){var aN=f(aM);if(aN<=0||at.tasks.getLength()==0){k=0;}else{if(aN>=at.tasks.getLength()){k=at.tasks.getLength()-1;}else{k=aN;}}}function av(aM){if(aM){if(k>0){k--;}else{k=at.tasks.getLength()-1;}}else{if(k<at.tasks.getLength()-1){k++;}else{k=0;}}}function u(aM){var aN=k;if(!x){return;}do{if(x.isViewable(at.tasks.tasks[k])){return;}av(aM);}while(aN!=k);terminal.print("Failed to find anything matching your filter "+x.getFilter());}function ad(){terminal.print(JSON.stringify(at.tasks));}function t(aM){X(aM);}function am(aM){af(aM,true);}function T(aN){var aM="<ul class='command-list bullet-free'>";for(cmd in s){aM+="<li>"+cmd;}aM+="</ul>";terminal.print(aM);}function E(aN){var aM=(/^\s*(\S+)\s*(.*)$/).exec(aN);if(!aM||aM[1]==""){terminal.error("I didn't understand the abbreviation. "+"Should be ABBREV short expanded");return;}if(aM[1]=="?"){terminal.print(new AliasesRenderer(at.abbreviations).render());return;}if(aM[2]==""){at.abbreviations.remove(aM[1]);terminal.print("Removed abbreviation "+aM[1]);}else{at.abbreviations.add(aM[1],aM[2]);}l(true);}function b(aM){af("@Note #0 "+aM);}function aq(aM){af(aM,false);}function af(aN,aO){if(!aN||aN.length==0){terminal.print("Nothing to add.");}else{var aM=new Task(at.abbreviations.apply(aN));A(aM);if(aO){at.tasks.insert(aM,0);}else{at.tasks.add(aM);}l(true);}}function A(aM){j.add(aM.contexts);G.add(aM.projects);if(aM.dueDate){var aN=aM.dueDate.toISOString().substring(0,10);e.add(aN);}j.sort();G.sort();e.sort(function(aP,aO){return aP.valueOf()-aO.valueOf();});}function g(aM){var aN=f(aM);if(aN>=0){aJ.setTask(aN,at.tasks.getAt(aN));aJ.process();}}function I(aN,aM){if(!/^\d+$/.test(aN)){return aM;}return parseInt(aN,10);}function f(aM){if(/^\s*(\^|this|\.)\s*$/i.test(aM)){return k;}var aN=I(aM,-1);if(aN==-1){terminal.error("Unrecognised id");}else{if(aN>=at.tasks.length){terminal.error("Task "+aM+" does not exist.");}}return aN;}function y(aM){at.tasks.remove(aM);terminal.print("Task "+aM+" removed.");l(true);}function F(){S.killCache();i=false;console.log("Killed cache");}function N(){new Confirm().yesOrNo("Are you sure you want to delete all local "+"caches?",function(){S.killAllCaches();i=false;window.location.reload();},function(){terminal.print("All the caches have been left in place.");});}function J(aM){if(/^\s*all caches\s*$/i.test(aM)){N();return;}if(/^\s*cache\s*$/i.test(aM)){F();window.location.reload();return;}var aN=f(aM);if(aN>=0){if(aN==k){y(aN);}else{terminal.print(new TaskRenderer(aN,at.tasks.getAt(aN)).verbose());new Confirm().yesOrNo("Are you sure you want to delete task "+aN,function(){y(aN);aw();});}}}function aK(){Z(e,":d");}function aD(aM){Z(G,"");}function ak(aM){Z(j,"");}function Z(aO,aN){var aM=aO.getItems();for(var aP=0;aP<aM.length;aP++){console.log(aM[aP]);terminal.print(new TaskListRenderer(at.tasks,new Filter(aN+aM[aP],aM[aP])).render(-1,true));}}function q(aM){terminal.print(new TaskListRenderer(at.tasks,aM&&aM!=""?new Filter(at.abbreviations.apply(aM)):x).render());}function aw(){if(at.tasks.getLength()>0){if(x.isActive()){terminal.print(new FilterRenderer(x).render(false));}if(x.isViewable(at.tasks.getAt(k))){terminal.print(new TaskRenderer(k,at.tasks.getAt(k)).verbose());}else{"No task matching filter";}}}function aL(aM){at.abbreviations.apply(aM.getContexts());}function ae(aM){aM=aM.trim();if(aM==""){if(aI.reviewMode){aa();aw();return;}}entry=ah.process(aM);if(!entry){return;}var aN=(/^\s*(\S+)\s*(.*)$/).exec(entry);var aO=s[O.get(aN[1].toUpperCase())];if(aO){aO(aN[2]);}else{if(entry&&entry.length>10){aq(entry);}else{terminal.print("Unrecognised command");}}if(!terminal.isRunningCommand()&&aF){aw();}aF=true;return false;}function H(){return i;}function l(aM){i=aM;if(aI.autosave&&i){if(S.getStoreName()=="Dropbox"){ap();}else{X();}}terminal.setDirty(i);}return{init:an,process:ae,abbreviate:aL,isDirty:H,setDirty:l,killCache:F};})();