let e,t,i,r,n,s,o,a,h,l,c,u,d;function m(e){return e&&e.__esModule?e.default:e}/**
 * @license {@link https://opensource.org/license/mit/|MIT}
 *
 * Copyright 2024 Steve Butler
 */let p=[];window.addEventListener("error",e=>{alert(`ERROR: ${e.filename}; line ${e.lineno}
${e.message}
:Stack:
${e.error.stack}`)});var f={log:function(...e){console.log(...e)},info:function(...e){console.debug(...e)},debug:function(...e){console.debug(...e)},error:function(...e){console.error(...e),p=p.concat(e)},fatal:function(e){let t;console.error(e),t=e.message?`${e.message}
Stack:
${e.stack}`:e,alert(`Fatal error: ${t}
Previous errors:
${p.join("\n")}`),p.push(t)}};const g="'UnifrakturCook', cursive",w={normal:{size:15,fontName:"'UnifrakturCook', cursive"},h1:{size:30,fontName:g},h2:{size:22,fontName:g},h3:{size:18,fontName:g},emojiSprite:{size:18,fontName:"'UnifrakturCook', cursive"}};function y(e){let t=w[e]??w.normal;return`${t.size}px ${t.fontName}`}const x={DEG_22_5:1/8*Math.PI,DEG_45:2/8*Math.PI,DEG_67_5:3/8*Math.PI,DEG_112_5:5/8*Math.PI,DEG_135:6/8*Math.PI,DEG_157_7:7/8*Math.PI};function S(e,t,i){return e<t?t:e>i?i:e}const T={NONE:-1,N:0,NE:1,E:2,SE:3,S:4,SW:5,W:6,NW:7};function E(e,t){let i=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-i+1)+i)}function v(e,t){let i=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-i+1)+i)}class C{x;y;constructor(e,t){this.x=e,this.y=t}static copy(e){return new C(e.x,e.y)}coincident(e){return this.x===e.x&&this.y===e.y}getCartesianAngleTo(e){return Math.atan2(e.y-this.y,e.x-this.x)}getScreenAngleTo(e){return Math.atan2(this.y-e.y,e.x-this.x)}toString(){return`(${this.x},${this.y})`}isCoincident(e){return Math.round(this.x)===Math.round(e.x)&&Math.round(this.y)===Math.round(e.y)}isOtherClose(e,t){return Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2)<=Math.pow(t,2)}}class P{x;y;rotation;constructor(e,t,i){this.x=e,this.y=t,this.rotation=i}getCartesianDirection(){return Math.atan2(this.y,this.x)}getScreenDirection(){return Math.atan2(-this.y,this.x)}isZero(e){return Math.abs(this.x)<e&&Math.abs(this.y)<e}}class b extends C{rotation;constructor(e,t,i){super(e,t),this.y=t,this.rotation=i}static fromPoint(e){return new b(e.x,e.y,0)}static copy(e){return new b(e.x,e.y,e.rotation)}getRelativeTo(e){return new b(this.x-e.x,this.y-e.y,this.rotation-e.rotation)}withinSquare(e,t){return Math.abs(e.x-this.x)<t&&Math.abs(e.y-this.y)<t}}class M{x;y;width;height;constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}getBottomRight(){return new C(this.x+this.width,this.y+this.height)}getTopLeft(){return new C(this.x,this.y)}overlaps(e){let t=this.getBottomRight(),i=e.getBottomRight();return!(e.x>t.x||e.y>t.y||i.x<this.x||i.y<this.y)}containsPoint(e){return e.x>=this.x&&e.x<=this.x+this.width&&e.y>=this.y&&e.y<=this.y+this.height}containsCoordinate(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}equals(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}}new C(Number.MIN_VALUE,Number.MIN_VALUE),new C(Number.MAX_VALUE,Number.MAX_VALUE);let z=null,R=null,I=null,O=0,k=0,L=!0,B=null,A=null,_=0,N=0,D=1,G=1,W=.1,F="COVER",H=new b(0,0,0);function U(){let e,t,i,r;let n={width:window.innerWidth,height:window.innerHeight},s=I.width/I.height,o=0,a=0,h=n.width/n.height;("COVER"===F?s>h:s<h)?a=(o=n.height)*s:o=(a=n.width)/s,(D=a/I.width)>G?(a=(D=G)*I.width,o=D*I.height):D<W&&(a=(D=W)*I.width,o=D*I.height),_=(n.width-a)/2,N=(n.height-o)/2,R.style.left=`${_}px`,R.style.top=`${N}px`,R.style.width=`${a}px`,R.style.height=`${o}px`,_<0?(i=-_/D,e=n.width/D):(i=0,e=I.width),N<0?(r=-N/D,t=n.height/D):(r=0,t=I.height),B=new M(i,r,e,t),f.debug(`Scale: ${D}`),f.debug(`Window: width: ${n.width}, height: ${n.height}`),f.debug(`Display: left: ${_}, top: ${N}, width: ${a}, height: ${o}`),f.debug(`Visible canvas: left: ${i}, top: ${r}, width: ${e}, height: ${t}`)}function $(){let e=w.normal.size*D;document.documentElement.style.fontSize=`${e}px`}function V(){U(),$()}function X(){return R.getContext("2d",{alpha:L})}function K(e){return e.style.opacity=0,new Promise(t=>{window.setTimeout(()=>{e.remove(),t()},500)})}function Y(e){return new b(e.x+H.x,e.y+H.y,e.rotation)}window.addEventListener("resize",()=>{null===z&&(z=window.setTimeout(()=>{V(),z=null},200))});var Z={canvasPositionToWorld:Y,centreCanvasOn:function(e){H.x=e.x-O,H.y=e.y-k},clearCanvas:function(){X().clearRect(0,0,I.width,I.height)},displayOnGlass:function(e,t,i){let r;let n=document.createElement("div");document.body.appendChild(n),n.className="glass";let s=document.createElement("div");n.appendChild(s),s.className="glass-content",s.appendChild(e),i&&n.classList.add(i),n.style.display="block",n.style.opacity=1;let o=[];if(t&&t.length>0)t.forEach(e=>{let t=new Promise(t=>{e.element.addEventListener("click",async()=>{t(e.response)})});o.push(t)});else{let e=new Promise(e=>s.addEventListener("click",()=>e()));o.push(e)}return Promise.race(o).then(e=>(r=e,K(n))).then(()=>r)},getCanvas:()=>R,getContext2D:X,getCanvasDimensions:function(){return{width:I.width,height:I.height}},getWorldInCanvasBounds:function(){return new M(H.x,H.y,I.width,I.height)},getVisibleCanvasRect:function(){return B},glassPositionToWorld:function(e){let t=e.x<0?B.x+B.width:B.x,i=e.y<0?B.y+B.height:B.y;return Y(new b(t+e.x,i+e.y,e.rotation))},isOnCanvas:function(e){return e.overlaps(I)},isOnScreen:function(e){return e.overlaps(I)},panCamera:function(e,t){H.x+=e,H.y+=t},resize:V,setOpacity:function(e){X().globalAlpha=e},setOptions:function(e){var t;if(R){f.error("Multiple calls to setScreen ignored.");return}A=document.getElementById("game-content"),t=e.width,w.normal.size=15+t/100*.390625,w.h1.size=2*w.normal.size,w.h2.size=1.5*w.normal.size,w.h3.size=1.2*w.normal.size,w.emojiSprite.size=t/10,(R=document.createElement("canvas")).id="game-canvas",R.setAttribute("width",e.width),R.setAttribute("height",e.height),R.innerText="Loading the app.",I=new M(0,0,e.width,e.height),O=e.width/2,k=e.height/2,A.appendChild(R),G=e.maxScale,W=e.minScale,F=e.sizingMethod,L=e.alpha,U(),$()},wipeGlass:K,worldPositionToCanvas:function(e){return new b(e.x-H.x,e.y-H.y,e.rotation)},worldToUi:function(e){return e*D},uiCoordsToMappedPositions:function(e,t){return{canvas:new b(Math.round(e/=D),Math.round(t/=D)),world:new b(Math.round(e+H.x),Math.round(t+H.y),-H.rotation)}},uiToWorld:function(e){return e/D}};const q=new Map,j=new Map;function J(t){let i=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,i),q.delete(t)}function Q(e){f.debug("Remove passive sprite."),j.delete(e)}function ee(){e=null}var et={addActor:function(t){q.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addPassiveSprite:function(e){j.set(e,e)},clearAll:function(){q.forEach(e=>J(e)),j.forEach(e=>Q(e)),ee()},getActors:function(){return q},getTileMap:function(){return e},getWorldDims:function(){return e?e.getDimensions():Z.getCanvasDimensions()},removeTileMap:ee,resolveCancel:function(e){return!1},resolveClick:function(t){let i=e?.getTileAtWorldPoint(t.world);return!!i&&(i.actionClick(t.world),!0)},resolveContextMenu:function(t){let i=e.getTileAtWorldPoint(t.world);return!!i&&(i.actionContextClick(t.world),!0)},removeActor:J,removePassiveSprite:Q,setTileMap:function(t){e=t},update:function(t){e?.update(t),q.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let n=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,n)}),j.forEach(e=>e.update(t))}};function ei(e,t,i,r){if(e.font=y(r?.styleName),e.fillStyle=r?.color??"white",r?.wrapAtX){var n=t.split("\n");for(let t=0;t<n.length;t++)r.y=function(e,t,i,r){let n;let s=t.split(" "),o=i.x??0,a=i.y??0,h=r.xWrapPosition-o,l=r.lineSpacing??1,c="";for(let t=0;t<s.length;t++){let i=c+s[t]+" ",r=function(e,t){let i=e.measureText(void 0);return{width:i.width,height:i.fontBoundingBoxAscent+i.fontBoundingBoxDescent,offsetTop:-i.fontBoundingBoxAscent,offsetCentreY:.5*(i.fontBoundingBoxDescent-i.fontBoundingBoxAscent)}}(e);n||(n=l*r.height),r.width>h&&t>0?(e.fillText(c,o,a),c=s[t]+" ",a+=n):c=i}return e.fillText(c,o,a),a+n}(e,n[t],i,r)}else e.fillText(t,i.x??0,i.y??0)}const er={spriteBoxes:!1,showFps:!0};let en=[];function es(e){return new Promise(t=>{let i=new Image;i.addEventListener("load",()=>{f.debug("Image loaded."),t(i)}),i.src=e})}var eo={getSpriteBitmap:function(e,t){let i=en[e].get(t);return i||f.debug(`Failed to find image ${t} at index ${e}`),i},loadImage:es,loadImages:function(e){let t=[];return e.forEach(e=>t.push(es(e))),Promise.all(t)},loadSpriteMap:function(e,t){return es(t).then(t=>(function(e,t){let i=[],r=new Map;return en.push(r),e.frames.forEach(e=>{i.push(createImageBitmap(t,e.frame.x,e.frame.y,e.frame.w,e.frame.h).then(t=>{let i={image:t,width:e.frame.w,height:e.frame.h,centreX:e.sourceSize.w/2-e.spriteSourceSize.x,centreY:e.sourceSize.h/2-e.spriteSourceSize.y};return r.set(e.filename,i),e.filename}))}),Promise.all(i)})(e,t))}};let ea=0;var eh={updateTimeNow:function(e){ea=e},getFrameCount:function(e){return Math.floor(ea/e)}};const el={WRAP:0,REVERSE:1,STOP:2};class ec{#e;#t;#i;#r;#n;constructor(e,t){this.#e=e,this.#t=e-1,this.#i=t,this.#r=1,this.#n=0}get index(){return this.#n}set index(e){this.#n=S(e,0,this.#e-1)}advanceBy(e){if(this.#e<1)return this.#n;switch(this.#i){case el.WRAP:return this.#s(e);case el.REVERSE:return this.#o(e);case el.NONE:default:return this.#a(e)}}#s(e){return e%=this.#e,this.#n+=e%this.#e,this.#n>=this.#e&&(this.#n=this.#n-this.#e),this.#n}#o(e){if(Math.floor(e/this.#e)%2&&(this.#r=-this.#r),e%=this.#e,this.#r>0){this.#n+=e;let t=this.#n-this.#t;t>0&&(this.#n=this.#t-t,this.#r=-1)}else this.#r<0&&(this.#n-=e,this.#n<0&&(this.#n=-this.#n,this.#r=1));return this.#n}#a(e){return this.#r>0?this.#n=Math.min(this.#t,this.#n+e):this.#r<0&&(this.#n=Math.max(0,this.#n-e)),this.#n}}class eu{playing;#h;#l;#c;#u;constructor(e,t,i){let r;if(this.#h=[],this.#c=0,"string"==typeof t){this.#h.push(eo.getSpriteBitmap(e,t));return}this.#u=Math.max(1,i.framePeriodMs);let n=t.startIndex??0,s=t.padding??0;do{let i=`${t.prefix}${n.toString().padStart(s,"0")}${t.suffix}`;(r=eo.getSpriteBitmap(e,i))&&this.#h.push(r),n++}while(r)this.#l=new ec(this.#h.length,i.loopMethod),this.playing=!0}getCurrentFrame(){if(!(this.#h.length>1))return this.#h[0];if(this.playing){let e=eh.getFrameCount(this.#u);e!==this.#c&&(this.#l.advanceBy(e-this.#c),this.#c=e)}return this.#h[this.#l.index]}setCurrentIndex(e){this.#h.length>1&&(this.playing=!1,this.#l.index=e)}getCurrentIndex(){return this.#h.length>1?this.#l.index:0}}class ed{#d;#m;constructor(e,t){this.#d={},this.#d[e]=t,this.#m=t}get image(){return this.#m}addAnimatedImage(e,t){this.#d[e]=t}setCurrentKey(e){this.#d.hasOwnProperty(e)?this.#m=this.#d[e]:f.error(`Attempt to set current key to nonexistent value of ${e}`)}getCurrentFrame(){return this.#m.getCurrentFrame()}}class em{_context;_boundingBoxCanvas;constructor(e){this._context=e,this._boundingBoxCanvas=new M(0,0,0,0)}getContext(){return this._context}getBoundingBoxCanvas(){return this._boundingBoxCanvas}render(e,t){if(e=Z.worldPositionToCanvas(e),!this.isOnCanvas(e))return;let i=this._context.globalAlpha;this._context.globalAlpha=i*t;let r=e.rotation;r&&(this._context.save(),this._context.translate(e.x,e.y),this._context.rotate(-e.rotation),this._context.translate(-e.x,-e.y)),this._doRender(e),r&&this._context.restore(),er.spriteBoxes&&(this._context.strokeStyle="green",this._context.strokeRect(this._boundingBoxCanvas.x,this._boundingBoxCanvas.y,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height)),this._context.globalAlpha=i}_doRender(e){f.error("_doRender method should be overridden.")}isOnScreen(e){let t=new M(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return Z.isOnScreen(t)}isOnCanvas(e){let t=new M(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return Z.isOnCanvas(t)}}class ep extends em{#p;#f;#g;text;constructor(e,t,i="normal"){super(e),this.text=t,this.#p=i}#w(e){this._context.font=y(this.#p);let t=this._context.measureText(e);this.#g={width:t.width,height:t.fontBoundingBoxAscent+t.fontBoundingBoxDescent,origin:{x:-.5*t.width,y:.5*(t.fontBoundingBoxAscent-t.fontBoundingBoxDescent)}},this.#f=e}_doRender(e){var t;this.text!==this.#f&&this.#w(this.text);let i={x:e.x+this.#g.origin.x,y:e.y+this.#g.origin.y,rotation:e.rotation};ei(this._context,this.#f,i,{styleName:this.#p}),this._boundingBoxCanvas=(t=this.#g,new M(e.x-t.width/2,e.y-t.height/2,t.width,t.height))}}class ef extends em{#y;#x;#S;#T;#E;#v;constructor(e,t){super(e),this.#y=t.width??10,this.#x=t.height??10,this.#S=this.#y/2,this.#T=this.#x/2,this.#E=t.fillStyle,this.#v=t.strokeStyle}_doRender(e){let t=e.x-this.#S,i=e.y-this.#T;this.#E&&(this._context.fillStyle=this.#E,this._context.fillRect(t,i,this.#y,this.#x)),this.#v&&(this._context.strokeStyle=this.#v,this._context.strokeRect(t,i,this.#y,this.#x)),this._boundingBoxCanvas=new M(t,i,this.#y,this.#x)}}class eg extends em{#x;#T;#y;#S;#E;#v;#C;#P;#b;#M;constructor(e,t){super(e),this.#x=t.height,this.#T=this.#x/2,this.#y=t.width,this.#S=this.#y/2,this.#E=t.fillStyle,this.#v=t.strokeStyle,this.#C=t.offsetX??0,this.#P=t.offsetY??0,this.setLevel(0)}setLevel(e){this.#b=Math.min(e,1)*this.#x,this.#M=.5*this.#b}_doRender(e){let t=e.y-this.#T+this.#P,i=e.y+this.#T-this.#b+this.#P,r=e.x-this.#S+this.#C;this.#E&&(this._context.fillStyle=this.#E,this._context.fillRect(r,i,this.#y,this.#b)),this.#v&&(this._context.strokeStyle=this.#v,this._context.strokeRect(r,t,this.#y,this.#x)),this._boundingBoxCanvas=new M(r,t,this.#y,this.#x)}}class ew extends em{#z;constructor(e,t){super(e);let i=Math.max(t.fillStyles.length??0,t.strokeStyles.length??0);if(0===i){f.error("Attempt to create MultiGaugeTileRenderer with no gauges.");return}this.#z=[];let r=t.tileSize/i,n=-t.tileSize/2+r/2;for(let s=0;s<i;s++)this.#z.push(new eg(e,{width:r,height:t.tileSize,fillStyle:t.fillStyles?.[s],strokeStyle:t.strokeStyles?.[s],offsetX:n+r*s,offsetY:0}))}setLevel(e,t){this.#z[e]?.setLevel(t)}render(e){this.#z?.forEach(t=>t.render(e))}}class ey extends em{#R;#I;constructor(e,t){super(e),t?.getCurrentFrame?(this.#I=t,this.#R=this.#I.getCurrentFrame()):this.#R=t,this.#R?(this._boundingBoxCanvas.width=this.#R?.width??0,this._boundingBoxCanvas.height=this.#R?.height??0):f.error("No image frame available for sprite.",t)}_doRender(e){if(!this.#R)return;let t=this.#I?this.#I.getCurrentFrame():this.#R;this._boundingBoxCanvas.x=e.x-this._boundingBoxCanvas.width/2,this._boundingBoxCanvas.y=e.y-this._boundingBoxCanvas.height/2,this._context.drawImage(t.image,e.x-t.centreX,e.y-t.centreY)}}class ex{#O=new b(0,0,0);#k=new P(0,0,0);#L;#B;modifier;visible;opacity;constructor(e){this.#L=e?.renderer,this.#B=Array.isArray(this.#L),this.visible=!0,this.opacity=1}get position(){return this.#O}set position(e){this.#O.x=this.valueOrZero(e.x),this.#O.y=this.valueOrZero(e.y),this.#O.rotation=this.valueOrZero(e.rotation)}get velocity(){return this.#k}set velocity(e){this.#k.x=this.valueOrZero(e.x),this.#k.y=this.valueOrZero(e.y),this.#k.rotation=this.valueOrZero(e.rotation)}valueOrZero(e){return"number"==typeof e?e:0}update(e){this.modifier&&(this.modifier=this.modifier.update(this,e)),this.visible&&this.#A()}#A(){this.#L&&(this.#L.forEach?this.#L.forEach(e=>e.render(this.#O,this.opacity)):this.#L.render(this.#O,this.opacity))}getBoundingBox(){let e=this.#L.getBoundingBoxCanvas();return new M(this.position.x-e.width/2,this.position.y-e.height/2,e.width,e.height)}}class eS{decoratedModifier;#_;#N;#D;constructor(e){this.#N=0,this.#D=0,this.decoratedModifier=e}applyAsTransientToSprite(e,t=10){return this.#D=t,new Promise(t=>{this.#_=t,e.modifier=this})}applyAsContinuousToSprite(e){e.modifier=this}update(e,t){this.#_&&(this.#N+=t),this.decoratedModifier&&(this.decoratedModifier=this.decoratedModifier?.update(e,t));let i=this.doUpdate(e,t);return!i||this.#N>this.#D?(this.#_?.(null),null):i}doUpdate(e,t){return f.error("doUpdate should be overridden."),this}}class eT extends eS{#G;constructor(e,t){super(t),this.#G=1/Math.max(e,.5)}doUpdate(e,t){return e.opacity=Math.max(0,e.opacity-t*this.#G),e.opacity>0?this:null}}class eE{#W;#F;constructor(e,t){this.#W=e,this.#F=t}getSpeedBetweenPoints(e,t){return this.#F?this.#W:(1+.1*(Math.abs(e.x-t.x)+Math.abs(e.y-t.y)))*this.#W}}class ev extends eS{#H;#U;constructor(e){super(e)}doUpdate(e,t){let i=e.position,r=e.velocity;return i.x+=r.x*t,i.y+=r.y*t,e.position=i,e.velocity=r,this}}class eC extends eS{#$;#V;#X;constructor(e,t){super(t),this.#$=e.prey,this.#V=e.maxSeparation,this.#X=new eE(e.speed,e.linear)}doUpdate(e,t){let i=this.#$.position,r=e.position,n=this.#X.getSpeedBetweenPoints(i,r);if(!r.withinSquare(i,this.#V)){let s=r.getCartesianAngleTo(i);e.velocity.x=n*Math.cos(s),e.velocity.y=n*Math.sin(s);let o=e.velocity.x*t,a=e.velocity.y*t;e.position.x+=this.getMinMove(o,i.x,r.x),e.position.y+=this.getMinMove(a,i.y,r.y)}return this}getMinMove(e,t,i){let r=t-i;return 0>Math.sign(e)?Math.max(e,r):Math.min(e,r)}}class eP extends eS{#K;#n;#Y;#X;constructor(e,t){super(t),this.#K=e.path,this.#n=0,this.#Y=e.path[0],this.#X=new eE(e.speed,e.linear)}doUpdate(e,t){let i=e.position,r=this.#X.getSpeedBetweenPoints(this.#Y,i),n=i.getCartesianAngleTo(this.#Y);e.velocity.x=r*Math.cos(n),e.velocity.y=r*Math.sin(n);let s=e.velocity.x*t,o=e.velocity.y*t;if(i.x+=this.getMinMove(s,this.#Y.x,i.x),i.y+=this.getMinMove(o,this.#Y.y,i.y),i.isCoincident(this.#Y)){if(++this.#n>=this.#K.length)return e.velocity.x=0,e.velocity.y=0,this.decoratedModifier;this.#Y=this.#K[this.#n]}return this}getMinMove(e,t,i){let r=t-i;return 0>Math.sign(e)?Math.max(e,r):Math.min(e,r)}}function eb(e,t){let i=new ex({renderer:e});i.position=t.position,i.velocity=t.velocity,et.addPassiveSprite(i),new eT(t.lifetimeSecs,new ev).applyAsTransientToSprite(i,20).then(()=>et.removePassiveSprite(i))}function eM(e,t){eb(new ep(Z.getContext2D(),e),t)}function ez(e=6){return v(1,e)}var eR={TILE_SIZE:48};const eI=new class{#Z;constructor(){this.#Z=new Map}set(e,t){this.#Z.set(e,t);try{localStorage.setItem(e,JSON.stringify(t))}catch(e){f.error(`Cannot save setting. ${e.message}`)}}get(e,t){if(this.#Z.has(e))return this.#Z.get(e);let i=t;try{let t=localStorage.getItem(e);null!==t&&(i=JSON.parse(t))}catch(e){f.error(`Cannot parse value from local storage. ${e.message}`)}return this.#Z.set(e,i),i}};class eO{_element;#q;#j;#J;closes;constructor(e){if(e.closes&&e.action)throw Error(`Attempt made to create control ${e.id} that is set to close forms and perform and action. These are mutually exclusive.`);this.#q=e.id,this.#J=e.persistent,e.persistent?this.#j=eI.get(this.#q,e.defValue):this.#j=e.defValue,this.closes=e.closes,this.listeners=0}get element(){return this._element}get value(){return this.#j}set value(e){e!==this.#j&&(this.#J&&eI.set(this.#q,e),this.#j=e)}}class ek extends eO{constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return t.appendChild(document.createTextNode(e.label)),t.className="text-button",t}}class eL extends eO{constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return t.appendChild(document.createTextNode(e.label)),t.appendChild(eB(e.index,e.imageName,"button-icon")),t.className="icon-button",t}}function eB(e=0,t,i){let r=eo.getSpriteBitmap(e,t),n=document.createElement("canvas");n.setAttribute("width",eR.TILE_SIZE),n.setAttribute("height",eR.TILE_SIZE);let s=n.getContext("2d");return s.clearRect(0,0,eR.TILE_SIZE,eR.TILE_SIZE),s.drawImage(r.image,.5*(eR.TILE_SIZE-r.width),.5*(eR.TILE_SIZE-r.height)),n.className=i,n}class eA extends eO{#Q;constructor(e){super(e),this._element=this.buildElement(e.label),this.#Q.checked=this.value,this._element.addEventListener("change",t=>{this.value=this.#Q.checked,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-checkbox",this.#Q=document.createElement("input"),this.#Q.setAttribute("type","checkbox"),t.appendChild(this.#Q),t.appendChild(eB(0,"ui-checkbox00.png","unchecked")),t.appendChild(eB(0,"ui-checkbox01.png","checked"));let i=document.createElement("label");return i.appendChild(document.createTextNode(e)),i.appendChild(t),i}}class e_ extends eO{#ee;constructor(e){super(e),this._element=this.buildElement(e.label),this.#ee.value=this.value,this._element.addEventListener("change",t=>{this.value=this.#ee.value,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-range",this.#ee=document.createElement("input"),this.#ee.setAttribute("type","range"),t.appendChild(this.#ee);let i=document.createElement("label");return i.appendChild(document.createTextNode(e)),i.appendChild(t),i}}const eN={TEXT_BUTTON:"text button",CHECKBOX:"checkbox",RANGE:"range"};function eD(e){let t=document.createElement("div");return t.innerText=e,t.classList.add(["scrollable"]),t}var eG={showMessage:function(e){let t=document.createElement("div");t.appendChild(document.createTextNode(e)),t.className="popup",t.style.opacity=1,document.body.appendChild(t),t.addEventListener("click",()=>t.remove())},showOkDialog:function(e,t="OK",i){let r=document.createElement("div");r.appendChild(eD(e));let n=document.createElement("button");return n.appendChild(document.createTextNode(t)),r.appendChild(n),Z.displayOnGlass(r,[{element:n,id:0,closer:!0}],i)},showControlsDialog:function(e,t,i){let r=document.createElement("div");r.appendChild(eD(e));let n=[];if(t?.forEach(e=>{r.appendChild(e.element),e.closes&&n.push({element:e.element,response:e.id})}),0===n.length){let e=new ek({label:"OK"});r.appendChild(e.element),n.push(e)}return Z.displayOnGlass(r,n,i)}};const eW=new class{#et;#ei;#er;#en;constructor(){this.#er=.5,this.#en=.5,this.#et=new Map}loadAndPlayMusic(e){if(this.#ei)throw Error("Only one music track currently supported.");this.#ei=this.#es(e),this.#ei&&this.#ei.addEventListener("canplay",e=>{this.#ei.volume=this.#er,this.#ei.loop=!0,this.#ei.play()})}loadEffects(e){let t=[];return e.forEach((e,i)=>{let r=new Promise(t=>{let r=this.#es(e);r&&r.addEventListener("canplay",e=>{this.#et.set(i,r),t()})});t.push(r)}),Promise.all(t)}#es(e){return e?new Audio(e):null}playEffect(e){let t=this.#et.get(e);t&&(t.volume=this.#en,t.play())}setMusicVolumePercent(e){this.#er=e/100,this.#ei&&(this.#ei.volume=this.#er)}setEffectsVolumePercent(e){this.#en=e/100}};class eF{actor;constructor(e){this.actor=e}enact(e){return Promise.resolve()}react(e){return Promise.resolve()}allowEscape(e){return!0}}class eH extends eF{constructor(e){super(e)}enact(e){return this.#eo(this.actor,e)}react(e){return this.#eo(e,this.actor)}allowEscape(e){return this.actor,ez(20)>10||(eM("Failed to run.",{lifetimeSecs:2,position:e.position,velocity:new P(0,-100,0)}),!1)}#ea(e,t){let i=C.copy(e.position);return new eP({path:[new C(e.position.x+.2*(t.position.x-e.position.x),e.position.y+.2*(t.position.y-e.position.y)),i],speed:100}).applyAsTransientToSprite(e.sprite)}#eh(e,t){return new Promise(e=>{var i,r;if(ez(20)>10)eW.playEffect("PUNCH"),i=eo.getSpriteBitmap(0,eI.get("BLOOD_ON")?"blood-splat.png":"pow.png"),r={lifetimeSecs:1,position:t.position,velocity:new P(0,0,0)},eb(new ey(Z.getContext2D(),i),r);else{eW.playEffect("MISS"),eM("Missed",{lifetimeSecs:2,position:t.position,velocity:new P(0,-100,0)}),e();return}let n=t.traits.get("HP"),s=ez(6);n=Math.max(0,n-s),t.traits.set("HP",n),0===n?(eW.playEffect("DIE"),f.info("Killed actor."),t.interaction=new eU,t.alive=!1):eM(`-${s} HP`,{lifetimeSecs:2,position:t.position,velocity:new P(0,-200,0)}),e(n)})}#eo(e,t){return this.#ea(e,t).then(()=>this.#eh(e,t))}}class eU extends eF{constructor(e){super(e)}react(e){return eG.showOkDialog("A bit macabre, but you're trying to search a corpse. I haven't written the code yet.")}}class e$ extends eF{constructor(e){super(e)}react(e){return eG.showOkDialog("Time to trade. I haven't written the code yet.")}}class eV{#el;#ec;#eu;#ed;setOnClick(e){this.#el=e}setOnContextClick(e){this.#ec=e}setOnPointerDown(e){this.#eu=e}setOnPointerUp(e){this.#ed=e}actionClick(e){this.#el?.(this,e)}actionContextClick(e){this.#ec?.(this,e)}actionPointerDown(e){this.#eu?.(this,e)}actionPointerUp(e){this.#ed?.(this,e)}}class eX extends eV{maxTilesPerMove;sprite;traits;interaction;alive;constructor(e){super(),this.interaction=new eF,this.sprite=e,this.sprite.obstacle=!0,this.maxTilesPerMove=4,this.alive=!0}set visible(e){this.sprite.visible=e}get visible(){return this.sprite.visible}get obstacle(){return this.sprite.obstacle}set obstacle(e){this.sprite.obstacle=e}get position(){return this.sprite.position}set position(e){this.sprite.position=e}get velocity(){return this.sprite.velocity}set velocity(e){this.sprite.velocity=e}isWandering(){return this?.traits.get("MOVE")==="wander"}isPassableByActor(e){return!this.alive||!this.obstacle}canShareLocationWithActor(e){return!this.obstacle}update(e){this.sprite.update(e)}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionContextClick(this.sprite.position)}actionPointerUp(e){super.actionPointerUp(this.sprite.position)}actionPointerDown(e){super.actionPointerDown(this.sprite.position)}}const eK={OFF:0,HERO:1,VELOCITY:2};class eY{#em;#ep;#ef;#eg;constructor(e,t,i=0){let r=Z.getCanvasDimensions(),n=i*Math.min(r.width,r.height);this.#em=new ex,this.#ep=new eC({prey:e,speed:t,maxSeparation:n}),this.#ef=new ev,this.#ep.applyAsContinuousToSprite(this.#em)}update(e){this.#eg!==eK.OFF&&(this.#em.update(e),Z.centreCanvasOn(this.#em.position))}setVelocity(e,t){this.setTrackingMethod(eK.VELOCITY),this.#em.velocity.x=e,this.#em.velocity.y=t}panBy(e,t){this.#em.position.x+=e,this.#em.position.y+=t,Z.centreCanvasOn(this.#em.position)}setTrackingMethod(e){if(e!==this.#eg)switch(this.#eg=e,e){case eK.HERO:this.#ep.applyAsContinuousToSprite(this.#em);break;case eK.VELOCITY:this.#ef.applyAsContinuousToSprite(this.#em);break;case eK.OFF:break;default:f.error(`Attempt to set invalid tracking method of ${e} ignored.`)}}}const eZ={TR:0,BR:1,BL:2,TL:3};class eq{#ew;#ey;#ex;constructor(e,t,i){this.#ew=e,this.#eS(t,i)}#eS(e,t){let i,r;switch(t){case eZ.TL:i=2*e,r=2*e;break;case eZ.TR:i=-2*e,r=2*e;break;case eZ.BR:i=-2*e,r=-2*e;break;case eZ.BL:i=2*e,r=-2*e}this.#eT(i,r),this.#eE(i,r,e)}#eT(e,t){this.#ex=new eu(0,{prefix:"hud-auto-centre",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:el.STOP}),this.#ey=e0.addButton(this.#ex,()=>{this.setTrackingState(!0)},()=>{this.setTrackingState(!1)}),this.#ey.position.x=e,this.#ey.position.y=t,this.#ey.actionClick(null)}setTrackingState(e){e?(this.#ex.setCurrentIndex(1),this.#ew.setTrackingMethod(eK.HERO)):(this.#ex.setCurrentIndex(0),this.#ew.setTrackingMethod(eK.OFF))}#eE(e,t,i){let r=3*i;this.#ev("hud-arrow-up",e,t-i,()=>{this.setTrackingState(!1),this.#ew.setVelocity(0,-r)},()=>this.#ew.setTrackingMethod(eK.OFF)),this.#ev("hud-arrow-right",e+i,t,()=>{this.setTrackingState(!1),this.#ew.setVelocity(r,0)},()=>this.#ew.setTrackingMethod(eK.OFF)),this.#ev("hud-arrow-down",e,t+i,()=>{this.setTrackingState(!1),this.#ew.setVelocity(0,r)},()=>this.#ew.setTrackingMethod(eK.OFF)),this.#ev("hud-arrow-left",e-i,t,()=>{this.setTrackingState(!1),this.#ew.setVelocity(-r,0)},()=>this.#ew.setTrackingMethod(eK.OFF))}#ev(e,t,i,r,n){let s=new eu(0,{prefix:e,startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:el.STOP}),o=e0.addMomentaryButton(s,r,n);o.position.x=t,o.position.y=i,s.setCurrentIndex(0)}}const ej=new Map;let eJ=!1;function eQ(e,t){let i=Z.glassPositionToWorld(t.position),r=t.sprite.getBoundingBox();return new M(i.x-r.width/2,i.y-r.height/2,r.width,r.height).containsCoordinate(e.world.x,e.world.y)}function e4(e){if(!eJ||!eJ)return!1;for(let[t,i]of ej)if(eQ(e,i))return i.actionPointerUp(i,e.canvas),!0;return!1}var e0={addButton:function(e,t,i){let r=new eX(new ex({renderer:new ey(Z.getContext2D(),e)}));return ej.set(r,r),r.setOnClick(()=>{i?0===e.getCurrentIndex()?(e.setCurrentIndex(1),t()):(e.setCurrentIndex(0),i()):t()}),e.setCurrentIndex(0),r},addMomentaryButton:function(e,t,i){let r=new eX(new ex({renderer:new ey(Z.getContext2D(),e)}));return ej.set(r,r),r.setOnPointerDown(()=>{e.setCurrentIndex(1),t?.()}),r.setOnPointerUp(()=>{e.setCurrentIndex(0),i?.()}),r},clear:function(){ej.clear()},removeButton:function(e){ej.delete(e)},update:function(e){eJ&&ej.forEach(t=>{let i=b.copy(t.position);t.position=Z.glassPositionToWorld(t.position),t.update(e),t.position=i})},resolvePointerCancel:function(e){return e4(e)},resolveClick:function(e){if(!eJ)return!1;for(let[t,i]of ej)if(eQ(e,i))return i.actionClick(i,e.canvas),!0;return!1},resolveContextMenu:function(e){return!1},resolvePointerDown:function(e){if(!eJ||!eJ)return!1;for(let[t,i]of ej)if(eQ(e,i))return i.actionPointerDown(i,e.canvas),!0;return!1},resolvePointerUp:e4,setVisible:function(e){eJ=e}};const e1={GRINNING:"\uD83D\uDE00",SANTA:"\uD83C\uDF85",SHAKING:"\uD83E\uDEE8"};var e8={};e8=new URL("dungeon_script.e102251e.txt",import.meta.url).toString();const e2={DUNGEON_SCRIPT:new URL(e8)},e3={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:el.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:el.REVERSE}},WALK_NORTH:{keyName:"WALK_N",suffix:"walk-n",options:{framePeriodMs:100,loopMethod:el.REVERSE}},WALK_EAST:{keyName:"WALK_E",suffix:"walk-e",options:{framePeriodMs:100,loopMethod:el.REVERSE}},WALK_SOUTH:{keyName:"WALK_S",suffix:"walk-s",options:{framePeriodMs:100,loopMethod:el.REVERSE}},WALK_WEST:{keyName:"WALK_W",suffix:"walk-w",options:{framePeriodMs:100,loopMethod:el.REVERSE}}};var e6={definitions:e3,formFrameNameRoot:function(e,t){let i=e3[e]?.suffix;if(!i)throw Error(`Attempt made to use invalid standard animation key of '${e}'`);return`${t}-${i}`}};class e7 extends ew{actor;constructor(e,t){super(e,t)}render(e){if(this.actor&&this.actor.traits){let e=this.actor.traits.get("HP"),t=this.actor.traits.get("HP_MAX");this.setLevel(0,e/t),this.setLevel(1,1)}super.render(e)}}class e5 extends ed{#eC;#eP;#eb;constructor(e,t){super(e,t),this.#eP=T.NONE}setActor(e){this.#eC=e,this.#eb=this.#eC.alive}getCurrentFrame(){let e=this.#eM();return(e!==this.#eP||this.#eb!=this.#eC?.alive)&&(this.#eP=e,this.#eb=this.#eC?.alive,this.#ez()),super.getCurrentFrame()}#eM(){return!this.#eC||this.#eC.velocity.isZero(.1)?T.NONE:function(e){let t=Math.abs(e);return t<=x.DEG_45?T.E:t<=x.DEG_135?Math.sign(e)>0?T.N:T.S:T.W}(this.#eC.velocity.getScreenDirection())}#ez(){if(!this.#eC.alive)return this.setCurrentKey(e6.definitions.DEAD.keyName);switch(this.#eP){case T.NONE:this.setCurrentKey(e6.definitions.IDLE.keyName);break;case T.E:this.setCurrentKey(e6.definitions.WALK_EAST.keyName);break;case T.N:case T.NW:case T.NE:this.setCurrentKey(e6.definitions.WALK_NORTH.keyName);break;case T.W:this.setCurrentKey(e6.definitions.WALK_WEST.keyName);break;default:this.setCurrentKey(e6.definitions.WALK_SOUTH.keyName)}}}function e9(e){let t=function(e){let t=new e5("still",new eu(0,`${e}.png`));for(let i in e6.definitions){let r=e6.definitions[i];t.addAnimatedImage(e6.definitions[i].keyName,new eu(0,{prefix:e6.formFrameNameRoot(i,e),suffix:".png",startIndex:0,padding:2},r.options))}return t.setCurrentKey(e6.definitions.IDLE.keyName),t}(e),i=new ey(Z.getContext2D(),t),r=new e7(Z.getContext2D(),{tileSize:et.getTileMap().getGridSize()-2,fillStyles:["rgba(255, 0, 0, 0.2)","rgba(0, 0, 255, 0.2)"],strokeStyles:[]}),n=new eX(new ex({renderer:[r,i]}));return t.setActor(n),r.actor=n,n.position=new b(eR.TILE_SIZE,eR.TILE_SIZE,0),n.velocity={x:0,y:0,rotation:.1},n}const te=new Map([["HERO",{create:()=>e9("hero")}],["MONSTER",{create:()=>(function(e){let t=e9("orc");return t.interaction=new eH(t),t})(0)}],["TRADER",{create:()=>(function(e){let t=e9(e);return t.interaction=new e$(t),t})("trader")}]]);function tt(e,t,i){return{centre:e[t]?.[i],tl:e[t-1]?.[i-1],above:e[t-1]?.[i],tr:e[t-1]?.[i+1],right:e[t]?.[i+1],br:e[t+1]?.[i+1],below:e[t+1]?.[i],bl:e[t+1]?.[i-1],left:e[t]?.[i-1]}}function ti(e){let t,i=e.length;for(;i>0;)t=Math.floor(Math.random()*i),i--,[e[i],e[t]]=[e[t],e[i]];return e}const tr={WALL:["#","*","|"],DOOR_IN:["-"],DOOR_OUT:["="],GROUND:[".",":",",",";"],VOID:[" "]},tn={TOP_LEFT:"-TL",TOP_LEFT_INTERNAL:"-TLI",TOP:"-T",TOP_RIGHT:"-TR",TOP_RIGHT_INTERNAL:"-TRI",RIGHT:"-R",BOTTOM_RIGHT:"-BR",BOTTOM_RIGHT_INTERNAL:"-BRI",BOTTOM:"-B",BOTTOM_LEFT:"-BL",BOTTOM_LEFT_INTERNAL:"-BLI",LEFT:"-L",TOP_TEE:"-TTEE",RIGHT_TEE:"-RTEE",BOTTOM_TEE:"-BTEE",LEFT_TEE:"-LTEE",INTERNAL_CROSS:"-XI",INTERNAL_VERTICAL:"-VI",INTERNAL_HORIZONTAL:"-HI"},ts={BELOW_WALL:"-SBW",BELOW_END_WALL:"-SBE"};class to{matrix;entryPointByDoor;exitPointByDoor;constructor(){this.entryPointByDoor=new C(0,0),this.exitPointByDoor=new C(0,0)}static generateTileMapPlan(e,t){let i=new to,r=i.convertToMatrix(e);return r=i.clarifyMatrix(r),i.createPlan(r,t),i}convertToMatrix(e){let t=[],i=0;return e.forEach(e=>{i=Math.max(i,e.length)}),e.forEach(e=>{e.length<i&&(e+=" ".repeat(i-length)),t.push(e.split(""))}),t}clarifyMatrix(e){let t=[];return e.forEach((i,r)=>{let n=[];t.push(n),i.forEach((t,i)=>{var s,o,a,h;let l;let c=tt(e,r,i);(s=t,tr.VOID.includes(s))?t=" ":tl(t)?(o=t,tc(c.above)&&(tc(c.tl)?o+=ts.BELOW_WALL:o+=ts.BELOW_END_WALL),a=t=o,ta(c.left)||ta(c.above)||ta(c.right)||ta(c.below))?this.entryPointByDoor=new C(i,r):(th(c.right)||th(c.below)||th(c.left)||th(c.above))&&(this.exitPointByDoor=new C(i,r)):tc(t)&&(l=h=t,tc(c.above)&&tc(c.right)&&tc(c.below)&&tc(c.left)?l+=tn.INTERNAL_CROSS:tl(c.left)&&tl(c.right)?l+=tn.INTERNAL_VERTICAL:tl(c.above)&&tl(c.below)?l+=tn.INTERNAL_HORIZONTAL:tc(c.left)&&tc(c.right)&&tc(c.below)?l+=tn.TOP_TEE:tc(c.above)&&tc(c.below)&&tc(c.left)?l+=tn.RIGHT_TEE:tc(c.left)&&tc(c.right)&&tc(c.above)?l+=tn.BOTTOM_TEE:tc(c.above)&&tc(c.below)&&tc(c.right)?l+=tn.LEFT_TEE:tc(c.right)&&tc(c.below)?l+=tl(c.br)?tn.TOP_LEFT:tn.TOP_LEFT_INTERNAL:tc(c.left)&&tc(c.below)?l+=tl(c.bl)?tn.TOP_RIGHT:tn.TOP_RIGHT_INTERNAL:tc(c.left)&&tc(c.above)?l+=tl(c.tl)?tn.BOTTOM_RIGHT:tn.BOTTOM_RIGHT_INTERNAL:tc(c.right)&&tc(c.above)?l+=tl(c.tr)?tn.BOTTOM_LEFT:tn.BOTTOM_LEFT_INTERNAL:tc(c.above)&&tc(c.below)?l+=tl(c.right)?tn.LEFT:tn.RIGHT:tc(c.right)&&tc(c.left)&&(l+=tl(c.below)?tn.TOP:tn.BOTTOM),t=tc(c.above)?l+ts.BELOW_WALL:l),n.push(t)})}),t}createPlan(e,t){let i=[];e.forEach(e=>{let r=[];i.push(r),e.forEach(e=>{r.push(function e(t,i){if(" "===t)return null;let r=t.match(/(.)(-[^-]*)?(-[^-]*)?/),n=i.get(t);if(!n&&r[2]&&r[3]&&(n=i.get(`${r[1]}${r[2]}`)),!n&&r[2]&&(n=i.get(r[1])),!n){let n=function(e){for(let t in tr)if(tr[t].includes(e))return tr[t][0];return null}(r[1]);if(n&&n!==r[1]){var s,o;let t;return e((s=r[2],o=r[3],t=n,s&&(t+=s),o&&(t+=o),t),i)}f.error(`Failed to find symbol for ${t}`)}return n}(e,t))})}),this.matrix=i}}function ta(e){return tr.DOOR_IN.includes(e)}function th(e){return tr.DOOR_OUT.includes(e)}function tl(e){return tr.GROUND.includes(e)}function tc(e){var t;return tr.WALL.includes(e)||ta(t=e)||th(t)}class tu{#eR;#eI;constructor(e){this.#eI=e,this.#eR=new Map}setRouteToCoords(e,t,i){this.#eR.set(this.coordsToKey(t,i),e)}getRouteToCoords(e,t){return this.#eR.get(this.coordsToKey(e,t))}hasRouteToCoords(e,t){return this.#eR.has(this.coordsToKey(e,t))}coordsToKey(e,t){return`${e}|${t}`}keyToGridPoint(e){let t=e.split("|");return new C(parseInt(t[0]),parseInt(t[1]))}forEach(e){this.#eR.forEach((t,i,r)=>e(t,i,r))}containsGridPoint(e){return this.#eR.has(this.coordsToKey(e.x,e.y))}getWaypointsAsGridPoints(e){let t=this.getRouteToCoords(e.x,e.y);return t.length>1?t.slice(1):null}getWaypointsAsWorldPoints(e){let t=this.getWaypointsAsGridPoints(e);return t?t.map(e=>this.#eI.gridPointToWorldPoint(e)):t}}class td{actor;#eR;#eI;#eO;constructor(e,t){this.#eI=e,this.actor=t}getDumbRouteNextTo(e,t,i){let r=this.#ek(e,t);if(r.coincident(e))return[];this.#eI.canGridPointBeOccupiedByActor(r,this.actor)||(r=this.#eL(r,t));let n=[],s=Math.sign(r.x-e.x),o=Math.sign(r.y-e.y),a=C.copy(e),h=.5>Math.random(),l=0;for(;i>0;){let t=C.copy(a),c=!1;if(h&&0!==s&&a.x!=r.x?(t.x+=s,c=!0):h||0===o||a.y==r.y||(t.y+=o,c=!0),c=c&&this.#eI.canGridPointBeOccupiedByActor(t,this.actor))l=0,a=t,i--;else{if(++l>=2)break;a.coincident(e)||n.push(this.#eI.gridPointToWorldPoint(a)),e=a,h=!h}}return a.coincident(e)||n.push(this.#eI.gridPointToWorldPoint(a)),n}getAllRoutesFrom(e,t){return this.#eR=new tu(this.#eI),this.#eO=e,this.#eB(e.x,e.y,t,null),this.#eR}#eB(e,t,i,r){if(r){if(e===this.#eO.x&&t===this.#eO.y||!this.#eA(e,t))return;let n=this.#eR.getRouteToCoords(e,t);if(n&&!(r.length<n.length-1))return;r.push(new C(e,t)),this.#e_(e,t)&&this.#eR.setRouteToCoords(r,e,t),i--}else r=[new C(e,t)];i>0&&(this.#eB(e,t-1,i,[...r]),this.#eB(e+1,t,i,[...r]),this.#eB(e,t+1,i,[...r]),this.#eB(e-1,t,i,[...r]))}#eA(e,t){return this.#eI.isGridPointPassableByActor(new C(e,t),this.actor)}#e_(e,t){return this.#eI.canGridPointBeOccupiedByActor(new C(e,t),this.actor)}#ek(e,t){let i=t.x-e.x,r=t.y-e.y,n=t.x,s=t.y;return Math.abs(i)>Math.abs(r)?n-=Math.sign(i):s-=Math.sign(r),new C(n,s)}#eL(e,t){return e.x===t.x&&e.y<t.y?new C(e.x+1,e.y+1):e.x>t.x&&e.y===t.y?new C(e.x-1,e.y+1):e.x===t.x&&e.y>t.y?new C(e.x-1,e.y-1):e.x<t.x&&e.y===t.y?new C(e.x+1,e.y-1):e}}class tm{#eC;#eN;#eI;#eD;#eG;#eW;#eF;constructor(e,t){this.#eI=e,this.#eC=t}findReachedTiles(){return this.#eN=this.#eI.worldPointToGrid(this.#eC.position),this.#eW=this.#eI.getMapGridPointRect(),this.#eG&&this.#eG.coincident(this.#eN)&&this.#eW&&this.#eW.equals(this.#eF)||(this.#eD=new Map,this.#eD.set(this.#eN.toString(),this.#eN),this.#eH().forEach(e=>{this.#eU(e)}),this.#eG=this.#eN,this.#eF=this.#eW),this.#eD}isGridPointInRays(e){return!!this.#eD&&this.#eD.has(e.toString())}#eH(){let e=[];for(let t=this.#eW.x;t<=this.#eW.x+this.#eW.width;t++)e.push(new C(t,this.#eW.y)),e.push(new C(t,this.#eW.y+this.#eW.height));for(let t=this.#eW.y+1;t<=this.#eW.y+this.#eW.height-1;t++)e.push(new C(this.#eW.x,t)),e.push(new C(this.#eW.x+this.#eW.width,t));return e}#eU(e){let t,i,r;let n=function(e){let t=Math.abs(e);return t<=x.DEG_22_5?T.E:t<=x.DEG_67_5?Math.sign(e)>0?T.NE:T.SE:t<=x.DEG_112_5?Math.sign(e)>0?T.N:T.S:t<=x.DEG_157_7?Math.sign(e)>0?T.NW:T.SW:T.W}(this.#eN.getScreenAngleTo(e));Math.abs(e.x-this.#eN.x)>=Math.abs(e.y-this.#eN.y)?(t=Math.sign(e.x-this.#eN.x),i=(r=Math.abs(e.x-this.#eN.x))<1?0:(e.y-this.#eN.y)/r):(i=Math.sign(e.y-this.#eN.y),t=(r=Math.abs(e.y-this.#eN.y))<1?0:(e.x-this.#eN.x)/r);let s=this.#eN.x,o=this.#eN.y,a=!0;for(;r>=0;){let e=new C(Math.round(s),Math.round(o));if(a||this.#eI.isSeeThrough(e,this.#eC))this.#e$(e,n);else break;a=!1,s+=t,o+=i,r--}}#e$(e,t){switch(this.#eD.set(e.toString(),e),t){case T.N:this.#eV(new C(e.x-1,e.y-1)),this.#eV(new C(e.x,e.y-1)),this.#eV(new C(e.x+1,e.y-1));break;case T.NE:this.#eV(new C(e.x,e.y-1)),this.#eV(new C(e.x+1,e.y-1)),this.#eV(new C(e.x+1,e.y));break;case T.E:this.#eV(new C(e.x+1,e.y-1)),this.#eV(new C(e.x+1,e.y)),this.#eV(new C(e.x+1,e.y+1));break;case T.SE:this.#eV(new C(e.x+1,e.y)),this.#eV(new C(e.x+1,e.y+1)),this.#eV(new C(e.x,e.y+1));break;case T.S:this.#eV(new C(e.x-1,e.y+1)),this.#eV(new C(e.x,e.y+1)),this.#eV(new C(e.x+1,e.y+1));break;case T.SW:this.#eV(new C(e.x-1,e.y)),this.#eV(new C(e.x-1,e.y+1)),this.#eV(new C(e.x,e.y+1));break;case T.W:this.#eV(new C(e.x-1,e.y-1)),this.#eV(new C(e.x-1,e.y)),this.#eV(new C(e.x-1,e.y+1));break;case T.NW:this.#eV(new C(e.x-1,e.y)),this.#eV(new C(e.x-1,e.y-1)),this.#eV(new C(e.x,e.y-1))}}#eV(e){this.#eI.isSeeThrough(e)||this.#eD.set(e.toString(),e)}}function tp(e){return e?tf(o).then(()=>e.load().then(()=>e.initialise()).then(()=>{a=new eq(r,48,eZ.BR),addEventListener("fullscreenchange",()=>{document.fullscreenElement?(f.debug("Entering fullscreen mode"),i.setCurrentIndex(1)):(f.debug("Exiting fullscreen mode."),i.setCurrentIndex(0))}),i=new eu(0,{prefix:"hud-fullscreen",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:el.STOP}),(t=e0.addButton(i,()=>{var e;(e=document.body).requestFullscreen?e.requestFullscreen({navigationUI:"hide"}):Promise.reject(Error("Fullscreen requests not supported by browser"))},()=>{document.exitFullscreen()})).position.x=eR.TILE_SIZE,t.position.y=-eR.TILE_SIZE,e0.setVisible(!0),o=e})):(f.error("Attempt made to switch to the next scene when there are no more."),Promise.reject())}function tf(e){return e?e.unload().then(()=>(et.clearAll(),o=null,a=null,e0.clear(),e0.setVisible(!1),Promise.resolve())):Promise.resolve(null)}function tg(){return++s<n.length?new tY(n[s]):null}var tw={areThereMoreScenes:function(){return s<n.length-1},setCameraToTrack:function(e,t,i){r=new eY(e,t,i)},panCameraBy:function(e,t){r.panBy(e,t),r.setTrackingMethod(eK.OFF),a.setTrackingState(!1)},setSceneDefinitions:function(e){n=e,s=-1},switchToFirstScene:function(){return tp((s=-1,tg()))},switchToNextScene:function(){return tp(tg())},unloadCurrentScene:function(){return tf(o)},update:function(e){o?.update(e),r?.update(e)}};const ty=[{id:"BLOOD_ON",label:"Blood on",defValue:!0,controlType:eN.CHECKBOX,persistent:!0,action:null,closes:!1},{id:"MUSIC_VOLUME",label:"Music volume",defValue:50,controlType:eN.RANGE,persistent:!0,action:null,onChange:e=>eW.setMusicVolumePercent(e),closes:!1},{id:"EFFECTS_VOLUME",label:"Effects volume",defValue:50,controlType:eN.RANGE,persistent:!0,action:null,onChange:e=>{eW.setEffectsVolumePercent(e),eW.playEffect("PUNCH")},closes:!1}],tx={MAIN_MENU:0,CLICKED_FREE_GROUND:1,CLICKED_ENTRANCE:2,CLICKED_EXIT:3};class tS{#eC;#eX;#eK;#eI;#eY;constructor(e,t,i){this.#eC=e,this.#eI=t,this.#eY=i}moveInstantly(){this.#eK=b.copy(this.#eC.position);let e=this.#eI.worldPointToGrid(this.#eC.position),t=this.#eC.isWandering()?this.#eZ(e,this.#eC.maxTilesPerMove):this.#eI.worldPointToGrid(h.position);if(Math.abs(t.x-e.x)+Math.abs(t.y-e.y)<=2*this.#eC.maxTilesPerMove&&this.#eI.canHeroSeeGridPoint(e)){this.#eY.actor=this.#eC;let i=this.#eY.getDumbRouteNextTo(e,t,this.#eC.maxTilesPerMove);i.length>0&&(this.#eX=new eP({path:i,speed:100},this.#eC.sprite.modifier),this.#eq(i[i.length-1]))}}#eZ(e,t){let i=v(e.x-t,e.x+t),r=v(e.y-t,e.y+t),n=this.#eI.getDimsInTiles();return new C(S(i,0,n.width-1),S(r,0,n.height-1))}#eq(e){let t=this.#eI.worldPointToGrid(this.#eC.position);this.#eC.position=e;let i=this.#eI.worldPointToGrid(this.#eC.position);this.#eI.moveTileOccupancyGridPoint(this.#eC,t,i)}#ej(){this.#eq(this.#eK)}replay(){return(this.#ej(),this.#eX)?this.#eX.applyAsTransientToSprite(this.#eC.sprite):Promise.resolve()}}class tT{#eI;#eY;#eJ;constructor(e,t){this.#eJ=[],this.#eI=e,this.#eY=t}addAndMoveActor(e){let t=new tS(e,this.#eI,this.#eY);t.moveInstantly(),this.#eJ.push(t)}replay(){let e=[];return this.#eJ.forEach(t=>e.push(t.replay())),Promise.all(e)}}class tE{constructor(){}async transitionTo(e){await this.onExit().then(()=>(tB=e,e.onEntry()))}onEntry(){return Promise.resolve()}onEvent(e){return Promise.resolve(null)}onExit(){return Promise.resolve(null)}}class tv extends tE{onEntry(){return(function(){let e=new eL({id:"PLAY",label:"Play",imageName:"ui-play00.png",internalLabel:!0,closes:!0}),t=new eL({id:"SETTINGS",label:"Settings",imageName:"ui-settings00.png",internalLabel:!0,action:()=>(function(){let e=[];return ty.forEach(t=>{e.push(function(e){let t;switch(e.controlType){case eN.CHECKBOX:t=new eA(e);break;case eN.RANGE:t=new e_(e);break;case eN.TEXT_BUTTON:t=new ek(e);break;default:throw Error(`Attempt to create unrecognised control type ${e.controlType}`)}return t}(t))}),eG.showControlsDialog("Settings",e,"door")})(),closes:!1});return eG.showControlsDialog("Welcome to the Scripted Dungeon",[t,e],"door")})().then(()=>this.transitionTo(new tC))}}class tC extends tE{onEntry(){return f.log("Enter AtStart"),eG.showOkDialog("You are in a dark and dingy dungeon.","Conquer it!","wall").then(()=>tw.switchToFirstScene()).then(()=>(h.sprite.position=et.getTileMap().getWorldPositionOfTileByEntry(),tB.transitionTo(new tM)))}}class tP extends tE{async onEntry(){f.log("Enter AtGameOver"),eM("YOU DIED!",{lifetimeSecs:2,position:h.position,velocity:new P(0,-100,0)}),await new Promise(e=>{setTimeout(()=>e(),2e3)}).then(()=>eG.showOkDialog("Game over. You died.","Try again")).then(()=>tw.unloadCurrentScene()).then(()=>this.transitionTo(new tv))}}class tb extends tE{async onEntry(){f.log("Enter AtGameCompleted"),await eG.showOkDialog("You've done it. Well done.","Try again").then(()=>tw.unloadCurrentScene()).then(()=>this.transitionTo(new tv))}}class tM extends tE{constructor(){super()}async onEntry(){await super.onEntry(),f.log("Enter HeroTurnIdle"),await tO()}async onEvent(e,t,i){switch(e){case tx.CLICKED_FREE_GROUND:i?.filter===tN.COMBAT_TILE?f.error("Unexpected click on combat tile ignored."):await tk(t),this.transitionTo(new tR);break;case tx.CLICKED_ENTRANCE:alert("Wow! Leaving so early. That bit of code is not ready yet.");break;case tx.CLICKED_EXIT:f.log("Escaping"),await tk(t),tw.areThereMoreScenes()?await tL(this):this.transitionTo(new tb)}return Promise.resolve(null)}}class tz extends tE{constructor(){super()}async onEntry(){await super.onEntry(),f.log("Enter HeroTurnFighting"),await tO()}async onEvent(e,t,i){switch(e){case tx.CLICKED_FREE_GROUND:i?.filter===tN.COMBAT_TILE?await this.#eQ(t):await this.#e4(t),0===et.getTileMap().getParticipants(h).length?this.transitionTo(new tR):this.transitionTo(new tI);break;case tx.CLICKED_ENTRANCE:alert("Wow! Leaving so early. That bit of code is not ready yet.");break;case tx.CLICKED_EXIT:f.log("Escaping"),await tk(t),tw.areThereMoreScenes()?await tL(this):this.transitionTo(new tb)}return Promise.resolve(null)}#eQ(e){let t=et.getTileMap().getTileAtWorldPoint(e).getOccupants(),i=[];for(let e of t.values())e.interaction&&i.push(e.interaction.react(h));return Promise.all(i)}#e4(e){for(let e of et.getTileMap().getParticipants(h))if(e.alive&&!e.interaction.allowEscape(h))return Promise.resolve(!1);return tk(e)}}class tR extends tE{constructor(){super()}async onEntry(){await super.onEntry(),f.log("Enter ComputerTurnIdle");let e=et.getTileMap(),t=new td(e),i=new tT(e,t),r=e.worldPointToGrid(h.position);for(let t of et.getActors().values())t!==h&&t.alive&&(t.isWandering()&&e.worldPointToGrid(t.position).isOtherClose(r,1.5)||i.addAndMoveActor(t));return await i.replay(),0===e.getParticipants(h).length?this.transitionTo(new tM):this.transitionTo(new tz),Promise.resolve(null)}}class tI extends tE{constructor(){super()}async onEntry(){await super.onEntry(),f.log("Enter ComputerTurnFighting");let e=et.getTileMap(),t=new td(e),i=new tT(e,t),r=e.getParticipants(h);for(let e of et.getActors().values())e!==h&&e.alive&&(r.includes(e)?await e.interaction.enact(h):i.addAndMoveActor(e));return await i.replay(),0===h.traits.get("HP")?this.transitionTo(new tP):0===r.length?this.transitionTo(new tM):this.transitionTo(new tz),Promise.resolve(null)}}function tO(){let e=et.getTileMap(),t=new td(e,h).getAllRoutesFrom(e.worldPointToGrid(h.sprite.position),h.maxTilesPerMove);return e.setMovementRoutes(t),e.setCombatActors(e.getParticipants(h)),Promise.resolve(null)}function tk(e){let t=et.getTileMap(),i=t.getWaypointsToWorldPoint(e);return(t.setMovementRoutes(null),t.setCombatActors(null),i)?new eP({path:i,speed:100},h.sprite.modifier).applyAsTransientToSprite(h.sprite):Promise.resolve()}function tL(e){return tw.switchToNextScene().then(()=>(h.sprite.position=et.getTileMap().getWorldPositionOfTileByEntry(),e.transitionTo(new tM)))}let tB=new class extends tE{onEntry(){f.log("WaitingToStart state")}async onEvent(e,t,i){e===tx.MAIN_MENU&&this.transitionTo(new tv)}},tA=!1;var t_={EventId:tx,getHeroActor:function(){return h},setHero:function(e){h=e},triggerEvent:function(e,t,i){if(tA){f.debug(`Ignoring event ${e} as still processing earlier event.`);return}tA=!0,tB.onEvent(e,t,i).then(()=>{tA=!1})}};const tN={MOVEMENT_TILE:0,COMBAT_TILE:1},tD={OBSTACLE:-1,GROUND:0,ENTRANCE:1,EXIT:2};class tG extends eV{sprite;obstacle;#e0;#e1;#e8;#e2;constructor(e,t){super(),this.sprite=e,this.#e0=new Map,this.obstacle=t.obstacle,this.#e1=t.gridPoint,this.#e8=t.worldPoint,this.#e2=t.role}get role(){return this.#e2}get gridPoint(){return this.#e1}get worldPoint(){return this.#e8}addOccupant(e){this.#e0.set(e,e)}deleteOccupant(e){this.#e0.delete(e)}getOccupants(){return this.#e0}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionClick(this.sprite.position)}isOccupied(){return this.#e0.size>0}isPassableByActor(e){if(this.obstacle)return!1;for(let t of this.#e0.values())if(t!==e&&!t.isPassableByActor(e))return!1;return!0}canBeOccupiedByActor(e){if(this.obstacle)return!1;for(let t of this.#e0.values())if(t!==e&&!t.canShareLocationWithActor(e))return!1;return!0}isSeeThrough(e){return!this.obstacle&&this.#e2!==tD.ENTRANCE&&this.#e2!==tD.EXIT}}class tW{#e3;#e6;#e7;#e5;#e9;#y;#x;#te;#tt;#ti;#tr;#tn;#ts;#to;#ta;#th;#tl;#tc;constructor(e,t,i){let r=t.matrix;this.#ts=t.entryPointByDoor,this.#to=t.exitPointByDoor,this.#e3=e,this.#ti=new ex({renderer:new ef(e,{width:i,height:i,fillStyle:null,strokeStyle:"white"})}),this.#tc=new ex({renderer:new ef(e,{width:i,height:i,fillStyle:null,strokeStyle:"red"})}),this.#e9=i,this.#e6=[],this.#e5=r.length,this.#e7=r[0].length,this.#y=i*this.tilesX,this.#x=i*this.tilesY,this.#ta=[],r.forEach((t,i)=>{let r=[];this.#e6.push(r),t.forEach((t,n)=>{if(t){let s=new ex({renderer:new ey(e,eo.getSpriteBitmap(0,t.image))}),o=new C(n,i),a=this.gridPointToWorldPoint(o),h=new tG(s,{obstacle:t.role===tD.OBSTACLE,gridPoint:o,worldPoint:a,role:t.role});t.onClick&&(h.setOnClick((e,i)=>this.#tu(e,i,t.onClick)),h.setOnContextClick(t.onContextClick)),this.processTileRole(h),r.push(h),s.position.x=n*this.#e9+this.#e9/2,s.position.y=i*this.#e9+this.#e9/2}else r.push(null)})}),this.#tr||(f.error("No entrance has been set. Setting to the first ground tile"),this.#tr=this.#ta[0])}getDimsInTiles(){return{width:this.#e7,height:this.#e5}}processTileRole(e){switch(e.role){case tD.ENTRANCE:if(this.#tr){let t=e.gridPoint;f.error(`Duplicate entrance found at (${t.x}, ${t.y}). Ignored.`)}else this.#tr=e;break;case tD.EXIT:if(this.#tn){let t=e.gridPoint;f.error(`Duplicate exit found at (${t.x}, ${t.y}). Ignored.`)}else this.#tn=e;break;case tD.GROUND:e.gridPoint.coincident(this.#ts)||this.#ta.push(e)}}update(e){this.#td();let t=this.getVisibleGridPointRect();for(let i=t.y;i<=t.y+t.height;i++)for(let r=t.x;r<=t.x+t.width;r++)if(this.#th?.isGridPointInRays(new C(r,i))){let t=this.#e6[i][r];t?.sprite.update(e)}this.#tm(e)}#td(){let e=t_.getHeroActor();if(e){this.#th||(this.#th=new tm(this,e));let t=this.getTileAtWorldPoint(e.position);if(t){let e=t.role;e!=tD.ENTRANCE&&e!=tD.EXIT&&this.#th.findReachedTiles()}else f.error(`Hero at ${e.position.toString()} but no tile found.`)}}getMapGridPointRect(){return new M(0,0,this.#e7,this.#e5)}getVisibleGridPointRect(){let e=Z.getWorldInCanvasBounds(),t=this.worldPointToGrid(new C(e.x,e.y)),i=this.worldPointToGrid(new C(e.x+e.width,e.y+e.height)),r=Math.max(0,t.x),n=Math.min(this.#e7-1,i.x),s=Math.max(0,t.y);return new M(r,s,n-r,Math.min(this.#e5-1,i.y)-s)}getGridSize(){return this.#e9}getDimensions(){return{width:this.#y,height:this.#x}}getTileAtWorldPoint(e){let t=this.worldPointToGrid(e);return this.getTileAtGridPoint(t)}getTileAtGridPoint(e){if(!e)return null;let t=e.y,i=e.x;return i>=0&&t>=0&&i<this.#e7&&t<this.#e5?this.#e6[t][i]:null}worldPointToGrid(e){return new C(Math.floor(e.x/this.#e9),Math.floor(e.y/this.#e9))}gridAlignedWorldPoint(e){let t=this.worldPointToGrid(e);return this.gridPointToWorldPoint(t)}gridPointToWorldPoint(e){let t=.5*this.#e9;return new C(e.x*this.#e9+t,e.y*this.#e9+t)}getWorldPositionOfTileByEntry(){return this.gridPointToWorldPoint(this.#ts)}getGridPositionOfEntrance(){return this.#tr.gridPoint}setMovementRoutes(e){this.#te=e,e?(this.#tt=new Map,this.#te.forEach(e=>e.forEach(e=>{this.#tt.set(e,e)}))):this.#tt=null}setCombatActors(e){this.#tl=[],e?.forEach(e=>{this.#tl.push(this.worldPointToGrid(e.position))})}#tm(e){this.#tp(e),this.#tf(e)}#tp(e){this.#tt?.forEach(t=>{this.#ti.position=this.gridPointToWorldPoint(t),this.#ti.update(e)})}#tf(e){this.#tl?.forEach(t=>{this.#tc.position=this.gridPointToWorldPoint(t),this.#tc.update(e)})}#tu(e,t,i){if(this.#te?.containsGridPoint(this.worldPointToGrid(t))){i(e,t,{filter:tN.MOVEMENT_TILE});return}let r=this.worldPointToGrid(t);this.#tl?.forEach(n=>{if(n.isCoincident(r)){i(e,t,{filter:tN.COMBAT_TILE});return}}),f.debug("Ignore click outside of highlighted area")}getWaypointsToWorldPoint(e){let t=this.worldPointToGrid(e);return this.#te?.getWaypointsAsWorldPoints(t)}getRandomFreeGroundTile(){for(let e of(ti(this.#ta),this.#ta))if(!e.isOccupied())return e;return null}isGridPointPassableByActor(e,t){let i=this.getTileAtGridPoint(e);return!!i&&i.isPassableByActor(t)}canGridPointBeOccupiedByActor(e,t){let i=this.getTileAtGridPoint(e);return!!i&&i.canBeOccupiedByActor(t)}canHeroSeeGridPoint(e){return this.#th?.isGridPointInRays(e)??!0}isSeeThrough(e,t){let i=this.getTileAtGridPoint(e);return!i||i.isSeeThrough(t)}getSurroundingTiles(e){return tt(this.#e6,e.y,e.x)}deleteOccupancyOfGridPoint(e,t){this.getTileAtGridPoint(t)?.deleteOccupant(e)}moveTileOccupancyGridPoint(e,t,i){i!==t&&(this.getTileAtGridPoint(t)?.deleteOccupant(e),this.getTileAtGridPoint(i)?.addOccupant(e))}getParticipants(e){let t=[],i=this.getSurroundingTiles(this.worldPointToGrid(e.position));return[i.above,i.right,i.below,i.left].forEach(e=>{let i=e?.getOccupants();i?.forEach(e=>{t.push(e)})}),t}}function tF(e){return{role:tD.GROUND,onClick:(e,t,i)=>t_.triggerEvent(t_.EventId.CLICKED_FREE_GROUND,t,i),image:e}}function tH(e){return{role:tD.ENTRANCE,onClick:(e,t,i)=>t_.triggerEvent(t_.EventId.CLICKED_ENTRANCE,t,i),image:e}}function tU(e){return{role:tD.EXIT,onClick:(e,t,i)=>t_.triggerEvent(t_.EventId.CLICKED_EXIT,t,i),image:e}}const t$=new Map([["x",{role:tD.OBSTACLE,image:"block.png"}],["#-TL",{role:tD.OBSTACLE,image:"wall-TL.png"}],["#-TLI",{role:tD.OBSTACLE,image:"wall-TLI.png"}],["#-T",{role:tD.OBSTACLE,image:"wall-T.png"}],["#-TR",{role:tD.OBSTACLE,image:"wall-TR.png"}],["#-TRI",{role:tD.OBSTACLE,image:"wall-TRI.png"}],["#-R",{role:tD.OBSTACLE,image:"wall-R.png"}],["#-BR",{role:tD.OBSTACLE,image:"wall-BR.png"}],["#-BRI",{role:tD.OBSTACLE,image:"wall-BRI.png"}],["#-B",{role:tD.OBSTACLE,image:"wall-B.png"}],["#-BL",{role:tD.OBSTACLE,image:"wall-BL.png"}],["#-BLI",{role:tD.OBSTACLE,image:"wall-BLI.png"}],["#-L",{role:tD.OBSTACLE,image:"wall-L.png"}],["#-XI",{role:tD.OBSTACLE,image:"wall-XI.png"}],["#-VI",{role:tD.OBSTACLE,image:"wall-VI.png"}],["#-HI",{role:tD.OBSTACLE,image:"wall-HI.png"}],["#-TTEE",{role:tD.OBSTACLE,image:"wall-TTEE.png"}],["#-RTEE",{role:tD.OBSTACLE,image:"wall-RTEE.png"}],["#-BTEE",{role:tD.OBSTACLE,image:"wall-BTEE.png"}],["#-LTEE",{role:tD.OBSTACLE,image:"wall-LTEE.png"}],["#",{role:tD.OBSTACLE,image:"block.png"}],["=-T",tU("door-T.png")],["=-R",tU("door-R.png")],["=-B",tU("door-B.png")],["=-L",tU("door-L.png")],["--T",tH("door-T.png")],["--R",tH("door-R.png")],["--B",tH("door-B.png")],["--L",tH("door-L.png")],["=",{role:tD.OBSTACLE,image:"block.png"}],["-",{role:tD.OBSTACLE,image:"block.png"}],[".",tF("floor.png")],[".-SBW",tF("floor-SBW.png")],[".-SBE",tF("floor-SBE.png")],[",-SBE",tF("floor2-SBE.png")],[",-SBW",tF("floor2-SBW.png")],[",",tF("floor2.png")]]);class tV{#tg;#G;#tw;#ty;#tx;heroActor;constructor(e=2,t=2){e>0?(this.#tg=0,this.#G=1/e):this.#G=1,this.#tw=e,this.#ty=t}getOpacity(){return this.#tg}load(){return this.doLoad()}initialise(){return this.doInitialise()}update(e){Z.clearCanvas(),Z.setOpacity(this.#tg),et.update(e),this.doUpdate(e),e0.update(e),Z.setOpacity(1),0!==this.#G&&(this.#tg+=e*this.#G,this.#tg>1?(this.#G=0,this.#tg=1):this.#tg<0&&(this.#G=0,this.#tg=0)),this.#tx&&0===this.#tg&&(this.#tx(),this.#tx=null)}unload(){return this.#tS().then(()=>this.doUnload())}#tS(){return this.#ty>0?(this.#G=-1/this.#ty,new Promise(e=>{this.#tx=e})):Promise.resolve()}doLoad(){return Promise.resolve()}doInitialise(){return Promise.resolve()}doUpdate(e){return Promise.resolve()}doUnload(){return Promise.resolve()}}const tX=eR.TILE_SIZE;class tK{intro;hero;enemies;mapDesign;constructor(){this.enemies=[],this.mapDesign=[]}}class tY extends tV{#tT;constructor(e){super(),this.#tT=e}doLoad(){return Promise.resolve()}doInitialise(){let e=to.generateTileMapPlan(this.#tT.mapDesign,t$),t=new tW(Z.getContext2D(),e,tX);return et.setTileMap(t),this.heroActor=function(e){if(e.hero){let t=te.get(e.hero.id).create();return t.traits=e.hero.traits.clone(),l=t,t}if(!l)throw Error("No hero has been defined.");return l}(this.#tT),(function(e){let t=[];return e.enemies.forEach(e=>{let i=te.get(e.id).create();i.traits=e.traits,t.push(i)}),t})(this.#tT).forEach(e=>{e.position=t.getRandomFreeGroundTile().worldPoint,et.addActor(e)}),tw.setCameraToTrack(this.heroActor.sprite,200,0),et.addActor(this.heroActor),t_.setHero(this.heroActor),Promise.resolve()}doUpdate(e){}doUnload(){return Promise.resolve(null)}}class tZ{#tE;#tv;constructor(e){e?(this.#tE=new Map(e),this.#tv=!1):(this.#tE=new Map,this.#tv=!0)}set(e,t){if(this.#tv||this.#tE.has(e))this.#tE.set(e,t);else throw Error(`Attempt to set invalid key '${e}'`)}get(e){return this.#tE.get(e)}setFromString(e){return e.split(",").forEach(e=>{let t=e.match(/^\s*(\w+)\s*[=: ]\s*(.+?)\s*$/);if(t)this.#tC(t[1],t[2]);else throw Error(`Invalid property definition'${e}'`)}),this}#tC(e,t){let i=t.match(/(\d+) *[/] *(\d+) */);i?(this.#tE.set(e,i[1]),this.#tE.set(`${e}_MAX`,i[2])):this.#tE.set(e,t)}clone(){let e=new tZ(this.#tE);return e.#tv=this.#tv,e}}class tq extends tZ{constructor(e){super(e??new Map([["NAME","mystery"],["MOVEMENT","wander"],["HP",10],["HP_MAX",10],["STR",10],["STR_MAX",10]]))}}class tj{#tP;#tb;#tM;#tz;#tR;#tI;#tO;#tk;#tL;#tB;constructor(e){this.#tP=v(e.minCols,e.maxCols),this.#tb=v(e.minRows,e.maxRows),this.#tM=e.maxRoomCols,this.#tz=e.maxRoomRows,this.#tR=tr.WALL[0],this.#tI=tr.GROUND[0],this.#tL=tr.VOID[0],this.#tO=tr.DOOR_IN[0],this.#tk=tr.DOOR_OUT[0]}generate(){this.#tB=[];let e=0,t=this.#tP;for(;this.#tB.length<this.#tb-4;){let i=e+t-4-2,r=i>0?E(0,i):0,n=Math.max(e-r+4,4),s=Math.min(this.#tM,this.#tP-r),o=s>n?E(n,s):n,a=this.#tP-r-o,h=E(4,Math.min(this.#tz,this.#tb-this.#tB.length));this.#tA(r,o,a,h),e=r,t=o}return this.#t_(),this.#tN(),this.getMatrixAsStrings()}getMatrixAsStrings(){return this.#tB.map(e=>e.join(""))}#tA(e,t,i,r){f.log(`Create room ${e} ${t} ${i} ${r}`);let n="";n+=this.#tL.repeat(e)+this.#tR.repeat(t)+this.#tL.repeat(i),this.#tB.push(n.split(""));for(let s=0;s<r-2;s++)n=""+this.#tL.repeat(e)+this.#tR+this.#tI.repeat(t-2)+this.#tR+this.#tL.repeat(i),this.#tB.push(n.split(""));n=""+this.#tL.repeat(e)+this.#tR.repeat(t)+this.#tL.repeat(i),this.#tB.push(n.split(""))}#t_(){for(let e=1;e<this.#tB.length-1;e++)for(let t=1;t<this.#tB[0].length-2;t++)this.#tB[e][t]===this.#tR&&this.#tB[e+1][t]===this.#tR&&this.#tB[e-1][t]===this.#tI&&this.#tB[e+2][t]===this.#tI&&(this.#tB[e][t]=this.#tI,this.#tB[e+1][t]=this.#tI)}#tD(e){return e.above===this.#tR&&e.centre===this.#tR&&e.below===this.#tR}#tG(e){return e.left===this.#tR&&e.centre===this.#tR&&e.right===this.#tR}#tN(){let e=[];this.#tB.forEach((t,i)=>t.forEach((t,r)=>{let n=tt(this.#tB,i,r);(this.#tG(n)||this.#tD(n))&&e.push({row:i,col:r})}));let t=ti(e),i=t[0];this.#tB[i.row][i.col]=this.#tO,i=t[1],this.#tB[i.row][i.col]=this.#tk}}const tJ={HERO:"HERO",LEVEL:"LEVEL",CAST:"CAST",MAP:"MAP"};class tQ{sceneDefn;lines;lineIndex;constructor(e,t,i){this.lines=e,this.lineIndex=t,this.sceneDefn=i}parse(){for(;this.lineIndex<this.lines.length;){let e=this.lines[this.lineIndex],t=tQ.getSectionIdFromLine(e);if(t)return{nextSectionId:t,nextLineIndex:this.lineIndex};this.parseLine(e),this.lineIndex++}return null}static findFirstSection(e){for(let t=0;t<e.length;t++){let i=tQ.getSectionIdFromLine(e[t].trim());if(i)return{nextSectionId:i,nextLineIndex:t}}return null}parseLine(e){throw"Method parseLine should be overridden."}static getSectionIdFromLine(e){let t=e.match(/^\s*\[ *([\w ]+) *\]/);return t?t[1].toUpperCase():null}fatalError(e){throw Error(`Error parsing script on line ${this.lineIndex+1}: ${e}`)}ignoreError(e){f.debug(`Ignoring error parsing script on line ${this.lineIndex}: ${e}`)}}class t4 extends tQ{constructor(e,t,i){super(e,t,i),this.sceneDefn.intro=""}parseLine(e){this.sceneDefn.intro+=""===e?"\n":e}}class t0 extends tQ{constructor(e,t,i){super(e,t,i)}parseLine(e){let t=e.match(/^\s*(\w+?) *: *([\w,:= /]*)/);t?this.#tW(t):this.#tF(e)}#tW(e){let t=e[1],i=e[2];try{let e=new tq().setFromString(i);this.sceneDefn.hero={id:"HERO",name:t||"mystery",traits:e}}catch(e){this.fatalError(e.message)}}#tF(e){this.fatalError("Long form actors not supported.")}}class t1 extends tQ{constructor(e,t,i){super(e,t,i)}parseLine(e){let t=e.match(/^\s*(\w+?) *x(\d{1,2}) *([^:]*): *([\w,:= /]*)/);t?this.#tH(t):this.#tU(e)}#tH(e){let t=e[1].toUpperCase(),i=parseInt(e[2]),r=e[3],n=e[4];for(let e=0;e<i;e++)if(te.has(t))try{let e=new tq().setFromString(n);this.sceneDefn.enemies.push({id:t,name:r||"mystery",traits:e})}catch(e){this.fatalError(e.message)}else this.fatalError(`Cast member ${t} does not exist.`)}#tU(e){this.fatalError("Long form actors not supported.")}}class t8 extends tQ{#t$;#tV;constructor(e,t,i){super(e,t,i),this.#t$=!1,this.#tV=/^\s*random\s*$/i}parseLine(e){if(!this.#t$&&""!==e){if(this.#tV.test(e)){let e=new tj({minCols:12,maxCols:40,maxRoomCols:10,minRows:12,maxRows:40,maxRoomRows:6});this.sceneDefn.mapDesign=e.generate(),this.#t$=!0,f.debug("Random map"),this.sceneDefn.mapDesign.forEach(e=>f.debug(e))}else this.sceneDefn.mapDesign.push(e)}}}function t2(e,t,i){switch(e){case tJ.HERO:return new t0(c,t+1,i);case tJ.LEVEL:return new t4(c,t+1,i);case tJ.CAST:return new t1(c,t+1,i);case tJ.MAP:return new t8(c,t+1,i)}return null}const t3="custom-pointer-down-event",t6="custom-pointer-up-event",t7="custom-pointer-cancel-event",t5="custom-click-event",t9="custom-pointer-drag-event",ie={MOUSE:0,TOUCH:1};function it(e,t,i){let r=new CustomEvent(t,{detail:i});e.dispatchEvent(r)}function ii(e){let t=e.target.getBoundingClientRect();return{x:e.touches[0].pageX-t.left,y:e.touches[0].pageY-t.top}}function ir(e,t,i,r){r.actionStarted=!0,r.dragging=!1,r.distance=0,r.lastX=t,r.lastY=i,r.startX=t,r.startY=i,it(r.element,t3,{x:t,y:i})}function is(e,t,i,r){let n=r.dragging?"custom-pointer-drag-end-event":t6;r.actionStarted=!1,r.dragging=!1,r.distance=0,r.lastX=t,r.lastY=i,r.startX=t,r.startY=i,it(r.element,n,{x:t,y:i})}function io(e,t,i,r){let n=t-r.lastX,s=i-r.lastY;if(r.lastX=t,r.lastY=i,r.dragging){let e=new CustomEvent(t9,{detail:{x:t,y:i,dx:n,dy:s}});r.element.dispatchEvent(e)}else(Math.abs(t-r.startX)>10||Math.abs(i-r.startY)>10)&&(r.dragging=!0,r.suppressClickEvent=!0)}var ia={};ia=JSON.parse('{"frames":[{"filename":"blank.png","frame":{"x":333,"y":246,"w":3,"h":3},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":3,"h":3},"sourceSize":{"w":48,"h":48}},{"filename":"block.png","frame":{"x":97,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"blood-splat.png","frame":{"x":1,"y":1,"w":94,"h":92},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":4,"w":94,"h":92},"sourceSize":{"w":96,"h":96}},{"filename":"door-B.png","frame":{"x":1,"y":190,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-L.png","frame":{"x":702,"y":197,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-R.png","frame":{"x":721,"y":101,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-T.png","frame":{"x":147,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor-SBE.png","frame":{"x":197,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor-SBW.png","frame":{"x":247,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor.png","frame":{"x":297,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBE.png","frame":{"x":347,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBW.png","frame":{"x":397,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2.png","frame":{"x":447,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-dead00.png","frame":{"x":771,"y":150,"w":48,"h":33},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":7,"w":48,"h":33},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle00.png","frame":{"x":784,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle01.png","frame":{"x":497,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle02.png","frame":{"x":832,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle03.png","frame":{"x":197,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e00.png","frame":{"x":862,"y":150,"w":34,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":1,"w":34,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e01.png","frame":{"x":889,"y":199,"w":35,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":1,"w":35,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e02.png","frame":{"x":1060,"y":101,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e03.png","frame":{"x":1176,"y":151,"w":30,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":30,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n00.png","frame":{"x":880,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n01.png","frame":{"x":246,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n02.png","frame":{"x":880,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n03.png","frame":{"x":1167,"y":51,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s00.png","frame":{"x":928,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s01.png","frame":{"x":547,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s02.png","frame":{"x":928,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s03.png","frame":{"x":1120,"y":51,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w00.png","frame":{"x":1101,"y":101,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w01.png","frame":{"x":51,"y":190,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w02.png","frame":{"x":821,"y":150,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w03.png","frame":{"x":1137,"y":151,"w":37,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":37,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero.png","frame":{"x":976,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down00.png","frame":{"x":145,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down01.png","frame":{"x":193,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left00.png","frame":{"x":241,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left01.png","frame":{"x":289,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right00.png","frame":{"x":337,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right01.png","frame":{"x":385,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up00.png","frame":{"x":433,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up01.png","frame":{"x":481,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre00.png","frame":{"x":529,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre01.png","frame":{"x":577,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen00.png","frame":{"x":625,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen01.png","frame":{"x":673,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"orc-dead00.png","frame":{"x":721,"y":151,"w":48,"h":34},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":11,"w":48,"h":34},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle00.png","frame":{"x":295,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle01.png","frame":{"x":344,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle02.png","frame":{"x":393,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle03.png","frame":{"x":442,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e00.png","frame":{"x":1015,"y":150,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e01.png","frame":{"x":776,"y":201,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":36,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e02.png","frame":{"x":898,"y":149,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e03.png","frame":{"x":1142,"y":101,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n00.png","frame":{"x":96,"y":188,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n01.png","frame":{"x":491,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n02.png","frame":{"x":687,"y":51,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n03.png","frame":{"x":976,"y":100,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s00.png","frame":{"x":735,"y":51,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s01.png","frame":{"x":540,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s02.png","frame":{"x":735,"y":51,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s03.png","frame":{"x":239,"y":197,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w00.png","frame":{"x":933,"y":100,"w":41,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":41,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w01.png","frame":{"x":756,"y":100,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w02.png","frame":{"x":589,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w03.png","frame":{"x":800,"y":100,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc.png","frame":{"x":638,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"pow.png","frame":{"x":1,"y":95,"w":92,"h":93},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":92,"h":93},"sourceSize":{"w":96,"h":96}},{"filename":"RIP.png","frame":{"x":97,"y":51,"w":48,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":48,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"trader-dead00.png","frame":{"x":95,"y":149,"w":48,"h":37},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":37},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle-s03.png","frame":{"x":1024,"y":51,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle00.png","frame":{"x":427,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle01.png","frame":{"x":657,"y":197,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle02.png","frame":{"x":473,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e00.png","frame":{"x":850,"y":199,"w":37,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":37,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e01.png","frame":{"x":1018,"y":101,"w":40,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":40,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e02.png","frame":{"x":814,"y":201,"w":34,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":34,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e03.png","frame":{"x":737,"y":201,"w":37,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":37,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n00.png","frame":{"x":519,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n01.png","frame":{"x":844,"y":100,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n02.png","frame":{"x":565,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n03.png","frame":{"x":933,"y":150,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s00.png","frame":{"x":333,"y":197,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":45,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s01.png","frame":{"x":286,"y":197,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s02.png","frame":{"x":380,"y":197,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":45,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s03.png","frame":{"x":1072,"y":51,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w00.png","frame":{"x":974,"y":150,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w01.png","frame":{"x":888,"y":100,"w":43,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":1,"w":43,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w02.png","frame":{"x":1055,"y":151,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w03.png","frame":{"x":1096,"y":151,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader.png","frame":{"x":611,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox00.png","frame":{"x":145,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox01.png","frame":{"x":193,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play00.png","frame":{"x":241,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play01.png","frame":{"x":289,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings00.png","frame":{"x":337,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings01.png","frame":{"x":385,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down00.png","frame":{"x":433,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down01.png","frame":{"x":481,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left00.png","frame":{"x":529,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left01.png","frame":{"x":577,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right00.png","frame":{"x":625,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right01.png","frame":{"x":673,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up00.png","frame":{"x":143,"y":197,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up01.png","frame":{"x":191,"y":197,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"wall-B.png","frame":{"x":597,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BL.png","frame":{"x":962,"y":201,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BLI.png","frame":{"x":647,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BR.png","frame":{"x":926,"y":201,"w":34,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":34,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BRI.png","frame":{"x":697,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BTEE.png","frame":{"x":747,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-HI.png","frame":{"x":797,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-L.png","frame":{"x":997,"y":201,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-LTEE.png","frame":{"x":1032,"y":201,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-R.png","frame":{"x":1067,"y":201,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-RTEE.png","frame":{"x":1102,"y":201,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-T.png","frame":{"x":847,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TL.png","frame":{"x":1137,"y":201,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TLI.png","frame":{"x":897,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TR.png","frame":{"x":1172,"y":201,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TRI.png","frame":{"x":947,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TTEE.png","frame":{"x":997,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-VI.png","frame":{"x":1047,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-XI.png","frame":{"x":1097,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-B.png","frame":{"x":1147,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-HI.png","frame":{"x":95,"y":99,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-T.png","frame":{"x":147,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}}],"meta":{"app":"https://www.codeandweb.com/texturepacker","version":"1.0","image":"dungeon.png","format":"RGBA8888","size":{"w":1208,"h":250},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:4534e0ee2047f5c5e3b4b1eab74e2e70:5c8c3f7b31e25a52db917ab223c06f93:9c0fba27a8a0c106083a8713f6c67b32$"}}');var ih={};ih=new URL("dungeon.c7fee6f0.png",import.meta.url).toString();var il={};il=new URL("do-alto-do-trono-da-desolacao-trimmed.18cbfbbb.mp3",import.meta.url).toString();var ic={};ic=new URL("punch-trimmed.d5ee82fe.mp3",import.meta.url).toString();var iu={};iu=new URL("long-medium-swish-trimmed.69cad07b.mp3",import.meta.url).toString();var id={};async function im(e){Z.setOptions(e),function(e){let t=0;for(let i in e1){let r=e.measureText(e1[i]),n=r.fontBoundingBoxAscent+r.fontBoundingBoxDescent,s=.5*n-r.fontBoundingBoxDescent;e.fillText(e1[i],-.5*r.width,s),e.getImageData(0,0,1,1).data[3]<=0&&(f.debug(`Emoji ${i} not supported.`),e1[i]=`[${t++}]`),e.clearRect(0,0,r.width,n)}}(Z.getContext2D()),function(){let e;let t=Z.getCanvas();e={element:t,actionStarted:!1,dragging:!1,x:0,y:0,lastTouchStartPoint:null,suppressClickEvent:!1},t.addEventListener("mousedown",t=>(f.debug("mousedown"),ir(ie.MOUSE,t.offsetX,t.offsetY,e)),{passive:!0}),t.addEventListener("mouseup",t=>(f.debug("mouseup"),is(ie.MOUSE,t.offsetX,t.offsetY,e)),{passive:!0}),t.addEventListener("mousemove",t=>{f.debug("mousemove"),1&t.buttons&&io(ie.MOUSE,t.offsetX,t.offsetY,e)},{passive:!0}),t.addEventListener("touchstart",t=>{if(f.debug("touchstart"),1===t.changedTouches.length){let i=ii(t);e.lastTouchStartPoint=new C(i.x,i.y),ir(ie.TOUCH,i.x,i.y,e)}},{passive:!0}),t.addEventListener("touchend",t=>{f.debug("touchend"),1===t.changedTouches.length&&is(ie.TOUCH,e.lastTouchStartPoint?.x,e.lastTouchStartPoint?.y,e),e.lastTouchStartPoint=null,e.suppressClickEvent=!1},{passive:!0}),t.addEventListener("touchmove",t=>{if(f.debug("touchmove"),1===t.changedTouches.length){let i=ii(t);io(ie.TOUCH,i.x,i.y,e),e.suppressClickEvent=!0}},{passive:!0}),t.addEventListener("touchcancel",t=>{var i,r;f.debug("touchcancel"),ie.TOUCH,i=e.lastTouchStartPoint?.x,r=e.lastTouchStartPoint?.y,e.actionStarted=!1,e.dragging=!1,e.distance=0,e.lastX=i,e.lastY=r,e.startX=i,e.startY=r,it(e.element,t7,{x:i,y:r}),e.lastTouchStartPoint=null},{passive:!0}),t.addEventListener("click",i=>{f.debug("click"),e.suppressClickEvent||it(t,t5,{x:i.offsetX,y:i.offsetY}),e.suppressClickEvent=!1}),t.addEventListener(t5,e=>{let t=e.detail.x,i=e.detail.y,r=Z.uiCoordsToMappedPositions(t,i);e0.resolveClick(r)||et.resolveClick(r)}),t.addEventListener(t3,e=>{let t=e.detail.x,i=e.detail.y,r=Z.uiCoordsToMappedPositions(t,i);e0.resolvePointerDown(r)}),t.addEventListener(t6,e=>{let t=e.detail.x,i=e.detail.y,r=Z.uiCoordsToMappedPositions(t,i);e0.resolvePointerUp(r)}),t.addEventListener(t7,e=>{let t=e.detail.x,i=e.detail.y,r=Z.uiCoordsToMappedPositions(t,i);e0.resolvePointerCancel(r)}),t.addEventListener(t9,e=>{tw.panCameraBy(-e.detail.dx,-e.detail.dy)}),t.addEventListener("contextmenu",e=>{f.debug("Context menu");let t=e.detail.x,i=e.detail.y,r=Z.uiCoordsToMappedPositions(t,i);e0.resolveContextMenu(r)||et.resolveContextMenu(r),e.preventDefault()})}();let t=new URL(il),i=new Map([["PUNCH",new URL(ic)],["MISS",new URL(iu)],["DIE",new URL(id)]]);ty.forEach(e=>{if(e.persistent&e.onChange){let t=eI.get(e.id,e.defValue);e.onChange(t)}}),eG.showOkDialog("Welcome to the Scripted Dungeon","Let's start","door").then(()=>eW.loadAndPlayMusic(t)).then(()=>eW.loadEffects(i)).then(()=>eo.loadSpriteMap(m(ia),m(ih))).then(()=>{var e;return e=e2.DUNGEON_SCRIPT,fetch(e).then(e=>e.text()).then(e=>e).catch(t=>(f.error(`Error fetching ${e}: ${t}`),null))}).then(e=>tw.setSceneDefinitions(function(e){c=e.split(/\r?\n/),u=[];let t=new tK,i=tQ.findFirstSection(c);if(!i)throw Error("Invalid script. No section identifiers found.");let r=t2(i.nextSectionId,i.nextLineIndex,t);for(;r;){let e=r.parse();e?.nextSectionId&&e.nextSectionId!==tJ.LEVEL||(u.push(t),t=new tK),r=e?t2(e.nextSectionId,e.nextLineIndex,t):null}return u}(e))).then(()=>{}).then(()=>t_.triggerEvent(t_.EventId.MAIN_MENU)).then(()=>void window.requestAnimationFrame(ip)).catch(e=>{f.error(e),alert(`Fatal error in main game. ${e.message}`)})}function ip(e){if(eh.updateTimeNow(e),d){var t;let i=(e-d)/1e3;tw.update(i),er.showFps&&(t=1/i,ei(Z.getContext2D(),`FPS: ${Math.round(t)}`,{x:0,y:Z.getCanvasDimensions().height},{color:"green"}))}d=e,window.requestAnimationFrame(ip)}id=new URL("male-hurt-sound-trimmed.76fa38ed.mp3",import.meta.url).toString();var ig={TILE_SIZE:48,initialise:im};window.addEventListener("load",()=>{try{ig.initialise({width:800,height:600,maxScale:2.4,minScale:1,sizingMethod:"COVER",alpha:!1})}catch(e){f.fatal(e)}});
//# sourceMappingURL=index.c6bca8ec.js.map
