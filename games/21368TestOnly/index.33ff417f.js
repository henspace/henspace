let e,t,i,r,a,n,s,o,l,h,c;String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){if(!(e instanceof RegExp))return this.replace(RegExp(e,"g"),t);if(0>e.flags.indexOf("g"))throw TypeError("String.prototype.replaceAll called with a non-global RegExp argument");return this.replace(e,t)}),String.prototype.toWellFormed||(String.prototype.toWellFormed=function(){if(!this)return this;let e="";for(let t of this){let i=t.codePointAt(0);i>=55296&&i<=56319||i>=56320&&i<=57343?e+="ï¿½":e+=t}return e});let u=new class{#e;#t;#i;#r;constructor(e){this.#i=e,this.#e=0,this.#t=0,this.#r=[]}clear(){this.#r=[],this.#e=0,this.#t=0}add(e){this.#r[this.#e]=e,this.#e=this.#a(this.#e),this.#e===this.#t&&(this.#t=this.#a(this.#t))}getAll(){let e=[],t=this.#t;for(;t!==this.#e;)e.push(this.#r[t]),t=this.#a(t);return e}#a(e){return++e>this.#i&&(e=0),e}}(50);function d(e){for(let t of e)u.add(t)}window.addEventListener("error",e=>{alert(`ERROR: ${e.filename}; line ${e.lineno}
${e.message}
:Stack:
${e.error.stack}`)});var p,f={log:function(...e){console.log(...e)},info:function(...e){console.info(...e),d(e)},debug:function(...e){console.debug(...e),d(e)},error:function(...e){console.error(...e),d(e)},fatal:function(e){let t;console.error(e),t=e.message?`${e.message}
Stack:
${e.stack}`:e,alert(`Fatal error: ${t}
Previous errors:
${u.join("\n")}`),u.add(t)},getMessages:()=>u.getAll()};const m="'UnifrakturCook', cursive",g={normal:{size:15,fontName:"'UnifrakturCook', cursive"},h1:{size:30,fontName:m},h2:{size:22,fontName:m},h3:{size:18,fontName:m},emojiSprite:{size:18,fontName:"'UnifrakturCook', cursive"}};function S(e){let t=g[e]??g.normal;return`${t.size}px ${t.fontName}`}const w={DEG_22_5:1/8*Math.PI,DEG_45:2/8*Math.PI,DEG_67_5:3/8*Math.PI,DEG_112_5:5/8*Math.PI,DEG_135:6/8*Math.PI,DEG_157_7:7/8*Math.PI};function E(e,t,i){return e<t?t:e>i?i:e}const T={NONE:-1,N:0,NE:1,E:2,SE:3,S:4,SW:5,W:6,NW:7};function y(e,t){let i=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-i)+i)}function A(e){let t=y(0,e.length);return e[t]}function x(e,t){let i=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-i+1)+i)}function R(e,t=0,i){let r=parseInt(e,i);return Number.isNaN(r)?t:r}function O(e,t=0){let i=parseFloat(e);return Number.isNaN(i)?t:i}class C{x;y;constructor(e,t){this.x=e,this.y=t}static copy(e){return new C(e.x,e.y)}coincident(e){return this.x===e.x&&this.y===e.y}getCartesianAngleTo(e){return Math.atan2(e.y-this.y,e.x-this.x)}getScreenAngleTo(e){return Math.atan2(this.y-e.y,e.x-this.x)}toString(){return`(${this.x},${this.y})`}isCoincident(e){return Math.round(this.x)===Math.round(e.x)&&Math.round(this.y)===Math.round(e.y)}isOtherClose(e,t){return Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2)<=Math.pow(t,2)}getOrthoSeparation(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}}class I{x;y;rotation;constructor(e,t,i){this.x=e,this.y=t,this.rotation=i}getCartesianDirection(){return Math.atan2(this.y,this.x)}getScreenDirection(){return Math.atan2(-this.y,this.x)}isZero(e){return Math.abs(this.x)<e&&Math.abs(this.y)<e}}class N{x;y;rotation;constructor(e,t,i){this.x=e,this.y=t,this.rotation=i}}class v extends C{rotation;constructor(e,t,i){super(e,t),this.y=t,this.rotation=i}static fromPoint(e){return new v(e.x,e.y,0)}static copy(e){return new v(e.x,e.y,e.rotation)}getRelativeTo(e){return new v(this.x-e.x,this.y-e.y,this.rotation-e.rotation)}withinSquare(e,t){return Math.abs(e.x-this.x)<t&&Math.abs(e.y-this.y)<t}}class P{x;y;width;height;constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}getBottomRight(){return new C(this.x+this.width,this.y+this.height)}getTopLeft(){return new C(this.x,this.y)}overlaps(e){let t=this.getBottomRight(),i=e.getBottomRight();return!(e.x>t.x||e.y>t.y||i.x<this.x||i.y<this.y)}containsPoint(e){return e.x>=this.x&&e.x<=this.x+this.width&&e.y>=this.y&&e.y<=this.y+this.height}containsCoordinate(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}equals(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}}new C(Number.MIN_VALUE,Number.MIN_VALUE),new C(Number.MAX_VALUE,Number.MAX_VALUE);let L=null,M=null,D=null,b=0,_=0,z=!0,B=null,G=null,k=0,U=0,H=1,F=1,$=.1,W="COVER",V=new v(0,0,0);function K(){let e,t,i,r;let a={width:window.innerWidth,height:window.innerHeight},n=D.width/D.height,s=0,o=0,l=a.width/a.height;("COVER"===W?n>l:n<l)?o=(s=a.height)*n:s=(o=a.width)/n,(H=o/D.width)>F?(o=(H=F)*D.width,s=H*D.height):H<$&&(o=(H=$)*D.width,s=H*D.height),k=(a.width-o)/2,U=(a.height-s)/2,M.style.left=`${k}px`,M.style.top=`${U}px`,M.style.width=`${o}px`,M.style.height=`${s}px`,k<0?(i=-k/H,e=a.width/H):(i=0,e=D.width),U<0?(r=-U/H,t=a.height/H):(r=0,t=D.height),B=new P(i,r,e,t),f.debug(`Scale: ${H}`),f.debug(`Window: width: ${a.width}, height: ${a.height}`),f.debug(`Display: left: ${k}, top: ${U}, width: ${o}, height: ${s}`),f.debug(`Visible canvas: left: ${i}, top: ${r}, width: ${e}, height: ${t}`)}function Y(){let e=g.normal.size*H;document.documentElement.style.fontSize=`${e}px`}function X(){K(),Y()}function q(){return M.getContext("2d",{alpha:z})}function j(e){return e.style.opacity=0,window.setTimeout(()=>{e.remove()},500),Promise.resolve()}function Z(e){return new v(e.x+V.x,e.y+V.y,e.rotation)}window.addEventListener("resize",()=>{null===L&&(L=window.setTimeout(()=>{X(),L=null},200))});var J={canvasPositionToWorld:Z,centreCanvasOn:function(e){V.x=e.x-b,V.y=e.y-_},clearCanvas:function(){q().clearRect(0,0,D.width,D.height)},displayOnGlass:function(e,t){let i,r;t.replace&&(i=document.getElementsByClassName("glass")[0],i?.replaceChildren()),i||(i=document.createElement("div"),document.body.appendChild(i),i.className="glass");let a=document.createElement("div");i.appendChild(a),a.className="glass-content",a.appendChild(e),t.className&&i.classList.add(t.className),i.style.display="block",i.style.opacity=1;let n=a.getBoundingClientRect().height;a.scrollHeight>n&&a.classList.add("overflow");let s=[];if(t.closers&&t.closers.length>0)t.closers.forEach(e=>{let t=new Promise(t=>{e.element.addEventListener("click",async()=>{t(e.closes)})});s.push(t)});else{let e=new Promise(e=>a.addEventListener("click",()=>e()));s.push(e)}return Promise.race(s).then(e=>(r=e,j(i))).then(()=>r)},getCanvas:()=>M,getContext2D:q,getCanvasDimensions:function(){return{width:D.width,height:D.height}},getWorldInCanvasBounds:function(){return new P(V.x,V.y,D.width,D.height)},getVisibleCanvasRect:function(){return B},glassPositionToWorld:function(e){let t=e.x<0?B.x+B.width:B.x,i=e.y<0?B.y+B.height:B.y;return Z(new v(t+e.x,i+e.y,e.rotation))},isOnCanvas:function(e){return e.overlaps(D)},isOnScreen:function(e){return e.overlaps(D)},panCamera:function(e,t){V.x+=e,V.y+=t},resize:X,setOpacity:function(e){q().globalAlpha=e},setOptions:function(e){var t;if(M){f.error("Multiple calls to setScreen ignored.");return}if(!(G=document?.getElementById("game-content"))){f.debug("No game element so assuming running as Jest test. No ui");return}t=e.width,g.normal.size=15+t/100*.390625,g.h1.size=2*g.normal.size,g.h2.size=1.5*g.normal.size,g.h3.size=1.2*g.normal.size,g.emojiSprite.size=t/10,(M=document.createElement("canvas")).id="game-canvas",M.setAttribute("width",e.width),M.setAttribute("height",e.height),M.innerText="Loading the app.",D=new P(0,0,e.width,e.height),b=e.width/2,_=e.height/2,G.appendChild(M),F=e.maxScale,$=e.minScale,W=e.sizingMethod,z=e.alpha,K(),Y()},wipeGlass:j,worldPositionToCanvas:function(e){return new v(e.x-V.x,e.y-V.y,e.rotation)},worldToUi:function(e){return e*H},uiCoordsToMappedPositions:function(e,t){return{canvas:new v(Math.round(e/=H),Math.round(t/=H)),world:new v(Math.round(e+V.x),Math.round(t+V.y),-V.rotation)}},uiToWorld:function(e){return e/H}};const Q=new Map,ee=new Map,et=new Map,ei=new Map;function er(t){let i=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,i),t.isOrganic()?ei.delete(t):Q.delete(t)}function ea(t){let i=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,i),ee.delete(t)}function en(e){et.delete(e)}function es(){e=null}var eo={addActor:function(t){t.isOrganic()?ei.set(t,t):Q.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addArtefact:function(t){ee.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addPassiveSprite:function(e){et.set(e,e)},clearAll:function(){ei.forEach(e=>er(e)),Q.forEach(e=>er(e)),ee.forEach(e=>ea(e)),et.forEach(e=>en(e)),es()},getActors:function(){return Q},getOrganicActors:function(){return ei},getArtefacts:function(){return Q},getTileMap:function(){return e},getWorldDims:function(){return e?e.getDimensions():J.getCanvasDimensions()},removeTileMap:es,resolveCancel:function(e){return!1},resolveClick:function(t){let i=e?.getTileAtWorldPoint(t.world);return!!i&&(i.actionClick(t.world),!0)},resolveContextMenu:function(t){let i=e.getTileAtWorldPoint(t.world);return!!i&&(i.actionContextClick(t.world),!0)},removeActor:er,removeArtefact:ea,removePassiveSprite:en,setTileMap:function(t){e=t},update:function(t){e?.update(t),ei.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let a=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,a)}),ee.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let a=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,a)}),Q.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let a=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,a)}),et.forEach(e=>e.update(t))}};function el(e,t,i,r){if(e.font=S(r?.styleName),e.fillStyle=r?.color??"white",r?.wrapAtX){var a=t.split("\n");for(let t=0;t<a.length;t++)r.y=function(e,t,i,r){let a;let n=t.split(" "),s=i.x??0,o=i.y??0,l=r.xWrapPosition-s,h=r.lineSpacing??1,c="";for(let t=0;t<n.length;t++){let i=c+n[t]+" ",r=function(e,t){let i=e.measureText(void 0);return{width:i.width,height:i.fontBoundingBoxAscent+i.fontBoundingBoxDescent,offsetTop:-i.fontBoundingBoxAscent,offsetCentreY:.5*(i.fontBoundingBoxDescent-i.fontBoundingBoxAscent)}}(e);a||(a=h*r.height),r.width>l&&t>0?(e.fillText(c,s,o),c=n[t]+" ",o+=a):c=i}return e.fillText(c,s,o),o+a}(e,a[t],i,r)}else e.fillText(t,i.x??0,i.y??0)}const eh={spriteBoxes:!1,showFps:!0};let ec=new Map;function eu(e){return new Promise(t=>{let i=new Image;i.addEventListener("load",()=>{f.debug(`Image ${e} loaded.`),t(i)}),i.src=e})}var ed={getSpriteBitmap:function(e,t){let i=ec.get(e);return i||t?.quiet||f.debug(`Failed to find image ${e}.`),!(!i&&t?.fallback)||(i=ec.get(t.fallback))||f.debug(`Failed to find fallback image ${t.fallback}.`),i},getUndefinedBitmap:function(){return ec.get("undefined.png")},loadImage:eu,loadImages:function(e){let t=[];return e.forEach(e=>t.push(eu(e))),Promise.all(t)},loadSpriteMap:function(e,t){return eu(t).then(t=>(function(e,t){let i=[];return e.frames.forEach(e=>{i.push(createImageBitmap(t,e.frame.x,e.frame.y,e.frame.w,e.frame.h).then(t=>{let i={filename:e.filename,image:t,width:e.frame.w,height:e.frame.h,centreX:e.sourceSize.w/2-e.spriteSourceSize.x,centreY:e.sourceSize.h/2-e.spriteSourceSize.y};return ec.set(e.filename,i),e.filename}))}),Promise.all(i)})(e,t))}};let ep=0;var ef={updateTimeNow:function(e){ep=e},getFrameCount:function(e,t=0){return Math.floor((ep+t)/e)}};const em={WRAP:0,REVERSE:1,STOP:2};class eg{#n;#s;#o;#l;#h;constructor(e,t){this.#n=e,this.#s=e-1,this.#o=t,this.#l=1,this.#h=0}get index(){return this.#h}set index(e){this.#h=E(e,0,this.#n-1)}advanceBy(e){if(this.#n<1)return this.#h;switch(this.#o){case em.WRAP:return this.#c(e);case em.REVERSE:return this.#u(e);case em.NONE:default:return this.#d(e)}}#c(e){return e%=this.#n,this.#h+=e%this.#n,this.#h>=this.#n&&(this.#h=this.#h-this.#n),this.#h}#u(e){if(Math.floor(e/this.#n)%2&&(this.#l=-this.#l),e%=this.#n,this.#l>0){this.#h+=e;let t=this.#h-this.#s;t>0&&(this.#h=this.#s-t,this.#l=-1)}else this.#l<0&&(this.#h-=e,this.#h<0&&(this.#h=-this.#h,this.#l=1));return this.#h}#d(e){return this.#l>0?this.#h=Math.min(this.#s,this.#h+e):this.#l<0&&(this.#h=Math.max(0,this.#h-e)),this.#h}}class eS{playing;#p;#f;#m;#g;#S;constructor(e,t){let i;if(this.#p=[],this.#m=0,this.#g=y(0,1e3),"string"==typeof e){this.#p.push(ed.getSpriteBitmap(e));return}this.#S=Math.max(1,t.framePeriodMs);let r=e.startIndex??0,a=e.padding??0,n=!0;do{let t=`${e.prefix}${r.toString().padStart(a,"0")}${e.suffix}`;n?(i=ed.getSpriteBitmap(t),n=!1):i=ed.getSpriteBitmap(t,{quiet:!0}),i&&this.#p.push(i),r++}while(i)this.#f=new eg(this.#p.length,t.loopMethod),this.playing=!0}getCurrentFrame(){if(!(this.#p.length>1))return this.#p[0];if(this.playing){let e=ef.getFrameCount(this.#S,this.#g);e!==this.#m&&(this.#f.advanceBy(e-this.#m),this.#m=e)}return this.#p[this.#f.index]}setCurrentIndex(e){this.#p.length>1&&(this.playing=!1,this.#f.index=e)}getCurrentIndex(){return this.#p.length>1?this.#f.index:0}}class ew{#w;#E;constructor(e,t){this.#w={},this.#w[e]=t,this.#E=t}get image(){return this.#E}addAnimatedImage(e,t){this.#w[e]=t}setCurrentKey(e){this.#w.hasOwnProperty(e)?this.#E=this.#w[e]:f.error(`Attempt to set current key to nonexistent value of ${e}`)}getCurrentFrame(){return this.#E.getCurrentFrame()}}class eE{_context;_boundingBoxCanvas;constructor(e){this._context=e,this._boundingBoxCanvas=new P(0,0,0,0)}getImageFilename(){return null}getContext(){return this._context}getBoundingBoxCanvas(){return this._boundingBoxCanvas}render(e,t){if(e=J.worldPositionToCanvas(e),!this.isOnCanvas(e))return;let i=this._context.globalAlpha;this._context.globalAlpha=i*t;let r=e.rotation;r&&(this._context.save(),this._context.translate(e.x,e.y),this._context.rotate(-e.rotation),this._context.translate(-e.x,-e.y)),this._doRender(e),r&&this._context.restore(),eh.spriteBoxes&&(this._context.strokeStyle="green",this._context.strokeRect(this._boundingBoxCanvas.x,this._boundingBoxCanvas.y,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height)),this._context.globalAlpha=i}_doRender(e){f.error("_doRender method should be overridden.")}isOnScreen(e){let t=new P(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return J.isOnScreen(t)}isOnCanvas(e){let t=new P(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return J.isOnCanvas(t)}}class eT extends eE{#T;#y;#A;text;color;constructor(e,t,i={styleName:"normal",color:"white"}){super(e),this.text=t,this.color=i.color,this.#T=i.styleName}#x(e){this._context.font=S(this.#T);let t=this._context.measureText(e);this.#A={width:t.width,height:t.fontBoundingBoxAscent+t.fontBoundingBoxDescent,origin:{x:-.5*t.width,y:.5*(t.fontBoundingBoxAscent-t.fontBoundingBoxDescent)}},this.#y=e}_doRender(e){var t;this.text!==this.#y&&this.#x(this.text);let i={x:e.x+this.#A.origin.x,y:e.y+this.#A.origin.y,rotation:e.rotation};el(this._context,this.#y,i,{color:this.color,styleName:this.#T}),this._boundingBoxCanvas=(t=this.#A,new P(e.x-t.width/2,e.y-t.height/2,t.width,t.height))}}class ey extends eE{#R;#O;#C;#I;#N;#v;#P;constructor(e,t){super(e),this.#R=t.width??10,this.#O=t.height??10,this.#C=this.#R/2,this.#I=this.#O/2,this.#N=t.fillStyle,this.#v=t.strokeStyle,this.#P=t.lineWidth??2}_doRender(e){this._context.lineWidth=this.#P;let t=e.x-this.#C,i=e.y-this.#I;this.#N&&(this._context.fillStyle=this.#N,this._context.fillRect(t,i,this.#R,this.#O)),this.#v&&(this._context.strokeStyle=this.#v,this._context.strokeRect(t,i,this.#R,this.#O)),this._boundingBoxCanvas=new P(t,i,this.#R,this.#O)}}class eA extends eE{#O;#I;#R;#C;#N;#v;#L;#M;#D;#b;constructor(e,t){super(e),this.#O=t.height,this.#I=this.#O/2,this.#R=t.width,this.#C=this.#R/2,this.#N=t.fillStyle,this.#v=t.strokeStyle,this.#L=t.offsetX??0,this.#M=t.offsetY??0,this.setLevel(0)}setLevel(e){this.#D=Math.min(e,1)*this.#O,this.#b=.5*this.#D}_doRender(e){let t=e.y-this.#I+this.#M,i=e.y+this.#I-this.#D+this.#M,r=e.x-this.#C+this.#L;this.#N&&(this._context.fillStyle=this.#N,this._context.fillRect(r,i,this.#R,this.#D)),this.#v&&(this._context.strokeStyle=this.#v,this._context.strokeRect(r,t,this.#R,this.#O)),this._boundingBoxCanvas=new P(r,t,this.#R,this.#O)}}class ex extends eE{#_;constructor(e,t){super(e);let i=Math.max(t.fillStyles.length??0,t.strokeStyles.length??0);if(0===i){f.error("Attempt to create MultiGaugeTileRenderer with no gauges.");return}this.#_=[];let r=t.tileSize/i,a=-t.tileSize/2+r/2;for(let n=0;n<i;n++)this.#_.push(new eA(e,{width:r,height:t.tileSize,fillStyle:t.fillStyles?.[n],strokeStyle:t.strokeStyles?.[n],offsetX:a+r*n,offsetY:0}))}setLevel(e,t){this.#_[e]?.setLevel(t)}render(e){this.#_?.forEach(t=>t.render(e))}}class eR extends eE{#z;#B;constructor(e,t){super(e),t?.getCurrentFrame?(this.#B=t,this.#z=this.#B.getCurrentFrame()):this.#z=t,this.#z?(this._boundingBoxCanvas.width=this.#z?.width??0,this._boundingBoxCanvas.height=this.#z?.height??0):f.error("No image frame available for sprite.",t)}getImageFilename(){return this.#z.filename}_doRender(e){if(!this.#z)return;let t=this.#B?this.#B.getCurrentFrame():this.#z;this._boundingBoxCanvas.x=e.x-this._boundingBoxCanvas.width/2,this._boundingBoxCanvas.y=e.y-this._boundingBoxCanvas.height/2,this._context.drawImage(t.image,e.x-t.centreX,e.y-t.centreY)}}class eO{#G=new v(0,0,0);#k=new I(0,0,0);#U=new N(0,0,0);#H;#F;visible;opacity;constructor(e){this.#H=e?.renderer,this.visible=!0,this.opacity=1}get position(){return this.#G}set position(e){this.#G.x=this.valueOrZero(e.x),this.#G.y=this.valueOrZero(e.y),this.#G.rotation=this.valueOrZero(e.rotation)}get velocity(){return this.#k}get acceleration(){return this.#U}set acceleration(e){this.#U=e}set velocity(e){this.#k.x=this.valueOrZero(e.x),this.#k.y=this.valueOrZero(e.y),this.#k.rotation=this.valueOrZero(e.rotation)}replaceModifier(e){this.#F&&this.#F.kill(),this.#F=e}valueOrZero(e){return"number"==typeof e?e:0}update(e){this.#F&&(this.#F=this.#F.update(this,e)),this.visible&&this.#$()}#$(){this.#H&&(this.#H.forEach?this.#H.forEach(e=>e.render(this.#G,this.opacity)):this.#H.render(this.#G,this.opacity))}getBoundingBox(){let e=this.#H.getBoundingBoxCanvas();return new P(this.position.x-e.width/2,this.position.y-e.height/2,e.width,e.height)}getImageFilename(){if(!this.#H.forEach)return this.#H.getImageFilename();for(let e of this.#H){let t=e.getImageFilename();if(t)return t}return null}}class eC{decoratedModifier;#W;#V;#K;constructor(e){this.#V=0,this.#K=0,this.decoratedModifier=e}#Y(e){this.#W&&(this.#W(e),this.#W=null)}kill(){this.#Y()}applyAsTransientToSprite(e,t=10){return this.#K=t,new Promise(t=>{this.#W=t,e.replaceModifier(this)})}applyAsContinuousToSprite(e){e.replaceModifier(this)}update(e,t){this.#W&&(this.#V+=t),this.decoratedModifier&&(this.decoratedModifier=this.decoratedModifier?.update(e,t));let i=this.doUpdate(e,t);return!i||this.#V>this.#K?(this.#Y(null),null):i}doUpdate(e,t){return f.error("doUpdate should be overridden."),this}}class eI extends eC{#X;#q;#j;#Z;constructor(e,t,i){super(i),this.#q=e,this.#Z=.3*t;let r=t-this.#Z;this.#X=1/Math.max(r,.5),this.#j=0}doUpdate(e,t){return this.#j+=t,this.#j>this.#q+this.#Z?e.opacity=Math.max(0,1-(this.#j-this.#q-this.#Z)*this.#X):e.opacity=1,e.opacity>0?this:null}}class eN{#J;#Q;constructor(e,t){this.#J=e,this.#Q=t}getSpeedBetweenPoints(e,t){return this.#Q?this.#J:(1+.1*(Math.abs(e.x-t.x)+Math.abs(e.y-t.y)))*this.#J}}class ev extends eC{#ee;#et;constructor(e){super(e)}doUpdate(e,t){return e.position.x+=e.velocity.x*t,e.position.y+=e.velocity.y*t,e.position.rotation+=e.velocity.rotation*t,e.acceleration&&(e.velocity.x+=e.acceleration.x*t,e.velocity.y+=e.acceleration.y*t,e.velocity.rotation+=e.acceleration.rotation*t),this}}class eP extends eC{#ei;#er;#ea;constructor(e,t){super(t),this.#ei=e.prey,this.#er=e.maxSeparation,this.#ea=new eN(e.speed,e.linear)}doUpdate(e,t){let i=this.#ei.position,r=e.position,a=this.#ea.getSpeedBetweenPoints(i,r);if(!r.withinSquare(i,this.#er)){let n=r.getCartesianAngleTo(i);e.velocity.x=a*Math.cos(n),e.velocity.y=a*Math.sin(n);let s=e.velocity.x*t,o=e.velocity.y*t;e.position.x+=this.getMinMove(s,i.x,r.x),e.position.y+=this.getMinMove(o,i.y,r.y)}return this}getMinMove(e,t,i){let r=t-i;return 0>Math.sign(e)?Math.max(e,r):Math.min(e,r)}}class eL extends eC{#en;#h;#es;#ea;constructor(e,t){super(t),this.#en=e.path,this.#h=0,this.#es=e.path[0],this.#ea=new eN(e.speed,e.linear)}doUpdate(e,t){let i=e.position,r=this.#ea.getSpeedBetweenPoints(this.#es,i),a=i.getCartesianAngleTo(this.#es);e.velocity.x=r*Math.cos(a),e.velocity.y=r*Math.sin(a);let n=e.velocity.x*t,s=e.velocity.y*t;if(i.x+=this.getMinMove(n,this.#es.x,i.x),i.y+=this.getMinMove(s,this.#es.y,i.y),i.isCoincident(this.#es)){if(++this.#h>=this.#en.length)return e.velocity.x=0,e.velocity.y=0,this.decoratedModifier;this.#es=this.#en[this.#h]}return this}getMinMove(e,t,i){let r=t-i;return 0>Math.sign(e)?Math.max(e,r):Math.min(e,r)}}function eM(e,t){return new eL({path:[t],speed:100},e.sprite.modifier).applyAsTransientToSprite(e.sprite)}function eD(e,t){let i=new eO({renderer:e});i.position=t.position,i.velocity=t.velocity??new I(0,0,0),i.acceleration=t.acceleration??new N(0,0,0),eo.addPassiveSprite(i),new eI(t.delaySecs,t.lifetimeSecs,new ev).applyAsTransientToSprite(i,20).then(()=>eo.removePassiveSprite(i))}function eb(e,t){eD(new eR(J.getContext2D(),e),t)}function e_(e,t){let i=new eS({prefix:e,suffix:".png",startIndex:0,padding:2},{framePeriodMs:300,loopMethod:em.REVERSE});eD(new eR(J.getContext2D(),i),t)}function ez(e,t){eD(new eT(J.getContext2D(),e,{color:t.color}),t)}function eB(e,t,i="white"){ez(e,{color:i,delaySecs:2,lifetimeSecs:3,position:new C(t.x,t.y),velocity:new I(0,-48,0),acceleration:new N(0,-96,0)})}var eG={TILE_SIZE:48};function ek(e){var t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i)|0;return Math.abs(t).toString(16).toLowerCase().padStart(8,"0")}const eU=new class{#eo;#el;constructor(){this.#eo=localStorage,this.#el=new Map}set(e,t){this.#el.set(e,t);try{this.#eo.setItem(e,this.toChecksummed(JSON.stringify(t)))}catch(e){f.error(`Cannot save setting. ${e.message}`)}}get(e,t,i){if(this.#el.has(e))return this.#el.get(e);let r=t;try{let t=this.#eo.getItem(e);null!==t&&(r=JSON.parse(this.fromChecksummed(t),i))}catch(e){f.error(`Cannot parse value from local storage. ${e.message}`)}return this.#el.set(e,r),r}clearAll(){this.#eo.clear(),this.#el.clear(),f.info("All local storage cleared.")}setStorage(e){this.#eo=e}toChecksummed(e){let t=ek(e);return`${t}*${e}`}fromChecksummed(e){let t=e.match(/^([a-z0-9]{8})\*(.*)$/);if(t){if(t[1]===ek(t[2]))return t[2];throw Error("Invalid checksum")}throw Error("Invalid format")}};class eH{#eh;_element;#ec;#eu;closes;constructor(e){if(e.closes&&e.action)throw Error("Attempt made to create control that is set to close forms and perform and action. These are mutually exclusive.");if(e.persistent&&!e.id)throw Error("Persistent controls must have an ID set in the options.");this.#eh=e.id,this.#eu=e.persistent,e.persistent?this.#ec=eU.get(this.#eh,e.defValue):this.#ec=e.defValue,this.closes=e.closes,this.listeners=0}get element(){return this._element}get value(){return this.#ec}set value(e){e!==this.#ec&&(this.#eu&&eU.set(this.#eh,e),this.#ec=e)}}class eF extends eH{constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return t.appendChild(document.createTextNode(e.label)),t.className="text-button",t}}class e$ extends eH{constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return e.leftLabel&&t.appendChild(document.createTextNode(e.leftLabel)),t.appendChild(eW(e.imageName,"button-icon")),e.rightLabel&&t.appendChild(document.createTextNode(e.rightLabel)),t.className="icon-button",t}}function eW(e,t){let i=ed.getSpriteBitmap(e??"undefined.png",{fallback:"undefined.png"}),r=document.createElement("canvas");r.setAttribute("width",eG.TILE_SIZE),r.setAttribute("height",eG.TILE_SIZE);let a=r.getContext("2d");return a.clearRect(0,0,eG.TILE_SIZE,eG.TILE_SIZE),a.drawImage(i.image,.5*(eG.TILE_SIZE-i.width),.5*(eG.TILE_SIZE-i.height)),r.className=t,r}class eV extends eH{#ed;constructor(e){super(e),this._element=this.buildElement(e.label),this.#ed.checked=this.value,this._element.addEventListener("change",t=>{this.value=this.#ed.checked,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-checkbox",this.#ed=document.createElement("input"),this.#ed.setAttribute("type","checkbox"),t.appendChild(this.#ed),t.appendChild(eW("ui-checkbox00.png","unchecked")),t.appendChild(eW("ui-checkbox01.png","checked"));let i=document.createElement("label");return i.appendChild(document.createTextNode(e)),i.appendChild(t),i}}class eK extends eH{#ep;constructor(e){super(e),this._element=this.buildElement(e.label),this.#ep.value=this.value,this._element.addEventListener("change",t=>{this.value=this.#ep.value,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-range",this.#ep=document.createElement("input"),this.#ep.setAttribute("type","range"),t.appendChild(this.#ep);let i=document.createElement("label");return i.appendChild(document.createTextNode(e)),i.appendChild(t),i}}const eY={TEXT_BUTTON:"text button",CHECKBOX:"checkbox",RANGE:"range"};function eX(e,t={}){let i=document.createElement(e);return t.className&&(i.className=t.className),t.html?i.innerHTML=t.html:t.text&&(i.innerText=t.text),t.child&&i.appendChild(t.child),i}function eq(e){let i=t?.get(e);return null==i?e:Array.isArray(i)?i[y(0,i.length)]:i}function ej(e,...t){let i,r="";for(let t of e){let e=t.trim();if(""!==e){i=e;break}}return i?(r=eq(i),t.forEach((e,t)=>{let i=RegExp(`\\$\\{${t}[a-zA-Z_-]*\\}`);r=r.replace(i,e)}),r):t?t.join(" "):""}const eZ={setMap:function(e){t=e},getText:eq},eJ=new class{onStartAnimation;#ef;#em;constructor(){this.#ef=!1,this.#em=void 0,window.addEventListener("blur",()=>{f.debug(`Blur: current animation state ${this.#ef}`),this.#em=this.#ef,this.setAnimationState(!1)}),window.addEventListener("focus",()=>{f.debug(`Focus: saved animation state ${this.#em}`),this.setAnimationState(this.#em??!0),this.#em=void 0})}setAnimationState(e){e!==this.#ef&&(this.#ef=e,f.debug(`Set animation state to ${this.#ef}`),this.#ef&&this.onStartAnimation&&this.onStartAnimation())}isAnimationOn(){return this.#ef}},eQ={OK:0,CANCEL:1};function e4(){eJ.setAnimationState(!1)}function e0(e,t){return J.displayOnGlass(e,t).then(e=>(eJ.setAnimationState(!0),e))}function e1(e,t){let i=eX("div",{className:"dialog-scroll-content"});if(t&&i.appendChild(eX("p",{className:"dialog-title",text:t})),Array.isArray(e))for(let t of e)i.appendChild(e1(t));else i.appendChild(eX("p",{text:e}));return i.classList.add(["scrollable"]),i}function e8(e,t={}){e4();let i=document.createElement("div"),r=eX("div",{className:"dialog-scroll-content"});i.appendChild(r),t.title&&r.appendChild(eX("p",{className:"dialog-title",text:t.title})),t.preamble&&(t.preamble instanceof Element?r.appendChild(t.preamble):r.appendChild(eX("p",{text:t.preamble}))),e instanceof Element?r.appendChild(e):r.appendChild(e1(e));let a=eX("div",{className:t.row?"action-buttons-row":"action-buttons-col"});i.appendChild(a);let n=[];if(t?.actionButtons?.forEach(e=>{e.element.parentElement||a.appendChild(e.element),null!==e.closes&&void 0!==e.closes&&n.push({element:e.element,closes:e.closes})}),0===n.length){let e=new eF({id:eQ.OK,label:t.okButtonLabel??ej`BUTTON OK`});a.appendChild(e.element),n.push(e)}return e0(i,{closers:n,className:t?.className})}var e3={popupElement:function(e){let t=document.createElement("div");t.className="popup";let i=document.createElement("div");return t.appendChild(i),i.appendChild(e),t.style.opacity=1,document.body.appendChild(t),t},showChoiceDialog:function(e,t,i){document.createElement("div").appendChild(e1(t,e));let r=[];return i?.forEach((e,t)=>{let i=new eF({label:e,closes:t});r.push(i)}),e8(t,{preamble:e,actionButtons:r,row:!0})},showMessage:function(e){let t=document.createElement("div");t.appendChild(document.createTextNode(e)),t.className="popup",t.style.opacity=1,document.body.appendChild(t),t.addEventListener("click",()=>t.remove())},showOkDialog:function(e,t={}){e4();let i=document.createElement("div");i.appendChild(e1(e,t.title));let r=document.createElement("button");return r.appendChild(document.createTextNode(t.okButtonLabel??ej`BUTTON OK`)),i.appendChild(r),e0(i,{className:t?.className,closers:[{element:r,closes:eQ.OK}]})},showElementOkDialog:function(e,t,i=ej`BUTTON OK`,r){e4();let a=document.createElement("div"),n=eX("div",{className:"dialog-scroll-content"});a.appendChild(n),e&&n.appendChild(eX("p",{className:"dialog-title",text:e})),n.appendChild(t);let s=document.createElement("button");return s.appendChild(document.createTextNode(i)),a.appendChild(s),e0(a,{closers:[{element:s,closes:eQ.OK}],className:r})},showControlsDialog:e8};const e2=new class{#eg;#eS;#ew;#eE;constructor(){this.#ew=.5,this.#eE=.5,this.#eg=new Map}loadAndPlayMusic(e){if(this.#eS)throw Error("Only one music track currently supported.");this.#eS=this.#eT(e),this.#eS&&this.#eS.addEventListener("canplay",e=>{this.#eS.volume=this.#ew,this.#eS.loop=!0,this.#eS.play(),window.addEventListener("blur",()=>{this.#eS.pause()}),window.addEventListener("focus",()=>{this.#eS.play()})})}loadEffects(e){let t=[];return e.forEach((e,i)=>{let r=new Promise(t=>{let r=this.#eT(e);r&&r.addEventListener("canplay",e=>{this.#eg.set(i,r),t()})});t.push(r)}),Promise.all(t)}#eT(e){return e?new Audio(e):null}playEffect(e){let t=this.#eg.get(e);t&&(t.volume=this.#eE,t.play())}setMusicVolumePercent(e){this.#ew=e/100,this.#eS&&(this.#eS.volume=this.#ew)}setEffectsVolumePercent(e){this.#eE=e/100}},e9=/^ *(\d+(?:\.\d*)?) *([a-zA-Z]+) *$/,e6=new Map([["PP",10],["GP",1],["SP",.1],["CP",.01]]);function e5(e){let t=0,i=0,r=e.match(e9);if(!r)return f.error(`Unrecognised coin "${e}". Value set to zero.`),{valueFace:0,valueGp:0,type:"GP"};{t=r[1];let e=e6.get(r[2])??0;i=parseFloat(r[1])*e}return{valueFace:t,valueGp:i,type:r[2]}}const e7=/(\d+)[dD](\d+)(?: *\+ *(\d+))?/;function te(e=6){return x(1,e)}function tt(e){return e7.test(e)}function ti(e){if(!e)return 1;if(Number.isInteger(e))return te(e);let t=ta(e);if(!t)return f.error(`String ${e} not recognised as a dice roll. Defaulting to 1D1.`),1;let i=0;for(let e=0;e<t.qty;e++)i+=te(parseInt(t.sides))+t.offset;return i}function tr(e){let t=ta(e);return t?t.qty*(t.sides+t.offset):1}function ta(e){let t=e?.match(e7);return t?{qty:parseInt(t[1]),sides:parseInt(t[2]),offset:t[3]?parseInt(t[3]):0}:(f.error(`Invalid dice format: ${e}`),{qty:0,sides:0,offset:0})}function tn(e){return e?e.offset?`${e.qty}D${e.sides}+${e.offset}`:`${e.qty}D${e.sides}`:""}const ts=[10,200,450,700,1100,1800,2300,2900,3900,5e3,5900,7200,8400,1e4,11500,13e3,15e3,18e3,2e4,22e3,25e3,33e3,41e3,5e4,62e3,75e3,9e4,105e3,12e4,135e3,155e3],to=[{exp:0,profBonus:2},{exp:300,profBonus:2},{exp:900,profBonus:2},{exp:2700,profBonus:2},{exp:6500,profBonus:3},{exp:14e3,profBonus:3},{exp:23e3,profBonus:3},{exp:34e3,profBonus:3},{exp:48e3,profBonus:4},{exp:64e3,profBonus:4},{exp:85e3,profBonus:4},{exp:1e5,profBonus:4},{exp:12e4,profBonus:5},{exp:14e4,profBonus:5},{exp:165e3,profBonus:5},{exp:195e3,profBonus:5},{exp:225e3,profBonus:6},{exp:265e3,profBonus:6},{exp:305e3,profBonus:6},{exp:355e3,profBonus:6}],tl=[[13,15],[12,14],[11,13],[8,13],[8,13],[8,13]],th=[8,15],tc=new Map([["FIGHTER",["STR","DEX","CON","INT","WIS","CHA"]],["CLERIC",["WIS","CON","STR","DEX","INT","CHA"]],["ROGUE",["DEX","STR","INT","CHA","CON","WIS"]],["DEFAULT",["STR","CON","DEX","INT","WIS","CHA"]]]),tu=new Map([["ROGUE",{pbMultiplier:2}],["DEFAULT",{pbMultiplier:1}]]),td=new Map([["ROGUE",[4,8,10,12,16,19]]]);function tp(e){let t=Math.round(4*(2+20*(e.getCharacterLevel()-1)/19));return e.set("CASTING_POWER",t),t}const tf={VERY_EASY:5,EASY:10,MEDIUM:15,HARD:20,VERY_HARD:25,NEARLY_IMPOSSIBLE:30};function tm(e,t){let i=e.rollForAttack();if(1===i.roll)return f.info("Attack dice rolled 0: cursed."),0;if(20===i.roll)return f.info("Attack dice rolled 20: critical hit. Damage will be doubled."),2*e.rollForDamage();let r=t.getEffectiveInt("AC");return(f.info(`Attack: rolled ${i.roll}; value ${i.value} vs target AC ${r}`),i.value>=r)?e.rollForDamage():0}function tg(e,t){let i=ti(e.get("DMG","1D4")),r=t.getNonMeleeSaveAbilityModifier(e),a=e.getInt("DC");return a?te(20)+r>=a?0:i:(f.error(`Poisoner ${e.get("NAME")} has no DC set.`),i)}const tS={NONE:"",NEED_LONG_REST:"need long rest",NEED_MORE_RATIONS:"need more rations"};function tw(e,t){let i=e.traits.getInt("HP",0),r=i;switch(t){case"SHORT":{let t=e.traits.get("HIT_DICE"),a=e.traits.getInt("HP_MAX",i),n=e.traits.getAsModifier("CON"),s=ta(t);s.qty>0&&(s.qty--,r=Math.min(r=i+te(s.sides)+n,a),e.traits.set("HP",r),e.traits.set("HIT_DICE",tn(s)))}break;case"LONG":{let t=e.traits.getCharacterLevel(),a=ta(e.traits.get("HIT_DICE")),n=Math.max(1,Math.ceil(.5*a.qty));a.qty=Math.min(t,a.qty+n),e.traits.set("HIT_DICE",tn(a)),r=e.traits.getInt("HP_MAX",i),e.traits.set("HP",r),e.toxify.cure(),tp(e.traits)}break;default:f.error(`Attempt to rest for unknown length of ${t}`)}return{oldHp:i,newHp:r}}const tE=["STR","DEX","CON","INT","WIS","CHA","AC"];function tT(e){return Math.floor((e-10)/2)}class ty{damageDice;proficiencyBonus;abilityModifier;#ey;unarmed;constructor(e){this.damageDice=e.damageDice??"1D1";let t=e.weaponType??"";"UNARMED"===t?(this.unarmed=!0,this.#ey=!1):t.includes("SIMPLE")&&t.includes("LIGHT")?(this.unarmed=!1,this.#ey=!0):(this.unarmed=!1,this.#ey=!1),this.proficiencyBonus=e?.proficiencyBonus??0,this.abilityModifier=e?.abilityModifier??0}#eA(){return 1+this.abilityModifier}getMaxDamage(){return this.unarmed?this.#eA():tr(this.damageDice)+this.abilityModifier}canUseTwoWeapons(){return this.#ey}rollForAttack(){let e=te(20);return f.info(`Attack roll ${e} + ability(${this.abilityModifier})+ proficiency(${this.proficiencyBonus})`),{roll:e,value:e+this.abilityModifier+this.proficiencyBonus}}rollForDamage(){if(this.unarmed)return this.#eA();let e=ti(this.damageDice)+this.abilityModifier;return f.debug(`Damage: ${this.damageDice} + ability(${this.abilityModifier}) = ${e}`),e}clone(){let e=new ty({});return e.abilityModifier=this.abilityModifier,e.damageDice=this.damageDice,e.proficiencyBonus=this.proficiencyBonus,e.#ey=this.#ey,e.unarmed=this.unarmed,e}}class tA{_traits;constructor(e){"string"==typeof e?(this._traits=new Map,this.#ex(e)):this._traits=new Map(e)}#ex(e){return e.split(",").forEach(e=>{let t=e.match(/^\s*(\w+)\s*[=: ]\s*(.+?)\s*$/);if(!t)return;let[i,r]=this.#eR(t[1],t[2]);if(t)this.#eO(i,r.trim());else throw Error(`Invalid property definition'${e}'`)}),this}has(e){return this._traits.has(e)||this._traits.has("_"+e)}set(e,t){this._traits.set(e,t),this._refreshDerivedValues(e)}get(e,t){return this._traits.get(e)??this._traits.get("_"+e)??t}delete(e){return this._traits.delete(e)}_refreshDerivedValues(e){}getInt(e,t){return R(this.get(e,t),t)}addInt(e,t){let i=this.getInt(e),r=R(t)+i;this._traits.set(e,r)}getValueInFeetInTiles(e,t){let i=this.getInt(e);return null==i?t:tA.feetToTiles(i)}static feetToTiles(e){return Math.round(e/7.5)}getFloat(e,t){return O(this.get(e,t),t)}getAsModifier(e,t){let i=this.getInt(e);return null==i?t:tT(i)}#eR(e,t){return"NAME"!==(e=e.toUpperCase())&&"REWARD"!==e&&(t=t.toUpperCase()),[e,t]}#eO(e,t){switch(e){case"PROF":case"_PROF":return this.#eC(e,t);case"VALUE":case"_VALUE":return this.#eI(e,t);case"DMG":case"_DMG":return this.#eN(e,t);case"HIT_DICE":case"_HIT_DICE":return this.#ev(e,t);case"DC":case"_DC":return this.#eP(e,t);default:return this.#eL(e,t)}}#eI(e,t){let i=t.match(/^(.*)([a-zA-Z]{2})$/);if(i){let e;let r=i[1].trim();e=tt(r)?ti(r):R(i[1],0),t=`${e} ${i[2]}`}else f.error(`Invalid value for VALUE trait: ${t}`),t="0 GP";this.set(e,t)}#eP(e,t){let i;i=isNaN(t)?tf[t]??1:R(t),this.set(e,i)}#ev(e,t){tt(t)||(f.error(`Invalid trait value ${t} for ${e}. Dice definition required.`),t="1D6"),this.set(e,t)}#eN(e,t){let i;tt(t)?i=t:isNaN(i=parseInt(t))&&(f.error(`Invalid trait value ${t} for ${e}. Integer or dice definition required.`),i=0),this.set(e,i)}#eL(e,t){"YES"===t||"TRUE"===t?t=!0:"NO"===t||"FALSE"===t?t=!1:tt(t)&&"DMG"!==e&&(t=ti(t)),this.set(e,t)}#eC(e,t){let i=t.split(/\s*&\s*/),r=[];i.forEach(e=>r.push(e.toUpperCase())),this._traits.set(e,r)}clone(){return new tA(this._traits)}getAllTraits(){return new Map([...this._traits.entries()])}getAllTraitsSorted(){return new Map([...this._traits.entries()].sort())}valuesToString(){let e="";return this._traits.forEach((t,i)=>{""!==e&&(e+=","),e+=`${i}:${t}`}),e}toJSON(){return{reviver:"Traits",data:[...this._traits]}}static revive(e){return new tA(new Map(e))}}class tx extends tA{constructor(e){super(e??new Map)}getDamageDiceWhenCastBy(e){let t=this.get("DMG"),i=this.getFloat("DICE_PER_LEVEL",0),r=function(e,t){let i=ta(e);return i?(i.qty=Math.max(i.qty+t,0),tn(i)):e}(t,Math.floor((e.getCharacterLevel()-1)*i));return f.info(`Spell cast: base damage dice = ${t} raised to ${r} for level.`),r}toJSON(){let e=super.toJSON();return e.reviver="MagicTraits",e}static revive(e){return new tx(new Map(e))}}class tR extends tA{_proficiencyBonus;_level;_attacks;_availableArtefactTraits;_transientFxTraits;_effectiveTraits;_maxTileMovePerTurn;_allowRefreshDerived=!1;constructor(e){super(e??new Map([["NAME","mystery"]])),this._proficiencyBonus=0,this.#eM(),this._transientFxTraits=[],this._allowRefreshDerived=!0,this._refreshDerivedValues()}getMaxTilesPerMove(){return this._maxTileMovePerTurn}clone(){let e=new tR(this._traits);return e._proficiencyBonus=this._proficiencyBonus,e._level=this._level,e._attacks=this._attacks.map(e=>e.clone()),e._availableArtefactTraits=this._availableArtefactTraits,e._effectiveTraits=this._effectiveTraits.clone(),e._transientFxTraits=[],this._transientFxTraits.forEach(t=>e._transientFxTraits.push(t.clone())),e._maxTileMovePerTurn=this._maxTileMovePerTurn,e}exceedAbilitiesAndExp(e,t=0){["STR","DEX","INT","WIS","CON","CHA","EXP"].forEach(i=>{let r=e.getInt(i)+t;r>this.getInt(i)&&this.set(i,r)})}addTransientFxTraits(e){let t=new tA,i=!1;tE.forEach(r=>{let a=tR.toFxKey(r),n=e.getInt(a);n&&(i=!0,t.set(a,n))}),i&&(this._transientFxTraits.push(t),this._refreshDerivedValues())}clearTransientFxTraits(){this._transientFxTraits=[],this._refreshDerivedValues()}#eM(){(function(e){let t=new Map,i=tc.get(e)??tc.get("DEFAULT");for(let e=0;e<i.length;e++){let r=e<tl.length?tl[e]:th,a=x(r[0],r[1]);t.set(i[e],a)}return t})(this.get("CLASS")).forEach((e,t)=>{this.get(t)||this.set(t,e??8)}),this.has("EXP")||this.set("EXP",0)}_updateHitPoints(){let e=this._traits.has("HP"),t=this._traits.has("HP_MAX"),i=this.get("HIT_DICE");if(!e||!t||i){if(i){let t=tT(this.getInt("CON",0)),r=tr(i),a=r+t+(this._level-1)*(Math.ceil((r+1)/2)+t);this.set("HP_MAX",a),e||this.set("HP",tr(i)+t)}else e&&this.set("HP_MAX",this.get("HP"))}}static toFxKey(e){return`FX_${e}`}hasEffective(e){return!!this._effectiveTraits&&this._effectiveTraits.has(e)}getEffective(e,t){return this._effectiveTraits.get(e)??this.get(e,t)}getEffectiveInt(e,t){return R(this.getEffective(e),t)}getCharacterLevel(){return this._level}getNonMeleeSaveAbilityModifier(e){let t=e.get("SAVE_BY");return t?tT(this.getInt(t)??0):(f.error(`Non-melee ${e.get("NAME")} has no SAVE_BY set.`),0)}getCharacterPb(e){return this.isProficient(e)?this._proficiencyBonus:0}getAttacks(){return this._attacks}utiliseAdditionalTraits(e){this._availableArtefactTraits=e,this._refreshDerivedValues()}_refreshDerivedValues(e){this._allowRefreshDerived&&(!e||tE.includes(e))&&(this._adjustForExperience(),this._updateHitPoints(),this._initialiseEffectiveTraits(),"ENEMY"===this._traits.get("TYPE_ID")?this._deriveValuesFromTraits():(this._utiliseTransientTraits(),this._utiliseMagicTraits(),this._utiliseWeaponsTraits(),this._utiliseArmourAndShieldTraits(),this._adjustMovementForArmour()))}_deriveValuesFromTraits(){this._maxTileMovePerTurn=this.getValueInFeetInTiles("SPEED",1),this._attacks=[];let e=tT(this.getInt("STR",1)),t=new ty({damageDice:this._traits.get("DMG"),weaponType:"ALMANAC",proficiencyBonus:this._traits.get("PB",0),abilityModifier:e,secondAttack:!1});this._attacks.push(t)}_initialiseEffectiveTraits(){this._effectiveTraits=new tA,tE.forEach(e=>{this._effectiveTraits.set(e,this.getInt(e,0))})}_utiliseTransientTraits(){this._transientFxTraits?.forEach(e=>{f.debug(`Transient traits: ${e.valuesToString()}`),this._addFxTraitsToEffectiveTraits(e)})}_addFxTraitsToEffectiveTraits(e){tE.forEach(t=>{let i=e.getInt(tR.toFxKey(t));i&&this._effectiveTraits.addInt(t,i)})}_utiliseMagicTraits(){if(this?._availableArtefactTraits?.magic)for(let e of this._availableArtefactTraits.magic)f.debug(`Magic traits: ${e.valuesToString()}`),this._addFxTraitsToEffectiveTraits(e)}_utiliseArmourAndShieldTraits(){let e=this.getEffectiveInt("AC",0),t=this?._availableArtefactTraits?.armour,i=this?._availableArtefactTraits?.shields,r=0,a=0;t?.forEach(t=>{let i=this._getAcFromTraits(t);i.additional?r+=i.value:i.value>e&&(e=i.value)}),i?.forEach(e=>{a=Math.max(a,e.getInt("AC",0))});let n=e+r+a;this._effectiveTraits.set("AC",n)}_adjustMovementForArmour(){let e=this.getFloat("SPEED",1);if(this._maxTileMovePerTurn=Math.max(1,tA.feetToTiles(e)),this._availableArtefactTraits?.armour){for(let t of this._availableArtefactTraits.armour)if(t.get("TYPE","").toUpperCase().includes("HEAVY")&&t.getInt("STR",0)>this.getEffectiveInt("STR")){this._maxTileMovePerTurn=Math.max(1,tA.feetToTiles(e-10));return}}}_utiliseWeaponsTraits(){var e;let t,i,r,a,n;this._attacks=[];let s=this?._availableArtefactTraits?.weapons??[],o=tT(this.getEffectiveInt("STR",1)),l=(e=this.get("CLASS"),tu.get(e)??tu.get("DEFAULT")),h=this._proficiencyBonus*l.pbMultiplier;s.length>2&&f.error(`Unexpected number of equipped weapons. Expected 2; received ${s.length}`),0===s.length?(r="",i="UNARMED",a=!0):(r=s[0].get("DMG","1D1")??"1D1",i=s[0].get("TYPE")??"",a=this.isProficient(s[0])),t=new ty({damageDice:r,weaponType:i,proficiencyBonus:a?h:0,abilityModifier:o}),s.length>1&&(n=new ty({damageDice:s[1].get("DMG","1D1")??"1D1",weaponType:s[1].get("TYPE")??"",proficiencyBonus:this.isProficient(s[1])?h:0,abilityModifier:o})),n?.canUseTwoWeapons()&&t.canUseTwoWeapons()?(this._attacks.push(t),n.abilityModifier>0&&(n.abilityModifier=0),this._attacks.push(n)):n&&n.getMaxDamage()>t.getMaxDamage()?this._attacks.push(n):this._attacks.push(t)}_getAcFromTraits(e){let t=tT(this.getEffectiveInt("DEX",1)),i=e.get("TYPE","").toUpperCase(),r=e.get("AC",1),a=R(r);return i.includes("MEDIUM")?a+=Math.min(2,t):i.includes("HEAVY")||(a+=t),{additional:/^[+-]/.test(r),value:a}}_adjustForExperience(){let e=this._level??1,t=function(e){let t=R(e,0),i=0,r=0;do if(t>=to[r++].exp)i=r;else break;while(r<to.length)return{level:i,profBonus:to[i-1].profBonus}}(this._traits.get("EXP"));this._level=t.level,this._proficiencyBonus=t.profBonus,this._adjustTraitsForLevelChange(e,this._level)}_adjustTraitsForLevelChange(e,t){var i;let r=(i=this.get("CLASS"),{levels:td.get(i)??[],traits:tc.get(i)??tc.get("DEFAULT"),gainPerAdjustment:2,maxAbility:20});if(0===r.levels.length)return;let a=0;for(let i of r.levels){if(i>t)break;i>e&&(a+=r.gainPerAdjustment)}let n=0;for(;a>0&&n<r.traits.length;){let e=r.traits[n],t=this.get(e);t<r.maxAbility?(this.set(e,t+1),a--):n++}}adjustForDefeatOfActor(e){let t;let i=(t=O(e.get("CR")))<.124?10:t<.249?25:t<.499?50:t<.999?100:(t=Math.min(ts.length-1,parseInt(t)),ts[t]),r=this.getInt("EXP",0),a=r+i;f.info(`Experience increased from ${r} to ${a}.`),this.set("EXP",a);let n=this._level;return this._adjustForExperience(),{exp:{was:r,now:a},level:{was:n,now:this._level}}}isProficient(e){let t=this.get("PROF"),i=e.get("TYPE");if(!t||!i)return!1;for(let e of t){let t=e.split(" "),r=!0;for(let e of t)if(!i.includes(e)){r=!1;break}if(r)return!0}return!1}toJSON(){let e=super.toJSON();return e.reviver="CharacterTraits",e}static revive(e){return new tR(new Map(e))}}function tO(e="?"){if(e.len<2)return e;let t=e.replace(/_/g," "),i=t.charAt(0).toUpperCase()+t.substring(1);return eZ.getText(i)}function tC(e){let t=`DESCRIPTION ${e.toUpperCase()}`,i=eZ.getText(t);return t===i?(f.error(`No description set for ${t}.`),""):i}function tI(e){return fetch(e).then(e=>e.text()).then(e=>e).catch(t=>(f.error(`Error fetching ${e}: ${t}`),null))}const tN={COMMON:"COMMON",UNCOMMON:"UNCOMMON",RARE:"RARE",VERY_RARE:"VERY RARE"};class tv{static COMMON_CUTOFF=.7207207207207207;static UNCOMMON_CUTOFF=.9459459459459459;static RARE_CUTOFF=.990990990990991;static VERY_RARE_CUTOFF=1;common;uncommon;rare;veryRare;constructor(){this.common=[],this.uncommon=[],this.rare=[],this.veryRare=[]}mergeAlmanac(e){this.common.push(...e.common),this.uncommon.push(...e.uncommon),this.rare.push(...e.rare),this.veryRare.push(...e.veryRare)}find(e){let t=this.common.find(e);return t||(t=this.uncommon.find(e))||(t=this.rare.find(e))?t:this.veryRare.find(e)}filter(e){let t=new tv;return t.common=e?this.common.filter(e):[...this.common],t.uncommon=e?this.uncommon.filter(e):[...this.uncommon],t.rare=e?this.rare.filter(e):[...this.rare],t.veryRare=e?this.veryRare.filter(e):[...this.veryRare],t}getRandomEntry(){let e=Math.random();return e<tv.COMMON_CUTOFF?this.getRandomCommonEntry():e<tv.UNCOMMON_CUTOFF?this.getRandomUncommonEntry():e<tv.RARE_CUTOFF?this.getRandomRareEntry():this.getRandomVeryRareEntry()}getRandomCommonEntry(){return A(this.common)}getRandomUncommonEntry(){return 0===this.uncommon.length?this.getRandomCommonEntry():A(this.uncommon)}getRandomRareEntry(){return 0===this.rare.length?this.getRandomUncommonEntry():A(this.rare)}getRandomVeryRareEntry(){return 0===this.veryRare.length?this.getRandomRareEntry():A(this.veryRare)}}function tP(e,t){var i;let r=e.match(/^ *(\d+) *, *(\w+ ?\w+) *, *(\w*) *, *([\w+]*) *(?:\[ *([\w, ]*?)])? *\*(.*)$/);if(!r)return f.error(`Invalid almanac entry ${e}`),null;let a={};a.minLevel=parseInt(r[1]),a.rarity=r[2].toUpperCase(),a.typeId=r[3],a.type=tL.getItemType(t,a.typeId),a.id=r[4];let n=function(e="?"){let t=e.split("+");return e.len<2?e:{name:tO(t[0]),imageName:t[0].toLowerCase(),description:tC(t[0])}}(a.id);return a.name=n.name,a.imageName=n.imageName,a.description=n.description,a.equipmentIds=(i=r[5])?i.trim().split(/\s*,\s*/):i,a.traitsString=`_TYPE_ID:${a.typeId},${r[6]}`,a.challengeRating=function(e){let t=e?.match(/CR *[:=] *([\d.]+)/);return t?O(t[1],0):0}(a.traitsString),a}const tL=new class{#eD;constructor(){this.#eD=new Map}addAlmanac(e,t){this.#eD.set(e,t)}getAlmanac(e){let t=this.#eD.get(e);return t||f`Attempt to get non-existent almanac ${e}`,t}getRandomEntry(e,t){let i;i=Array.isArray(e)?A(e):e;let r=this.getAlmanac(i).filter(t);if(r)return r.getRandomEntry();f.error(`Failed to find almanac with key ${i}`)}findById(e,t){for(let i of(t||(t=this.#eD.keys()),t)){let t=this.#eD.get(i)?.find(t=>t.id===e);if(t)return t}f.error(`Failed to find almanac entry for '${e}' in ${t.join(", ")}`)}getPooledAlmanac(e,t){let i=new tv;return e.forEach(e=>{let r=this.getAlmanac(e).filter(t);i.mergeAlmanac(r)}),i}getItemType(e,t){switch(e){case"HEROES":case"ENEMIES":case"OBJECTIVES":case"TRADERS":return function(e){let t=ap[e];return null==t&&f.error(`Unrecognised actor type: ${e}`),t}(t);default:return function(e){let t=tb[e];return null==t&&f.error(`Unrecognised artefact type: ${e}`),t}(t)}}};function tM(e,t){let i,r;e.type===tb.SPELL?(i=t??new tx(e.traitsString),r="spell"):e.type===tb.CANTRIP?(i=t??new tx(e.traitsString),r="cantrip"):(i=t??new tA(e.traitsString),r=e.imageName),i.set("NAME",e.name);let a=function(e,t,i){let r=new tB(e,"",`${t}.png`);return r.traits=i,r}(e,r,i);return a.description=e.description,a.isTrap()?a.interaction=new au(a):a.isMagic()?a.interaction=new al(a):a.isConsumable()&&(a.interaction=new ah(a)),a}const tD={HEAD:{id:"HEAD",space:1,money:!1,spacesExpand:!1},BODY:{id:"BODY",space:1,money:!1,spacesExpand:!1},HANDS:{id:"HANDS",space:2,money:!1,spacesExpand:!1},FEET:{id:"FEET",space:2,money:!1,spacesExpand:!1},BACKPACK:{id:"BACKPACK",space:8,money:!1,spacesExpand:!0},WAGON:{id:"WAGON",space:8,money:!1,spacesExpand:!0},CANTRIPS:{id:"CANTRIPS",space:999,money:!1,spacesExpand:!0},SPELLS:{id:"SPELLS",space:9,money:!1,spacesExpand:!0},PREPARED_SPELLS:{id:"PREPARED SPELLS",space:9,money:!1,spacesExpand:!0},PURSE:{id:"PURSE",space:Number.MAX_SAFE_INTEGER,money:!0,spacesExpand:!1}},tb={ARMOUR:{storageSpace:1,storeType:{stash:tD.WAGON,equip:tD.BODY}},CANTRIP:{storageSpace:1,storeType:{stash:null,equip:tD.CANTRIPS}},COINS:{storageSpace:0,storeType:{stash:tD.PURSE}},CONSUMABLE:{storageSpace:1,storeType:{stash:tD.BACKPACK}},GENERIC:{storageSpace:1,storeType:{stash:tD.BACKPACK}},HEAD_GEAR:{storageSpace:1,storeType:{stash:tD.BACKPACK,equip:tD.HEAD}},KEY:{storageSpace:1,storeType:{stash:tD.BACKPACK}},SHIELD:{storageSpace:1,storeType:{stash:tD.BACKPACK,equip:tD.HANDS}},SPELL:{storageSpace:1,storeType:{stash:tD.SPELLS,equip:tD.PREPARED_SPELLS}},TRAP:{storageSpace:1,storeType:{stash:tD.BACKPACK}},TWO_HANDED_WEAPON:{storageSpace:2,storeType:{stash:tD.BACKPACK,equip:tD.HANDS}},WEAPON:{storageSpace:1,storeType:{stash:tD.BACKPACK,equip:tD.HANDS}}};class t_{#eb;#e_;#ez;#eB;#eG;constructor(e,t,i){this.#eb=e,this.#ez=0,this.#e_=new Map,this.#eB=t,this.#eG=i}get storeTypeId(){return this.#eG.id}get storeType(){return this.#eG}get freeSpace(){return this.#eb-this.#ez}get maxSpace(){return this.#eb}adjustCapacity(e){return this.#eb=Math.max(e,this.#ez),this.#eb}isEmpty(){return 0===this.#ez}getRequiredSpace(e){return this.#eB?1:e.storageSpace}has(e){return this.#e_.has(e)}add(e){let t=this.#eb-this.#ez,i=this.getRequiredSpace(e);return t>=i&&(this.#e_.set(e,e),this.#ez+=i,!0)}take(e){let t=this.#e_.get(e),i=this.getRequiredSpace(e);return t&&(this.#ez-=i,this.#e_.delete(t)),t}getFirst(){return this.isEmpty()?null:this.#e_.values().next().value}takeFirst(){if(this.isEmpty())return null;let e=this.#e_.values().next().value;return this.take(e)}values(){return this.#e_.values()}canAdd(e){let t=this.getRequiredSpace(e);return this.#eb-this.#ez>=t}}class tz{#ek;#eU;constructor(){this.#eU=!1}get storeType(){return tD.PURSE}get storeTypeId(){return tD.PURSE.id}isEmpty(){return!this.#ek||0===this.#ek.costInGp}has(e){return this.#ek.costInGp>0}add(e){let t=e.costDetails;if(!this.#ek)return this.#ek=e.clone(),!0;let i=this.#ek.costDetails;return this.#eU||(this.#ek=tz.createGoldCoinArtefact(i.valueGp),this.#eU=!0),this.#ek.costInGp=i.valueGp+t.valueGp,!0}take(e){let t=Math.min(this.#ek.costInGp,e.costInGp);return this.#ek.costInGp=this.#ek.costInGp-t,e.costInGp=t,e}canAdd(e){return!0}values(){return this.#ek&&0!==this.#ek.costInGp?[this.#ek.clone()].values():[].values()}static createGoldCoinArtefact(e){let t=tM(tP(`0,COMMON,COINS,gold_coins * VALUE:${e}GP`));return t.costInGp=e,t}}class tB{id;iconImageName;description;artefactType;traits;interaction;almanacEntry;constructor(e,t,i){this.id=e.id,this.description=t,this.iconImageName=i,this.artefactType=e.type,this.almanacEntry=e}get costDetails(){return e5(this.traits?.get("VALUE"))}get costInGp(){return e5(this.traits?.get("VALUE")).valueGp}get sellBackPriceInGp(){return this.artefactType===tb.COINS?this.costInGp:Math.round(75*this.costInGp)/100}set costInGp(e){if(!this.traits)throw Error("Artefact has no traits so cannot set cost.");this.traits.set("VALUE",`${e.toFixed(2)} GP`)}get storageSpace(){return this.artefactType.storageSpace}get stashStoreType(){return this.artefactType.storeType.stash}get equipStoreType(){return this.artefactType.storeType.equip}get stashInWagon(){return this.stashStoreType===tD.WAGON}getDefaultStoreType(){return this.artefactType.storeType.stash??this.artefactType.storeType.equip}getStoreTypes(){let e=[];return this.artefactType.storeType.stash&&e.push(this.artefactType.storeType.stash),this.artefactType.storeType.equip&&e.push(this.artefactType.storeType.equip),e}clone(){let e=new tB(this.almanacEntry,this.description,this.iconImageName);return e.traits=this.traits.clone(),e.value=this.value,e}isMagic(){return this.artefactType===tb.SPELL||this.artefactType===tb.CANTRIP}isTrap(){return this.artefactType===tb.TRAP}isUsable(){return!!this.interaction?.canReact()}isConsumable(){return this.artefactType===tb.CONSUMABLE}toJSON(){return{reviver:"Artefact",data:{almanacEntry:this.almanacEntry,traits:this.traits}}}static revive(e,t){return t(e.almanacEntry,e.traits)}}class tG{#eH;#eF;#e$;constructor(e,t){for(let t in this.#eH=new Map,this.#eF=e,tD){let e=tD[t];this.#eW(e)}this.#e$=t}get hasWagon(){return this.#eF}#eV(){this.#e$&&this.#e$()}#eW(e){if(e.money)return this.#eH.set(e,new tz(e.space,e.spacesExpand));let t=!0;this.#eF&&e===tD.BACKPACK?t=!1:this.#eF||e!==tD.WAGON||(t=!1),t&&this.#eH.set(e,new t_(e.space,e.spacesExpand,e))}getStore(e){return this.#eF&&e===tD.BACKPACK&&(e=tD.WAGON),this.#eH.get(e)}getStoreByTypeId(e){for(let t of this.#eH.values())if(t.storeTypeId===e)return t;return null}findSuitableStore(e){let t=e.stashStoreType,i=this.getStore(t);return(i||(t=e.equipStoreType,i=this.getStore(t)),i?.canAdd(e))?i:null}addArtefact(e){let t=this.getStore(e.getDefaultStoreType()),i=t?.add(e);return this.#eV(),i}getFirstStorageDetails(){for(let e of this.#eH.values()){let t=e.values(),i=t.next()?.value;if(i)return{store:e,artefact:i}}return null}hasArtefactWithSameId(e){for(let t of this.getAllStorageDetails())if(t.artefact.id===e.id)return!0;return!1}getAllEquippedArtefacts(){let e=[];for(let t of[this.#eH.get(tD.HEAD),this.#eH.get(tD.BODY),this.#eH.get(tD.HANDS),this.#eH.get(tD.FEET),this.#eH.get(tD.CANTRIPS),this.#eH.get(tD.PREPARED_SPELLS)])for(let i of t.values())e.push(i);return e}getAllStorageDetails(){let e=[];return this.#eH.forEach(t=>{for(let i of t.values())e.push({store:t,artefact:i})}),e}getPurseValue(){let e=this.getStore(tD.PURSE).values(),t=e.next()?.value;return t?t.costInGp:0}addToPurse(e){let t=tz.createGoldCoinArtefact(e);this.#eH.get(tD.PURSE).add(t),this.#eV()}takeFromPurse(e){let t=tz.createGoldCoinArtefact(e),i=this.#eH.get(tD.PURSE).take(t);return this.#eV(),i.costInGp}getStoreContents(e){let t=this.getStore(e);return!t||t.isEmpty()?null:t.values()}discard(e){return!!this.discardStashed(e,!0)||this.discardEquipped(e)}discardEquipped(e,t){let i=this.getStore(e.equipStoreType);return i?i.take(e)?(this.#eV(),!0):(t||f.error("Artefact could not be found so not discarded."),!1):(t||f.error("Cannot discard artefact as there isn't an equip store."),!1)}discardStashed(e,t){let i=this.getStore(e.stashStoreType);return i?i.take(e)?(this.#eV(),!0):(t||f.error("Artefact could not be found so not discarded."),!1):(t||f.error("Cannot discard artefact as there isn't a stash store."),!1)}equip(e,t={}){let i=this.getStore(e.stashStoreType),r=this.getStore(e.equipStoreType);if(!i&&!t.direct)return f.error("Cannot equip artefact as there isn`t a stash store to take it from."),!1;if(!r)return f.error("Cannot equip artefact as there isn't an equip store."),!1;let a=e.storageSpace;if(a>r.maxSpace)return f.error("The equip store cannot hold this item."),!1;if(!i?.take(e)&&!t.direct)return f.error("Could not find artefact in the stash."),!1;for(;r.freeSpace<a;){let e=r.takeFirst();i?.add(e)}let n=r.add(e);return this.#eV(),n}stash(e,t={}){let i=this.getStore(e.stashStoreType),r=this.getStore(e.equipStoreType);if(!i)return f.debug("Cannot stash artefact as there isn`t a suitable stash store to put it in."),!1;if(!r&&!t.direct)return f.error("No suitable equip store found. If stashing a new artefact, the direct option should be set."),!1;if(e.storageSpace>i.freeSpace)return f.error("The stash store cannot hold this item."),!1;if(!r?.take(e)&&!t.direct)return f.error("The artefact hasn't been equipped so can't unequip it."),!1;let a=i.add(e);return this.#eV(),a}}function tk(e,t,i){return{centre:e[t]?.[i],tl:e[t-1]?.[i-1],above:e[t-1]?.[i],tr:e[t-1]?.[i+1],right:e[t]?.[i+1],br:e[t+1]?.[i+1],below:e[t+1]?.[i],bl:e[t+1]?.[i-1],left:e[t]?.[i-1]}}function tU(e){let t,i=e.length;for(;i>0;)t=Math.floor(Math.random()*i),i--,[e[i],e[t]]=[e[t],e[i]];return e}const tH={WALL:["#","*","|"],DOOR_IN:["-","~"],DOOR_OUT:["=",">"],GROUND:[".",":",",",";"],VOID:[" "]},tF={TOP_LEFT:"-TL",TOP_LEFT_INTERNAL:"-TLI",TOP:"-T",TOP_RIGHT:"-TR",TOP_RIGHT_INTERNAL:"-TRI",RIGHT:"-R",BOTTOM_RIGHT:"-BR",BOTTOM_RIGHT_INTERNAL:"-BRI",BOTTOM:"-B",BOTTOM_LEFT:"-BL",BOTTOM_LEFT_INTERNAL:"-BLI",LEFT:"-L",TOP_TEE:"-TTEE",RIGHT_TEE:"-RTEE",BOTTOM_TEE:"-BTEE",LEFT_TEE:"-LTEE",INTERNAL_CROSS:"-XI",INTERNAL_VERTICAL:"-VI",INTERNAL_HORIZONTAL:"-HI"},t$={BELOW_WALL:"-SBW",BELOW_END_WALL:"-SBE"};class tW{matrix;entryPointByDoor;exitPointByDoor;constructor(){this.entryPointByDoor=new C(0,0),this.exitPointByDoor=new C(0,0)}static generateTileMapPlan(e,t){let i=new tW,r=i.convertToMatrix(e);return r=i.clarifyMatrix(r),i.createPlan(r,t),i}convertToMatrix(e){let t=[],i=0;return e.forEach(e=>{i=Math.max(i,e.length)}),e.forEach(e=>{e.length<i&&(e+=" ".repeat(i-length)),t.push(e.split(""))}),t}clarifyMatrix(e){let t=[];return e.forEach((i,r)=>{let a=[];t.push(a),i.forEach((t,i)=>{var n,s,o,l;let h;let c=tk(e,r,i);(n=t,tH.VOID.includes(n))?t=" ":tY(t)?(s=t,tX(c.above)&&(tX(c.tl)?s+=t$.BELOW_WALL:s+=t$.BELOW_END_WALL),o=t=s,tV(c.left)||tV(c.above)||tV(c.right)||tV(c.below))?this.entryPointByDoor=new C(i,r):(tK(c.right)||tK(c.below)||tK(c.left)||tK(c.above))&&(this.exitPointByDoor=new C(i,r)):tX(t)&&(h=l=t,tX(c.above)&&tX(c.right)&&tX(c.below)&&tX(c.left)?h+=tF.INTERNAL_CROSS:tY(c.left)&&tY(c.right)?h+=tF.INTERNAL_VERTICAL:tY(c.above)&&tY(c.below)?h+=tF.INTERNAL_HORIZONTAL:tX(c.left)&&tX(c.right)&&tX(c.below)?h+=tF.TOP_TEE:tX(c.above)&&tX(c.below)&&tX(c.left)?h+=tF.RIGHT_TEE:tX(c.left)&&tX(c.right)&&tX(c.above)?h+=tF.BOTTOM_TEE:tX(c.above)&&tX(c.below)&&tX(c.right)?h+=tF.LEFT_TEE:tX(c.right)&&tX(c.below)?h+=tY(c.br)?tF.TOP_LEFT:tF.TOP_LEFT_INTERNAL:tX(c.left)&&tX(c.below)?h+=tY(c.bl)?tF.TOP_RIGHT:tF.TOP_RIGHT_INTERNAL:tX(c.left)&&tX(c.above)?h+=tY(c.tl)?tF.BOTTOM_RIGHT:tF.BOTTOM_RIGHT_INTERNAL:tX(c.right)&&tX(c.above)?h+=tY(c.tr)?tF.BOTTOM_LEFT:tF.BOTTOM_LEFT_INTERNAL:tX(c.above)&&tX(c.below)?h+=tY(c.right)?tF.LEFT:tF.RIGHT:tX(c.right)&&tX(c.left)&&(h+=tY(c.below)?tF.TOP:tF.BOTTOM),t=tX(c.above)?h+t$.BELOW_WALL:h),a.push(t)})}),t}createPlan(e,t){let i=[];e.forEach(e=>{let r=[];i.push(r),e.forEach(e=>{r.push(function e(t,i){if(" "===t)return null;let r=t.match(/(.)(-[^-]*)?(-[^-]*)?/),a=i.get(t);if(!a&&r[2]&&r[3]&&(a=i.get(`${r[1]}${r[2]}`)),!a&&r[2]&&(a=i.get(r[1])),!a){let a=function(e){for(let t in tH)if(tH[t].includes(e))return tH[t][0];return null}(r[1]);if(a&&a!==r[1]){var n,s;let t;return e((n=r[2],s=r[3],t=a,n&&(t+=n),s&&(t+=s),t),i)}f.error(`Failed to find symbol for ${t}`)}return a}(e,t))})}),this.matrix=i}}function tV(e){return tH.DOOR_IN.includes(e)}function tK(e){return tH.DOOR_OUT.includes(e)}function tY(e){return tH.GROUND.includes(e)}function tX(e){var t;return tH.WALL.includes(e)||tV(t=e)||tK(t)}class tq{#eK;#eY;#eX;#eq;setOnClick(e){this.#eK=e}setOnContextClick(e){this.#eY=e}setOnPointerDown(e){this.#eX=e}setOnPointerUp(e){this.#eq=e}actionClick(e){this.#eK?.(this,e)}actionContextClick(e){this.#eY?.(this,e)}actionPointerDown(e){this.#eX?.(this,e)}actionPointerUp(e){this.#eq?.(this,e)}}class tj{#ej;#eZ;constructor(e){this.#eZ=e,this.#ej=new Map}setRouteToCoords(e,t,i){this.#ej.set(this.coordsToKey(t,i),e)}getRouteToCoords(e,t){return this.#ej.get(this.coordsToKey(e,t))}hasRouteToCoords(e,t){return this.#ej.has(this.coordsToKey(e,t))}coordsToKey(e,t){return`${e}|${t}`}keyToGridPoint(e){let t=e.split("|");return new C(parseInt(t[0]),parseInt(t[1]))}forEach(e){this.#ej.forEach((t,i,r)=>e(t,i,r))}containsGridPoint(e){return this.#ej.has(this.coordsToKey(e.x,e.y))}getWaypointsAsGridPoints(e){let t=this.getRouteToCoords(e.x,e.y);return t&&t.length>1?t.slice(1):null}getWaypointsAsWorldPoints(e){let t=this.getWaypointsAsGridPoints(e);return t?t.map(e=>this.#eZ.gridPointToWorldPoint(e)):t}}class tZ{actor;#ej;#eZ;#eJ;constructor(e,t){this.#eZ=e,this.actor=t}getDumbRouteNextTo(e,t,i){let r=this.#eQ(e,t);if(r.coincident(e))return[];this.#eZ.canGridPointBeOccupiedByActor(r,this.actor)||(r=this.#e4(r,t));let a=[],n=Math.sign(r.x-e.x),s=Math.sign(r.y-e.y),o=C.copy(e),l=.5>Math.random(),h=0;for(;i>0;){let t=C.copy(o),c=!1;if(l&&0!==n&&o.x!=r.x?(t.x+=n,c=!0):l||0===s||o.y==r.y||(t.y+=s,c=!0),c=c&&this.#eZ.canGridPointBeOccupiedByActor(t,this.actor))h=0,o=t,i--;else{if(++h>=2)break;o.coincident(e)||a.push(this.#eZ.gridPointToWorldPoint(o)),e=o,l=!l}}return o.coincident(e)||a.push(this.#eZ.gridPointToWorldPoint(o)),a}getAllRoutesFrom(e,t){return this.#ej=new tj(this.#eZ),this.#eJ=e,this.#e0(e.x,e.y,t,null),this.#ej}#e0(e,t,i,r){if(r){if(e===this.#eJ.x&&t===this.#eJ.y||!this.#e1(e,t))return;let a=this.#ej.getRouteToCoords(e,t);if(a&&!(r.length<a.length-1))return;r.push(new C(e,t)),this.#e8(e,t)&&this.#ej.setRouteToCoords(r,e,t),i--}else r=[new C(e,t)];i>0&&(this.#e0(e,t-1,i,[...r]),this.#e0(e+1,t,i,[...r]),this.#e0(e,t+1,i,[...r]),this.#e0(e-1,t,i,[...r]))}#e1(e,t){return this.#eZ.isGridPointPassableByActor(new C(e,t),this.actor)}#e8(e,t){return this.#eZ.canGridPointBeOccupiedByActor(new C(e,t),this.actor)}#eQ(e,t){let i=t.x-e.x,r=t.y-e.y,a=t.x,n=t.y;return Math.abs(i)>Math.abs(r)?a-=Math.sign(i):n-=Math.sign(r),new C(a,n)}#e4(e,t){return e.x===t.x&&e.y<t.y?new C(e.x+1,e.y+1):e.x>t.x&&e.y===t.y?new C(e.x-1,e.y+1):e.x===t.x&&e.y>t.y?new C(e.x-1,e.y-1):e.x<t.x&&e.y===t.y?new C(e.x+1,e.y-1):e}}class tJ{#e3;#e2;#eZ;#e9;#e6;#e5;#e7;constructor(e,t){this.#eZ=e,this.#e3=t}findReachedTiles(){return this.#e2=this.#eZ.worldPointToGrid(this.#e3.position),this.#e5=this.#eZ.getMapGridPointRect(),this.#e6&&this.#e6.coincident(this.#e2)&&this.#e5&&this.#e5.equals(this.#e7)||(this.#e9=new Map,this.#e9.set(this.#e2.toString(),this.#e2),this.#te().forEach(e=>{this.#tt(e)}),this.#e6=this.#e2,this.#e7=this.#e5),this.#e9}isGridPointInRays(e){return!!this.#e9&&this.#e9.has(e.toString())}#te(){let e=[];for(let t=this.#e5.x;t<=this.#e5.x+this.#e5.width;t++)e.push(new C(t,this.#e5.y)),e.push(new C(t,this.#e5.y+this.#e5.height));for(let t=this.#e5.y+1;t<=this.#e5.y+this.#e5.height-1;t++)e.push(new C(this.#e5.x,t)),e.push(new C(this.#e5.x+this.#e5.width,t));return e}#tt(e){let t,i,r;let a=function(e){let t=Math.abs(e);return t<=w.DEG_22_5?T.E:t<=w.DEG_67_5?Math.sign(e)>0?T.NE:T.SE:t<=w.DEG_112_5?Math.sign(e)>0?T.N:T.S:t<=w.DEG_157_7?Math.sign(e)>0?T.NW:T.SW:T.W}(this.#e2.getScreenAngleTo(e));Math.abs(e.x-this.#e2.x)>=Math.abs(e.y-this.#e2.y)?(t=Math.sign(e.x-this.#e2.x),i=(r=Math.abs(e.x-this.#e2.x))<1?0:(e.y-this.#e2.y)/r):(i=Math.sign(e.y-this.#e2.y),t=(r=Math.abs(e.y-this.#e2.y))<1?0:(e.x-this.#e2.x)/r);let n=this.#e2.x,s=this.#e2.y,o=!0;for(;r>=0;){let e=new C(Math.round(n),Math.round(s));if(o||this.#eZ.isSeeThrough(e,this.#e3))this.#ti(e,a);else break;o=!1,n+=t,s+=i,r--}}#ti(e,t){switch(this.#e9.set(e.toString(),e),t){case T.N:this.#tr(new C(e.x-1,e.y-1)),this.#tr(new C(e.x,e.y-1)),this.#tr(new C(e.x+1,e.y-1));break;case T.NE:this.#tr(new C(e.x,e.y-1)),this.#tr(new C(e.x+1,e.y-1)),this.#tr(new C(e.x+1,e.y));break;case T.E:this.#tr(new C(e.x+1,e.y-1)),this.#tr(new C(e.x+1,e.y)),this.#tr(new C(e.x+1,e.y+1));break;case T.SE:this.#tr(new C(e.x+1,e.y)),this.#tr(new C(e.x+1,e.y+1)),this.#tr(new C(e.x,e.y+1));break;case T.S:this.#tr(new C(e.x-1,e.y+1)),this.#tr(new C(e.x,e.y+1)),this.#tr(new C(e.x+1,e.y+1));break;case T.SW:this.#tr(new C(e.x-1,e.y)),this.#tr(new C(e.x-1,e.y+1)),this.#tr(new C(e.x,e.y+1));break;case T.W:this.#tr(new C(e.x-1,e.y-1)),this.#tr(new C(e.x-1,e.y)),this.#tr(new C(e.x-1,e.y+1));break;case T.NW:this.#tr(new C(e.x-1,e.y)),this.#tr(new C(e.x-1,e.y-1)),this.#tr(new C(e.x,e.y-1))}}#tr(e){this.#eZ.isSeeThrough(e)||this.#e9.set(e.toString(),e)}}const tQ={DOOR_HIGHLIGHT_FILL:"rgba(0, 255, 0, 0.2)",HP_GAUGE:"rgba(204, 51, 0, 0.4)",HP_TRANSIENT_TEXT_HERO:"white",HP_TRANSIENT_TEXT_ENEMY:"black",INTERACT_HIGHLIGHT_FILL:"transparent",INTERACT_HIGHLIGHT_STROKE:"black",MOVE_HIGHLIGHT_FILL:"rgba(255, 255, 255, 0.2)",MOVE_HIGHLIGHT_STROKE:"white"},t4={MOVEMENT_TILE:0,INTERACT_TILE:1,OCCUPIED_TILE:2,MOVE_OR_INTERACT_TILE:4},t0={OBSTACLE:-1,GROUND:0,ENTRANCE:1,EXIT:2};class t1 extends tq{sprite;obstacle;#ta;#tn;#ts;#to;constructor(e,t){super(),this.sprite=e,this.#ta=new Map,this.obstacle=t.obstacle,this.#tn=t.gridPoint,this.#ts=t.worldPoint,this.#to=t.role}get role(){return this.#to}get gridPoint(){return this.#tn}get worldPoint(){return this.#ts}addOccupant(e){this.#ta.set(e,e)}deleteOccupant(e){this.#ta.delete(e)}getOccupants(){return this.#ta}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionClick(this.sprite.position)}isOccupied(){return this.#ta.size>0}isPassableByActor(e){if(this.#to===t0.ENTRANCE||this.#to===t0.EXIT||this.obstacle)return!1;for(let t of this.#ta.values())if(t!==e&&!t.isPassableByActor(e))return!1;return!0}canBeOccupiedByActor(e){if((this.#to===t0.ENTRANCE||this.#to===t0.EXIT)&&!e.isHero()||this.obstacle)return!1;for(let t of this.#ta.values())if(t!==e&&!t.canShareLocationWithActor(e))return!1;return!0}isSeeThrough(e){return!this.obstacle&&this.#to!==t0.ENTRANCE&&this.#to!==t0.EXIT}}class t8{#tl;#th;#tc;#tu;#td;#R;#O;#tp;#tf;#tm;#tg;#tS;#tw;#tE;#tT;#ty;#tA;#tx;#tR;#tO;#tC;constructor(e,t,i,r){this.#tC=r;let a=t.matrix;if(this.#tT=t.entryPointByDoor,this.#ty=t.exitPointByDoor,this.#tl=e,this.#tm=new eO({renderer:new ey(e,{width:i,height:i,fillStyle:tQ.MOVE_HIGHLIGHT_FILL,strokeStyle:tQ.MOVE_HIGHLIGHT_STROKE})}),this.#tg=new eO({renderer:new ey(e,{width:i,height:i,fillStyle:tQ.DOOR_HIGHLIGHT_FILL,strokeStyle:"green"})}),this.#tO=new eO({renderer:new ey(e,{width:i,height:i,fillStyle:tQ.INTERACT_HIGHLIGHT_FILL,strokeStyle:tQ.INTERACT_HIGHLIGHT_STROKE})}),this.#td=i,this.#th=[],this.#tu=a.length,this.#tc=a[0].length,this.#R=i*this.tilesX,this.#O=i*this.tilesY,this.#tA=[],a.forEach((t,i)=>{let r=[];this.#th.push(r),t.forEach((t,a)=>{if(t){let n=new eO({renderer:new eR(e,ed.getSpriteBitmap(t.image))}),s=new C(a,i),o=this.gridPointToWorldPoint(s),l=new t1(n,{obstacle:t.role===t0.OBSTACLE,gridPoint:s,worldPoint:o,role:t.role});t.onClick&&l.setOnClick((e,i)=>this.#tI(e,i,t.onClick)),this.processTileRole(l),r.push(l),n.position.x=a*this.#td+this.#td/2,n.position.y=i*this.#td+this.#td/2}else r.push(null)})}),this.#tw||(f.error("No entrance has been set. Setting to the first ground tile"),this.#tw=this.#tA[0]),!this.#tE)throw Error("No exit tile.")}getDimsInTiles(){return{width:this.#tc,height:this.#tu}}processTileRole(e){switch(e.role){case t0.ENTRANCE:if(this.#tw){let t=e.gridPoint;f.error(`Duplicate entrance found at (${t.x}, ${t.y}). Ignored.`)}else this.#tw=e;break;case t0.EXIT:if(this.#tE){let t=e.gridPoint;f.error(`Duplicate exit found at (${t.x}, ${t.y}). Ignored.`)}else this.#tE=e;break;case t0.GROUND:e.gridPoint.coincident(this.#tT)||this.#tA.push(e)}}update(e){this.#tN();let t=this.getVisibleGridPointRect();for(let i=t.y;i<=t.y+t.height;i++)for(let r=t.x;r<=t.x+t.width;r++)if(this.#tx?.isGridPointInRays(new C(r,i))){let t=this.#th[i][r];t?.sprite.update(e)}this.#tv(e)}#tN(){if(this.#tC){this.#tx||(this.#tx=new tJ(this,this.#tC));let e=this.getTileAtWorldPoint(this.#tC.position);if(e){let t=e.role;t!=t0.ENTRANCE&&t!=t0.EXIT&&this.#tx.findReachedTiles()}}}getMapGridPointRect(){return new P(0,0,this.#tc,this.#tu)}getVisibleGridPointRect(){let e=J.getWorldInCanvasBounds(),t=this.worldPointToGrid(new C(e.x,e.y)),i=this.worldPointToGrid(new C(e.x+e.width,e.y+e.height)),r=Math.max(0,t.x),a=Math.min(this.#tc-1,i.x),n=Math.max(0,t.y);return new P(r,n,a-r,Math.min(this.#tu-1,i.y)-n)}getGridSize(){return this.#td}getDimensions(){return{width:this.#R,height:this.#O}}getTileAtWorldPoint(e){let t=this.worldPointToGrid(e);return this.getTileAtGridPoint(t)}getTileAtGridPoint(e){if(!e)return null;let t=e.y,i=e.x;return i>=0&&t>=0&&i<this.#tc&&t<this.#tu?this.#th[t][i]:null}worldPointToGrid(e){return new C(Math.floor(e.x/this.#td),Math.floor(e.y/this.#td))}gridAlignedWorldPoint(e){let t=this.worldPointToGrid(e);return this.gridPointToWorldPoint(t)}gridPointToWorldPoint(e){let t=.5*this.#td;return new C(e.x*this.#td+t,e.y*this.#td+t)}getWorldPositionOfTileByEntry(){return this.gridPointToWorldPoint(this.#tT)}getGridPositionOfEntrance(){return this.#tw.gridPoint}setMovementRoutes(e){this.#tp=e,e?(this.#tf=new Map,this.#tp.forEach(e=>e.forEach(e=>{this.#tf.set(e,e)}))):this.#tf=null}setInteractActors(e){this.#tR=[],e?.forEach(e=>{e.interaction.canReact()&&this.#tR.push(this.worldPointToGrid(e.position))})}calcReachableDoors(e){this.#tS=[];let t=this.getSurroundingTiles(this.worldPointToGrid(e));[t.above,t.right,t.below,t.left].forEach(e=>{e.gridPoint.coincident(this.#tE.gridPoint)?this.#tS.push(e.gridPoint):e.gridPoint.coincident(this.#tw.gridPoint)&&this.#tS.push(e.gridPoint)})}#tv(e){this.#tP(e),this.#tL(e),this.#tM(e)}#tP(e){this.#tf?.forEach(t=>{this.#tm.position=this.gridPointToWorldPoint(t),this.#tm.update(e)})}#tL(e){this.#tR?.forEach(t=>{this.#tO.position=this.gridPointToWorldPoint(t),this.#tO.update(e)})}#tM(e){this.#tS?.forEach(t=>{this.#tg.position=this.gridPointToWorldPoint(t),this.#tg.update(e)})}#tI(e,t,i){let r;let a=this.worldPointToGrid(t),n=e.getOccupants();n.size>0&&(r=n.values().next().value);let s=this.#tp?.containsGridPoint(a),o=!1;if(this.#tR){for(let e of this.#tR)if(e.isCoincident(a)){o=!0;break}}let l=!r?.alive&&r?.isProp();if(s&&o||o&&l){i(e,t,{filter:t4.MOVE_OR_INTERACT_TILE,occupant:r});return}if(s){i(e,t,{filter:t4.MOVEMENT_TILE,occupant:r});return}if(o){i(e,t,{filter:t4.INTERACT_TILE,occupant:r});return}if(this.#tS){for(let r of this.#tS)if(r.isCoincident(a)){i(e,t,{filter:t4.INTERACT_TILE});return}}let h=this.worldPointToGrid(this.#tC.position);if(a.coincident(h)){i(e,t,{occupant:this.#tC,filter:t4.OCCUPIED_TILE});return}r&&i(e,t,{occupant:r,filter:t4.OCCUPIED_TILE}),f.debug("Ignore click outside of highlighted area")}getWaypointsToWorldPoint(e){let t=this.worldPointToGrid(e);return this.#tp?.getWaypointsAsWorldPoints(t)}getRandomFreeGroundTile(){for(let e of(tU(this.#tA),this.#tA))if(!e.isOccupied())return e;return null}isGridPointPassableByActor(e,t){let i=this.getTileAtGridPoint(e);return!!i&&i.isPassableByActor(t)}canGridPointBeOccupiedByActor(e,t){let i=this.getTileAtGridPoint(e);return!!i&&i.canBeOccupiedByActor(t)}canHeroSeeGridPoint(e){return this.#tx?.isGridPointInRays(e)??!0}isSeeThrough(e,t){let i=this.getTileAtGridPoint(e);return!i||i.isSeeThrough(t)}getSurroundingTiles(e){return tk(this.#th,e.y,e.x)}getRadiatingUpAndDown(e,t=1){return function(e,t){let i;let r=t.columnIndex,a=t.rowIndex,n=[],s=!0,o=!0,l=!0,h=!0,c=1,u=t.distance??1;for(;u-- >0;)h&&(i=e[a][r-c],t.filter&&!t.filter(i)?h=!1:n.push(i)),o&&(i=e[a][r+c],t.filter&&!t.filter(i)?o=!1:n.push(i)),s&&(i=e[a-c][r],t.filter&&!t.filter(i)?s=!1:n.push(i)),l&&(i=e[a+c][r],t.filter&&!t.filter(i)?l=!1:n.push(i)),c++;return n}(this.#th,{rowIndex:e.y,columnIndex:e.x,distance:t,filter:e=>e.role===t0.GROUND})}deleteOccupancyOfGridPoint(e,t){this.getTileAtGridPoint(t)?.deleteOccupant(e)}moveTileOccupancyGridPoint(e,t,i){i!==t&&(this.getTileAtGridPoint(t)?.deleteOccupant(e),this.getTileAtGridPoint(i)?.addOccupant(e))}getCoincidentActors(e){return this.getTileAtWorldPoint(e.position).getOccupants()}getParticipants(e){let t=[],i=this.getSurroundingTiles(this.worldPointToGrid(e.position));return[i.above,i.right,i.below,i.left].forEach(e=>{let i=e?.getOccupants();i?.forEach(e=>{t.push(e)})}),t}}const t3=[{id:"MUSIC_VOLUME",labelKey:"CONTROL MUSIC VOLUME",defValue:50,controlType:eY.RANGE,persistent:!0,action:null,onChange:e=>e2.setMusicVolumePercent(e)},{id:"EFFECTS_VOLUME",labelKey:"CONTROL EFFECTS VOLUME",defValue:50,controlType:eY.RANGE,persistent:!0,action:null,onChange:e=>{e2.setEffectsVolumePercent(e),e2.playEffect("PUNCH")}},{id:"SHOW_QUICK_TIPS_AT_START",labelKey:"CONTROL SHOW QUICK TIPS",defValue:!0,controlType:eY.CHECKBOX,persistent:!0,action:null,onChange:null},{id:"START_IN_FULLSCREEN",labelKey:"CONTROL START IN FULLSCREEN",defValue:!1,controlType:eY.CHECKBOX,persistent:!0,action:null,onChange:null},{id:"SHOW_DEBUG_LOG",labelKey:"BUTTON SHOW DEBUG LOG",defValue:!0,controlType:eY.TEXT_BUTTON,persistent:!1,action:()=>(function(){f.getMessages();let e="";for(let t of f.getMessages())e+=t+"\n";return e3.showOkDialog(e,{title:ej`DIALOG TITLE DEBUG LOG`,className:"wall"})})(),onChange:null}];function t2(){let e=[];return t3.forEach(t=>{e.push(function(e){let t;switch(e.controlType){case eY.CHECKBOX:t=new eV(e);break;case eY.RANGE:t=new eK(e);break;case eY.TEXT_BUTTON:t=new eF(e);break;default:throw Error(`Attempt to create unrecognised control type ${e.controlType}`)}return t}(t))}),e3.showControlsDialog(ej`DIALOG TITLE SETTINGS`,{actionButtons:e,className:"door"})}const t9={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:em.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:em.REVERSE}},WALK_NORTH:{keyName:"WALK_N",suffix:"walk-n",options:{framePeriodMs:100,loopMethod:em.REVERSE}},WALK_EAST:{keyName:"WALK_E",suffix:"walk-e",options:{framePeriodMs:100,loopMethod:em.REVERSE}},WALK_SOUTH:{keyName:"WALK_S",suffix:"walk-s",options:{framePeriodMs:100,loopMethod:em.REVERSE}},WALK_WEST:{keyName:"WALK_W",suffix:"walk-w",options:{framePeriodMs:100,loopMethod:em.REVERSE}}},t6={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:em.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:em.REVERSE}}};class t5{#tD;constructor(e){this.#tD=e}#tb(e,t){let i=this.#tD[e]?.suffix;if(!i)throw Error(`Attempt made to use invalid standard animation key of '${e}'`);return`${t}-${i}`}getKeyName(e){return this.#tD[e].keyName}addAllToKeyedAnimation(e,t){for(let i in this.#tD){let r=this.#tD[i];e.addAnimatedImage(this.#tD[i].keyName,new eS({prefix:this.#tb(i,t),suffix:".png",startIndex:0,padding:2},r.options))}e.setCurrentKey(this.#tD.IDLE.keyName)}}const t7={peripatetic:new t5(t9),artefact:new t5(t6)},ie=["a","e","i","o","u","ee","oo"],it=["b","br","ch","chr","cl","cr","d","dr","fl","fr","g","gl","gr","h","j","k","kr","kl","l","m","n","p","pl","pr","qu","r","s","sch","sh","st","t","th","tr","v","w","y","z"],ii=["b","bbey","bble","bboy","bby","c","ch","ck","cky","ct","d","f","ff","ffle","ffy","ffey","g","ge","gey","gle","k","l","ll","lly","lley","m","n","ngle","nny","p","r","s","sk","ss","ssy","st","sty","t","th","thy","v","w","y","z","zzle","zzy"];function ir(){let e;return(e=.5>Math.random()?A(it)+A(ie)+A(ii):A(it)+A(ie)+A(it)+A(ie)+A(ii)).charAt(0).toUpperCase()+e.substring(1)}class ia extends ex{actor;constructor(e,t){super(e,t)}render(e){if(this.actor&&this.actor.traits){let e=this.actor.traits.getInt("HP",0),t=this.actor.traits.getInt("HP_MAX",1);this.setLevel(0,e/t)}super.render(e)}}class is extends ew{#e3;#t_;#tz;#tB;constructor(e,t){super(e,t),this.#t_=T.NONE,this.#tB=t}setActor(e){this.#e3=e,this.#tz=this.#e3.alive}getCurrentFrame(){let e=this.#tG();return(e!==this.#t_||this.#tz!=this.#e3?.alive)&&(this.#t_=e,this.#tz=this.#e3?.alive,this.#tk()),super.getCurrentFrame()??this.#tB.getCurrentFrame()??ed.getUndefinedBitmap()}#tG(){return!this.#e3||this.#e3.velocity.isZero(.1)?T.NONE:function(e){let t=Math.abs(e);return t<=w.DEG_45?T.E:t<=w.DEG_135?Math.sign(e)>0?T.N:T.S:T.W}(this.#e3.velocity.getScreenDirection())}#tk(){let e=this.#e3.disengaging;if(!this.#e3.alive)return this.setCurrentKey(t7.peripatetic.getKeyName("DEAD"));switch(this.#t_){case T.NONE:this.setCurrentKey(t7.peripatetic.getKeyName("IDLE"));break;case T.E:this.setCurrentKey(t7.peripatetic.getKeyName(e?"WALK_WEST":"WALK_EAST"));break;case T.N:case T.NW:case T.NE:this.setCurrentKey(t7.peripatetic.getKeyName(e?"WALK_SOUTH":"WALK_NORTH"));break;case T.W:this.setCurrentKey(t7.peripatetic.getKeyName(e?"WALK_EAST":"WALK_WEST"));break;default:this.setCurrentKey(t7.peripatetic.getKeyName(e?"WALK_NORTH":"WALK_SOUTH"))}}}function io(e,t,i,r){let a;let n=function(e){let t=new is("still",new eS(`${e}.png`));return t7.peripatetic.addAllToKeyedAnimation(t,e),t}(e),s=new eR(J.getContext2D(),n),o=new ag(new eO({renderer:i.get("MOVE")!==am.ORGANIC?[a=new ia(J.getContext2D(),{tileSize:eG.TILE_SIZE-2,fillStyles:[tQ.HP_GAUGE],strokeStyles:[]}),s]:[s]}),r.type);return n.setActor(o),a&&(a.actor=o),o.position=new v(eG.TILE_SIZE,eG.TILE_SIZE,0),o.almanacEntry=r,o.traits=i,o.velocity={x:0,y:0,rotation:0},o.iconImageName=t?`${t}.png`:`${e}.png`,o}function il(e,t){let i;let r=t??new tR(e.traitsString);switch(r.get("NAME")||r.set("NAME",e.name),e.type){case ap.HERO:(i=io(e.imageName,null,r,e)).type=ap.HERO,t||(r.set("NAME",`${ir()} ${ir()}`),tp(r)),i.toxify=new ao;break;case ap.OBJECTIVE:i=function(e,t,i,r){let a=io(e,null,i,r);return a.interaction=new ad(a),a}(e.imageName,0,r,e);break;case ap.TRADER:i=function(e,t,i,r){let a=io(e,null,i,r);return a.interaction=new aa(a),a}(e.imageName,0,r,e);break;case ap.HIDDEN_ARTEFACT:i=function(e,t,i){let r=function(e){let t=new is("still",new eS(`${e}.png`));return t7.artefact.addAllToKeyedAnimation(t,e),t}(e),a=new ag(new eO({renderer:[new eR(J.getContext2D(),r)]}),"SPELL"===i.type?ap.PROP:ap.HIDDEN_ARTEFACT);return r.setActor(a),a.position=new v(eG.TILE_SIZE,eG.TILE_SIZE,0),a.velocity={x:0,y:0,rotation:0},a.interaction=new an(a),a.iconImageName=`${e}.png`,a.traits=new tR,a}(e.imageName,0,r,e);break;case ap.PROP:i=function(e,t,i,r){let a=io(e,null,i,r);return a.interaction=new an(a),a}(e.imageName,0,r,e);break;default:i=function(e,t,i,r){let a=io(e,null,i,r);return a.isOrganic()?(a.interaction=new as(a),a.obstacle=!1):a.interaction=new ai(a),a}(e.imageName,0,r,e)}return i.description=e.description,!t&&e.equipmentIds&&function(e,t){if(t&&0!==t.length)for(let i of t){let t=tL.findById(i,["MONEY","WEAPONS","ARMOUR","MAGIC"]);if(t){let i=tM(t);i.equipStoreType?e.storeManager.equip(i,{direct:!0}):e.storeManager.stash(i,{direct:!0})}else f.error(`Cannot find ${i} artefact in almanac to equip actor.`)}}(i,e.equipmentIds),i}class ih{#tU;#tH;constructor(e=0,t=0){this.#tH=e,this.#tU=t}getChangeInHpThisTurn(){let e=this.#tH+this.#tU,t=Math.floor(e);return this.#tU=e-t,t}addToxicEffect(e){this.#tH+=e}cure(){this.#tH=0,this.#tU=0}get isActive(){return 0!==this.#tH||0!==this.#tU}toJSON(){return{reviver:"Toxin",data:{pendingHpChange:this.#tU,hpPerTurn:this.#tH}}}static revive(e){return new ih(e.hpPerTurn,e.pendingHpChange)}}function ic(e){return 0===e?"1":`B${e}`}class iu{#tF;#t$;#tW;#tV;constructor(e,t={}){this.#t$=e??[],this.#tF=t?.maxLength??10,this.#tW=t.sortFn,this.#tV=t.equalFn??((e,t)=>e==t)}add(e){let t=this.indexOfEqual(e);if(t>=0){let i=this.#t$[t];if(!(0>this.#tW(e,i)))return -1;this.#t$[t]=e}else this.#t$.push(e);return this.#t$.sort(this.#tW),this.#t$.length>this.#tF&&this.#t$.pop(),this.#t$.indexOf(e)}indexOfEqual(e){for(let t=0;t<this.#t$.length;t++)if(this.#tV(e,this.#t$[t]))return t;return -1}getCurrentData(){return[...this.#t$]}getMaxLength(){return this.#tF}}const id="LEADERBOARD_DATA";function ip(){return new iu(eU.get(id),{maxLength:10,sortFn:(e,t)=>e.score>t.score?-1:1,equalFn:(e,t)=>e.adventureStartTime===t.adventureStartTime&&e.name===t.name})}function im(e,t=!1){let i=function(e){let t=ip(),i=t.add(e);return i>=0&&eU.set(id,t.getCurrentData()),i}(function(e,t){let i={adventureStartTime:0,name:"unknown",class:"unknown",gold:0,exp:0,characterLevel:0,dungeonFloor:0,score:0,completed:!1};return e&&(i.adventureStartTime=e.adventureStartTime,i.name=e.traits.get("NAME"),i.class=e.traits.get("CLASS"),i.gold=e.storeManager.getPurseValue(),i.exp=e.traits.getInt("EXP",0),i.characterLevel=e.traits.getCharacterLevel(),i.dungeonFloor=ic(rW.getCurrentSceneLevel()),i.score=Math.floor(100*i.gold*i.characterLevel),i.completed=t),i}(e,t)),r={sceneLevel:rW.getCurrentSceneLevel(),hero:e,completed:t};return eU.set("GAME_STATE",r),i}function ig(e,t){switch(t?.reviver){case"Actor":return ag.revive(t.data,il);case"Toxin":return ih.revive(t.data);case"Artefact":return tB.revive(t.data,tM);case"Traits":return tA.revive(t.data);case"CharacterTraits":return tR.revive(t.data);case"MagicTraits":return tx.revive(t.data);default:return t}}class iS{#tK=new Map;constructor(){}clear(){this.#tK.clear()}#tY(e){return window.btoa(function(e){try{return encodeURIComponent(e)}catch(t){return console.error(t),encodeURIComponent(e.toWellFormed())}}(e)).replace(/=/g,":")}protect(e){if(!e)return e;let t=`???${this.#tK.size}${this.#tY(e)}???`;return this.#tK.set(t,e),t}retrieve(e){let t=this.#tK.get(e);return(this.#tK.delete(e),t)?t:(console.error(`Could not find ${e} in protected data.`),e)}reinstate(e){return e.replace(/[?]{3}\d+[a-zA-Z0-9+/]+:{0,2}[?]{3}/g,e=>this.retrieve(e))}}const iw=new iS;function iE(e,t){return`<span class="printable-link for-print-only">${t?"(":""}${e}${t?")":""}</span>`}const iT=[{re:/(?:(.+)\n=+\n)/g,rep:"\n\n<h1>$1</h1>\n\n"},{re:/(?:(.+)\n-+\n)/g,rep:"\n\n<h2>$1</h2>\n\n"},{re:/^(#+)(?: *)(.+?)(?:#*)[ \t]*$/gm,rep:(e,t,i)=>{let r=Math.min(t.length,6);return`

<h${r}>${i.trim()}</h${r}>
`}},iN(">[ 	]*",{blockPrefix:"<blockquote>",blockSuffix:"</blockquote>"}),iN("(?: {4}|	)",{blockPrefix:"<pre><code>",blockSuffix:"</code></pre>",trimContents:!0,useWarden:!0}),{re:/^(?:[*_-] *){3,}\s*$/gm,rep:"\n\n<hr>\n\n"},iN(" {0,3}[*+-][ 	]+",{blockPrefix:"<ul>",blockSuffix:"</ul>",linePrefix:"<li>",lineSuffix:"</li>"}),iN(" {0,3}\\d+\\.[ 	]+",{blockPrefix:"<ol>",blockSuffix:"</ol>",linePrefix:"<li>",lineSuffix:"</li>"})],iy=[{re:/(?:(?:^|\n{2,})(?!<\w+>))((?:.(?:\n(?!\n))?)+)/g,rep:"\n\n<p>$1</p>\n\n"},{re:/\n{2,}/g,rep:"\n\n"}],iA=[{re:/!(&lt;)?\[(.*?)\]\((https?:\/\/[-\w@:%.+~#=/]+?)(?: +"(.*?)")?\)/gm,rep:(e,t,i,r,a)=>{let n=`<img alt="${i??""}" class="${t?"floatable":""}" src="${r}" title="${a??""}"/>`;return iw.protect(n)}},{re:/\[(.*?)\]\((https?:\/\/[-\w@:%.+~#=/]+?)(?: +"(.*?)")?\)/gm,rep:(e,t,i,r)=>{var a;let n;a=t,n="",/^https:\/\/vimeo.com\//.test(i)?n='<i class="fa-brands fa-vimeo"></i>':/^https:\/\/(www\.)?youtube.com\//.test(i)&&(n='<i class="fa-brands fa-youtube"></i>'),n&&(n=`<span class='link-icon'>${n}</span>`),t=`${a}${n}`;let s=`<a target="_blank" href="${i}" title="${r??""}">${t??""}</a>${iE(i,!0)}`;return iw.protect(s)}},{re:/(?:&lt;|<)(https?:\/\/[-\w@:%.+~#=/]+?)>/gm,rep:(e,t)=>{let i=`<a target="_blank" href="${t}">${t}</a>${iE(t,!0)}`;return iw.protect(i)}},{re:/(?:&lt;|<)([\w.-]+@(?:[\w-]+\.)+[\w-]+)/gm,rep:(e,t)=>{let i=function(e){let t="";for(let i of e)t+=iv(i);return t}(t),r=`<a href="${i}">${i}</a>`;return iw.protect(r)}},{re:/(?:`{2,}(.*?)`{2,}|`(.*?)`)/gm,rep:(e,t,i)=>{let r=`<code>${t??i}</code>`;return iw.protect(r)}},{re:/\*\*([^\s])\*\*/gm,rep:"<strong>$1</strong>"},{re:/__([^\s])__/gm,rep:"<strong>$1</strong>"},{re:/\*([^\s])\*/gm,rep:"<em>$1</em>"},{re:/_([^\s])_/gm,rep:"<em>$1</em>"},{re:/\*\*([^\s])(.*?)([^\s])\*\*/gm,rep:"<strong>$1$2$3</strong>"},{re:/__([^\s])(.*?)([^\s])__/gm,rep:"<strong>$1$2$3</strong>"},{re:/\*([^\s])(.*?)([^\s])\*/gm,rep:"<em>$1$2$3</em>"},{re:/_([^\s])(.*?)([^\s])_/gm,rep:"<em>$1$2$3</em>"}],ix=[{re:/\\([\\`*_{}[\]()#+.!-])/g,rep:(e,t)=>iv(t)}],iR=[{re:"\x00",rep:"ï¿½"}],iO=[{re:/&(?![\w#]+?;)/gm,rep:"&amp;"},{re:/<(?!\/?(?:br|sub|sup)>)/gim,rep:"&lt;"}],iC=[{re:/^\s*$/gm,rep:""},{re:/<(?:p|div)>\s*?<\/(?:p|div)>/gim,rep:""}];function iI(e,t){return e&&t.forEach(t=>{e=e.replaceAll(t.re,t.rep)}),e}function iN(e,t){let i=RegExp(`(?:^|\\n)${e}(?:.|\\n)*?(?:(\\n(?!${e}))|$)`,"g"),r=RegExp(`^${e}([ \\t]*.*)$`,"gm"),a=`${t?.linePrefix??""}$1${t?.lineSuffix??""}`;return{re:i,rep:e=>{let i=e.replaceAll(r,a);return t.trimContents&&(i=i.replace(/^[\n\r]*/,"").trimEnd()),t.useWarden&&(i=iw.protect(i)),`

${t?.blockPrefix??""}${i}${t?.blockSuffix??""}

`}}}function iv(e){return`&#${e.charCodeAt(0).toString()};`}var iP={};iP=JSON.parse('{"frames":[{"filename":"acid00.png","frame":{"x":99,"y":95,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"axe.png","frame":{"x":150,"y":95,"w":42,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":42,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"barbarian1-dead00.png","frame":{"x":1,"y":1097,"w":48,"h":33},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":11,"w":48,"h":33},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-idle00.png","frame":{"x":151,"y":641,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":44,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-idle01.png","frame":{"x":101,"y":393,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":45,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-e00.png","frame":{"x":200,"y":146,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":42,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-e01.png","frame":{"x":101,"y":443,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":46,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-e02.png","frame":{"x":51,"y":292,"w":41,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":41,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-e03.png","frame":{"x":241,"y":740,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":0,"w":36,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-n00.png","frame":{"x":94,"y":293,"w":48,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":48,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-n01.png","frame":{"x":195,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-n02.png","frame":{"x":195,"y":51,"w":48,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":48,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-n03.png","frame":{"x":101,"y":991,"w":44,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":44,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-s00.png","frame":{"x":151,"y":690,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":44,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-s01.png","frame":{"x":101,"y":1041,"w":44,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":44,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-s02.png","frame":{"x":151,"y":739,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":44,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-s03.png","frame":{"x":101,"y":941,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":45,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-w00.png","frame":{"x":201,"y":788,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":38,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-w01.png","frame":{"x":197,"y":640,"w":41,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":41,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-w02.png","frame":{"x":280,"y":840,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":38,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1-walk-w03.png","frame":{"x":285,"y":790,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":0,"w":33,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"barbarian1.png","frame":{"x":194,"y":461,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":44,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"black_flask.png","frame":{"x":237,"y":887,"w":28,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":28,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"blank.png","frame":{"x":406,"y":842,"w":3,"h":3},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":3,"h":3},"sourceSize":{"w":48,"h":49}},{"filename":"block.png","frame":{"x":1,"y":547,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"blood-splat-twice.png","frame":{"x":1,"y":99,"w":96,"h":94},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":96,"h":94},"sourceSize":{"w":96,"h":96}},{"filename":"blood-splat.png","frame":{"x":99,"y":1,"w":94,"h":92},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":4,"w":94,"h":92},"sourceSize":{"w":96,"h":96}},{"filename":"blue_crystal.png","frame":{"x":197,"y":740,"w":42,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"blue_flask.png","frame":{"x":237,"y":937,"w":28,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":28,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"cantrip.png","frame":{"x":432,"y":578,"w":44,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"chain_mail_armour.png","frame":{"x":150,"y":858,"w":42,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":3,"w":42,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-dead00.png","frame":{"x":194,"y":243,"w":48,"h":29},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":12,"w":48,"h":29},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-idle00.png","frame":{"x":101,"y":493,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-idle01.png","frame":{"x":101,"y":793,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-e00.png","frame":{"x":194,"y":887,"w":41,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":41,"h":46},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-e01.png","frame":{"x":101,"y":842,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":47,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-e02.png","frame":{"x":147,"y":1036,"w":39,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":2,"w":39,"h":46},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-e03.png","frame":{"x":415,"y":712,"w":36,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":4,"w":36,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-n00.png","frame":{"x":145,"y":342,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":46,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-n01.png","frame":{"x":101,"y":543,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":47,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-n02.png","frame":{"x":193,"y":316,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":46,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-n03.png","frame":{"x":195,"y":510,"w":43,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":43,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-s00.png","frame":{"x":240,"y":660,"w":43,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":43,"h":46},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-s01.png","frame":{"x":241,"y":372,"w":46,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":3,"w":46,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-s02.png","frame":{"x":321,"y":745,"w":43,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":43,"h":46},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-s03.png","frame":{"x":101,"y":891,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-w00.png","frame":{"x":238,"y":838,"w":40,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":2,"w":40,"h":46},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-w01.png","frame":{"x":195,"y":559,"w":43,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":43,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-w02.png","frame":{"x":320,"y":835,"w":40,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":2,"w":40,"h":46},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1-walk-w03.png","frame":{"x":451,"y":802,"w":36,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":36,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"cleric1.png","frame":{"x":101,"y":593,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"club.png","frame":{"x":399,"y":1,"w":48,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"coins.png","frame":{"x":1,"y":292,"w":48,"h":49},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"copper_coins.png","frame":{"x":286,"y":617,"w":44,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":4,"w":44,"h":44},"sourceSize":{"w":48,"h":49}},{"filename":"dagger.png","frame":{"x":194,"y":935,"w":41,"h":35},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":7,"w":41,"h":35},"sourceSize":{"w":49,"h":48}},{"filename":"door-B.png","frame":{"x":1,"y":597,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-L.png","frame":{"x":307,"y":936,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-R.png","frame":{"x":342,"y":932,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-T.png","frame":{"x":449,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door2-B.png","frame":{"x":1,"y":647,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door2-T.png","frame":{"x":1,"y":697,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"engraved_pillar.png","frame":{"x":149,"y":1084,"w":39,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":39,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"failed-spell.png","frame":{"x":1,"y":1,"w":96,"h":96},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":96,"h":96},"sourceSize":{"w":96,"h":96}},{"filename":"fighter1-dead00.png","frame":{"x":274,"y":709,"w":46,"h":29},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":12,"w":46,"h":29},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-idle00.png","frame":{"x":190,"y":1084,"w":37,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":3,"w":37,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-idle01.png","frame":{"x":229,"y":1084,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":3,"w":38,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-e00.png","frame":{"x":452,"y":942,"w":29,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":3,"w":29,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-e01.png","frame":{"x":415,"y":942,"w":35,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":35,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-e02.png","frame":{"x":269,"y":1084,"w":28,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":28,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-e03.png","frame":{"x":340,"y":986,"w":27,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":4,"w":27,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-n00.png","frame":{"x":445,"y":848,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":36,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-n01.png","frame":{"x":320,"y":883,"w":40,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":40,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-n02.png","frame":{"x":443,"y":895,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":36,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-n03.png","frame":{"x":406,"y":847,"w":37,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":37,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-s00.png","frame":{"x":404,"y":893,"w":37,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":3,"w":37,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-s01.png","frame":{"x":377,"y":940,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":36,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-s02.png","frame":{"x":453,"y":708,"w":37,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":3,"w":37,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-s03.png","frame":{"x":267,"y":936,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":3,"w":38,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-w00.png","frame":{"x":404,"y":1038,"w":28,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":28,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-w01.png","frame":{"x":303,"y":986,"w":35,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":35,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-w02.png","frame":{"x":404,"y":1085,"w":28,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":28,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1-walk-w03.png","frame":{"x":434,"y":1039,"w":27,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":4,"w":27,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"fighter1.png","frame":{"x":453,"y":755,"w":37,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":3,"w":37,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"fire00.png","frame":{"x":1,"y":747,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"fire01.png","frame":{"x":1,"y":343,"w":48,"h":49},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"floor-SBE.png","frame":{"x":1,"y":797,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor-SBW.png","frame":{"x":1,"y":847,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor.png","frame":{"x":1,"y":897,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBE.png","frame":{"x":1,"y":947,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBW.png","frame":{"x":1,"y":997,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2.png","frame":{"x":1,"y":1047,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-dead00.png","frame":{"x":195,"y":608,"w":43,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":12,"w":43,"h":30},"sourceSize":{"w":49,"h":48}},{"filename":"goblin-idle00.png","frame":{"x":149,"y":902,"w":43,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":6,"w":43,"h":42},"sourceSize":{"w":49,"h":48}},{"filename":"goblin-idle01.png","frame":{"x":444,"y":198,"w":47,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":47,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"goblin-walk-e00.png","frame":{"x":228,"y":1039,"w":37,"h":43},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":5,"w":37,"h":43},"sourceSize":{"w":49,"h":48}},{"filename":"goblin-walk-n00.png","frame":{"x":285,"y":663,"w":44,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":44,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"goblin-walk-s00.png","frame":{"x":148,"y":946,"w":43,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":6,"w":43,"h":42},"sourceSize":{"w":49,"h":48}},{"filename":"goblin-walk-w00.png","frame":{"x":188,"y":1039,"w":38,"h":43},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":5,"w":38,"h":43},"sourceSize":{"w":49,"h":48}},{"filename":"goblin.png","frame":{"x":366,"y":798,"w":43,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":6,"w":43,"h":42},"sourceSize":{"w":49,"h":48}},{"filename":"gold_coins.png","frame":{"x":1,"y":394,"w":48,"h":49},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"green_flask.png","frame":{"x":243,"y":989,"w":28,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":28,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"half_plate_armour.png","frame":{"x":295,"y":244,"w":48,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":4,"w":48,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"handaxe.png","frame":{"x":101,"y":342,"w":42,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":42,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"helmet.png","frame":{"x":411,"y":800,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":1,"w":38,"h":45},"sourceSize":{"w":48,"h":49}},{"filename":"hidden_artefact-dead00.png","frame":{"x":240,"y":708,"w":32,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":10,"w":32,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"hidden_artefact-idle00.png","frame":{"x":481,"y":440,"w":18,"h":20},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":14,"y":16,"w":18,"h":20},"sourceSize":{"w":48,"h":48}},{"filename":"hidden_artefact.png","frame":{"x":481,"y":462,"w":18,"h":20},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":14,"y":16,"w":18,"h":20},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down00.png","frame":{"x":144,"y":294,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down01.png","frame":{"x":193,"y":365,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left00.png","frame":{"x":241,"y":324,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left01.png","frame":{"x":289,"y":329,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right00.png","frame":{"x":289,"y":377,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right01.png","frame":{"x":337,"y":334,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up00.png","frame":{"x":385,"y":334,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up01.png","frame":{"x":337,"y":382,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre00.png","frame":{"x":385,"y":382,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre01.png","frame":{"x":433,"y":338,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen00.png","frame":{"x":51,"y":342,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen01.png","frame":{"x":433,"y":386,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"iron_rations.png","frame":{"x":322,"y":712,"w":45,"h":31},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":10,"w":45,"h":31},"sourceSize":{"w":49,"h":49}},{"filename":"leather_armour.png","frame":{"x":51,"y":1092,"w":48,"h":38},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":38},"sourceSize":{"w":48,"h":48}},{"filename":"magic00.png","frame":{"x":362,"y":842,"w":42,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":42,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"manhole_cover-dead00.png","frame":{"x":474,"y":1027,"w":30,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":9,"w":30,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"manhole_cover-idle00.png","frame":{"x":367,"y":1037,"w":30,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":9,"w":30,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"manhole_cover.png","frame":{"x":434,"y":1085,"w":30,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":9,"w":30,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"miss.png","frame":{"x":332,"y":622,"w":44,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":44,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-dead00.png","frame":{"x":51,"y":392,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-idle00.png","frame":{"x":51,"y":442,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-idle01.png","frame":{"x":51,"y":492,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-idle02.png","frame":{"x":51,"y":542,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-idle03.png","frame":{"x":51,"y":592,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-walk-e00.png","frame":{"x":245,"y":51,"w":48,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-walk-n00.png","frame":{"x":51,"y":642,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-walk-s00.png","frame":{"x":145,"y":196,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-walk-w00.png","frame":{"x":295,"y":51,"w":48,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas.png","frame":{"x":51,"y":692,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-dead00.png","frame":{"x":244,"y":244,"w":49,"h":36},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":8,"w":49,"h":36},"sourceSize":{"w":49,"h":48}},{"filename":"orc-idle00.png","frame":{"x":148,"y":391,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"orc-idle01.png","frame":{"x":149,"y":441,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"orc-walk-e00.png","frame":{"x":197,"y":690,"w":41,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":0,"w":41,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"orc-walk-n00.png","frame":{"x":150,"y":491,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":0,"w":42,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"orc-walk-s00.png","frame":{"x":150,"y":541,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"orc-walk-w00.png","frame":{"x":279,"y":740,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":40,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"orc.png","frame":{"x":150,"y":591,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"padded_armour.png","frame":{"x":194,"y":100,"w":48,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":48,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"plate_armour.png","frame":{"x":345,"y":51,"w":48,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":48,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"platinum_coins.png","frame":{"x":1,"y":445,"w":48,"h":49},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"poleaxe.png","frame":{"x":1,"y":496,"w":48,"h":49},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"portal.png","frame":{"x":1,"y":195,"w":91,"h":95},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":91,"h":95},"sourceSize":{"w":96,"h":96}},{"filename":"rat-dead00.png","frame":{"x":423,"y":669,"w":45,"h":35},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":13,"w":45,"h":35},"sourceSize":{"w":48,"h":48}},{"filename":"rat-idle00.png","frame":{"x":193,"y":274,"w":48,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":7,"w":48,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"rat-idle01.png","frame":{"x":243,"y":282,"w":48,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":6,"w":48,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-e00.png","frame":{"x":293,"y":286,"w":48,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-n00.png","frame":{"x":412,"y":758,"w":39,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":6,"w":39,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-s00.png","frame":{"x":193,"y":972,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-w00.png","frame":{"x":343,"y":291,"w":48,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"rat.png","frame":{"x":393,"y":292,"w":48,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":7,"w":48,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"red_crystal.png","frame":{"x":150,"y":809,"w":42,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":47},"sourceSize":{"w":48,"h":49}},{"filename":"red_flask.png","frame":{"x":273,"y":983,"w":28,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":28,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"ring_mail_armour.png","frame":{"x":149,"y":990,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"RIP.png","frame":{"x":94,"y":245,"w":48,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":48,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"rusty_key.png","frame":{"x":299,"y":1083,"w":33,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":1,"w":33,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"scale_mail_armour.png","frame":{"x":331,"y":668,"w":44,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":3,"w":44,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"shield.png","frame":{"x":378,"y":622,"w":44,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":44,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"shortsword.png","frame":{"x":194,"y":413,"w":45,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":45,"h":46},"sourceSize":{"w":49,"h":48}},{"filename":"silver_coins.png","frame":{"x":240,"y":611,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":44,"h":47},"sourceSize":{"w":48,"h":49}},{"filename":"skull.png","frame":{"x":144,"y":245,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"slime-dead00.png","frame":{"x":51,"y":742,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"slime-idle00.png","frame":{"x":99,"y":145,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-idle01.png","frame":{"x":94,"y":195,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-idle02.png","frame":{"x":246,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-walk-e00.png","frame":{"x":151,"y":788,"w":48,"h":19},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":13,"w":48,"h":19},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-n00.png","frame":{"x":481,"y":338,"w":18,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":14,"y":0,"w":18,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-s00.png","frame":{"x":481,"y":389,"w":17,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":14,"y":0,"w":17,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-w00.png","frame":{"x":193,"y":1018,"w":48,"h":19},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":13,"w":48,"h":19},"sourceSize":{"w":48,"h":49}},{"filename":"slime.png","frame":{"x":241,"y":419,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"spell.png","frame":{"x":241,"y":790,"w":42,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"spider-dead00.png","frame":{"x":101,"y":1091,"w":46,"h":38},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":5,"w":46,"h":38},"sourceSize":{"w":48,"h":48}},{"filename":"spider-idle00.png","frame":{"x":369,"y":712,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"spider-idle01.png","frame":{"x":377,"y":669,"w":44,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"spider-idle02.png","frame":{"x":424,"y":626,"w":44,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"spider-idle03.png","frame":{"x":366,"y":754,"w":44,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"spider-walk-e00.png","frame":{"x":362,"y":886,"w":40,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":40,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"spider-walk-n00.png","frame":{"x":320,"y":793,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"spider-walk-s00.png","frame":{"x":369,"y":712,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"spider-walk-w00.png","frame":{"x":267,"y":890,"w":40,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":40,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"spider.png","frame":{"x":369,"y":712,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"studded_leather_armour.png","frame":{"x":443,"y":294,"w":48,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":48,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"tomb_of_elder.png","frame":{"x":51,"y":792,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader1-dead00.png","frame":{"x":297,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"trader1-idle00.png","frame":{"x":244,"y":100,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader1-idle01.png","frame":{"x":51,"y":842,"w":48,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":48,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"trader1-walk-e00.png","frame":{"x":294,"y":100,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader1-walk-n00.png","frame":{"x":344,"y":100,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader1-walk-s00.png","frame":{"x":394,"y":151,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader1-walk-w00.png","frame":{"x":444,"y":151,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader1.png","frame":{"x":345,"y":244,"w":47,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":3,"w":47,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader2-dead00.png","frame":{"x":348,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"trader2-idle00.png","frame":{"x":194,"y":196,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader2-idle01.png","frame":{"x":51,"y":892,"w":48,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":48,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"trader2-walk-e00.png","frame":{"x":244,"y":197,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader2-walk-n00.png","frame":{"x":294,"y":197,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader2-walk-s00.png","frame":{"x":344,"y":197,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader2-walk-w00.png","frame":{"x":394,"y":198,"w":48,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":48,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trader2.png","frame":{"x":394,"y":245,"w":47,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":3,"w":47,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"trapdoor-dead00.png","frame":{"x":470,"y":676,"w":34,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":9,"w":34,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"trapdoor-idle00.png","frame":{"x":474,"y":989,"w":30,"h":36},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":9,"w":30,"h":36},"sourceSize":{"w":48,"h":48}},{"filename":"trapdoor.png","frame":{"x":474,"y":989,"w":30,"h":36},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":9,"w":30,"h":36},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox00.png","frame":{"x":289,"y":425,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox01.png","frame":{"x":337,"y":430,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-guides00.png","frame":{"x":385,"y":430,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-guides01.png","frame":{"x":433,"y":434,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-hall-of-fame00.png","frame":{"x":240,"y":467,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-hall-of-fame01.png","frame":{"x":288,"y":473,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play00.png","frame":{"x":336,"y":478,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play01.png","frame":{"x":384,"y":478,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings00.png","frame":{"x":432,"y":482,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings01.png","frame":{"x":240,"y":515,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down00.png","frame":{"x":288,"y":521,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down01.png","frame":{"x":240,"y":563,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left00.png","frame":{"x":336,"y":526,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left01.png","frame":{"x":384,"y":526,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right00.png","frame":{"x":288,"y":569,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right01.png","frame":{"x":432,"y":530,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up00.png","frame":{"x":336,"y":574,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up01.png","frame":{"x":384,"y":574,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"undefined.png","frame":{"x":267,"y":1039,"w":28,"h":43},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":3,"w":28,"h":43},"sourceSize":{"w":48,"h":49}},{"filename":"wall-B.png","frame":{"x":51,"y":942,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BL.png","frame":{"x":297,"y":1033,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BLI.png","frame":{"x":51,"y":992,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BR.png","frame":{"x":470,"y":626,"w":34,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":34,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BRI.png","frame":{"x":51,"y":1042,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BTEE.png","frame":{"x":395,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-HI.png","frame":{"x":445,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-L.png","frame":{"x":332,"y":1032,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-LTEE.png","frame":{"x":334,"y":1082,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-R.png","frame":{"x":369,"y":987,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-RTEE.png","frame":{"x":404,"y":988,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-T.png","frame":{"x":150,"y":146,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TL.png","frame":{"x":439,"y":989,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TLI.png","frame":{"x":244,"y":147,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TR.png","frame":{"x":369,"y":1069,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TRI.png","frame":{"x":294,"y":147,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TTEE.png","frame":{"x":344,"y":147,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-VI.png","frame":{"x":394,"y":101,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-XI.png","frame":{"x":444,"y":101,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-B.png","frame":{"x":101,"y":643,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-HI.png","frame":{"x":101,"y":693,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-T.png","frame":{"x":101,"y":743,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"warhammer.png","frame":{"x":443,"y":245,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"waterskin.png","frame":{"x":194,"y":838,"w":42,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":2,"w":42,"h":47},"sourceSize":{"w":49,"h":49}}],"meta":{"app":"https://www.codeandweb.com/texturepacker","version":"1.0","image":"dungeon.png","format":"RGBA8888","size":{"w":505,"h":1131},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:37023dc90710a0ab1954b41f9da7fbfd:eed4a63a174bf1f866f2aa869453a339:9c0fba27a8a0c106083a8713f6c67b32$"}}');var iL={};iL=new URL("about.167275cc.md",import.meta.url).toString();var iM={};iM=new URL("armour.544d9006.txt",import.meta.url).toString();var iD={};iD=new URL("artefacts.296ca47c.txt",import.meta.url).toString();var ib={};ib=new URL("magic.df81064f.txt",import.meta.url).toString();var i_={};i_=new URL("monsters.d1245abf.txt",import.meta.url).toString();var iz={};iz=new URL("heroes.9f8aeff2.txt",import.meta.url).toString();var iB={};iB=new URL("money.8a4afea3.txt",import.meta.url).toString();var iG={};iG=new URL("traders.1d8d82a4.txt",import.meta.url).toString();var ik={};ik=new URL("weapons.326b8112.txt",import.meta.url).toString();var iU={};iU=new URL("keys.f3b71340.txt",import.meta.url).toString();var iH={};iH=new URL("traps.372f7cd1.txt",import.meta.url).toString();var iF={};iF=new URL("objectives.db6c512b.txt",import.meta.url).toString();var i$={};i$=new URL("dungeon-completed.6e49dc4f.md",import.meta.url).toString();var iW={};iW=new URL("dungeon_script.34f994bb.txt",import.meta.url).toString();var iV={};iV=new URL("dungeon-welcome.97ed0392.md",import.meta.url).toString();var iK={};iK=new URL("dungeon-welcome-casual.d4a9c126.md",import.meta.url).toString();var iY={};iY=new URL("help.29d4aacb.md",import.meta.url).toString();var iX={};iX=new URL("do-alto-do-trono-da-desolacao-trimmed.18cbfbbb.mp3",import.meta.url).toString();var iq={};iq=new URL("privacy.9596e717.md",import.meta.url).toString();var ij={};ij=new URL("startupTips.5db37e5a.md",import.meta.url).toString();var iZ={};iZ=new URL("quickStart.c5e1f66a.md",import.meta.url).toString();var iJ={};iJ=new URL("punch-trimmed.d5ee82fe.mp3",import.meta.url).toString();var iQ={};iQ=new URL("punch-trimmed-double.7756f095.mp3",import.meta.url).toString();var i4={};i4=new URL("long-medium-swish-trimmed.69cad07b.mp3",import.meta.url).toString();var i0={};i0=new URL("bubbling-trimmed.361718fa.mp3",import.meta.url).toString();var i1={};i1=new URL("male-hurt-sound-trimmed.76fa38ed.mp3",import.meta.url).toString();var i8={};i8=new URL("pig-oink-47167.4d796935.mp3",import.meta.url).toString();var i3={};i3=new URL("squeal-thing-103111.d7f21093.mp3",import.meta.url).toString();var i2={};i2=new URL("metal-blade-slice-32-195321.f9effd4c.mp3",import.meta.url).toString();var i9={};i9=new URL("click-and-crawl.10b21974.png",import.meta.url).toString();const i6={ABOUT_MD:new URL(iL),ALMANAC_MAP:new Map([["ARMOUR",new URL(iM)],["ARTEFACTS",new URL(iD)],["MAGIC",new URL(ib)],["ENEMIES",new URL(i_)],["HEROES",new URL(iz)],["MONEY",new URL(iB)],["TRADERS",new URL(iG)],["WEAPONS",new URL(ik)],["KEYS",new URL(iU)],["TRAPS",new URL(iH)],["OBJECTIVES",new URL(iF)]]),DUNGEON_COMPLETE:new URL(i$),DUNGEON_SCRIPT:new URL(iW),DUNGEON_WELCOME:new URL(iV),DUNGEON_WELCOME_CASUAL:new URL(iK),HELP_MD:new URL(iY),MUSIC:new URL(iX),PRIVACY_MD:new URL(iq),STARTUP_TIPS_MD:new URL(ij),QUICK_START_MD:new URL(iZ),SOUND_EFFECTS_MAP:new Map([["PUNCH",new URL(iJ)],["DOUBLE PUNCH",new URL(iQ)],["MISS",new URL(i4)],["POISONED",new URL(i0)],["DIE",new URL(i1)],["DIE_MONSTER",new URL(i8)],["DIE_MONSTER_SMALL",new URL(i3)],["TRIGGER TRAP",new URL(i2)]]),SPLASH_IMAGE:new URL(i9)};var i5={};i5=new URL("dungeon.63a56163.png",import.meta.url).toString();const i7={data:(p=iP)&&p.__esModule?p.default:p,textureUrl:new URL(i5)};function re(e,t={}){return tI(e).then(i=>{let r,a;if(i){var n,s;iw.clear(),s=iI(s=i.replaceAll(/\r/g,""),iR),n?.pre&&(s=iI(s,n.pre)),s=iI(s,iO),s=iI(s,ix),s=iI(s,iT),s=iI(s,iy),s=iI(s,iA),s=iI(s,iC),n?.post&&(s=iI(s,n.post)),r=iw.reinstate(s)}else a=ej`MESSAGE CANNOT LOAD URL ${e.toString()}`;let o=eX("div",{className:"parsed-markdown",text:a,html:r});return e3.showControlsDialog(o,{actionButtons:t.actionButtons,row:!0,okButtonLabel:t.okButtonLabel})})}const rt={MAIN_MENU:0,CLICKED_FREE_GROUND:1,CLICKED_ENTRANCE:2,CLICKED_EXIT:3};let ri=!0;class rr{#e3;#F;#tX;#eZ;#tq;#tj;constructor(e,t,i,r){this.#e3=e,this.#eZ=t,this.#tq=i,this.#tj=r}#tZ(e){if(this.#e3.moveType===am.HUNT){if(this.#tj)return e;{let t=this.#eZ.worldPointToGrid(i.position);if(e.getOrthoSeparation(t)-1<=1.5*this.#e3.getMaxTilesPerMove())return this.#eZ.worldPointToGrid(i.position)}}return this.#tJ(e,this.#e3.getMaxTilesPerMove())}moveInstantly(){this.#tX=v.copy(this.#e3.position);let e=this.#eZ.worldPointToGrid(this.#e3.position),t=this.#tZ(e);if(!t.coincident(e)){this.#tq.actor=this.#e3;let i=this.#tq.getDumbRouteNextTo(e,t,this.#e3.getMaxTilesPerMove());i.length>0&&(this.#F=new eL({path:i,speed:100},this.#e3.sprite.modifier),this.#tQ(i[i.length-1]))}}#tJ(e,t){let i=x(e.x-t,e.x+t),r=x(e.y-t,e.y+t),a=this.#eZ.getDimsInTiles();return new C(E(i,0,a.width-1),E(r,0,a.height-1))}#tQ(e){let t=this.#eZ.worldPointToGrid(this.#e3.position);this.#e3.position=e;let i=this.#eZ.worldPointToGrid(this.#e3.position);this.#eZ.moveTileOccupancyGridPoint(this.#e3,t,i)}#t4(){this.#tQ(this.#tX)}replay(){return(this.#t4(),this.#F)?(this.#t0(),this.#F.applyAsTransientToSprite(this.#e3.sprite)):Promise.resolve()}#t0(){if(this.#e3.isOrganic()){let e=il(this.#e3.almanacEntry);e.position=this.#tX,e.freezeMovement(),eo.addActor(e)}}}class ra{#eZ;#tq;#t1;#tj;constructor(e,t,i){this.#t1=[],this.#eZ=e,this.#tq=t,this.#tj=i}addAndMoveActor(e){if(0===e.getMaxTilesPerMove())return;let t=new rr(e,this.#eZ,this.#tq,this.#tj);t.moveInstantly(),this.#t1.push(t)}replay(){let e=[];return this.#t1.forEach(t=>e.push(t.replay())),Promise.all(e)}}class rn{constructor(){}async transitionTo(e){await this.onExit().then(()=>(rR=e,e.onEntry()))}onEntry(){return Promise.resolve()}onEvent(e){return Promise.resolve(null)}onExit(){return Promise.resolve(null)}}class rs extends rn{onEntry(){return(function(){let e=new e$({leftLabel:ej`BUTTON PLAY ADVENTURE`,imageName:"ui-play00.png",internalLabel:!0,closes:"PLAY ADVENTURE"}),t=new e$({leftLabel:ej`BUTTON PLAY CASUAL`,imageName:"ui-play00.png",internalLabel:!0,closes:"PLAY CASUAL"}),i=new e$({leftLabel:ej`BUTTON SETTINGS`,imageName:"ui-settings00.png",internalLabel:!0,action:()=>t2()}),r=new e$({leftLabel:ej`BUTTON HALL OF FAME`,imageName:"ui-hall-of-fame00.png",internalLabel:!0,action:()=>(function(){let e=eX("div",{className:"best-adventure"}),t=ip().getCurrentData();if(0===t.length)e.appendChild(eX("p",{text:ej`MESSAGE NO SAVED ADVENTURE`}));else{let i=document.createElement("ul");for(let r of(e.appendChild(i),t))i.appendChild(eX("li",{text:function(e){let t=new Date(e.adventureStartTime).toISOString().split("T")[0],i=e.class?.toLowerCase()??"";return ej`MESSAGE HALL OF FAME ENTRY ${e.name} ${e.characterLevel} ${i} ${t} ${e.gold} ${e.dungeonFloor}`}(r)}))}return e3.showElementOkDialog(ej`DIALOG TITLE HALL OF FAME`,e)})()}),a=new e$({leftLabel:ej`BUTTON GUIDES`,imageName:"ui-guides00.png",internalLabel:!0,action:()=>(function(){let e=new eF({label:ej`BUTTON ABOUT`,action:()=>re(i6.ABOUT_MD)}),t=new eF({label:ej`BUTTON HELP`,action:()=>re(i6.HELP_MD)}),i=new eF({label:ej`BUTTON PRIVACY`,action:()=>re(i6.PRIVACY_MD)});return re(i6.QUICK_START_MD,{actionButtons:[t,e,i]})})()});return e3.showControlsDialog(ej`MENU TITLE MAIN`,{actionButtons:[a,i,r,e,t],className:"door"})})().then(async e=>{ri="PLAY CASUAL"!==e,await this.transitionTo(new ro)})}}class ro extends rn{onEntry(){return f.debug("Enter AtStart"),this.#t8().then(()=>this.#t3()).then(e=>{let t=i.traits.get("NAME");return e?e3.showOkDialog(ej`MESSAGE DUNGEON INTRO CONTINUE ${t}`,{okButtonLabel:ej`BUTTON ENTER DUNGEON`,className:"wall"}).then(()=>r9(i)):re(ri?i6.DUNGEON_WELCOME:i6.DUNGEON_WELCOME_CASUAL,{okButtonLabel:ej`BUTTON ENTER DUNGEON`})}).then(()=>{i.sprite.position=eo.getTileMap().getWorldPositionOfTileByEntry()}).then(()=>{let e=rW.getCurrentSceneIntro();return e?e3.showOkDialog(e,{className:"mask"}):void 0}).then(()=>rR.transitionTo(new rc))}#t3(){let e=ri?function(){let e=eU.get("GAME_STATE",null,ig);if(!e){f.debug("No saved game state to restore.");return}if(!e.hero.alive){f.debug("Last hero state was dead, so not restoring.");return}if(e.completed){f.debug("Last game was completed, so not restoring.");return}return{hero:e.hero,sceneLevel:e.sceneLevel}}():null;return e?rW.continueFromSavedScene(e.sceneLevel,e.hero).then(()=>!0):rW.switchToFirstScene().then(()=>!1)}#t8(){if(!eU.get("SHOW_QUICK_TIPS_AT_START",!0))return Promise.resolve();let e=new eF({label:ej`BUTTON OK`,closes:"OK"}),t=new eF({label:ej`BUTTON DO NOT SHOW AGAIN`,closes:"NOT AGAIN"});return re(i6.STARTUP_TIPS_MD,{actionButtons:[e,t]}).then(e=>{"NOT AGAIN"===e&&eU.set("SHOW_QUICK_TIPS_AT_START",!1)})}}class rl extends rn{async onEntry(){f.debug("Enter AtGameOver"),ri&&im(i),ez("YOU DIED!",{delaySecs:1,lifetimeSecs:2,position:i.position,velocity:new I(0,-100,0)}),await new Promise(e=>{setTimeout(()=>e(),2e3)}).then(()=>e3.showOkDialog(ej`MESSAGE DEFEAT`,{okButtonLabel:ej`BUTTON TRY AGAIN`})).then(()=>rW.unloadCurrentScene()).then(()=>this.transitionTo(new rs))}}class rh extends rn{async onEntry(){f.debug("Enter AtGameCompleted"),await re(i6.DUNGEON_COMPLETE,{okButtonLabel:ej`BUTTON TRY AGAIN`}).then(()=>rW.unloadCurrentScene()).then(()=>this.transitionTo(new rs))}}class rc extends rn{constructor(){super()}async onEntry(){await super.onEntry(),f.debug("Enter HeroTurnIdle"),await rf(),await rm()&&await this.transitionTo(new rl)}async onEvent(e,t,r={}){switch(e){case rt.CLICKED_FREE_GROUND:{let e=await rA(r.filter,r.occupant);e===t4.INTERACT_TILE?await rw(t):e===t4.OCCUPIED_TILE?await ry(r.occupant):await rg(t,{usePathFinder:r.filter!==t4.MOVE_OR_INTERACT_TILE}),r.occupant?.isObjective()&&e===t4.INTERACT_TILE?await rE():0===i.traits.get("HP",0)?await this.transitionTo(new rl):await this.transitionTo(new rd)}break;case rt.CLICKED_ENTRANCE:await e3.showOkDialog(ej`MESSAGE ENTRANCE STUCK`);break;case rt.CLICKED_EXIT:f.debug("Escaping"),await rx()&&await rg(t,{usePathFinder:!1}).then(()=>rT(this))}return Promise.resolve(null)}}class ru extends rn{constructor(){super()}async onEntry(){await super.onEntry(),f.debug("Enter HeroTurnInteracting"),await rf(),await rm()&&await this.transitionTo(new rl)}async onEvent(e,t,r={}){switch(e){case rt.CLICKED_FREE_GROUND:{let e=await rA(r.filter,r.occupant);e===t4.INTERACT_TILE?await rw(t):e===t4.OCCUPIED_TILE?await ry(r.occupant):await this.#t2(t,{usePathFinder:r.filter!==t4.MOVE_OR_INTERACT_TILE}),r.occupant?.isObjective()&&e===t4.INTERACT_TILE?await rE():0===i.traits.get("HP",0)?await this.transitionTo(new rl):0===eo.getTileMap().getParticipants(i).length?await this.transitionTo(new rd):await this.transitionTo(new rp)}break;case rt.CLICKED_ENTRANCE:e3.showOkDialog(ej`MESSAGE ENTRANCE STUCK`);break;case rt.CLICKED_EXIT:await rx()&&await this.#t2(t,{usePathFinder:!1}).then(()=>rT(this))}return Promise.resolve(null)}#t2(e,t={usePathFinder:!0}){let r=eo.getTileMap(),a=r.getParticipants(i),n=!1;for(let e of a)if(e.alive&&e.interaction.respectDisengage(i)){n=!0;break}let s=r.worldPointToGrid(i.position),o=r.worldPointToGrid(e),l=s.getOrthoSeparation(o);return n&&l<=2&&(i.disengaging=!0),rg(e,t).then(()=>!0)}}class rd extends rn{constructor(){super()}async onEntry(){await super.onEntry(),f.debug("Enter ComputerTurnIdle"),await rS();let e=eo.getTileMap(),t=new tZ(e),r=new ra(e,t,i.disengaging);for(let e of eo.getActors().values())e!==i&&e.alive&&(!e.isWandering()||te(6)>3)&&r.addAndMoveActor(e);for(let e of eo.getOrganicActors().values())e.alive&&r.addAndMoveActor(e);for(let t of(await r.replay(),e.getParticipants(i)))if(t.isEnemy())return await this.transitionTo(new ru),Promise.resolve(null);await this.transitionTo(new rc)}}class rp extends rn{constructor(){super()}async onEntry(){await super.onEntry(),await rS();let e=eo.getTileMap(),t=new tZ(e),r=new ra(e,t,i.disengaging),a=e.getParticipants(i);for(let e of eo.getActors().values())e!==i&&e.alive&&e.interaction&&(a.includes(e)&&e.willInteract()?await e.interaction.enact(i):r.addAndMoveActor(e));for(let e of eo.getOrganicActors().values())e.alive&&r.addAndMoveActor(e);return await r.replay(),0===i.traits.get("HP",0)?await this.transitionTo(new rl):0===a.length?await this.transitionTo(new rc):await this.transitionTo(new ru),Promise.resolve(null)}}function rf(){i.disengaging=!1;let e=eo.getTileMap(),t=new tZ(e,i).getAllRoutesFrom(e.worldPointToGrid(i.sprite.position),i.getMaxTilesPerMove());return e.setMovementRoutes(t),e.setInteractActors(e.getParticipants(i)),e.calcReachableDoors(i.position),Promise.resolve(null)}function rm(){return!!i.toxify?.isActive&&(i.toxify.enact(i),0>=i.traits.getInt("HP",0))}function rg(e,t={usePathFinder:!0}){let r;let a=eo.getTileMap();return(r=t.usePathFinder?a.getWaypointsToWorldPoint(e):[i.position,e],a.setMovementRoutes(null),a.setInteractActors(null),r)?new eL({path:r,speed:100},i.sprite.modifier).applyAsTransientToSprite(i.sprite):Promise.resolve()}function rS(){let e=eo.getTileMap(),t=[];return eo.getOrganicActors().forEach(i=>{e.getCoincidentActors(i).forEach(e=>{e.alive&&!e.isOrganic()&&i.interaction&&t.push(i.interaction.enact(e))})}),Promise.all(t)}function rw(e){let t=eo.getTileMap().getTileAtWorldPoint(e).getOccupants(),r=[];for(let e of t.values())e.interaction&&r.push(e.interaction.react(i));return Promise.all(r)}function rE(){return i.traits.clearTransientFxTraits(),ri&&im(i,!0),rR.transitionTo(new rh)}function rT(e){return(i.traits.clearTransientFxTraits(),ri&&im(i),rW.areThereMoreScenes())?rW.unloadCurrentScene().then(()=>r9(i)).then(()=>rW.switchToNextScene()).then(e=>(i.sprite.position=eo.getTileMap().getWorldPositionOfTileByEntry(),e)).then(e=>e.intro?e3.showOkDialog(e.intro,{className:"wall"}):void 0).then(()=>e.transitionTo(new rc)):e.transitionTo(new rh)}function ry(e){return e?e.isHiddenArtefact()?e3.showOkDialog(e.description):r3(e,{allowConsumption:e.isHero(),allowMagicUse:e.isHero()}):(f.error("Clicked on tile but no occupant to view."),Promise.resolve())}function rA(e,t){if(e===t4.MOVE_OR_INTERACT_TILE){if(t?.isHiddenArtefact()){let e=t.storeManager.getFirstStorageDetails(),i=e?.artefact;if(t.alive&&i)return t4.INTERACT_TILE;if(!t.alive&&!i)return t4.MOVEMENT_TILE}return e3.showChoiceDialog(ej`DIALOG TITLE CHOICES`,ej`MESSAGE SEARCH OR MOVE`,[ej`BUTTON CLIMB OVER`,ej`BUTTON SEARCH`]).then(e=>0===e?t4.MOVEMENT_TILE:t4.INTERACT_TILE)}return e}function rx(){return r?i.storeManager.discard(r,!0)?e3.showOkDialog(ej`MESSAGE KEY UNLOCKS EXIT`).then(()=>!0):e3.showOkDialog(ej`MESSAGE EXIT LOCKED`).then(()=>!1):Promise.resolve(!0)}let rR=new class extends rn{onEntry(){f.debug("WaitingToStart state")}async onEvent(e,t,i){if(e!==rt.MAIN_MENU)return Promise.resolve();await this.transitionTo(new rs)}},rO=!1;var rC={EventId:rt,getHeroActor:function(){return i},setHero:function(e){i=e},triggerEvent:function(e,t,i){if(rO){f.debug(`Ignoring event ${e} as still processing earlier event.`);return}rO=!0,rR.onEvent(e,t,i).then(()=>{rO=!1})},setExitKeyArtefact:function(e){r=e}};function rI(e){return{role:t0.GROUND,onClick:(e,t,i)=>rC.triggerEvent(rC.EventId.CLICKED_FREE_GROUND,t,i),image:e}}function rN(e){return{role:t0.ENTRANCE,onClick:(e,t,i)=>rC.triggerEvent(rC.EventId.CLICKED_ENTRANCE,t,i),image:e}}function rv(e){return{role:t0.EXIT,onClick:(e,t,i)=>rC.triggerEvent(rC.EventId.CLICKED_EXIT,t,i),image:e}}const rP=new Map([["x",{role:t0.OBSTACLE,image:"block.png"}],["#-TL",{role:t0.OBSTACLE,image:"wall-TL.png"}],["#-TLI",{role:t0.OBSTACLE,image:"wall-TLI.png"}],["#-T",{role:t0.OBSTACLE,image:"wall-T.png"}],["*-T",{role:t0.OBSTACLE,image:"wall2-T.png"}],["#-TR",{role:t0.OBSTACLE,image:"wall-TR.png"}],["#-TRI",{role:t0.OBSTACLE,image:"wall-TRI.png"}],["#-R",{role:t0.OBSTACLE,image:"wall-R.png"}],["#-BR",{role:t0.OBSTACLE,image:"wall-BR.png"}],["#-BRI",{role:t0.OBSTACLE,image:"wall-BRI.png"}],["#-B",{role:t0.OBSTACLE,image:"wall-B.png"}],["*-B",{role:t0.OBSTACLE,image:"wall2-B.png"}],["#-BL",{role:t0.OBSTACLE,image:"wall-BL.png"}],["#-BLI",{role:t0.OBSTACLE,image:"wall-BLI.png"}],["#-L",{role:t0.OBSTACLE,image:"wall-L.png"}],["#-XI",{role:t0.OBSTACLE,image:"wall-XI.png"}],["#-VI",{role:t0.OBSTACLE,image:"wall-VI.png"}],["#-HI",{role:t0.OBSTACLE,image:"wall-HI.png"}],["#-TTEE",{role:t0.OBSTACLE,image:"wall-TTEE.png"}],["#-RTEE",{role:t0.OBSTACLE,image:"wall-RTEE.png"}],["#-BTEE",{role:t0.OBSTACLE,image:"wall-BTEE.png"}],["#-LTEE",{role:t0.OBSTACLE,image:"wall-LTEE.png"}],["#",{role:t0.OBSTACLE,image:"block.png"}],["=-T",rv("door-T.png")],[">-T",rv("door2-T.png")],["=-R",rv("door-R.png")],["=-B",rv("door-B.png")],[">-B",rv("door2-B.png")],["=-L",rv("door-L.png")],["--T",rN("door-T.png")],["~-T",rN("door2-T.png")],["--R",rN("door-R.png")],["--B",rN("door-B.png")],["~-B",rN("door2-B.png")],["--L",rN("door-L.png")],["=",{role:t0.OBSTACLE,image:"block.png"}],["-",{role:t0.OBSTACLE,image:"block.png"}],[".",rI("floor.png")],[".-SBW",rI("floor-SBW.png")],[".-SBE",rI("floor-SBE.png")],[",-SBE",rI("floor2-SBE.png")],[",-SBW",rI("floor2-SBW.png")],[",",rI("floor2.png")]]);class rL{#t9;#X;#t6;#t5;#t7;heroActor;intro;constructor(e=2,t=2){e>0?(this.#t9=0,this.#X=1/e):this.#X=1,this.#t6=e,this.#t5=t}getOpacity(){return this.#t9}load(){return this.doLoad()}initialise(){return this.doInitialise()}update(e){J.clearCanvas(),J.setOpacity(this.#t9),eo.update(e),this.doUpdate(e),J.setOpacity(1),0!==this.#X&&(this.#t9+=e*this.#X,this.#t9>1?(this.#X=0,this.#t9=1):this.#t9<0&&(this.#X=0,this.#t9=0)),this.#t7&&0===this.#t9&&(this.#t7(),this.#t7=null)}unload(){return this.#ie().then(()=>this.doUnload())}#ie(){return this.#t5>0?(this.#X=-1/this.#t5,new Promise(e=>{this.#t7=e})):Promise.resolve()}doLoad(){return Promise.resolve()}doInitialise(){return Promise.resolve()}doUpdate(e){return Promise.resolve()}doUnload(){return Promise.resolve()}}const rM=eG.TILE_SIZE;function rD(e,t){let i,r;switch(e.type){case tb.SPELL:case tb.CANTRIP:i="engraved_pillar",r=ap.PROP;break;default:{let e=te(6);i=e<3?"hidden_artefact":e<5?"trapdoor":"manhole_cover"}r=ap.HIDDEN_ARTEFACT}let a=il({id:i,name:tO(i),description:tC(i),imageName:i,type:r,traitsString:""}),n=t??tM(e);return a.storeManager.addArtefact(n),a}function rb(e,t,i){if(t){let r=tM(t);i.equip&&r.equipStoreType?e.storeManager?.equip(r,{direct:!0}):e.storeManager?.stash(r,{direct:!0})}}class r_ extends rL{#it;constructor(e){super(),this.#it=e,this.intro=e.intro}doLoad(){return Promise.resolve()}doInitialise(){var e;let t=tW.generateTileMapPlan(this.#it.mapDesign,rP);this.heroActor=function(e){if(e.hero instanceof ag)a=e.hero;else if(e.hero)a=il(e.hero);else if(!a)throw Error("No hero has been defined.");return a}(this.#it);let i=new t8(J.getContext2D(),t,rM,this.heroActor);eo.setTileMap(i);let r=(e=this.#it).objective?il(e.objective):null;if(r){let e=i.getRandomFreeGroundTile();e?(r.position=e.worldPoint,eo.addArtefact(r)):(f.debug("No free tiles for objective."),r=null)}let n=tL.getRandomEntry("KEYS"),s=r||te(6)>3?tM(n):null,o=!r&&s?1:0,l=tL.getPooledAlmanac(["ARTEFACTS","ARMOUR","WEAPONS"],e=>e.minLevel<=rW.getCurrentSceneLevel()),h=l.find(e=>"waterskin"===e.id),c=l.find(e=>"iron_rations"===e.id);for(let e of function(e){let t=[];return e.enemies.forEach(e=>{let i=il(e);t.push(i)}),t}(this.#it)){let t=i.getRandomFreeGroundTile();if(!t){f.debug("No free tiles for enemy.");break}if(e.position=t.worldPoint,eo.addActor(e),e.isTrader()){e.traits.exceedAbilitiesAndExp?.(this.heroActor.traits,1);let t=7;te(6)>3&&(rb(e,h,{equip:!1}),t--),te(6)>3&&(rb(e,c,{equip:!1}),t--),function(e,t,i){for(;i.qty-- >0;)rb(e,t.getRandomEntry(),i)}(e,l,{qty:t,equip:!1})}else o&&!e.isOrganic()&&e.traits.get("HAS_KEYS")&&(e.storeManager.stash(s,{direct:!0}),o=0,f.debug("Added key to actor."))}if(o){let e=rD(n,s),t=i.getRandomFreeGroundTile();t&&(e.position=t.worldPoint,eo.addArtefact(e),o=0,f.debug("Added key as hidden object."))}for(let e of function(e){let t=[];return e.artefacts.forEach(e=>{let i=rD(e);t.push(i)}),t}(this.#it)){let t=i.getRandomFreeGroundTile();if(!t){f.debug("No free tile to add artefact.");break}e.position=t.worldPoint,eo.addArtefact(e)}return rW.setCameraToTrack(this.heroActor.sprite,200,0),eo.addActor(this.heroActor),rC.setHero(this.heroActor),o>0?rC.setExitKeyArtefact(null):rC.setExitKeyArtefact(s),Promise.resolve()}doUpdate(e){}doUnload(){return Promise.resolve(null)}}const rz={OFF:0,HERO:1,VELOCITY:2};class rB{#ii;#ir;#ia;#is;constructor(e,t,i=0){let r=J.getCanvasDimensions(),a=i*Math.min(r.width,r.height);this.#ii=new eO,this.#ir=new eP({prey:e,speed:t,maxSeparation:a}),this.#ia=new ev,this.#ir.applyAsContinuousToSprite(this.#ii)}update(e){this.#is!==rz.OFF&&(this.#ii.update(e),J.centreCanvasOn(this.#ii.position))}setVelocity(e,t){this.setTrackingMethod(rz.VELOCITY),this.#ii.velocity.x=e,this.#ii.velocity.y=t}panBy(e,t){this.#ii.position.x+=e,this.#ii.position.y+=t,J.centreCanvasOn(this.#ii.position)}setTrackingMethod(e){if(e!==this.#is)switch(this.#is=e,e){case rz.HERO:this.#ir.applyAsContinuousToSprite(this.#ii);break;case rz.VELOCITY:this.#ia.applyAsContinuousToSprite(this.#ii);break;case rz.OFF:break;default:f.error(`Attempt to set invalid tracking method of ${e} ignored.`)}}}const rG={TR:0,BR:1,BL:2,TL:3};class rk{#io;#il;#ih;constructor(e,t,i,r){this.#io=e,this.#ic(t,i,!1),this.#iu(t,r)}#iu(e,t){let i=new eS({prefix:"ui-settings",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:em.STOP}),r=ay.addButton(i,()=>t2()),a=this.#id(e,t,1);r.position.x=a.x,r.position.y=a.y}#id(e,t,i){let r=new C(0,0);switch(t){case rG.TL:r.x=i*e,r.y=i*e;break;case rG.TR:r.x=-i*e,r.y=i*e;break;case rG.BR:r.x=-i*e,r.y=-i*e;break;case rG.BL:r.x=i*e,r.y=-i*e}return r}#ic(e,t,i){let r=this.#id(e,t,i?2:1);this.#ip(r.x,r.y),i&&this.#im(r.x,r.y,e)}#ip(e,t){this.#ih=new eS({prefix:"hud-auto-centre",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:em.STOP}),this.#il=ay.addButton(this.#ih,()=>{this.setTrackingState(!0)},()=>{this.setTrackingState(!1)}),this.#il.position.x=e,this.#il.position.y=t,this.#il.actionClick(null)}setTrackingState(e){e?(this.#ih.setCurrentIndex(1),this.#io.setTrackingMethod(rz.HERO)):(this.#ih.setCurrentIndex(0),this.#io.setTrackingMethod(rz.OFF))}#im(e,t,i){let r=3*i;this.#ig("hud-arrow-up",e,t-i,()=>{this.setTrackingState(!1),this.#io.setVelocity(0,-r)},()=>this.#io.setTrackingMethod(rz.OFF)),this.#ig("hud-arrow-right",e+i,t,()=>{this.setTrackingState(!1),this.#io.setVelocity(r,0)},()=>this.#io.setTrackingMethod(rz.OFF)),this.#ig("hud-arrow-down",e,t+i,()=>{this.setTrackingState(!1),this.#io.setVelocity(0,r)},()=>this.#io.setTrackingMethod(rz.OFF)),this.#ig("hud-arrow-left",e-i,t,()=>{this.setTrackingState(!1),this.#io.setVelocity(-r,0)},()=>this.#io.setTrackingMethod(rz.OFF))}#ig(e,t,i,r,a){let n=new eS({prefix:e,startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:em.STOP}),s=ay.addMomentaryButton(n,r,a);s.position.x=t,s.position.y=i,n.setCurrentIndex(0)}}class rU{intro;hero;enemies;artefacts;mapDesign;objective;constructor(){this.hero=null,this.enemies=[],this.artefacts=[],this.mapDesign=[]}}function rH(e){return e?rF(o).then(()=>e.load().then(()=>e.initialise()).then(()=>{l=new rk(n,48,rG.BR,rG.BL),ay.setVisible(!0),o=e})).then(()=>e):(f.error("Attempt made to switch to the next scene when there are no more."),Promise.reject())}function rF(e){return e?e.unload().then(()=>(eo.clearAll(),o=null,l=null,ay.clear(),ay.setVisible(!1),Promise.resolve())):Promise.resolve(null)}function r$(){return new r_(s.getNext())}var rW={areThereMoreScenes:function(){return s.hasNext()},continueFromSavedScene:function(e,t){return s.restore(e,t),rH(r$())},getCurrentSceneLevel:function(){return s.getIndex()},getCurrentSceneIntro:function(){return s.intro},panCameraBy:function(e,t){n.panBy(e,t),n.setTrackingMethod(rz.OFF),l.setTrackingState(!1)},setCameraToTrack:function(e,t,i){n=new rB(e,t,i)},setSceneList:function(e){(s=e).reset()},switchToFirstScene:function(){return s.reset(),rH(r$())},switchToNextScene:function(){return rH(r$())},unloadCurrentScene:function(){return rF(o)},update:function(e){o?.update(e),n?.update(e)}};const rV={VIEW:0,SELL:1,PILLAGE:2,FIND:3},rK={CONTINUE:"continue",CONSUME:"consume",LEAVE:"leave",LEARN_SPELL:"learn",DISCARD:"discard",EQUIP:"equip",PREPARE_SPELL:"prepare",STASH:"stash",TAKE:"take",SELL:"sell",PILLAGE:"pillage",USE:"use"},rY={STANDARD:"standard",STASH_ONLY:"stash",SPELLS:"spells",MAGIC:"magic",READY_MAGIC:"ready magic",CANTRIPS:"cantrips"};class rX{#iS;#iw;#iE;linkedInventory;#iT;constructor(e,t={}){this.#iS=e,this.#iw=t,this.#iE=eX("div",{className:"stores"}),this.refresh()}get element(){return this.#iE}get actionButtons(){return this.#iT}refresh(e){let t=!0;if(this.#iT=[],!e&&this.linkedInventory&&this.linkedInventory.refresh(!0),this.#iE.replaceChildren(),(!this.#iS.currentOwner.isHero()||this.#iS.currentOwner.alive)&&this.#iy().forEach(e=>{let i=this.#iS.currentOwner.storeManager.getStoreContents(e.storeType);if(i){t=!1;let r=this.#iA(e.label,e.storeType,i);this.#iE.appendChild(r)}}),t){let e;e=this.#iS.currentOwner.isHero()&&!this.#iS.currentOwner.alive?ej`MESSAGE DEAD HERO HAS NO INVENTORY`:ej`MESSAGE NOTHING HERE`,this.#iE.appendChild(eX("p",{text:e}))}this.#iw.onRefresh&&this.#iw.onRefresh()}#iy(){let e;switch(this.#iw.limitation){case rY.SPELLS:e=[{label:ej`Prepared spells`,storeType:tD.PREPARED_SPELLS},{label:ej`Known spells`,storeType:tD.SPELLS}];break;case rY.MAGIC:e=[{label:ej`Cantrips`,storeType:tD.CANTRIPS},{label:ej`Prepared spells`,storeType:tD.PREPARED_SPELLS},{label:ej`Known spells`,storeType:tD.SPELLS}];break;case rY.READY_MAGIC:e=[{label:ej`Ready magic`,storeType:tD.PREPARED_SPELLS},{label:ej`Cantrips`,storeType:tD.CANTRIPS}];break;case rY.CANTRIPS:tD.CANTRIPS;break;case rY.STASH_ONLY:e=[this.#ix()];break;case rY.STANDARD:default:e=[{label:ej`Purse`,storeType:tD.PURSE},{label:ej`Head`,storeType:tD.HEAD},{label:ej`Body`,storeType:tD.BODY},{label:ej`Hands`,storeType:tD.HANDS},{label:ej`Feet`,storeType:tD.FEET},this.#ix()]}return e}#ix(){return this.#iS.currentOwner.isTrader()?{label:ej`Wagon`,storeType:tD.WAGON}:{label:ej`Backpack`,storeType:tD.BACKPACK}}#iA(e,t,i){let r=eX("div",{className:"store"});r.appendChild(eX("span",{className:"store-label",text:e}));let a=eX("div",{className:"store-contents"});return r.appendChild(a),[...i].sort((e,t)=>e.id<t.id).forEach(e=>{let i={...this.#iS};i.refresh=this.refresh.bind(this),i.storeType=t,i.artefact=e;let r=this.#iR(i);null!==r.closes&&void 0!==r.closes&&this.#iT.push(r),a.appendChild(r.element)}),r}#iR(e){let t,i;let r=function(e){let t=e.artefact.traits,i=t.get("NAME");if(e.showDamage){let r=t.getDamageDiceWhenCastBy?t.getDamageDiceWhenCastBy(e.currentOwner.traits):t.get("DMG"),a=t.get("RANGE");r&&(i=`${i} DMG: ${r}`),a&&(i=`${i} RANGE: ${a}`)}if(e.showPrice||e.artefact.artefactType===tb.COINS){let t=e.currentOwner.isTrader()?e.artefact.costInGp:e.artefact.sellBackPriceInGp;i=`${i} ${t.toFixed(2)} GP`}return i}(e);return e.customAction?(t=()=>e.customAction(e.currentOwner,e.artefact),i=eQ.OK):t=async()=>{await r2(e).then(()=>e.refresh?.())},new e$({rightLabel:r,imageName:e.artefact.iconImageName,action:t,closes:i})}}function rq(e,t,i){i>t.length&&f.error("Attempt being made to discard more items than provided in array.");for(let r=0;r<i&&r<t.length;r++)e.take(t[r])||f.error(`Trying to take artefact ${t[r]}, but none found.`)}function rj(e,t={}){let i=eX("div",{className:"inventory"}),r=eX("div",{className:"actor-container"});i.appendChild(r),r.appendChild(r1(e,{hideDescription:!0,hideTraits:!0}));let a=new rX({currentOwner:e,prospectiveOwner:e,allowMagicUse:t.allowMagicUse,allowConsumption:t.allowConsumption},{limitation:t.limitation,onRefresh:()=>r.replaceChildren(r1(e,{hideDescription:!0,hideTraits:!0}))});return i.appendChild(a.element),e3.showControlsDialog(i)}function rZ(e,t){if(t.artefact.artefactType===tb.COINS)return;let i=[];switch(t.artefact.artefactType){case tb.SPELL:i=function(e){let t=[],i=e.artefact;return e.allowMagicUse?f.error("Unexpected creation of Spell buttons with magic allowed. Use of Spells is handled by custom actions."):e.storeType===i.stashStoreType&&e.allowSpellPrep&&t.push(new eF({label:ej`BUTTON PREPARE SPELL`,closes:rK.PREPARE_SPELL})),e.allowSpellPrep&&t.push(new eF({label:ej`BUTTON FORGET`,closes:rK.DISCARD})),t}(t);break;case tb.CANTRIP:i=function(e){let t=[];return e.allowMagicUse&&f.error("Unexpected creation of Cantrip buttons with magic allowed. Use of Cantrips is handled by custom actions."),t.push(new eF({label:ej`Forget`,closes:rK.DISCARD})),t}(t);break;case tb.CONSUMABLE:i=function(e){let t=[];return rJ(e)&&t.push(new eF({label:rQ(e.artefact),closes:rK.CONSUME})),t.push(new eF({label:ej`BUTTON DISCARD`,closes:rK.DISCARD})),t}(t);break;case tb.KEY:i=[];break;default:i=function(e){let t=[];return rJ(e)?t.push(new eF({label:rQ(e.artefact),closes:rK.USE})):e.storeType===e.artefact.stashStoreType&&e.artefact.equipStoreType?t.push(new eF({label:ej`BUTTON EQUIP`,closes:rK.EQUIP})):e.storeType===e.artefact.equipStoreType&&(!e.artefact.stashInWagon||e.currentOwner.storeManager.hasWagon)&&t.push(new eF({label:ej`BUTTON STASH`,closes:rK.STASH})),t.push(new eF({label:e.artefact.isMagic()?ej`Forget`:ej`BUTTON DISCARD`,closes:rK.DISCARD})),t}(t)}return i.push(new eF({label:ej`BUTTON CONTINUE`,closes:rK.CONTINUE})),i}function rJ(e){let t=e.artefact;return!!t.isUsable()&&(t.isMagic()?e.allowMagicUse:t.isConsumable()?e.allowConsumption:void 0)}function rQ(e){switch(e.artefactType){case tb.CONSUMABLE:return ej`BUTTON CONSUME`;case tb.SPELL:case tb.CANTRIP:return ej`BUTTON CAST SPELL`;default:return ej`BUTTON USE`}}function r4(e){return eX("p",{className:"guidance",text:e.prospectiveOwner.isTrader()?ej`MESSAGE TRADER CANNOT STASH`:e.artefact.stashInWagon?ej`MESSAGE MAKE SPACE IN EQUIP`:ej`MESSAGE MAKE SPACE IN BACKPACK`})}function r0(e){let t=eX("div",{className:"actor-id-card"});t.appendChild(eW(e.iconImageName)),t.appendChild(eX("span",{text:e.traits?.get("NAME")??ej`Unknown`}));let i=e.traits.getInt("HP");if(i&&!e.traits.get("_HP")){let r;let a=e.traits.getInt("HP_MAX");r=0===i?ej`(DEAD)`:a?ej`(HP OUT OF VALUE) ${i} ${a}`:ej`(HP VALUE) ${i}`,t.appendChild(eX("span",{text:r}))}return e.traits.getCharacterLevel&&t.appendChild(eX("span",{text:ej`CHARACTER LEVEL: ${e.traits.getCharacterLevel()}`})),t}function r1(e,t={}){let i;let r=eX("div",{className:"actor-detail"}),a=r0(e);return r.appendChild(a),!t.hideDescription&&(e.artefactType||e.alive?t.description?i=t.description instanceof Element?t.description:eX("p",{text:t.description}):e.description&&(i=eX("p",{text:e.description})):i=function(e){let t;if(e.isHero()){let i=e.traits.get("NAME");t=ej`MESSAGE HERO EPITAPH FOR ${i}`}else t=ej`MESSAGE GENERIC EPITAPH`;return eX("p",{text:t})}(e)),i&&r.appendChild(i),t.hideTraits||r.appendChild(function(e,t,i){let r=document.createElement("ul");if(i){let t=e.storeManager?.getPurseValue();t&&r.appendChild(eX("li",{text:`${t.toFixed(2)}\u{00A0}GP`}))}return e.traits?.getAllTraitsSorted().forEach((i,a)=>{if(e.traits.hasEffective?.(a)){let t=e.traits.getEffectiveInt(a),r=R(i);if(t!==r){let e=t-r;i=`${t} [${r}${e<0?"-":"+"}${e}]`}}if(i&&"0"!==i){let e=Array.isArray(i)?i.join(", "):i;if(!t.includes(a)&&!a.startsWith("_")){let t=a?.replace("_"," "),i=document.createElement("li"),n=eX("span",{text:`${t}: `}),s=eX("span",{text:e});r.appendChild(i),i.appendChild(n),i.appendChild(s)}}}),r}(e,["NAME"],!0)),r}function r8(e,t,i){let r=eX("div",{className:"trade"}),a=eX("div",{className:"side-by-side"});r.appendChild(a);let n=eX("div",{}),s=eX("div",{});a.appendChild(n),a.appendChild(s),n.appendChild(r0(e)),s.appendChild(r0(t));let o=i?rV.PILLAGE:rV.SELL,l=new rX({currentOwner:e,prospectiveOwner:t,actionType:o,showPrice:!0}),h=new rX({currentOwner:t,prospectiveOwner:e,actionType:o,showPrice:!0},{limitation:i?rY.STANDARD:rY.STASH_ONLY});l.linkedInventory=h,h.linkedInventory=l,n.appendChild(l.element),s.appendChild(h.element);let c=new eF({label:ej`BUTTON CONTINUE`});c.closes=eQ.CANCEL;let u=[];return u.push(c),e3.showControlsDialog(r,{preamble:i?ej`DIALOG TITLE PILLAGE`:ej`DIALOG TITLE TRADE`,actionButtons:u})}function r3(e,t={}){let i,r;let a=document.createElement("div");a.appendChild(eX("span",{text:ej`Dungeon floor: ${ic(rW.getCurrentSceneLevel())}`}));let n=eX("div",{className:"actor-container"});a.appendChild(n);let s=r1(e,{hideTraits:!0,description:t.description});return n.appendChild(s),!e.isProp()&&(i=new eF({label:ej`BUTTON INVENTORY`,action:()=>rj(e,{allowConsumption:t.allowConsumption,allowMagicUse:t.allowMagicUse}).then(()=>n.replaceChildren(r1(e,{hideTraits:!0,description:t.description})))}),a.appendChild(i.element),i=new eF({label:ej`BUTTON TRAITS`,action:()=>(function(e){let t=document.createElement("div");return t.appendChild(r1(e,{hideDescription:!0})),e3.showControlsDialog(t)})(e)}),a.appendChild(i.element),i=new eF({label:ej`BUTTON MAGIC`,action:()=>rj(e,{allowMagicUse:!1,limitation:rY.MAGIC})}),a.appendChild(i.element),t.allowRest&&(i=new eF({label:ej`BUTTON REST`,action:()=>(function(e){let t=e.storeManager.getStore(tD.BACKPACK),i=[],r=[];t.values().forEach(e=>{if(e.artefactType===tb.CONSUMABLE){let t=e.traits.get("TYPE");"MEAL"===t?i.push(e):"DRINK"===t&&r.push(e)}});let a=document.createElement("div");a.appendChild(r0(e)),a.appendChild(eX("p",{text:ej`MESSAGE EXPLAIN REST`}));let n=[],s=-1,o=-1,l=function(e,t,i){let r={possible:!0,failure:tS.NONE},a={possible:!0,failure:tS.NONE},n=i.get("HIT_DICE","0D6");return!n||1>tr(n)?(r.possible=!1,r.failure=tS.NEED_LONG_REST):(e<1||t<1)&&(r.possible=!1,r.failure=tS.NEED_MORE_RATIONS),(e<3||t<3)&&(a.possible=!1,a.failure=tS.NEED_MORE_RATIONS),{shortRest:r,longRest:a}}(i.length,r.length,e.traits),h="";return l.shortRest.possible||(h=l.shortRest.failure===tS.NEED_LONG_REST?ej`MESSAGE CANNOT REST SHORT NEED LONG REST`:ej`MESSAGE CANNOT REST SHORT NEED RATIONS`,a.appendChild(eX("p",{text:h}))),l.longRest.possible||(h=ej`MESSAGE CANNOT REST LONG NEED RATIONS`,a.appendChild(eX("p",{text:h}))),l.shortRest.possible&&(s=n.length,n.push(ej`BUTTON REST SHORT`)),l.longRest.possible&&(o=n.length,n.push(ej`BUTTON REST LONG`)),n.push(ej`BUTTON CONTINUE`),e3.showChoiceDialog(ej`DIALOG TITLE CHOICES`,a,n).then(a=>{if(a===s){rq(t,i,1),rq(t,r,1);let a=tw(e,"SHORT");return e3.showOkDialog(ej`MESSAGE REST SHORT HP GAIN ${a.newHp-a.oldHp}`)}if(a===o){rq(t,i,3),rq(t,r,3);let a=tw(e,"LONG");return(function(e){let t=eX("div",{className:"inventory"});t.appendChild(r1(e,{hideDescription:!0,hideTraits:!0}));let i=new rX({currentOwner:e,prospectiveOwner:e,allowSpellPrep:!0},{limitation:rY.SPELLS});return t.appendChild(i.element),e3.showControlsDialog(t,{title:ej`DIALOG TITLE PREPARE SPELLS`,preamble:ej`MESSAGE EXPLAIN SPELL PREP`})})(e).then(()=>e3.showOkDialog(`MESSAGE REST LONG HP GAIN ${a.newHp-a.oldHp}`))}})})(e).then(()=>s.replaceWith(r1(e,{hideTraits:!0})))}),a.appendChild(i.element)),t.allowMagicUse&&(r=r??[],(i=new eF({label:ej`BUTTON CAST SPELL`})).closes="CAST SPELL",r.push(i))),r&&((i=new eF({label:ej`BUTTON CONTINUE`})).closes=eQ.CANCEL,r.push(i)),e3.showControlsDialog(a,{okButtonLabel:t.okButtonLabel,actionButtons:r}).then(t=>"CAST SPELL"===t?function(e){let t=eX("div",{className:"inventory"}),i=new rX({currentOwner:e,prospectiveOwner:e,allowMagicUse:!0,showDamage:!0,customAction:(e,t)=>(eJ.setAnimationState(!0),new Promise(i=>{setTimeout(()=>{t.interaction.react(e).then(()=>i())})}))},{limitation:rY.READY_MAGIC});t.appendChild(i.element);let r=new eF({label:ej`BUTTON CONTINUE`,closes:eQ.CANCEL});return e3.showControlsDialog(t,{title:ej`DIALOG TITLE PICK SPELL TO CAST`,actionButtons:[...i.actionButtons,r]})}(e):Promise.resolve())}function r2(e){e.prospectiveOwner||(e.prospectiveOwner=e.currentOwner);let t=e.currentOwner?.storeManager,i=e.prospectiveOwner.storeManager,r=e.artefact;return(function(e){let t=e.artefact,i=eX("div",{className:"use-weapon-dialog"});i.appendChild(r1(t,e));let r=function(e,t){if(t.currentOwner===t.prospectiveOwner||!t.prospectiveOwner)return rZ(e,t);switch(t.actionType){case rV.FIND:return function(e,t){let i;let r=[],a=t.prospectiveOwner.storeManager.findSuitableStore(t.artefact);if(a){let e,t;a.storeType===tD.CANTRIPS||a.storeType===tD.SPELLS||a.storeType===tD.READY_SPELLS?(e=ej`BUTTON LEARN SPELL`,t=rK.LEARN_SPELL):(e=ej`BUTTON TAKE ARTEFACT`,t=rK.TAKE),i=new eF({label:e,closes:t}),r.push(i)}else e.appendChild(r4(t));return i=new eF({label:ej`BUTTON LEAVE ARTEFACT`,closes:rK.LEAVE}),r.push(i),r}(e,t);case rV.SELL:return function(e,t){let i;if(t.artefact.artefactType===tb.COINS)return;let r=[],a=t.artefact.costInGp;if(i=t.prospectiveOwner.isTrader()?Number.MAX_SAFE_INTEGER:t.prospectiveOwner.storeManager.getPurseValue(),!t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)){e.appendChild(r4(t)),t.currentOwner.isTrader()||rZ(e,t);return}if(i<t.artefact.costInGp){e.appendChild(eX("p",{className:"guidance",text:ej`MESSAGE INSUFFICIENT FUNDS ${a} ${i}`})),t.currentOwner.isTrader()||rZ(e,t);return}return r.push(new eF({label:t.currentOwner.isTrader()?ej`BUTTON BUY FOR GP ${t.artefact.costInGp.toFixed(2)}`:ej`BUTTON SELL FOR GP ${t.artefact.sellBackPriceInGp.toFixed(2)}`,closes:rK.SELL})),r.push(new eF({label:ej`BUTTON CONTINUE`,closes:rK.CONTINUE})),r}(e,t);case rV.PILLAGE:return function(e,t){if(t.currentOwner.alive)return rZ(e,t);let i=[];if(!t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)){e.appendChild(r4(t)),t.currentOwner.alive&&rZ(e,t);return}let r=new eF({label:ej`BUTTON PILLAGE`,closes:rK.PILLAGE});return i.push(r),i.push(r=new eF({label:ej`BUTTON LEAVE ARTEFACT`,closes:rK.CONTINUE})),i}(e,t);case rV.VIEW:default:return[]}}(i,e);return e3.showControlsDialog(i,{preamble:e.preamble,actionButtons:r,row:!0})})(e).then(a=>{switch(a){case rK.CONSUME:return t.discard(r),r.interaction.react(e.currentOwner);case rK.DISCARD:t.discard(r);break;case rK.PREPARE_SPELL:case rK.EQUIP:i.equip(r);break;case rK.LEARN_SPELL:if(r.isMagic()&&i.hasArtefactWithSameId(r))return e3.showOkDialog(ej`MESSAGE SPELL ALREADY KNOWN`);if(t.discard(r),i.findSuitableStore(r).add(r),r.artefactType===tb.SPELL)return e3.showOkDialog(ej`MESSAGE EXPLAIN SPELL NEEDS REST`);break;case rK.PILLAGE:t.discard(r),i.findSuitableStore(r).add(r);break;case rK.SELL:{let a=e.currentOwner.isTrader()?r.costInGp:r.sellBackPriceInGp;t.addToPurse(a),e.prospectiveOwner.isTrader()||i.takeFromPurse(a),t.discard(r),r.stashInWagon&&!i.hasWagon?i.equip(r,{direct:!0}):i.stash(r,{direct:!0})}break;case rK.STASH:i.stash(r)||e3.showOkDialog(e.prospectiveOwner.isTrader()?ej`MESSAGE TRADER CANNOT STASH`:ej`MESSAGE CANNOT STASH`);break;case rK.TAKE:t?.discard(r),r.stashInWagon&&!i.hasWagon?i.equip(r,{direct:!0}):i.stash(r,{direct:!0});break;case rK.USE:return r.interaction.react(e.currentOwner)}return Promise.resolve()})}function r9(e){let t=eX("div");return t.appendChild(eX("p",{text:ej`MESSAGE REST DIALOG`})),r3(e,{allowConsumption:!0,allowRest:!0,description:t,okButtonLabel:ej`BUTTON TO NEXT FLOOR`})}const r6={SETBACK:{dc:11,bonus:4,damage:["1D10","2D10","4D10","10D10"]},DANGEROUS:{dc:14,bonus:7,damage:["2D10","4D10","10D10","18D10"]},DEADLY:{dc:18,bonus:11,damage:["4D10","10D10","18D10","24D10"]}};function r5(e,t){let i=document.createElement("div"),r=document.createElement("p");r.innerText=e,i.appendChild(r);let a=document.createElement("p");return a.innerText=t,i.appendChild(a),i}function r7(e,t,i){if(e2.playEffect("POISONED"),i>0)return f.debug("Poison applied"),eb(ed.getSpriteBitmap("skull.png"),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new I(0,0,0)}),ae(e,t,i);eb(ed.getSpriteBitmap("miss.png"),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new I(0,0,0)}),f.debug("Poison resisted.")}function ae(e,t,i){if(!i||!t.alive||t.isProp()||t.isHiddenArtefact())return 0;let r=t.traits.get("HP",0);if(r=Math.max(0,r-i),t.traits.set("HP",r),0===r){if(e2.playEffect(t.traits.get("SOUND","DIE")),f.info("Killed actor."),t.interaction=new ar(t),t.alive=!1,e?.isHero?.()){let i;let r=e.traits.adjustForDefeatOfActor(t.traits);r.level.now>r.level.was?i=ej`LEVEL UP ${r.level.now}`:r.exp.now>r.exp.was&&(i=`+${r.exp.now-r.exp.was} EXP`),i&&eB(i,e.position,tQ.HP_TRANSIENT_TEXT_HERO)}}else{let e=t.isHero()?tQ.HP_TRANSIENT_TEXT_HERO:tQ.HP_TRANSIENT_TEXT_ENEMY;eB(`-${i} HP`,t.position,e)}return r}class at{owner;constructor(e){this.owner=e}enact(e){return Promise.resolve()}react(e){return Promise.resolve()}canReact(){return!1}canEnact(){return!1}respectDisengage(e){return!1}}class ai extends at{constructor(e){super(e)}canEnact(){return!0}canReact(){return!0}enact(e){return this.#iO(this.owner,e)}react(e){return this.#iO(e,this.owner)}respectDisengage(e){return!0}#iC(e,t){let i=C.copy(e.position);return new eL({path:[new C(e.position.x+.2*(t.position.x-e.position.x),e.position.y+.2*(t.position.y-e.position.y)),i],speed:100}).applyAsTransientToSprite(e.sprite)}#iI(e,t){if(!e.isHero()){if(e.attackMode===af.POISON)return new as(e).enact(t);let i=e.storeManager,r=i.getStore(tD.PREPARED_SPELLS).getFirst();if(r||(r=i.getStore(tD.CANTRIPS).getFirst()),r)return r.interaction.react(e)}return this.#iN(e,t)}#iN(e,t){let i=0,r=0;return e.traits.getAttacks().forEach(e=>{let a=tm(e,t.traits);a>0&&(r++,i+=a)}),new Promise(a=>{if(i<=0){e2.playEffect("MISS"),eb(ed.getSpriteBitmap("miss.png"),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new I(0,0,0)}),a();return}let n=r>1?"DOUBLE PUNCH":"PUNCH",s=r>1?"blood-splat-twice.png":"blood-splat.png";e2.playEffect(n),eb(ed.getSpriteBitmap(s),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new I(0,0,0)}),a(ae(e,t,i))})}#iO(e,t){return f.info(`${e.traits?.get("NAME")} attacks ${t.traits.get("NAME")}`),this.#iC(e,t).then(()=>this.#iI(e,t))}}class ar extends at{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){return r8(e,this.owner,!0)}}class aa extends at{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}react(e){return this.owner.traits.get("NO_TRADE")?e3.showOkDialog([ej`MESSAGE TRADER WILL NOT TRADE`,ej`MESSAGE TRADERS PROTECTED`]):e3.showChoiceDialog(ej`DIALOG TITLE CHOICES`,ej`MESSAGE TRADE STEAL OR BARGE`,[ej`BUTTON TRADE`,ej`BUTTON STEAL`,ej`BUTTON BARGE`]).then(t=>0===t?r8(e,this.owner,!1):1===t?this.#iv(e):this.#iP(e))}#iv(e){if(!function(e,t){let i=tT(e.getInt("DEX",1));return te(20)+i>=t.getInt("DC",tf.HARD)}(e.traits,this.owner.traits))return this.owner.traits.set("_NO_TRADE",!0),e3.showOkDialog(ej`MESSAGE TRADER ATTACKS BACK`).then(()=>new ai(this.owner).enact(e));{let t=x(1,this.owner.traits.getInt("MAX_THEFT",1));return e.storeManager.addToPurse(t),e3.showOkDialog(ej`MESSAGE STOLE GOLD ${t}`)}}#iP(e){let t=C.copy(this.owner.position),i=C.copy(e.position);return Promise.all([eM(e,t),eM(this.owner,i)])}}class an extends at{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){this.owner.alive=!1;let t=this.owner.storeManager.getFirstStorageDetails();if(!t)return e3.showOkDialog(ej`MESSAGE NOTHING MORE TO DISCOVER`);{let i=t.artefact;if(i.isTrap()){let t=await i.interaction.react(e);if(t.outcome===ac.LEAVE)return this.owner.alive=!0,Promise.resolve();if(this.owner.storeManager.discardStashed(i,!0),!t.artefact)return Promise.resolve();i=t.artefact,this.owner.storeManager.stash(i,{direct:!0})}else if(i.isMagic()&&!function(e,t){let i=e.getCharacterLevel(),r=t.getInt("LEVEL",0);if(r>1+8*(i-1)/16)return f.info(`${e.get("NAME")} cannot learn level ${r} ${t.get("NAME")} as too high.`),!1;let a=t.get("CASTERS");if(!a)return f.info(`No casters set for ${t.get("NAME")} so can be learned.`),!0;let n=e.get("CLASS");return!!a.includes(n)||(f.info(`${e.get("NAME")} cannot learn ${t.get("NAME")} as not in casters.`),!1)}(e.traits,i.traits))return e3.showOkDialog(ej`MESSAGE CANNOT UNDERSTAND MAGIC`);return r2({preamble:this.#iL(i),currentOwner:this.owner,prospectiveOwner:e,storeType:t.store.storeType,artefact:i,actionType:rV.FIND,hideTraits:i.isMagic()})}}#iL(e){return this.owner.type===ap.HIDDEN_ARTEFACT?ej`MESSAGE FOUND HIDDEN ARTEFACT`:e.isMagic()?ej`MESSAGE FOUND ENGRAVING`:ej`MESSAGE FOUND GENERIC`}}class as extends at{constructor(e){super(e)}canEnact(){return!0}canReact(){return!1}enact(e){let t=tg(this.owner.traits,e.traits);return r7(this.owner,e,t),t&&e.toxify?.addToxicEffect(this.owner.traits),e.traits.addTransientFxTraits(this.owner.traits),Promise.resolve()}}class ao extends at{#iM;constructor(e){super(null),this.#iM=e??new ih}canEnact(){return!0}canReact(){return!1}enact(e){if(this.#iM.isActive)return r7(null,e,-this.#iM.getChangeInHpThisTurn()),Promise.resolve()}addToxicEffect(e){let t=-e.getFloat("DMG_PER_TURN",0);t&&(f.debug(`Add toxic effect of ${t} HP/turn`),this.#iM.addToxicEffect(t))}cure(){this.#iM.cure()}get isActive(){return this.#iM.isActive}getToxin(){return this.#iM}}class al extends at{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){let t=eo.getTileMap(),i=t.worldPointToGrid(e.position),r=this.owner.traits.getValueInFeetInTiles("RANGE",1),a=this.owner.traits.getInt("MAX_TARGETS",999),n=0,s=t.getRadiatingUpAndDown(i,r),o=this.owner.traits.get("ATTACK","MAGIC");for(let t of s){if(n>a)break;for(let i of("MAGIC"===o&&this.#iD(t.worldPoint),[...t.getOccupants().values()].sort((e,t)=>t.traits.getInt("HP")-e.traits.getInt("HP")))){var l,h,c;let r=(l=e.traits,h=i.traits,"MELEE"===(c=this.owner.traits).get("ATTACK")?function(e,t,i){let r=e.get("SPELL_CAST","INT"),a=e.getInt(r,1);return tm(new ty({damageDice:i.getDamageDiceWhenCastBy(e),weaponType:"UNARMED",proficiencyBonus:e.getCharacterPb(i),abilityModifier:tT(a)}),t)}(l,h,c):function(e,t,i){let r=e.get("SPELL_CAST","INT"),a=e.getInt(r,1),n=t.getNonMeleeSaveAbilityModifier(i),s=i.getInt("DC");null==s&&(f.error(`Magic ${e.get("NAME")} has no DC set.`),s=0);let o=s+(e.getCharacterPb(i)+tT(a)),l=te(20)+n,h=ti(i.getDamageDiceWhenCastBy(e));return l>=o?Math.round(i.getFloat("DMG_SAVED",0)*h):h}(l,h,c));r>0&&(n++,"MELEE"===o&&this.#iD(t.worldPoint),ae(e,i,r),i.traits.addTransientFxTraits(this.owner.traits))}}return"MELEE"===o&&0===n&&this.#ib(e.position),this.owner.artefactType===tb.SPELL&&function(e,t){let i=Math.round(1+5*(t.getInt("LEVEL",1)-1)/8),r=function(e){let t=e.getInt("CASTING_POWER");return e.has("CASTING_POWER")?t:tp(e)}(e);e.set("CASTING_POWER",Math.max(0,r-i))}(this.enactor.traits,this.owner.traits),Promise.resolve()}#iD(e){e_(this.owner.traits.get("EFFECT").toLowerCase(),{position:e,delaySecs:0,lifetimeSecs:1})}#ib(e){e_("failed-spell",{position:e,delaySecs:0,lifetimeSecs:1})}}class ah extends at{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){let t=this.owner.traits.get("TYPE");if("POISON"===t){let t=tg(this.owner.traits,e.traits);return 0===t?e3.showOkDialog(ej`MESSAGE RESISTED POISON`):0>=r7(this.owner,e,t)?e3.showOkDialog(ej`MESSAGE KILLED BY POISON`):e3.showOkDialog(ej`MESSAGE IT'S POISON ${t}`)}{let i=function(e,t){let i=e.getInt("HP",0),r=t.getInt("HP",0),a=t.getInt("HP_MAX",r)-r;return{shortFall:a,oldHp:r,newHp:r+(a<0?0:Math.min(a,i))}}(this.owner.traits,e.traits),r=i.newHp-i.oldHp;if(i.shortFall<=0)return e3.showOkDialog(ej`MESSAGE CONSUME BUT ALREADY FULL HP`);if(0===r)return e3.showOkDialog(ej`MESSAGE CONSUME BUT NO HP GAIN`);let a="POTION"===t?ej`MESSAGE IT'S A HEALTHY DRINK ${r}`:ej`MESSAGE IT'S HEALTHY ${r}`;return e3.showOkDialog(a).then(()=>e.traits.set("HP",i.newHp))}}}const ac={ATTEMPT_DISABLE:"attempt disable",LEAVE:"leave",DISABLED:"disabled",TRIGGERED:"triggered"};class au extends at{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){let t,i=null,r=function(e,t){let i;let r=r6[t.get("SEVERITY","SETBACK")]??r6.SETBACK;return i=e<5?r.damage[0]:e<11?r.damage[1]:e<17?r.damage[2]:r.damage[3],{difficulty:r.dc,attack:new ty({damageDice:i,weaponType:"TRAP",proficiencyBonus:0,abilityModifier:r.bonus}),detectBy:t.get("DETECT_BY","WIS"),disableBy:t.get("DISABLE_BY","INT"),reward:t.get("REWARD")}}(e.traits.getCharacterLevel(),this.owner.traits),a=await this.#i_(e.traits,r);switch(a){case ac.TRIGGERED:return f.info("Trigger the trap."),(0===(t=tm(r.attack,e.traits))?function(e,t,i){return e3.showElementOkDialog(ej`DIALOG TITLE TRAP TRIGGERED SURVIVED`,r5(i,ej`MESSAGE TRAP TRIGGERED SURVIVED`))}:function(e,t,i){return e3.showElementOkDialog(ej`DIALOG TITLE TRAP TRIGGERED INJURED`,r5(i,ej`MESSAGE TRAP TRIGGERED INJURED`))})(e,r,this.owner.description).then(()=>this.#iz(e,t)).then(()=>({outcome:a,artefact:i}));case ac.DISABLED:return f.info("Disabled the trap."),i=function(e,t=["MONEY"]){let i=tL.findById(e,t);return i?tM(i):(f.error(`Could not find artefact ${e} in ${t} almanacs.`),null)}(r.reward),(this.owner.description,e3.showOkDialog(ej`DIALOG TITLE TRAP DISABLED`,r5(ej`MESSAGE TRAP DISABLED`))).then(()=>({outcome:a,artefact:i}));case ac.LEAVE:return f.info("Left the trap."),Promise.resolve({outcome:a,artefact:i})}}#iz(e,t){return new Promise(i=>{e2.playEffect("TRIGGER TRAP"),t<=0?eb(ed.getSpriteBitmap("miss.png"),{delaySecs:1,lifetimeSecs:3,position:e.position,velocity:new I(0,0,0)}):(eb(ed.getSpriteBitmap("blood-splat.png"),{delaySecs:1,lifetimeSecs:3,position:e.position,velocity:new I(0,0,0)}),ae(this.owner,e,t)),i()})}#i_(e,t){return!function(e,t){let i=tT(e.get(t.detectBy,0));return te(20)+i>=t.difficulty}(e,t)?Promise.resolve(ac.TRIGGERED):(this.owner.description,e3.showChoiceDialog(ej`DIALOG TITLE TRAP DETECTED`,ej`MESSAGE TRAP ATTEMPT DISABLE`,[ej`BUTTON TRAP DISABLE`,ej`BUTTON TRAP LEAVE`]).then(e=>0===e?ac.ATTEMPT_DISABLE:ac.LEAVE)).then(i=>i===ac.LEAVE?i:!function(e,t){let i=tT(e.get(t.disableBy,0));return te(20)+i>=t.difficulty}(e,t)?ac.TRIGGERED:ac.DISABLED)}}class ad extends at{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){return this.#iB(e,this.owner)}#iB(e,t){let i=new eL({path:[t.position],speed:5});eb(ed.getSpriteBitmap("portal.png"),{delaySecs:0,lifetimeSecs:6,position:t.position,velocity:new I(0,0,3)}),new eI(0,3,new ev).applyAsTransientToSprite(e.sprite,20);let r=new eI(0,3,new ev);return i.applyAsTransientToSprite(e.sprite).then(()=>r.applyAsTransientToSprite(e.sprite))}}const ap={HERO:0,ENEMY:1,ARTEFACT:2,HIDDEN_ARTEFACT:3,TRADER:4,PROP:5,OBJECTIVE:6},af={COMBAT:"COMBAT",POISON:"POISON"},am={WANDER:"WANDER",HUNT:"HUNT",ORGANIC:"ORGANIC"};class ag extends tq{almanacEntry;#iG;sprite;traits;interaction;toxify;alive;disengaging;description;iconImageName;storeManager;type;adventureStartTime;constructor(e,t=ap.ENEMY){super(),this.interaction=new at,this.sprite=e,this.sprite.obstacle=!0,this.#iG=!1,this.alive=!0,this.disengaging=!1,this.type=t,this.storeManager=new tG(t===ap.TRADER||t===ap.HIDDEN_ARTEFACT,()=>this.#ik()),t===ap.HERO&&(this.adventureStartTime=new Date().getTime())}#ik(){let e=this.storeManager.getAllEquippedArtefacts(),t=e.filter(e=>e.artefactType===tb.WEAPON||e.artefactType===tb.TWO_HANDED_WEAPON),i=e.filter(e=>e.artefactType===tb.ARMOUR),r=e.filter(e=>e.artefactType===tb.SHIELD),a=e.filter(e=>e.isMagic());this.traits.utiliseAdditionalTraits({weapons:t.map(e=>e.traits),armour:i.map(e=>e.traits),shields:r.map(e=>e.traits),magic:a.map(e=>e.traits)})}freezeMovement(){this.#iG=!0}getMaxTilesPerMove(){return this.#iG?0:this.traits.getMaxTilesPerMove()}isHero(){return this.type===ap.HERO}isEnemy(){return this.type===ap.ENEMY}isTrader(){return this.type===ap.TRADER}isHiddenArtefact(){return this.type===ap.HIDDEN_ARTEFACT}set visible(e){this.sprite.visible=e}get visible(){return this.sprite.visible}get obstacle(){return this.sprite.obstacle}set obstacle(e){this.sprite.obstacle=e}get position(){return this.sprite.position}set position(e){this.sprite.position=e}get velocity(){return this.sprite.velocity}set velocity(e){this.sprite.velocity=e}getImageFilename(){return this.sprite.getImageFilename()}isWandering(){return this.traits?.get("MOVE")===am.WANDER}isOrganic(){return this.traits?.get("MOVE")===am.ORGANIC}isProp(){return this?.type===ap.PROP}isObjective(){return this?.type===ap.OBJECTIVE}get moveType(){return this?.traits.get("MOVE")}get attackMode(){return this?.traits.get("ATTACK",af.COMBAT)}willInteract(){return!!this.interaction&&(!this.isWandering()||te(6)>3)}isPassableByActor(e){return!!(e.isHero()&&this.isHiddenArtefact())||!this.alive&&!this.isProp()||!this.obstacle}canShareLocationWithActor(e){return this.isOrganic()?!e.isOrganic()&&!e.isTrader():this.isHiddenArtefact()?e.isHero():!!(!this.alive&&e.isHero())||!this.obstacle}update(e){this.sprite.update(e)}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionContextClick(this.sprite.position)}actionPointerUp(e){super.actionPointerUp(this.sprite.position)}actionPointerDown(e){super.actionPointerDown(this.sprite.position)}toJSON(){let e=this.storeManager.getAllStorageDetails(),t=[];for(let i of e)t.push({storeTypeId:i.store.storeTypeId,artefact:i.artefact});return{reviver:"Actor",data:{adventureStartTime:this.adventureStartTime,alive:this.alive,almanacEntry:this.almanacEntry,traits:this.traits,inventory:t,toxin:this?.toxify.getToxin()}}}static revive(e,t){let i=t(e.almanacEntry,e.traits);for(let t of(i.adventureStartTime=e.adventureStartTime,i.alive=e.alive,i.toxify=new ao(e.toxin),e.inventory)){let e=i.storeManager.getStoreByTypeId(t.storeTypeId);if(!e){f.error(`Unable to find store matching ${t.storeTypeId}. Game restore abandoned.`);return}e.add(t.artefact)}return i}}const aS=new Map;let aw=!1;function aE(e,t){let i=J.glassPositionToWorld(t.position),r=t.sprite.getBoundingBox();return new P(i.x-r.width/2,i.y-r.height/2,r.width,r.height).containsCoordinate(e.world.x,e.world.y)}function aT(e){if(!aw||!aw)return!1;for(let[t,i]of aS)if(aE(e,i))return i.actionPointerUp(i,e.canvas),!0;return!1}var ay={addButton:function(e,t,i){let r=new ag(new eO({renderer:new eR(J.getContext2D(),e)}));return aS.set(r,r),r.setOnClick(()=>{i?0===e.getCurrentIndex()?(e.setCurrentIndex(1),t()):(e.setCurrentIndex(0),i()):t()}),e.setCurrentIndex(0),r},addMomentaryButton:function(e,t,i){let r=new ag(new eO({renderer:new eR(J.getContext2D(),e)}));return aS.set(r,r),r.setOnPointerDown(()=>{e.setCurrentIndex(1),t?.()}),r.setOnPointerUp(()=>{e.setCurrentIndex(0),i?.()}),r},clear:function(){aS.clear()},removeButton:function(e){aS.delete(e)},update:function(e){aw&&aS.forEach(t=>{let i=v.copy(t.position);t.position=J.glassPositionToWorld(t.position),t.update(e),t.position=i})},resolvePointerCancel:function(e){return aT(e)},resolveClick:function(e){if(!aw)return!1;for(let[t,i]of aS)if(aE(e,i))return i.actionClick(i,e.canvas),!0;return!1},resolveContextMenu:function(e){return!1},resolvePointerDown:function(e){if(!aw||!aw)return!1;for(let[t,i]of aS)if(aE(e,i))return i.actionPointerDown(i,e.canvas),!0;return!1},resolvePointerUp:aT,setVisible:function(e){aw=e}};const aA={GRINNING:"\uD83D\uDE00",SANTA:"\uD83C\uDF85",SHAKING:"\uD83E\uDEE8"};class ax{#iU;#iH;#iF;#i$;#iW;constructor(e){this.#iU=x(e.minCols,e.maxCols),this.#iH=x(e.minRows,e.maxRows),this.#iF=e.maxRoomCols,this.#i$=e.maxRoomRows}#iV(e=1){let t="";for(;e-- >0;)t+=A(tH.WALL);return t}#iK(e=1){let t="";for(;e-- >0;)t+=A(tH.GROUND);return t}#iY(e=1){let t="";for(;e-- >0;)t+=A(tH.VOID);return t}#iX(e=1){let t="";for(;e-- >0;)t+=A(tH.DOOR_IN);return t}#iq(e=1){let t="";for(;e-- >0;)t+=A(tH.DOOR_OUT);return t}#ij(e){return tH.WALL.includes(e)}#iZ(e){return tH.GROUND.includes(e)}#iJ(e){return tH.VOID.includes(e)}#iQ(e){return tH.DOOR_IN.includes(e)}#i4(e){return tH.DOOR_OUT.includes(e)}generate(){this.#iW=[];let e=0,t=this.#iU;for(;this.#iW.length<this.#iH-4;){let i=e+t-4-2,r=i>0?y(0,i):0,a=Math.max(e-r+4,4),n=Math.min(this.#iF,this.#iU-r),s=n>a?y(a,n):a,o=this.#iU-r-s,l=y(4,Math.min(this.#i$,this.#iH-this.#iW.length));this.#i0(r,s,o,l),e=r,t=s}return this.#i1(),this.#i8(),this.getMatrixAsStrings()}getMatrixAsStrings(){return this.#iW.map(e=>e.join(""))}#i0(e,t,i,r){let a="";a+=this.#iY(e)+this.#iV(t)+this.#iY(i),this.#iW.push(a.split(""));for(let n=0;n<r-2;n++)a=""+this.#iY(e)+this.#iV(1)+this.#iK(t-2)+this.#iV(1)+this.#iY(i),this.#iW.push(a.split(""));a=""+this.#iY(e)+this.#iV(t)+this.#iY(i),this.#iW.push(a.split(""))}#i1(){for(let e=1;e<this.#iW.length-1;e++)for(let t=1;t<this.#iW[0].length-2;t++)this.#ij(this.#iW[e][t])&&this.#ij(this.#iW[e+1][t])&&this.#iZ(this.#iW[e-1][t])&&this.#iZ(this.#iW[e+2][t])&&(this.#iW[e][t]=this.#iK(1),this.#iW[e+1][t]=this.#iK(1))}#i3(e){return this.#ij(e.above)&&this.#ij(e.centre)&&this.#ij(e.below)}#i2(e){return this.#ij(e.left)&&this.#ij(e.centre)&&this.#ij(e.right)}#i8(){let e=[];this.#iW.forEach((t,i)=>t.forEach((t,r)=>{let a=tk(this.#iW,i,r);(this.#i2(a)||this.#i3(a))&&e.push({row:i,col:r})}));let t=tU(e),i=t[0];this.#iW[i.row][i.col]=this.#iX(),i=t[1],this.#iW[i.row][i.col]=this.#iq()}}const aR={MEDIUM:.25};class aO{#h;#it;constructor(){this.reset()}getIndex(){return this.#h}getNext(){return this.#h++,0===this.#h&&(h=null),this.#i9(),this.#it}hasNext(){return!0}reset(){this.#h=-1}restore(e,t){h=t,this.#h=e}#i9(){this.#it=new rU,this.#i6(),this.#i5(),this.#i7(),this.#re(),this.#rt(),this.#ri(),this.#rr()}#i5(){this.#it.intro=ej`MESSAGE ENTER FLOOR ${ic(this.#h)}`}#i6(){if(!h){let e=tL.getRandomEntry("HEROES");e||f.fatal(Error("Could not find hero in almanacs.")),h=il(e)}this.#it.hero=h}#i7(e=aR.MEDIUM){let t=function(e,t){let i=e*(h?.traits.getCharacterLevel()??1)+.001;return tL.getAlmanac("ENEMIES").filter(e=>e.challengeRating<=i&&e.minLevel<=t)}(e,this.#h),i=0,r=0;for(;i<e&&r<8;){let e=t.getRandomEntry();i+=e.challengeRating,r++,this.#it.enemies.push(e)}}#re(){for(let e=0;e<1;e++){let e=tL.getRandomEntry("TRADERS",e=>e.minLevel<=this.#h);this.#it.enemies.push(e)}}#rt(){let e=tL.getPooledAlmanac(["ARTEFACTS","MAGIC","MONEY","WEAPONS","TRAPS"],e=>e.minLevel<=this.#h),t=x(4,12);for(;t-- >0;){let t=e.getRandomEntry();t&&this.#it.artefacts.push(t)}}#rr(){let e=tL.getRandomEntry("OBJECTIVES",e=>e.minLevel<=this.#h);e&&(this.#it.objective=e)}#ri(){let e=new ax({minCols:12,maxCols:40,maxRoomCols:10,minRows:12,maxRows:40,maxRoomRows:6});this.#it.mapDesign=e.generate()}}const aC="custom-pointer-down-event",aI="custom-pointer-up-event",aN="custom-pointer-cancel-event",av="custom-click-event",aP="custom-context-click-event",aL="custom-pointer-drag-event",aM={MOUSE:0,TOUCH:1};function aD(e,t,i){let r=new CustomEvent(t,{detail:i});e.dispatchEvent(r)}function ab(e){let t=e.target.getBoundingClientRect();return{x:e.touches[0].pageX-t.left,y:e.touches[0].pageY-t.top}}function a_(e,t,i,r){r.actionStarted=!0,r.dragging=!1,r.distance=0,r.lastX=t,r.lastY=i,r.startX=t,r.startY=i,aD(r.element,aC,{x:t,y:i})}function az(e,t,i,r){let a=r.dragging?"custom-pointer-drag-end-event":aI;r.actionStarted=!1,r.dragging=!1,r.distance=0,r.lastX=t,r.lastY=i,r.startX=t,r.startY=i,aD(r.element,a,{x:t,y:i})}function aB(e,t,i,r){let a=t-r.lastX,n=i-r.lastY;if(r.lastX=t,r.lastY=i,r.dragging){let e=new CustomEvent(aL,{detail:{x:t,y:i,dx:a,dy:n}});r.element.dispatchEvent(e)}else(Math.abs(t-r.startX)>10||Math.abs(i-r.startY)>10)&&(r.dragging=!0,r.suppressClickEvent=!0)}const aG=new Map([["BUTTON ABOUT","About"],["BUTTON BUY FOR GP","Buy for ${0}Â GP"],["BUTTON CANCEL","Cancel"],["BUTTON CAST SPELL","Cast spell"],["BUTTON CONSUME","Consume"],["BUTTON CONTINUE","Continue"],["BUTTON CLIMB OVER","Climb over"],["BUTTON BARGE","Barge past"],["BUTTON HALL OF FAME","Hall of fame"],["BUTTON DISCARD","Discard"],["BUTTON DO NOT SHOW AGAIN","Do not show again"],["BUTTON ENTER DUNGEON","Enter if you dare"],["BUTTON EQUIP","Equip"],["BUTTON FORGET","Forget"],["BUTTON GUIDES","About and Help"],["BUTTON HELP","Help"],["BUTTON INVENTORY","Inventory"],["BUTTON LEARN SPELL","Learn spell"],["BUTTON LEAVE ARTEFACT","Leave"],["BUTTON MAGIC","Magic"],["BUTTON MOVE","Move"],["BUTTON OK","OK"],["BUTTON PILLAGE","Pillage"],["BUTTON PLAY ADVENTURE","Play adventure"],["BUTTON PLAY CASUAL","Play casual"],["BUTTON PRIVACY","Privacy"],["BUTTON PREPARE SPELL","Prepare"],["BUTTON REST","Rest"],["BUTTON REST LONG","Long rest"],["BUTTON READY MAGIC","Ready Magic"],["BUTTON REST SHORT","Short rest"],["BUTTON SEARCH","Search"],["BUTTON SELL FOR GP","Sell for ${0}Â GP"],["BUTTON SETTINGS","Settings"],["BUTTON SHOW DEBUG LOG","The chronicles of Debug Loggerman"],["BUTTON START","Let's get started."],["BUTTON STASH","Stash"],["BUTTON STEAL","Steal"],["BUTTON TRAP DISABLE","Try to disable"],["BUTTON TRAP LEAVE","Leave it alone"],["BUTTON TAKE ARTEFACT","Take"],["BUTTON TRADE","Trade"],["BUTTON TRAITS","Traits"],["BUTTON TRY AGAIN","Try again"],["BUTTON TO NEXT FLOOR","To the next floor"],["BUTTON USE","Use"],["CONTROL EFFECTS VOLUME","Effect volume"],["CONTROL MUSIC VOLUME","Music volume"],["CONTROL SHOW QUICK TIPS","Show quick tips"],["CONTROL START IN FULLSCREEN","Start in fullscreen"],["DESCRIPTION ACID_SPLASH","Casting this spell hurls acid over your enemies."],["DESCRIPTION BARBARIAN1","You are a barbarian ready to battle to the end of this dungeon in search of wealth and glory."],["DESCRIPTION BLACK_FLASK","A black flask containing a clear, pungent liquid."],["DESCRIPTION BLUE_FLASK","A blue flask containing a clear, aromatic oil."],["DESCRIPTION BURNING_HANDS","Casting this spell with your thumbs touching and fingers spread creates a thin sheet of flames enveloping your enemies."],["DESCRIPTION CHAIN_MAIL_ARMOUR","Armour comprising interlocking steel rings over a soft cushioning fabric. The suit includes gauntlets."],["DESCRIPTION CLERIC1","A powerful cleric who can act as a conduit between divine powers and the mortal world."],["DESCRIPTION CLUB","A simple wooden club that's seen a lot of action."],["DESCRIPTION COINS","Various coins stamped with the image of latter day kings and queens."],["DESCRIPTION COPPER_COINS","Old copper coins of low value."],["DESCRIPTION DAGGER","A short and very sharp piercing weapon."],["DESCRIPTION ENGRAVED_PILLAR","A large stone pillar covered with mystical engravings."],["DESCRIPTION FIGHTER1","You are a warrior whose family have fallen out of favour. You have been sent on a quest to recover the Chalice of Dark Sight. If found, your family's good name will be restored."],["DESCRIPTION GOBLIN","Small humanoid creature.Treat with caution. They're small but vicious."],["DESCRIPTION GOLD_COINS","Gold coins stamped with the image of latter day kings and queens."],["DESCRIPTION HALF_PLATE_ARMOUR","Shaped metal plates covering most of the body. Simple greaves protect the legs."],["DESCRIPTION HANDAXE","A small, light axe. The blade is sharp and has been looked after with care."],["DESCRIPTION HIDDEN_ARTEFACT","The ground appears to have been disturbed."],["DESCRIPTION INFLICT_WOUNDS","Target any creature you can touch to inflict necrotic damage."],["DESCRIPTION IRON_RATIONS","Simple emergency rations. Crucial for resting between floors."],["DESCRIPTION LEATHER_ARMOUR","Simple armour comprising stiffened leather boiled in oil along with some more flexible sections."],["DESCRIPTION MANHOLE_COVER","A small manhole cover set into the dungeon floor."],["DESCRIPTION NOXIOUS_GAS","A cloud of foul smelling gas. Poisonous and strength sapping"],["DESCRIPTION ORC","A monstrous creature with an intense hatred of humans."],["DESCRIPTION PADDED_ARMOUR","Simple quilted layers of cloth and batting."],["DESCRIPTION PLATE_ARMOUR","Full plate armour with interlocking steel plates covering the entire body. A visored helmet, gauntlets, boots, and padding are included."],["DESCRIPTION PLATINUM_COINS","Highly valued large platinum."],["DESCRIPTION RAT","A giant rat, diseased and vicious."],["DESCRIPTION RING_MAIL_ARMOUR","Leather armour reinforced with heavy steel rings sown into the material."],["DESCRIPTION RUSTY_KEY","A large iron key, covered in rust. It's been lost a long time."],["DESCRIPTION SCALE_MAIL_ARMOUR","Leather coat and legging covered with overlapping steel scales."],["DESCRIPTION SHIELD","A wooden shield, carried in one hand and offering some protection."],["DESCRIPTION SHORTSWORD","A light and highly versatile sword."],["DESCRIPTION SILVER_COINS","Silver coins, worn and tarnished but still of value."],["DESCRIPTION SLIME","A green sticky substance that seems to be growing."],["DESCRIPTION SPIDER","A giant spider with fangs dripping green venom."],["DESCRIPTION SPIKES","It's a trap. Sharp iron spikes shoot up from the ground."],["DESCRIPTION STUDDED_LEATHER_ARMOUR","Tough and flexible leather armour with the addition of steel spikes and rivets."],["DESCRIPTION TOMB_OF_ELDER","A large ancient shrine. It appears to be stone but with a magical gold lustre."],["DESCRIPTION TRADER1","A wandering trader selling all manner of things gathered during many months in the dungeon."],["DESCRIPTION TRADER2","A wandering trader with a wagon stacked high with a variety of artefacts found in the dungeon."],["DESCRIPTION TRAPDOOR","A small door in the floor. You can't tell what it hides."],["DESCRIPTION WATERSKIN","A leather drinking flask with fresh water. Crucial for resting between floors."],["DESCRIPTION WARHAMMER","A bludgeoning, versatile iron hammer favoured by many clerics."],["DIALOG TITLE DEBUG LOG","Chronicles of Debug Loggerman"],["DIALOG TITLE HALL OF FAME","Hall of Fame"],["DIALOG TITLE CHOICES","Decisions, decisions"],["DIALOG TITLE PICK SPELL TO CAST","Pick spell to cast"],["DIALOG TITLE PILLAGE","Pillage corpse"],["DIALOG TITLE PREPARE SPELLS","Prepare spells"],["DIALOG TITLE SETTINGS","Adjust settings"],["DIALOG TITLE TRADE","Buy and sell with trader"],["DIALOG TITLE TRAP DETECTED","Trap detected!"],["DIALOG TITLE TRAP DISABLED","Trap disabled!"],["DIALOG TITLE TRAP TRIGGERED SURVIVED","Trap triggered!"],["DIALOG TITLE TRAP TRIGGERED INJURED","Trap triggered!"],["MENU TITLE MAIN","Click and Crawl"],["MENU TITLE GUIDES","Guides and information"],["MESSAGE CANNOT LOAD URL","Cannot load data from ${0}"],["MESSAGE CANNOT REST SHORT NEED LONG REST","You've had too many short rests. You need a long one first."],["MESSAGE CANNOT REST SHORT NEED RATIONS","You don't have enough rations for a short rest."],["MESSAGE CANNOT REST LONG NEED RATIONS","You don't have enough rations for a long rest."],["MESSAGE CANNOT STASH","You need to make space in your backpack to stash this."],["MESSAGE CANNOT STORE","You're carrying too much stuff to pick up what you've found."],["MESSAGE CANNOT UNDERSTAND MAGIC","There is strange magic written here, but it's beyond your comprehension."],["MESSAGE CONSUME BUT ALREADY FULL HP","Tastes good, but you're already in prime health. Perhaps you should've waited."],["MESSAGE CONSUME BUT NO HP GAIN","Tastes nice, but your health hasn`t improved."],["MESSAGE DEAD HERO HAS NO INVENTORY","Dead heroes have no use for material belongings. Your inventory is lost in the dungeon, perhaps to be rediscovered by the next intrepid explorer."],["MESSAGE DEFEAT","Despite your valiant efforts, you died. Your legend will live on."],["MESSAGE DUNGEON INTRO CONTINUE","Welcome back, ${0}. The adventure continues. You recognise the familiar smell of death."],["MESSAGE DUNGEON INTRO CASUAL","You enter the dungeon for a quick exploration and to check on what dangers might exist before starting a full adventure. You progress will not be saved and any achievements will be lost."],["MESSAGE ENTER FLOOR","You enter dungeon floor ${0}. The door slams shut behind you. There's no way back. Like it or not, your only path is to continue deeper into the depths of this stone hell."],["MESSAGE EXIT LOCKED","The exit is locked. There must be a key somewhere."],["MESSAGE EXPLAIN REST","Trying to use the safety of the corridor to rest and eat?"],["MESSAGE EXPLAIN SPELL NEEDS REST","To use a spell you need to prepare it. Preparation can only be done between dungeon floors after a long rest."],["MESSAGE GENERIC EPITAPH","Here lies the corpse of one more defeated enemy."],["MESSAGE HALL OF FAME ENTRY","${3-startDate}: ${0-name}; level ${1-level} ${2-class}; ${4-gold} GP; floor ${5-floor}"],["MESSAGE HERO EPITAPH FOR","Here lies the body of ${0}. Rest in peace."],["MESSAGE INSUFFICIENT FUNDS","You don't have enough funds to purchase this item. The item costs ${0}Â GP but you only have ${1}Â GP."],["MESSAGE IT'S A HEALTHY DRINK","That tastes good. +${0}HP"],["MESSAGE IT'S HEALTHY","A bit chewy, but tastes good. +${0}HP"],["MESSAGE KILLED BY POISON","Yuk! Poison! You start to burn up, cough and vomit, before falling to the floor and dying."],["MESSAGE IT'S POISON","Yuk! It's poison. -${0}HP"],["MESSAGE MAKE SPACE IN BACKPACK","You need to make space in your backpack by discarding or using something."],["MESSAGE MAKE SPACE IN EQUIP","This is too big to store. Sell or discard what you're wearing so you can wear this."],["MESSAGE NOTHING MORE TO DISCOVER","There's nothing more for you to learn or discover here."],["MESSAGE RESISTED POISON","Yuk! It's poisonous, but you resist its toxic effects."],["MESSAGE REST DIALOG","You are on a dark staircase leading deeper into the dungeon, but safe for now. If you have enough food or drink, you can rest to restore some health if necessary. If you don't need to recover, save your rations."],["MESSAGE SEARCH CORPSE OR MOVE",["You have a choice. Do you want to search the body or climb on top?","You've found a corpse, but what should you do? Search for weapons and treasure or climb on top of the body?"]],["MESSAGE SEARCH HOLE OR MOVE",["You have a choice. Do you want to search this hole or move into it?","You've been here before. Do you want to search again or climb into the hole you dug?"]],["MESSAGE SEARCH OR MOVE","You have a choice. Do you want to search this tile or move onto it?"],["MESSAGE SPELL ALREADY KNOWN","You've found a spell, but you already know this incantation."],["MESSAGE STOLE GOLD","Success. You pick the trader's pocket undetected and steal ${0} gold coins."],["MESSAGE TRADE STEAL OR BARGE","Do you want to trade or barge past this guy?"],["MESSAGE TRADER ATTACKS BACK","The angry trader detects your clumsy attempt at robbery and strikes back at you."],["MESSAGE TRADER CANNOT STASH","The trader has no space for this."],["MESSAGE TRADER WILL NOT TRADE","The trader has had enough of your trickery and will not trade with you."],["MESSAGE TRADERS PROTECTED",'Traders are protected from attack under the ancient law for the protection of travelling merchants, "MÃ­riel roita ohtaril alamÃ«."'],["MESSAGE TRAP ATTEMPT DISABLE","You find a trap. You can't tell what it is though. Do you want to try to disable it?"],["MESSAGE TRAP TRIGGERED SURVIVED","Despite the trap triggering, you luckily avoid any injury."],["MESSAGE TRAP TRIGGERED INJURED","You're caught by surprise and sustain a number of injuries from the trap."],["MESSAGE TRAP DISABLED","Taking great care you manage to disable the trap."],["MESSAGE ENTRANCE STUCK",["The entrance is locked or jammed. You can't tell. Either way, you can't escape in that direction.","You can't open the door. It seems locked or jammed. There's no way back."]],["MESSAGE EXPLAIN SPELL PREP","After a long rest, you can prepare spells ready for use."],["MESSAGE FOUND HIDDEN ARTEFACT",["Good fortune smiles upon you. You found something.","You find something hidden in the ground.","Buried beneath the surface, you find something."]],["MESSAGE FOUND ENGRAVING","You find strange words engraved on the cold stone surface."],["MESSAGE FOUND GENERIC","It 's your lucky day. You' found something."],["MESSAGE KEY UNLOCKS EXIT","You use the key you found earlier to unlock the door."],["MESSAGE NO SAVED ADVENTURE","No adventure has been saved yet."],["MESSAGE NOTHING HERE","There's nothing here."],["MESSAGE REST SHORT HP GAIN","Your short rest recovered ${0} HP."],["MESSAGE REST LONG HP GAIN","Your long rest recovered ${0} HP. You are also now cured of the toxic effects of any poisons you may have encountered."],["MESSAGE WELCOME","Welcome to the Click and Crawl old-school dungeon crawler. How far will you get?"],["AC (including armour)","AC (+armour): ${0}"],["Backpack","Backpack"],["Body","Body"],["Cantrips","Cantrips"],["Consumables","Consumables"],["Character level:","Character level: ${0}"],["CHARACTER LEVEL:","level: ${0}"],["(DEAD)","(DEAD!)"],["Dungeon floor:","Dungeon floor: ${0}"],["Experience:","Experience: ${0}"],["Feet","Feet"],["Score:","Score: ${0}"],["Gold:","Gold: ${0}Â GP"],["GOLD PIECES"," gold pieces"],["Hands","Hands"],["Head","Head"],["(HP OUT OF VALUE)","(HP:Â ${0}/${1})"],["(HP VALUE)","(HP:Â ${0})"],["Known spells","Known spells"],["level","level"],["LEVEL UP","Level up to ${0}"],["Name:","Name: ${0}"],["Prepared spells","Prepared spells"],["Ready magic","Ready magic"],["Unknown","Unknown"],["Wagon","Wagon"]]);function ak(e){if(ef.updateTimeNow(e),c){var t;let i=(e-c)/1e3;rW.update(i),ay.update(i),eh.showFps&&(t=1/i,el(J.getContext2D(),`FPS: ${Math.round(t)}`,{x:0,y:J.getCanvasDimensions().height},{color:"green"}))}c=e,eJ.isAnimationOn()?window.requestAnimationFrame(ak):f.debug("Animation paused")}var aU={TILE_SIZE:48,initialise:async function(e){J.setOptions(e);let t=e3.popupElement(function(){let e=document.createElement("div"),t=document.createElement("img");t.src=i6.SPLASH_IMAGE,e.appendChild(t);let i=document.createElement("div");i.className="progress-indicator",e.appendChild(i);let r=document.createElement("p");return r.innerText="Loading",e.appendChild(r),e}());eZ.setMap(aG),function(e){let t=0;for(let i in aA){let r=e.measureText(aA[i]),a=r.fontBoundingBoxAscent+r.fontBoundingBoxDescent,n=.5*a-r.fontBoundingBoxDescent;e.fillText(aA[i],-.5*r.width,n),e.getImageData(0,0,1,1).data[3]<=0&&(f.debug(`Emoji ${i} not supported.`),aA[i]=`[${t++}]`),e.clearRect(0,0,r.width,a)}}(J.getContext2D()),function(){let e;let t=J.getCanvas();e={element:t,actionStarted:!1,dragging:!1,x:0,y:0,lastTouchStartPoint:null,suppressClickEvent:!1},t.addEventListener("mousedown",t=>a_(aM.MOUSE,t.offsetX,t.offsetY,e),{passive:!0}),t.addEventListener("mouseup",t=>az(aM.MOUSE,t.offsetX,t.offsetY,e),{passive:!0}),t.addEventListener("mousemove",t=>{1&t.buttons&&aB(aM.MOUSE,t.offsetX,t.offsetY,e)},{passive:!0}),t.addEventListener("touchstart",t=>{if(1===t.changedTouches.length){let i=ab(t);e.lastTouchStartPoint=new C(i.x,i.y),a_(aM.TOUCH,i.x,i.y,e)}},{passive:!0}),t.addEventListener("touchend",t=>{1===t.changedTouches.length&&az(aM.TOUCH,e.lastTouchStartPoint?.x,e.lastTouchStartPoint?.y,e),e.lastTouchStartPoint=null,e.suppressClickEvent=!1},{passive:!0}),t.addEventListener("touchmove",t=>{if(1===t.changedTouches.length){let i=ab(t);aB(aM.TOUCH,i.x,i.y,e),e.suppressClickEvent=!0}},{passive:!0}),t.addEventListener("touchcancel",t=>{var i,r;aM.TOUCH,i=e.lastTouchStartPoint?.x,r=e.lastTouchStartPoint?.y,e.actionStarted=!1,e.dragging=!1,e.distance=0,e.lastX=i,e.lastY=r,e.startX=i,e.startY=r,aD(e.element,aN,{x:i,y:r}),e.lastTouchStartPoint=null},{passive:!0}),t.addEventListener("click",i=>{f.debug("click"),e.suppressClickEvent||aD(t,av,{x:i.offsetX,y:i.offsetY}),e.suppressClickEvent=!1}),t.addEventListener("contextmenu",e=>{e.preventDefault(),aD(t,aP,{x:e.offsetX,y:e.offsetY})}),t.addEventListener(av,e=>{let t=e.detail.x,i=e.detail.y,r=J.uiCoordsToMappedPositions(t,i);ay.resolveClick(r)||eo.resolveClick(r)}),t.addEventListener(aC,e=>{let t=e.detail.x,i=e.detail.y,r=J.uiCoordsToMappedPositions(t,i);ay.resolvePointerDown(r)}),t.addEventListener(aI,e=>{let t=e.detail.x,i=e.detail.y,r=J.uiCoordsToMappedPositions(t,i);ay.resolvePointerUp(r)}),t.addEventListener(aN,e=>{let t=e.detail.x,i=e.detail.y,r=J.uiCoordsToMappedPositions(t,i);ay.resolvePointerCancel(r)}),t.addEventListener(aL,e=>{rW.panCameraBy(-e.detail.dx,-e.detail.dy)}),t.addEventListener(aP,e=>{let t=e.detail.x,i=e.detail.y,r=J.uiCoordsToMappedPositions(t,i);ay.resolveContextMenu(r)||eo.resolveContextMenu(r),e.preventDefault()})}(),t3.forEach(e=>{if(e.label=eZ.getText(e.labelKey),e.persistent&&e.onChange){let t=eU.get(e.id,e.defValue);e.onChange(t)}}),e3.showOkDialog(ej`MESSAGE WELCOME`,{okButtonLabel:ej`BUTTON START`,className:"door"}).then(()=>(function(){let e=document.body;e.requestFullscreen&&eU.get("START_IN_FULLSCREEN")&&e.requestFullscreen({navigationUI:"hide"})})()).then(()=>e2.loadAndPlayMusic(i6.MUSIC)).then(()=>e2.loadEffects(i6.SOUND_EFFECTS_MAP)).then(()=>ed.loadSpriteMap(i7.data,i7.textureUrl)).then(()=>tI(i6.DUNGEON_SCRIPT)).then(e=>rW.setSceneList(new aO)).then(()=>(function(e){let t=[];return e.forEach((e,i)=>{let r=tI(e).then(e=>{tL.addAlmanac(i,function(e,t){let i=new tv;return e.split(/[\r\n]+/).forEach(e=>{if(""!==(e=e.trim())&&!e.startsWith("#")){let r=tP(e,t);if(r)switch(r.rarity){case tN.VERY_RARE:i.veryRare.push(r);break;case tN.RARE:i.rare.push(r);break;case tN.UNCOMMON:i.uncommon.push(r);break;case tN.COMMON:default:i.common.push(r)}}}),i}(e,i))});t.push(r)}),Promise.all(t)})(i6.ALMANAC_MAP)).then(()=>(t.remove(),rC.triggerEvent(rC.EventId.MAIN_MENU))).then(()=>{eJ.onStartAnimation=()=>void(f.debug("Start animations"),window.requestAnimationFrame(ak)),eJ.setAnimationState(!0)}).catch(e=>{f.error(e),alert(`Fatal error in main game. ${e.message}`)})}};window.addEventListener("load",()=>{try{aU.initialise({width:800,height:600,maxScale:2.4,minScale:1,sizingMethod:"COVER",alpha:!1})}catch(e){f.fatal(e)}});
//# sourceMappingURL=index.33ff417f.js.map
