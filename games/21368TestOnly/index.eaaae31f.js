let e,t,i,r,n,s,o,a,l;/**
 * @license See {@link https://opensource.org/license/mit/|MIT}
 *
 * Copyright 2024 Steve Butler
 */let h=[];window.addEventListener("error",e=>{alert(`ERROR: ${e.filename}; line ${e.lineno}
${e.message}
:Stack:
${e.error.stack}`)});var c,u={log:function(...e){console.log(...e)},info:function(...e){console.debug(...e)},debug:function(...e){console.debug(...e)},error:function(...e){console.error(...e),h=h.concat(e)},fatal:function(e){let t;console.error(e),t=e.message?`${e.message}
Stack:
${e.stack}`:e,alert(`Fatal error: ${t}
Previous errors:
${h.join("\n")}`),h.push(t)}};const d="'UnifrakturCook', cursive",p={normal:{size:15,fontName:"'UnifrakturCook', cursive"},h1:{size:30,fontName:d},h2:{size:22,fontName:d},h3:{size:18,fontName:d},emojiSprite:{size:18,fontName:"'UnifrakturCook', cursive"}};function f(e){let t=p[e]??p.normal;return`${t.size}px ${t.fontName}`}const m={DEG_22_5:1/8*Math.PI,DEG_45:2/8*Math.PI,DEG_67_5:3/8*Math.PI,DEG_112_5:5/8*Math.PI,DEG_135:6/8*Math.PI,DEG_157_7:7/8*Math.PI};function g(e,t,i){return e<t?t:e>i?i:e}const w={NONE:-1,N:0,NE:1,E:2,SE:3,S:4,SW:5,W:6,NW:7};function S(e,t){let i=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-i)+i)}function y(e,t){let i=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-i+1)+i)}function E(e,t=0,i){let r=parseInt(e,i);return Number.isNaN(r)?t:r}class T{x;y;constructor(e,t){this.x=e,this.y=t}static copy(e){return new T(e.x,e.y)}coincident(e){return this.x===e.x&&this.y===e.y}getCartesianAngleTo(e){return Math.atan2(e.y-this.y,e.x-this.x)}getScreenAngleTo(e){return Math.atan2(this.y-e.y,e.x-this.x)}toString(){return`(${this.x},${this.y})`}isCoincident(e){return Math.round(this.x)===Math.round(e.x)&&Math.round(this.y)===Math.round(e.y)}isOtherClose(e,t){return Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2)<=Math.pow(t,2)}getOrthoSeparation(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}}class x{x;y;rotation;constructor(e,t,i){this.x=e,this.y=t,this.rotation=i}getCartesianDirection(){return Math.atan2(this.y,this.x)}getScreenDirection(){return Math.atan2(-this.y,this.x)}isZero(e){return Math.abs(this.x)<e&&Math.abs(this.y)<e}}class A extends T{rotation;constructor(e,t,i){super(e,t),this.y=t,this.rotation=i}static fromPoint(e){return new A(e.x,e.y,0)}static copy(e){return new A(e.x,e.y,e.rotation)}getRelativeTo(e){return new A(this.x-e.x,this.y-e.y,this.rotation-e.rotation)}withinSquare(e,t){return Math.abs(e.x-this.x)<t&&Math.abs(e.y-this.y)<t}}class C{x;y;width;height;constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}getBottomRight(){return new T(this.x+this.width,this.y+this.height)}getTopLeft(){return new T(this.x,this.y)}overlaps(e){let t=this.getBottomRight(),i=e.getBottomRight();return!(e.x>t.x||e.y>t.y||i.x<this.x||i.y<this.y)}containsPoint(e){return e.x>=this.x&&e.x<=this.x+this.width&&e.y>=this.y&&e.y<=this.y+this.height}containsCoordinate(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}equals(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}}new T(Number.MIN_VALUE,Number.MIN_VALUE),new T(Number.MAX_VALUE,Number.MAX_VALUE);let O=null,I=null,v=null,P=0,R=0,N=!0,M=null,b=null,D=0,L=0,k=1,B=1,z=.1,_="COVER",G=new A(0,0,0);function U(){let e,t,i,r;let n={width:window.innerWidth,height:window.innerHeight},s=v.width/v.height,o=0,a=0,l=n.width/n.height;("COVER"===_?s>l:s<l)?a=(o=n.height)*s:o=(a=n.width)/s,(k=a/v.width)>B?(a=(k=B)*v.width,o=k*v.height):k<z&&(a=(k=z)*v.width,o=k*v.height),D=(n.width-a)/2,L=(n.height-o)/2,I.style.left=`${D}px`,I.style.top=`${L}px`,I.style.width=`${a}px`,I.style.height=`${o}px`,D<0?(i=-D/k,e=n.width/k):(i=0,e=v.width),L<0?(r=-L/k,t=n.height/k):(r=0,t=v.height),M=new C(i,r,e,t),u.debug(`Scale: ${k}`),u.debug(`Window: width: ${n.width}, height: ${n.height}`),u.debug(`Display: left: ${D}, top: ${L}, width: ${a}, height: ${o}`),u.debug(`Visible canvas: left: ${i}, top: ${r}, width: ${e}, height: ${t}`)}function H(){let e=p.normal.size*k;document.documentElement.style.fontSize=`${e}px`}function F(){U(),H()}function W(){return I.getContext("2d",{alpha:N})}function $(e){return e.style.opacity=0,new Promise(t=>{window.setTimeout(()=>{e.remove(),t()},500)})}function V(e){return new A(e.x+G.x,e.y+G.y,e.rotation)}window.addEventListener("resize",()=>{null===O&&(O=window.setTimeout(()=>{F(),O=null},200))});var K={canvasPositionToWorld:V,centreCanvasOn:function(e){G.x=e.x-P,G.y=e.y-R},clearCanvas:function(){W().clearRect(0,0,v.width,v.height)},displayOnGlass:function(e,t,i){let r;let n=document.createElement("div");document.body.appendChild(n),n.className="glass";let s=document.createElement("div");n.appendChild(s),s.className="glass-content",s.appendChild(e),i&&n.classList.add(i),n.style.display="block",n.style.opacity=1;let o=s.getBoundingClientRect().height;s.scrollHeight>o&&s.classList.add("overflow");let a=[];if(t&&t.length>0)t.forEach(e=>{let t=new Promise(t=>{e.element.addEventListener("click",async()=>{t(e.closes)})});a.push(t)});else{let e=new Promise(e=>s.addEventListener("click",()=>e()));a.push(e)}return Promise.race(a).then(e=>(r=e,$(n))).then(()=>r)},getCanvas:()=>I,getContext2D:W,getCanvasDimensions:function(){return{width:v.width,height:v.height}},getWorldInCanvasBounds:function(){return new C(G.x,G.y,v.width,v.height)},getVisibleCanvasRect:function(){return M},glassPositionToWorld:function(e){let t=e.x<0?M.x+M.width:M.x,i=e.y<0?M.y+M.height:M.y;return V(new A(t+e.x,i+e.y,e.rotation))},isOnCanvas:function(e){return e.overlaps(v)},isOnScreen:function(e){return e.overlaps(v)},panCamera:function(e,t){G.x+=e,G.y+=t},resize:F,setOpacity:function(e){W().globalAlpha=e},setOptions:function(e){var t;if(I){u.error("Multiple calls to setScreen ignored.");return}b=document.getElementById("game-content"),t=e.width,p.normal.size=15+t/100*.390625,p.h1.size=2*p.normal.size,p.h2.size=1.5*p.normal.size,p.h3.size=1.2*p.normal.size,p.emojiSprite.size=t/10,(I=document.createElement("canvas")).id="game-canvas",I.setAttribute("width",e.width),I.setAttribute("height",e.height),I.innerText="Loading the app.",v=new C(0,0,e.width,e.height),P=e.width/2,R=e.height/2,b.appendChild(I),B=e.maxScale,z=e.minScale,_=e.sizingMethod,N=e.alpha,U(),H()},wipeGlass:$,worldPositionToCanvas:function(e){return new A(e.x-G.x,e.y-G.y,e.rotation)},worldToUi:function(e){return e*k},uiCoordsToMappedPositions:function(e,t){return{canvas:new A(Math.round(e/=k),Math.round(t/=k)),world:new A(Math.round(e+G.x),Math.round(t+G.y),-G.rotation)}},uiToWorld:function(e){return e/k}};const q=new Map,Y=new Map,X=new Map,Z=new Map;function j(t){let i=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,i),t.isOrganic()?Z.delete(t):q.delete(t)}function Q(t){let i=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,i),Y.delete(t)}function J(e){u.debug("Remove passive sprite."),X.delete(e)}function ee(){e=null}var et={addActor:function(t){t.isOrganic()?Z.set(t,t):q.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addArtefact:function(t){Y.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addPassiveSprite:function(e){X.set(e,e)},clearAll:function(){Z.forEach(e=>j(e)),q.forEach(e=>j(e)),Y.forEach(e=>Q(e)),X.forEach(e=>J(e)),ee()},getActors:function(){return q},getOrganicActors:function(){return Z},getArtefacts:function(){return q},getTileMap:function(){return e},getWorldDims:function(){return e?e.getDimensions():K.getCanvasDimensions()},removeTileMap:ee,resolveCancel:function(e){return!1},resolveClick:function(t){let i=e?.getTileAtWorldPoint(t.world);return!!i&&(i.actionClick(t.world),!0)},resolveContextMenu:function(t){let i=e.getTileAtWorldPoint(t.world);return!!i&&(i.actionContextClick(t.world),!0)},removeActor:j,removeArtefact:Q,removePassiveSprite:J,setTileMap:function(t){e=t},update:function(t){e?.update(t),Z.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let n=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,n)}),Y.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let n=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,n)}),q.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let n=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,n)}),X.forEach(e=>e.update(t))}};function ei(e,t,i,r){if(e.font=f(r?.styleName),e.fillStyle=r?.color??"white",r?.wrapAtX){var n=t.split("\n");for(let t=0;t<n.length;t++)r.y=function(e,t,i,r){let n;let s=t.split(" "),o=i.x??0,a=i.y??0,l=r.xWrapPosition-o,h=r.lineSpacing??1,c="";for(let t=0;t<s.length;t++){let i=c+s[t]+" ",r=function(e,t){let i=e.measureText(void 0);return{width:i.width,height:i.fontBoundingBoxAscent+i.fontBoundingBoxDescent,offsetTop:-i.fontBoundingBoxAscent,offsetCentreY:.5*(i.fontBoundingBoxDescent-i.fontBoundingBoxAscent)}}(e);n||(n=h*r.height),r.width>l&&t>0?(e.fillText(c,o,a),c=s[t]+" ",a+=n):c=i}return e.fillText(c,o,a),a+n}(e,n[t],i,r)}else e.fillText(t,i.x??0,i.y??0)}const er={spriteBoxes:!1,showFps:!0};let en=new Map;function es(e){return new Promise(t=>{let i=new Image;i.addEventListener("load",()=>{u.debug("Image loaded."),t(i)}),i.src=e})}var eo={getSpriteBitmap:function(e,t){let i=en.get(e);return i||t?.quiet||u.debug(`Failed to find image ${e}.`),!(!i&&t?.fallback)||(i=en.get(t.fallback))||u.debug(`Failed to find fallback image ${t.fallback}.`),i},loadImage:es,loadImages:function(e){let t=[];return e.forEach(e=>t.push(es(e))),Promise.all(t)},loadSpriteMap:function(e,t){return es(t).then(t=>(function(e,t){let i=[];return e.frames.forEach(e=>{i.push(createImageBitmap(t,e.frame.x,e.frame.y,e.frame.w,e.frame.h).then(t=>{let i={filename:e.filename,image:t,width:e.frame.w,height:e.frame.h,centreX:e.sourceSize.w/2-e.spriteSourceSize.x,centreY:e.sourceSize.h/2-e.spriteSourceSize.y};return en.set(e.filename,i),e.filename}))}),Promise.all(i)})(e,t))}};let ea=0;var el={updateTimeNow:function(e){ea=e},getFrameCount:function(e,t=0){return Math.floor((ea+t)/e)}};const eh={WRAP:0,REVERSE:1,STOP:2};class ec{#e;#t;#i;#r;#n;constructor(e,t){this.#e=e,this.#t=e-1,this.#i=t,this.#r=1,this.#n=0}get index(){return this.#n}set index(e){this.#n=g(e,0,this.#e-1)}advanceBy(e){if(this.#e<1)return this.#n;switch(this.#i){case eh.WRAP:return this.#s(e);case eh.REVERSE:return this.#o(e);case eh.NONE:default:return this.#a(e)}}#s(e){return e%=this.#e,this.#n+=e%this.#e,this.#n>=this.#e&&(this.#n=this.#n-this.#e),this.#n}#o(e){if(Math.floor(e/this.#e)%2&&(this.#r=-this.#r),e%=this.#e,this.#r>0){this.#n+=e;let t=this.#n-this.#t;t>0&&(this.#n=this.#t-t,this.#r=-1)}else this.#r<0&&(this.#n-=e,this.#n<0&&(this.#n=-this.#n,this.#r=1));return this.#n}#a(e){return this.#r>0?this.#n=Math.min(this.#t,this.#n+e):this.#r<0&&(this.#n=Math.max(0,this.#n-e)),this.#n}}class eu{playing;#l;#h;#c;#u;#d;constructor(e,t){let i;if(this.#l=[],this.#c=0,this.#u=S(0,1e3),"string"==typeof e){this.#l.push(eo.getSpriteBitmap(e));return}this.#d=Math.max(1,t.framePeriodMs);let r=e.startIndex??0,n=e.padding??0,s=!0;do{let t=`${e.prefix}${r.toString().padStart(n,"0")}${e.suffix}`;s?(i=eo.getSpriteBitmap(t,{fallback:"undefined.png"}),s=!1):i=eo.getSpriteBitmap(t,{quiet:!0}),i&&this.#l.push(i),r++}while(i)this.#h=new ec(this.#l.length,t.loopMethod),this.playing=!0}getCurrentFrame(){if(!(this.#l.length>1))return this.#l[0];if(this.playing){let e=el.getFrameCount(this.#d,this.#u);e!==this.#c&&(this.#h.advanceBy(e-this.#c),this.#c=e)}return this.#l[this.#h.index]}setCurrentIndex(e){this.#l.length>1&&(this.playing=!1,this.#h.index=e)}getCurrentIndex(){return this.#l.length>1?this.#h.index:0}}class ed{#p;#f;constructor(e,t){this.#p={},this.#p[e]=t,this.#f=t}get image(){return this.#f}addAnimatedImage(e,t){this.#p[e]=t}setCurrentKey(e){this.#p.hasOwnProperty(e)?this.#f=this.#p[e]:u.error(`Attempt to set current key to nonexistent value of ${e}`)}getCurrentFrame(){return this.#f.getCurrentFrame()}}class ep{_context;_boundingBoxCanvas;constructor(e){this._context=e,this._boundingBoxCanvas=new C(0,0,0,0)}getImageFilename(){return null}getContext(){return this._context}getBoundingBoxCanvas(){return this._boundingBoxCanvas}render(e,t){if(e=K.worldPositionToCanvas(e),!this.isOnCanvas(e))return;let i=this._context.globalAlpha;this._context.globalAlpha=i*t;let r=e.rotation;r&&(this._context.save(),this._context.translate(e.x,e.y),this._context.rotate(-e.rotation),this._context.translate(-e.x,-e.y)),this._doRender(e),r&&this._context.restore(),er.spriteBoxes&&(this._context.strokeStyle="green",this._context.strokeRect(this._boundingBoxCanvas.x,this._boundingBoxCanvas.y,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height)),this._context.globalAlpha=i}_doRender(e){u.error("_doRender method should be overridden.")}isOnScreen(e){let t=new C(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return K.isOnScreen(t)}isOnCanvas(e){let t=new C(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return K.isOnCanvas(t)}}class ef extends ep{#m;#g;#w;text;constructor(e,t,i="normal"){super(e),this.text=t,this.#m=i}#S(e){this._context.font=f(this.#m);let t=this._context.measureText(e);this.#w={width:t.width,height:t.fontBoundingBoxAscent+t.fontBoundingBoxDescent,origin:{x:-.5*t.width,y:.5*(t.fontBoundingBoxAscent-t.fontBoundingBoxDescent)}},this.#g=e}_doRender(e){var t;this.text!==this.#g&&this.#S(this.text);let i={x:e.x+this.#w.origin.x,y:e.y+this.#w.origin.y,rotation:e.rotation};ei(this._context,this.#g,i,{styleName:this.#m}),this._boundingBoxCanvas=(t=this.#w,new C(e.x-t.width/2,e.y-t.height/2,t.width,t.height))}}class em extends ep{#y;#E;#T;#x;#A;#C;constructor(e,t){super(e),this.#y=t.width??10,this.#E=t.height??10,this.#T=this.#y/2,this.#x=this.#E/2,this.#A=t.fillStyle,this.#C=t.strokeStyle}_doRender(e){let t=e.x-this.#T,i=e.y-this.#x;this.#A&&(this._context.fillStyle=this.#A,this._context.fillRect(t,i,this.#y,this.#E)),this.#C&&(this._context.strokeStyle=this.#C,this._context.strokeRect(t,i,this.#y,this.#E)),this._boundingBoxCanvas=new C(t,i,this.#y,this.#E)}}class eg extends ep{#E;#x;#y;#T;#A;#C;#O;#I;#v;#P;constructor(e,t){super(e),this.#E=t.height,this.#x=this.#E/2,this.#y=t.width,this.#T=this.#y/2,this.#A=t.fillStyle,this.#C=t.strokeStyle,this.#O=t.offsetX??0,this.#I=t.offsetY??0,this.setLevel(0)}setLevel(e){this.#v=Math.min(e,1)*this.#E,this.#P=.5*this.#v}_doRender(e){let t=e.y-this.#x+this.#I,i=e.y+this.#x-this.#v+this.#I,r=e.x-this.#T+this.#O;this.#A&&(this._context.fillStyle=this.#A,this._context.fillRect(r,i,this.#y,this.#v)),this.#C&&(this._context.strokeStyle=this.#C,this._context.strokeRect(r,t,this.#y,this.#E)),this._boundingBoxCanvas=new C(r,t,this.#y,this.#E)}}class ew extends ep{#R;constructor(e,t){super(e);let i=Math.max(t.fillStyles.length??0,t.strokeStyles.length??0);if(0===i){u.error("Attempt to create MultiGaugeTileRenderer with no gauges.");return}this.#R=[];let r=t.tileSize/i,n=-t.tileSize/2+r/2;for(let s=0;s<i;s++)this.#R.push(new eg(e,{width:r,height:t.tileSize,fillStyle:t.fillStyles?.[s],strokeStyle:t.strokeStyles?.[s],offsetX:n+r*s,offsetY:0}))}setLevel(e,t){this.#R[e]?.setLevel(t)}render(e){this.#R?.forEach(t=>t.render(e))}}class eS extends ep{#N;#M;constructor(e,t){super(e),t?.getCurrentFrame?(this.#M=t,this.#N=this.#M.getCurrentFrame()):this.#N=t,this.#N?(this._boundingBoxCanvas.width=this.#N?.width??0,this._boundingBoxCanvas.height=this.#N?.height??0):u.error("No image frame available for sprite.",t)}getImageFilename(){return this.#N.filename}_doRender(e){if(!this.#N)return;let t=this.#M?this.#M.getCurrentFrame():this.#N;this._boundingBoxCanvas.x=e.x-this._boundingBoxCanvas.width/2,this._boundingBoxCanvas.y=e.y-this._boundingBoxCanvas.height/2,this._context.drawImage(t.image,e.x-t.centreX,e.y-t.centreY)}}class ey{#b=new A(0,0,0);#D=new x(0,0,0);#L;modifier;visible;opacity;constructor(e){this.#L=e?.renderer,this.visible=!0,this.opacity=1}get position(){return this.#b}set position(e){this.#b.x=this.valueOrZero(e.x),this.#b.y=this.valueOrZero(e.y),this.#b.rotation=this.valueOrZero(e.rotation)}get velocity(){return this.#D}set velocity(e){this.#D.x=this.valueOrZero(e.x),this.#D.y=this.valueOrZero(e.y),this.#D.rotation=this.valueOrZero(e.rotation)}valueOrZero(e){return"number"==typeof e?e:0}update(e){this.modifier&&(this.modifier=this.modifier.update(this,e)),this.visible&&this.#k()}#k(){this.#L&&(this.#L.forEach?this.#L.forEach(e=>e.render(this.#b,this.opacity)):this.#L.render(this.#b,this.opacity))}getBoundingBox(){let e=this.#L.getBoundingBoxCanvas();return new C(this.position.x-e.width/2,this.position.y-e.height/2,e.width,e.height)}getImageFilename(){if(!this.#L.forEach)return this.#L.getImageFilename();for(let e of this.#L){let t=e.getImageFilename();if(t)return t}return null}}class eE{decoratedModifier;#B;#z;#_;constructor(e){this.#z=0,this.#_=0,this.decoratedModifier=e}applyAsTransientToSprite(e,t=10){return this.#_=t,new Promise(t=>{this.#B=t,e.modifier=this})}applyAsContinuousToSprite(e){e.modifier=this}update(e,t){this.#B&&(this.#z+=t),this.decoratedModifier&&(this.decoratedModifier=this.decoratedModifier?.update(e,t));let i=this.doUpdate(e,t);return!i||this.#z>this.#_?(this.#B?.(null),null):i}doUpdate(e,t){return u.error("doUpdate should be overridden."),this}}class eT extends eE{#G;constructor(e,t){super(t),this.#G=1/Math.max(e,.5)}doUpdate(e,t){return e.opacity=Math.max(0,e.opacity-t*this.#G),e.opacity>0?this:null}}class ex{#U;#H;constructor(e,t){this.#U=e,this.#H=t}getSpeedBetweenPoints(e,t){return this.#H?this.#U:(1+.1*(Math.abs(e.x-t.x)+Math.abs(e.y-t.y)))*this.#U}}class eA extends eE{#F;#W;constructor(e){super(e)}doUpdate(e,t){let i=e.position,r=e.velocity;return i.x+=r.x*t,i.y+=r.y*t,e.position=i,e.velocity=r,this}}class eC extends eE{#$;#V;#K;constructor(e,t){super(t),this.#$=e.prey,this.#V=e.maxSeparation,this.#K=new ex(e.speed,e.linear)}doUpdate(e,t){let i=this.#$.position,r=e.position,n=this.#K.getSpeedBetweenPoints(i,r);if(!r.withinSquare(i,this.#V)){let s=r.getCartesianAngleTo(i);e.velocity.x=n*Math.cos(s),e.velocity.y=n*Math.sin(s);let o=e.velocity.x*t,a=e.velocity.y*t;e.position.x+=this.getMinMove(o,i.x,r.x),e.position.y+=this.getMinMove(a,i.y,r.y)}return this}getMinMove(e,t,i){let r=t-i;return 0>Math.sign(e)?Math.max(e,r):Math.min(e,r)}}class eO extends eE{#q;#n;#Y;#K;constructor(e,t){super(t),this.#q=e.path,this.#n=0,this.#Y=e.path[0],this.#K=new ex(e.speed,e.linear)}doUpdate(e,t){let i=e.position,r=this.#K.getSpeedBetweenPoints(this.#Y,i),n=i.getCartesianAngleTo(this.#Y);e.velocity.x=r*Math.cos(n),e.velocity.y=r*Math.sin(n);let s=e.velocity.x*t,o=e.velocity.y*t;if(i.x+=this.getMinMove(s,this.#Y.x,i.x),i.y+=this.getMinMove(o,this.#Y.y,i.y),i.isCoincident(this.#Y)){if(++this.#n>=this.#q.length)return e.velocity.x=0,e.velocity.y=0,this.decoratedModifier;this.#Y=this.#q[this.#n]}return this}getMinMove(e,t,i){let r=t-i;return 0>Math.sign(e)?Math.max(e,r):Math.min(e,r)}}function eI(e,t){return new eO({path:[t],speed:100},e.sprite.modifier).applyAsTransientToSprite(e.sprite)}function ev(e,t){let i=new ey({renderer:e});i.position=t.position,i.velocity=t.velocity,et.addPassiveSprite(i),new eT(t.lifetimeSecs,new eA).applyAsTransientToSprite(i,20).then(()=>et.removePassiveSprite(i))}function eP(e,t){ev(new eS(K.getContext2D(),e),t)}function eR(e,t){ev(new ef(K.getContext2D(),e),t)}var eN={TILE_SIZE:48};const eM=new class{#X;constructor(){this.#X=new Map}set(e,t){this.#X.set(e,t);try{localStorage.setItem(e,JSON.stringify(t))}catch(e){u.error(`Cannot save setting. ${e.message}`)}}get(e,t){if(this.#X.has(e))return this.#X.get(e);let i=t;try{let t=localStorage.getItem(e);null!==t&&(i=JSON.parse(t))}catch(e){u.error(`Cannot parse value from local storage. ${e.message}`)}return this.#X.set(e,i),i}};class eb{#Z;_element;#j;#Q;closes;constructor(e){if(e.closes&&e.action)throw Error("Attempt made to create control that is set to close forms and perform and action. These are mutually exclusive.");if(e.persistent&&!e.id)throw Error("Persistent controls must have an ID set in the options.");this.#Z=e.id,this.#Q=e.persistent,e.persistent?this.#j=eM.get(this.#Z,e.defValue):this.#j=e.defValue,this.closes=e.closes,this.listeners=0}get element(){return this._element}get value(){return this.#j}set value(e){e!==this.#j&&(this.#Q&&eM.set(this.#Z,e),this.#j=e)}}class eD extends eb{constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return t.appendChild(document.createTextNode(e.label)),t.className="text-button",t}}class eL extends eb{constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return e.leftLabel&&t.appendChild(document.createTextNode(e.leftLabel)),t.appendChild(ek(e.imageName,"button-icon")),e.rightLabel&&t.appendChild(document.createTextNode(e.rightLabel)),t.className="icon-button",t}}function ek(e,t){let i=eo.getSpriteBitmap(e??"undefined.png",{fallback:"undefined.png"}),r=document.createElement("canvas");r.setAttribute("width",eN.TILE_SIZE),r.setAttribute("height",eN.TILE_SIZE);let n=r.getContext("2d");return n.clearRect(0,0,eN.TILE_SIZE,eN.TILE_SIZE),n.drawImage(i.image,.5*(eN.TILE_SIZE-i.width),.5*(eN.TILE_SIZE-i.height)),r.className=t,r}class eB extends eb{#J;constructor(e){super(e),this._element=this.buildElement(e.label),this.#J.checked=this.value,this._element.addEventListener("change",t=>{this.value=this.#J.checked,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-checkbox",this.#J=document.createElement("input"),this.#J.setAttribute("type","checkbox"),t.appendChild(this.#J),t.appendChild(ek("ui-checkbox00.png","unchecked")),t.appendChild(ek("ui-checkbox01.png","checked"));let i=document.createElement("label");return i.appendChild(document.createTextNode(e)),i.appendChild(t),i}}class ez extends eb{#ee;constructor(e){super(e),this._element=this.buildElement(e.label),this.#ee.value=this.value,this._element.addEventListener("change",t=>{this.value=this.#ee.value,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-range",this.#ee=document.createElement("input"),this.#ee.setAttribute("type","range"),t.appendChild(this.#ee);let i=document.createElement("label");return i.appendChild(document.createTextNode(e)),i.appendChild(t),i}}const e_={TEXT_BUTTON:"text button",CHECKBOX:"checkbox",RANGE:"range"};function eG(e,t){let i=document.createElement(e);return t.className&&(i.className=t.className),t.html?i.innerHtml=t.html:t.text&&(i.innerText=t.text),t.child&&i.appendChild(t.child),i}function eU(e){let i=t.get(e);return null==i?e:Array.isArray(i)?i[S(0,i.length)]:i}function eH(e,...t){let i,r="";for(let t of e){let e=t.trim();if(""!==e){i=e;break}}return i?(r=eU(i),t.forEach((e,t)=>{let i=`\${${t}}`;r=r.replace(i,e)}),r):t?t.join(" "):""}const eF={setMap:function(e){t=e},getText:eU},eW={OK:0};function e$(e){let t=eG("div",{className:"dialog-scroll-content"});return t.innerText=e,t.classList.add(["scrollable"]),t}function eV(e,t){let i=document.createElement("div"),r=eG("div",{className:"dialog-scroll-content"});i.appendChild(r),t?.preamble&&r.appendChild(eG("p",{text:t.preamble})),e instanceof Element?r.appendChild(e):r.appendChild(e$(e));let n=eG("div",{className:t?.row?"action-buttons-row":"action-buttons-col"});i.appendChild(n);let s=[];if(t?.actionButtons?.forEach(e=>{n.appendChild(e.element),null!==e.closes&&void 0!==e.closes&&s.push({element:e.element,closes:e.closes})}),0===s.length){let e=new eD({id:eW.OK,label:eH`BUTTON OK`});n.appendChild(e.element),s.push(e)}return K.displayOnGlass(i,s,t?.className)}var eK={showChoiceDialog:function(e,t,i){let r=document.createElement("div");e&&r.appendChild(eG("p",{text:e})),r.appendChild(eG("p",{text:t}));let n=[];return i?.forEach((e,t)=>{let i=new eD({label:e,closes:t});n.push(i)}),eV(t,{preamble:e,actionButtons:n,row:!0})},showMessage:function(e){let t=document.createElement("div");t.appendChild(document.createTextNode(e)),t.className="popup",t.style.opacity=1,document.body.appendChild(t),t.addEventListener("click",()=>t.remove())},showOkDialog:function(e,t){let i=document.createElement("div");i.appendChild(e$(e));let r=document.createElement("button");return r.appendChild(document.createTextNode(t?.okButtonLabel??eH`BUTTON OK`)),i.appendChild(r),K.displayOnGlass(i,[{element:r,closes:eW.OK}],t?.className)},showElementOkDialog:function(e,t,i="BUTTON OK",r){let n=document.createElement("div"),s=eG("div",{className:"dialog-scroll-content"});n.appendChild(s),e&&s.appendChild(eG("p",{text:e})),s.appendChild(t);let o=document.createElement("button");return o.appendChild(document.createTextNode(i)),n.appendChild(o),K.displayOnGlass(n,[{element:o,closes:eW.OK}],r)},showControlsDialog:eV};const eq=new class{#et;#ei;#er;#en;constructor(){this.#er=.5,this.#en=.5,this.#et=new Map}loadAndPlayMusic(e){if(this.#ei)throw Error("Only one music track currently supported.");this.#ei=this.#es(e),this.#ei&&this.#ei.addEventListener("canplay",e=>{this.#ei.volume=this.#er,this.#ei.loop=!0,this.#ei.play(),window.addEventListener("blur",()=>{this.#ei.pause()}),window.addEventListener("focus",()=>{this.#ei.play()})})}loadEffects(e){let t=[];return e.forEach((e,i)=>{let r=new Promise(t=>{let r=this.#es(e);r&&r.addEventListener("canplay",e=>{this.#et.set(i,r),t()})});t.push(r)}),Promise.all(t)}#es(e){return e?new Audio(e):null}playEffect(e){let t=this.#et.get(e);t&&(t.volume=this.#en,t.play())}setMusicVolumePercent(e){this.#er=e/100,this.#ei&&(this.#ei.volume=this.#er)}setEffectsVolumePercent(e){this.#en=e/100}},eY=/^ *(\d+(?:\.\d*)?) *([a-zA-Z]+) *$/,eX=new Map([["PP",10],["GP",1],["SP",.1],["CP",.01]]);function eZ(e){let t=0,i=0,r=e.match(eY);if(!r)return u.error(`Unrecognised coin "${e}". Value set to zero.`),{valueFace:0,valueGp:0,type:"GP"};{t=r[1];let e=eX.get(r[2])??0;i=parseFloat(r[1])*e}return{valueFace:t,valueGp:i,type:r[2]}}const ej=/(\d+)[dD](\d+)(?: *\+ *(\d+))?/;function eQ(e=6){return y(1,e)}function eJ(e){return ej.test(e)}function e4(e){if(!e)return 1;if(Number.isInteger(e))return eQ(e);let t=e1(e);if(!t)return u.error(`String ${e} not recognised as a dice roll. Defaulting to 1D1.`),1;let i=0;for(let e=0;e<t.qty;e++)i+=eQ(parseInt(t.sides))+t.offset;return i}function e0(e){let t=e1(e);return t?t.qty*(t.sides+t.offset):1}function e1(e){let t=e.match(ej);return t?{qty:parseInt(t[1]),sides:parseInt(t[2]),offset:t[3]?parseInt(t[3]):0}:(u.error(`Invalid dice format: ${e}`),null)}function e8(e){return e.offset?`${e.qty}D${e.sides}+${e.offset}`:`${e.qty}D${e.sides}`}const e2=[10,200,450,700,1100,1800,2300,2900,3900,5e3,5900,7200,8400,1e4,11500,13e3,15e3,18e3,2e4,22e3,25e3,33e3,41e3,5e4,62e3,75e3,9e4,105e3,12e4,135e3,155e3],e3=[{exp:0,profBonus:2},{exp:300,profBonus:2},{exp:900,profBonus:2},{exp:2700,profBonus:2},{exp:6500,profBonus:3},{exp:14e3,profBonus:3},{exp:23e3,profBonus:3},{exp:34e3,profBonus:3},{exp:48e3,profBonus:4},{exp:64e3,profBonus:4},{exp:85e3,profBonus:4},{exp:1e5,profBonus:4},{exp:12e4,profBonus:5},{exp:14e4,profBonus:5},{exp:165e3,profBonus:5},{exp:195e3,profBonus:5},{exp:225e3,profBonus:6},{exp:265e3,profBonus:6},{exp:305e3,profBonus:6},{exp:355e3,profBonus:6}];function e5(e,t,i){return{centre:e[t]?.[i],tl:e[t-1]?.[i-1],above:e[t-1]?.[i],tr:e[t-1]?.[i+1],right:e[t]?.[i+1],br:e[t+1]?.[i+1],below:e[t+1]?.[i],bl:e[t+1]?.[i-1],left:e[t]?.[i-1]}}function e6(e){let t,i=e.length;for(;i>0;)t=Math.floor(Math.random()*i),i--,[e[i],e[t]]=[e[t],e[i]];return e}const e7=["STR","DEX","CON","INT","WIS","CHA"];function e9(e){return Math.floor((e-10)/2)}class te{damageDice;proficiencyBonus;abilityModifier;twoWeaponFighting;isSecondAttack;unarmed;constructor(e){this.damageDice=e.damageDice??"1D1";let t=e.weaponType??"";"UNARMED"===t?(this.unarmed=!0,this.twoWeaponFighting=!1):t.includes("SIMPLE")&&t.includes("LIGHT")?this.twoWeaponFighting=!0:this.twoWeaponFighting=!1,this.proficiencyBonus=e?.proficiencyBonus??0,this.abilityModifier=e?.abilityModifier??0,this.isSecondAttack=e.secondAttack}#eo(){return 1+this.abilityModifier}getMaxDamage(){return this.unarmed?this.#eo():e0(this.damageDice)+this.proficiencyBonus}rollForAttack(){return eQ(20)+this.abilityModifier+this.proficiencyBonus}rollForDamage(){let e;return this.unarmed?this.#eo():(e=this.isSecondAttack&&this.abilityModifier>0?0:this.abilityModifier,e4(this.damageDice)+e)}clone(){let e=new te({});return e.abilityModifier=this.abilityModifier,e.damageDice=this.damageDice,e.isSecondAttack=this.isSecondAttack,e.proficiencyBonus=this.proficiencyBonus,e.twoWeaponFighting=this.twoWeaponFighting,e.unarmed=this.unarmed,e}}class tt{_traits;constructor(e){"string"==typeof e?(this._traits=new Map,this.#ea(e)):this._traits=new Map(e)}#ea(e){return e.split(",").forEach(e=>{let t=e.match(/^\s*(\w+)\s*[=: ]\s*(.+?)\s*$/);if(!t)return;let[i,r]=this.#el(t[1],t[2]);if(t)this.#eh(i,r.trim());else throw Error(`Invalid property definition'${e}'`)}),this._compositeAc=this.getInt("AC",0),this}set(e,t){this._traits.set(e,t),this._refreshDerivedValues(e)}get(e,t){return this._traits.get(e)??this._traits.get("_"+e)??t}_refreshDerivedValues(e){}getInt(e,t){return E(this.get(e,t),t)}getAsModifier(e,t){let i=this.getInt(e);return null==i?t:e9(i)}#el(e,t){return"NAME"!==(e=e.toUpperCase())&&(t=t.toUpperCase()),[e,t]}#eh(e,t){switch(e){case"PROF":return this.#ec(e,t);case"COST":return this.#eu(e,t);case"DMG":return this.#ed(e,t);case"HIT_DICE":return this.#ep(e,t);default:return this.#ef(e,t)}}#eu(e,t){let i=t.match(/^(.*)([a-zA-Z]{2})$/);if(i){let e;let r=i[1].trim();e=eJ(r)?e4(r):E(i[1],0),t=`${e} ${i[2]}`}else u.error(`Invalid value for COST trait: ${t}`),t="0 GP";this.set(e,t)}#ep(e,t){eJ(t)||(u.error(`Invalid trait value ${t} for ${e}. Dice definition required.`),t="1D6"),this.set(e,t)}#ed(e,t){!eJ(t)&&isNaN(parseInt(t))&&(u.error(`Invalid trait value ${t} for ${e}. Integer or dice definition required.`),t="0"),this.set(e,t)}#ef(e,t){eJ(t)&&"DMG"!==e&&(t=e4(t)),this.set(e,t)}#ec(e,t){let i=t.split(/\s*&\s*/),r=[];i.forEach(e=>r.push(e.toUpperCase())),this._traits.set("PROF",r)}clone(){return new tt(this._traits)}getAllTraits(){return new Map([...this._traits.entries()].sort())}}class ti extends tt{_compositeAc;_proficiencyBonus;_level;_attacks;_equippedWeapons;_equippedArmour;constructor(e){super(e??new Map([["NAME","mystery"]])),this._proficiencyBonus=0,this.#em(e7),this.#eg(),this._refreshDerivedValues()}clone(){let e=super.clone();return e._compositeAc=this._compositeAc,e._proficiencyBonus=this._proficiencyBonus,e._level=this._level,e._attacks=this._attacks.map(e=>e.clone()),e._equippedWeapons=this._equippedWeapons,e._equippedArmour=this._equippedArmour,e}#em(e){let t=e6([15,14,13,12,10,8]),i=0;e.forEach(e=>{if(!this.get(e)){let r=t[i++]??8;this.set(e,r)}})}#eg(){let e=this._traits.has("HP"),t=this._traits.has("HP_MAX");if(e&&t)return;let i=this.get("HIT_DICE");if(i){let r=e9(this.getInt("CON",0));t||this.set("HP_MAX",e0(i)+r),e||this.set("HP",e0(i)+r)}else e&&this.set("HP_MAX",this.get("HP"))}getEffectiveAc(){return this._compositeAc}getCharacterLevel(){return this._level}getAttacks(){return this._attacks}utiliseArtefacts(e){this._equippedWeapons=e.filter(e=>e.artefactType===tn.WEAPON),this._equippedArmour=e.filter(e=>e.artefactType===tn.ARMOUR),this._refreshDerivedValues()}_refreshDerivedValues(e){(!e||e7.includes(e))&&(this._setLevelAndProfBonusFromExp(),this._utiliseWeapons(this._equippedWeapons),this._utiliseArmour(this._equippedArmour))}_utiliseArmour(e){let t=this.getInt("AC",0);if(!e||0===e.length){this._compositeAc=t;return}let i=this.getInt("DEX",1),r=0,n=0;for(let s of e)switch(s.artefactType){case tn.ARMOUR:{let e=s.traits.get("AC",0),n=function(e,t){let i=e9(t),r=e.traits.get("TYPE","").toLowerCase(),n=e.traits.getInt("AC",0);return r.includes("HEAVY")?n:r.includes("MEDIUM")?n+Math.min(2,i):n+i}(s,i);e.startsWith("+")?r+=n:n>t&&(t=n)}break;case tn.SHIELD:n=Math.max(n,s.traits.getInt("AC",0))}this._compositeAc=t+r+n}_utiliseWeapons(e=[]){let t,i,r,n,s;this._attacks=[];let o=this.getInt("STR",1),a=e9(o);e.length>2&&u.error(`Unexpected number of equipped weapons. Expected 2; received ${e.length}`),0===e.length?(r="",i="UNARMED",n=!0):(r=e[0].traits.get("DMG","1D1")??"1D1",i=e[0].traits.get("TYPE")??"",n=this.isProficient(e[0])),t=new te({damageDice:r,weaponType:i,proficiencyBonus:n?this._proficiencyBonus:0,abilityModifier:a,secondAttack:!1}),e.length>1&&(s=new te({damageDice:e[1].traits.get("DMG","1D1")??"1D1",weaponType:e[1].traits.get("TYPE")??"",proficiencyBonus:this.isProficient(e[1])?this._proficiencyBonus:0,abilityModifier:o,secondAttack:!0})),s?.twoWeaponFighting&&t.twoWeaponFighting?(this._attacks.push(t),this._attacks.push(s)):s&&s.getMaxDamage()>t.getMaxDamage()?(s.isSecondAttack=!1,this._attacks.push(s)):this._attacks.push(t)}_setLevelAndProfBonusFromExp(){let e=function(e){let t=E(e,0),i=0,r=0;do if(t>=e3[r++].exp)i=r;else break;while(r<e3.length)return{level:i,profBonus:e3[i-1].profBonus}}(this._traits.get("EXP"));this._level=e.level,this._proficiencyBonus=e.profBonus}adjustForDefeatOfActor(e){let t;let i=(t=function(e,t=0){let i=parseFloat(e);return Number.isNaN(i)?t:i}(e.traits.get("CR")))<.124?10:t<.249?25:t<.499?50:t<.999?100:(t=Math.min(e2.length-1,parseInt(t)),e2[t]),r=this.getInt("EXP",0),n=r+i;u.info(`Experience increased from ${r} to ${n}.`),this.set("EXP",n),this._setLevelAndProfBonusFromExp()}isProficient(e){let t=this._traits.get("PROF"),i=e.traits.get("TYPE");for(let e of t){let t=e.split(" "),r=!0;for(let e of t)if(!i.includes(e)){r=!1;break}if(r)return!0}return!1}}const tr={HEAD:{id:"HEAD",space:1,money:!1,spacesExpand:!1},BODY:{id:"BODY",space:1,money:!1,spacesExpand:!1},HANDS:{id:"HANDS",space:2,money:!1,spacesExpand:!1},FEET:{id:"FEET",space:2,money:!1,spacesExpand:!1},BACKPACK:{id:"BACKPACK",space:8,money:!1,spacesExpand:!0},WAGON:{id:"WAGON",space:8,money:!1,spacesExpand:!0},PURSE:{id:"PURSE",space:Number.MAX_SAFE_INTEGER,money:!0,spacesExpand:!1}},tn={ARMOUR:{storageSpace:1,storeType:{stash:tr.WAGON,equip:tr.BODY}},FOOD:{storageSpace:1,storeType:{stash:tr.BACKPACK}},SPELL:{storageSpace:1,storeType:{stash:tr.BACKPACK}},WEAPON:{storageSpace:1,storeType:{stash:tr.BACKPACK,equip:tr.HANDS}},SHIELD:{storageSpace:1,storeType:{stash:tr.BACKPACK,equip:tr.HANDS}},TWO_HANDED_WEAPON:{storageSpace:2,storeType:{stash:tr.BACKPACK,equip:tr.HANDS}},HEAD_GEAR:{storageSpace:1,storeType:{stash:tr.BACKPACK,equip:tr.HEAD}},COINS:{storageSpace:0,storeType:{stash:tr.PURSE}}};class ts{#ew;#eS;#ey;#eE;#eT;constructor(e,t,i){this.#ew=e,this.#ey=0,this.#eS=new Map,this.#eE=t,this.#eT=i}get storeType(){return this.#eT}get freeSpace(){return this.#ew-this.#ey}get maxSpace(){return this.#ew}isEmpty(){return 0===this.#ey}getRequiredSpace(e){return this.#eE?1:e.storageSpace}has(e){return this.#eS.has(e)}add(e){let t=this.#ew-this.#ey,i=this.getRequiredSpace(e);return t>=i&&(this.#eS.set(e,e),this.#ey+=i,!0)}take(e){let t=this.#eS.get(e),i=this.getRequiredSpace(e);return t&&(this.#ey-=i,this.#eS.delete(t)),t}takeFirst(){if(this.isEmpty())return null;let e=this.#eS.values().next().value;return this.take(e)}values(){return this.#eS.values()}canAdd(e){let t=this.getRequiredSpace(e);return this.#ew-this.#ey>=t}}class to{#ex;#eA;constructor(){this.#eA=!1}get storeType(){return tr.PURSE}isEmpty(){return!this.#ex||0===this.#ex.costInGp}has(e){return this.#ex.costInGp>0}add(e){let t=e.costDetails;if(!this.#ex)return this.#ex=e.clone(),!0;let i=this.#ex.costDetails;return this.#eA||(this.#ex=to.createGoldCoinArtefact(i.valueGp),this.#eA=!0),this.#ex.costInGp=i.valueGp+t.valueGp,!0}take(e){let t=Math.min(this.#ex.costInGp,e.costInGp);return this.#ex.costInGp=this.#ex.costInGp-t,e.costInGp=t,e}canAdd(e){return!0}values(){return this.#ex&&0!==this.#ex.costInGp?[this.#ex.clone()].values():[].values()}static createGoldCoinArtefact(e){let t=new ta("coins",eH`DESCRIPTION COINS`,"coins.png",tn.COINS);return t.traits=new tt([["NAME","Coins"]]),t.costInGp=e,t}}class ta{id;iconImageName;description;artefactType;traits;constructor(e,t,i,r){this.id=e,this.description=t,this.iconImageName=i,this.artefactType=r}get costDetails(){return eZ(this.traits?.get("COST"))}get costInGp(){return eZ(this.traits?.get("COST")).valueGp}get sellBackPriceInGp(){return this.artefactType===tn.COINS?this.costInGp:Math.round(75*this.costInGp)/100}set costInGp(e){if(!this.traits)throw Error("Artefact has no traits so cannot set cost.");this.traits.set("COST",`${e.toFixed(2)} GP`)}get storageSpace(){return this.artefactType.storageSpace}get stashStoreType(){return this.artefactType.storeType.stash}get equipStoreType(){return this.artefactType.storeType.equip}get stashInWagon(){return this.stashStoreType===tr.WAGON}getDefaultStoreType(){return this.artefactType.storeType.stash??this.artefactType.storeType.equip}getStoreTypes(){let e=[];return this.artefactType.storeType.stash&&e.push(this.artefactType.storeType.stash),this.artefactType.storeType.equip&&e.push(this.artefactType.storeType.equip),e}clone(){let e=new ta(this.id,this.description,this.iconImageName,this.artefactType);return e.traits=this.traits.clone(),e.value=this.value,e}}class tl{#eC;#eO;#eI;constructor(e,t){for(let t in this.#eC=new Map,this.#eO=e,tr){let e=tr[t];this.#ev(e)}this.#eI=t}get hasWagon(){return this.#eO}#eP(){this.#eI&&this.#eI()}#ev(e){if(e.money)return this.#eC.set(e,new to(e.space,e.spacesExpand));let t=!0;this.#eO&&e===tr.BACKPACK?t=!1:this.#eO||e!==tr.WAGON||(t=!1),t&&this.#eC.set(e,new ts(e.space,e.spacesExpand,e))}getStore(e){return this.#eO&&e===tr.BACKPACK&&(e=tr.WAGON),this.#eC.get(e)}findSuitableStore(e){let t=e.stashStoreType;this.#eC.has(t)||(t=e.equipStoreType);let i=this.getStore(t);return i?.canAdd(e)?i:null}addArtefact(e){let t=this.getStore(e.getDefaultStoreType()),i=t?.add(e);return this.#eP(),i}getFirstStorageDetails(){for(let e of this.#eC.values()){let t=e.values(),i=t.next()?.value;if(i)return{store:e,artefact:i}}return null}getAllEquippedArtefacts(){let e=[];for(let t of[this.#eC.get(tr.HEAD),this.#eC.get(tr.BODY),this.#eC.get(tr.HANDS),this.#eC.get(tr.FEET)])t.values().forEach(t=>e.push(t));return e}getAllStorageDetails(){let e=[];return this.#eC.values().forEach(t=>{t.values().forEach(i=>{e.push({store:t,artefact:i})})}),e}getPurseValue(){let e=this.getStore(tr.PURSE).values(),t=e.next()?.value;return t?t.costInGp:0}addToPurse(e){let t=to.createGoldCoinArtefact(e);this.#eC.get(tr.PURSE).add(t),this.#eP()}takeFromPurse(e){let t=to.createGoldCoinArtefact(e),i=this.#eC.get(tr.PURSE).take(t);return this.#eP(),i.costInGp}getStoreContents(e){let t=this.getStore(e);return!t||t.isEmpty()?null:t.values()}discard(e){return!!this.discardStashed(e,!0)||this.discardEquipped(e)}discardEquipped(e,t){let i=this.getStore(e.equipStoreType);return i?i.take(e)?(this.#eP(),!0):(t||u.error("Artefact could not be found so not discarded."),!1):(t||u.error("Cannot discard artefact as there isn't an equip store."),!1)}discardStashed(e,t){let i=this.getStore(e.stashStoreType);return i?i.take(e)?(this.#eP(),!0):(t||u.error("Artefact could not be found so not discarded."),!1):(t||u.error("Cannot discard artefact as there isn't a stash store."),!1)}equip(e,t={}){let i=this.getStore(e.stashStoreType),r=this.getStore(e.equipStoreType);if(!i&&!t.direct)return u.error("Cannot equip artefact as there isn`t a stash store to take it from."),!1;if(!r)return u.error("Cannot equip artefact as there isn't an equip store."),!1;let n=e.storageSpace;if(n>r.maxSpace)return u.error("The equip store cannot hold this item."),!1;if(!i?.take(e)&&!t.direct)return u.error("Could not find artefact in the stash."),!1;for(;r.freeSpace<n;){let e=r.takeFirst();i?.add(e)}let s=r.add(e);return this.#eP(),s}stash(e,t={}){let i=this.getStore(e.stashStoreType),r=this.getStore(e.equipStoreType);if(!i)return u.info("Cannot stash artefact as there isn`t a suitable stash store to put it in."),!1;if(!r&&!t.direct)return u.error("No suitable equip store found. If stashing a new artefact, the direct option should be set."),!1;if(e.storageSpace>i.freeSpace)return u.error("The stash store cannot hold this item."),!1;if(!r?.take(e)&&!t.direct)return u.error("The artefact hasn't been equipped so can't unequip it."),!1;let n=i.add(e);return this.#eP(),n}}const th={WALL:["#","*","|"],DOOR_IN:["-"],DOOR_OUT:["="],GROUND:[".",":",",",";"],VOID:[" "]},tc={TOP_LEFT:"-TL",TOP_LEFT_INTERNAL:"-TLI",TOP:"-T",TOP_RIGHT:"-TR",TOP_RIGHT_INTERNAL:"-TRI",RIGHT:"-R",BOTTOM_RIGHT:"-BR",BOTTOM_RIGHT_INTERNAL:"-BRI",BOTTOM:"-B",BOTTOM_LEFT:"-BL",BOTTOM_LEFT_INTERNAL:"-BLI",LEFT:"-L",TOP_TEE:"-TTEE",RIGHT_TEE:"-RTEE",BOTTOM_TEE:"-BTEE",LEFT_TEE:"-LTEE",INTERNAL_CROSS:"-XI",INTERNAL_VERTICAL:"-VI",INTERNAL_HORIZONTAL:"-HI"},tu={BELOW_WALL:"-SBW",BELOW_END_WALL:"-SBE"};class td{matrix;entryPointByDoor;exitPointByDoor;constructor(){this.entryPointByDoor=new T(0,0),this.exitPointByDoor=new T(0,0)}static generateTileMapPlan(e,t){let i=new td,r=i.convertToMatrix(e);return r=i.clarifyMatrix(r),i.createPlan(r,t),i}convertToMatrix(e){let t=[],i=0;return e.forEach(e=>{i=Math.max(i,e.length)}),e.forEach(e=>{e.length<i&&(e+=" ".repeat(i-length)),t.push(e.split(""))}),t}clarifyMatrix(e){let t=[];return e.forEach((i,r)=>{let n=[];t.push(n),i.forEach((t,i)=>{var s,o,a,l;let h;let c=e5(e,r,i);(s=t,th.VOID.includes(s))?t=" ":tm(t)?(o=t,tg(c.above)&&(tg(c.tl)?o+=tu.BELOW_WALL:o+=tu.BELOW_END_WALL),a=t=o,tp(c.left)||tp(c.above)||tp(c.right)||tp(c.below))?this.entryPointByDoor=new T(i,r):(tf(c.right)||tf(c.below)||tf(c.left)||tf(c.above))&&(this.exitPointByDoor=new T(i,r)):tg(t)&&(h=l=t,tg(c.above)&&tg(c.right)&&tg(c.below)&&tg(c.left)?h+=tc.INTERNAL_CROSS:tm(c.left)&&tm(c.right)?h+=tc.INTERNAL_VERTICAL:tm(c.above)&&tm(c.below)?h+=tc.INTERNAL_HORIZONTAL:tg(c.left)&&tg(c.right)&&tg(c.below)?h+=tc.TOP_TEE:tg(c.above)&&tg(c.below)&&tg(c.left)?h+=tc.RIGHT_TEE:tg(c.left)&&tg(c.right)&&tg(c.above)?h+=tc.BOTTOM_TEE:tg(c.above)&&tg(c.below)&&tg(c.right)?h+=tc.LEFT_TEE:tg(c.right)&&tg(c.below)?h+=tm(c.br)?tc.TOP_LEFT:tc.TOP_LEFT_INTERNAL:tg(c.left)&&tg(c.below)?h+=tm(c.bl)?tc.TOP_RIGHT:tc.TOP_RIGHT_INTERNAL:tg(c.left)&&tg(c.above)?h+=tm(c.tl)?tc.BOTTOM_RIGHT:tc.BOTTOM_RIGHT_INTERNAL:tg(c.right)&&tg(c.above)?h+=tm(c.tr)?tc.BOTTOM_LEFT:tc.BOTTOM_LEFT_INTERNAL:tg(c.above)&&tg(c.below)?h+=tm(c.right)?tc.LEFT:tc.RIGHT:tg(c.right)&&tg(c.left)&&(h+=tm(c.below)?tc.TOP:tc.BOTTOM),t=tg(c.above)?h+tu.BELOW_WALL:h),n.push(t)})}),t}createPlan(e,t){let i=[];e.forEach(e=>{let r=[];i.push(r),e.forEach(e=>{r.push(function e(t,i){if(" "===t)return null;let r=t.match(/(.)(-[^-]*)?(-[^-]*)?/),n=i.get(t);if(!n&&r[2]&&r[3]&&(n=i.get(`${r[1]}${r[2]}`)),!n&&r[2]&&(n=i.get(r[1])),!n){let n=function(e){for(let t in th)if(th[t].includes(e))return th[t][0];return null}(r[1]);if(n&&n!==r[1]){var s,o;let t;return e((s=r[2],o=r[3],t=n,s&&(t+=s),o&&(t+=o),t),i)}u.error(`Failed to find symbol for ${t}`)}return n}(e,t))})}),this.matrix=i}}function tp(e){return th.DOOR_IN.includes(e)}function tf(e){return th.DOOR_OUT.includes(e)}function tm(e){return th.GROUND.includes(e)}function tg(e){var t;return th.WALL.includes(e)||tp(t=e)||tf(t)}class tw{#eR;#eN;#eM;#eb;setOnClick(e){this.#eR=e}setOnContextClick(e){this.#eN=e}setOnPointerDown(e){this.#eM=e}setOnPointerUp(e){this.#eb=e}actionClick(e){this.#eR?.(this,e)}actionContextClick(e){this.#eN?.(this,e)}actionPointerDown(e){this.#eM?.(this,e)}actionPointerUp(e){this.#eb?.(this,e)}}class tS{#eD;#eL;constructor(e){this.#eL=e,this.#eD=new Map}setRouteToCoords(e,t,i){this.#eD.set(this.coordsToKey(t,i),e)}getRouteToCoords(e,t){return this.#eD.get(this.coordsToKey(e,t))}hasRouteToCoords(e,t){return this.#eD.has(this.coordsToKey(e,t))}coordsToKey(e,t){return`${e}|${t}`}keyToGridPoint(e){let t=e.split("|");return new T(parseInt(t[0]),parseInt(t[1]))}forEach(e){this.#eD.forEach((t,i,r)=>e(t,i,r))}containsGridPoint(e){return this.#eD.has(this.coordsToKey(e.x,e.y))}getWaypointsAsGridPoints(e){let t=this.getRouteToCoords(e.x,e.y);return t&&t.length>1?t.slice(1):null}getWaypointsAsWorldPoints(e){let t=this.getWaypointsAsGridPoints(e);return t?t.map(e=>this.#eL.gridPointToWorldPoint(e)):t}}class ty{actor;#eD;#eL;#ek;constructor(e,t){this.#eL=e,this.actor=t}getDumbRouteNextTo(e,t,i){let r=this.#eB(e,t);if(r.coincident(e))return[];this.#eL.canGridPointBeOccupiedByActor(r,this.actor)||(r=this.#ez(r,t));let n=[],s=Math.sign(r.x-e.x),o=Math.sign(r.y-e.y),a=T.copy(e),l=.5>Math.random(),h=0;for(;i>0;){let t=T.copy(a),c=!1;if(l&&0!==s&&a.x!=r.x?(t.x+=s,c=!0):l||0===o||a.y==r.y||(t.y+=o,c=!0),c=c&&this.#eL.canGridPointBeOccupiedByActor(t,this.actor))h=0,a=t,i--;else{if(++h>=2)break;a.coincident(e)||n.push(this.#eL.gridPointToWorldPoint(a)),e=a,l=!l}}return a.coincident(e)||n.push(this.#eL.gridPointToWorldPoint(a)),n}getAllRoutesFrom(e,t){return this.#eD=new tS(this.#eL),this.#ek=e,this.#e_(e.x,e.y,t,null),this.#eD}#e_(e,t,i,r){if(r){if(e===this.#ek.x&&t===this.#ek.y||!this.#eG(e,t))return;let n=this.#eD.getRouteToCoords(e,t);if(n&&!(r.length<n.length-1))return;r.push(new T(e,t)),this.#eU(e,t)&&this.#eD.setRouteToCoords(r,e,t),i--}else r=[new T(e,t)];i>0&&(this.#e_(e,t-1,i,[...r]),this.#e_(e+1,t,i,[...r]),this.#e_(e,t+1,i,[...r]),this.#e_(e-1,t,i,[...r]))}#eG(e,t){return this.#eL.isGridPointPassableByActor(new T(e,t),this.actor)}#eU(e,t){return this.#eL.canGridPointBeOccupiedByActor(new T(e,t),this.actor)}#eB(e,t){let i=t.x-e.x,r=t.y-e.y,n=t.x,s=t.y;return Math.abs(i)>Math.abs(r)?n-=Math.sign(i):s-=Math.sign(r),new T(n,s)}#ez(e,t){return e.x===t.x&&e.y<t.y?new T(e.x+1,e.y+1):e.x>t.x&&e.y===t.y?new T(e.x-1,e.y+1):e.x===t.x&&e.y>t.y?new T(e.x-1,e.y-1):e.x<t.x&&e.y===t.y?new T(e.x+1,e.y-1):e}}class tE{#eH;#eF;#eL;#eW;#e$;#eV;#eK;constructor(e,t){this.#eL=e,this.#eH=t}findReachedTiles(){return this.#eF=this.#eL.worldPointToGrid(this.#eH.position),this.#eV=this.#eL.getMapGridPointRect(),this.#e$&&this.#e$.coincident(this.#eF)&&this.#eV&&this.#eV.equals(this.#eK)||(this.#eW=new Map,this.#eW.set(this.#eF.toString(),this.#eF),this.#eq().forEach(e=>{this.#eY(e)}),this.#e$=this.#eF,this.#eK=this.#eV),this.#eW}isGridPointInRays(e){return!!this.#eW&&this.#eW.has(e.toString())}#eq(){let e=[];for(let t=this.#eV.x;t<=this.#eV.x+this.#eV.width;t++)e.push(new T(t,this.#eV.y)),e.push(new T(t,this.#eV.y+this.#eV.height));for(let t=this.#eV.y+1;t<=this.#eV.y+this.#eV.height-1;t++)e.push(new T(this.#eV.x,t)),e.push(new T(this.#eV.x+this.#eV.width,t));return e}#eY(e){let t,i,r;let n=function(e){let t=Math.abs(e);return t<=m.DEG_22_5?w.E:t<=m.DEG_67_5?Math.sign(e)>0?w.NE:w.SE:t<=m.DEG_112_5?Math.sign(e)>0?w.N:w.S:t<=m.DEG_157_7?Math.sign(e)>0?w.NW:w.SW:w.W}(this.#eF.getScreenAngleTo(e));Math.abs(e.x-this.#eF.x)>=Math.abs(e.y-this.#eF.y)?(t=Math.sign(e.x-this.#eF.x),i=(r=Math.abs(e.x-this.#eF.x))<1?0:(e.y-this.#eF.y)/r):(i=Math.sign(e.y-this.#eF.y),t=(r=Math.abs(e.y-this.#eF.y))<1?0:(e.x-this.#eF.x)/r);let s=this.#eF.x,o=this.#eF.y,a=!0;for(;r>=0;){let e=new T(Math.round(s),Math.round(o));if(a||this.#eL.isSeeThrough(e,this.#eH))this.#eX(e,n);else break;a=!1,s+=t,o+=i,r--}}#eX(e,t){switch(this.#eW.set(e.toString(),e),t){case w.N:this.#eZ(new T(e.x-1,e.y-1)),this.#eZ(new T(e.x,e.y-1)),this.#eZ(new T(e.x+1,e.y-1));break;case w.NE:this.#eZ(new T(e.x,e.y-1)),this.#eZ(new T(e.x+1,e.y-1)),this.#eZ(new T(e.x+1,e.y));break;case w.E:this.#eZ(new T(e.x+1,e.y-1)),this.#eZ(new T(e.x+1,e.y)),this.#eZ(new T(e.x+1,e.y+1));break;case w.SE:this.#eZ(new T(e.x+1,e.y)),this.#eZ(new T(e.x+1,e.y+1)),this.#eZ(new T(e.x,e.y+1));break;case w.S:this.#eZ(new T(e.x-1,e.y+1)),this.#eZ(new T(e.x,e.y+1)),this.#eZ(new T(e.x+1,e.y+1));break;case w.SW:this.#eZ(new T(e.x-1,e.y)),this.#eZ(new T(e.x-1,e.y+1)),this.#eZ(new T(e.x,e.y+1));break;case w.W:this.#eZ(new T(e.x-1,e.y-1)),this.#eZ(new T(e.x-1,e.y)),this.#eZ(new T(e.x-1,e.y+1));break;case w.NW:this.#eZ(new T(e.x-1,e.y)),this.#eZ(new T(e.x-1,e.y-1)),this.#eZ(new T(e.x,e.y-1))}}#eZ(e){this.#eL.isSeeThrough(e)||this.#eW.set(e.toString(),e)}}const tT={MOVEMENT_TILE:0,INTERACT_TILE:1,OCCUPIED_TILE:2,MOVE_OR_INTERACT_TILE:4},tx={OBSTACLE:-1,GROUND:0,ENTRANCE:1,EXIT:2};class tA extends tw{sprite;obstacle;#ej;#eQ;#eJ;#e4;constructor(e,t){super(),this.sprite=e,this.#ej=new Map,this.obstacle=t.obstacle,this.#eQ=t.gridPoint,this.#eJ=t.worldPoint,this.#e4=t.role}get role(){return this.#e4}get gridPoint(){return this.#eQ}get worldPoint(){return this.#eJ}addOccupant(e){this.#ej.set(e,e)}deleteOccupant(e){this.#ej.delete(e)}getOccupants(){return this.#ej}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionClick(this.sprite.position)}isOccupied(){return this.#ej.size>0}isPassableByActor(e){if(this.#e4===tx.ENTRANCE||this.#e4===tx.EXIT||this.obstacle)return!1;for(let t of this.#ej.values())if(t!==e&&!t.isPassableByActor(e))return!1;return!0}canBeOccupiedByActor(e){if((this.#e4===tx.ENTRANCE||this.#e4===tx.EXIT)&&!e.isHero()||this.obstacle)return!1;for(let t of this.#ej.values())if(t!==e&&!t.canShareLocationWithActor(e))return!1;return!0}isSeeThrough(e){return!this.obstacle&&this.#e4!==tx.ENTRANCE&&this.#e4!==tx.EXIT}}class tC{#e0;#e1;#e8;#e2;#e3;#y;#E;#e5;#e6;#e7;#e9;#te;#tt;#ti;#tr;#tn;#ts;#to;#ta;#tl;#th;constructor(e,t,i,r){this.#th=r;let n=t.matrix;this.#tr=t.entryPointByDoor,this.#tn=t.exitPointByDoor,this.#e0=e,this.#e7=new ey({renderer:new em(e,{width:i,height:i,fillStyle:"rgba(255, 255, 255, 0.2)",strokeStyle:"white"})}),this.#e9=new ey({renderer:new em(e,{width:i,height:i,fillStyle:"rgba(0, 255, 0, 0.2)",strokeStyle:"green"})}),this.#tl=new ey({renderer:new em(e,{width:i,height:i,fillStyle:"rgba(255, 0, 0, 0.2)",strokeStyle:"red"})}),this.#e3=i,this.#e1=[],this.#e2=n.length,this.#e8=n[0].length,this.#y=i*this.tilesX,this.#E=i*this.tilesY,this.#ts=[],n.forEach((t,i)=>{let r=[];this.#e1.push(r),t.forEach((t,n)=>{if(t){let s=new ey({renderer:new eS(e,eo.getSpriteBitmap(t.image))}),o=new T(n,i),a=this.gridPointToWorldPoint(o),l=new tA(s,{obstacle:t.role===tx.OBSTACLE,gridPoint:o,worldPoint:a,role:t.role});t.onClick&&l.setOnClick((e,i)=>this.#tc(e,i,t.onClick)),this.processTileRole(l),r.push(l),s.position.x=n*this.#e3+this.#e3/2,s.position.y=i*this.#e3+this.#e3/2}else r.push(null)})}),this.#tt||(u.error("No entrance has been set. Setting to the first ground tile"),this.#tt=this.#ts[0])}getDimsInTiles(){return{width:this.#e8,height:this.#e2}}processTileRole(e){switch(e.role){case tx.ENTRANCE:if(this.#tt){let t=e.gridPoint;u.error(`Duplicate entrance found at (${t.x}, ${t.y}). Ignored.`)}else this.#tt=e;break;case tx.EXIT:if(this.#ti){let t=e.gridPoint;u.error(`Duplicate exit found at (${t.x}, ${t.y}). Ignored.`)}else this.#ti=e;break;case tx.GROUND:e.gridPoint.coincident(this.#tr)||this.#ts.push(e)}}update(e){this.#tu();let t=this.getVisibleGridPointRect();for(let i=t.y;i<=t.y+t.height;i++)for(let r=t.x;r<=t.x+t.width;r++)if(this.#to?.isGridPointInRays(new T(r,i))){let t=this.#e1[i][r];t?.sprite.update(e)}this.#td(e)}#tu(){if(this.#th){this.#to||(this.#to=new tE(this,this.#th));let e=this.getTileAtWorldPoint(this.#th.position);if(e){let t=e.role;t!=tx.ENTRANCE&&t!=tx.EXIT&&this.#to.findReachedTiles()}}}getMapGridPointRect(){return new C(0,0,this.#e8,this.#e2)}getVisibleGridPointRect(){let e=K.getWorldInCanvasBounds(),t=this.worldPointToGrid(new T(e.x,e.y)),i=this.worldPointToGrid(new T(e.x+e.width,e.y+e.height)),r=Math.max(0,t.x),n=Math.min(this.#e8-1,i.x),s=Math.max(0,t.y);return new C(r,s,n-r,Math.min(this.#e2-1,i.y)-s)}getGridSize(){return this.#e3}getDimensions(){return{width:this.#y,height:this.#E}}getTileAtWorldPoint(e){let t=this.worldPointToGrid(e);return this.getTileAtGridPoint(t)}getTileAtGridPoint(e){if(!e)return null;let t=e.y,i=e.x;return i>=0&&t>=0&&i<this.#e8&&t<this.#e2?this.#e1[t][i]:null}worldPointToGrid(e){return new T(Math.floor(e.x/this.#e3),Math.floor(e.y/this.#e3))}gridAlignedWorldPoint(e){let t=this.worldPointToGrid(e);return this.gridPointToWorldPoint(t)}gridPointToWorldPoint(e){let t=.5*this.#e3;return new T(e.x*this.#e3+t,e.y*this.#e3+t)}getWorldPositionOfTileByEntry(){return this.gridPointToWorldPoint(this.#tr)}getGridPositionOfEntrance(){return this.#tt.gridPoint}setMovementRoutes(e){this.#e5=e,e?(this.#e6=new Map,this.#e5.forEach(e=>e.forEach(e=>{this.#e6.set(e,e)}))):this.#e6=null}setInteractActors(e){this.#ta=[],e?.forEach(e=>{e.interaction.canReact()&&this.#ta.push(this.worldPointToGrid(e.position))})}calcReachableDoors(e){this.#te=[];let t=this.getSurroundingTiles(this.worldPointToGrid(e));[t.above,t.right,t.below,t.left].forEach(e=>{e.gridPoint.coincident(this.#ti.gridPoint)?this.#te.push(e.gridPoint):e.gridPoint.coincident(this.#tt.gridPoint)&&this.#te.push(e.gridPoint)})}#td(e){this.#tp(e),this.#tf(e),this.#tm(e)}#tp(e){this.#e6?.forEach(t=>{this.#e7.position=this.gridPointToWorldPoint(t),this.#e7.update(e)})}#tf(e){this.#ta?.forEach(t=>{this.#tl.position=this.gridPointToWorldPoint(t),this.#tl.update(e)})}#tm(e){this.#te?.forEach(t=>{this.#e9.position=this.gridPointToWorldPoint(t),this.#e9.update(e)})}#tc(e,t,i){let r=this.worldPointToGrid(t),n=this.#e5?.containsGridPoint(r),s=!1;if(this.#ta){for(let e of this.#ta)if(e.isCoincident(r)){s=!0;break}}if(n&&s){i(e,t,{filter:tT.MOVE_OR_INTERACT_TILE});return}if(n){i(e,t,{filter:tT.MOVEMENT_TILE});return}if(s){i(e,t,{filter:tT.INTERACT_TILE});return}if(this.#te){for(let n of this.#te)if(n.isCoincident(r)){i(e,t,{filter:tT.INTERACT_TILE});return}}let o=this.worldPointToGrid(this.#th.position);if(r.coincident(o)){i(e,t,{occupant:this.#th,filter:tT.OCCUPIED_TILE});return}let a=e.getOccupants();a.size>0&&i(e,t,{occupant:a.values().next().value,filter:tT.OCCUPIED_TILE}),u.debug("Ignore click outside of highlighted area")}getWaypointsToWorldPoint(e){let t=this.worldPointToGrid(e);return this.#e5?.getWaypointsAsWorldPoints(t)}getRandomFreeGroundTile(){for(let e of(e6(this.#ts),this.#ts))if(!e.isOccupied())return e;return null}isGridPointPassableByActor(e,t){let i=this.getTileAtGridPoint(e);return!!i&&i.isPassableByActor(t)}canGridPointBeOccupiedByActor(e,t){let i=this.getTileAtGridPoint(e);return!!i&&i.canBeOccupiedByActor(t)}canHeroSeeGridPoint(e){return this.#to?.isGridPointInRays(e)??!0}isSeeThrough(e,t){let i=this.getTileAtGridPoint(e);return!i||i.isSeeThrough(t)}getSurroundingTiles(e){return e5(this.#e1,e.y,e.x)}deleteOccupancyOfGridPoint(e,t){this.getTileAtGridPoint(t)?.deleteOccupant(e)}moveTileOccupancyGridPoint(e,t,i){i!==t&&(this.getTileAtGridPoint(t)?.deleteOccupant(e),this.getTileAtGridPoint(i)?.addOccupant(e))}getCoincidentActors(e){return this.getTileAtWorldPoint(e.position).getOccupants()}getParticipants(e){let t=[],i=this.getSurroundingTiles(this.worldPointToGrid(e.position));return[i.above,i.right,i.below,i.left].forEach(e=>{let i=e?.getOccupants();i?.forEach(e=>{t.push(e)})}),t}}const tO=[{id:"MUSIC_VOLUME",labelKey:"CONTROL MUSIC VOLUME",defValue:50,controlType:e_.RANGE,persistent:!0,action:null,onChange:e=>eq.setMusicVolumePercent(e)},{id:"EFFECTS_VOLUME",labelKey:"CONTROL EFFECTS VOLUME",defValue:50,controlType:e_.RANGE,persistent:!0,action:null,onChange:e=>{eq.setEffectsVolumePercent(e),eq.playEffect("PUNCH")}}],tI={HP_GAUGE:"rgba(204, 51, 0, 0.4)"},tv={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:eh.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:eh.REVERSE}},WALK_NORTH:{keyName:"WALK_N",suffix:"walk-n",options:{framePeriodMs:100,loopMethod:eh.REVERSE}},WALK_EAST:{keyName:"WALK_E",suffix:"walk-e",options:{framePeriodMs:100,loopMethod:eh.REVERSE}},WALK_SOUTH:{keyName:"WALK_S",suffix:"walk-s",options:{framePeriodMs:100,loopMethod:eh.REVERSE}},WALK_WEST:{keyName:"WALK_W",suffix:"walk-w",options:{framePeriodMs:100,loopMethod:eh.REVERSE}}},tP={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:eh.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:eh.REVERSE}}};class tR{#tg;constructor(e){this.#tg=e}#tw(e,t){let i=this.#tg[e]?.suffix;if(!i)throw Error(`Attempt made to use invalid standard animation key of '${e}'`);return`${t}-${i}`}getKeyName(e){return this.#tg[e].keyName}addAllToKeyedAnimation(e,t){for(let i in this.#tg){let r=this.#tg[i];e.addAnimatedImage(this.#tg[i].keyName,new eu({prefix:this.#tw(i,t),suffix:".png",startIndex:0,padding:2},r.options))}e.setCurrentKey(this.#tg.IDLE.keyName)}}const tN={peripatetic:new tR(tv),artefact:new tR(tP)};function tM(e){return fetch(e).then(e=>e.text()).then(e=>e).catch(t=>(u.error(`Error fetching ${e}: ${t}`),null))}function tb(e="?"){if(e.len<2)return e;let t=e.replace(/_/g," "),i=t.charAt(0).toUpperCase()+t.substring(1);return eF.getText(i)}function tD(e){let t=`DESCRIPTION ${e.toUpperCase()}`,i=eF.getText(t);return t===i?(u.error(`No description set for ${t}.`),""):i}const tL=new class{#tS;constructor(){this.#tS=new Map}addAlmanac(e,t){this.#tS.set(e,t)}getAlmanac(e){let t=this.#tS.get(e);return t||u`Attempt to get non-existent almanac ${e}`,t}getRandomEntry(e,t){let i,r;if(Array.isArray(e)){let t=S(0,e.length);i=e[t]}else i=e;if(r=Number.isInteger(t)?this.getAlmanac(i)?.filter(e=>e.minLevel<=t):this.getAlmanac(i)){let e=S(0,r.length);return r[e]}u.error(`Failed to find almanac with key ${i}`)}findById(e,t){for(let i of(t||(t=this.#tS.keys()),t)){let t=this.#tS.get(i)?.find(t=>t.id===e);if(t)return t}u.error(`Failed to find almanac entry for '${e}' in ${t.join(", ")}`)}getItemType(e,t){switch(e){case"HEROES":case"ENEMIES":case"TRADERS":return function(e){let t=i_[e];return null==t&&u.error(`Unrecognised actor type: ${e}`),t}(t);default:return function(e){let t=tn[e];return null==t&&u.error(`Unrecognised artefact type: ${e}`),t}(t)}}};function tk(e){let t=new tt(e.traitsString);t.set("NAME",tb(e.id));let i=function(e,t,i,r){let n=new ta(e,"",`${t}.png`,i);return n.traits=r,n}(e.id,e.id.toLowerCase(),e.type,t);return i.description=tD(e.id),i}class tB extends ew{actor;constructor(e,t){super(e,t)}render(e){if(this.actor&&this.actor.traits){let e=this.actor.traits.getInt("HP",0),t=this.actor.traits.getInt("HP_MAX",1);this.setLevel(0,e/t)}super.render(e)}}class tz extends ed{#eH;#ty;#tE;#tT;constructor(e,t){super(e,t),this.#ty=w.NONE,this.#tT=t}setActor(e){this.#eH=e,this.#tE=this.#eH.alive}getCurrentFrame(){let e=this.#tx();return(e!==this.#ty||this.#tE!=this.#eH?.alive)&&(this.#ty=e,this.#tE=this.#eH?.alive,this.#tA()),super.getCurrentFrame()??this.#tT.getCurrentFrame()}#tx(){return!this.#eH||this.#eH.velocity.isZero(.1)?w.NONE:function(e){let t=Math.abs(e);return t<=m.DEG_45?w.E:t<=m.DEG_135?Math.sign(e)>0?w.N:w.S:w.W}(this.#eH.velocity.getScreenDirection())}#tA(){let e=this.#eH.disengaging;if(!this.#eH.alive)return this.setCurrentKey(tN.peripatetic.getKeyName("DEAD"));switch(this.#ty){case w.NONE:this.setCurrentKey(tN.peripatetic.getKeyName("IDLE"));break;case w.E:this.setCurrentKey(tN.peripatetic.getKeyName(e?"WALK_WEST":"WALK_EAST"));break;case w.N:case w.NW:case w.NE:this.setCurrentKey(tN.peripatetic.getKeyName(e?"WALK_SOUTH":"WALK_NORTH"));break;case w.W:this.setCurrentKey(tN.peripatetic.getKeyName(e?"WALK_EAST":"WALK_WEST"));break;default:this.setCurrentKey(tN.peripatetic.getKeyName(e?"WALK_NORTH":"WALK_SOUTH"))}}}function t_(e,t,i,r){let n;let s=function(e){let t=new tz("still",new eu(`${e}.png`));return tN.peripatetic.addAllToKeyedAnimation(t,e),t}(e),o=new eS(K.getContext2D(),s),a=new iU(new ey({renderer:i.get("MOVE")!==iG.ORGANIC?[n=new tB(K.getContext2D(),{tileSize:eN.TILE_SIZE-2,fillStyles:[tI.HP_GAUGE],strokeStyles:[]}),o]:[o]}),r.type);return s.setActor(a),n&&(n.actor=a),a.position=new A(eN.TILE_SIZE,eN.TILE_SIZE,0),a.almanacEntry=r,a.traits=i,a.maxTilesPerMove=E(i.get("SPEED",1),1),a.velocity={x:0,y:0,rotation:0},a.iconImageName=t?`${t}.png`:`${e}.png`,a}function tG(e){let t;let i=new ti(e.traitsString);switch(i.set("NAME",tb(e.id)),e.type){case i_.HERO:t=t_("hero",null,i,e);break;case i_.TRADER:t=function(e,t,i,r){let n=t_(e,null,i,r);return n.interaction=new ik(n),n}("trader",0,i,e);break;case i_.HIDDEN_ARTEFACT:t=function(e,t){let i=function(e){let t=new tz("still",new eu(`${e}.png`));return tN.artefact.addAllToKeyedAnimation(t,e),t}(e),r=new iU(new ey({renderer:[new eS(K.getContext2D(),i)]}),i_.HIDDEN_ARTEFACT);return i.setActor(r),r.position=new A(eN.TILE_SIZE,eN.TILE_SIZE,0),r.velocity={x:0,y:0,rotation:0},r.interaction=new iB(r),r.iconImageName=`${e}.png`,r.traits=new ti,r}("hidden-artefact",0,i,e);break;default:t=function(e,t,i,r){let n=t_(e,null,i,r);return n.isOrganic()?(n.interaction=new iz(n),n.obstacle=!1):n.interaction=new iD(n),n}(e.id.toLowerCase(),0,i,e)}return t.description=tD(e.id),e.equipmentIds&&function(e,t){if(t)for(let i of t){let t=tL.findById(i,["MONEY","WEAPONS","ARMOUR"]);if(t){let i=tk(t);i.equipStoreType?e.storeManager.equip(i,{direct:!0}):e.storeManager.stash(i,{direct:!0})}else u.error(`Cannot find ${i} artefact in almanac to equip actor.`)}}(t,e.equipmentIds),t}const tU={MAIN_MENU:0,CLICKED_FREE_GROUND:1,CLICKED_ENTRANCE:2,CLICKED_EXIT:3};class tH{#eH;#tC;#tO;#eL;#tI;#tv;constructor(e,t,i,r){this.#eH=e,this.#eL=t,this.#tI=i,this.#tv=r}#tP(e){if(this.#eH.moveType===iG.HUNT){if(this.#tv)return e;{let t=this.#eL.worldPointToGrid(i.position);if(e.getOrthoSeparation(t)-1<=1.5*this.#eH.maxTilesPerMove)return this.#eL.worldPointToGrid(i.position)}}return this.#tR(e,this.#eH.maxTilesPerMove)}moveInstantly(){this.#tO=A.copy(this.#eH.position);let e=this.#eL.worldPointToGrid(this.#eH.position),t=this.#tP(e);if(!t.coincident(e)&&this.#eL.canHeroSeeGridPoint(e)){this.#tI.actor=this.#eH;let i=this.#tI.getDumbRouteNextTo(e,t,this.#eH.maxTilesPerMove);i.length>0&&(this.#tC=new eO({path:i,speed:100},this.#eH.sprite.modifier),this.#tN(i[i.length-1]))}}#tR(e,t){let i=y(e.x-t,e.x+t),r=y(e.y-t,e.y+t),n=this.#eL.getDimsInTiles();return new T(g(i,0,n.width-1),g(r,0,n.height-1))}#tN(e){let t=this.#eL.worldPointToGrid(this.#eH.position);this.#eH.position=e;let i=this.#eL.worldPointToGrid(this.#eH.position);this.#eL.moveTileOccupancyGridPoint(this.#eH,t,i)}#tM(){this.#tN(this.#tO)}replay(){return(this.#tM(),this.#tb(),this.#tC)?this.#tC.applyAsTransientToSprite(this.#eH.sprite):Promise.resolve()}#tb(){if(this.#eH.isOrganic()){let e=tG(this.#eH.almanacEntry);e.position=this.#tO,e.maxTilesPerMove=0,et.addActor(e)}}}class tF{#eL;#tI;#tD;#tv;constructor(e,t,i){this.#tD=[],this.#eL=e,this.#tI=t,this.#tv=i}addAndMoveActor(e){if(0===e.maxTilesPerMove)return;let t=new tH(e,this.#eL,this.#tI,this.#tv);t.moveInstantly(),this.#tD.push(t)}replay(){let e=[];return this.#tD.forEach(t=>e.push(t.replay())),Promise.all(e)}}class tW{constructor(){}async transitionTo(e){await this.onExit().then(()=>(t3=e,e.onEntry()))}onEntry(){return Promise.resolve()}onEvent(e){return Promise.resolve(null)}onExit(){return Promise.resolve(null)}}class t$ extends tW{onEntry(){return(function(){let e=new eL({leftLabel:eH`BUTTON PLAY`,imageName:"ui-play00.png",internalLabel:!0,closes:"PLAY"}),t=new eL({leftLabel:eH`BUTTON SETTINGS`,imageName:"ui-settings00.png",internalLabel:!0,action:()=>(function(){let e=[];return tO.forEach(t=>{e.push(function(e){let t;switch(e.controlType){case e_.CHECKBOX:t=new eB(e);break;case e_.RANGE:t=new ez(e);break;case e_.TEXT_BUTTON:t=new eD(e);break;default:throw Error(`Attempt to create unrecognised control type ${e.controlType}`)}return t}(t))}),eK.showControlsDialog(eH`DIALOG TITLE SETTINGS`,{actionButtons:e,className:"door"})})()});return eK.showControlsDialog(eH`MENU TITLE MAIN`,{actionButtons:[t,e],className:"door"})})().then(()=>this.transitionTo(new tV))}}class tV extends tW{onEntry(){return u.log("Enter AtStart"),eK.showOkDialog(eH`MESSAGE DUNGEON INTRO`,{okButtonLabel:eH`BUTTON ENTER DUNGEON`,className:"wall"}).then(()=>im.switchToFirstScene()).then(e=>(i.sprite.position=et.getTileMap().getWorldPositionOfTileByEntry(),e)).then(e=>e.intro?eK.showOkDialog(e.intro,{className:"mask"}):void 0).then(()=>t3.transitionTo(new tY))}}class tK extends tW{async onEntry(){u.log("Enter AtGameOver"),eR("YOU DIED!",{lifetimeSecs:2,position:i.position,velocity:new x(0,-100,0)}),await new Promise(e=>{setTimeout(()=>e(),2e3)}).then(()=>eK.showOkDialog(eH`MESSAGE DEFEAT`,{okButtonLabel:eH`BUTTON TRY AGAIN`})).then(()=>im.unloadCurrentScene()).then(()=>this.transitionTo(new t$))}}class tq extends tW{async onEntry(){u.log("Enter AtGameCompleted"),await eK.showOkDialog(eH`MESSAGE VICTORY`,{okButtonLabel:eH`BUTTON TRY AGAIN`}).then(()=>im.unloadCurrentScene()).then(()=>this.transitionTo(new t$))}}class tY extends tW{constructor(){super()}async onEntry(){await super.onEntry(),u.log("Enter HeroTurnIdle"),await tQ()}async onEvent(e,t,i){switch(e){case tU.CLICKED_FREE_GROUND:{let e=await t2(i?.filter);e===tT.INTERACT_TILE?await t0(t):e===tT.OCCUPIED_TILE?await t8(i.occupant):await tJ(t),this.transitionTo(new tZ)}break;case tU.CLICKED_ENTRANCE:await eK.showOkDialog(eH`MESSAGE ENTRANCE STUCK`);break;case tU.CLICKED_EXIT:u.log("Escaping"),await tJ(t,!1).then(()=>eK.showOkDialog(eH`MESSAGE OPEN EXIT`)).then(()=>t1(this))}return Promise.resolve(null)}}class tX extends tW{constructor(){super()}async onEntry(){await super.onEntry(),u.log("Enter HeroTurnInteracting"),await tQ()}async onEvent(e,t,r){switch(e){case tU.CLICKED_FREE_GROUND:{let e=await t2(r?.filter);e===tT.INTERACT_TILE?await t0(t):e===tT.OCCUPIED_TILE?await t8(r.occupant):await this.#tL(t),0===et.getTileMap().getParticipants(i).length?this.transitionTo(new tZ):this.transitionTo(new tj)}break;case tU.CLICKED_ENTRANCE:eK.showOkDialog(eH`MESSAGE ENTRANCE STUCK`);break;case tU.CLICKED_EXIT:await this.#tL(t,!1).then(e=>e?eK.showOkDialog(eH`MESSAGE OPEN EXIT WHILE FIGHTING`).then(()=>t1(this)):Promise.resolve())}return Promise.resolve(null)}#tL(e,t=!0){let r=et.getTileMap(),n=r.getParticipants(i),s=!1;for(let e of n)if(e.alive&&e.interaction.respectDisengage(i)){s=!0;break}let o=r.worldPointToGrid(i.position),a=r.worldPointToGrid(e),l=o.getOrthoSeparation(a);return s&&l<=2&&(i.disengaging=!0),tJ(e,t).then(()=>!0)}}class tZ extends tW{constructor(){super()}async onEntry(){await super.onEntry(),u.log("Enter ComputerTurnIdle"),await t4();let e=et.getTileMap(),t=new ty(e),r=new tF(e,t,i.disengaging);for(let e of et.getActors().values())e!==i&&e.alive&&(!e.isWandering()||eQ(6)>3)&&r.addAndMoveActor(e);for(let e of et.getOrganicActors().values())e.alive&&r.addAndMoveActor(e);for(let t of(await r.replay(),e.getParticipants(i)))if(t.isEnemy())return this.transitionTo(new tX),Promise.resolve(null);this.transitionTo(new tY)}}class tj extends tW{constructor(){super()}async onEntry(){await super.onEntry(),u.log("Enter ComputerTurnInteracting"),await t4();let e=et.getTileMap(),t=new ty(e),r=new tF(e,t,i.disengaging),n=e.getParticipants(i);for(let e of et.getActors().values())e!==i&&e.alive&&e.interaction&&(n.includes(e)&&e.willInteract()?await e.interaction.enact(i):r.addAndMoveActor(e));for(let e of et.getOrganicActors().values())e.alive&&r.addAndMoveActor(e);return await r.replay(),0===i.traits.get("HP",0)?this.transitionTo(new tK):0===n.length?this.transitionTo(new tY):this.transitionTo(new tX),Promise.resolve(null)}}function tQ(){i.disengaging=!1;let e=et.getTileMap(),t=new ty(e,i).getAllRoutesFrom(e.worldPointToGrid(i.sprite.position),i.maxTilesPerMove);return e.setMovementRoutes(t),e.setInteractActors(e.getParticipants(i)),e.calcReachableDoors(i.position),Promise.resolve(null)}function tJ(e,t=!0){let r;let n=et.getTileMap();return(r=t?n.getWaypointsToWorldPoint(e):[i.position,e],n.setMovementRoutes(null),n.setInteractActors(null),r)?new eO({path:r,speed:100},i.sprite.modifier).applyAsTransientToSprite(i.sprite):Promise.resolve()}function t4(){let e=et.getTileMap(),t=[];return et.getOrganicActors().forEach(i=>{e.getCoincidentActors(i).forEach(e=>{e.alive&&!e.isOrganic()&&i.interaction&&t.push(i.interaction.enact(e))})}),Promise.all(t)}function t0(e){let t=et.getTileMap().getTileAtWorldPoint(e).getOccupants(),r=[];for(let e of t.values())e.interaction&&r.push(e.interaction.react(i));return Promise.all(r)}function t1(e){return im.areThereMoreScenes()?iR(i,{allowRest:!0}).then(()=>im.switchToNextScene()).then(e=>(i.sprite.position=et.getTileMap().getWorldPositionOfTileByEntry(),e)).then(e=>e.intro?eK.showOkDialog(e.intro,{className:"mask"}):void 0).then(()=>e.transitionTo(new tY)):e.transitionTo(new tq)}function t8(e){return e?e.isHiddenArtefact()?eK.showOkDialog(eH`MESSAGE GROUND DISTURBED`):iR(e):(u.error("Clicked on tile but no occupant to view."),Promise.resolve())}function t2(e){return e===tT.MOVE_OR_INTERACT_TILE?eK.showChoiceDialog(eH`DIALOG TITLE CHOICES`,eH`MESSAGE SEARCH OR MOVE`,[eH`BUTTON MOVE`,eH`BUTTON SEARCH`]).then(e=>0===e?tT.MOVEMENT_TILE:tT.INTERACT_TILE):e}let t3=new class extends tW{onEntry(){u.log("WaitingToStart state")}async onEvent(e,t,i){e===tU.MAIN_MENU&&this.transitionTo(new t$)}},t5=!1;var t6={EventId:tU,getHeroActor:function(){return i},setHero:function(e){i=e},triggerEvent:function(e,t,i){if(t5){u.debug(`Ignoring event ${e} as still processing earlier event.`);return}t5=!0,t3.onEvent(e,t,i).then(()=>{t5=!1})}};function t7(e){return{role:tx.GROUND,onClick:(e,t,i)=>t6.triggerEvent(t6.EventId.CLICKED_FREE_GROUND,t,i),image:e}}function t9(e){return{role:tx.ENTRANCE,onClick:(e,t,i)=>t6.triggerEvent(t6.EventId.CLICKED_ENTRANCE,t,i),image:e}}function ie(e){return{role:tx.EXIT,onClick:(e,t,i)=>t6.triggerEvent(t6.EventId.CLICKED_EXIT,t,i),image:e}}const it=new Map([["x",{role:tx.OBSTACLE,image:"block.png"}],["#-TL",{role:tx.OBSTACLE,image:"wall-TL.png"}],["#-TLI",{role:tx.OBSTACLE,image:"wall-TLI.png"}],["#-T",{role:tx.OBSTACLE,image:"wall-T.png"}],["#-TR",{role:tx.OBSTACLE,image:"wall-TR.png"}],["#-TRI",{role:tx.OBSTACLE,image:"wall-TRI.png"}],["#-R",{role:tx.OBSTACLE,image:"wall-R.png"}],["#-BR",{role:tx.OBSTACLE,image:"wall-BR.png"}],["#-BRI",{role:tx.OBSTACLE,image:"wall-BRI.png"}],["#-B",{role:tx.OBSTACLE,image:"wall-B.png"}],["#-BL",{role:tx.OBSTACLE,image:"wall-BL.png"}],["#-BLI",{role:tx.OBSTACLE,image:"wall-BLI.png"}],["#-L",{role:tx.OBSTACLE,image:"wall-L.png"}],["#-XI",{role:tx.OBSTACLE,image:"wall-XI.png"}],["#-VI",{role:tx.OBSTACLE,image:"wall-VI.png"}],["#-HI",{role:tx.OBSTACLE,image:"wall-HI.png"}],["#-TTEE",{role:tx.OBSTACLE,image:"wall-TTEE.png"}],["#-RTEE",{role:tx.OBSTACLE,image:"wall-RTEE.png"}],["#-BTEE",{role:tx.OBSTACLE,image:"wall-BTEE.png"}],["#-LTEE",{role:tx.OBSTACLE,image:"wall-LTEE.png"}],["#",{role:tx.OBSTACLE,image:"block.png"}],["=-T",ie("door-T.png")],["=-R",ie("door-R.png")],["=-B",ie("door-B.png")],["=-L",ie("door-L.png")],["--T",t9("door-T.png")],["--R",t9("door-R.png")],["--B",t9("door-B.png")],["--L",t9("door-L.png")],["=",{role:tx.OBSTACLE,image:"block.png"}],["-",{role:tx.OBSTACLE,image:"block.png"}],[".",t7("floor.png")],[".-SBW",t7("floor-SBW.png")],[".-SBE",t7("floor-SBE.png")],[",-SBE",t7("floor2-SBE.png")],[",-SBW",t7("floor2-SBW.png")],[",",t7("floor2.png")]]);class ii{#tk;#G;#tB;#tz;#t_;heroActor;intro;constructor(e=2,t=2){e>0?(this.#tk=0,this.#G=1/e):this.#G=1,this.#tB=e,this.#tz=t}getOpacity(){return this.#tk}load(){return this.doLoad()}initialise(){return this.doInitialise()}update(e){K.clearCanvas(),K.setOpacity(this.#tk),et.update(e),this.doUpdate(e),K.setOpacity(1),0!==this.#G&&(this.#tk+=e*this.#G,this.#tk>1?(this.#G=0,this.#tk=1):this.#tk<0&&(this.#G=0,this.#tk=0)),this.#t_&&0===this.#tk&&(this.#t_(),this.#t_=null)}unload(){return this.#tG().then(()=>this.doUnload())}#tG(){return this.#tz>0?(this.#G=-1/this.#tz,new Promise(e=>{this.#t_=e})):Promise.resolve()}doLoad(){return Promise.resolve()}doInitialise(){return Promise.resolve()}doUpdate(e){return Promise.resolve()}doUnload(){return Promise.resolve()}}const ir=eN.TILE_SIZE;class is extends ii{#tU;constructor(e){super(),this.#tU=e,this.intro=e.intro}doLoad(){return Promise.resolve()}doInitialise(){let e=td.generateTileMapPlan(this.#tU.mapDesign,it);this.heroActor=function(e){if(e.heroes&&e.heroes[0]){let t=tG(e.heroes[0]);return t.type=i_.HERO,r=t,t}if(!r)throw Error("No hero has been defined.");return r}(this.#tU);let t=new tC(K.getContext2D(),e,ir,this.heroActor);return et.setTileMap(t),(function(e){let t=[];return e.enemies.forEach(e=>{let i=tG(e);t.push(i)}),t})(this.#tU).forEach(e=>{e.position=t.getRandomFreeGroundTile().worldPoint,et.addActor(e),e.isTrader()&&function(e,t,i){for(;i.qty-- >0;){let r=S(0,t.length),n=t[r],s=tL.getRandomEntry(n);if(s){let t=tk(s);i.equip&&t.equipStoreType?e.storeManager?.equip(t,{direct:!0}):e.storeManager?.stash(t,{direct:!0})}}}(e,["WEAPONS","ARMOUR","ARTEFACTS"],{qty:7,equip:!1})}),(function(e){let t=[];return e.artefacts.forEach(e=>{let i=tG({id:"hidden_artefact",type:i_.HIDDEN_ARTEFACT,traitsString:""}),r=tk(e);i.storeManager.addArtefact(r),t.push(i)}),t})(this.#tU).forEach(e=>{e.position=t.getRandomFreeGroundTile().worldPoint,et.addArtefact(e)}),im.setCameraToTrack(this.heroActor.sprite,200,0),et.addActor(this.heroActor),t6.setHero(this.heroActor),Promise.resolve()}doUpdate(e){}doUnload(){return Promise.resolve(null)}}const io={OFF:0,HERO:1,VELOCITY:2};class ia{#tH;#tF;#tW;#t$;constructor(e,t,i=0){let r=K.getCanvasDimensions(),n=i*Math.min(r.width,r.height);this.#tH=new ey,this.#tF=new eC({prey:e,speed:t,maxSeparation:n}),this.#tW=new eA,this.#tF.applyAsContinuousToSprite(this.#tH)}update(e){this.#t$!==io.OFF&&(this.#tH.update(e),K.centreCanvasOn(this.#tH.position))}setVelocity(e,t){this.setTrackingMethod(io.VELOCITY),this.#tH.velocity.x=e,this.#tH.velocity.y=t}panBy(e,t){this.#tH.position.x+=e,this.#tH.position.y+=t,K.centreCanvasOn(this.#tH.position)}setTrackingMethod(e){if(e!==this.#t$)switch(this.#t$=e,e){case io.HERO:this.#tF.applyAsContinuousToSprite(this.#tH);break;case io.VELOCITY:this.#tW.applyAsContinuousToSprite(this.#tH);break;case io.OFF:break;default:u.error(`Attempt to set invalid tracking method of ${e} ignored.`)}}}const il={TR:0,BR:1,BL:2,TL:3};class ih{#tV;#tK;#tq;constructor(e,t,i){this.#tV=e,this.#tY(t,i,!1)}#tY(e,t,i){let r,n;let s=i?2:1;switch(t){case il.TL:r=s*e,n=s*e;break;case il.TR:r=-s*e,n=s*e;break;case il.BR:r=-s*e,n=-s*e;break;case il.BL:r=s*e,n=-s*e}this.#tX(r,n),i&&this.#tZ(r,n,e)}#tX(e,t){this.#tq=new eu({prefix:"hud-auto-centre",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:eh.STOP}),this.#tK=iV.addButton(this.#tq,()=>{this.setTrackingState(!0)},()=>{this.setTrackingState(!1)}),this.#tK.position.x=e,this.#tK.position.y=t,this.#tK.actionClick(null)}setTrackingState(e){e?(this.#tq.setCurrentIndex(1),this.#tV.setTrackingMethod(io.HERO)):(this.#tq.setCurrentIndex(0),this.#tV.setTrackingMethod(io.OFF))}#tZ(e,t,i){let r=3*i;this.#tj("hud-arrow-up",e,t-i,()=>{this.setTrackingState(!1),this.#tV.setVelocity(0,-r)},()=>this.#tV.setTrackingMethod(io.OFF)),this.#tj("hud-arrow-right",e+i,t,()=>{this.setTrackingState(!1),this.#tV.setVelocity(r,0)},()=>this.#tV.setTrackingMethod(io.OFF)),this.#tj("hud-arrow-down",e,t+i,()=>{this.setTrackingState(!1),this.#tV.setVelocity(0,r)},()=>this.#tV.setTrackingMethod(io.OFF)),this.#tj("hud-arrow-left",e-i,t,()=>{this.setTrackingState(!1),this.#tV.setVelocity(-r,0)},()=>this.#tV.setTrackingMethod(io.OFF))}#tj(e,t,i,r,n){let s=new eu({prefix:e,startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:eh.STOP}),o=iV.addMomentaryButton(s,r,n);o.position.x=t,o.position.y=i,s.setCurrentIndex(0)}}class ic{intro;heroes;enemies;artefacts;mapDesign;constructor(){this.heroes=[],this.enemies=[],this.artefacts=[],this.mapDesign=[]}}function iu(e){return e?id(o).then(()=>e.load().then(()=>e.initialise()).then(()=>{!function(){let e;a=new ih(n,48,il.BR);let t=(e=new eu({prefix:"hud-fullscreen",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:eh.STOP}),addEventListener("fullscreenchange",()=>{document.fullscreenElement?(u.debug("Entering fullscreen mode"),e.setCurrentIndex(1)):(u.debug("Exiting fullscreen mode."),e.setCurrentIndex(0))}),{image:e,callbackOn:()=>{var e;(e=document.body).requestFullscreen?e.requestFullscreen({navigationUI:"hide"}):Promise.reject(Error("Fullscreen requests not supported by browser"))},callbackOff:()=>{document.exitFullscreen()}}),i=iV.addButton(t.image,t.callbackOn,t.callbackOff);i.position.x=eN.TILE_SIZE,i.position.y=-eN.TILE_SIZE,iV.setVisible(!0)}(),o=e})).then(()=>e):(u.error("Attempt made to switch to the next scene when there are no more."),Promise.reject())}function id(e){return e?e.unload().then(()=>(et.clearAll(),o=null,a=null,iV.clear(),iV.setVisible(!1),Promise.resolve())):Promise.resolve(null)}function ip(){return new is(s.getNext())}var im={areThereMoreScenes:function(){return s.hasNext()},getCurrentSceneLevel:function(){return s.getIndex()},panCameraBy:function(e,t){n.panBy(e,t),n.setTrackingMethod(io.OFF),a.setTrackingState(!1)},setCameraToTrack:function(e,t,i){n=new ia(e,t,i)},setSceneList:function(e){(s=e).reset()},switchToFirstScene:function(){return s.reset(),iu(ip())},switchToNextScene:function(){return iu(ip())},unloadCurrentScene:function(){return id(o)},update:function(e){o?.update(e),n?.update(e)}};function ig(e,t,i){switch(e){case"SHORT":return t>=1&&i>=1;case"LONG":return t>=3&&i>=1}return u.error(`Attempt to rest for unknown length of ${e}`),!1}function iw(e,t){switch(t){case"SHORT":{let t=e.traits.get("HIT_DICE"),i=e.traits.getInt("HP",0),r=e.traits.getInt("HP_MAX",i),n=e.traits.getAsModifier("CON"),s=e1(t);s.qty>0&&(s.qty--,i+=eQ(s.sides)+n,e.traits.set("HP",Math.min(i,r)),e.traits.set("HIT_DICE",e8(s)))}break;case"LONG":{let t=e.traits.getCharacterLevel(),i=e1(e.traits.get("HIT_DICE")),r=Math.max(1,Math.ceil(.5*i.qty));i.qty=Math.min(t,i.qty+r),e.traits.set("HIT_DICE",e8(i)),e.traits.set("HP",e.traits.getInt("HP_MAX",0))}break;default:u.error(`Attempt to rest for unknown length of ${t}`)}}const iS={VIEW:0,SELL:1,PILLAGE:2,FIND:3},iy={CANCEL:"cancel",LEAVE:"leave",DISCARD:"discard",EQUIP:"equip",STASH:"stash",TAKE:"take",SELL:"sell",PILLAGE:"pillage"};class iE{#tQ;#tJ;#t4;linkedInventory;constructor(e,t={}){this.#tQ=e,this.#tJ=t,this.#t4=eG("div",{className:"stores"}),this.refresh()}get element(){return this.#t4}refresh(e){!e&&this.linkedInventory&&this.linkedInventory.refresh(!0),this.#t4.replaceChildren();let t=[];t=this.#tJ.justStash?[]:[{label:eH`Purse`,storeType:tr.PURSE},{label:eH`Head`,storeType:tr.HEAD},{label:eH`Body`,storeType:tr.BODY},{label:eH`Hands`,storeType:tr.HANDS},{label:eH`Feet`,storeType:tr.FEET}],this.#tQ.currentOwner.isTrader()?t.push({label:eH`Wagon`,storeType:tr.WAGON}):t.push({label:eH`Backpack`,storeType:tr.BACKPACK}),t.forEach(e=>{let t=this.#tQ.currentOwner.storeManager.getStoreContents(e.storeType);if(t){let i=this.#t0(e.label,e.storeType,t);this.#t4.appendChild(i)}})}#t0(e,t,i){let r=eG("div",{className:"store"});r.appendChild(eG("span",{className:"store-label",text:e}));let n=eG("div",{className:"store-contents"});return r.appendChild(n),i.forEach(e=>{let i={...this.#tQ};i.refresh=this.refresh.bind(this),i.storeType=t,i.artefact=e;let r=function(e){let t=e.artefact.traits.get("NAME");if(e.showPrice||e.artefact.artefactType===tn.COINS){let i=e.currentOwner.isTrader()?e.artefact.costInGp:e.artefact.sellBackPriceInGp;t=`${t} ${i.toFixed(2)} GP`}return new eL({rightLabel:t,imageName:e.artefact.iconImageName,action:async()=>{await iN(e).then(t=>{t!==eW.OK&&e.refresh?.()})}})}(i);n.appendChild(r.element)}),r}}function iT(e,t,i){i>t.length&&u.error("Attempt being made to discard more items than provided in array.");for(let r=0;r<i&&r<t.length;r++)e.take(t[r])||u.error(`Trying to take artefact ${item}, but none found.`)}function ix(e,t){let i;if(t.artefact.artefactType===tn.COINS)return;let r=[];return t.storeType===tr.BACKPACK?t.artefact.equipStoreType&&(i=new eD({label:eH`BUTTON EQUIP`,closes:iy.EQUIP})):(!t.artefact.stashInWagon||t.currentOwner.storeManager.hasWagon)&&(i=new eD({label:eH`BUTTON STASH`,closes:iy.STASH})),i&&(e.appendChild(i.element),r.push(i)),i=new eD({label:eH`BUTTON DISCARD`,closes:iy.DISCARD}),e.appendChild(i.element),r.push(i),i=new eD({label:eH`BUTTON CANCEL`,closes:iy.CANCEL}),e.appendChild(i.element),r.push(i),r}function iA(e){return eG("p",{className:"guidance",text:e.artefact.stashInWagon?eH`MESSAGE MAKE SPACE IN EQUIP`:eH`MESSAGE MAKE SPACE IN BACKPACK`})}function iC(e){let t=e.artefact,i=eG("div",{className:"use-weapon-dialog"});i.appendChild(iv(t));let r=function(e,t){if(t.currentOwner===t.prospectiveOwner||!t.prospectiveOwner)return ix(e,t);switch(t.actionType){case iS.FIND:return function(e,t){let i;let r=[];return t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)?(i=new eD({label:eH`BUTTON TAKE ARTEFACT`,closes:iy.TAKE}),e.appendChild(i.element),r.push(i)):e.appendChild(iA(t)),i=new eD({label:eH`BUTTON LEAVE ARTEFACT`,closes:iy.LEAVE}),e.appendChild(i.element),r.push(i),r}(e,t);case iS.SELL:return function(e,t){let i,r;if(t.artefact.artefactType===tn.COINS)return;let n=[],s=t.artefact.costInGp;if(i=t.prospectiveOwner.isTrader()?Number.MAX_SAFE_INTEGER:t.prospectiveOwner.storeManager.getPurseValue(),!t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)){e.appendChild(iA(t)),t.currentOwner.isTrader()||ix(e,t);return}if(i<t.artefact.costInGp){e.appendChild(eG("p",{className:"guidance",text:eH`MESSAGE INSUFFICIENT FUNDS ${s} ${i}`})),t.currentOwner.isTrader()||ix(e,t);return}return r=new eD({label:t.currentOwner.isTrader()?eH`BUTTON BUY`:eH`BUTTON SELL`,closes:iy.SELL}),e.appendChild(r.element),n.push(r),e.appendChild(r.element),n.push(r),r=new eD({label:eH`BUTTON CANCEL`,closes:iy.CANCEL}),e.appendChild(r.element),n.push(r),n}(e,t);case iS.PILLAGE:return function(e,t){if(t.currentOwner.alive)return ix(e,t);let i=[];if(!t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)){e.appendChild(iA(t)),t.currentOwner.alive&&ix(e,t);return}let r=new eD({label:eH`BUTTON PILLAGE`,closes:iy.PILLAGE});return e.appendChild(r.element),i.push(r),e.appendChild(r.element),i.push(r),r=new eD({label:eH`BUTTON LEAVE ARTEFACT`,closes:iy.CANCEL}),e.appendChild(r.element),i.push(r),i}(e,t);case iS.VIEW:default:return[]}}(i,e);return eK.showControlsDialog(i,{preamble:e.preamble,actionButtons:r,row:!0})}function iO(e){return eK.showOkDialog("Use spell dialog ToDo")}function iI(e){let t=eG("div",{className:"actor-id-card"});t.appendChild(ek(e.iconImageName)),t.appendChild(eG("span",{text:e.traits?.get("NAME")??eH`Unknown`}));let i=e.traits.getInt("HP");if(i){let r;let n=e.traits.getInt("HP_MAX");r=n?eH`(HP OUT OF VALUE) ${i} ${n}`:eH`(HP VALUE) ${i}`,t.appendChild(eG("span",{text:r}))}return e.traits.getCharacterLevel&&t.appendChild(eG("span",{text:eH`CHARACTER LEVEL: ${e.traits.getCharacterLevel()}`})),t}function iv(e,t={}){let i=eG("div",{className:"actor-detail"}),r=iI(e);if(i.appendChild(r),!t.hideDescription&&e.description){let t=document.createElement("p");t.innerText=e.description,i.appendChild(t)}return t.hideTraits||i.appendChild(function(e,t,i){let r=document.createElement("ul");if(e.traits.getEffectiveAc&&r.appendChild(eG("li",{text:eH`AC (including armour)${e.traits.getEffectiveAc()}`})),i){let t=e.storeManager?.getPurseValue();t&&r.appendChild(eG("li",{text:`${t.toFixed(2)}\u{00A0}GP`}))}return e.traits?.getAllTraits().forEach((e,i)=>{if(e&&"0"!==e){let n=Array.isArray(e)?e.join(", "):e;if(!t.includes(i)&&!i.startsWith("_")){let e=i?.replace("_"," "),t=document.createElement("li"),s=eG("span",{text:`${e}: `}),o=eG("span",{text:n});r.appendChild(t),t.appendChild(s),t.appendChild(o)}}}),r}(e,["NAME"],!0)),i}function iP(e,t,i){let r=eG("div",{className:"trade"}),n=eG("div",{className:"side-by-side"});r.appendChild(n);let s=eG("div",{}),o=eG("div",{});n.appendChild(s),n.appendChild(o),s.appendChild(iI(e)),o.appendChild(iI(t));let a=i?iS.PILLAGE:iS.SELL,l=new iE({currentOwner:e,prospectiveOwner:t,actionType:a,showPrice:!0}),h=new iE({currentOwner:t,prospectiveOwner:e,actionType:a,showPrice:!0},{justStash:!i});return l.linkedInventory=h,h.linkedInventory=l,s.appendChild(l.element),o.appendChild(h.element),eK.showControlsDialog(r,{preamble:i?eH`DIALOG TITLE PILLAGE`:eH`DIALOG TITLE TRADE`})}function iR(e,t={}){let i=document.createElement("div");i.appendChild(eG("span",{text:eH`Dungeon level: ${im.getCurrentSceneLevel()}`}));let r=iv(e,{hideTraits:!0});i.appendChild(r);let n=new eD({label:eH`BUTTON INVENTORY`,action:()=>(function(e){let t=eG("div",{className:"inventory"});t.appendChild(iv(e,{hideDescription:!0,hideTraits:!0}));let i=new iE({currentOwner:e,prospectiveOwner:e});return t.appendChild(i.element),eK.showControlsDialog(t)})(e)});return i.appendChild(n.element),n=new eD({label:eH`BUTTON TRAITS`,action:()=>(function(e){let t=document.createElement("div");return t.appendChild(iv(e,{hideDescription:!0})),eK.showControlsDialog(t)})(e)}),i.appendChild(n.element),t.allowRest&&(n=new eD({label:eH`BUTTON REST`,action:()=>(function(e){let t;let i=e.storeManager.getStore(tr.BACKPACK),r=[],n=[];i.values().forEach(e=>{if(e.artefactType===tn.FOOD){let t=e.traits.get("TYPE");"MEAL"===t?r.push(e):"DRINK"===t&&n.push(e)}});let s=document.createElement("div");s.appendChild(iI(e));let o=ig("LONG",r.length,n.length),a=ig("SHORT",r.length,n.length),l=[];s.appendChild(eG("p",{text:eH`MESSAGE EXPLAIN REST`})),o||a?o||(t=eH`MESSAGE CANNOT REST LONG ${3} ${1}`):t=eH`MESSAGE CANNOT REST ${1} ${1}${3} ${1}`,s.appendChild(eG("p",{text:t}));let h=-1,c=-1;return a&&(h=l.length,l.push(eH`BUTTON REST SHORT`)),o&&(c=l.length,l.push(eH`BUTTON REST LONG`)),l.push(eH`BUTTON CANCEL`),eK.showChoiceDialog(eH`DIALOG TITLE CHOICES`,s,l).then(t=>{t===h?(iT(i,r,1),iT(i,n,1),iw(e,"SHORT")):t===c&&(iT(i,r,3),iT(i,n,1),iw(e,"LONG"))})})(e).then(()=>r.replaceWith(iv(e,{hideTraits:!0})))}),i.appendChild(n.element)),eK.showControlsDialog(i)}function iN(e){let t;e.prospectiveOwner||(e.prospectiveOwner=e.currentOwner);let i=e.currentOwner.storeManager,r=e.prospectiveOwner.storeManager,n=e.artefact;switch(e.artefact.artefactType){case tn.WEAPON:case tn.TWO_HANDED_WEAPON:case tn.HEAD_GEAR:case tn.ARMOUR:case tn.SHIELD:case tn.COINS:case tn.FOOD:t=iC;break;case tn.SPELL:t=iO}return t(e).then(t=>{switch(t){case iy.DISCARD:i.discard(n);break;case iy.EQUIP:r.equip(n);break;case iy.PILLAGE:i.discard(n),r.findSuitableStore(n).add(n);break;case iy.SELL:{let t=e.currentOwner.isTrader()?n.costInGp:n.sellBackPriceInGp;i.addToPurse(t),e.prospectiveOwner.isTrader()||r.takeFromPurse(t),i.discard(n),n.stashInWagon&&!r.hasWagon?r.equip(n,{direct:!0}):r.stash(n,{direct:!0})}break;case iy.STASH:r.stash(n);break;case iy.TAKE:i.discard(n),n.stashInWagon&&!r.hasWagon?r.equip(n,{direct:!0}):r.stash(n,{direct:!0})}})}function iM(e,t,i){let r=t.traits.get("HP",0);return r=Math.max(0,r-i),t.traits.set("HP",r),0===r?(eq.playEffect("DIE"),u.info("Killed actor."),t.interaction=new iL(t),t.alive=!1,e.isHero()&&e.traits.adjustForDefeatOfActor(t)):eR(`-${i} HP`,{lifetimeSecs:2,position:new T(t.position.x,t.position.y),velocity:new x(0,0,0)}),r}class ib{actor;constructor(e){this.actor=e}enact(e){return Promise.resolve()}react(e){return Promise.resolve()}canReact(){return!1}canEnact(){return!1}respectDisengage(e){return!1}}class iD extends ib{constructor(e){super(e)}canEnact(){return!0}canReact(){return!0}enact(e){return this.#t1(this.actor,e)}react(e){return this.#t1(e,this.actor)}respectDisengage(e){return!0}#t8(e,t){let i=T.copy(e.position);return new eO({path:[new T(e.position.x+.2*(t.position.x-e.position.x),e.position.y+.2*(t.position.y-e.position.y)),i],speed:100}).applyAsTransientToSprite(e.sprite)}#t2(e,t){let i=0,r=0;return e.traits.getAttacks().forEach(e=>{let n=function(e,t){let i=eQ(20);return 1===i?0:20===i?2*e.rollForDamage():i>=t.traits.getEffectiveAc()?e.rollForDamage():0}(e,t);n>0&&(r++,i+=n)}),new Promise(n=>{if(i<=0){eq.playEffect("MISS"),eP(eo.getSpriteBitmap("miss.png"),{lifetimeSecs:1,position:t.position,velocity:new x(0,0,0)}),n();return}let s=r>1?"DOUBLE PUNCH":"PUNCH",o=r>1?"blood-splat-twice.png":"blood-splat.png";eq.playEffect(s),eP(eo.getSpriteBitmap(o),{lifetimeSecs:1,position:t.position,velocity:new x(0,0,0)}),n(iM(e,t,i))})}#t1(e,t){return this.#t8(e,t).then(()=>this.#t2(e,t))}}class iL extends ib{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){return"MOVE"===await this.#t3()?eI(e,this.actor.position):iP(e,this.actor,!0)}async #t3(){return 0===await eK.showChoiceDialog(eH`DIALOG TITLE CHOICES`,eH`MESSAGE SEARCH CORPSE OR MOVE`,[eH`BUTTON SEARCH`,eH`BUTTON MOVE`])?"SEARCH":"MOVE"}}class ik extends ib{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}react(e){return eK.showChoiceDialog(eH`DIALOG TITLE CHOICES`,eH`MESSAGE TRADE OR BARGE`,[eH`BUTTON TRADE`,eH`BUTTON BARGE`]).then(t=>0!==t?this.#t5(e):iP(e,this.actor,!1))}#t5(e){let t=T.copy(this.actor.position),i=T.copy(e.position);return Promise.all([eI(e,t),eI(this.actor,i)])}}class iB extends ib{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){let t=await this.#t3();if(this.actor.alive=!1,"MOVE"===t)return eI(e,this.actor.position);let i=this.actor.storeManager.getFirstStorageDetails();return i?iN({preamble:eH`MESSAGE FOUND ARTEFACT`,currentOwner:this.actor,prospectiveOwner:e,storeType:i.store.storeType,artefact:i.artefact,actionType:iS.FIND}):eK.showOkDialog(eH`MESSAGE ARTEFACTS ALREADY TAKEN`)}async #t3(){return this.actor.alive?Promise.resolve("SEARCH"):0===await eK.showChoiceDialog(eH`DIALOG TITLE CHOICES`,eH`MESSAGE SEARCH HOLE OR MOVE`,[eH`BUTTON SEARCH`,eH`BUTTON MOVE`])?"SEARCH":"MOVE"}}class iz extends ib{constructor(e){super(e)}canEnact(){return!0}canReact(){return!1}enact(e){let t=function(e,t){let i=e4(e.traits.get("DMG","1D4")),r=e.traits.get("SAVE");if(!r)return u.info("No saving throw trait so damage applied."),i;let n=r.match(/(\d+) *([a-zA-Z])+/);if(!n)return u.error(`Unrecognised save trait: ${r}`),i;let s=t.traits.get(n[2]),o=s?e9(s):0;return eQ(20)+o>=n[1]?0:i}(this.actor,e);return eq.playEffect("POISONED"),t>=0&&(eP(eo.getSpriteBitmap("skull.png"),{lifetimeSecs:1,position:e.position,velocity:new x(0,0,0)}),iM(this.actor,e,t)),Promise.resolve()}}const i_={HERO:0,ENEMY:1,ARTEFACT:2,HIDDEN_ARTEFACT:3,TRADER:4},iG={WANDER:"WANDER",HUNT:"HUNT",ORGANIC:"ORGANIC"};class iU extends tw{almanacEntry;maxTilesPerMove;sprite;traits;interaction;alive;disengaging;description;iconImageName;storeManager;constructor(e,t=i_.ENEMY){super(),this.interaction=new ib,this.sprite=e,this.sprite.obstacle=!0,this.maxTilesPerMove=1,this.alive=!0,this.disengaging=!1,this.type=t,this.storeManager=new tl(t===i_.TRADER||t===i_.HIDDEN_ARTEFACT,()=>this.#t6())}#t6(){let e=this.storeManager.getAllEquippedArtefacts();this.traits.utiliseArtefacts(e)}isHero(){return this.type===i_.HERO}isEnemy(){return this.type===i_.ENEMY}isTrader(){return this.type===i_.TRADER}isHiddenArtefact(){return this.type===i_.HIDDEN_ARTEFACT}set visible(e){this.sprite.visible=e}get visible(){return this.sprite.visible}get obstacle(){return this.sprite.obstacle}set obstacle(e){this.sprite.obstacle=e}get position(){return this.sprite.position}set position(e){this.sprite.position=e}get velocity(){return this.sprite.velocity}set velocity(e){this.sprite.velocity=e}getImageFilename(){return this.sprite.getImageFilename()}isWandering(){return this?.traits.get("MOVE")===iG.WANDER}isOrganic(){return this?.traits.get("MOVE")===iG.ORGANIC}get moveType(){return this?.traits.get("MOVE")}willInteract(){return!!this.interaction&&(!this.isWandering()||eQ(6)>3)}isPassableByActor(e){return!!(e.isHero()&&this.isHiddenArtefact())||!this.alive||!this.obstacle}canShareLocationWithActor(e){return this.isOrganic()?!e.isOrganic()&&!e.isTrader():this.isHiddenArtefact()?e.isHero():!this.obstacle}update(e){this.sprite.update(e)}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionContextClick(this.sprite.position)}actionPointerUp(e){super.actionPointerUp(this.sprite.position)}actionPointerDown(e){super.actionPointerDown(this.sprite.position)}}const iH=new Map;let iF=!1;function iW(e,t){let i=K.glassPositionToWorld(t.position),r=t.sprite.getBoundingBox();return new C(i.x-r.width/2,i.y-r.height/2,r.width,r.height).containsCoordinate(e.world.x,e.world.y)}function i$(e){if(!iF||!iF)return!1;for(let[t,i]of iH)if(iW(e,i))return i.actionPointerUp(i,e.canvas),!0;return!1}var iV={addButton:function(e,t,i){let r=new iU(new ey({renderer:new eS(K.getContext2D(),e)}));return iH.set(r,r),r.setOnClick(()=>{i?0===e.getCurrentIndex()?(e.setCurrentIndex(1),t()):(e.setCurrentIndex(0),i()):t()}),e.setCurrentIndex(0),r},addMomentaryButton:function(e,t,i){let r=new iU(new ey({renderer:new eS(K.getContext2D(),e)}));return iH.set(r,r),r.setOnPointerDown(()=>{e.setCurrentIndex(1),t?.()}),r.setOnPointerUp(()=>{e.setCurrentIndex(0),i?.()}),r},clear:function(){iH.clear()},removeButton:function(e){iH.delete(e)},update:function(e){iF&&iH.forEach(t=>{let i=A.copy(t.position);t.position=K.glassPositionToWorld(t.position),t.update(e),t.position=i})},resolvePointerCancel:function(e){return i$(e)},resolveClick:function(e){if(!iF)return!1;for(let[t,i]of iH)if(iW(e,i))return i.actionClick(i,e.canvas),!0;return!1},resolveContextMenu:function(e){return!1},resolvePointerDown:function(e){if(!iF||!iF)return!1;for(let[t,i]of iH)if(iW(e,i))return i.actionPointerDown(i,e.canvas),!0;return!1},resolvePointerUp:i$,setVisible:function(e){iF=e}};const iK={GRINNING:"\uD83D\uDE00",SANTA:"\uD83C\uDF85",SHAKING:"\uD83E\uDEE8"};class iq{#t7;#t9;#ie;#it;#ii;#ir;#is;#io;#ia;#il;constructor(e){this.#t7=y(e.minCols,e.maxCols),this.#t9=y(e.minRows,e.maxRows),this.#ie=e.maxRoomCols,this.#it=e.maxRoomRows,this.#ii=th.WALL[0],this.#ir=th.GROUND[0],this.#ia=th.VOID[0],this.#is=th.DOOR_IN[0],this.#io=th.DOOR_OUT[0]}generate(){this.#il=[];let e=0,t=this.#t7;for(;this.#il.length<this.#t9-4;){let i=e+t-4-2,r=i>0?S(0,i):0,n=Math.max(e-r+4,4),s=Math.min(this.#ie,this.#t7-r),o=s>n?S(n,s):n,a=this.#t7-r-o,l=S(4,Math.min(this.#it,this.#t9-this.#il.length));this.#ih(r,o,a,l),e=r,t=o}return this.#ic(),this.#iu(),this.getMatrixAsStrings()}getMatrixAsStrings(){return this.#il.map(e=>e.join(""))}#ih(e,t,i,r){u.log(`Create room ${e} ${t} ${i} ${r}`);let n="";n+=this.#ia.repeat(e)+this.#ii.repeat(t)+this.#ia.repeat(i),this.#il.push(n.split(""));for(let s=0;s<r-2;s++)n=""+this.#ia.repeat(e)+this.#ii+this.#ir.repeat(t-2)+this.#ii+this.#ia.repeat(i),this.#il.push(n.split(""));n=""+this.#ia.repeat(e)+this.#ii.repeat(t)+this.#ia.repeat(i),this.#il.push(n.split(""))}#ic(){for(let e=1;e<this.#il.length-1;e++)for(let t=1;t<this.#il[0].length-2;t++)this.#il[e][t]===this.#ii&&this.#il[e+1][t]===this.#ii&&this.#il[e-1][t]===this.#ir&&this.#il[e+2][t]===this.#ir&&(this.#il[e][t]=this.#ir,this.#il[e+1][t]=this.#ir)}#id(e){return e.above===this.#ii&&e.centre===this.#ii&&e.below===this.#ii}#ip(e){return e.left===this.#ii&&e.centre===this.#ii&&e.right===this.#ii}#iu(){let e=[];this.#il.forEach((t,i)=>t.forEach((t,r)=>{let n=e5(this.#il,i,r);(this.#ip(n)||this.#id(n))&&e.push({row:i,col:r})}));let t=e6(e),i=t[0];this.#il[i.row][i.col]=this.#is,i=t[1],this.#il[i.row][i.col]=this.#io}}class iY{#n;#tU;constructor(){this.reset()}getIndex(){return this.#n}getNext(){return this.#n++,this.#im(),this.#tU}hasNext(){return!0}reset(){this.#n=-1}#im(){this.#tU=new ic,0===this.#n&&this.#ig(),this.#iw(),this.#iS(),this.#iy(),this.#iE(),this.#iT()}#iw(){this.#tU.intro=eH`MESSAGE ENTER LEVEL ${this.#n}`}#ig(){let e=tL.findById("hero",["HEROES"]);if(!e)throw Error("Could not find hero in almanacs.");this.#tU.heroes.push(e)}#iS(){let e=y(5,10);for(let t=0;t<e;t++){let e=tL.getRandomEntry("ENEMIES",this.#n);this.#tU.enemies.push(e)}}#iy(){for(let e=0;e<1;e++){let e=tL.getRandomEntry("TRADERS",this.#n);this.#tU.enemies.push(e)}}#iE(){let e=y(10,10);for(let t=0;t<e;t++){let e=tL.getRandomEntry(["WEAPONS","MONEY","ARTEFACTS"],this.#n);e&&this.#tU.artefacts.push(e)}}#iT(){let e=new iq({minCols:12,maxCols:40,maxRoomCols:10,minRows:12,maxRows:40,maxRoomRows:6});this.#tU.mapDesign=e.generate(),u.debug("Random map"),this.#tU.mapDesign.forEach(e=>u.debug(e))}}const iX="custom-pointer-down-event",iZ="custom-pointer-up-event",ij="custom-pointer-cancel-event",iQ="custom-click-event",iJ="custom-conext-click-event",i4="custom-pointer-drag-event",i0={MOUSE:0,TOUCH:1};function i1(e,t,i){let r=new CustomEvent(t,{detail:i});e.dispatchEvent(r)}function i8(e){let t=e.target.getBoundingClientRect();return{x:e.touches[0].pageX-t.left,y:e.touches[0].pageY-t.top}}function i2(e,t,i,r){r.actionStarted=!0,r.dragging=!1,r.distance=0,r.lastX=t,r.lastY=i,r.startX=t,r.startY=i,i1(r.element,iX,{x:t,y:i})}function i3(e,t,i,r){let n=r.dragging?"custom-pointer-drag-end-event":iZ;r.actionStarted=!1,r.dragging=!1,r.distance=0,r.lastX=t,r.lastY=i,r.startX=t,r.startY=i,i1(r.element,n,{x:t,y:i})}function i5(e,t,i,r){let n=t-r.lastX,s=i-r.lastY;if(r.lastX=t,r.lastY=i,r.dragging){let e=new CustomEvent(i4,{detail:{x:t,y:i,dx:n,dy:s}});r.element.dispatchEvent(e)}else(Math.abs(t-r.startX)>10||Math.abs(i-r.startY)>10)&&(r.dragging=!0,r.suppressClickEvent=!0)}const i6=new Map([["BUTTON CANCEL","Cancel"],["BUTTON BARGE","Barge past"],["BUTTON BUY","Buy"],["BUTTON DISCARD","Discard"],["BUTTON ENTER DUNGEON","Enter if you dare"],["BUTTON EQUIP","Equip"],["BUTTON INVENTORY","Inventory"],["BUTTON LEAVE ARTEFACT","Leave"],["BUTTON MOVE","Move"],["BUTTON OK","OK"],["BUTTON PILLAGE","Pillage"],["BUTTON PLAY","Play"],["BUTTON REST","Rest"],["BUTTON REST LONG","Long rest"],["BUTTON REST SHORT","Short rest"],["BUTTON SEARCH","Search"],["BUTTON SELL","Sell"],["BUTTON SETTINGS","Settings"],["BUTTON START","Let's get started."],["BUTTON TAKE ARTEFACT","Take"],["BUTTON TRADE","Trade"],["BUTTON TRAITS","Traits"],["BUTTON TRY AGAIN","Try again"],["BUTTON STASH","Stash"],["CONTROL EFFECTS VOLUME","Effect volume"],["CONTROL MUSIC VOLUME","Music volume"],["DESCRIPTION ARMOUR_CHAIN_MAIL","Armour comprising interlocking steel rings over a soft cushioning fabric. The suit includes gauntlets."],["DESCRIPTION ARMOUR_HALF_PLATE","Shaped metal plates covering most of the body. Simple greaves protect the legs."],["DESCRIPTION ARMOUR_LEATHER","Simple armour comprising stiffened leather boiled in oil along with some more flexible sections."],["DESCRIPTION ARMOUR_PADDED","Simple quilted layers of cloth and batting."],["DESCRIPTION ARMOUR_PLATE","Full plate armour with interlocking steel plates covering the entire body. A visored helmet, gauntlets, boots, and padding are included."],["DESCRIPTION ARMOUR_RING_MAIL","Leather armour reinforced with heavy steel rings sown into the material."],["DESCRIPTION ARMOUR_SCALE_MAIL","Leather coat and legging covered with overlapping steel scales."],["DESCRIPTION ARMOUR_STUDDED_LEATHER","Tough and flexible leather armour with the addition of steel spikes and rivets."],["DESCRIPTION CLUB","A simple wooden club that's seen a lot of action."],["DESCRIPTION COPPER_COINS","Old copper coins of low value."],["DESCRIPTION SILVER_COINS","Silver coins, worn and tarnished but still of value."],["DESCRIPTION GOLD_COINS","Gold coins stamped with the image of latter day kings and queens."],["DESCRIPTION PLATINUM_COINS","Highly valued large platinum."],["DESCRIPTION COINS","Various coins stamped with the image of latter day kings and queens."],["DESCRIPTION DAGGER","A short and very sharp piercing weapon."],["DESCRIPTION HERO","You are a warrior whose family have fallen out of favour. You have been sent on a quest to recover the Chalice of Dark Sight. If found, your family's good name will be restored."],["DESCRIPTION HIDDEN_ARTEFACT","There might be something hidden here."],["DESCRIPTION IRON_RATIONS","Simple emergency rations. Crucial for resting between rooms."],["DESCRIPTION WATERSKIN","A leather drinking flask with fresh water. Crucial for resting between rooms."],["DESCRIPTION ORC","A monstrous creature with an intense hatred of humans."],["DESCRIPTION GOBLIN","Small humanoid creature.Treat with caution. They're small but vicious."],["DESCRIPTION SHIELD","A wooden shield, carried in one hand and offering some protection."],["DESCRIPTION SHORTSWORD","A light and highly versatile sword."],["DESCRIPTION SLIME","A green sticky substance that seems to be growing."],["DESCRIPTION TRADER","A wandering trader selling all manner of things gathered during many months in the dungeon."],["DIALOG TITLE CHOICES","Decisions, decisions"],["DIALOG TITLE SETTINGS","Adjust settings"],["DIALOG TITLE TRADE","Buy and sell with trader"],["DIALOG TITLE PILLAGE","Pillage corpse"],["MENU TITLE MAIN","The Scripted Dungeon"],["MESSAGE ARTEFACTS ALREADY TAKEN","You search but there's nothing left here."],["MESSAGE CANNOT STORE","You're carrying too much stuff to pick up what you've found."],["MESSAGE CANNOT REST","You cannot rest. For a short rest you need ${0} meal, ${1} drink and at least one hit dice. For a long rest you need ${2} meals and ${3} drink"],["MESSAGE CANNOT REST LONG","You cannot have a long rest. For a long rest you need ${0} meals and ${1} drink"],["MESSAGE ENTER LEVEL","You enter level ${0}. The door slams shut behind you. There's no way back."],["MESSAGE EXPLAIN REST","If you have food and drink, you can take a short rest to recover some hit points. A long rest requires more food but can recover all your hit points."],["MESSAGE DUNGEON INTRO","You enter a dark and dingy dungeon. Water runs down the wall and the smell of rotting corpses fills the air"],["MESSAGE DEFEAT","Despite your valiant efforts, you died. Your legend will live on."],["MESSAGE INSUFFICIENT FUNDS","You don't have enough funds to purchase this item. The item costs ${0}GP but you only have ${1}GP."],["MESSAGE MAKE SPACE IN BACKPACK","You need to make space in your backpack by discarding or using something."],["MESSAGE MAKE SPACE IN EQUIP","This is too big to store. Sell or discard what you're wearing so you can wear this."],["MESSAGE SEARCH CORPSE OR MOVE",["You have a choice. Do you want to search the body or climb on top?","You've found a corpse, but what should you do? Search for weapons and treasure or climb on top of the body?"]],["MESSAGE SEARCH HOLE OR MOVE",["You have a choice. Do you want to search this hole or move into it?","You've been here before. Do you want to search again or climb into the hole you dug?"]],["MESSAGE SEARCH OR MOVE","You have a choice. Do you want to search this tile or move onto it?"],["MESSAGE TRADE OR BARGE","Do you want to trade or barge past this guy?"],["MESSAGE ENTRANCE STUCK",["The entrance is locked or jammed. You can't tell. Either way, you can't escape in that direction.","You can't open the door. It seems locked or jammed. There's no way back."]],["MESSAGE EXIT STUCK",["The exit is locked. You will need to find the key if you are ever to leave this dungeon.","The door will not move. It appears to be locked. There must be a key here somewhere."]],["MESSAGE FOUND ARTEFACT",["Good fortune smiles upon you. You found something.","You find something hidden in the ground.","Buried beneath the surface, you find something."]],["MESSAGE GROUND DISTURBED",["The ground appears to have been disturbed.","There's been some recent digging here."]],["MESSAGE OPEN EXIT",["The door opens and you slip away.","You decide that's enough exploring this dungeon and slip away into the darkness."]],["MESSAGE OPEN EXIT WHILE FIGHTING",["A dangerous move, but despite the fighting, you manage to escape.","Dodging a blow, you manage to open the door and make your escape."]],["MESSAGE WELCOME","Welcome to dungeon. How far will you get?"],["MESSAGE VICTORY","You have conquered the dungeon. Your name will live on forever and generations will sing of your great achievements."],["AC (including armour)","AC (+armour): ${0}"],["Backpack","Backpack"],["Body","Body"],["Dungeon level:","Dungeon level: ${0}"],["Feet","Feet"],["GOLD PIECES"," gold pieces"],["Hands","Hands"],["Head","Head"],["(HP OUT OF VALUE)","(HP:${0}/${1})"],["(HP VALUE)","(HP:${0})"],["CHARACTER LEVEL:","level: ${0}"],["Unknown","Unknown"],["Wagon","Wagon"]]);var i7={};i7=JSON.parse('{"frames":[{"filename":"axe.png","frame":{"x":466,"y":197,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"blank.png","frame":{"x":1504,"y":126,"w":3,"h":3},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":3,"h":3},"sourceSize":{"w":48,"h":48}},{"filename":"block.png","frame":{"x":201,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"blood-splat-twice.png","frame":{"x":1,"y":1,"w":96,"h":94},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":96,"h":94},"sourceSize":{"w":96,"h":96}},{"filename":"blood-splat.png","frame":{"x":1,"y":97,"w":94,"h":92},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":4,"w":94,"h":92},"sourceSize":{"w":96,"h":96}},{"filename":"coins.png","frame":{"x":149,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"copper_coins.png","frame":{"x":687,"y":197,"w":44,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"crystal_blue.png","frame":{"x":779,"y":197,"w":42,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":47},"sourceSize":{"w":48,"h":49}},{"filename":"crystal_red.png","frame":{"x":819,"y":101,"w":42,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"door-B.png","frame":{"x":251,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-L.png","frame":{"x":990,"y":200,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-R.png","frame":{"x":1369,"y":101,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-T.png","frame":{"x":301,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor-SBE.png","frame":{"x":351,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor-SBW.png","frame":{"x":401,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor.png","frame":{"x":451,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBE.png","frame":{"x":501,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBW.png","frame":{"x":551,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2.png","frame":{"x":601,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-dead00.png","frame":{"x":1310,"y":151,"w":42,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":9,"w":42,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle00.png","frame":{"x":1213,"y":151,"w":39,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":39,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle01.png","frame":{"x":898,"y":200,"w":40,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":40,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle02.png","frame":{"x":1354,"y":151,"w":39,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":39,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle03.png","frame":{"x":1395,"y":151,"w":37,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":37,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-walk-e00.png","frame":{"x":1460,"y":206,"w":31,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":4,"w":31,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-walk-n00.png","frame":{"x":1460,"y":164,"w":35,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":4,"w":35,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-walk-s00.png","frame":{"x":1352,"y":193,"w":37,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":3,"w":37,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-walk-w00.png","frame":{"x":1391,"y":193,"w":37,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":3,"w":37,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"goblin.png","frame":{"x":198,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"gold_coins.png","frame":{"x":247,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"helmet.png","frame":{"x":1102,"y":200,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":1,"w":38,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"hero-dead00.png","frame":{"x":940,"y":200,"w":48,"h":33},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":7,"w":48,"h":33},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle00.png","frame":{"x":981,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle01.png","frame":{"x":651,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle02.png","frame":{"x":1029,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle03.png","frame":{"x":296,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e00.png","frame":{"x":1297,"y":101,"w":34,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":1,"w":34,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e01.png","frame":{"x":1260,"y":101,"w":35,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":1,"w":35,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e02.png","frame":{"x":1034,"y":100,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e03.png","frame":{"x":1146,"y":150,"w":30,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":30,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n00.png","frame":{"x":1077,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n01.png","frame":{"x":345,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n02.png","frame":{"x":1077,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n03.png","frame":{"x":950,"y":100,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s00.png","frame":{"x":1125,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s01.png","frame":{"x":701,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s02.png","frame":{"x":1125,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s03.png","frame":{"x":1365,"y":51,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w00.png","frame":{"x":1075,"y":100,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w01.png","frame":{"x":52,"y":191,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w02.png","frame":{"x":1199,"y":100,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w03.png","frame":{"x":1107,"y":150,"w":37,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":37,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero.png","frame":{"x":1173,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hidden-artefact-dead00.png","frame":{"x":815,"y":149,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"hidden-artefact-idle00.png","frame":{"x":859,"y":150,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"hidden-artefact.png","frame":{"x":859,"y":150,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down00.png","frame":{"x":147,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down01.png","frame":{"x":195,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left00.png","frame":{"x":191,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left01.png","frame":{"x":243,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right00.png","frame":{"x":239,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right01.png","frame":{"x":291,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up00.png","frame":{"x":287,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up01.png","frame":{"x":339,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre00.png","frame":{"x":335,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre01.png","frame":{"x":387,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen00.png","frame":{"x":383,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen01.png","frame":{"x":435,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"iron_rations.png","frame":{"x":1458,"y":126,"w":44,"h":36},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":8,"w":44,"h":36},"sourceSize":{"w":49,"h":49}},{"filename":"miss.png","frame":{"x":733,"y":197,"w":44,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":44,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"orc-dead00.png","frame":{"x":1459,"y":90,"w":48,"h":34},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":11,"w":48,"h":34},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle00.png","frame":{"x":394,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle01.png","frame":{"x":443,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle02.png","frame":{"x":492,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle03.png","frame":{"x":541,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e00.png","frame":{"x":985,"y":150,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e01.png","frame":{"x":1064,"y":199,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":36,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e02.png","frame":{"x":1404,"y":101,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e03.png","frame":{"x":1116,"y":100,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n00.png","frame":{"x":1412,"y":51,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n01.png","frame":{"x":590,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n02.png","frame":{"x":786,"y":51,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n03.png","frame":{"x":992,"y":100,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s00.png","frame":{"x":834,"y":51,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s01.png","frame":{"x":639,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s02.png","frame":{"x":834,"y":51,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s03.png","frame":{"x":97,"y":149,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w00.png","frame":{"x":907,"y":100,"w":41,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":41,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w01.png","frame":{"x":510,"y":197,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w02.png","frame":{"x":688,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w03.png","frame":{"x":554,"y":197,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc.png","frame":{"x":737,"y":51,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"platinum_coins.png","frame":{"x":883,"y":51,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"poleaxe.png","frame":{"x":751,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"RIP.png","frame":{"x":99,"y":51,"w":48,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":48,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"silver_coins.png","frame":{"x":1221,"y":51,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"skull.png","frame":{"x":932,"y":51,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"slime-dead00.png","frame":{"x":801,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"slime-idle00.png","frame":{"x":99,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-idle01.png","frame":{"x":1,"y":191,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-idle02.png","frame":{"x":150,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-walk-e00.png","frame":{"x":1260,"y":150,"w":48,"h":19},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":13,"w":48,"h":19},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-n00.png","frame":{"x":1240,"y":100,"w":18,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":14,"y":0,"w":18,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-s00.png","frame":{"x":1439,"y":101,"w":17,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":14,"y":0,"w":17,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-w00.png","frame":{"x":1254,"y":171,"w":48,"h":19},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":13,"w":48,"h":19},"sourceSize":{"w":48,"h":49}},{"filename":"slime.png","frame":{"x":431,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"trader-dead00.png","frame":{"x":1459,"y":51,"w":48,"h":37},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":37},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle-s03.png","frame":{"x":1269,"y":51,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle00.png","frame":{"x":191,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle01.png","frame":{"x":421,"y":197,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle02.png","frame":{"x":237,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e00.png","frame":{"x":859,"y":196,"w":37,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":37,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e01.png","frame":{"x":1157,"y":100,"w":40,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":40,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e02.png","frame":{"x":823,"y":195,"w":34,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":34,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e03.png","frame":{"x":1025,"y":199,"w":37,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":37,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n00.png","frame":{"x":283,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n01.png","frame":{"x":598,"y":197,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n02.png","frame":{"x":329,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n03.png","frame":{"x":903,"y":150,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s00.png","frame":{"x":97,"y":199,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":45,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s01.png","frame":{"x":144,"y":149,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s02.png","frame":{"x":144,"y":199,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":45,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s03.png","frame":{"x":1317,"y":51,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w00.png","frame":{"x":944,"y":150,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w01.png","frame":{"x":642,"y":197,"w":43,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":1,"w":43,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w02.png","frame":{"x":1025,"y":150,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w03.png","frame":{"x":1066,"y":150,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader.png","frame":{"x":375,"y":197,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox00.png","frame":{"x":483,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox01.png","frame":{"x":479,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play00.png","frame":{"x":531,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play01.png","frame":{"x":527,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings00.png","frame":{"x":579,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings01.png","frame":{"x":575,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down00.png","frame":{"x":627,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down01.png","frame":{"x":623,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left00.png","frame":{"x":675,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left01.png","frame":{"x":671,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right00.png","frame":{"x":723,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right01.png","frame":{"x":719,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up00.png","frame":{"x":771,"y":101,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up01.png","frame":{"x":767,"y":149,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"undefined.png","frame":{"x":1430,"y":193,"w":28,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":2,"w":28,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"wall-B.png","frame":{"x":851,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BL.png","frame":{"x":1178,"y":149,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BLI.png","frame":{"x":901,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BR.png","frame":{"x":1333,"y":101,"w":34,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":34,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BRI.png","frame":{"x":951,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BTEE.png","frame":{"x":1001,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-HI.png","frame":{"x":1051,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-L.png","frame":{"x":1142,"y":200,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-LTEE.png","frame":{"x":1177,"y":200,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-R.png","frame":{"x":1212,"y":199,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-RTEE.png","frame":{"x":1247,"y":193,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-T.png","frame":{"x":1101,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TL.png","frame":{"x":1282,"y":192,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TLI.png","frame":{"x":1151,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TR.png","frame":{"x":1317,"y":183,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TRI.png","frame":{"x":1201,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TTEE.png","frame":{"x":1251,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-VI.png","frame":{"x":1301,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-XI.png","frame":{"x":1351,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-B.png","frame":{"x":1401,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-HI.png","frame":{"x":1451,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-T.png","frame":{"x":97,"y":99,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"waterskin.png","frame":{"x":863,"y":100,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":1,"w":42,"h":48},"sourceSize":{"w":49,"h":49}}],"meta":{"app":"https://www.codeandweb.com/texturepacker","version":"1.0","image":"dungeon.png","format":"RGBA8888","size":{"w":1508,"h":249},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:bcdc5b177861dc06e94b66db864cf092:7ceb2b2e3e5f07b1705a593ff18907a4:9c0fba27a8a0c106083a8713f6c67b32$"}}');var i9={};i9=new URL("armour.4143b952.txt",import.meta.url).toString();var re={};re=new URL("artefacts.e4e6a385.txt",import.meta.url).toString();var rt={};rt=new URL("enemies.87a4f575.txt",import.meta.url).toString();var ri={};ri=new URL("heroes.56f80e5c.txt",import.meta.url).toString();var rr={};rr=new URL("money.9be0b48a.txt",import.meta.url).toString();var rn={};rn=new URL("traders.aa17109e.txt",import.meta.url).toString();var rs={};rs=new URL("weapons.183c6123.txt",import.meta.url).toString();var ro={};ro=new URL("dungeon_script.34f994bb.txt",import.meta.url).toString();var ra={};ra=new URL("do-alto-do-trono-da-desolacao-trimmed.18cbfbbb.mp3",import.meta.url).toString();var rl={};rl=new URL("punch-trimmed.d5ee82fe.mp3",import.meta.url).toString();var rh={};rh=new URL("punch-trimmed-double.7756f095.mp3",import.meta.url).toString();var rc={};rc=new URL("long-medium-swish-trimmed.69cad07b.mp3",import.meta.url).toString();var ru={};ru=new URL("bubbling-trimmed.361718fa.mp3",import.meta.url).toString();var rd={};rd=new URL("male-hurt-sound-trimmed.76fa38ed.mp3",import.meta.url).toString();const rp={ALMANAC_MAP:new Map([["ARMOUR",new URL(i9)],["ARTEFACTS",new URL(re)],["ENEMIES",new URL(rt)],["HEROES",new URL(ri)],["MONEY",new URL(rr)],["TRADERS",new URL(rn)],["WEAPONS",new URL(rs)]]),DUNGEON_SCRIPT:new URL(ro),MUSIC:new URL(ra),SOUND_EFFECTS_MAP:new Map([["PUNCH",new URL(rl)],["DOUBLE PUNCH",new URL(rh)],["MISS",new URL(rc)],["POISONED",new URL(ru)],["DIE",new URL(rd)]])};var rf={};rf=new URL("dungeon.36310135.png",import.meta.url).toString();const rm={data:(c=i7)&&c.__esModule?c.default:c,textureUrl:new URL(rf)};function rg(e){if(el.updateTimeNow(e),l){var t;let i=(e-l)/1e3;im.update(i),iV.update(i),er.showFps&&(t=1/i,ei(K.getContext2D(),`FPS: ${Math.round(t)}`,{x:0,y:K.getCanvasDimensions().height},{color:"green"}))}l=e,window.requestAnimationFrame(rg)}var rw={TILE_SIZE:48,initialise:async function(e){K.setOptions(e),eF.setMap(i6),function(e){let t=0;for(let i in iK){let r=e.measureText(iK[i]),n=r.fontBoundingBoxAscent+r.fontBoundingBoxDescent,s=.5*n-r.fontBoundingBoxDescent;e.fillText(iK[i],-.5*r.width,s),e.getImageData(0,0,1,1).data[3]<=0&&(u.debug(`Emoji ${i} not supported.`),iK[i]=`[${t++}]`),e.clearRect(0,0,r.width,n)}}(K.getContext2D()),function(){let e;let t=K.getCanvas();e={element:t,actionStarted:!1,dragging:!1,x:0,y:0,lastTouchStartPoint:null,suppressClickEvent:!1},t.addEventListener("mousedown",t=>(u.debug("mousedown"),i2(i0.MOUSE,t.offsetX,t.offsetY,e)),{passive:!0}),t.addEventListener("mouseup",t=>(u.debug("mouseup"),i3(i0.MOUSE,t.offsetX,t.offsetY,e)),{passive:!0}),t.addEventListener("mousemove",t=>{1&t.buttons&&i5(i0.MOUSE,t.offsetX,t.offsetY,e)},{passive:!0}),t.addEventListener("touchstart",t=>{if(u.debug("touchstart"),1===t.changedTouches.length){let i=i8(t);e.lastTouchStartPoint=new T(i.x,i.y),i2(i0.TOUCH,i.x,i.y,e)}},{passive:!0}),t.addEventListener("touchend",t=>{u.debug("touchend"),1===t.changedTouches.length&&i3(i0.TOUCH,e.lastTouchStartPoint?.x,e.lastTouchStartPoint?.y,e),e.lastTouchStartPoint=null,e.suppressClickEvent=!1},{passive:!0}),t.addEventListener("touchmove",t=>{if(u.debug("touchmove"),1===t.changedTouches.length){let i=i8(t);i5(i0.TOUCH,i.x,i.y,e),e.suppressClickEvent=!0}},{passive:!0}),t.addEventListener("touchcancel",t=>{var i,r;u.debug("touchcancel"),i0.TOUCH,i=e.lastTouchStartPoint?.x,r=e.lastTouchStartPoint?.y,e.actionStarted=!1,e.dragging=!1,e.distance=0,e.lastX=i,e.lastY=r,e.startX=i,e.startY=r,i1(e.element,ij,{x:i,y:r}),e.lastTouchStartPoint=null},{passive:!0}),t.addEventListener("click",i=>{u.debug("click"),e.suppressClickEvent||i1(t,iQ,{x:i.offsetX,y:i.offsetY}),e.suppressClickEvent=!1}),t.addEventListener("contextmenu",e=>{u.debug("contextmenu"),e.preventDefault(),i1(t,iJ,{x:e.offsetX,y:e.offsetY})}),t.addEventListener(iQ,e=>{let t=e.detail.x,i=e.detail.y,r=K.uiCoordsToMappedPositions(t,i);iV.resolveClick(r)||et.resolveClick(r)}),t.addEventListener(iX,e=>{let t=e.detail.x,i=e.detail.y,r=K.uiCoordsToMappedPositions(t,i);iV.resolvePointerDown(r)}),t.addEventListener(iZ,e=>{let t=e.detail.x,i=e.detail.y,r=K.uiCoordsToMappedPositions(t,i);iV.resolvePointerUp(r)}),t.addEventListener(ij,e=>{let t=e.detail.x,i=e.detail.y,r=K.uiCoordsToMappedPositions(t,i);iV.resolvePointerCancel(r)}),t.addEventListener(i4,e=>{im.panCameraBy(-e.detail.dx,-e.detail.dy)}),t.addEventListener(iJ,e=>{u.debug("Context menu");let t=e.detail.x,i=e.detail.y,r=K.uiCoordsToMappedPositions(t,i);iV.resolveContextMenu(r)||et.resolveContextMenu(r),e.preventDefault()})}(),tO.forEach(e=>{if(e.label=eF.getText(e.labelKey),e.persistent&e.onChange){let t=eM.get(e.id,e.defValue);e.onChange(t)}}),eK.showOkDialog(eH`MESSAGE WELCOME`,{okButtonLabel:eH`BUTTON START`,className:"door"}).then(()=>eq.loadAndPlayMusic(rp.MUSIC)).then(()=>eq.loadEffects(rp.SOUND_EFFECTS_MAP)).then(()=>eo.loadSpriteMap(rm.data,rm.textureUrl)).then(()=>tM(rp.DUNGEON_SCRIPT)).then(e=>im.setSceneList(new iY)).then(()=>(function(e){let t=[];return e.forEach((e,i)=>{let r=tM(e).then(e=>{tL.addAlmanac(i,function(e,t){let i=[];return e.split(/[\r\n]+/).forEach(e=>{if(""!==(e=e.trim())&&!e.startsWith("#")){let r=function(e,t){var i;let r=e.match(/^ *(\d+) *, *(\w*) *, *(\w*) *(?:\[ *([\w, ]*?)])? *\*(.*)$/);if(!r)return u.error(`Invalid almanac entry ${e}`),null;let n={};return n.minLevel=parseInt(r[1]),n.type=tL.getItemType(t,r[2]),n.id=r[3],n.name=tb(n.id),n.equipmentIds=(i=r[4])?i.trim().split(/\s*,\s*/):i,n.traitsString=r[5],n}(e,t);r&&i.push(r)}}),i}(e,i))});t.push(r)}),Promise.all(t)})(rp.ALMANAC_MAP)).then(()=>t6.triggerEvent(t6.EventId.MAIN_MENU)).then(()=>void window.requestAnimationFrame(rg)).catch(e=>{u.error(e),alert(`Fatal error in main game. ${e.message}`)})}};window.addEventListener("load",()=>{try{rw.initialise({width:800,height:600,maxScale:2.4,minScale:1,sizingMethod:"COVER",alpha:!1})}catch(e){u.fatal(e)}});
//# sourceMappingURL=index.eaaae31f.js.map
