let e,t,i,r,a,n,s,o,l,h,c;String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){if(!(e instanceof RegExp))return this.replace(RegExp(e,"g"),t);if(0>e.flags.indexOf("g"))throw TypeError("String.prototype.replaceAll called with a non-global RegExp argument");return this.replace(e,t)}),String.prototype.toWellFormed||(String.prototype.toWellFormed=function(){if(!this)return this;let e="";for(let t of this){let i=t.codePointAt(0);i>=55296&&i<=56319||i>=56320&&i<=57343?e+="ï¿½":e+=t}return e});const u={LOG:0,INFO:1,DEBUG:2,ERROR:3};let d=new class{#e;#t;#i;#r;constructor(e){this.#i=e,this.#e=0,this.#t=0,this.#r=[]}clear(){this.#r=[],this.#e=0,this.#t=0}add(e){this.#r[this.#e]=e,this.#e=this.#a(this.#e),this.#e===this.#t&&(this.#t=this.#a(this.#t))}getAll(){let e=[],t=this.#t;for(;t!==this.#e;)e.push(this.#r[t]),t=this.#a(t);return e}#a(e){return++e>this.#i&&(e=0),e}}(50);function p(e,t){let i;switch(t){case u.DEBUG:i=":-/ ";break;case u.INFO:i="(i) ";break;case u.ERROR:i="/! ";break;case u.LOG:default:i=""}for(let t of e)d.add(`${i}${t}`)}window.addEventListener("error",e=>{alert(`ERROR: ${e.filename}; line ${e.lineno}
${e.message}
:Stack:
${e.error.stack}`)});var f,m={log:function(...e){console.log(...e)},info:function(...e){console.info(...e),p(e,u.INFO)},debug:function(...e){console.debug(...e)},error:function(...e){console.error(...e),p(e,u.ERROR)},fatal:function(e){let t;console.error(e),t=e.message?`${e.message}
Stack:
${e.stack}`:e,alert(`Fatal error: ${t}
Previous errors:
${d.join("\n")}`),p(t,u.ERROR)},getMessages:function(){return d.getAll()}};const g="'UnifrakturCook', cursive",S={normal:{size:15,fontName:"'UnifrakturCook', cursive"},h1:{size:30,fontName:g},h2:{size:22,fontName:g},h3:{size:18,fontName:g},emojiSprite:{size:18,fontName:"'UnifrakturCook', cursive"}};function w(e){let t=S[e]??S.normal;return`${t.size}px ${t.fontName}`}const E={DEG_22_5:1/8*Math.PI,DEG_45:2/8*Math.PI,DEG_67_5:3/8*Math.PI,DEG_112_5:5/8*Math.PI,DEG_135:6/8*Math.PI,DEG_157_7:7/8*Math.PI};function T(e,t,i){return e<t?t:e>i?i:e}const y={NONE:-1,N:0,NE:1,E:2,SE:3,S:4,SW:5,W:6,NW:7};function A(e,t){let i=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-i)+i)}function x(e){let t=A(0,e.length);return e[t]}function I(e,t){let i=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-i+1)+i)}function O(e,t=0,i){let r=parseInt(e,i);return Number.isNaN(r)?t:r}function R(e,t=0){let i=parseFloat(e);return Number.isNaN(i)?t:i}class C{x;y;constructor(e,t){this.x=e,this.y=t}static copy(e){return new C(e.x,e.y)}coincident(e){return this.x===e.x&&this.y===e.y}getCartesianAngleTo(e){return Math.atan2(e.y-this.y,e.x-this.x)}getScreenAngleTo(e){return Math.atan2(this.y-e.y,e.x-this.x)}toString(){return`(${this.x},${this.y})`}isCoincident(e){return Math.round(this.x)===Math.round(e.x)&&Math.round(this.y)===Math.round(e.y)}isOtherClose(e,t){return Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2)<=Math.pow(t,2)}getOrthoSeparation(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}}class N{x;y;rotation;constructor(e,t,i){this.x=e,this.y=t,this.rotation=i}getCartesianDirection(){return Math.atan2(this.y,this.x)}getScreenDirection(){return Math.atan2(-this.y,this.x)}isZero(e){return Math.abs(this.x)<e&&Math.abs(this.y)<e}}class P{x;y;rotation;constructor(e,t,i){this.x=e,this.y=t,this.rotation=i}}class v extends C{rotation;constructor(e,t,i){super(e,t),this.y=t,this.rotation=i}static fromPoint(e){return new v(e.x,e.y,0)}static copy(e){return new v(e.x,e.y,e.rotation)}getRelativeTo(e){return new v(this.x-e.x,this.y-e.y,this.rotation-e.rotation)}withinSquare(e,t){return Math.abs(e.x-this.x)<t&&Math.abs(e.y-this.y)<t}}class L{x;y;width;height;constructor(e,t,i,r){this.x=e,this.y=t,this.width=i,this.height=r}getBottomRight(){return new C(this.x+this.width,this.y+this.height)}getTopLeft(){return new C(this.x,this.y)}overlaps(e){let t=this.getBottomRight(),i=e.getBottomRight();return!(e.x>t.x||e.y>t.y||i.x<this.x||i.y<this.y)}containsPoint(e){return e.x>=this.x&&e.x<=this.x+this.width&&e.y>=this.y&&e.y<=this.y+this.height}containsCoordinate(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}equals(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}}new C(Number.MIN_VALUE,Number.MIN_VALUE),new C(Number.MAX_VALUE,Number.MAX_VALUE);let D=null,M=null,b=null,_=0,z=0,k=!0,B=null,G=null,U=0,H=0,F=1,$=1,W=.1,K="COVER",V=new v(0,0,0);function Y(){let e,t,i,r;let a={width:window.innerWidth,height:window.innerHeight},n=b.width/b.height,s=0,o=0,l=a.width/a.height;("COVER"===K?n>l:n<l)?o=(s=a.height)*n:s=(o=a.width)/n,(F=o/b.width)>$?(o=(F=$)*b.width,s=F*b.height):F<W&&(o=(F=W)*b.width,s=F*b.height),U=(a.width-o)/2,H=(a.height-s)/2,M.style.left=`${U}px`,M.style.top=`${H}px`,M.style.width=`${o}px`,M.style.height=`${s}px`,U<0?(i=-U/F,e=a.width/F):(i=0,e=b.width),H<0?(r=-H/F,t=a.height/F):(r=0,t=b.height),B=new L(i,r,e,t),m.debug(`Scale: ${F}`),m.debug(`Window: width: ${a.width}, height: ${a.height}`),m.debug(`Display: left: ${U}, top: ${H}, width: ${o}, height: ${s}`),m.debug(`Visible canvas: left: ${i}, top: ${r}, width: ${e}, height: ${t}`)}function X(){let e=S.normal.size*F;document.documentElement.style.fontSize=`${e}px`}function q(){Y(),X()}function j(){return M.getContext("2d",{alpha:k})}function Z(e){return e.style.opacity=0,window.setTimeout(()=>{e.remove()},500),Promise.resolve()}function J(e){return new v(e.x+V.x,e.y+V.y,e.rotation)}window.addEventListener("resize",()=>{null===D&&(D=window.setTimeout(()=>{q(),D=null},200))});var Q={canvasPositionToWorld:J,centreCanvasOn:function(e){V.x=e.x-_,V.y=e.y-z},clearCanvas:function(){j().clearRect(0,0,b.width,b.height)},displayOnGlass:function(e,t){let i,r;t.replace&&(i=document.getElementsByClassName("glass")[0],i?.replaceChildren()),i||(i=document.createElement("div"),document.body.appendChild(i),i.className="glass");let a=document.createElement("div");i.appendChild(a),a.className="glass-content",a.appendChild(e),t.className&&i.classList.add(t.className),i.style.display="block",i.style.opacity=1;let n=a.getBoundingClientRect().height;a.scrollHeight>n&&a.classList.add("overflow");let s=[];if(t.closers&&t.closers.length>0)t.closers.forEach(e=>{let t=new Promise(t=>{e.element.addEventListener("click",async()=>{t(e.closes)})});s.push(t)});else{let e=new Promise(e=>a.addEventListener("click",()=>e()));s.push(e)}return Promise.race(s).then(e=>(r=e,Z(i))).then(()=>r)},getCanvas:()=>M,getContext2D:j,getCanvasDimensions:function(){return{width:b.width,height:b.height}},getWorldInCanvasBounds:function(){return new L(V.x,V.y,b.width,b.height)},getVisibleCanvasRect:function(){return B},glassPositionToWorld:function(e){let t=e.x<0?B.x+B.width:B.x,i=e.y<0?B.y+B.height:B.y;return J(new v(t+e.x,i+e.y,e.rotation))},isOnCanvas:function(e){return e.overlaps(b)},isOnScreen:function(e){return e.overlaps(b)},panCamera:function(e,t){V.x+=e,V.y+=t},resize:q,setOpacity:function(e){j().globalAlpha=e},setOptions:function(e){var t;if(M){m.error("Multiple calls to setScreen ignored.");return}if(!(G=document?.getElementById("game-content"))){m.debug("No game element so assuming running as Jest test. No ui");return}t=e.width,S.normal.size=15+t/100*.390625,S.h1.size=2*S.normal.size,S.h2.size=1.5*S.normal.size,S.h3.size=1.2*S.normal.size,S.emojiSprite.size=t/10,(M=document.createElement("canvas")).id="game-canvas",M.setAttribute("width",e.width),M.setAttribute("height",e.height),M.innerText="Loading the app.",b=new L(0,0,e.width,e.height),_=e.width/2,z=e.height/2,G.appendChild(M),$=e.maxScale,W=e.minScale,K=e.sizingMethod,k=e.alpha,Y(),X()},wipeGlass:Z,worldPositionToCanvas:function(e){return new v(e.x-V.x,e.y-V.y,e.rotation)},worldToUi:function(e){return e*F},uiCoordsToMappedPositions:function(e,t){return{canvas:new v(Math.round(e/=F),Math.round(t/=F)),world:new v(Math.round(e+V.x),Math.round(t+V.y),-V.rotation)}},uiToWorld:function(e){return e/F}};const ee=new Map,et=new Map,ei=new Map,er=new Map;function ea(t){let i=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,i),t.isOrganic()?er.delete(t):ee.delete(t)}function en(t){let i=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,i),et.delete(t)}function es(e){ei.delete(e)}function eo(){e=null}var el={addActor:function(t){t.isOrganic()?er.set(t,t):ee.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addArtefact:function(t){et.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addPassiveSprite:function(e){ei.set(e,e)},clearAll:function(){er.forEach(e=>ea(e)),ee.forEach(e=>ea(e)),et.forEach(e=>en(e)),ei.forEach(e=>es(e)),eo()},getActors:function(){return ee},getOrganicActors:function(){return er},getArtefacts:function(){return ee},getTileMap:function(){return e},getWorldDims:function(){return e?e.getDimensions():Q.getCanvasDimensions()},removeTileMap:eo,resolveCancel:function(e){return!1},resolveClick:function(t){let i=e?.getTileAtWorldPoint(t.world);return!!i&&(i.actionClick(t.world),!0)},resolveContextMenu:function(t){let i=e.getTileAtWorldPoint(t.world);return!!i&&(i.actionContextClick(t.world),!0)},removeActor:ea,removeArtefact:en,removePassiveSprite:es,setTileMap:function(t){e=t},update:function(t){e?.update(t),er.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let a=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,a)}),et.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let a=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,a)}),ee.forEach(i=>{let r=e.worldPointToGrid(i.position);i.visible=e.canHeroSeeGridPoint(r),i.update(t);let a=e.worldPointToGrid(i.position);e.moveTileOccupancyGridPoint(i,r,a)}),ei.forEach(e=>e.update(t)),e?.updateHighlights(t)}};function eh(e,t,i,r){if(e.font=w(r?.styleName),e.fillStyle=r?.color??"white",r?.wrapAtX){var a=t.split("\n");for(let t=0;t<a.length;t++)r.y=function(e,t,i,r){let a;let n=t.split(" "),s=i.x??0,o=i.y??0,l=r.xWrapPosition-s,h=r.lineSpacing??1,c="";for(let t=0;t<n.length;t++){let i=c+n[t]+" ",r=function(e,t){let i=e.measureText(void 0);return{width:i.width,height:i.fontBoundingBoxAscent+i.fontBoundingBoxDescent,offsetTop:-i.fontBoundingBoxAscent,offsetCentreY:.5*(i.fontBoundingBoxDescent-i.fontBoundingBoxAscent)}}(e);a||(a=h*r.height),r.width>l&&t>0?(e.fillText(c,s,o),c=n[t]+" ",o+=a):c=i}return e.fillText(c,s,o),o+a}(e,a[t],i,r)}else e.fillText(t,i.x??0,i.y??0)}const ec={spriteBoxes:!1,showFps:!1};let eu=new Map;function ed(e){return new Promise(t=>{let i=new Image;i.addEventListener("load",()=>{m.debug(`Image ${e} loaded.`),t(i)}),i.src=e})}var ep={getSpriteBitmap:function(e,t){let i=eu.get(e);return i||t?.quiet||m.debug(`Failed to find image ${e}.`),!(!i&&t?.fallback)||(i=eu.get(t.fallback))||m.debug(`Failed to find fallback image ${t.fallback}.`),i},getUndefinedBitmap:function(){return eu.get("undefined.png")},loadImage:ed,loadImages:function(e){let t=[];return e.forEach(e=>t.push(ed(e))),Promise.all(t)},loadSpriteMap:function(e,t){return ed(t).then(t=>(function(e,t){let i=[];return e.frames.forEach(e=>{i.push(createImageBitmap(t,e.frame.x,e.frame.y,e.frame.w,e.frame.h).then(t=>{let i={filename:e.filename,image:t,width:e.frame.w,height:e.frame.h,centreX:e.sourceSize.w/2-e.spriteSourceSize.x,centreY:e.sourceSize.h/2-e.spriteSourceSize.y};return eu.set(e.filename,i),e.filename}))}),Promise.all(i)})(e,t))}};let ef=0;var em={updateTimeNow:function(e){ef=e},getFrameCount:function(e,t=0){return Math.floor((ef+t)/e)}};const eg={WRAP:0,REVERSE:1,STOP:2};class eS{#n;#s;#o;#l;#h;constructor(e,t){this.#n=e,this.#s=e-1,this.#o=t,this.#l=1,this.#h=0}get index(){return this.#h}set index(e){this.#h=T(e,0,this.#n-1)}advanceBy(e){if(this.#n<1)return this.#h;switch(this.#o){case eg.WRAP:return this.#c(e);case eg.REVERSE:return this.#u(e);case eg.NONE:default:return this.#d(e)}}#c(e){return e%=this.#n,this.#h+=e%this.#n,this.#h>=this.#n&&(this.#h=this.#h-this.#n),this.#h}#u(e){if(Math.floor(e/this.#n)%2&&(this.#l=-this.#l),e%=this.#n,this.#l>0){this.#h+=e;let t=this.#h-this.#s;t>0&&(this.#h=this.#s-t,this.#l=-1)}else this.#l<0&&(this.#h-=e,this.#h<0&&(this.#h=-this.#h,this.#l=1));return this.#h}#d(e){return this.#l>0?this.#h=Math.min(this.#s,this.#h+e):this.#l<0&&(this.#h=Math.max(0,this.#h-e)),this.#h}}const ew={NONE:0};class eE{playing;#p;#f;#m;#g;#S;constructor(e,t){let i;if(this.#p=[],this.#m=0,this.#g=A(0,1e3),"string"==typeof e){this.#p.push(ep.getSpriteBitmap(e));return}this.#S=Math.max(1,t.framePeriodMs);let r=e.startIndex??0,a=e.padding??0;do{let t;let n=`${e.prefix}${r.toString().padStart(a,"0")}${e.suffix}`;t=!(0===r&&(e.prefix.endsWith("idle")||e.prefix.endsWith("dead"))),(i=ep.getSpriteBitmap(n,{quiet:t}))&&this.#p.push(i),r++}while(i)this.#f=new eS(this.#p.length,t.loopMethod),this.playing=!0}getFirstFrame(){return{bitmap:this.#p[0],rotation:0,flip:ew.NONE}}getCurrentFrame(){let e={bitmap:void 0,rotation:0,flip:ew.NONE};if(this.#p.length>1){if(this.playing){let e=em.getFrameCount(this.#S,this.#g);e!==this.#m&&(this.#f.advanceBy(e-this.#m),this.#m=e)}e.bitmap=this.#p[this.#f.index]}else e.bitmap=this.#p[0];return e.bitmap?e:void 0}setCurrentIndex(e){this.#p.length>1&&(this.playing=!1,this.#f.index=e)}getCurrentIndex(){return this.#p.length>1?this.#f.index:0}}class eT{#w;#E;constructor(e,t){this.#w={},e&&(this.#w[e]=t,this.#E=t)}get image(){return this.#E}addAnimatedImage(e,t){this.#w[e]=t}setCurrentKey(e){this.#w.hasOwnProperty(e)?this.#E=this.#w[e]:m.error(`Attempt to set current key to nonexistent value of ${e}`)}getCurrentFrame(){return this.#E.getCurrentFrame()}getAnimatedImage(e){return this.#w[e]}}class ey{_context;_boundingBoxCanvas;constructor(e){this._context=e,this._boundingBoxCanvas=new L(0,0,0,0)}getImageFilename(){return null}getContext(){return this._context}getBoundingBoxCanvas(){return this._boundingBoxCanvas}render(e,t){if(e=Q.worldPositionToCanvas(e),!this.isOnCanvas(e))return;let i=this._context.globalAlpha;this._context.globalAlpha=i*t;let r=e.rotation;r&&(this._context.save(),this._context.translate(e.x,e.y),this._context.rotate(-e.rotation),this._context.translate(-e.x,-e.y)),this._doRender(e),r&&this._context.restore(),ec.spriteBoxes&&(this._context.strokeStyle="green",this._context.strokeRect(this._boundingBoxCanvas.x,this._boundingBoxCanvas.y,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height)),this._context.globalAlpha=i}_doRender(e){m.error("_doRender method should be overridden.")}isOnScreen(e){let t=new L(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return Q.isOnScreen(t)}isOnCanvas(e){let t=new L(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return Q.isOnCanvas(t)}}class eA extends ey{#T;#y;#A;text;color;constructor(e,t,i={styleName:"normal",color:"white"}){super(e),this.text=t,this.color=i.color,this.#T=i.styleName}#x(e){this._context.font=w(this.#T);let t=this._context.measureText(e);this.#A={width:t.width,height:t.fontBoundingBoxAscent+t.fontBoundingBoxDescent,origin:{x:-.5*t.width,y:.5*(t.fontBoundingBoxAscent-t.fontBoundingBoxDescent)}},this.#y=e}_doRender(e){var t;this.text!==this.#y&&this.#x(this.text);let i={x:e.x+this.#A.origin.x,y:e.y+this.#A.origin.y,rotation:e.rotation};eh(this._context,this.#y,i,{color:this.color,styleName:this.#T}),this._boundingBoxCanvas=(t=this.#A,new L(e.x-t.width/2,e.y-t.height/2,t.width,t.height))}}class ex extends ey{#I;#O;#R;#C;#N;#P;#v;constructor(e,t){super(e),this.#I=t.width??10,this.#O=t.height??10,this.#R=this.#I/2,this.#C=this.#O/2,this.#N=t.fillStyle,this.#P=t.strokeStyle,this.#v=t.lineWidth??2}_doRender(e){this._context.lineWidth=this.#v;let t=e.x-this.#R,i=e.y-this.#C;this.#N&&(this._context.fillStyle=this.#N,this._context.fillRect(t,i,this.#I,this.#O)),this.#P&&(this._context.strokeStyle=this.#P,this._context.strokeRect(t,i,this.#I,this.#O)),this._boundingBoxCanvas=new L(t,i,this.#I,this.#O)}}class eI extends ey{#O;#C;#I;#R;#N;#P;#L;#D;#M;#b;constructor(e,t){super(e),this.#O=t.height,this.#C=this.#O/2,this.#I=t.width,this.#R=this.#I/2,this.#N=t.fillStyle,this.#P=t.strokeStyle,this.#L=t.offsetX??0,this.#D=t.offsetY??0,this.setLevel(0)}setLevel(e){this.#M=Math.min(e,1)*this.#O,this.#b=.5*this.#M}_doRender(e){let t=e.y-this.#C+this.#D,i=e.y+this.#C-this.#M+this.#D,r=e.x-this.#R+this.#L;this.#N&&(this._context.fillStyle=this.#N,this._context.fillRect(r,i,this.#I,this.#M)),this.#P&&(this._context.strokeStyle=this.#P,this._context.strokeRect(r,t,this.#I,this.#O)),this._boundingBoxCanvas=new L(r,t,this.#I,this.#O)}}class eO extends ey{#_;constructor(e,t){super(e);let i=Math.max(t.fillStyles.length??0,t.strokeStyles.length??0);if(0===i){m.error("Attempt to create MultiGaugeTileRenderer with no gauges.");return}this.#_=[];let r=t.tileSize/i,a=-t.tileSize/2+r/2;for(let n=0;n<i;n++)this.#_.push(new eI(e,{width:r,height:t.tileSize,fillStyle:t.fillStyles?.[n],strokeStyle:t.strokeStyles?.[n],offsetX:a+r*n,offsetY:0}))}setLevel(e,t){this.#_[e]?.setLevel(t)}render(e){this.#_?.forEach(t=>t.render(e))}}class eR extends ey{#z;#k;constructor(e,t){super(e),t?.getCurrentFrame?(this.#k=t,this.#z=this.#k.getCurrentFrame()):this.#z={bitmap:t,rotation:0,flip:ew.NONE},this.#z?.bitmap?(this._boundingBoxCanvas.width=this.#z.bitmap.width??0,this._boundingBoxCanvas.height=this.#z.bitmap.height??0):m.error("No image frame available for sprite.",t)}getImageFilename(){return this.#z?.bitmap.filename}_doRender(e){if(!this.#z)return;let t=this.#k?this.#k.getCurrentFrame():this.#z;this._boundingBoxCanvas.x=e.x-this._boundingBoxCanvas.width/2,this._boundingBoxCanvas.y=e.y-this._boundingBoxCanvas.height/2,e.rotation=t.rotation,this._context.drawImage(t.bitmap.image,e.x-t.bitmap.centreX,e.y-t.bitmap.centreY)}}class eC{#B=new v(0,0,0);#G=new N(0,0,0);#U=new P(0,0,0);#H;#F;#$;visible;opacity;constructor(e){this.#H=e?.renderer,this.visible=!0,this.opacity=1}get position(){return this.#B}set position(e){this.#B.x=this.valueOrZero(e.x),this.#B.y=this.valueOrZero(e.y),this.#B.rotation=this.valueOrZero(e.rotation)}get velocity(){return this.#G}get acceleration(){return this.#U}set acceleration(e){this.#U=e}set velocity(e){this.#G.x=this.valueOrZero(e.x),this.#G.y=this.valueOrZero(e.y),this.#G.rotation=this.valueOrZero(e.rotation)}replaceTransientModifier(e){this.#$&&this.#$.kill(),this.#$=e}replaceBaseModifier(e){this.#F&&this.#F.kill(),this.#F=e}valueOrZero(e){return"number"==typeof e?e:0}update(e){this.#F&&(this.#F=this.#F.update(this,e)),this.#$&&(this.#$=this.#$.update(this,e)),this.visible&&this.#W()}#W(){this.#H&&(this.#H.forEach?this.#H.forEach(e=>e.render(this.#B,this.opacity)):this.#H.render(this.#B,this.opacity))}getBoundingBox(){let e=this.#H.getBoundingBoxCanvas();return new L(this.position.x-e.width/2,this.position.y-e.height/2,e.width,e.height)}getImageFilename(){if(!this.#H.forEach)return this.#H.getImageFilename();for(let e of this.#H){let t=e.getImageFilename();if(t)return t}return null}}class eN{decoratedModifier;#K;#V;#Y;constructor(e){this.#V=0,this.#Y=0,this.decoratedModifier=e}#X(e){this.#K&&(this.#K(e),this.#K=null)}kill(){this.#X()}cleanUpOnTimeout(e){}applyAsTransientToSprite(e,t=10){return this.#Y=t,new Promise(t=>{this.#K=t,e.replaceTransientModifier(this)})}applyAsContinuousToSprite(e){e.replaceBaseModifier(this)}update(e,t){this.#K&&(this.#V+=t),this.decoratedModifier&&(this.decoratedModifier=this.decoratedModifier?.update(e,t));let i=this.doUpdate(e,t);return(this.#V>this.#Y&&(this.cleanUpOnTimeout(e),i=null),i)?i:(this.#X(null),null)}doUpdate(e,t){return m.error("doUpdate should be overridden."),this}}class eP extends eN{#q;#j;#Z;#J;constructor(e,t,i){super(i),this.#j=e,this.#J=.3*t;let r=t-this.#J;this.#q=1/Math.max(r,.5),this.#Z=0}doUpdate(e,t){return this.#Z+=t,this.#Z>this.#j+this.#J?e.opacity=Math.max(0,1-(this.#Z-this.#j-this.#J)*this.#q):e.opacity=1,e.opacity>0?this:null}}class ev{#Q;#ee;constructor(e,t){this.#Q=e,this.#ee=t}getSpeedBetweenPoints(e,t){return this.#ee?this.#Q:(1+.1*(Math.abs(e.x-t.x)+Math.abs(e.y-t.y)))*this.#Q}}class eL extends eN{#et;#ei;constructor(e){super(e)}doUpdate(e,t){return e.position.x+=e.velocity.x*t,e.position.y+=e.velocity.y*t,e.position.rotation+=e.velocity.rotation*t,e.acceleration&&(e.velocity.x+=e.acceleration.x*t,e.velocity.y+=e.acceleration.y*t,e.velocity.rotation+=e.acceleration.rotation*t),this}}class eD extends eN{#er;constructor(e=-Math.PI/2,t){super(t),this.#er=e}static createUprightAligner(e){return new eD(-Math.PI/2,e)}doUpdate(e,t){return e.position.rotation=e.velocity.isZero(.1)?0:e.velocity.getScreenDirection()-this.#er,this}}class eM extends eN{#ea;#en;#es;constructor(e,t){super(t),this.#ea=e.prey,this.#en=e.maxSeparation,this.#es=new ev(e.speed,e.linear)}doUpdate(e,t){let i=this.#ea.position,r=e.position,a=this.#es.getSpeedBetweenPoints(i,r);if(!r.withinSquare(i,this.#en)){let n=r.getCartesianAngleTo(i);e.velocity.x=a*Math.cos(n),e.velocity.y=a*Math.sin(n);let s=e.velocity.x*t,o=e.velocity.y*t;e.position.x+=this.getMinMove(s,i.x,r.x),e.position.y+=this.getMinMove(o,i.y,r.y)}return this}getMinMove(e,t,i){let r=t-i;return 0>Math.sign(e)?Math.max(e,r):Math.min(e,r)}}class eb extends eN{#eo;#h;#el;#es;constructor(e,t){super(t),this.#eo=e.path,this.#h=0,this.#el=e.path[0],this.#es=new ev(e.speed,e.linear)}cleanUpOnTimeout(e){m.debug("Transient path follower timed out. Moving to end of path.");let t=this.#eo[this.#eo.length-1];e.position.x=t.x,e.position.y=t.y}doUpdate(e,t){let i=e.position,r=this.#es.getSpeedBetweenPoints(this.#el,i),a=i.getCartesianAngleTo(this.#el);e.velocity.x=r*Math.cos(a),e.velocity.y=r*Math.sin(a);let n=e.velocity.x*t,s=e.velocity.y*t;if(i.x+=this.getMinMove(n,this.#el.x,i.x),i.y+=this.getMinMove(s,this.#el.y,i.y),i.isCoincident(this.#el)){if(++this.#h>=this.#eo.length)return e.velocity.x=0,e.velocity.y=0,this.decoratedModifier;this.#el=this.#eo[this.#h]}return this}getMinMove(e,t,i){let r=t-i;return 0>Math.sign(e)?Math.max(e,r):Math.min(e,r)}}function e_(e,t){return new eb({path:[t],speed:100},e.sprite.modifier).applyAsTransientToSprite(e.sprite)}function ez(e,t){let i=new eC({renderer:e});i.position=t.position,i.velocity=t.velocity??new N(0,0,0),i.acceleration=t.acceleration??new P(0,0,0),el.addPassiveSprite(i),new eP(t.delaySecs,t.lifetimeSecs,new eL).applyAsTransientToSprite(i,20).then(()=>el.removePassiveSprite(i))}function ek(e,t){ez(new eR(Q.getContext2D(),e),t)}function eB(e,t){ez(new eA(Q.getContext2D(),e,{color:t.color}),t)}function eG(e,t,i="white"){eB(e,{color:i,delaySecs:2,lifetimeSecs:3,position:new C(t.x,t.y),velocity:new N(0,-48,0),acceleration:new P(0,-96,0)})}var eU={TILE_SIZE:48};function eH(e){var t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i)|0;return Math.abs(t).toString(16).toLowerCase().padStart(8,"0")}const eF=new class{#eh;#ec;constructor(){this.#eh=localStorage,this.#ec=new Map}set(e,t){this.#ec.set(e,t);try{this.#eh.setItem(e,this.toChecksummed(JSON.stringify(t)))}catch(e){m.error(`Cannot save setting. ${e.message}`)}}get(e,t,i){if(this.#ec.has(e))return this.#ec.get(e);let r=t;try{let t=this.#eh.getItem(e);null!==t&&(r=JSON.parse(this.fromChecksummed(t),i))}catch(e){m.error(`Cannot parse value from local storage. ${e.message}`)}return this.#ec.set(e,r),r}clearAll(){this.#eh.clear(),this.#ec.clear(),m.info("All local storage cleared.")}setStorage(e){this.#eh=e}toChecksummed(e){let t=eH(e);return`${t}*${e}`}fromChecksummed(e){let t=e.match(/^([a-z0-9]{8})\*(.*)$/);if(t){if(t[1]===eH(t[2]))return t[2];throw Error("Invalid checksum")}throw Error("Invalid format")}};class e${#eu;_element;#ed;#ep;closes;constructor(e){if(e.closes&&e.action)throw Error("Attempt made to create control that is set to close forms and perform and action. These are mutually exclusive.");if(e.persistent&&!e.id)throw Error("Persistent controls must have an ID set in the options.");this.#eu=e.id,this.#ep=e.persistent,e.persistent?this.#ed=eF.get(this.#eu,e.defValue):this.#ed=e.defValue,this.closes=e.closes,this.listeners=0}get element(){return this._element}get value(){return this.#ed}set value(e){e!==this.#ed&&(this.#ep&&eF.set(this.#eu,e),this.#ed=e)}}class eW extends e${constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return t.appendChild(document.createTextNode(e.label)),t.className="text-button",t}}class eK extends e${constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return e.leftLabel&&t.appendChild(document.createTextNode(e.leftLabel)),t.appendChild(eV(e.imageName,"button-icon")),e.rightLabel&&t.appendChild(document.createTextNode(e.rightLabel)),t.className="icon-button",t}}function eV(e,t){let i=ep.getSpriteBitmap(e??"undefined.png",{fallback:"undefined.png"}),r=document.createElement("canvas");r.setAttribute("width",eU.TILE_SIZE),r.setAttribute("height",eU.TILE_SIZE);let a=r.getContext("2d");return a.clearRect(0,0,eU.TILE_SIZE,eU.TILE_SIZE),a.drawImage(i.image,.5*(eU.TILE_SIZE-i.width),.5*(eU.TILE_SIZE-i.height)),r.className=t,r}class eY extends e${#ef;constructor(e){super(e),this._element=this.buildElement(e.label),this.#ef.checked=this.value,this._element.addEventListener("change",t=>{this.value=this.#ef.checked,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-checkbox",this.#ef=document.createElement("input"),this.#ef.setAttribute("type","checkbox"),t.appendChild(this.#ef),t.appendChild(eV("ui-checkbox00.png","unchecked")),t.appendChild(eV("ui-checkbox01.png","checked"));let i=document.createElement("label");return i.appendChild(document.createTextNode(e)),i.appendChild(t),i}}class eX extends e${#em;constructor(e){super(e),this._element=this.buildElement(e.label),this.#em.value=this.value,this._element.addEventListener("change",t=>{this.value=this.#em.value,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-range",this.#em=document.createElement("input"),this.#em.setAttribute("type","range"),t.appendChild(this.#em);let i=document.createElement("label");return i.appendChild(document.createTextNode(e)),i.appendChild(t),i}}const eq={TEXT_BUTTON:"text button",CHECKBOX:"checkbox",RANGE:"range"};function ej(e,t={}){let i=document.createElement(e);return t.className&&(i.className=t.className),t.html?i.innerHTML=t.html:t.text&&(i.innerText=t.text),t.child&&i.appendChild(t.child),i}function eZ(e){let i=t?.get(e);return null==i?e:Array.isArray(i)?i[A(0,i.length)]:i}function eJ(e,...t){let i,r="";for(let t of e){let e=t.trim();if(""!==e){i=e;break}}return i?(r=eZ(i),t.forEach((e,t)=>{let i=RegExp(`\\$\\{${t}[a-zA-Z_-]*\\}`);r=r.replace(i,e)}),r):t?t.join(" "):""}const eQ={setMap:function(e){t=e},getText:eZ},e4=new class{onStartAnimation;#eg;#eS;constructor(){this.#eg=!1,this.#eS=void 0,window.addEventListener("blur",()=>{m.debug(`Blur: current animation state ${this.#eg}`),this.#eS=this.#eg,this.setAnimationState(!1)}),window.addEventListener("focus",()=>{m.debug(`Focus: saved animation state ${this.#eS}`),this.setAnimationState(this.#eS??!0),this.#eS=void 0})}setAnimationState(e){e!==this.#eg&&(this.#eg=e,this.#eg&&this.onStartAnimation&&this.onStartAnimation())}isAnimationOn(){return this.#eg}},e0={OK:0,CANCEL:1};function e1(){e4.setAnimationState(!1)}function e8(e,t){return Q.displayOnGlass(e,t).then(e=>(e4.setAnimationState(!0),e))}function e3(e,t){let i=ej("div",{className:"dialog-scroll-content"});if(t&&i.appendChild(ej("p",{className:"dialog-title",text:t})),Array.isArray(e))for(let t of e)i.appendChild(e3(t));else i.appendChild(ej("p",{text:e}));return i.classList.add(["scrollable"]),i}function e2(e,t={}){e1();let i=document.createElement("div"),r=ej("div",{className:"dialog-scroll-content"});i.appendChild(r),t.title&&r.appendChild(ej("p",{className:"dialog-title",text:t.title})),t.preamble&&(t.preamble instanceof Element?r.appendChild(t.preamble):r.appendChild(ej("p",{text:t.preamble}))),e instanceof Element?r.appendChild(e):r.appendChild(e3(e));let a=ej("div",{className:t.row?"action-buttons-row":"action-buttons-col"});i.appendChild(a);let n=[];if(t?.actionButtons?.forEach(e=>{e.element.parentElement||a.appendChild(e.element),null!==e.closes&&void 0!==e.closes&&n.push({element:e.element,closes:e.closes})}),0===n.length){let e=new eW({id:e0.OK,label:t.okButtonLabel??eJ`BUTTON OK`});a.appendChild(e.element),n.push(e)}return e8(i,{closers:n,className:t?.className})}var e5={popupElement:function(e){let t=document.createElement("div");t.className="popup";let i=document.createElement("div");return t.appendChild(i),i.appendChild(e),t.style.opacity=1,document.body.appendChild(t),t},showChoiceDialog:function(e,t,i){document.createElement("div").appendChild(e3(t,e));let r=[];return i?.forEach((e,t)=>{let i=new eW({label:e,closes:t});r.push(i)}),e2(t,{preamble:e,actionButtons:r,row:!0})},showMessage:function(e){let t=document.createElement("div");t.appendChild(document.createTextNode(e)),t.className="popup",t.style.opacity=1,document.body.appendChild(t),t.addEventListener("click",()=>t.remove())},showOkDialog:function(e,t={}){e1();let i=document.createElement("div");i.appendChild(e3(e,t.title));let r=document.createElement("button");return r.appendChild(document.createTextNode(t.okButtonLabel??eJ`BUTTON OK`)),i.appendChild(r),e8(i,{className:t?.className,closers:[{element:r,closes:e0.OK}]})},showElementOkDialog:function(e,t,i=eJ`BUTTON OK`,r){e1();let a=document.createElement("div"),n=ej("div",{className:"dialog-scroll-content"});a.appendChild(n),e&&n.appendChild(ej("p",{className:"dialog-title",text:e})),n.appendChild(t);let s=document.createElement("button");return s.appendChild(document.createTextNode(i)),a.appendChild(s),e8(a,{closers:[{element:s,closes:e0.OK}],className:r})},showControlsDialog:e2};const e6=new class{#ew;#eE;#eT;#ey;constructor(){this.#eT=.5,this.#ey=.5,this.#ew=new Map}loadAndPlayMusic(e){if(this.#eE)throw Error("Only one music track currently supported.");this.#eE=this.#eA(e),this.#eE&&this.#eE.addEventListener("canplay",e=>{this.#eE.volume=this.#eT,this.#eE.loop=!0,this.#eE.play(),window.addEventListener("blur",()=>{this.#eE.pause()}),window.addEventListener("focus",()=>{this.#eE.play()})})}loadEffects(e){let t=[];return e.forEach((e,i)=>{let r=new Promise(t=>{let r=this.#eA(e);r&&r.addEventListener("canplay",e=>{this.#ew.set(i,r),t()})});t.push(r)}),Promise.all(t)}#eA(e){return e?new Audio(e):null}playEffect(e){let t=this.#ew.get(e);t&&(t.volume=this.#ey,t.play())}setMusicVolumePercent(e){this.#eT=e/100,this.#eE&&(this.#eE.volume=this.#eT)}setEffectsVolumePercent(e){this.#ey=e/100}},e9=/^ *(\d+(?:\.\d*)?) *([a-zA-Z]+) *$/,e7=new Map([["PP",10],["GP",1],["SP",.1],["CP",.01]]);function te(e){let t=0,i=0,r=e.match(e9);if(!r)return m.error(`Unrecognised coin "${e}". Value set to zero.`),{valueFace:0,valueGp:0,type:"GP"};{t=r[1];let e=e7.get(r[2])??0;i=parseFloat(r[1])*e}return{valueFace:t,valueGp:i,type:r[2]}}const tt=/(\d+)[dD](\d+)(?: *\+ *(\d+))?/;function ti(e=6){return I(1,e)}function tr(e){return tt.test(e)}function ta(e){if(!e)return 1;if(Number.isInteger(e))return ti(e);let t=ts(e);if(!t)return m.error(`String ${e} not recognised as a dice roll. Defaulting to 1D1.`),1;let i=0;for(let e=0;e<t.qty;e++)i+=ti(parseInt(t.sides))+t.offset;return i}function tn(e){let t=ts(e);return t?t.qty*(t.sides+t.offset):1}function ts(e){let t=e?.match(tt);return t?{qty:parseInt(t[1]),sides:parseInt(t[2]),offset:t[3]?parseInt(t[3]):0}:(m.error(`Invalid dice format: ${e}`),{qty:0,sides:0,offset:0})}function to(e){return e?e.offset?`${e.qty}D${e.sides}+${e.offset}`:`${e.qty}D${e.sides}`:""}const tl=[10,200,450,700,1100,1800,2300,2900,3900,5e3,5900,7200,8400,1e4,11500,13e3,15e3,18e3,2e4,22e3,25e3,33e3,41e3,5e4,62e3,75e3,9e4,105e3,12e4,135e3,155e3],th=[{exp:0,profBonus:2},{exp:300,profBonus:2},{exp:900,profBonus:2},{exp:2700,profBonus:2},{exp:6500,profBonus:3},{exp:14e3,profBonus:3},{exp:23e3,profBonus:3},{exp:34e3,profBonus:3},{exp:48e3,profBonus:4},{exp:64e3,profBonus:4},{exp:85e3,profBonus:4},{exp:1e5,profBonus:4},{exp:12e4,profBonus:5},{exp:14e4,profBonus:5},{exp:165e3,profBonus:5},{exp:195e3,profBonus:5},{exp:225e3,profBonus:6},{exp:265e3,profBonus:6},{exp:305e3,profBonus:6},{exp:355e3,profBonus:6}],tc=[[13,15],[12,14],[11,13],[8,13],[8,13],[8,13]],tu=[8,15],td=new Map([["BARBARIAN",["STR","CON","DEX","INT","WIS","CHA"]],["CLERIC",["WIS","CON","STR","CHA","INT","DEX"]],["FIGHTER",["STR","DEX","CON","INT","WIS","CHA"]],["RANGER",["STR","DEX","INT","CHA","CON","WIS"]],["ROGUE",["DEX","INT","CHA","STR","CON","WIS"]],["WIZARD",["INT","WIS","STR","CON","DEX","CHA"]],["DEFAULT",["STR","CON","DEX","INT","WIS","CHA"]]]),tp=new Map([["ROGUE",{pbMultiplier:2}],["DEFAULT",{pbMultiplier:1}]]),tf=new Map([["BARBARIAN",[4,8,12,16,19]],["CLERIC",[4,8,12,16,19]],["FIGHTER",[4,6,8,12,14,16,19]],["RANGER",[4,8,12,16,19]],["ROGUE",[4,8,10,12,16,19]],["WIZARD",[4,8,12,16,19]]]);function tm(e){let t=Math.round(4*(2+20*(e.getCharacterLevel()-1)/19));return e.set("CASTING_POWER",t),t}const tg={VERY_EASY:5,EASY:10,MEDIUM:15,HARD:20,VERY_HARD:25,NEARLY_IMPOSSIBLE:30,IMPOSSIBLE:999};function tS(e,t){let i=e.rollForAttack();if(1===i.roll)return m.info("Attack dice rolled 0: cursed."),0;if(20===i.roll)return m.info("Attack dice rolled 20: critical hit. Damage will be doubled."),2*e.rollForDamage();let r=t.getEffectiveInt("AC");return(m.info(`Attack: rolled ${i.roll}; value ${i.value} vs target AC ${r}`),i.value>=r)?e.rollForDamage():0}function tw(e,t){let i=ta(e.get("DMG","1D4")),r=t.getNonMeleeSaveAbilityModifier(e),a=e.getInt("DC");return a?ti(20)+r>=a?0:i:(m.error(`Poisoner ${e.get("NAME")} has no DC set.`),i)}const tE={NONE:"",NEED_LONG_REST:"need long rest",NEED_MORE_RATIONS:"need more rations"};function tT(e,t){let i=e.traits.getInt("HP",0),r=i;switch(t){case"SHORT":{let t=e.traits.get("HIT_DICE"),a=e.traits.getInt("HP_MAX",i),n=e.traits.getAsModifier("CON"),s=ts(t);s.qty>0&&(s.qty--,r=Math.min(r=i+ti(s.sides)+n,a),e.traits.set("HP",r),e.traits.set("HIT_DICE",to(s)))}break;case"LONG":{let t=e.traits.getCharacterLevel(),a=ts(e.traits.get("HIT_DICE")),n=Math.max(1,Math.ceil(.5*a.qty));a.qty=Math.min(t,a.qty+n),e.traits.set("HIT_DICE",to(a)),r=e.traits.getInt("HP_MAX",i),e.traits.set("HP",r),e.toxify.cure(),tm(e.traits)}break;default:m.error(`Attempt to rest for unknown length of ${t}`)}return{oldHp:i,newHp:r}}function ty(e,t){let i=tx(e.getInt(t.ability,1)),r=t.proficiency?e.getCharacterPb(t.proficiency):0;return ti(20)+i+r>=t.difficulty}const tA=["STR","DEX","CON","INT","WIS","CHA","AC"];function tx(e){return Math.floor((e-10)/2)}class tI{damageDice;proficiencyBonus;abilityModifier;#ex;unarmed;constructor(e){this.damageDice=e.damageDice??"1D1";let t=e.weaponType??"";"UNARMED"===t?(this.unarmed=!0,this.#ex=!1):t.includes("SIMPLE")&&t.includes("LIGHT")?(this.unarmed=!1,this.#ex=!0):(this.unarmed=!1,this.#ex=!1),this.proficiencyBonus=e?.proficiencyBonus??0,this.abilityModifier=e?.abilityModifier??0}#eI(){return 1+this.abilityModifier}getMaxDamage(){return this.unarmed?this.#eI():tn(this.damageDice)+this.abilityModifier}canUseTwoWeapons(){return this.#ex}rollForAttack(){let e=ti(20);return m.info(`Attack roll ${e} + ability(${this.abilityModifier})+ proficiency(${this.proficiencyBonus})`),{roll:e,value:e+this.abilityModifier+this.proficiencyBonus}}rollForDamage(){if(this.unarmed)return this.#eI();let e=ta(this.damageDice)+this.abilityModifier;return m.debug(`Damage: ${this.damageDice} + ability(${this.abilityModifier}) = ${e}`),e}clone(){let e=new tI({});return e.abilityModifier=this.abilityModifier,e.damageDice=this.damageDice,e.proficiencyBonus=this.proficiencyBonus,e.#ex=this.#ex,e.unarmed=this.unarmed,e}}class tO{_traits;constructor(e){"string"==typeof e?(this._traits=new Map,this.#eO(e)):this._traits=new Map(e)}#eO(e){return e.split(",").forEach(e=>{let t=e.match(/^\s*(\w+)\s*[=: ]\s*(.+?)\s*$/);if(!t)return;let[i,r]=this.#eR(t[1],t[2]);if(t)this.#eC(i,r.trim());else throw Error(`Invalid property definition'${e}'`)}),this}has(e){return this._traits.has(e)||this._traits.has("_"+e)}set(e,t){this._traits.set(e,t),this._refreshDerivedValues(e)}get(e,t){return this._traits.get(e)??this._traits.get("_"+e)??t}delete(e){return this._traits.delete(e)}_refreshDerivedValues(e){}getInt(e,t){return O(this.get(e,t),t)}addInt(e,t){let i=this.getInt(e),r=O(t)+i;this._traits.set(e,r)}getValueInFeetInTiles(e,t){let i=this.getInt(e);return null==i?t:tO.feetToTiles(i)}static feetToTiles(e){return Math.round(e/7.5)}getFloat(e,t){return R(this.get(e,t),t)}getAsModifier(e,t){let i=this.getInt(e);return null==i?t:tx(i)}#eR(e,t){return"NAME"!==(e=e.toUpperCase())&&"REWARD"!==e&&(t=t.toUpperCase()),[e,t]}#eC(e,t){switch(e){case"PROF":case"_PROF":return this.#eN(e,t);case"VALUE":case"_VALUE":return this.#eP(e,t);case"DMG":case"_DMG":case"HP_GAIN":case"_HP_GAIN":return this.#ev(e,t);case"HIT_DICE":case"_HIT_DICE":return this.#eL(e,t);case"DC":case"_DC":case"IDENTIFY_DC":case"_IDENTIFY_DC":return this.#eD(e,t);default:return this.#eM(e,t)}}#eP(e,t){let i=t.match(/^(.*)([a-zA-Z]{2})$/);if(i){let e;let r=i[1].trim();e=tr(r)?ta(r):O(i[1],0),t=`${e} ${i[2]}`}else m.error(`Invalid value for VALUE trait: ${t}`),t="0 GP";this.set(e,t)}#eD(e,t){let i;i=isNaN(t)?tg[t]??1:O(t),this.set(e,i)}#eL(e,t){tr(t)||(m.error(`Invalid trait value ${t} for ${e}. Dice definition required.`),t="1D6"),this.set(e,t)}#ev(e,t){let i;tr(t)?i=t:isNaN(i=parseInt(t))&&(m.error(`Invalid trait value ${t} for ${e}. Integer or dice definition required.`),i=0),this.set(e,i)}#eM(e,t){"YES"===t||"TRUE"===t?t=!0:"NO"===t||"FALSE"===t?t=!1:tr(t)&&"DMG"!==e&&(t=ta(t)),this.set(e,t)}#eN(e,t){let i=t.split(/\s*&\s*/),r=[];i.forEach(e=>r.push(e.toUpperCase())),this._traits.set(e,r)}clone(){return new tO(this._traits)}getAllTraits(){return new Map([...this._traits.entries()])}getAllTraitsSorted(){return new Map([...this._traits.entries()].sort())}valuesToString(){let e="";return this._traits.forEach((t,i)=>{""!==e&&(e+=","),e+=`${i}:${t}`}),e}toJSON(){return{reviver:"Traits",data:[...this._traits]}}static revive(e){return new tO(new Map(e))}}class tR extends tO{constructor(e){super(e??new Map)}getDamageDiceWhenCastBy(e){let t=this.get("DMG");return this.#eb(t,e)}getHpGainDiceWhenCastBy(e){let t=this.get("HP_GAIN");return this.#eb(t,e)}#eb(e,t){let i=this.getFloat("DICE_PER_LEVEL",0),r=function(e,t){let i=ts(e);return i?(i.qty=Math.max(i.qty+t,0),to(i)):e}(e,Math.floor((t.getCharacterLevel()-1)*i));return m.info(`Spell cast: base dice = ${e} raised to ${r} for level.`),r}toJSON(){let e=super.toJSON();return e.reviver="MagicTraits",e}static revive(e){return new tR(new Map(e))}}class tC extends tO{_proficiencyBonus;_level;_attacks;_availableArtefactTraits;_transientFxTraits;_effectiveTraits;_maxTileMovePerTurn;_allowRefreshDerived=!1;constructor(e){super(e??new Map([["NAME","mystery"]])),this._proficiencyBonus=0,this.#e_(),this._transientFxTraits=[],this._allowRefreshDerived=!0,this._refreshDerivedValues()}getMaxTilesPerMove(){return this._maxTileMovePerTurn}clone(){let e=new tC(this._traits);return e._proficiencyBonus=this._proficiencyBonus,e._level=this._level,e._attacks=this._attacks.map(e=>e.clone()),e._availableArtefactTraits=this._availableArtefactTraits,e._effectiveTraits=this._effectiveTraits.clone(),e._transientFxTraits=[],this._transientFxTraits.forEach(t=>e._transientFxTraits.push(t.clone())),e._maxTileMovePerTurn=this._maxTileMovePerTurn,e}exceedAbilitiesAndExp(e,t=0){["STR","DEX","INT","WIS","CON","CHA","EXP"].forEach(i=>{let r=e.getInt(i)+t;r>this.getInt(i)&&this.set(i,r)})}addTransientFxTraits(e){let t=new tO,i=!1;tA.forEach(r=>{let a=tC.toFxKey(r),n=e.getInt(a);n&&(i=!0,t.set(a,n))}),i&&(this._transientFxTraits.push(t),this._refreshDerivedValues())}clearTransientFxTraits(){this._transientFxTraits=[],this._refreshDerivedValues()}#e_(){(function(e){let t=new Map,i=td.get(e)??td.get("DEFAULT");for(let e=0;e<i.length;e++){let r=e<tc.length?tc[e]:tu,a=I(r[0],r[1]);t.set(i[e],a)}return t})(this.get("CLASS")).forEach((e,t)=>{this.get(t)||this.set(t,e??8)}),this.has("EXP")||this.set("EXP",0)}_updateHitPoints(){let e=this._traits.has("HP"),t=this._traits.has("HP_MAX"),i=this.get("HIT_DICE");if(!e||!t||i){if(i){let t=tx(this.getInt("CON",0)),r=tn(i),a=r+t+(this._level-1)*(Math.ceil((r+1)/2)+t);this.set("HP_MAX",a),e||this.set("HP",tn(i)+t)}else e&&this.set("HP_MAX",this.get("HP"))}}static toFxKey(e){return`FX_${e}`}hasEffective(e){return!!this._effectiveTraits&&this._effectiveTraits.has(e)}getEffective(e,t){return this._effectiveTraits.get(e)??this.get(e,t)}getEffectiveInt(e,t){return O(this.getEffective(e),t)}getCharacterLevel(){return this._level}getNonMeleeSaveAbilityModifier(e){let t=e.get("SAVE_BY");return t?tx(this.getInt(t)??0):(m.error(`Non-melee ${e.get("NAME")} has no SAVE_BY set.`),0)}getCharacterPb(e){return this.isProficient(e)?this._proficiencyBonus:0}getAttacks(){return this._attacks}utiliseAdditionalTraits(e){this._availableArtefactTraits=e,this._refreshDerivedValues()}_refreshDerivedValues(e){this._allowRefreshDerived&&(!e||tA.includes(e))&&(this._adjustForExperience(),this._updateHitPoints(),this._initialiseEffectiveTraits(),"ENEMY"===this._traits.get("TYPE_ID")?this._deriveValuesFromTraits():(this._utiliseTransientTraits(),this._utiliseMagicTraits(),this._utiliseWeaponsTraits(),this._utiliseArmourAndShieldTraits(),this._adjustMovementForArmour()))}_deriveValuesFromTraits(){this._maxTileMovePerTurn=this.getValueInFeetInTiles("SPEED",1),this._attacks=[];let e=tx(this.getInt("STR",1)),t=new tI({damageDice:this._traits.get("DMG"),weaponType:"ALMANAC",proficiencyBonus:this._traits.get("PB",0),abilityModifier:e,secondAttack:!1});this._attacks.push(t)}_initialiseEffectiveTraits(){this._effectiveTraits=new tO,tA.forEach(e=>{this._effectiveTraits.set(e,this.getInt(e,0))})}_utiliseTransientTraits(){this._transientFxTraits?.forEach(e=>{m.debug(`Transient traits: ${e.valuesToString()}`),this._addFxTraitsToEffectiveTraits(e)})}_addFxTraitsToEffectiveTraits(e){tA.forEach(t=>{let i=e.getInt(tC.toFxKey(t));i&&this._effectiveTraits.addInt(t,i)})}_utiliseMagicTraits(){if(this?._availableArtefactTraits?.magic)for(let e of this._availableArtefactTraits.magic)m.debug(`Magic traits: ${e.valuesToString()}`),this._addFxTraitsToEffectiveTraits(e)}_utiliseArmourAndShieldTraits(){let e=this.getEffectiveInt("AC",0),t=this?._availableArtefactTraits?.armour,i=this?._availableArtefactTraits?.shields,r=0,a=0;t?.forEach(t=>{let i=this._getAcFromTraits(t);i.additional?r+=i.value:i.value>e&&(e=i.value)}),i?.forEach(e=>{a=Math.max(a,e.getInt("AC",0))});let n=e+r+a;this._effectiveTraits.set("AC",n)}_adjustMovementForArmour(){let e=this.getFloat("SPEED",1);if(this._maxTileMovePerTurn=Math.max(1,tO.feetToTiles(e)),this._availableArtefactTraits?.armour){for(let t of this._availableArtefactTraits.armour)if(t.get("TYPE","").toUpperCase().includes("HEAVY")&&t.getInt("STR",0)>this.getEffectiveInt("STR")){this._maxTileMovePerTurn=Math.max(1,tO.feetToTiles(e-10));return}}}_utiliseWeaponsTraits(){var e;let t,i,r,a,n;this._attacks=[];let s=this?._availableArtefactTraits?.weapons??[],o=tx(this.getEffectiveInt("STR",1)),l=(e=this.get("CLASS"),tp.get(e)??tp.get("DEFAULT")),h=this._proficiencyBonus*l.pbMultiplier;s.length>2&&m.error(`Unexpected number of equipped weapons. Expected 2; received ${s.length}`),0===s.length?(r="",i="UNARMED",a=!0):(r=s[0].get("DMG","1D1")??"1D1",i=s[0].get("TYPE")??"",a=this.isProficient(s[0])),t=new tI({damageDice:r,weaponType:i,proficiencyBonus:a?h:0,abilityModifier:o}),s.length>1&&(n=new tI({damageDice:s[1].get("DMG","1D1")??"1D1",weaponType:s[1].get("TYPE")??"",proficiencyBonus:this.isProficient(s[1])?h:0,abilityModifier:o})),n?.canUseTwoWeapons()&&t.canUseTwoWeapons()?(this._attacks.push(t),n.abilityModifier>0&&(n.abilityModifier=0),this._attacks.push(n)):n&&n.getMaxDamage()>t.getMaxDamage()?this._attacks.push(n):this._attacks.push(t)}_getAcFromTraits(e){let t=tx(this.getEffectiveInt("DEX",1)),i=e.get("TYPE","").toUpperCase(),r=e.get("AC",1),a=O(r);return i.includes("MEDIUM")?a+=Math.min(2,t):i.includes("HEAVY")||(a+=t),{additional:/^[+-]/.test(r),value:a}}_adjustForExperience(){let e=this._level??1,t=function(e){let t=O(e,0),i=0,r=0;do if(t>=th[r++].exp)i=r;else break;while(r<th.length)return{level:i,profBonus:th[i-1].profBonus}}(this._traits.get("EXP"));this._level=t.level,this._proficiencyBonus=t.profBonus,this._adjustTraitsForLevelChange(e,this._level)}_adjustTraitsForLevelChange(e,t){var i;let r=(i=this.get("CLASS"),{levels:tf.get(i)??[],traits:td.get(i)??td.get("DEFAULT"),gainPerAdjustment:2,maxAbility:20});if(0===r.levels.length)return;let a=0;for(let i of r.levels){if(i>t)break;i>e&&(a+=r.gainPerAdjustment)}let n=0;for(;a>0&&n<r.traits.length;){let e=r.traits[n],t=this.get(e);t<r.maxAbility?(this.set(e,t+1),a--):n++}}adjustForDefeatOfActor(e){let t;let i=(t=R(e.get("CR")))<.124?10:t<.249?25:t<.499?50:t<.999?100:(t=Math.min(tl.length-1,parseInt(t)),tl[t]),r=this.getInt("EXP",0),a=r+i;m.info(`Experience increased from ${r} to ${a}.`),this.set("EXP",a);let n=this._level;return this._adjustForExperience(),{exp:{was:r,now:a},level:{was:n,now:this._level}}}isProficient(e){let t=this.get("PROF"),i="string"==typeof e?e:e.get("TYPE");if(!t||!i)return!1;for(let e of t){let t=e.split(" "),r=!0;for(let e of t)if(!i.includes(e)){r=!1;break}if(r)return!0}return!1}toJSON(){let e=super.toJSON();return e.reviver="CharacterTraits",e}static revive(e){return new tC(new Map(e))}}function tN(e="?"){if(e.len<2)return e;let t=e.replace(/_pv$/i,"").replace(/_/g," "),i=t.charAt(0).toUpperCase()+t.substring(1);return eQ.getText(i)}function tP(e){let t=`DESCRIPTION ${e.toUpperCase()}`,i=eQ.getText(t);return t===i?(m.error(`No description set for ${t}.`),""):i}function tv(e){return fetch(e).then(e=>e.text()).then(e=>e).catch(t=>(m.error(`Error fetching ${e}: ${t}`),null))}const tL={COMMON:"COMMON",UNCOMMON:"UNCOMMON",RARE:"RARE",VERY_RARE:"VERY RARE"};class tD{static COMMON_CUTOFF=.7207207207207207;static UNCOMMON_CUTOFF=.9459459459459459;static RARE_CUTOFF=.990990990990991;static VERY_RARE_CUTOFF=1;common;uncommon;rare;veryRare;constructor(){this.common=[],this.uncommon=[],this.rare=[],this.veryRare=[]}mergeAlmanac(e){this.common.push(...e.common),this.uncommon.push(...e.uncommon),this.rare.push(...e.rare),this.veryRare.push(...e.veryRare)}find(e){let t=this.common.find(e);return t||(t=this.uncommon.find(e))||(t=this.rare.find(e))?t:this.veryRare.find(e)}filter(e){let t=new tD;return t.common=e?this.common.filter(e):[...this.common],t.uncommon=e?this.uncommon.filter(e):[...this.uncommon],t.rare=e?this.rare.filter(e):[...this.rare],t.veryRare=e?this.veryRare.filter(e):[...this.veryRare],t}getRandomEntry(){let e=Math.random();return e<tD.COMMON_CUTOFF?this.getRandomCommonEntry():e<tD.UNCOMMON_CUTOFF?this.getRandomUncommonEntry():e<tD.RARE_CUTOFF?this.getRandomRareEntry():this.getRandomVeryRareEntry()}getRandomCommonEntry(){return x(this.common)}getRandomUncommonEntry(){return 0===this.uncommon.length?this.getRandomCommonEntry():x(this.uncommon)}getRandomRareEntry(){return 0===this.rare.length?this.getRandomUncommonEntry():x(this.rare)}getRandomVeryRareEntry(){return 0===this.veryRare.length?this.getRandomRareEntry():x(this.veryRare)}}function tM(e,t){var i;let r=e.match(/^ *(\d+) *, *(\w+ ?\w+) *, *(\w+) *, *([\w+]*) *(?:\[ *([\w, ]*?)])? *\*(.*)$/);if(!r)return m.error(`Invalid almanac entry ${e}`),null;let a={},n=r[6]??"";a.minLevel=parseInt(r[1]),a.rarity=r[2].toUpperCase(),a.typeId=r[3],a.type=tb.getItemType(t,a.typeId),a.id=r[4];let s=function(e="?"){let t=e.split("+"),i=t.length>1,r=t[0];return e?{name:tN(r),imageName:t[0].toLowerCase(),description:tP(e),unknownDescription:i?tP(r):void 0}:{}}(a.id);return a.name=s.name,a.imageName=s.imageName,a.description=s.description,a.unknownDescription=s.unknownDescription,a.equipmentIds=(i=r[5])?i.trim().split(/\s*,\s*/):i,a.traitsString=`_TYPE_ID:${a.typeId},${n}`,a.challengeRating=function(e){let t=e?.match(/CR *[:=] *([\d.]+)/);return t?R(t[1],0):0}(a.traitsString),a}const tb=new class{#ez;constructor(){this.#ez=new Map}addAlmanac(e,t){this.#ez.set(e,t)}getAlmanac(e){let t=this.#ez.get(e);return t||m`Attempt to get non-existent almanac ${e}`,t}getRandomEntry(e,t){let i;i=Array.isArray(e)?x(e):e;let r=this.getAlmanac(i).filter(t);if(r)return r.getRandomEntry();m.error(`Failed to find almanac with key ${i}`)}findById(e,t){for(let i of(t||(t=this.#ez.keys()),t)){let t=this.#ez.get(i)?.find(t=>t.id===e);if(t)return t}m.error(`Failed to find almanac entry for '${e}' in ${t.join(", ")}`)}getPooledAlmanac(e,t){let i=new tD;return e.forEach(e=>{let r=this.getAlmanac(e).filter(t);i.mergeAlmanac(r)}),i}getItemType(e,t){switch(e){case"HEROES":case"ENEMIES":case"OBJECTIVES":case"TRADERS":return function(e){let t=aS[e];return null==t&&m.error(`Unrecognised actor type: ${e}`),t}(t);default:return function(e){let t=tk[e];return null==t&&m.error(`Unrecognised artefact type: ${e}`),t}(t)}}};function t_(e,t){let i,r;e.type===tk.SPELL?(i=t??new tR(e.traitsString),r="spell"):e.type===tk.CANTRIP?(i=t??new tR(e.traitsString),r="cantrip"):(i=t??new tO(e.traitsString),r=e.imageName),i.set("NAME",e.name);let a=function(e,t){let i=new tU(e,t.description,`${t.imageName}.png`,t.unknownDescription);return i.traits=t.traits,i}(e,{description:e.description,unknownDescription:e.unknownDescription,imageName:r,traits:i});return a.isTrap()?a.interaction=new am(a):a.isMagic()?a.interaction=new ad(a):a.isConsumable()&&(a.interaction=new ap(a)),a}const tz={HEAD:{id:"HEAD",space:1,money:!1,spacesExpand:!1},BODY:{id:"BODY",space:1,money:!1,spacesExpand:!1},HANDS:{id:"HANDS",space:2,money:!1,spacesExpand:!1},FEET:{id:"FEET",space:2,money:!1,spacesExpand:!1},BACKPACK:{id:"BACKPACK",space:8,money:!1,spacesExpand:!0},WAGON:{id:"WAGON",space:8,money:!1,spacesExpand:!0},CANTRIPS:{id:"CANTRIPS",space:999,money:!1,spacesExpand:!0},SPELLS:{id:"SPELLS",space:9,money:!1,spacesExpand:!0},PREPARED_SPELLS:{id:"PREPARED SPELLS",space:9,money:!1,spacesExpand:!0},PURSE:{id:"PURSE",space:Number.MAX_SAFE_INTEGER,money:!0,spacesExpand:!1}},tk={ARMOUR:{storageSpace:1,storeType:{stash:tz.WAGON,equip:tz.BODY}},CANTRIP:{storageSpace:1,storeType:{stash:null,equip:tz.CANTRIPS}},COINS:{storageSpace:0,storeType:{stash:tz.PURSE}},CONSUMABLE:{storageSpace:1,storeType:{stash:tz.BACKPACK}},GENERIC:{storageSpace:1,storeType:{stash:tz.BACKPACK}},HEAD_GEAR:{storageSpace:1,storeType:{stash:tz.BACKPACK,equip:tz.HEAD}},KEY:{storageSpace:1,storeType:{stash:tz.BACKPACK}},SHIELD:{storageSpace:1,storeType:{stash:tz.BACKPACK,equip:tz.HANDS}},SPELL:{storageSpace:1,storeType:{stash:tz.SPELLS,equip:tz.PREPARED_SPELLS}},TRAP:{storageSpace:1,storeType:{stash:tz.BACKPACK}},TWO_HANDED_WEAPON:{storageSpace:2,storeType:{stash:tz.BACKPACK,equip:tz.HANDS}},WEAPON:{storageSpace:1,storeType:{stash:tz.BACKPACK,equip:tz.HANDS}}};class tB{#ek;#eB;#eG;#eU;#eH;constructor(e,t,i){this.#ek=e,this.#eG=0,this.#eB=new Map,this.#eU=t,this.#eH=i}get storeTypeId(){return this.#eH.id}get storeType(){return this.#eH}get freeSpace(){return this.#ek-this.#eG}get maxSpace(){return this.#ek}adjustCapacity(e){return this.#ek=Math.max(e,this.#eG),this.#ek}isEmpty(){return 0===this.#eG}getRequiredSpace(e){return this.#eU?1:e.storageSpace}has(e){return this.#eB.has(e)}add(e){let t=this.#ek-this.#eG,i=this.getRequiredSpace(e);return t>=i&&(this.#eB.set(e,e),this.#eG+=i,!0)}take(e){let t=this.#eB.get(e),i=this.getRequiredSpace(e);return t&&(this.#eG-=i,this.#eB.delete(t)),t}getFirst(){return this.isEmpty()?null:this.#eB.values().next().value}takeFirst(){if(this.isEmpty())return null;let e=this.#eB.values().next().value;return this.take(e)}values(){return this.#eB.values()}canAdd(e){let t=this.getRequiredSpace(e);return this.#ek-this.#eG>=t}}class tG{#eF;#e$;constructor(){this.#e$=!1}get storeType(){return tz.PURSE}get storeTypeId(){return tz.PURSE.id}isEmpty(){return!this.#eF||0===this.#eF.costInGp}has(e){return this.#eF.costInGp>0}add(e){let t=e.costDetails;if(!this.#eF)return this.#eF=e.clone(),!0;let i=this.#eF.costDetails;return this.#e$||(this.#eF=tG.createGoldCoinArtefact(i.valueGp),this.#e$=!0),this.#eF.costInGp=i.valueGp+t.valueGp,!0}take(e){let t=Math.min(this.#eF.costInGp,e.costInGp);return this.#eF.costInGp=this.#eF.costInGp-t,e.costInGp=t,e}canAdd(e){return!0}values(){return this.#eF&&0!==this.#eF.costInGp?[this.#eF.clone()].values():[].values()}static createGoldCoinArtefact(e){let t=t_(tM(`0,COMMON,COINS,gold_coins * VALUE:${e}GP`));return t.costInGp=e,t}}class tU{id;iconImageName;description;artefactType;traits;interaction;almanacEntry;unknown;constructor(e,t,i,r){this.id=e.id,this.description=t,this.iconImageName=i,this.artefactType=e.type,this.almanacEntry=e,this.unknownDescription=r,this.unknown=!!r}get costDetails(){return te(this.traits?.get("VALUE"))}get costInGp(){return te(this.traits?.get("VALUE")).valueGp}get sellBackPriceInGp(){return this.artefactType===tk.COINS?this.costInGp:Math.round(75*this.costInGp)/100}set costInGp(e){if(!this.traits)throw Error("Artefact has no traits so cannot set cost.");this.traits.set("VALUE",`${e.toFixed(2)} GP`)}get storageSpace(){return this.artefactType.storageSpace}get stashStoreType(){return this.artefactType.storeType.stash}get equipStoreType(){return this.artefactType.storeType.equip}get stashInWagon(){return this.stashStoreType===tz.WAGON}getDefaultStoreType(){return this.artefactType.storeType.stash??this.artefactType.storeType.equip}getStoreTypes(){let e=[];return this.artefactType.storeType.stash&&e.push(this.artefactType.storeType.stash),this.artefactType.storeType.equip&&e.push(this.artefactType.storeType.equip),e}clone(){let e=new tU(this.almanacEntry,this.description,this.iconImageName,this.unknownDescription);return e.traits=this.traits.clone(),e.value=this.value,e.unknown=this.unknown,e}isMagic(){return this.artefactType===tk.SPELL||this.artefactType===tk.CANTRIP}isTrap(){return this.artefactType===tk.TRAP}isUsable(){return!!this.interaction?.canReact()}isConsumable(){return this.artefactType===tk.CONSUMABLE}toJSON(){return{reviver:"Artefact",data:{almanacEntry:this.almanacEntry,traits:this.traits,unknown:this.unknown}}}static revive(e,t){let i=t(e.almanacEntry,e.traits);return i.unknown=e.unknown,i}}class tH{#eW;#eK;#eV;constructor(e,t){for(let t in this.#eW=new Map,this.#eK=e,tz){let e=tz[t];this.#eY(e)}this.#eV=t}get hasWagon(){return this.#eK}#eX(){this.#eV&&this.#eV()}#eY(e){if(e.money)return this.#eW.set(e,new tG(e.space,e.spacesExpand));let t=!0;this.#eK&&e===tz.BACKPACK?t=!1:this.#eK||e!==tz.WAGON||(t=!1),t&&this.#eW.set(e,new tB(e.space,e.spacesExpand,e))}getStore(e){return this.#eK&&e===tz.BACKPACK&&(e=tz.WAGON),this.#eW.get(e)}getStoreByTypeId(e){for(let t of this.#eW.values())if(t.storeTypeId===e)return t;return null}findSuitableStore(e){let t=e.stashStoreType,i=this.getStore(t);return(i||(t=e.equipStoreType,i=this.getStore(t)),i?.canAdd(e))?i:null}addArtefact(e){let t=this.getStore(e.getDefaultStoreType()),i=t?.add(e);return this.#eX(),i}getFirstStorageDetails(){for(let e of this.#eW.values()){let t=e.values(),i=t.next()?.value;if(i)return{store:e,artefact:i}}return null}hasArtefactWithSameId(e){let t="string"==typeof e?e:e.id;for(let e of this.getAllStorageDetails())if(e.artefact.id===t)return!0;return!1}hasArtefact(e){for(let t of this.getAllStorageDetails())if(t.artefact===e)return!0;return!1}getAllEquippedArtefacts(){let e=[];for(let t of[this.#eW.get(tz.HEAD),this.#eW.get(tz.BODY),this.#eW.get(tz.HANDS),this.#eW.get(tz.FEET),this.#eW.get(tz.CANTRIPS),this.#eW.get(tz.PREPARED_SPELLS)])for(let i of t.values())e.push(i);return e}getAllStorageDetails(){let e=[];return this.#eW.forEach(t=>{for(let i of t.values())e.push({store:t,artefact:i})}),e}getPurseValue(){let e=this.getStore(tz.PURSE).values(),t=e.next()?.value;return t?t.costInGp:0}addToPurse(e){let t=tG.createGoldCoinArtefact(e);this.#eW.get(tz.PURSE).add(t),this.#eX()}takeFromPurse(e){let t=tG.createGoldCoinArtefact(e),i=this.#eW.get(tz.PURSE).take(t);return this.#eX(),i.costInGp}getStoreContents(e){let t=this.getStore(e);return!t||t.isEmpty()?null:t.values()}discard(e){return!!this.discardStashed(e,!0)||this.discardEquipped(e)}discardEquipped(e,t){let i=this.getStore(e.equipStoreType);return i?i.take(e)?(this.#eX(),!0):(t||m.error("Artefact could not be found so not discarded."),!1):(t||m.error("Cannot discard artefact as there isn't an equip store."),!1)}discardStashed(e,t){let i=this.getStore(e.stashStoreType);return i?i.take(e)?(this.#eX(),!0):(t||m.error("Artefact could not be found so not discarded."),!1):(t||m.error("Cannot discard artefact as there isn't a stash store."),!1)}equip(e,t={}){let i=this.getStore(e.stashStoreType),r=this.getStore(e.equipStoreType);if(!i&&!t.direct)return m.error("Cannot equip artefact as there isn`t a stash store to take it from."),!1;if(!r)return m.error("Cannot equip artefact as there isn't an equip store."),!1;let a=e.storageSpace;if(a>r.maxSpace)return m.error("The equip store cannot hold this item."),!1;if(!i?.take(e)&&!t.direct)return m.error("Could not find artefact in the stash."),!1;for(;r.freeSpace<a;){let e=r.takeFirst();i?.add(e)}let n=r.add(e);return this.#eX(),n}stash(e,t={}){let i=this.getStore(e.stashStoreType),r=this.getStore(e.equipStoreType);if(!i)return m.debug("Cannot stash artefact as there isn`t a suitable stash store to put it in."),!1;if(!r&&!t.direct)return m.error("No suitable equip store found. If stashing a new artefact, the direct option should be set."),!1;if(e.storageSpace>i.freeSpace)return m.error("The stash store cannot hold this item."),!1;if(!r?.take(e)&&!t.direct)return m.error("The artefact hasn't been equipped so can't unequip it."),!1;let a=i.add(e);return this.#eX(),a}}function tF(e,t,i){return{centre:e[t]?.[i],tl:e[t-1]?.[i-1],above:e[t-1]?.[i],tr:e[t-1]?.[i+1],right:e[t]?.[i+1],br:e[t+1]?.[i+1],below:e[t+1]?.[i],bl:e[t+1]?.[i-1],left:e[t]?.[i-1]}}function t$(e){let t,i=e.length;for(;i>0;)t=Math.floor(Math.random()*i),i--,[e[i],e[t]]=[e[t],e[i]];return e}const tW={WALL:["#","*","|"],DOOR_IN:["-","~"],DOOR_OUT:["=",">"],GROUND:[".",":",",",";"],VOID:[" "]},tK={TOP_LEFT:"-TL",TOP_LEFT_INTERNAL:"-TLI",TOP:"-T",TOP_RIGHT:"-TR",TOP_RIGHT_INTERNAL:"-TRI",RIGHT:"-R",BOTTOM_RIGHT:"-BR",BOTTOM_RIGHT_INTERNAL:"-BRI",BOTTOM:"-B",BOTTOM_LEFT:"-BL",BOTTOM_LEFT_INTERNAL:"-BLI",LEFT:"-L",TOP_TEE:"-TTEE",RIGHT_TEE:"-RTEE",BOTTOM_TEE:"-BTEE",LEFT_TEE:"-LTEE",INTERNAL_CROSS:"-XI",INTERNAL_VERTICAL:"-VI",INTERNAL_HORIZONTAL:"-HI"},tV={BELOW_WALL:"-SBW",BELOW_END_WALL:"-SBE"};class tY{matrix;entryPointByDoor;exitPointByDoor;constructor(){this.entryPointByDoor=new C(0,0),this.exitPointByDoor=new C(0,0)}static generateTileMapPlan(e,t){let i=new tY,r=i.convertToMatrix(e);return r=i.clarifyMatrix(r),i.createPlan(r,t),i}convertToMatrix(e){let t=[],i=0;return e.forEach(e=>{i=Math.max(i,e.length)}),e.forEach(e=>{e.length<i&&(e+=" ".repeat(i-length)),t.push(e.split(""))}),t}clarifyMatrix(e){let t=[];return e.forEach((i,r)=>{let a=[];t.push(a),i.forEach((t,i)=>{var n,s,o,l;let h;let c=tF(e,r,i);(n=t,tW.VOID.includes(n))?t=" ":tj(t)?(s=t,tZ(c.above)&&(tZ(c.tl)?s+=tV.BELOW_WALL:s+=tV.BELOW_END_WALL),o=t=s,tX(c.left)||tX(c.above)||tX(c.right)||tX(c.below))?this.entryPointByDoor=new C(i,r):(tq(c.right)||tq(c.below)||tq(c.left)||tq(c.above))&&(this.exitPointByDoor=new C(i,r)):tZ(t)&&(h=l=t,tZ(c.above)&&tZ(c.right)&&tZ(c.below)&&tZ(c.left)?h+=tK.INTERNAL_CROSS:tj(c.left)&&tj(c.right)?h+=tK.INTERNAL_VERTICAL:tj(c.above)&&tj(c.below)?h+=tK.INTERNAL_HORIZONTAL:tZ(c.left)&&tZ(c.right)&&tZ(c.below)?h+=tK.TOP_TEE:tZ(c.above)&&tZ(c.below)&&tZ(c.left)?h+=tK.RIGHT_TEE:tZ(c.left)&&tZ(c.right)&&tZ(c.above)?h+=tK.BOTTOM_TEE:tZ(c.above)&&tZ(c.below)&&tZ(c.right)?h+=tK.LEFT_TEE:tZ(c.right)&&tZ(c.below)?h+=tj(c.br)?tK.TOP_LEFT:tK.TOP_LEFT_INTERNAL:tZ(c.left)&&tZ(c.below)?h+=tj(c.bl)?tK.TOP_RIGHT:tK.TOP_RIGHT_INTERNAL:tZ(c.left)&&tZ(c.above)?h+=tj(c.tl)?tK.BOTTOM_RIGHT:tK.BOTTOM_RIGHT_INTERNAL:tZ(c.right)&&tZ(c.above)?h+=tj(c.tr)?tK.BOTTOM_LEFT:tK.BOTTOM_LEFT_INTERNAL:tZ(c.above)&&tZ(c.below)?h+=tj(c.right)?tK.LEFT:tK.RIGHT:tZ(c.right)&&tZ(c.left)&&(h+=tj(c.below)?tK.TOP:tK.BOTTOM),t=tZ(c.above)?h+tV.BELOW_WALL:h),a.push(t)})}),t}createPlan(e,t){let i=[];e.forEach(e=>{let r=[];i.push(r),e.forEach(e=>{r.push(function e(t,i){if(" "===t)return null;let r=t.match(/(.)(-[^-]*)?(-[^-]*)?/),a=i.get(t);if(!a&&r[2]&&r[3]&&(a=i.get(`${r[1]}${r[2]}`)),!a&&r[2]&&(a=i.get(r[1])),!a){let a=function(e){for(let t in tW)if(tW[t].includes(e))return tW[t][0];return null}(r[1]);if(a&&a!==r[1]){var n,s;let t;return e((n=r[2],s=r[3],t=a,n&&(t+=n),s&&(t+=s),t),i)}m.error(`Failed to find symbol for ${t}`)}return a}(e,t))})}),this.matrix=i}}function tX(e){return tW.DOOR_IN.includes(e)}function tq(e){return tW.DOOR_OUT.includes(e)}function tj(e){return tW.GROUND.includes(e)}function tZ(e){var t;return tW.WALL.includes(e)||tX(t=e)||tq(t)}class tJ{#eq;#ej;#eZ;#eJ;setOnClick(e){this.#eq=e}setOnContextClick(e){this.#ej=e}setOnPointerDown(e){this.#eZ=e}setOnPointerUp(e){this.#eJ=e}actionClick(e){this.#eq?.(this,e)}actionContextClick(e){this.#ej?.(this,e)}actionPointerDown(e){this.#eZ?.(this,e)}actionPointerUp(e){this.#eJ?.(this,e)}}class tQ{#eQ;#e4;constructor(e){this.#e4=e,this.#eQ=new Map}setRouteToCoords(e,t,i){this.#eQ.set(this.coordsToKey(t,i),e)}getRouteToCoords(e,t){return this.#eQ.get(this.coordsToKey(e,t))}hasRouteToCoords(e,t){return this.#eQ.has(this.coordsToKey(e,t))}coordsToKey(e,t){return`${e}|${t}`}keyToGridPoint(e){let t=e.split("|");return new C(parseInt(t[0]),parseInt(t[1]))}forEach(e){this.#eQ.forEach((t,i,r)=>e(t,i,r))}containsGridPoint(e){return this.#eQ.has(this.coordsToKey(e.x,e.y))}getWaypointsAsGridPoints(e){let t=this.getRouteToCoords(e.x,e.y);return t&&t.length>1?t.slice(1):null}getWaypointsAsWorldPoints(e){let t=this.getWaypointsAsGridPoints(e);return t?t.map(e=>this.#e4.gridPointToWorldPoint(e)):t}}class t4{actor;#eQ;#e4;#e0;constructor(e,t){this.#e4=e,this.actor=t}getDumbRouteNextTo(e,t,i){let r=this.#e1(e,t);if(r.coincident(e))return[];this.#e4.canGridPointBeOccupiedByActor(r,this.actor)||(r=this.#e8(r,t));let a=[],n=Math.sign(r.x-e.x),s=Math.sign(r.y-e.y),o=C.copy(e),l=.5>Math.random(),h=0;for(;i>0;){let t=C.copy(o),c=!1;if(l&&0!==n&&o.x!=r.x?(t.x+=n,c=!0):l||0===s||o.y==r.y||(t.y+=s,c=!0),c=c&&this.#e4.canGridPointBeOccupiedByActor(t,this.actor))h=0,o=t,i--;else{if(++h>=2)break;o.coincident(e)||a.push(this.#e4.gridPointToWorldPoint(o)),e=o,l=!l}}return o.coincident(e)||a.push(this.#e4.gridPointToWorldPoint(o)),a}getAllRoutesFrom(e,t){return this.#eQ=new tQ(this.#e4),this.#e0=e,this.#e3(e.x,e.y,t,null),this.#eQ}#e3(e,t,i,r){if(r){if(e===this.#e0.x&&t===this.#e0.y||!this.#e2(e,t))return;let a=this.#eQ.getRouteToCoords(e,t);if(a&&!(r.length<a.length-1))return;r.push(new C(e,t)),this.#e5(e,t)&&this.#eQ.setRouteToCoords(r,e,t),i--}else r=[new C(e,t)];i>0&&(this.#e3(e,t-1,i,[...r]),this.#e3(e+1,t,i,[...r]),this.#e3(e,t+1,i,[...r]),this.#e3(e-1,t,i,[...r]))}#e2(e,t){return this.#e4.isGridPointPassableByActor(new C(e,t),this.actor)}#e5(e,t){return this.#e4.canGridPointBeOccupiedByActor(new C(e,t),this.actor)}#e1(e,t){let i=t.x-e.x,r=t.y-e.y,a=t.x,n=t.y;return Math.abs(i)>Math.abs(r)?a-=Math.sign(i):n-=Math.sign(r),new C(a,n)}#e8(e,t){return e.x===t.x&&e.y<t.y?new C(e.x+1,e.y+1):e.x>t.x&&e.y===t.y?new C(e.x-1,e.y+1):e.x===t.x&&e.y>t.y?new C(e.x-1,e.y-1):e.x<t.x&&e.y===t.y?new C(e.x+1,e.y-1):e}}class t0{#e6;#e9;#e4;#e7;#te;#tt;#ti;constructor(e,t){this.#e4=e,this.#e6=t}findReachedTiles(){return this.#e9=this.#e4.worldPointToGrid(this.#e6.position),this.#tt=this.#e4.getMapGridPointRect(),this.#te&&this.#te.coincident(this.#e9)&&this.#tt&&this.#tt.equals(this.#ti)||(this.#e7=new Map,this.#e7.set(this.#e9.toString(),this.#e9),this.#tr().forEach(e=>{this.#ta(e)}),this.#te=this.#e9,this.#ti=this.#tt),this.#e7}isGridPointInRays(e){return!!this.#e7&&this.#e7.has(e.toString())}#tr(){let e=[];for(let t=this.#tt.x;t<=this.#tt.x+this.#tt.width;t++)e.push(new C(t,this.#tt.y)),e.push(new C(t,this.#tt.y+this.#tt.height));for(let t=this.#tt.y+1;t<=this.#tt.y+this.#tt.height-1;t++)e.push(new C(this.#tt.x,t)),e.push(new C(this.#tt.x+this.#tt.width,t));return e}#ta(e){let t,i,r;let a=function(e){let t=Math.abs(e);return t<=E.DEG_22_5?y.E:t<=E.DEG_67_5?Math.sign(e)>0?y.NE:y.SE:t<=E.DEG_112_5?Math.sign(e)>0?y.N:y.S:t<=E.DEG_157_7?Math.sign(e)>0?y.NW:y.SW:y.W}(this.#e9.getScreenAngleTo(e));Math.abs(e.x-this.#e9.x)>=Math.abs(e.y-this.#e9.y)?(t=Math.sign(e.x-this.#e9.x),i=(r=Math.abs(e.x-this.#e9.x))<1?0:(e.y-this.#e9.y)/r):(i=Math.sign(e.y-this.#e9.y),t=(r=Math.abs(e.y-this.#e9.y))<1?0:(e.x-this.#e9.x)/r);let n=this.#e9.x,s=this.#e9.y,o=!0;for(;r>=0;){let e=new C(Math.round(n),Math.round(s));if(o||this.#e4.isSeeThrough(e,this.#e6))this.#tn(e,a);else break;o=!1,n+=t,s+=i,r--}}#tn(e,t){switch(this.#e7.set(e.toString(),e),t){case y.N:this.#ts(new C(e.x-1,e.y-1)),this.#ts(new C(e.x,e.y-1)),this.#ts(new C(e.x+1,e.y-1));break;case y.NE:this.#ts(new C(e.x,e.y-1)),this.#ts(new C(e.x+1,e.y-1)),this.#ts(new C(e.x+1,e.y));break;case y.E:this.#ts(new C(e.x+1,e.y-1)),this.#ts(new C(e.x+1,e.y)),this.#ts(new C(e.x+1,e.y+1));break;case y.SE:this.#ts(new C(e.x+1,e.y)),this.#ts(new C(e.x+1,e.y+1)),this.#ts(new C(e.x,e.y+1));break;case y.S:this.#ts(new C(e.x-1,e.y+1)),this.#ts(new C(e.x,e.y+1)),this.#ts(new C(e.x+1,e.y+1));break;case y.SW:this.#ts(new C(e.x-1,e.y)),this.#ts(new C(e.x-1,e.y+1)),this.#ts(new C(e.x,e.y+1));break;case y.W:this.#ts(new C(e.x-1,e.y-1)),this.#ts(new C(e.x-1,e.y)),this.#ts(new C(e.x-1,e.y+1));break;case y.NW:this.#ts(new C(e.x-1,e.y)),this.#ts(new C(e.x-1,e.y-1)),this.#ts(new C(e.x,e.y-1))}}#ts(e){this.#e4.isSeeThrough(e)||this.#e7.set(e.toString(),e)}}const t1={DOOR_HIGHLIGHT_FILL:"rgba(0, 255, 0, 0.2)",HP_GAUGE:"rgba(204, 51, 0, 0.4)",HP_TRANSIENT_TEXT_HERO:"white",HP_TRANSIENT_TEXT_ENEMY:"black",INTERACT_HIGHLIGHT_FILL:void 0,INTERACT_HIGHLIGHT_STROKE:"red",MOVE_HIGHLIGHT_FILL:void 0,MOVE_HIGHLIGHT_STROKE:"white"},t8={MOVEMENT_TILE:0,INTERACT_TILE:1,OCCUPIED_TILE:2,MOVE_OR_INTERACT_TILE:4},t3={OBSTACLE:-1,GROUND:0,ENTRANCE:1,EXIT:2};class t2 extends tJ{sprite;obstacle;#to;#tl;#th;#tc;constructor(e,t){super(),this.sprite=e,this.#to=new Map,this.obstacle=t.obstacle,this.#tl=t.gridPoint,this.#th=t.worldPoint,this.#tc=t.role}get role(){return this.#tc}get gridPoint(){return this.#tl}get worldPoint(){return this.#th}addOccupant(e){this.#to.set(e,e)}deleteOccupant(e){this.#to.delete(e)}getOccupants(){return this.#to}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionClick(this.sprite.position)}isOccupied(){return this.#to.size>0}isPassableByActor(e){if(this.#tc===t3.ENTRANCE||this.#tc===t3.EXIT||this.obstacle)return!1;for(let t of this.#to.values())if(t!==e&&!t.isPassableByActor(e))return!1;return!0}canBeOccupiedByActor(e){if((this.#tc===t3.ENTRANCE||this.#tc===t3.EXIT)&&!e.isHero()||this.obstacle)return!1;for(let t of this.#to.values())if(t!==e&&!t.canShareLocationWithActor(e))return!1;return!0}isSeeThrough(e){return!this.obstacle&&this.#tc!==t3.ENTRANCE&&this.#tc!==t3.EXIT}}class t5{#tu;#td;#tp;#tf;#tm;#I;#O;#tg;#tS;#tw;#tE;#tT;#ty;#tA;#tx;#tI;#tO;#tR;#tC;#tN;#tP;constructor(e,t,i,r){this.#tP=r;let a=t.matrix;if(this.#tx=t.entryPointByDoor,this.#tI=t.exitPointByDoor,this.#tu=e,this.#tw=new eC({renderer:new ex(e,{width:i,height:i,fillStyle:t1.MOVE_HIGHLIGHT_FILL,strokeStyle:t1.MOVE_HIGHLIGHT_STROKE})}),this.#tE=new eC({renderer:new ex(e,{width:i,height:i,fillStyle:t1.DOOR_HIGHLIGHT_FILL,strokeStyle:"green"})}),this.#tN=new eC({renderer:new ex(e,{width:i,height:i,fillStyle:t1.INTERACT_HIGHLIGHT_FILL,strokeStyle:t1.INTERACT_HIGHLIGHT_STROKE})}),this.#tm=i,this.#td=[],this.#tf=a.length,this.#tp=a[0].length,this.#I=i*this.tilesX,this.#O=i*this.tilesY,this.#tO=[],a.forEach((t,i)=>{let r=[];this.#td.push(r),t.forEach((t,a)=>{if(t){let n=new eC({renderer:new eR(e,ep.getSpriteBitmap(t.image))}),s=new C(a,i),o=this.gridPointToWorldPoint(s),l=new t2(n,{obstacle:t.role===t3.OBSTACLE,gridPoint:s,worldPoint:o,role:t.role});t.onClick&&l.setOnClick((e,i)=>this.#tv(e,i,t.onClick)),this.processTileRole(l),r.push(l),n.position.x=a*this.#tm+this.#tm/2,n.position.y=i*this.#tm+this.#tm/2}else r.push(null)})}),this.#ty||(m.error("No entrance has been set. Setting to the first ground tile"),this.#ty=this.#tO[0]),!this.#tA)throw Error("No exit tile.")}getDimsInTiles(){return{width:this.#tp,height:this.#tf}}processTileRole(e){switch(e.role){case t3.ENTRANCE:if(this.#ty){let t=e.gridPoint;m.error(`Duplicate entrance found at (${t.x}, ${t.y}). Ignored.`)}else this.#ty=e;break;case t3.EXIT:if(this.#tA){let t=e.gridPoint;m.error(`Duplicate exit found at (${t.x}, ${t.y}). Ignored.`)}else this.#tA=e;break;case t3.GROUND:e.gridPoint.coincident(this.#tx)||this.#tO.push(e)}}update(e){this.#tL();let t=this.getVisibleGridPointRect();for(let i=t.y;i<=t.y+t.height;i++)for(let r=t.x;r<=t.x+t.width;r++)if(this.#tR?.isGridPointInRays(new C(r,i))){let t=this.#td[i][r];t?.sprite.update(e)}}updateHighlights(e){this.#tD(e)}#tL(){if(this.#tP){this.#tR||(this.#tR=new t0(this,this.#tP));let e=this.getTileAtWorldPoint(this.#tP.position);if(e){let t=e.role;t!=t3.ENTRANCE&&t!=t3.EXIT&&this.#tR.findReachedTiles()}}}getMapGridPointRect(){return new L(0,0,this.#tp,this.#tf)}getVisibleGridPointRect(){let e=Q.getWorldInCanvasBounds(),t=this.worldPointToGrid(new C(e.x,e.y)),i=this.worldPointToGrid(new C(e.x+e.width,e.y+e.height)),r=Math.max(0,t.x),a=Math.min(this.#tp-1,i.x),n=Math.max(0,t.y);return new L(r,n,a-r,Math.min(this.#tf-1,i.y)-n)}getGridSize(){return this.#tm}getDimensions(){return{width:this.#I,height:this.#O}}getTileAtWorldPoint(e){let t=this.worldPointToGrid(e);return this.getTileAtGridPoint(t)}getTileAtGridPoint(e){if(!e)return null;let t=e.y,i=e.x;return i>=0&&t>=0&&i<this.#tp&&t<this.#tf?this.#td[t][i]:null}worldPointToGrid(e){return new C(Math.floor(e.x/this.#tm),Math.floor(e.y/this.#tm))}gridAlignedWorldPoint(e){let t=this.worldPointToGrid(e);return this.gridPointToWorldPoint(t)}gridPointToWorldPoint(e){let t=.5*this.#tm;return new C(e.x*this.#tm+t,e.y*this.#tm+t)}getWorldPositionOfTileByEntry(){return this.gridPointToWorldPoint(this.#tx)}getGridPositionOfEntrance(){return this.#ty.gridPoint}setMovementRoutes(e){this.#tg=e,e?(this.#tS=new Map,this.#tg.forEach(e=>e.forEach(e=>{this.#tS.set(e,e)}))):this.#tS=null}setInteractActors(e){this.#tC=[],e?.forEach(e=>{e.interaction.canReact()&&this.#tC.push(this.worldPointToGrid(e.position))})}calcReachableDoors(e){this.#tT=[];let t=this.getSurroundingTiles(this.worldPointToGrid(e));[t.above,t.right,t.below,t.left].forEach(e=>{e.gridPoint.coincident(this.#tA.gridPoint)?this.#tT.push(e.gridPoint):e.gridPoint.coincident(this.#ty.gridPoint)&&this.#tT.push(e.gridPoint)})}#tD(e){this.#tM(e),this.#tb(e),this.#t_(e)}#tM(e){this.#tS?.forEach(t=>{this.#tw.position=this.gridPointToWorldPoint(t),this.#tw.update(e)})}#tb(e){this.#tC?.forEach(t=>{this.#tN.position=this.gridPointToWorldPoint(t),this.#tN.update(e)})}#t_(e){this.#tT?.forEach(t=>{this.#tE.position=this.gridPointToWorldPoint(t),this.#tE.update(e)})}#tv(e,t,i){let r;let a=this.worldPointToGrid(t),n=e.getOccupants();n.size>0&&(r=n.values().next().value);let s=this.#tg?.containsGridPoint(a),o=!1;if(this.#tC){for(let e of this.#tC)if(e.isCoincident(a)){o=!0;break}}let l=!r?.alive&&r?.isProp();if(s&&o||o&&l){i(e,t,{filter:t8.MOVE_OR_INTERACT_TILE,occupant:r});return}if(s){i(e,t,{filter:t8.MOVEMENT_TILE,occupant:r});return}if(o){i(e,t,{filter:t8.INTERACT_TILE,occupant:r});return}if(this.#tT){for(let r of this.#tT)if(r.isCoincident(a)){i(e,t,{filter:t8.INTERACT_TILE});return}}let h=this.worldPointToGrid(this.#tP.position);if(a.coincident(h)){i(e,t,{occupant:this.#tP,filter:t8.OCCUPIED_TILE});return}r&&i(e,t,{occupant:r,filter:t8.OCCUPIED_TILE}),m.debug("Ignore click outside of highlighted area")}getWaypointsToWorldPoint(e){let t=this.worldPointToGrid(e);return this.#tg?.getWaypointsAsWorldPoints(t)}getRandomFreeGroundTile(){for(let e of(t$(this.#tO),this.#tO))if(!e.isOccupied())return e;return null}isGridPointPassableByActor(e,t){let i=this.getTileAtGridPoint(e);return!!i&&i.isPassableByActor(t)}canGridPointBeOccupiedByActor(e,t){let i=this.getTileAtGridPoint(e);return!!i&&i.canBeOccupiedByActor(t)}canHeroSeeGridPoint(e){return this.#tR?.isGridPointInRays(e)??!0}isSeeThrough(e,t){let i=this.getTileAtGridPoint(e);return!i||i.isSeeThrough(t)}getSurroundingTiles(e){return tF(this.#td,e.y,e.x)}getRadiatingUpAndDown(e,t=1){return function(e,t){let i;let r=t.columnIndex,a=t.rowIndex,n=[],s=!0,o=!0,l=!0,h=!0,c=1,u=t.distance??1;for(;u-- >0;)h&&(i=e[a][r-c],t.filter&&!t.filter(i)?h=!1:n.push(i)),o&&(i=e[a][r+c],t.filter&&!t.filter(i)?o=!1:n.push(i)),s&&(i=e[a-c][r],t.filter&&!t.filter(i)?s=!1:n.push(i)),l&&(i=e[a+c][r],t.filter&&!t.filter(i)?l=!1:n.push(i)),c++;return n}(this.#td,{rowIndex:e.y,columnIndex:e.x,distance:t,filter:e=>e.role===t3.GROUND})}deleteOccupancyOfGridPoint(e,t){this.getTileAtGridPoint(t)?.deleteOccupant(e)}moveTileOccupancyGridPoint(e,t,i){i!==t&&(this.getTileAtGridPoint(t)?.deleteOccupant(e),this.getTileAtGridPoint(i)?.addOccupant(e))}getCoincidentActors(e){return this.getTileAtWorldPoint(e.position).getOccupants()}getParticipants(e){let t=[],i=this.getSurroundingTiles(this.worldPointToGrid(e.position));return[i.above,i.right,i.below,i.left].forEach(e=>{let i=e?.getOccupants();i?.forEach(e=>{t.push(e)})}),t}}const t6=[{id:"MUSIC_VOLUME",labelKey:"CONTROL MUSIC VOLUME",defValue:50,controlType:eq.RANGE,persistent:!0,action:null,onChange:e=>e6.setMusicVolumePercent(e)},{id:"EFFECTS_VOLUME",labelKey:"CONTROL EFFECTS VOLUME",defValue:50,controlType:eq.RANGE,persistent:!0,action:null,onChange:e=>{e6.setEffectsVolumePercent(e),e6.playEffect("PUNCH")}},{id:"SHOW_QUICK_TIPS_AT_START",labelKey:"CONTROL SHOW QUICK TIPS",defValue:!0,controlType:eq.CHECKBOX,persistent:!0,action:null,onChange:null},{id:"START_IN_FULLSCREEN",labelKey:"CONTROL START IN FULLSCREEN",defValue:!1,controlType:eq.CHECKBOX,persistent:!0,action:null,onChange:null},{id:"SHOW_DEBUG_LOG",labelKey:"BUTTON SHOW DEBUG LOG",defValue:!0,controlType:eq.TEXT_BUTTON,persistent:!1,action:()=>(function(){m.getMessages();let e="";for(let t of m.getMessages())e+=t+"\n";return e5.showOkDialog(e,{title:eJ`DIALOG TITLE DEBUG LOG`,className:"wall"})})(),onChange:null}];function t9(){let e=[];return t6.forEach(t=>{e.push(function(e){let t;switch(e.controlType){case eq.CHECKBOX:t=new eY(e);break;case eq.RANGE:t=new eX(e);break;case eq.TEXT_BUTTON:t=new eW(e);break;default:throw Error(`Attempt to create unrecognised control type ${e.controlType}`)}return t}(t))}),e5.showControlsDialog(eJ`DIALOG TITLE SETTINGS`,{actionButtons:e,className:"door"})}const t7={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:eg.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:eg.REVERSE}},WALK_NORTH:{keyName:"WALK_N",suffix:"walk-n",options:{framePeriodMs:100,loopMethod:eg.REVERSE}},WALK_EAST:{keyName:"WALK_E",suffix:"walk-e",options:{framePeriodMs:100,loopMethod:eg.REVERSE}},WALK_SOUTH:{keyName:"WALK_S",suffix:"walk-s",options:{framePeriodMs:100,loopMethod:eg.REVERSE}},WALK_WEST:{keyName:"WALK_W",suffix:"walk-w",options:{framePeriodMs:100,loopMethod:eg.REVERSE}}},ie={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:eg.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:eg.REVERSE}}};class it{#tz;constructor(e){this.#tz=e}#tk(e,t){let i=this.#tz[e]?.suffix;if(!i)throw Error(`Attempt made to use invalid standard animation key of '${e}'`);return`${t}-${i}`}getKeyName(e){return this.#tz[e].keyName}getDefaultImageName(e){return`${this.#tk("IDLE",e)}00.png`}getFallbackKey(){return this.getKeyName("IDLE")}addAllToKeyedAnimation(e,t){for(let i in this.#tz){let r=this.#tz[i];e.addAnimatedImage(this.#tz[i].keyName,new eE({prefix:this.#tk(i,t),suffix:".png",startIndex:0,padding:2},r.options))}e.setCurrentKey(this.#tz.IDLE.keyName)}}const ii={peripatetic:new it(t7),artefact:new it(ie)},ir=["a","e","i","o","u","ee","oo"],ia=["b","br","ch","chr","cl","cr","d","dr","fl","fr","g","gl","gr","h","j","k","kr","kl","l","m","n","p","pl","pr","qu","r","s","sch","sh","st","t","th","tr","v","w","y","z"],is=["b","bbey","bble","bboy","bby","c","ch","ck","cky","ct","d","f","ff","ffle","ffy","ffey","g","ge","gey","gle","k","l","ll","lly","lley","m","n","ngle","nny","p","r","s","sk","ss","ssy","st","sty","t","th","thy","v","w","y","z","zzle","zzy"];function io(){let e;return(e=.5>Math.random()?x(ia)+x(ir)+x(is):x(ia)+x(ir)+x(ia)+x(ir)+x(is)).charAt(0).toUpperCase()+e.substring(1)}class il extends eO{actor;constructor(e,t){super(e,t)}render(e){if(this.actor&&this.actor.traits){let e=this.actor.traits.getInt("HP",0),t=this.actor.traits.getInt("HP_MAX",1);this.setLevel(0,e/t)}super.render(e)}}class ih extends eT{#e6;#tB;#tG;#tU;#tH;constructor(e,t){super(e,t),this.#tB=y.NONE,this.#tU=t,this.#tH=0}setActor(e){this.#e6=e,this.#tG=this.#e6.alive}setFallbackKey(e){this.#tU=this.getAnimatedImage(e),this.#tU?.getCurrentFrame()||m.error(`Fallback key ${e} has no image.`)}getCurrentFrame(){let e=this.#tF();(e!==this.#tB||this.#tG!=this.#e6?.alive)&&(this.#tB=e,this.#tG=this.#e6?.alive,this.#t$());let t=super.getCurrentFrame()??this.#tU?.getCurrentFrame()??{bitmap:ep.getUndefinedBitmap(),rotation:0,flip:ew.NONE};return t.rotation=this.#tH,t}#tF(){return!this.#e6||this.#e6.velocity.isZero(.1)?y.NONE:function(e){let t=Math.abs(e);return t<=E.DEG_45?y.E:t<=E.DEG_135?Math.sign(e)>0?y.N:y.S:y.W}(this.#e6.velocity.getScreenDirection())}#t$(){return this.#e6.alive?this.#tB===y.NONE?this.setCurrentKey(ii.peripatetic.getKeyName("IDLE")):this.#tW():this.setCurrentKey(ii.peripatetic.getKeyName("DEAD"))}#tW(){let e=this.#e6.disengaging;switch(this.#tB){case y.NONE:this.setCurrentKey(ii.peripatetic.getKeyName("IDLE"));break;case y.E:this.setCurrentKey(ii.peripatetic.getKeyName(e?"WALK_WEST":"WALK_EAST"));break;case y.N:case y.NW:case y.NE:this.setCurrentKey(ii.peripatetic.getKeyName(e?"WALK_SOUTH":"WALK_NORTH"));break;case y.W:this.setCurrentKey(ii.peripatetic.getKeyName(e?"WALK_EAST":"WALK_WEST"));break;default:this.setCurrentKey(ii.peripatetic.getKeyName(e?"WALK_NORTH":"WALK_SOUTH"))}}}function ic(e,t,i,r){let a;let n=function(e){let t=new ih;return ii.peripatetic.addAllToKeyedAnimation(t,e),t.setFallbackKey(ii.peripatetic.getFallbackKey()),t}(e),s=new eR(Q.getContext2D(),n),o=new aT(new eC({renderer:i.get("MOVE")!==aE.ORGANIC?[a=new il(Q.getContext2D(),{tileSize:eU.TILE_SIZE-2,fillStyles:[t1.HP_GAUGE],strokeStyles:[]}),s]:[s]}),r.type);return n.setActor(o),a&&(a.actor=o),o.position=new v(eU.TILE_SIZE,eU.TILE_SIZE,0),o.almanacEntry=r,o.traits=i,o.velocity={x:0,y:0,rotation:0},o.iconImageName=t?`${t}.png`:ii.peripatetic.getDefaultImageName(e),/\w+_pv/.test(e)&&o.sprite.replaceBaseModifier(eD.createUprightAligner()),o}function iu(e,t){let i;let r=t??new tC(e.traitsString);switch(r.get("NAME")||r.set("NAME",e.name),e.type){case aS.HERO:(i=ic(e.imageName,null,r,e)).type=aS.HERO,t||(r.set("NAME",`${io()} ${io()}`),tm(r)),i.toxify=new au;break;case aS.OBJECTIVE:i=function(e,t,i,r){let a=ic(e,null,i,r);return a.interaction=new ag(a),a}(e.imageName,0,r,e);break;case aS.TRADER:i=function(e,t,i,r){let a=ic(e,null,i,r);return a.interaction=new al(a),a}(e.imageName,0,r,e);break;case aS.HIDDEN_ARTEFACT:i=function(e,t,i){let r=function(e){let t=new ih;return ii.artefact.addAllToKeyedAnimation(t,e),t.setFallbackKey(ii.artefact.getFallbackKey()),t}(e),a=new aT(new eC({renderer:[new eR(Q.getContext2D(),r)]}),"SPELL"===i.type?aS.PROP:aS.HIDDEN_ARTEFACT);return r.setActor(a),a.position=new v(eU.TILE_SIZE,eU.TILE_SIZE,0),a.velocity={x:0,y:0,rotation:0},a.interaction=new ah(a),a.iconImageName=`${e}.png`,a.traits=new tC,a}(e.imageName,0,r,e);break;case aS.PROP:i=function(e,t,i,r){let a=ic(e,null,i,r);return a.interaction=new ah(a),a}(e.imageName,0,r,e);break;default:i=function(e,t,i,r){let a=ic(e,null,i,r);return a.isOrganic()?(a.interaction=new ac(a),a.obstacle=!1):a.interaction=new as(a),a}(e.imageName,0,r,e)}return i.description=e.description,!t&&e.equipmentIds&&function(e,t){if(t&&0!==t.length)for(let i of t){let t=tb.findById(i,["MONEY","WEAPONS","ARMOUR","MAGIC","ARTEFACTS"]);if(t){let i=t_(t);i.equipStoreType?e.storeManager.equip(i,{direct:!0}):e.storeManager.stash(i,{direct:!0})}else m.error(`Cannot find ${i} artefact in almanac to equip actor.`)}}(i,e.equipmentIds),i}class id{#tK;#tV;constructor(e=0,t=0){this.#tV=e,this.#tK=t}getChangeInHpThisTurn(){let e=this.#tV+this.#tK,t=Math.floor(e);return this.#tK=e-t,t}addToxicEffect(e){this.#tV+=e}cure(){this.#tV=0,this.#tK=0}get isActive(){return 0!==this.#tV||0!==this.#tK}toJSON(){return{reviver:"Toxin",data:{pendingHpChange:this.#tK,hpPerTurn:this.#tV}}}static revive(e){return new id(e.hpPerTurn,e.pendingHpChange)}}function ip(e){return 0===e?"1":`B${e}`}class im{#tY;#tX;#tq;#tj;constructor(e,t={}){this.#tX=e??[],this.#tY=t?.maxLength??10,this.#tq=t.sortFn,this.#tj=t.equalFn??((e,t)=>e==t)}add(e){let t=this.indexOfEqual(e);if(t>=0){let i=this.#tX[t];if(!(0>this.#tq(e,i)))return -1;this.#tX[t]=e}else this.#tX.push(e);return this.#tX.sort(this.#tq),this.#tX.length>this.#tY&&this.#tX.pop(),this.#tX.indexOf(e)}indexOfEqual(e){for(let t=0;t<this.#tX.length;t++)if(this.#tj(e,this.#tX[t]))return t;return -1}getCurrentData(){return[...this.#tX]}getMaxLength(){return this.#tY}}const ig="LEADERBOARD_DATA";function iS(){return new im(eF.get(ig),{maxLength:10,sortFn:(e,t)=>e.score>t.score?-1:1,equalFn:(e,t)=>e.adventureStartTime===t.adventureStartTime&&e.name===t.name})}function iw(e,t=!1){let i=function(e){let t=iS(),i=t.add(e);return i>=0&&eF.set(ig,t.getCurrentData()),i}(function(e,t){let i={adventureStartTime:0,name:"unknown",class:"unknown",gold:0,exp:0,characterLevel:0,dungeonFloor:0,score:0,completed:!1};return e&&(i.adventureStartTime=e.adventureStartTime,i.name=e.traits.get("NAME"),i.class=e.traits.get("CLASS"),i.gold=e.storeManager.getPurseValue(),i.exp=e.traits.getInt("EXP",0),i.characterLevel=e.traits.getCharacterLevel(),i.dungeonFloor=ip(rX.getCurrentSceneLevel()),i.score=Math.floor(100*i.gold*i.characterLevel),i.completed=t),i}(e,t)),r={sceneLevel:rX.getCurrentSceneLevel(),hero:e,completed:t};return eF.set("GAME_STATE",r),i}function iE(e,t){switch(t?.reviver){case"Actor":return aT.revive(t.data,iu);case"Toxin":return id.revive(t.data);case"Artefact":return tU.revive(t.data,t_);case"Traits":return tO.revive(t.data);case"CharacterTraits":return tC.revive(t.data);case"MagicTraits":return tR.revive(t.data);default:return t}}class iT{#tZ=new Map;constructor(){}clear(){this.#tZ.clear()}#tJ(e){return window.btoa(function(e){try{return encodeURIComponent(e)}catch(t){return console.error(t),encodeURIComponent(e.toWellFormed())}}(e)).replace(/=/g,":")}protect(e){if(!e)return e;let t=`???${this.#tZ.size}${this.#tJ(e)}???`;return this.#tZ.set(t,e),t}retrieve(e){let t=this.#tZ.get(e);return(this.#tZ.delete(e),t)?t:(console.error(`Could not find ${e} in protected data.`),e)}reinstate(e){return e.replace(/[?]{3}\d+[a-zA-Z0-9+/]+:{0,2}[?]{3}/g,e=>this.retrieve(e))}}const iy=new iT;function iA(e,t){return`<span class="printable-link for-print-only">${t?"(":""}${e}${t?")":""}</span>`}const ix=[{re:/(?:(.+)\n=+\n)/g,rep:"\n\n<h1>$1</h1>\n\n"},{re:/(?:(.+)\n-+\n)/g,rep:"\n\n<h2>$1</h2>\n\n"},{re:/^(#+)(?: *)(.+?)(?:#*)[ \t]*$/gm,rep:(e,t,i)=>{let r=Math.min(t.length,6);return`

<h${r}>${i.trim()}</h${r}>
`}},iL(">[ 	]*",{blockPrefix:"<blockquote>",blockSuffix:"</blockquote>"}),iL("(?: {4}|	)",{blockPrefix:"<pre><code>",blockSuffix:"</code></pre>",trimContents:!0,useWarden:!0}),{re:/^(?:[*_-] *){3,}\s*$/gm,rep:"\n\n<hr>\n\n"},iL(" {0,3}[*+-][ 	]+",{blockPrefix:"<ul>",blockSuffix:"</ul>",linePrefix:"<li>",lineSuffix:"</li>"}),iL(" {0,3}\\d+\\.[ 	]+",{blockPrefix:"<ol>",blockSuffix:"</ol>",linePrefix:"<li>",lineSuffix:"</li>"})],iI=[{re:/(?:(?:^|\n{2,})(?!<\w+>))((?:.(?:\n(?!\n))?)+)/g,rep:"\n\n<p>$1</p>\n\n"},{re:/\n{2,}/g,rep:"\n\n"}],iO=[{re:/!(&lt;)?\[(.*?)\]\((https?:\/\/[-\w@:%.+~#=/]+?)(?: +"(.*?)")?\)/gm,rep:(e,t,i,r,a)=>{let n=`<img alt="${i??""}" class="${t?"floatable":""}" src="${r}" title="${a??""}"/>`;return iy.protect(n)}},{re:/\[(.*?)\]\((https?:\/\/[-\w@:%.+~#=/]+?)(?: +"(.*?)")?\)/gm,rep:(e,t,i,r)=>{var a;let n;a=t,n="",/^https:\/\/vimeo.com\//.test(i)?n='<i class="fa-brands fa-vimeo"></i>':/^https:\/\/(www\.)?youtube.com\//.test(i)&&(n='<i class="fa-brands fa-youtube"></i>'),n&&(n=`<span class='link-icon'>${n}</span>`),t=`${a}${n}`;let s=`<a target="_blank" href="${i}" title="${r??""}">${t??""}</a>${iA(i,!0)}`;return iy.protect(s)}},{re:/(?:&lt;|<)(https?:\/\/[-\w@:%.+~#=/]+?)>/gm,rep:(e,t)=>{let i=`<a target="_blank" href="${t}">${t}</a>${iA(t,!0)}`;return iy.protect(i)}},{re:/(?:&lt;|<)([\w.-]+@(?:[\w-]+\.)+[\w-]+)/gm,rep:(e,t)=>{let i=function(e){let t="";for(let i of e)t+=iD(i);return t}(t),r=`<a href="${i}">${i}</a>`;return iy.protect(r)}},{re:/(?:`{2,}(.*?)`{2,}|`(.*?)`)/gm,rep:(e,t,i)=>{let r=`<code>${t??i}</code>`;return iy.protect(r)}},{re:/\*\*([^\s])\*\*/gm,rep:"<strong>$1</strong>"},{re:/__([^\s])__/gm,rep:"<strong>$1</strong>"},{re:/\*([^\s])\*/gm,rep:"<em>$1</em>"},{re:/_([^\s])_/gm,rep:"<em>$1</em>"},{re:/\*\*([^\s])(.*?)([^\s])\*\*/gm,rep:"<strong>$1$2$3</strong>"},{re:/__([^\s])(.*?)([^\s])__/gm,rep:"<strong>$1$2$3</strong>"},{re:/\*([^\s])(.*?)([^\s])\*/gm,rep:"<em>$1$2$3</em>"},{re:/_([^\s])(.*?)([^\s])_/gm,rep:"<em>$1$2$3</em>"}],iR=[{re:/\\([\\`*_{}[\]()#+.!-])/g,rep:(e,t)=>iD(t)}],iC=[{re:"\x00",rep:"ï¿½"}],iN=[{re:/&(?![\w#]+?;)/gm,rep:"&amp;"},{re:/<(?!\/?(?:br|sub|sup)>)/gim,rep:"&lt;"}],iP=[{re:/^\s*$/gm,rep:""},{re:/<(?:p|div)>\s*?<\/(?:p|div)>/gim,rep:""}];function iv(e,t){return e&&t.forEach(t=>{e=e.replaceAll(t.re,t.rep)}),e}function iL(e,t){let i=RegExp(`(?:^|\\n)${e}(?:.|\\n)*?(?:(\\n(?!${e}))|$)`,"g"),r=RegExp(`^${e}([ \\t]*.*)$`,"gm"),a=`${t?.linePrefix??""}$1${t?.lineSuffix??""}`;return{re:i,rep:e=>{let i=e.replaceAll(r,a);return t.trimContents&&(i=i.replace(/^[\n\r]*/,"").trimEnd()),t.useWarden&&(i=iy.protect(i)),`

${t?.blockPrefix??""}${i}${t?.blockSuffix??""}

`}}}function iD(e){return`&#${e.charCodeAt(0).toString()};`}var iM={};iM=JSON.parse('{"frames":[{"filename":"acid00.png","frame":{"x":1,"y":296,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"axe.png","frame":{"x":1,"y":245,"w":42,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":42,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"barbarian1-dead00.png","frame":{"x":934,"y":471,"w":47,"h":33},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":11,"w":47,"h":33},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-idle00.png","frame":{"x":589,"y":244,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-idle01.png","frame":{"x":352,"y":194,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-e00.png","frame":{"x":350,"y":344,"w":41,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":41,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-e01.png","frame":{"x":302,"y":294,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-e02.png","frame":{"x":392,"y":394,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-e03.png","frame":{"x":488,"y":94,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":0,"w":36,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-n00.png","frame":{"x":99,"y":145,"w":48,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":48,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-n01.png","frame":{"x":1,"y":446,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-n02.png","frame":{"x":149,"y":145,"w":48,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":48,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-n03.png","frame":{"x":400,"y":95,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-s00.png","frame":{"x":585,"y":394,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-s01.png","frame":{"x":301,"y":394,"w":44,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":44,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-s02.png","frame":{"x":615,"y":344,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-s03.png","frame":{"x":346,"y":244,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-w00.png","frame":{"x":486,"y":1,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-w01.png","frame":{"x":391,"y":444,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-w02.png","frame":{"x":435,"y":294,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"barbarian1-walk-w03.png","frame":{"x":526,"y":94,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"black_flask.png","frame":{"x":551,"y":444,"w":28,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":28,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"blank.png","frame":{"x":1,"y":496,"w":3,"h":3},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":3,"h":3},"sourceSize":{"w":48,"h":49}},{"filename":"block.png","frame":{"x":51,"y":446,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"blood-splat-twice.png","frame":{"x":1,"y":98,"w":96,"h":94},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":96,"h":94},"sourceSize":{"w":96,"h":96}},{"filename":"blood-splat.png","frame":{"x":94,"y":1,"w":94,"h":92},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":4,"w":94,"h":92},"sourceSize":{"w":96,"h":96}},{"filename":"blue_crystal.png","frame":{"x":827,"y":235,"w":42,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"blue_flask.png","frame":{"x":581,"y":444,"w":28,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":28,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"cantrip.png","frame":{"x":806,"y":284,"w":44,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"chain_mail_armour.png","frame":{"x":331,"y":51,"w":42,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":3,"w":42,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-dead00.png","frame":{"x":885,"y":473,"w":47,"h":31},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":12,"w":47,"h":31},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-idle00.png","frame":{"x":564,"y":1,"w":47,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":47,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-idle01.png","frame":{"x":390,"y":1,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-e00.png","frame":{"x":876,"y":187,"w":42,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":3,"w":42,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-e01.png","frame":{"x":613,"y":1,"w":47,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":2,"w":47,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-e02.png","frame":{"x":900,"y":91,"w":41,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":3,"w":41,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-e03.png","frame":{"x":1132,"y":1,"w":38,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":4,"w":38,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-n00.png","frame":{"x":561,"y":142,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-n01.png","frame":{"x":252,"y":344,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-n02.png","frame":{"x":592,"y":190,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-n03.png","frame":{"x":347,"y":145,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":45,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-s00.png","frame":{"x":772,"y":382,"w":45,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":45,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-s01.png","frame":{"x":851,"y":91,"w":47,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":47,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-s02.png","frame":{"x":798,"y":334,"w":45,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":45,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-s03.png","frame":{"x":52,"y":295,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-w00.png","frame":{"x":951,"y":1,"w":40,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":40,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-w01.png","frame":{"x":301,"y":444,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-w02.png","frame":{"x":836,"y":429,"w":40,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":40,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"cleric1-walk-w03.png","frame":{"x":1029,"y":419,"w":38,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":4,"w":38,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"club.png","frame":{"x":45,"y":245,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"coins.png","frame":{"x":51,"y":194,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"copper_coins.png","frame":{"x":852,"y":283,"w":45,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":45,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"dagger.png","frame":{"x":1181,"y":430,"w":40,"h":35},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":7,"w":40,"h":35},"sourceSize":{"w":49,"h":48}},{"filename":"door-B.png","frame":{"x":96,"y":244,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-L.png","frame":{"x":526,"y":144,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-R.png","frame":{"x":515,"y":344,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-T.png","frame":{"x":102,"y":194,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door2-B.png","frame":{"x":150,"y":95,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door2-T.png","frame":{"x":190,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"engraved_pillar-idle00.png","frame":{"x":868,"y":379,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":3,"w":38,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"failed-spell.png","frame":{"x":375,"y":51,"w":42,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":3,"w":42,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-dead00.png","frame":{"x":1181,"y":67,"w":46,"h":29},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":12,"w":46,"h":29},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-idle00.png","frame":{"x":893,"y":330,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":38,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-idle01.png","frame":{"x":899,"y":282,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":38,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-e00.png","frame":{"x":1050,"y":135,"w":30,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":3,"w":30,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-e01.png","frame":{"x":1111,"y":181,"w":35,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":35,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-e02.png","frame":{"x":1056,"y":88,"w":29,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":3,"w":29,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-e03.png","frame":{"x":1199,"y":135,"w":28,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":4,"w":28,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-n00.png","frame":{"x":955,"y":423,"w":35,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":35,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-n01.png","frame":{"x":1068,"y":182,"w":41,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":41,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-n02.png","frame":{"x":985,"y":375,"w":35,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":35,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-n03.png","frame":{"x":1069,"y":419,"w":37,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":4,"w":37,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-s00.png","frame":{"x":918,"y":234,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":38,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-s01.png","frame":{"x":939,"y":281,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-s02.png","frame":{"x":920,"y":185,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":38,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-s03.png","frame":{"x":993,"y":1,"w":37,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":3,"w":37,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-w00.png","frame":{"x":1070,"y":1,"w":29,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":3,"w":29,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-w01.png","frame":{"x":1124,"y":134,"w":35,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":35,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-w02.png","frame":{"x":1101,"y":1,"w":29,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":3,"w":29,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"fighter1-walk-w03.png","frame":{"x":1199,"y":181,"w":28,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":4,"w":28,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"fire00.png","frame":{"x":52,"y":345,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"fire01.png","frame":{"x":1,"y":194,"w":48,"h":49},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"fire_beetle_pv-dead00.png","frame":{"x":1069,"y":48,"w":47,"h":38},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":5,"w":47,"h":38},"sourceSize":{"w":48,"h":48}},{"filename":"fire_beetle_pv-idle00.png","frame":{"x":52,"y":395,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"fire_beetle_pv-idle01.png","frame":{"x":101,"y":445,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor-SBE.png","frame":{"x":102,"y":294,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor-SBW.png","frame":{"x":146,"y":244,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor.png","frame":{"x":152,"y":194,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBE.png","frame":{"x":200,"y":95,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBW.png","frame":{"x":240,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2.png","frame":{"x":102,"y":344,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-dead00.png","frame":{"x":1181,"y":366,"w":43,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":12,"w":43,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle00.png","frame":{"x":286,"y":51,"w":43,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":6,"w":43,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle01.png","frame":{"x":845,"y":332,"w":46,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":46,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"gold_coins.png","frame":{"x":99,"y":95,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"green_flask.png","frame":{"x":585,"y":344,"w":28,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":28,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"half_plate_armour.png","frame":{"x":682,"y":49,"w":48,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":4,"w":48,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"handaxe.png","frame":{"x":350,"y":294,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":42,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"helmet.png","frame":{"x":878,"y":426,"w":37,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":1,"w":37,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"hidden_artefact-dead00.png","frame":{"x":1195,"y":467,"w":32,"h":32},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":5,"w":32,"h":32},"sourceSize":{"w":48,"h":48}},{"filename":"hidden_artefact-idle00.png","frame":{"x":787,"y":477,"w":28,"h":27},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":5,"w":28,"h":27},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down00.png","frame":{"x":609,"y":142,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down01.png","frame":{"x":611,"y":94,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left00.png","frame":{"x":662,"y":1,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left01.png","frame":{"x":635,"y":238,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right00.png","frame":{"x":640,"y":190,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right01.png","frame":{"x":657,"y":142,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up00.png","frame":{"x":659,"y":92,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up01.png","frame":{"x":710,"y":1,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre00.png","frame":{"x":662,"y":286,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre01.png","frame":{"x":683,"y":238,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen00.png","frame":{"x":102,"y":394,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen01.png","frame":{"x":688,"y":190,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ice00.png","frame":{"x":893,"y":138,"w":42,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":3,"w":42,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"iron_rations.png","frame":{"x":1181,"y":1,"w":46,"h":31},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":10,"w":46,"h":31},"sourceSize":{"w":48,"h":48}},{"filename":"kobold-dead00.png","frame":{"x":1181,"y":398,"w":42,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":12,"w":42,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"kobold-idle00.png","frame":{"x":646,"y":49,"w":34,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":7,"w":34,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"kobold-idle01.png","frame":{"x":609,"y":49,"w":35,"h":43},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":5,"w":35,"h":43},"sourceSize":{"w":48,"h":48}},{"filename":"leather_armour.png","frame":{"x":969,"y":48,"w":48,"h":38},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":38},"sourceSize":{"w":48,"h":48}},{"filename":"liquid_blue-idle00.png","frame":{"x":151,"y":444,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"lock_pick.png","frame":{"x":611,"y":443,"w":41,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":41,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"magic00.png","frame":{"x":419,"y":51,"w":42,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":42,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"manhole_cover-dead00.png","frame":{"x":1161,"y":467,"w":32,"h":33},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":6,"w":32,"h":33},"sourceSize":{"w":48,"h":48}},{"filename":"manhole_cover-idle00.png","frame":{"x":1167,"y":135,"w":30,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":9,"w":30,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"miss.png","frame":{"x":1045,"y":326,"w":44,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":44,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"noxious_gas-idle00.png","frame":{"x":152,"y":294,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-dead00.png","frame":{"x":1079,"y":465,"w":48,"h":36},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":8,"w":48,"h":36},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle00.png","frame":{"x":346,"y":444,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle01.png","frame":{"x":347,"y":394,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w00.png","frame":{"x":393,"y":344,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":40,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"padded_armour.png","frame":{"x":1022,"y":373,"w":48,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":48,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"plate_armour.png","frame":{"x":199,"y":145,"w":48,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":48,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"platinum_coins.png","frame":{"x":1,"y":346,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"poleaxe.png","frame":{"x":1,"y":396,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"portal.png","frame":{"x":1,"y":1,"w":91,"h":95},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":91,"h":95},"sourceSize":{"w":96,"h":96}},{"filename":"purple_plant.png","frame":{"x":1019,"y":48,"w":48,"h":38},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":7,"w":48,"h":38},"sourceSize":{"w":48,"h":48}},{"filename":"quarterstaff.png","frame":{"x":394,"y":145,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":1,"w":45,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"ranger1-dead00.png","frame":{"x":983,"y":470,"w":46,"h":33},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":12,"w":46,"h":33},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-idle00.png","frame":{"x":996,"y":232,"w":33,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":33,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-idle01.png","frame":{"x":958,"y":232,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-e00.png","frame":{"x":937,"y":138,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":38,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-e01.png","frame":{"x":1087,"y":88,"w":39,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":4,"w":39,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-e02.png","frame":{"x":943,"y":90,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":38,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-e03.png","frame":{"x":1091,"y":324,"w":36,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":36,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-n00.png","frame":{"x":992,"y":422,"w":35,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":35,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-n01.png","frame":{"x":1128,"y":88,"w":35,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":4,"w":35,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-n02.png","frame":{"x":998,"y":184,"w":33,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":33,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-n03.png","frame":{"x":1093,"y":275,"w":36,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":4,"w":36,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-s00.png","frame":{"x":960,"y":185,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-s01.png","frame":{"x":1110,"y":228,"w":36,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":36,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-s02.png","frame":{"x":977,"y":137,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-s03.png","frame":{"x":983,"y":88,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-w00.png","frame":{"x":908,"y":377,"w":37,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":37,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-w01.png","frame":{"x":1082,"y":135,"w":40,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":40,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-w02.png","frame":{"x":933,"y":329,"w":37,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":37,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"ranger1-walk-w03.png","frame":{"x":1072,"y":372,"w":37,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":4,"w":37,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rat-dead00.png","frame":{"x":1181,"y":98,"w":45,"h":35},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":13,"w":45,"h":35},"sourceSize":{"w":48,"h":48}},{"filename":"rat-idle00.png","frame":{"x":732,"y":49,"w":48,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":7,"w":48,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"rat-idle01.png","frame":{"x":782,"y":49,"w":48,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":6,"w":48,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-e00.png","frame":{"x":463,"y":51,"w":48,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-n00.png","frame":{"x":928,"y":48,"w":39,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":6,"w":39,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-s00.png","frame":{"x":1049,"y":278,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-w00.png","frame":{"x":513,"y":51,"w":48,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"rat.png","frame":{"x":832,"y":49,"w":48,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":7,"w":48,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"rat_pv-dead00.png","frame":{"x":1031,"y":465,"w":46,"h":37},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":10,"w":46,"h":37},"sourceSize":{"w":48,"h":48}},{"filename":"rat_pv-idle00.png","frame":{"x":631,"y":393,"w":41,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":41,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"rat_pv-idle01.png","frame":{"x":661,"y":342,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"red_crystal.png","frame":{"x":832,"y":187,"w":42,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"red_flask.png","frame":{"x":588,"y":294,"w":28,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":28,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"ring_mail_armour.png","frame":{"x":1066,"y":229,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"RIP.png","frame":{"x":674,"y":391,"w":48,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":48,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-dead00.png","frame":{"x":1181,"y":34,"w":46,"h":31},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":12,"w":46,"h":31},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-idle00.png","frame":{"x":1015,"y":135,"w":33,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":33,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-idle01.png","frame":{"x":1032,"y":1,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-e00.png","frame":{"x":1021,"y":88,"w":33,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":33,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-e01.png","frame":{"x":1131,"y":274,"w":34,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":34,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-e02.png","frame":{"x":1010,"y":326,"w":33,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":33,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-e03.png","frame":{"x":1148,"y":367,"w":31,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":4,"w":31,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-n00.png","frame":{"x":977,"y":279,"w":35,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":35,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-n01.png","frame":{"x":1108,"y":418,"w":35,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":4,"w":35,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-n02.png","frame":{"x":1014,"y":279,"w":33,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":3,"w":33,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-n03.png","frame":{"x":1111,"y":370,"w":35,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":4,"w":35,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-s00.png","frame":{"x":917,"y":424,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-s01.png","frame":{"x":1129,"y":321,"w":35,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":35,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-s02.png","frame":{"x":947,"y":376,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-s03.png","frame":{"x":972,"y":328,"w":36,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":3,"w":36,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-w00.png","frame":{"x":1031,"y":231,"w":33,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":33,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-w01.png","frame":{"x":1145,"y":416,"w":34,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":34,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-w02.png","frame":{"x":1033,"y":182,"w":33,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":3,"w":33,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"rogue1-walk-w03.png","frame":{"x":1166,"y":320,"w":31,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":4,"w":31,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"rusty_key.png","frame":{"x":654,"y":442,"w":33,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":1,"w":33,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"scale_mail_armour.png","frame":{"x":240,"y":51,"w":44,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":3,"w":44,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"shield.png","frame":{"x":871,"y":235,"w":45,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":45,"h":45},"sourceSize":{"w":49,"h":48}},{"filename":"shortsword.png","frame":{"x":705,"y":140,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":46,"h":46},"sourceSize":{"w":49,"h":48}},{"filename":"silver_coins.png","frame":{"x":441,"y":145,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":1,"w":45,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"skeleton-dead00.png","frame":{"x":836,"y":476,"w":47,"h":28},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":13,"w":47,"h":28},"sourceSize":{"w":48,"h":48}},{"filename":"skeleton-idle00.png","frame":{"x":476,"y":394,"w":37,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":0,"w":37,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"skeleton-idle01.png","frame":{"x":435,"y":344,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"skull.png","frame":{"x":249,"y":145,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"slime-idle00.png","frame":{"x":196,"y":244,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"spell.png","frame":{"x":849,"y":139,"w":42,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"spider_pv-dead00.png","frame":{"x":1118,"y":48,"w":46,"h":38},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":5,"w":46,"h":38},"sourceSize":{"w":48,"h":48}},{"filename":"spider_pv-idle00.png","frame":{"x":882,"y":49,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"spider_pv-idle01.png","frame":{"x":563,"y":51,"w":44,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"studded_leather_armour.png","frame":{"x":190,"y":51,"w":48,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":3,"w":48,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"tomb_of_elder.png","frame":{"x":202,"y":194,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader1-dead00.png","frame":{"x":250,"y":95,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader1-idle00.png","frame":{"x":902,"y":1,"w":47,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":47,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"trader1-idle01.png","frame":{"x":252,"y":394,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader2-dead00.png","frame":{"x":290,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader2-idle00.png","frame":{"x":787,"y":430,"w":47,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":3,"w":47,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"trader2-idle01.png","frame":{"x":301,"y":344,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trapdoor-dead00.png","frame":{"x":1148,"y":217,"w":34,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":9,"w":34,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"trapdoor-idle00.png","frame":{"x":1129,"y":464,"w":30,"h":36},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":9,"w":30,"h":36},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox00.png","frame":{"x":707,"y":91,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox01.png","frame":{"x":758,"y":1,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-guides00.png","frame":{"x":702,"y":334,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-guides01.png","frame":{"x":710,"y":286,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-hall-of-fame00.png","frame":{"x":731,"y":238,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-hall-of-fame01.png","frame":{"x":736,"y":188,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play00.png","frame":{"x":753,"y":139,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play01.png","frame":{"x":755,"y":91,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings00.png","frame":{"x":806,"y":1,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings01.png","frame":{"x":724,"y":382,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down00.png","frame":{"x":750,"y":334,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down01.png","frame":{"x":758,"y":286,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left00.png","frame":{"x":779,"y":236,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left01.png","frame":{"x":784,"y":187,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right00.png","frame":{"x":801,"y":139,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right01.png","frame":{"x":803,"y":91,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up00.png","frame":{"x":854,"y":1,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up01.png","frame":{"x":739,"y":430,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"undead00.png","frame":{"x":152,"y":344,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"undefined.png","frame":{"x":1199,"y":227,"w":28,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":11,"y":2,"w":28,"h":44},"sourceSize":{"w":49,"h":48}},{"filename":"vegetation-dead00.png","frame":{"x":611,"y":492,"w":29,"h":11},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":17,"w":29,"h":11},"sourceSize":{"w":48,"h":48}},{"filename":"vegetation-idle00.png","frame":{"x":689,"y":487,"w":29,"h":16},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":12,"w":29,"h":16},"sourceSize":{"w":48,"h":48}},{"filename":"wall-B.png","frame":{"x":152,"y":394,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BL.png","frame":{"x":515,"y":394,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BLI.png","frame":{"x":201,"y":444,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BR.png","frame":{"x":521,"y":194,"w":34,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":34,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BRI.png","frame":{"x":202,"y":294,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BTEE.png","frame":{"x":246,"y":244,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-HI.png","frame":{"x":252,"y":194,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-L.png","frame":{"x":516,"y":444,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-LTEE.png","frame":{"x":550,"y":344,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-R.png","frame":{"x":553,"y":294,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-RTEE.png","frame":{"x":554,"y":244,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-T.png","frame":{"x":300,"y":95,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TL.png","frame":{"x":557,"y":194,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TLI.png","frame":{"x":340,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TR.png","frame":{"x":550,"y":394,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TRI.png","frame":{"x":202,"y":344,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TTEE.png","frame":{"x":202,"y":394,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-VI.png","frame":{"x":251,"y":444,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-XI.png","frame":{"x":252,"y":294,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-B.png","frame":{"x":296,"y":244,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-HI.png","frame":{"x":302,"y":194,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-T.png","frame":{"x":350,"y":95,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"warhammer.png","frame":{"x":298,"y":145,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":47,"h":47},"sourceSize":{"w":49,"h":48}},{"filename":"waterskin.png","frame":{"x":618,"y":293,"w":42,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":1,"w":42,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-dead00.png","frame":{"x":1148,"y":180,"w":47,"h":35},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":10,"w":47,"h":35},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-idle00.png","frame":{"x":434,"y":394,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-idle01.png","frame":{"x":394,"y":244,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-e00.png","frame":{"x":399,"y":194,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-e01.png","frame":{"x":439,"y":1,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-e02.png","frame":{"x":394,"y":294,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-e03.png","frame":{"x":526,"y":1,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":36,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-n00.png","frame":{"x":435,"y":244,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-n01.png","frame":{"x":435,"y":444,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-n02.png","frame":{"x":440,"y":194,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-n03.png","frame":{"x":477,"y":444,"w":37,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":37,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-s00.png","frame":{"x":488,"y":144,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":0,"w":36,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-s01.png","frame":{"x":475,"y":294,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-s02.png","frame":{"x":515,"y":294,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":0,"w":36,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-s03.png","frame":{"x":447,"y":95,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-w00.png","frame":{"x":476,"y":244,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-w01.png","frame":{"x":481,"y":194,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-w02.png","frame":{"x":475,"y":344,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wizard1-walk-w03.png","frame":{"x":516,"y":244,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":6,"y":0,"w":36,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wraith-dead00.png","frame":{"x":819,"y":382,"w":47,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"wraith-idle00.png","frame":{"x":689,"y":439,"w":48,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":48,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"wraith-idle01.png","frame":{"x":561,"y":94,"w":48,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":48,"h":46},"sourceSize":{"w":48,"h":48}}],"meta":{"app":"https://www.codeandweb.com/texturepacker","version":"1.0","image":"dungeon.png","format":"RGBA8888","size":{"w":1228,"h":505},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:6a3a5f4caea402990412b449e39868ad:9ae90920268748adbebed918a37b80f7:9c0fba27a8a0c106083a8713f6c67b32$"}}');var ib={};ib=new URL("about.167275cc.md",import.meta.url).toString();var i_={};i_=new URL("armour.544d9006.txt",import.meta.url).toString();var iz={};iz=new URL("artefacts.a0ffbaae.txt",import.meta.url).toString();var ik={};ik=new URL("magic.2224265f.txt",import.meta.url).toString();var iB={};iB=new URL("monsters.b72d1322.txt",import.meta.url).toString();var iG={};iG=new URL("heroes.2d1d5c8e.txt",import.meta.url).toString();var iU={};iU=new URL("money.07bbfbaa.txt",import.meta.url).toString();var iH={};iH=new URL("traders.1d8d82a4.txt",import.meta.url).toString();var iF={};iF=new URL("weapons.fc46d85c.txt",import.meta.url).toString();var i$={};i$=new URL("keys.f3b71340.txt",import.meta.url).toString();var iW={};iW=new URL("traps.372f7cd1.txt",import.meta.url).toString();var iK={};iK=new URL("plants.721683b7.txt",import.meta.url).toString();var iV={};iV=new URL("objectives.db6c512b.txt",import.meta.url).toString();var iY={};iY=new URL("dungeon-completed.6e49dc4f.md",import.meta.url).toString();var iX={};iX=new URL("dungeon_script.34f994bb.txt",import.meta.url).toString();var iq={};iq=new URL("dungeon-welcome.97ed0392.md",import.meta.url).toString();var ij={};ij=new URL("dungeon-welcome-casual.d4a9c126.md",import.meta.url).toString();var iZ={};iZ=new URL("help.29d4aacb.md",import.meta.url).toString();var iJ={};iJ=new URL("do-alto-do-trono-da-desolacao-trimmed.18cbfbbb.mp3",import.meta.url).toString();var iQ={};iQ=new URL("privacy.9596e717.md",import.meta.url).toString();var i4={};i4=new URL("startupTips.c747051b.md",import.meta.url).toString();var i0={};i0=new URL("quickStart.c5e1f66a.md",import.meta.url).toString();var i1={};i1=new URL("punch-trimmed.d5ee82fe.mp3",import.meta.url).toString();var i8={};i8=new URL("punch-trimmed-double.7756f095.mp3",import.meta.url).toString();var i3={};i3=new URL("long-medium-swish-trimmed.69cad07b.mp3",import.meta.url).toString();var i2={};i2=new URL("bubbling-trimmed.361718fa.mp3",import.meta.url).toString();var i5={};i5=new URL("male-hurt-sound-trimmed.76fa38ed.mp3",import.meta.url).toString();var i6={};i6=new URL("pig-oink-47167.4d796935.mp3",import.meta.url).toString();var i9={};i9=new URL("squeal-thing-103111.d7f21093.mp3",import.meta.url).toString();var i7={};i7=new URL("metal-blade-slice-32-195321.f9effd4c.mp3",import.meta.url).toString();var re={};re=new URL("click-and-crawl.10b21974.png",import.meta.url).toString();const rt={ABOUT_MD:new URL(ib),ALMANAC_MAP:new Map([["ARMOUR",new URL(i_)],["ARTEFACTS",new URL(iz)],["MAGIC",new URL(ik)],["ENEMIES",new URL(iB)],["HEROES",new URL(iG)],["MONEY",new URL(iU)],["TRADERS",new URL(iH)],["WEAPONS",new URL(iF)],["KEYS",new URL(i$)],["TRAPS",new URL(iW)],["PLANTS",new URL(iK)],["OBJECTIVES",new URL(iV)]]),DUNGEON_COMPLETE:new URL(iY),DUNGEON_SCRIPT:new URL(iX),DUNGEON_WELCOME:new URL(iq),DUNGEON_WELCOME_CASUAL:new URL(ij),HELP_MD:new URL(iZ),MUSIC:new URL(iJ),PRIVACY_MD:new URL(iQ),STARTUP_TIPS_MD:new URL(i4),QUICK_START_MD:new URL(i0),SOUND_EFFECTS_MAP:new Map([["PUNCH",new URL(i1)],["DOUBLE PUNCH",new URL(i8)],["MISS",new URL(i3)],["POISONED",new URL(i2)],["DIE",new URL(i5)],["DIE_MONSTER",new URL(i6)],["DIE_MONSTER_SMALL",new URL(i9)],["TRIGGER TRAP",new URL(i7)]]),SPLASH_IMAGE:new URL(re)};var ri={};ri=new URL("dungeon.c0a1d27f.png",import.meta.url).toString();const rr={data:(f=iM)&&f.__esModule?f.default:f,textureUrl:new URL(ri)};function ra(e,t={}){return tv(e).then(i=>{let r,a;if(i){var n,s;iy.clear(),s=iv(s=i.replaceAll(/\r/g,""),iC),n?.pre&&(s=iv(s,n.pre)),s=iv(s,iN),s=iv(s,iR),s=iv(s,ix),s=iv(s,iI),s=iv(s,iO),s=iv(s,iP),n?.post&&(s=iv(s,n.post)),r=iy.reinstate(s)}else a=eJ`MESSAGE CANNOT LOAD URL ${e.toString()}`;let o=ej("div",{className:"parsed-markdown",text:a,html:r});return e5.showControlsDialog(o,{actionButtons:t.actionButtons,row:!0,okButtonLabel:t.okButtonLabel})})}const rn={MAIN_MENU:0,CLICKED_FREE_GROUND:1,CLICKED_ENTRANCE:2,CLICKED_EXIT:3};let rs=!0;class ro{#e6;#tQ;#t4;#e4;#t0;#t1;constructor(e,t,i,r){this.#e6=e,this.#e4=t,this.#t0=i,this.#t1=r}#t8(e){if(this.#e6.moveType===aE.HUNT){if(this.#t1)return e;{let t=this.#e4.worldPointToGrid(i.position);if(e.getOrthoSeparation(t)-1<=1.5*this.#e6.getMaxTilesPerMove())return this.#e4.worldPointToGrid(i.position)}}return this.#t3(e,this.#e6.getMaxTilesPerMove())}moveInstantly(){this.#t4=v.copy(this.#e6.position);let e=this.#e4.worldPointToGrid(this.#e6.position),t=this.#t8(e);if(!t.coincident(e)){this.#t0.actor=this.#e6;let i=this.#t0.getDumbRouteNextTo(e,t,this.#e6.getMaxTilesPerMove());i.length>0&&(this.#tQ=new eb({path:i,speed:100},this.#e6.sprite.modifier),this.#t2(i[i.length-1]))}}#t3(e,t){let i=I(e.x-t,e.x+t),r=I(e.y-t,e.y+t),a=this.#e4.getDimsInTiles();return new C(T(i,0,a.width-1),T(r,0,a.height-1))}#t2(e){let t=this.#e4.worldPointToGrid(this.#e6.position);this.#e6.position=e;let i=this.#e4.worldPointToGrid(this.#e6.position);this.#e4.moveTileOccupancyGridPoint(this.#e6,t,i)}#t5(){this.#t2(this.#t4)}replay(){return(this.#t5(),this.#tQ)?(this.#t6(),this.#tQ.applyAsTransientToSprite(this.#e6.sprite)):Promise.resolve()}#t6(){if(this.#e6.isOrganic()){let e=iu(this.#e6.almanacEntry);e.position=this.#t4,e.freezeMovement(),el.addActor(e)}}}class rl{#e4;#t0;#t9;#t1;constructor(e,t,i){this.#t9=[],this.#e4=e,this.#t0=t,this.#t1=i}addAndMoveActor(e){if(0===e.getMaxTilesPerMove())return;let t=new ro(e,this.#e4,this.#t0,this.#t1);t.moveInstantly(),this.#t9.push(t)}replay(){let e=[];return this.#t9.forEach(t=>e.push(t.replay())),Promise.all(e)}}class rh{constructor(){}async transitionTo(e){await this.onExit().then(()=>(rN=e,e.onEntry()))}onEntry(){return Promise.resolve()}onEvent(e){return Promise.resolve(null)}onExit(){return Promise.resolve(null)}}class rc extends rh{onEntry(){return(function(){let e=new eK({leftLabel:eJ`BUTTON PLAY ADVENTURE`,imageName:"ui-play00.png",internalLabel:!0,closes:"PLAY ADVENTURE"}),t=new eK({leftLabel:eJ`BUTTON PLAY CASUAL`,imageName:"ui-play00.png",internalLabel:!0,closes:"PLAY CASUAL"}),i=new eK({leftLabel:eJ`BUTTON SETTINGS`,imageName:"ui-settings00.png",internalLabel:!0,action:()=>t9()}),r=new eK({leftLabel:eJ`BUTTON HALL OF FAME`,imageName:"ui-hall-of-fame00.png",internalLabel:!0,action:()=>(function(){let e=ej("div",{className:"best-adventure"}),t=iS().getCurrentData();if(0===t.length)e.appendChild(ej("p",{text:eJ`MESSAGE NO SAVED ADVENTURE`}));else{let i=document.createElement("ul");for(let r of(e.appendChild(i),t))i.appendChild(ej("li",{text:function(e){let t=new Date(e.adventureStartTime).toISOString().split("T")[0],i=e.class?.toLowerCase()??"";return eJ`MESSAGE HALL OF FAME ENTRY ${e.name} ${e.characterLevel} ${i} ${t} ${e.gold} ${e.dungeonFloor}`}(r)}))}return e5.showElementOkDialog(eJ`DIALOG TITLE HALL OF FAME`,e)})()}),a=new eK({leftLabel:eJ`BUTTON GUIDES`,imageName:"ui-guides00.png",internalLabel:!0,action:()=>(function(){let e=new eW({label:eJ`BUTTON ABOUT`,action:()=>ra(rt.ABOUT_MD)}),t=new eW({label:eJ`BUTTON HELP`,action:()=>ra(rt.HELP_MD)}),i=new eW({label:eJ`BUTTON PRIVACY`,action:()=>ra(rt.PRIVACY_MD)});return ra(rt.QUICK_START_MD,{actionButtons:[t,e,i]})})()});return e5.showControlsDialog(eJ`MENU TITLE MAIN`,{actionButtons:[a,i,r,e,t],className:"door"})})().then(async e=>{rs="PLAY CASUAL"!==e,await this.transitionTo(new ru)})}}class ru extends rh{onEntry(){return m.debug("Enter AtStart"),this.#t7().then(()=>this.#ie()).then(e=>{let t=i.traits.get("NAME");return e?e5.showOkDialog(eJ`MESSAGE DUNGEON INTRO CONTINUE ${t}`,{okButtonLabel:eJ`BUTTON ENTER DUNGEON`,className:"wall"}).then(()=>ae(i)):ra(rs?rt.DUNGEON_WELCOME:rt.DUNGEON_WELCOME_CASUAL,{okButtonLabel:eJ`BUTTON ENTER DUNGEON`})}).then(()=>{i.sprite.position=el.getTileMap().getWorldPositionOfTileByEntry()}).then(()=>{let e=rX.getCurrentSceneIntro();return e?e5.showOkDialog(e,{className:"mask"}):void 0}).then(()=>rN.transitionTo(new rf))}#ie(){let e=rs?function(){let e=eF.get("GAME_STATE",null,iE);if(!e){m.debug("No saved game state to restore.");return}if(!e.hero.alive){m.debug("Last hero state was dead, so not restoring.");return}if(e.completed){m.debug("Last game was completed, so not restoring.");return}return{hero:e.hero,sceneLevel:e.sceneLevel}}():null;return e?rX.continueFromSavedScene(e.sceneLevel,e.hero).then(()=>!0):rX.switchToFirstScene().then(()=>!1)}#t7(){if(!eF.get("SHOW_QUICK_TIPS_AT_START",!0))return Promise.resolve();let e=new eW({label:eJ`BUTTON OK`,closes:"OK"}),t=new eW({label:eJ`BUTTON DO NOT SHOW AGAIN`,closes:"NOT AGAIN"});return ra(rt.STARTUP_TIPS_MD,{actionButtons:[e,t]}).then(e=>{"NOT AGAIN"===e&&eF.set("SHOW_QUICK_TIPS_AT_START",!1)})}}class rd extends rh{async onEntry(){m.debug("Enter AtGameOver"),rs&&iw(i),eB("YOU DIED!",{delaySecs:1,lifetimeSecs:2,position:i.position,velocity:new N(0,-100,0)}),await new Promise(e=>{setTimeout(()=>e(),2e3)}).then(()=>e5.showOkDialog(eJ`MESSAGE DEFEAT`,{okButtonLabel:eJ`BUTTON TRY AGAIN`})).then(()=>rX.unloadCurrentScene()).then(()=>this.transitionTo(new rc))}}class rp extends rh{async onEntry(){m.debug("Enter AtGameCompleted"),await ra(rt.DUNGEON_COMPLETE,{okButtonLabel:eJ`BUTTON TRY AGAIN`}).then(()=>rX.unloadCurrentScene()).then(()=>this.transitionTo(new rc))}}class rf extends rh{constructor(){super()}async onEntry(){await super.onEntry(),m.debug("Enter HeroTurnIdle"),await rw(),await rE()&&await this.transitionTo(new rd)}async onEvent(e,t,r={}){switch(e){case rn.CLICKED_FREE_GROUND:{let e=await rR(r.filter,r.occupant);e===t8.INTERACT_TILE?await rA(t):e===t8.OCCUPIED_TILE?await rO(r.occupant):await rT(t,{usePathFinder:r.filter!==t8.MOVE_OR_INTERACT_TILE}),r.occupant?.isObjective()&&e===t8.INTERACT_TILE?await rx():0===i.traits.get("HP",0)?await this.transitionTo(new rd):await this.transitionTo(new rg)}break;case rn.CLICKED_ENTRANCE:await e5.showOkDialog(eJ`MESSAGE ENTRANCE STUCK`),await this.transitionTo(new rg);break;case rn.CLICKED_EXIT:m.debug("Escaping"),await rC()?await rT(t,{usePathFinder:!1}).then(()=>rI(this)):await this.transitionTo(new rg)}return Promise.resolve(null)}}class rm extends rh{constructor(){super()}async onEntry(){await super.onEntry(),m.debug("Enter HeroTurnInteracting"),await rw(),await rE()&&await this.transitionTo(new rd)}async onEvent(e,t,r={}){switch(e){case rn.CLICKED_FREE_GROUND:{let e=await rR(r.filter,r.occupant);e===t8.INTERACT_TILE?await rA(t):e===t8.OCCUPIED_TILE?await rO(r.occupant):await this.#it(t,{usePathFinder:r.filter!==t8.MOVE_OR_INTERACT_TILE}),r.occupant?.isObjective()&&e===t8.INTERACT_TILE?await rx():0===i.traits.get("HP",0)?await this.transitionTo(new rd):await this.#ii()}break;case rn.CLICKED_ENTRANCE:await e5.showOkDialog(eJ`MESSAGE ENTRANCE STUCK`),await this.#ii();break;case rn.CLICKED_EXIT:await rC()?await this.#it(t,{usePathFinder:!1}).then(()=>rI(this)):await this.#ii()}return Promise.resolve(null)}async #ii(){0===el.getTileMap().getParticipants(i).length?await this.transitionTo(new rg):await this.transitionTo(new rS)}#it(e,t={usePathFinder:!0}){let r=el.getTileMap(),a=r.getParticipants(i),n=!1;for(let e of a)if(e.alive&&e.interaction.respectDisengage(i)){n=!0;break}let s=r.worldPointToGrid(i.position),o=r.worldPointToGrid(e),l=s.getOrthoSeparation(o);return n&&l<=2&&(i.disengaging=!0),rT(e,t).then(()=>!0)}}class rg extends rh{constructor(){super()}async onEntry(){await super.onEntry(),m.debug("Enter ComputerTurnIdle"),await ry();let e=el.getTileMap(),t=new t4(e),r=new rl(e,t,i.disengaging);for(let e of el.getActors().values())e!==i&&e.alive&&(!e.isWandering()||ti(6)>3)&&r.addAndMoveActor(e);for(let e of el.getOrganicActors().values())e.alive&&r.addAndMoveActor(e);for(let t of(await r.replay(),e.getParticipants(i)))if(t.isEnemy())return await this.transitionTo(new rm),Promise.resolve(null);await this.transitionTo(new rf)}}class rS extends rh{constructor(){super()}async onEntry(){await super.onEntry(),await ry();let e=el.getTileMap(),t=new t4(e),r=new rl(e,t,i.disengaging),a=e.getParticipants(i);for(let e of el.getActors().values())e!==i&&e.alive&&e.interaction&&(a.includes(e)&&e.willInteract()?await e.interaction.enact(i):r.addAndMoveActor(e));for(let e of el.getOrganicActors().values())e.alive&&r.addAndMoveActor(e);return await r.replay(),0===i.traits.get("HP",0)?await this.transitionTo(new rd):0===a.length?await this.transitionTo(new rf):await this.transitionTo(new rm),Promise.resolve(null)}}function rw(){i.disengaging=!1;let e=el.getTileMap(),t=new t4(e,i).getAllRoutesFrom(e.worldPointToGrid(i.sprite.position),i.getMaxTilesPerMove());return e.setMovementRoutes(t),e.setInteractActors(e.getParticipants(i)),e.calcReachableDoors(i.position),Promise.resolve(null)}function rE(){return!!i.toxify?.isActive&&(i.toxify.enact(i),0>=i.traits.getInt("HP",0))}function rT(e,t={usePathFinder:!0}){let r;let a=el.getTileMap();return(r=t.usePathFinder?a.getWaypointsToWorldPoint(e):[i.position,e],a.setMovementRoutes(null),a.setInteractActors(null),r)?new eb({path:r,speed:100},i.sprite.modifier).applyAsTransientToSprite(i.sprite):Promise.resolve()}function ry(){let e=el.getTileMap(),t=[];return el.getOrganicActors().forEach(i=>{e.getCoincidentActors(i).forEach(e=>{e.alive&&!e.isOrganic()&&i.interaction&&t.push(i.interaction.enact(e))})}),Promise.all(t)}function rA(e){let t=el.getTileMap().getTileAtWorldPoint(e).getOccupants(),r=[];for(let e of t.values())e.interaction&&r.push(e.interaction.react(i));return Promise.all(r)}function rx(){return i.traits.clearTransientFxTraits(),rs&&iw(i,!0),rN.transitionTo(new rp)}function rI(e){return(i.traits.clearTransientFxTraits(),rs&&iw(i),rX.areThereMoreScenes())?rX.unloadCurrentScene().then(()=>ae(i)).then(()=>rX.switchToNextScene()).then(e=>(i.sprite.position=el.getTileMap().getWorldPositionOfTileByEntry(),e)).then(e=>e.intro?e5.showOkDialog(e.intro,{className:"wall"}):void 0).then(()=>e.transitionTo(new rf)):e.transitionTo(new rp)}function rO(e){return e?e.isHiddenArtefact()?e5.showOkDialog(e.description):r9(e,{allowConsumption:e.isHero(),allowMagicUse:e.isHero()}):(m.error("Clicked on tile but no occupant to view."),Promise.resolve())}function rR(e,t){if(e===t8.MOVE_OR_INTERACT_TILE){if(t?.isHiddenArtefact()){let e=t.storeManager.getFirstStorageDetails(),i=e?.artefact;if(t.alive&&i)return t8.INTERACT_TILE;if(!t.alive&&!i)return t8.MOVEMENT_TILE}return e5.showChoiceDialog(eJ`DIALOG TITLE CHOICES`,eJ`MESSAGE SEARCH OR MOVE`,[eJ`BUTTON CLIMB OVER`,eJ`BUTTON SEARCH`]).then(e=>0===e?t8.MOVEMENT_TILE:t8.INTERACT_TILE)}return e}function rC(){var e,t;return r?i.storeManager.hasArtefact(r)?(i.storeManager.discard(r),e5.showOkDialog(eJ`MESSAGE KEY UNLOCKS EXIT`).then(()=>!0)):(e=i,t=r,e5.showChoiceDialog(eJ`DIALOG TITLE LOCKED`,eJ`MESSAGE EXIT LOCKED`,[eJ`BUTTON TRY TO PICK`,eJ`BUTTON LEAVE IT`]).then(i=>0===i&&(e.storeManager.hasArtefactWithSameId("lock_pick")?ty(e.traits,{ability:"DEX",difficulty:t.traits.get("DC",tg.EASY),proficiency:"PICK LOCK"})?e5.showOkDialog(eJ`MESSAGE YOU PICK THE LOCK`).then(()=>!0):e5.showOkDialog(eJ`MESSAGE YOU FAIL TO PICK THE LOCK`).then(()=>!1):e5.showOkDialog(eJ`MESSAGE NEED LOCK PICK`).then(()=>!1)))):Promise.resolve(!0)}let rN=new class extends rh{onEntry(){m.debug("WaitingToStart state")}async onEvent(e,t,i){if(e!==rn.MAIN_MENU)return Promise.resolve();await this.transitionTo(new rc)}},rP=!1;var rv={EventId:rn,getHeroActor:function(){return i},setHero:function(e){i=e},triggerEvent:function(e,t,i){if(rP){m.debug(`Ignoring event ${e} as still processing earlier event.`);return}rP=!0,rN.onEvent(e,t,i).then(()=>{rP=!1})},setExitKeyArtefact:function(e){r=e}};function rL(e){return{role:t3.GROUND,onClick:(e,t,i)=>rv.triggerEvent(rv.EventId.CLICKED_FREE_GROUND,t,i),image:e}}function rD(e){return{role:t3.ENTRANCE,onClick:(e,t,i)=>rv.triggerEvent(rv.EventId.CLICKED_ENTRANCE,t,i),image:e}}function rM(e){return{role:t3.EXIT,onClick:(e,t,i)=>rv.triggerEvent(rv.EventId.CLICKED_EXIT,t,i),image:e}}const rb=new Map([["x",{role:t3.OBSTACLE,image:"block.png"}],["#-TL",{role:t3.OBSTACLE,image:"wall-TL.png"}],["#-TLI",{role:t3.OBSTACLE,image:"wall-TLI.png"}],["#-T",{role:t3.OBSTACLE,image:"wall-T.png"}],["*-T",{role:t3.OBSTACLE,image:"wall2-T.png"}],["#-TR",{role:t3.OBSTACLE,image:"wall-TR.png"}],["#-TRI",{role:t3.OBSTACLE,image:"wall-TRI.png"}],["#-R",{role:t3.OBSTACLE,image:"wall-R.png"}],["#-BR",{role:t3.OBSTACLE,image:"wall-BR.png"}],["#-BRI",{role:t3.OBSTACLE,image:"wall-BRI.png"}],["#-B",{role:t3.OBSTACLE,image:"wall-B.png"}],["*-B",{role:t3.OBSTACLE,image:"wall2-B.png"}],["#-BL",{role:t3.OBSTACLE,image:"wall-BL.png"}],["#-BLI",{role:t3.OBSTACLE,image:"wall-BLI.png"}],["#-L",{role:t3.OBSTACLE,image:"wall-L.png"}],["#-XI",{role:t3.OBSTACLE,image:"wall-XI.png"}],["#-VI",{role:t3.OBSTACLE,image:"wall-VI.png"}],["#-HI",{role:t3.OBSTACLE,image:"wall-HI.png"}],["#-TTEE",{role:t3.OBSTACLE,image:"wall-TTEE.png"}],["#-RTEE",{role:t3.OBSTACLE,image:"wall-RTEE.png"}],["#-BTEE",{role:t3.OBSTACLE,image:"wall-BTEE.png"}],["#-LTEE",{role:t3.OBSTACLE,image:"wall-LTEE.png"}],["#",{role:t3.OBSTACLE,image:"block.png"}],["=-T",rM("door-T.png")],[">-T",rM("door2-T.png")],["=-R",rM("door-R.png")],["=-B",rM("door-B.png")],[">-B",rM("door2-B.png")],["=-L",rM("door-L.png")],["--T",rD("door-T.png")],["~-T",rD("door2-T.png")],["--R",rD("door-R.png")],["--B",rD("door-B.png")],["~-B",rD("door2-B.png")],["--L",rD("door-L.png")],["=",{role:t3.OBSTACLE,image:"block.png"}],["-",{role:t3.OBSTACLE,image:"block.png"}],[".",rL("floor.png")],[".-SBW",rL("floor-SBW.png")],[".-SBE",rL("floor-SBE.png")],[",-SBE",rL("floor2-SBE.png")],[",-SBW",rL("floor2-SBW.png")],[",",rL("floor2.png")]]);class r_{#ir;#q;#ia;#is;#io;heroActor;intro;constructor(e=2,t=2){e>0?(this.#ir=0,this.#q=1/e):this.#q=1,this.#ia=e,this.#is=t}getOpacity(){return this.#ir}load(){return this.doLoad()}initialise(){return this.doInitialise()}update(e){Q.clearCanvas(),Q.setOpacity(this.#ir),el.update(e),this.doUpdate(e),Q.setOpacity(1),0!==this.#q&&(this.#ir+=e*this.#q,this.#ir>1?(this.#q=0,this.#ir=1):this.#ir<0&&(this.#q=0,this.#ir=0)),this.#io&&0===this.#ir&&(this.#io(),this.#io=null)}unload(){return this.#il().then(()=>this.doUnload())}#il(){return this.#is>0?(this.#q=-1/this.#is,new Promise(e=>{this.#io=e})):Promise.resolve()}doLoad(){return Promise.resolve()}doInitialise(){return Promise.resolve()}doUpdate(e){return Promise.resolve()}doUnload(){return Promise.resolve()}}const rz=eU.TILE_SIZE;function rk(e,t){let i,r;if(e.type===tk.CONSUMABLE&&/SUBTYPE *: *VEGETATION/i.test(e.traitsString))i="vegetation",r=aS.HIDDEN_ARTEFACT;else switch(e.type){case tk.SPELL:case tk.CANTRIP:i="engraved_pillar",r=aS.PROP;break;default:{let e=ti(6);i=e<3?"hidden_artefact":e<5?"trapdoor":"manhole_cover"}r=aS.HIDDEN_ARTEFACT}let a=iu({id:i,name:tN(i),description:tP(i),imageName:i,type:r,traitsString:""}),n=t??t_(e);return a.storeManager.addArtefact(n),a}function rB(e,t,i){if(t){let r=t_(t);i.equip&&r.equipStoreType?e.storeManager?.equip(r,{direct:!0}):e.storeManager?.stash(r,{direct:!0})}}class rG extends r_{#ih;constructor(e){super(),this.#ih=e,this.intro=e.intro}doLoad(){return Promise.resolve()}doInitialise(){var e;let t=tY.generateTileMapPlan(this.#ih.mapDesign,rb);this.heroActor=function(e){if(e.hero instanceof aT)a=e.hero;else if(e.hero)a=iu(e.hero);else if(!a)throw Error("No hero has been defined.");return a}(this.#ih);let i=new t5(Q.getContext2D(),t,rz,this.heroActor);el.setTileMap(i);let r=(e=this.#ih).objective?iu(e.objective):null;if(r){let e=i.getRandomFreeGroundTile();e?(r.position=e.worldPoint,el.addArtefact(r)):(m.debug("No free tiles for objective."),r=null)}let n=tb.getRandomEntry("KEYS"),s=r||ti(6)>3?t_(n):null,o=!r&&s?1:0,l=tb.getPooledAlmanac(["ARTEFACTS","ARMOUR","WEAPONS"],e=>e.minLevel<=rX.getCurrentSceneLevel()),h=l.find(e=>"waterskin"===e.id),c=l.find(e=>"iron_rations"===e.id);for(let e of function(e){let t=[];return e.enemies.forEach(e=>{let i=iu(e);t.push(i)}),t}(this.#ih)){let t=i.getRandomFreeGroundTile();if(!t){m.debug("No free tiles for enemy.");break}if(e.position=t.worldPoint,el.addActor(e),e.isTrader()){e.traits.exceedAbilitiesAndExp?.(this.heroActor.traits,1);let t=7;ti(6)>3&&(rB(e,h,{equip:!1}),t--),ti(6)>3&&(rB(e,c,{equip:!1}),t--),function(e,t,i){for(;i.qty-- >0;)rB(e,t.getRandomEntry(),i)}(e,l,{qty:t,equip:!1})}else o&&!e.isOrganic()&&e.traits.get("HAS_KEYS")&&(e.storeManager.stash(s,{direct:!0}),o=0,m.debug("Added key to actor."))}if(o){let e=rk(n,s),t=i.getRandomFreeGroundTile();t&&(e.position=t.worldPoint,el.addArtefact(e),o=0,m.debug("Added key as hidden object."))}for(let e of function(e){let t=[];return e.artefacts.forEach(e=>{let i=rk(e);t.push(i)}),t}(this.#ih)){let t=i.getRandomFreeGroundTile();if(!t){m.debug("No free tile to add artefact.");break}e.position=t.worldPoint,el.addArtefact(e)}return rX.setCameraToTrack(this.heroActor.sprite,200,0),el.addActor(this.heroActor),rv.setHero(this.heroActor),o>0?rv.setExitKeyArtefact(null):rv.setExitKeyArtefact(s),Promise.resolve()}doUpdate(e){}doUnload(){return Promise.resolve(null)}}const rU={OFF:0,HERO:1,VELOCITY:2};class rH{#ic;#iu;#id;#ip;constructor(e,t,i=0){let r=Q.getCanvasDimensions(),a=i*Math.min(r.width,r.height);this.#ic=new eC,this.#iu=new eM({prey:e,speed:t,maxSeparation:a}),this.#id=new eL,this.#iu.applyAsContinuousToSprite(this.#ic)}update(e){this.#ip!==rU.OFF&&(this.#ic.update(e),Q.centreCanvasOn(this.#ic.position))}setVelocity(e,t){this.setTrackingMethod(rU.VELOCITY),this.#ic.velocity.x=e,this.#ic.velocity.y=t}panBy(e,t){this.#ic.position.x+=e,this.#ic.position.y+=t,Q.centreCanvasOn(this.#ic.position)}setTrackingMethod(e){if(e!==this.#ip)switch(this.#ip=e,e){case rU.HERO:this.#iu.applyAsContinuousToSprite(this.#ic);break;case rU.VELOCITY:this.#id.applyAsContinuousToSprite(this.#ic);break;case rU.OFF:break;default:m.error(`Attempt to set invalid tracking method of ${e} ignored.`)}}}const rF={TR:0,BR:1,BL:2,TL:3};class r${#im;#ig;#iS;constructor(e,t,i,r){this.#im=e,this.#iw(t,i,!1),this.#iE(t,r)}#iE(e,t){let i=new eE({prefix:"ui-settings",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:eg.STOP}),r=aO.addButton(i,()=>t9()),a=this.#iT(e,t,1);r.position.x=a.x,r.position.y=a.y}#iT(e,t,i){let r=new C(0,0);switch(t){case rF.TL:r.x=i*e,r.y=i*e;break;case rF.TR:r.x=-i*e,r.y=i*e;break;case rF.BR:r.x=-i*e,r.y=-i*e;break;case rF.BL:r.x=i*e,r.y=-i*e}return r}#iw(e,t,i){let r=this.#iT(e,t,i?2:1);this.#iy(r.x,r.y),i&&this.#iA(r.x,r.y,e)}#iy(e,t){this.#iS=new eE({prefix:"hud-auto-centre",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:eg.STOP}),this.#ig=aO.addButton(this.#iS,()=>{this.setTrackingState(!0)},()=>{this.setTrackingState(!1)}),this.#ig.position.x=e,this.#ig.position.y=t,this.#ig.actionClick(null)}setTrackingState(e){e?(this.#iS.setCurrentIndex(1),this.#im.setTrackingMethod(rU.HERO)):(this.#iS.setCurrentIndex(0),this.#im.setTrackingMethod(rU.OFF))}#iA(e,t,i){let r=3*i;this.#ix("hud-arrow-up",e,t-i,()=>{this.setTrackingState(!1),this.#im.setVelocity(0,-r)},()=>this.#im.setTrackingMethod(rU.OFF)),this.#ix("hud-arrow-right",e+i,t,()=>{this.setTrackingState(!1),this.#im.setVelocity(r,0)},()=>this.#im.setTrackingMethod(rU.OFF)),this.#ix("hud-arrow-down",e,t+i,()=>{this.setTrackingState(!1),this.#im.setVelocity(0,r)},()=>this.#im.setTrackingMethod(rU.OFF)),this.#ix("hud-arrow-left",e-i,t,()=>{this.setTrackingState(!1),this.#im.setVelocity(-r,0)},()=>this.#im.setTrackingMethod(rU.OFF))}#ix(e,t,i,r,a){let n=new eE({prefix:e,startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:eg.STOP}),s=aO.addMomentaryButton(n,r,a);s.position.x=t,s.position.y=i,n.setCurrentIndex(0)}}class rW{intro;hero;enemies;artefacts;mapDesign;objective;constructor(){this.hero=null,this.enemies=[],this.artefacts=[],this.mapDesign=[]}}function rK(e){return e?rV(o).then(()=>e.load().then(()=>e.initialise()).then(()=>{l=new r$(n,48,rF.BR,rF.BL),aO.setVisible(!0),o=e})).then(()=>e):(m.error("Attempt made to switch to the next scene when there are no more."),Promise.reject())}function rV(e){return e?e.unload().then(()=>(el.clearAll(),o=null,l=null,aO.clear(),aO.setVisible(!1),Promise.resolve())):Promise.resolve(null)}function rY(){return new rG(s.getNext())}var rX={areThereMoreScenes:function(){return s.hasNext()},continueFromSavedScene:function(e,t){return s.restore(e,t),rK(rY())},getCurrentSceneLevel:function(){return s.getIndex()},getCurrentSceneIntro:function(){return s.intro},panCameraBy:function(e,t){n.panBy(e,t),n.setTrackingMethod(rU.OFF),l.setTrackingState(!1)},setCameraToTrack:function(e,t,i){n=new rH(e,t,i)},setSceneList:function(e){(s=e).reset()},switchToFirstScene:function(){return s.reset(),rK(rY())},switchToNextScene:function(){return rK(rY())},unloadCurrentScene:function(){return rV(o)},update:function(e){o?.update(e),n?.update(e)}};const rq={VIEW:0,SELL:1,PILLAGE:2,FIND:3},rj={CONTINUE:"continue",CONSUME:"consume",LEAVE:"leave",LEARN_SPELL:"learn",DISCARD:"discard",EQUIP:"equip",PREPARE_SPELL:"prepare",STASH:"stash",TAKE:"take",SELL:"sell",PILLAGE:"pillage",USE:"use"},rZ={STANDARD:"standard",STASH_ONLY:"stash",SPELLS:"spells",MAGIC:"magic",READY_MAGIC:"ready magic",CANTRIPS:"cantrips"};class rJ{#iI;#iO;#iR;linkedInventory;#iC;constructor(e,t={}){this.#iI=e,this.#iO=t,this.#iR=ej("div",{className:"stores"}),this.refresh()}get element(){return this.#iR}get actionButtons(){return this.#iC}refresh(e){let t=!0;if(this.#iC=[],!e&&this.linkedInventory&&this.linkedInventory.refresh(!0),this.#iR.replaceChildren(),(!this.#iI.currentOwner.isHero()||this.#iI.currentOwner.alive)&&this.#iN().forEach(e=>{let i=this.#iI.currentOwner.storeManager.getStoreContents(e.storeType);if(i){t=!1;let r=this.#iP(e.label,e.storeType,i);this.#iR.appendChild(r)}}),t){let e;e=this.#iI.currentOwner.isHero()&&!this.#iI.currentOwner.alive?eJ`MESSAGE DEAD HERO HAS NO INVENTORY`:eJ`MESSAGE NOTHING HERE`,this.#iR.appendChild(ej("p",{text:e}))}this.#iO.onRefresh&&this.#iO.onRefresh()}#iN(){let e;switch(this.#iO.limitation){case rZ.SPELLS:e=[{label:eJ`Prepared spells`,storeType:tz.PREPARED_SPELLS},{label:eJ`Known spells`,storeType:tz.SPELLS}];break;case rZ.MAGIC:e=[{label:eJ`Cantrips`,storeType:tz.CANTRIPS},{label:eJ`Prepared spells`,storeType:tz.PREPARED_SPELLS},{label:eJ`Known spells`,storeType:tz.SPELLS}];break;case rZ.READY_MAGIC:e=[{label:eJ`Ready magic`,storeType:tz.PREPARED_SPELLS},{label:eJ`Cantrips`,storeType:tz.CANTRIPS}];break;case rZ.CANTRIPS:tz.CANTRIPS;break;case rZ.STASH_ONLY:e=[this.#iv()];break;case rZ.STANDARD:default:e=[{label:eJ`Purse`,storeType:tz.PURSE},{label:eJ`Head`,storeType:tz.HEAD},{label:eJ`Body`,storeType:tz.BODY},{label:eJ`Hands`,storeType:tz.HANDS},{label:eJ`Feet`,storeType:tz.FEET},this.#iv()]}return e}#iv(){return this.#iI.currentOwner.isTrader()?{label:eJ`Wagon`,storeType:tz.WAGON}:{label:eJ`Backpack`,storeType:tz.BACKPACK}}#iP(e,t,i){let r=ej("div",{className:"store"});r.appendChild(ej("span",{className:"store-label",text:e}));let a=ej("div",{className:"store-contents"});return r.appendChild(a),[...i].sort((e,t)=>e.id<t.id).forEach(e=>{let i={...this.#iI};i.refresh=this.refresh.bind(this),i.storeType=t,i.artefact=e;let r=this.#iL(i);null!==r.closes&&void 0!==r.closes&&this.#iC.push(r),a.appendChild(r.element)}),r}#iL(e){let t,i;let r=function(e){let t=e.artefact.traits,i=t.get("NAME");if(e.showDamage){let r,a,n;if(t.has("HP_GAIN")?(a="HP: +",r=t.getHpGainDiceWhenCastBy?t.getHpGainDiceWhenCastBy(e.currentOwner.traits):t.get("HP_GAIN")):(a="DMG: ",r=t.getDamageDiceWhenCastBy?t.getDamageDiceWhenCastBy(e.currentOwner.traits):t.get("DMG")),r&&(i=`${i} ${a}${r}`),"BLESS"===t.get("MODE"))n=eJ`ACTS ON CASTER`;else{let e=t.get("RANGE");e&&(n=eJ`Range: ${e}`)}i=`${i} ${n}`}if(e.showPrice||e.artefact.artefactType===tk.COINS){let t=e.currentOwner.isTrader()?e.artefact.costInGp:e.artefact.sellBackPriceInGp;i=`${i} ${t.toFixed(2)} GP`}return i}(e);return e.customAction?(t=()=>e.customAction(e.currentOwner,e.artefact),i=e0.OK):t=async()=>{await r7(e).then(()=>e.refresh?.())},new eK({rightLabel:r,imageName:e.artefact.iconImageName,action:t,closes:i})}}function rQ(e,t,i){i>t.length&&m.error("Attempt being made to discard more items than provided in array.");for(let r=0;r<i&&r<t.length;r++)e.take(t[r])||m.error(`Trying to take artefact ${t[r]}, but none found.`)}function r4(e,t={}){let i=ej("div",{className:"inventory"}),r=ej("div",{className:"actor-container"});i.appendChild(r),r.appendChild(r5(e,{hideDescription:!0,hideTraits:!0}));let a=new rJ({currentOwner:e,prospectiveOwner:e,allowMagicUse:t.allowMagicUse,allowConsumption:t.allowConsumption},{limitation:t.limitation,onRefresh:()=>r.replaceChildren(r5(e,{hideDescription:!0,hideTraits:!0}))});return i.appendChild(a.element),e5.showControlsDialog(i)}function r0(e,t){if(t.artefact.artefactType===tk.COINS)return;let i=[];switch(t.artefact.artefactType){case tk.SPELL:i=function(e){let t=[],i=e.artefact;return e.allowMagicUse?m.error("Unexpected creation of Spell buttons with magic allowed. Use of Spells is handled by custom actions."):e.storeType===i.stashStoreType&&e.allowSpellPrep&&t.push(new eW({label:eJ`BUTTON PREPARE SPELL`,closes:rj.PREPARE_SPELL})),e.allowSpellPrep&&t.push(new eW({label:eJ`BUTTON FORGET`,closes:rj.DISCARD})),t}(t);break;case tk.CANTRIP:i=function(e){let t=[];return e.allowMagicUse&&m.error("Unexpected creation of Cantrip buttons with magic allowed. Use of Cantrips is handled by custom actions."),t.push(new eW({label:eJ`Forget`,closes:rj.DISCARD})),t}(t);break;case tk.CONSUMABLE:i=function(e){let t=[];return r1(e)&&t.push(new eW({label:r8(e.artefact),closes:rj.CONSUME})),t.push(new eW({label:eJ`BUTTON DISCARD`,closes:rj.DISCARD})),t}(t);break;case tk.KEY:i=[];break;default:i=function(e){let t=[];return r1(e)?t.push(new eW({label:r8(e.artefact),closes:rj.USE})):e.storeType===e.artefact.stashStoreType&&e.artefact.equipStoreType?t.push(new eW({label:eJ`BUTTON EQUIP`,closes:rj.EQUIP})):e.storeType===e.artefact.equipStoreType&&(!e.artefact.stashInWagon||e.currentOwner.storeManager.hasWagon)&&t.push(new eW({label:eJ`BUTTON STASH`,closes:rj.STASH})),t.push(new eW({label:e.artefact.isMagic()?eJ`Forget`:eJ`BUTTON DISCARD`,closes:rj.DISCARD})),t}(t)}return i.push(new eW({label:eJ`BUTTON CONTINUE`,closes:rj.CONTINUE})),i}function r1(e){let t=e.artefact;return!!t.isUsable()&&(t.isMagic()?e.allowMagicUse:t.isConsumable()?e.allowConsumption:void 0)}function r8(e){switch(e.artefactType){case tk.CONSUMABLE:return eJ`BUTTON CONSUME`;case tk.SPELL:case tk.CANTRIP:return eJ`BUTTON CAST SPELL`;default:return eJ`BUTTON USE`}}function r3(e){return ej("p",{className:"guidance",text:e.prospectiveOwner.isTrader()?eJ`MESSAGE TRADER CANNOT STASH`:e.artefact.stashInWagon?eJ`MESSAGE MAKE SPACE IN EQUIP`:eJ`MESSAGE MAKE SPACE IN BACKPACK`})}function r2(e){let t=ej("div",{className:"actor-id-card"});t.appendChild(eV(e.iconImageName)),t.appendChild(ej("span",{text:e.traits?.get("NAME")??eJ`Unknown`}));let i=e.traits.getInt("HP");if(!e.artefactType&&i&&!e.traits.get("_HP")){let r;let a=e.traits.getInt("HP_MAX");r=0===i?eJ`(DEAD)`:a?eJ`(HP OUT OF VALUE) ${i} ${a}`:eJ`(HP VALUE) ${i}`,t.appendChild(ej("span",{text:r}))}return e.traits.getCharacterLevel&&t.appendChild(ej("span",{text:eJ`CHARACTER LEVEL: ${e.traits.getCharacterLevel()}`})),t}function r5(e,t={}){let i;let r=ej("div",{className:"actor-detail"}),a=r2(e);return r.appendChild(a),!t.hideDescription&&(e.artefactType||e.alive?t.description?i=t.description instanceof Element?t.description:ej("p",{text:t.description}):e.description&&(i=ej("p",{text:e.unknown&&e.unknownDescription?e.unknownDescription:e.description})):i=function(e){let t;if(e.isHero()){let i=e.traits.get("NAME");t=eJ`MESSAGE HERO EPITAPH FOR ${i}`}else t=eJ`MESSAGE GENERIC EPITAPH`;return ej("p",{text:t})}(e)),i&&r.appendChild(i),t.hideTraits||r.appendChild(function(e,t,i){let r=document.createElement("ul");if(i){let t=e.storeManager?.getPurseValue();t&&r.appendChild(ej("li",{text:`${t.toFixed(2)}\u{00A0}GP`}))}return e.traits?.getAllTraitsSorted().forEach((i,a)=>{if(e.traits.hasEffective?.(a)){let t=e.traits.getEffectiveInt(a),r=O(i);if(t!==r){let e=t-r;i=`${t} [${r}${e<0?"-":"+"}${e}]`}}if(i&&"0"!==i){let e=Array.isArray(i)?i.join(", "):i;if(!t.includes(a)&&!a.startsWith("_")){let t=a?.replace("_"," "),i=document.createElement("li"),n=ej("span",{text:`${t}: `}),s=ej("span",{text:e});r.appendChild(i),i.appendChild(n),i.appendChild(s)}}}),r}(e,["NAME"],!0)),r}function r6(e,t,i){let r=ej("div",{className:"trade"}),a=ej("div",{className:"side-by-side"});r.appendChild(a);let n=ej("div",{}),s=ej("div",{});a.appendChild(n),a.appendChild(s),n.appendChild(r2(e)),s.appendChild(r2(t));let o=i?rq.PILLAGE:rq.SELL,l=new rJ({currentOwner:e,prospectiveOwner:t,actionType:o,showPrice:!0}),h=new rJ({currentOwner:t,prospectiveOwner:e,actionType:o,showPrice:!0},{limitation:i?rZ.STANDARD:rZ.STASH_ONLY});l.linkedInventory=h,h.linkedInventory=l,n.appendChild(l.element),s.appendChild(h.element);let c=new eW({label:eJ`BUTTON CONTINUE`});c.closes=e0.CANCEL;let u=[];return u.push(c),e5.showControlsDialog(r,{preamble:i?eJ`DIALOG TITLE PILLAGE`:eJ`DIALOG TITLE TRADE`,actionButtons:u})}function r9(e,t={}){let i,r;let a=document.createElement("div");a.appendChild(ej("span",{text:eJ`Dungeon floor: ${ip(rX.getCurrentSceneLevel())}`}));let n=ej("div",{className:"actor-container"});a.appendChild(n);let s=r5(e,{hideTraits:!0,description:t.description});return n.appendChild(s),!e.isProp()&&(i=new eW({label:eJ`BUTTON INVENTORY`,action:()=>r4(e,{allowConsumption:t.allowConsumption,allowMagicUse:t.allowMagicUse}).then(()=>n.replaceChildren(r5(e,{hideTraits:!0,description:t.description})))}),a.appendChild(i.element),i=new eW({label:eJ`BUTTON TRAITS`,action:()=>(function(e){let t=document.createElement("div");return t.appendChild(r5(e,{hideDescription:!0})),e5.showControlsDialog(t)})(e)}),a.appendChild(i.element),i=new eW({label:eJ`BUTTON MAGIC`,action:()=>r4(e,{allowMagicUse:!1,limitation:rZ.MAGIC})}),a.appendChild(i.element),t.allowRest&&(i=new eW({label:eJ`BUTTON REST`,action:()=>(function(e){let t=e.storeManager.getStore(tz.BACKPACK),i=[],r=[];t.values().forEach(e=>{if(e.artefactType===tk.CONSUMABLE){let t=e.traits.get("TYPE");"MEAL"===t?i.push(e):"DRINK"===t&&r.push(e)}});let a=document.createElement("div");a.appendChild(r2(e)),a.appendChild(ej("p",{text:eJ`MESSAGE EXPLAIN REST`}));let n=[],s=-1,o=-1,l=function(e,t,i){let r={possible:!0,failure:tE.NONE},a={possible:!0,failure:tE.NONE},n=i.get("HIT_DICE","0D6");return!n||1>tn(n)?(r.possible=!1,r.failure=tE.NEED_LONG_REST):(e<1||t<1)&&(r.possible=!1,r.failure=tE.NEED_MORE_RATIONS),(e<3||t<3)&&(a.possible=!1,a.failure=tE.NEED_MORE_RATIONS),{shortRest:r,longRest:a}}(i.length,r.length,e.traits),h="";return l.shortRest.possible||(h=l.shortRest.failure===tE.NEED_LONG_REST?eJ`MESSAGE CANNOT REST SHORT NEED LONG REST`:eJ`MESSAGE CANNOT REST SHORT NEED RATIONS`,a.appendChild(ej("p",{text:h}))),l.longRest.possible||(h=eJ`MESSAGE CANNOT REST LONG NEED RATIONS`,a.appendChild(ej("p",{text:h}))),l.shortRest.possible&&(s=n.length,n.push(eJ`BUTTON REST SHORT`)),l.longRest.possible&&(o=n.length,n.push(eJ`BUTTON REST LONG`)),n.push(eJ`BUTTON CONTINUE`),e5.showChoiceDialog(eJ`DIALOG TITLE CHOICES`,a,n).then(a=>{if(a===s){rQ(t,i,1),rQ(t,r,1);let a=tT(e,"SHORT");return e5.showOkDialog(eJ`MESSAGE REST SHORT HP GAIN ${a.newHp-a.oldHp}`)}if(a===o){rQ(t,i,3),rQ(t,r,3);let a=tT(e,"LONG");return(function(e){let t=ej("div",{className:"inventory"});t.appendChild(r5(e,{hideDescription:!0,hideTraits:!0}));let i=new rJ({currentOwner:e,prospectiveOwner:e,allowSpellPrep:!0},{limitation:rZ.SPELLS});return t.appendChild(i.element),e5.showControlsDialog(t,{title:eJ`DIALOG TITLE PREPARE SPELLS`,preamble:eJ`MESSAGE EXPLAIN SPELL PREP`})})(e).then(()=>e5.showOkDialog(`MESSAGE REST LONG HP GAIN ${a.newHp-a.oldHp}`))}})})(e).then(()=>s.replaceWith(r5(e,{hideTraits:!0})))}),a.appendChild(i.element)),t.allowMagicUse&&(r=r??[],(i=new eW({label:eJ`BUTTON CAST SPELL`})).closes="CAST SPELL",r.push(i))),r&&((i=new eW({label:eJ`BUTTON CONTINUE`})).closes=e0.CANCEL,r.push(i)),e5.showControlsDialog(a,{okButtonLabel:t.okButtonLabel,actionButtons:r}).then(t=>"CAST SPELL"===t?function(e){let t=ej("div",{className:"inventory"}),i=new rJ({currentOwner:e,prospectiveOwner:e,allowMagicUse:!0,showDamage:!0,customAction:(e,t)=>(e4.setAnimationState(!0),new Promise(i=>{setTimeout(()=>{t.interaction.react(e).then(()=>i())})}))},{limitation:rZ.READY_MAGIC});t.appendChild(i.element);let r=new eW({label:eJ`BUTTON CONTINUE`,closes:e0.CANCEL});return e5.showControlsDialog(t,{title:eJ`DIALOG TITLE PICK SPELL TO CAST`,actionButtons:[...i.actionButtons,r]})}(e):Promise.resolve())}function r7(e){var t;e.prospectiveOwner||(e.prospectiveOwner=e.currentOwner);let i=e.currentOwner?.storeManager,r=e.prospectiveOwner.storeManager,a=e.artefact,n=e.hideTraits;return(e.artefact?.unknown?ty((e.prospectiveOwner??e.currentOwner).traits,{ability:"WIS",difficulty:(t=e.artefact.traits).get("IDENTIFY_DC",tg.EASY),proficiency:t.get("SUBTYPE")})?(e.artefact.unknown=!1,Promise.resolve(!0)):e5.showChoiceDialog(eJ`DIALOG TITLE UNKNOWN ITEM`,eJ`MESSAGE FAILED TO IDENTIFY`).then(()=>!1):Promise.resolve(!0)).then(t=>(t||(e.hideTraits=!0),function(e){let t=e.artefact,i=ej("div",{className:"use-weapon-dialog"});i.appendChild(r5(t,e));let r=function(e,t){if(t.currentOwner===t.prospectiveOwner||!t.prospectiveOwner)return r0(e,t);switch(t.actionType){case rq.FIND:return function(e,t){let i;let r=[],a=t.prospectiveOwner.storeManager.findSuitableStore(t.artefact);if(a){let e,t;a.storeType===tz.CANTRIPS||a.storeType===tz.SPELLS||a.storeType===tz.READY_SPELLS?(e=eJ`BUTTON LEARN SPELL`,t=rj.LEARN_SPELL):(e=eJ`BUTTON TAKE ARTEFACT`,t=rj.TAKE),i=new eW({label:e,closes:t}),r.push(i)}else e.appendChild(r3(t));return i=new eW({label:eJ`BUTTON LEAVE ARTEFACT`,closes:rj.LEAVE}),r.push(i),r}(e,t);case rq.SELL:return function(e,t){let i;if(t.artefact.artefactType===tk.COINS)return;let r=[],a=t.artefact.costInGp;if((i=t.prospectiveOwner.isTrader()?Number.MAX_SAFE_INTEGER:t.prospectiveOwner.storeManager.getPurseValue())<t.artefact.costInGp){e.appendChild(ej("p",{className:"guidance",text:eJ`MESSAGE INSUFFICIENT FUNDS ${a} ${i}`})),t.currentOwner.isTrader()||r0(e,t);return}if(!t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)){e.appendChild(r3(t)),t.currentOwner.isTrader()||r0(e,t);return}let n=new eW({label:t.currentOwner.isTrader()?eJ`BUTTON BUY FOR GP ${t.artefact.costInGp.toFixed(2)}`:eJ`BUTTON SELL FOR GP ${t.artefact.sellBackPriceInGp.toFixed(2)}`,closes:rj.SELL});return r.push(n),r.push(n=new eW({label:eJ`BUTTON CONTINUE`,closes:rj.CONTINUE})),r}(e,t);case rq.PILLAGE:return function(e,t){if(t.currentOwner.alive)return r0(e,t);let i=[];if(!t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)){e.appendChild(r3(t)),t.currentOwner.alive&&r0(e,t);return}let r=new eW({label:eJ`BUTTON PILLAGE`,closes:rj.PILLAGE});return i.push(r),i.push(r=new eW({label:eJ`BUTTON LEAVE ARTEFACT`,closes:rj.CONTINUE})),i}(e,t);case rq.VIEW:default:return[]}}(i,e);return e5.showControlsDialog(i,{preamble:e.preamble,actionButtons:r,row:!0})}(e))).then(t=>{switch(e.hideTraits=n,t){case rj.CONSUME:return i.discard(a),a.interaction.react(e.currentOwner);case rj.DISCARD:i.discard(a);break;case rj.PREPARE_SPELL:case rj.EQUIP:r.equip(a);break;case rj.LEARN_SPELL:if(a.isMagic()&&r.hasArtefactWithSameId(a))return e5.showOkDialog(eJ`MESSAGE SPELL ALREADY KNOWN`);if(i.discard(a),r.findSuitableStore(a).add(a),a.artefactType===tk.SPELL)return e5.showOkDialog(eJ`MESSAGE EXPLAIN SPELL NEEDS REST`);break;case rj.PILLAGE:i.discard(a),r.findSuitableStore(a).add(a);break;case rj.SELL:{let t=e.currentOwner.isTrader()?a.costInGp:a.sellBackPriceInGp;i.addToPurse(t),e.prospectiveOwner.isTrader()||r.takeFromPurse(t),i.discard(a),a.stashInWagon&&!r.hasWagon?r.equip(a,{direct:!0}):r.stash(a,{direct:!0})}break;case rj.STASH:r.stash(a)||e5.showOkDialog(e.prospectiveOwner.isTrader()?eJ`MESSAGE TRADER CANNOT STASH`:eJ`MESSAGE CANNOT STASH`);break;case rj.TAKE:i?.discard(a),a.stashInWagon&&!r.hasWagon?r.equip(a,{direct:!0}):r.stash(a,{direct:!0});break;case rj.USE:return a.interaction.react(e.currentOwner)}return Promise.resolve()})}function ae(e){let t=ej("div");return t.appendChild(ej("p",{text:eJ`MESSAGE REST DIALOG`})),r9(e,{allowConsumption:!0,allowRest:!0,description:t,okButtonLabel:eJ`BUTTON TO NEXT FLOOR`})}const at={SETBACK:{dc:11,bonus:4,damage:["1D10","2D10","4D10","10D10"]},DANGEROUS:{dc:14,bonus:7,damage:["2D10","4D10","10D10","18D10"]},DEADLY:{dc:18,bonus:11,damage:["4D10","10D10","18D10","24D10"]}};function ai(e,t){let i=document.createElement("div"),r=document.createElement("p");r.innerText=e,i.appendChild(r);let a=document.createElement("p");return a.innerText=t,i.appendChild(a),i}function ar(e,t,i){if(e6.playEffect("POISONED"),i>0)return m.debug("Poison applied"),ek(ep.getSpriteBitmap("skull.png"),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new N(0,0,0)}),aa(e,t,i);ek(ep.getSpriteBitmap("miss.png"),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new N(0,0,0)}),m.debug("Poison resisted.")}function aa(e,t,i){if(!i||!t.alive||t.isProp()||t.isHiddenArtefact())return 0;let r=t.traits.get("HP",0);if(r=Math.max(0,r-i),t.traits.set("HP",r),0===r){if(e6.playEffect(t.traits.get("SOUND","DIE")),m.info("Killed actor."),t.interaction=new ao(t),t.alive=!1,e?.isHero?.()){let i;let r=e.traits.adjustForDefeatOfActor(t.traits);r.level.now>r.level.was?i=eJ`LEVEL UP ${r.level.now}`:r.exp.now>r.exp.was&&(i=`+${r.exp.now-r.exp.was} EXP`),i&&eG(i,e.position,t1.HP_TRANSIENT_TEXT_HERO)}}else{let e=t.isHero()?t1.HP_TRANSIENT_TEXT_HERO:t1.HP_TRANSIENT_TEXT_ENEMY;eG(`-${i} HP`,t.position,e)}return r}class an{owner;constructor(e){this.owner=e}enact(e){return Promise.resolve()}react(e){return Promise.resolve()}canReact(){return!1}canEnact(){return!1}respectDisengage(e){return!1}}class as extends an{constructor(e){super(e)}canEnact(){return!0}canReact(){return!0}enact(e){return this.#iD(this.owner,e)}react(e){return this.#iD(e,this.owner)}respectDisengage(e){return!0}#iM(e,t){let i=C.copy(e.position);return new eb({path:[new C(e.position.x+.2*(t.position.x-e.position.x),e.position.y+.2*(t.position.y-e.position.y)),i],speed:100}).applyAsTransientToSprite(e.sprite)}#ib(e,t){if(!e.isHero()){if(e.attackMode===aw.POISON)return new ac(e).enact(t);if(e.attackMode===aw.MAGIC)return new ad(e).react(e);let i=e.storeManager,r=i.getStore(tz.PREPARED_SPELLS).getFirst();if(r||(r=i.getStore(tz.CANTRIPS).getFirst()),r)return r.interaction.react(e)}return this.#i_(e,t)}#i_(e,t){let i=0,r=0;return e.traits.getAttacks().forEach(e=>{let a=tS(e,t.traits);a>0&&(r++,i+=a)}),new Promise(a=>{if(i<=0){e6.playEffect("MISS"),ek(ep.getSpriteBitmap("miss.png"),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new N(0,0,0)}),a();return}let n=r>1?"DOUBLE PUNCH":"PUNCH",s=r>1?"blood-splat-twice.png":"blood-splat.png";e6.playEffect(n),ek(ep.getSpriteBitmap(s),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new N(0,0,0)}),a(aa(e,t,i))})}#iD(e,t){return m.info(`${e.traits?.get("NAME")} attacks ${t.traits.get("NAME")}`),this.#iM(e,t).then(()=>this.#ib(e,t))}}class ao extends an{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){return r6(e,this.owner,!0)}}class al extends an{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}react(e){return this.owner.traits.get("NO_TRADE")?e5.showOkDialog([eJ`MESSAGE TRADER WILL NOT TRADE`,eJ`MESSAGE TRADERS PROTECTED`]):e5.showChoiceDialog(eJ`DIALOG TITLE CHOICES`,eJ`MESSAGE TRADE STEAL OR BARGE`,[eJ`BUTTON TRADE`,eJ`BUTTON STEAL`,eJ`BUTTON BARGE`]).then(t=>0===t?r6(e,this.owner,!1):1===t?this.#iz(e):this.#ik(e))}#iz(e){if(!ty(e.traits,{ability:"DEX",difficulty:this.owner.traits.getInt("DC",tg.HARD),proficiency:"STEALING"}))return this.owner.traits.set("_NO_TRADE",!0),e5.showOkDialog(eJ`MESSAGE TRADER ATTACKS BACK`).then(()=>new as(this.owner).enact(e));{let t=I(1,this.owner.traits.getInt("MAX_THEFT",1));return e.storeManager.addToPurse(t),e5.showOkDialog(eJ`MESSAGE STOLE GOLD ${t}`)}}#ik(e){let t=C.copy(this.owner.position),i=C.copy(e.position);return Promise.all([e_(e,t),e_(this.owner,i)])}}class ah extends an{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){this.owner.alive=!1;let t=this.owner.storeManager.getFirstStorageDetails();if(!t)return e5.showOkDialog(eJ`MESSAGE NOTHING MORE TO DISCOVER`);{let i=t.artefact;if(i.isTrap()){let t=await i.interaction.react(e);if(t.outcome===af.LEAVE)return this.owner.alive=!0,Promise.resolve();if(this.owner.storeManager.discardStashed(i,!0),!t.artefact)return Promise.resolve();i=t.artefact,this.owner.storeManager.stash(i,{direct:!0})}else if(i.isMagic()&&!function(e,t){let i=e.getCharacterLevel(),r=t.getInt("LEVEL",0);if(r>1+8*(i-1)/16)return m.info(`${e.get("NAME")} cannot learn level ${r} ${t.get("NAME")} as too high.`),!1;let a=t.get("CASTERS");if(!a)return m.info(`No casters set for ${t.get("NAME")} so can be learned.`),!0;let n=e.get("CLASS");return!!a.includes(n)||(m.info(`${e.get("NAME")} cannot learn ${t.get("NAME")} as not in casters.`),!1)}(e.traits,i.traits))return e5.showOkDialog(eJ`MESSAGE CANNOT UNDERSTAND MAGIC`);return r7({preamble:this.#iB(i),currentOwner:this.owner,prospectiveOwner:e,storeType:t.store.storeType,artefact:i,actionType:rq.FIND,hideTraits:i.isMagic()})}}#iB(e){return this.owner.type===aS.HIDDEN_ARTEFACT?eJ`MESSAGE FOUND HIDDEN ARTEFACT`:e.isMagic()?eJ`MESSAGE FOUND ENGRAVING`:eJ`MESSAGE FOUND GENERIC`}}class ac extends an{constructor(e){super(e)}canEnact(){return!0}canReact(){return!1}enact(e){let t=tw(this.owner.traits,e.traits);return ar(this.owner,e,t),t&&e.toxify?.addToxicEffect(this.owner.traits),e.traits.addTransientFxTraits(this.owner.traits),Promise.resolve()}}class au extends an{#iG;constructor(e){super(null),this.#iG=e??new id}canEnact(){return!0}canReact(){return!1}enact(e){if(this.#iG.isActive)return ar(null,e,-this.#iG.getChangeInHpThisTurn()),Promise.resolve()}addToxicEffect(e){let t=-e.getFloat("DMG_PER_TURN",0);t&&(m.debug(`Add toxic effect of ${t} HP/turn`),this.#iG.addToxicEffect(t))}cure(){this.#iG.cure()}get isActive(){return this.#iG.isActive}getToxin(){return this.#iG}}class ad extends an{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){if("BLESS"===this.owner.traits.get("MODE"))return this.#iU(e);let t=el.getTileMap(),i=t.worldPointToGrid(e.position),r=this.owner.traits.getValueInFeetInTiles("RANGE",1),a=this.owner.traits.getInt("MAX_TARGETS",999),n=0;for(let h of t.getRadiatingUpAndDown(i,r)){if(n>=a)break;for(let t of[...h.getOccupants().values()].sort((e,t)=>t.traits.getInt("HP")-e.traits.getInt("HP")))if(this.#iH(e,t)){var s,o,l;let i=(s=e.traits,o=t.traits,"MELEE"===(l=this.owner.traits).get("MODE")?function(e,t,i){let r=e.get("SPELL_CAST","INT"),a=e.getInt(r,1);return tS(new tI({damageDice:i.getDamageDiceWhenCastBy?i.getDamageDiceWhenCastBy(e):i.get("DMG","1D4"),weaponType:"UNARMED",proficiencyBonus:e.getCharacterPb(i),abilityModifier:tx(a)}),t)}(s,o,l):function(e,t,i){let r=e.get("SPELL_CAST","INT"),a=e.getInt(r,1),n=t.getNonMeleeSaveAbilityModifier(i),s=i.getInt("DC");null==s&&(m.error(`Magic ${e.get("NAME")} has no DC set.`),s=0);let o=s+(e.getCharacterPb(i)+tx(a)),l=ti(20)+n,h=ta(i.getDamageDiceWhenCastBy?i.getDamageDiceWhenCastBy(e):i.get("DMG","1D4"));return l>=o?Math.round(i.getFloat("DMG_SAVED",0)*h):h}(s,o,l));i>0&&(n++,this.#iF(h.worldPoint),aa(e,t,i),t.traits.addTransientFxTraits(this.owner.traits))}}return 0===n&&this.#i$(e.position),this.owner.artefactType===tk.SPELL&&function(e,t){let i=Math.round(1+5*(t.getInt("LEVEL",1)-1)/8),r=function(e){let t=e.getInt("CASTING_POWER");return e.has("CASTING_POWER")?t:tm(e)}(e);e.set("CASTING_POWER",Math.max(0,r-i))}(this.enactor.traits,this.owner.traits),Promise.resolve()}#iU(e){if(!e.isHero())return;if(!function(e,t,i){let r=i.getInt("MAX_TARGET_HP",1),a=t.getInt("HP");return a>r?(m.info(`Targets's HP (${a}) is above max target hp of ${r}. Spell failed.`),!1):a<=r}(e.traits,e.traits,this.owner.traits)){this.#i$(e.position);return}let t=function(e,t,i){if(!i.has("HP_GAIN"))return 0;let r=ta(i.getHpGainDiceWhenCastBy?i.getHpGainDiceWhenCastBy(e):i.get("HP_GAIN",0)),a=t.getInt("HP");return Math.min(r,t.getInt("HP_MAX")-a)}(e.traits,e.traits,this.owner.traits);return this.#iF(e.position),t>0&&(e.traits.addInt("HP",t),eG(`+${t}HP`,e.position,t1.HP_TRANSIENT_TEXT_HERO)),Promise.resolve()}#iH(e,t){return e.isHero()?t.isEnemy()&&t.alive:t.isHero()&&t.alive}#iF(e){!function(e,t){let i=new eE({prefix:e,suffix:".png",startIndex:0,padding:2},{framePeriodMs:300,loopMethod:eg.REVERSE});ez(new eR(Q.getContext2D(),i),t)}(this.owner.traits.get("EFFECT").toLowerCase(),{position:e,delaySecs:0,lifetimeSecs:1})}#i$(e){ek(ep.getSpriteBitmap("failed-spell.png"),{position:e,delaySecs:0,lifetimeSecs:1})}}class ap extends an{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){let t=this.owner.traits.get("TYPE");if("POISON"===t){let t=tw(this.owner.traits,e.traits);return 0===t?e5.showOkDialog(eJ`MESSAGE RESISTED POISON`):0>=ar(this.owner,e,t)?e5.showOkDialog(eJ`MESSAGE KILLED BY POISON`):e5.showOkDialog(eJ`MESSAGE IT'S POISON ${t}`)}{let i=function(e,t){let i=e.getInt("HP",0),r=t.getInt("HP",0),a=t.getInt("HP_MAX",r)-r;return{shortFall:a,oldHp:r,newHp:r+(a<0?0:Math.min(a,i))}}(this.owner.traits,e.traits),r=i.newHp-i.oldHp;if(i.shortFall<=0)return e5.showOkDialog(eJ`MESSAGE CONSUME BUT ALREADY FULL HP`);if(0===r)return e5.showOkDialog(eJ`MESSAGE CONSUME BUT NO HP GAIN`);let a="MEDICINE"===t?eJ`MESSAGE IT'S A HEALTHY DRINK ${r}`:eJ`MESSAGE IT'S HEALTHY ${r}`;return e5.showOkDialog(a).then(()=>e.traits.set("HP",i.newHp))}}}const af={ATTEMPT_DISABLE:"attempt disable",LEAVE:"leave",DISABLED:"disabled",TRIGGERED:"triggered"};class am extends an{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){let t,i=null,r=function(e,t){let i;let r=at[t.get("SEVERITY","SETBACK")]??at.SETBACK;return i=e<5?r.damage[0]:e<11?r.damage[1]:e<17?r.damage[2]:r.damage[3],{difficulty:r.dc,attack:new tI({damageDice:i,weaponType:"TRAP",proficiencyBonus:0,abilityModifier:r.bonus}),detectBy:t.get("DETECT_BY","WIS"),disableBy:t.get("DISABLE_BY","INT"),reward:t.get("REWARD")}}(e.traits.getCharacterLevel(),this.owner.traits),a=await this.#iW(e.traits,r);switch(a){case af.TRIGGERED:return m.info("Trigger the trap."),(0===(t=tS(r.attack,e.traits))?function(e,t,i){return e5.showElementOkDialog(eJ`DIALOG TITLE TRAP TRIGGERED SURVIVED`,ai(i,eJ`MESSAGE TRAP TRIGGERED SURVIVED`))}:function(e,t,i){return e5.showElementOkDialog(eJ`DIALOG TITLE TRAP TRIGGERED INJURED`,ai(i,eJ`MESSAGE TRAP TRIGGERED INJURED`))})(e,r,this.owner.description).then(()=>this.#iK(e,t)).then(()=>({outcome:a,artefact:i}));case af.DISABLED:return m.info("Disabled the trap."),i=function(e,t=["MONEY"]){let i=tb.findById(e,t);return i?t_(i):(m.error(`Could not find artefact ${e} in ${t} almanacs.`),null)}(r.reward),(this.owner.description,e5.showOkDialog(eJ`DIALOG TITLE TRAP DISABLED`,ai(eJ`MESSAGE TRAP DISABLED`))).then(()=>({outcome:a,artefact:i}));case af.LEAVE:return m.info("Left the trap."),Promise.resolve({outcome:a,artefact:i})}}#iK(e,t){return new Promise(i=>{e6.playEffect("TRIGGER TRAP"),t<=0?ek(ep.getSpriteBitmap("miss.png"),{delaySecs:1,lifetimeSecs:3,position:e.position,velocity:new N(0,0,0)}):(ek(ep.getSpriteBitmap("blood-splat.png"),{delaySecs:1,lifetimeSecs:3,position:e.position,velocity:new N(0,0,0)}),aa(this.owner,e,t)),i()})}#iW(e,t){return ty(e,{ability:t.detectBy,difficulty:t.difficulty,proficiency:"TRAPS"})?(this.owner.description,e5.showChoiceDialog(eJ`DIALOG TITLE TRAP DETECTED`,eJ`MESSAGE TRAP ATTEMPT DISABLE`,[eJ`BUTTON TRAP DISABLE`,eJ`BUTTON TRAP LEAVE`]).then(e=>0===e?af.ATTEMPT_DISABLE:af.LEAVE)).then(i=>i===af.LEAVE?i:ty(e,{ability:t.disableBy,difficulty:t.difficulty,proficiency:"TRAPS"})?af.DISABLED:af.TRIGGERED):Promise.resolve(af.TRIGGERED)}}class ag extends an{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){return this.#iV(e,this.owner)}#iV(e,t){let i=new eb({path:[t.position],speed:5});ek(ep.getSpriteBitmap("portal.png"),{delaySecs:0,lifetimeSecs:6,position:t.position,velocity:new N(0,0,3)}),new eP(0,3,new eL).applyAsTransientToSprite(e.sprite,20);let r=new eP(0,3,new eL);return i.applyAsTransientToSprite(e.sprite).then(()=>r.applyAsTransientToSprite(e.sprite))}}const aS={HERO:0,ENEMY:1,ARTEFACT:2,HIDDEN_ARTEFACT:3,TRADER:4,PROP:5,OBJECTIVE:6},aw={COMBAT:"COMBAT",POISON:"POISON",MAGIC:"MAGIC"},aE={WANDER:"WANDER",HUNT:"HUNT",ORGANIC:"ORGANIC"};class aT extends tJ{almanacEntry;#iY;sprite;traits;interaction;toxify;alive;disengaging;description;iconImageName;storeManager;type;adventureStartTime;constructor(e,t=aS.ENEMY){super(),this.interaction=new an,this.sprite=e,this.sprite.obstacle=!0,this.#iY=!1,this.alive=!0,this.disengaging=!1,this.type=t,this.storeManager=new tH(t===aS.TRADER||t===aS.HIDDEN_ARTEFACT,()=>this.#iX()),t===aS.HERO&&(this.adventureStartTime=new Date().getTime())}#iX(){let e=this.storeManager.getAllEquippedArtefacts(),t=e.filter(e=>e.artefactType===tk.WEAPON||e.artefactType===tk.TWO_HANDED_WEAPON),i=e.filter(e=>e.artefactType===tk.ARMOUR),r=e.filter(e=>e.artefactType===tk.SHIELD),a=e.filter(e=>e.isMagic());this.traits.utiliseAdditionalTraits({weapons:t.map(e=>e.traits),armour:i.map(e=>e.traits),shields:r.map(e=>e.traits),magic:a.map(e=>e.traits)})}freezeMovement(){this.#iY=!0}getMaxTilesPerMove(){return this.#iY?0:this.traits.getMaxTilesPerMove()}isHero(){return this.type===aS.HERO}isEnemy(){return this.type===aS.ENEMY}isTrader(){return this.type===aS.TRADER}isHiddenArtefact(){return this.type===aS.HIDDEN_ARTEFACT}set visible(e){this.sprite.visible=e}get visible(){return this.sprite.visible}get obstacle(){return this.sprite.obstacle}set obstacle(e){this.sprite.obstacle=e}get position(){return this.sprite.position}set position(e){this.sprite.position=e}get velocity(){return this.sprite.velocity}set velocity(e){this.sprite.velocity=e}getImageFilename(){return this.sprite.getImageFilename()}isWandering(){return this.traits?.get("MOVE")===aE.WANDER}isOrganic(){return this.traits?.get("MOVE")===aE.ORGANIC}isProp(){return this?.type===aS.PROP}isObjective(){return this?.type===aS.OBJECTIVE}get moveType(){return this?.traits.get("MOVE")}get attackMode(){return this?.traits.get("ATTACK",aw.COMBAT)}willInteract(){return!!this.interaction&&(!this.isWandering()||ti(6)>3)}isPassableByActor(e){return!!(e.isHero()&&this.isHiddenArtefact())||!this.alive&&!this.isProp()||!this.obstacle}canShareLocationWithActor(e){return this.isOrganic()?!e.isOrganic()&&!e.isTrader():this.isHiddenArtefact()?e.isHero():!!(!this.alive&&e.isHero())||!this.obstacle}update(e){this.sprite.update(e)}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionContextClick(this.sprite.position)}actionPointerUp(e){super.actionPointerUp(this.sprite.position)}actionPointerDown(e){super.actionPointerDown(this.sprite.position)}toJSON(){let e=this.storeManager.getAllStorageDetails(),t=[];for(let i of e)t.push({storeTypeId:i.store.storeTypeId,artefact:i.artefact});return{reviver:"Actor",data:{adventureStartTime:this.adventureStartTime,alive:this.alive,almanacEntry:this.almanacEntry,traits:this.traits,inventory:t,toxin:this?.toxify.getToxin()}}}static revive(e,t){let i=t(e.almanacEntry,e.traits);for(let t of(i.adventureStartTime=e.adventureStartTime,i.alive=e.alive,i.toxify=new au(e.toxin),e.inventory)){let e=i.storeManager.getStoreByTypeId(t.storeTypeId);if(!e){m.error(`Unable to find store matching ${t.storeTypeId}. Game restore abandoned.`);return}e.add(t.artefact)}return i}}const ay=new Map;let aA=!1;function ax(e,t){let i=Q.glassPositionToWorld(t.position),r=t.sprite.getBoundingBox();return new L(i.x-r.width/2,i.y-r.height/2,r.width,r.height).containsCoordinate(e.world.x,e.world.y)}function aI(e){if(!aA||!aA)return!1;for(let[t,i]of ay)if(ax(e,i))return i.actionPointerUp(i,e.canvas),!0;return!1}var aO={addButton:function(e,t,i){let r=new aT(new eC({renderer:new eR(Q.getContext2D(),e)}));return ay.set(r,r),r.setOnClick(()=>{i?0===e.getCurrentIndex()?(e.setCurrentIndex(1),t()):(e.setCurrentIndex(0),i()):t()}),e.setCurrentIndex(0),r},addMomentaryButton:function(e,t,i){let r=new aT(new eC({renderer:new eR(Q.getContext2D(),e)}));return ay.set(r,r),r.setOnPointerDown(()=>{e.setCurrentIndex(1),t?.()}),r.setOnPointerUp(()=>{e.setCurrentIndex(0),i?.()}),r},clear:function(){ay.clear()},removeButton:function(e){ay.delete(e)},update:function(e){aA&&ay.forEach(t=>{let i=v.copy(t.position);t.position=Q.glassPositionToWorld(t.position),t.update(e),t.position=i})},resolvePointerCancel:function(e){return aI(e)},resolveClick:function(e){if(!aA)return!1;for(let[t,i]of ay)if(ax(e,i))return i.actionClick(i,e.canvas),!0;return!1},resolveContextMenu:function(e){return!1},resolvePointerDown:function(e){if(!aA||!aA)return!1;for(let[t,i]of ay)if(ax(e,i))return i.actionPointerDown(i,e.canvas),!0;return!1},resolvePointerUp:aI,setVisible:function(e){aA=e}};const aR={GRINNING:"\uD83D\uDE00",SANTA:"\uD83C\uDF85",SHAKING:"\uD83E\uDEE8"};class aC{#iq;#ij;#iZ;#iJ;#iQ;constructor(e){this.#iq=I(e.minCols,e.maxCols),this.#ij=I(e.minRows,e.maxRows),this.#iZ=e.maxRoomCols,this.#iJ=e.maxRoomRows}#i4(e=1){let t="";for(;e-- >0;)t+=x(tW.WALL);return t}#i0(e=1){let t="";for(;e-- >0;)t+=x(tW.GROUND);return t}#i1(e=1){let t="";for(;e-- >0;)t+=x(tW.VOID);return t}#i8(e=1){let t="";for(;e-- >0;)t+=x(tW.DOOR_IN);return t}#i3(e=1){let t="";for(;e-- >0;)t+=x(tW.DOOR_OUT);return t}#i2(e){return tW.WALL.includes(e)}#i5(e){return tW.GROUND.includes(e)}#i6(e){return tW.VOID.includes(e)}#i9(e){return tW.DOOR_IN.includes(e)}#i7(e){return tW.DOOR_OUT.includes(e)}generate(){this.#iQ=[];let e=0,t=this.#iq;for(;this.#iQ.length<this.#ij-4;){let i=e+t-4-2,r=i>0?A(0,i):0,a=Math.max(e-r+4,4),n=Math.min(this.#iZ,this.#iq-r),s=n>a?A(a,n):a,o=this.#iq-r-s,l=A(4,Math.min(this.#iJ,this.#ij-this.#iQ.length));this.#re(r,s,o,l),e=r,t=s}return this.#rt(),this.#ri(),this.getMatrixAsStrings()}getMatrixAsStrings(){return this.#iQ.map(e=>e.join(""))}#re(e,t,i,r){let a="";a+=this.#i1(e)+this.#i4(t)+this.#i1(i),this.#iQ.push(a.split(""));for(let n=0;n<r-2;n++)a=""+this.#i1(e)+this.#i4(1)+this.#i0(t-2)+this.#i4(1)+this.#i1(i),this.#iQ.push(a.split(""));a=""+this.#i1(e)+this.#i4(t)+this.#i1(i),this.#iQ.push(a.split(""))}#rt(){for(let e=1;e<this.#iQ.length-1;e++)for(let t=1;t<this.#iQ[0].length-2;t++)this.#i2(this.#iQ[e][t])&&this.#i2(this.#iQ[e+1][t])&&this.#i5(this.#iQ[e-1][t])&&this.#i5(this.#iQ[e+2][t])&&(this.#iQ[e][t]=this.#i0(1),this.#iQ[e+1][t]=this.#i0(1))}#rr(e){return this.#i2(e.above)&&this.#i2(e.centre)&&this.#i2(e.below)}#ra(e){return this.#i2(e.left)&&this.#i2(e.centre)&&this.#i2(e.right)}#ri(){let e=[];this.#iQ.forEach((t,i)=>t.forEach((t,r)=>{let a=tF(this.#iQ,i,r);(this.#ra(a)||this.#rr(a))&&e.push({row:i,col:r})}));let t=t$(e),i=t[0];this.#iQ[i.row][i.col]=this.#i8(),i=t[1],this.#iQ[i.row][i.col]=this.#i3()}}const aN={MEDIUM:.25};class aP{#h;#ih;constructor(){this.reset()}getIndex(){return this.#h}getNext(){return this.#h++,0===this.#h&&(h=null),this.#rn(),this.#ih}hasNext(){return!0}reset(){this.#h=-1}restore(e,t){h=t,this.#h=e}#rn(){this.#ih=new rW,this.#rs(),this.#ro(),this.#rl(),this.#rh(),this.#rc(),this.#ru(),this.#rd()}#ro(){this.#ih.intro=eJ`MESSAGE ENTER FLOOR ${ip(this.#h)}`}#rs(){if(!h){let e=tb.getRandomEntry("HEROES");e||m.fatal(Error("Could not find hero in almanacs.")),h=iu(e)}this.#ih.hero=h}#rl(e=aN.MEDIUM){let t=function(e,t){let i=e*(h?.traits.getCharacterLevel()??1)+.001;return tb.getAlmanac("ENEMIES").filter(e=>e.challengeRating<=i&&e.minLevel<=t)}(e,this.#h),i=0,r=0;for(;i<e&&r<8;){let e=t.getRandomEntry();i+=e.challengeRating,r++,this.#ih.enemies.push(e)}}#rh(){for(let e=0;e<1;e++){let e=tb.getRandomEntry("TRADERS",e=>e.minLevel<=this.#h);this.#ih.enemies.push(e)}}#rc(){let e=tb.getPooledAlmanac(["ARTEFACTS","MAGIC","MONEY","WEAPONS","TRAPS","PLANTS"],e=>e.minLevel<=this.#h),t=I(4,12);for(;t-- >0;){let t=e.getRandomEntry();t&&this.#ih.artefacts.push(t)}}#rd(){let e=tb.getRandomEntry("OBJECTIVES",e=>e.minLevel<=this.#h);e&&(this.#ih.objective=e)}#ru(){let e=new aC({minCols:12,maxCols:40,maxRoomCols:10,minRows:12,maxRows:40,maxRoomRows:6});this.#ih.mapDesign=e.generate()}}const av="custom-pointer-down-event",aL="custom-pointer-up-event",aD="custom-pointer-cancel-event",aM="custom-click-event",ab="custom-context-click-event",a_="custom-pointer-drag-event",az={MOUSE:0,TOUCH:1};function ak(e,t,i){let r=new CustomEvent(t,{detail:i});e.dispatchEvent(r)}function aB(e){let t=e.target.getBoundingClientRect();return{x:e.touches[0].pageX-t.left,y:e.touches[0].pageY-t.top}}function aG(e,t,i,r){r.actionStarted=!0,r.dragging=!1,r.distance=0,r.lastX=t,r.lastY=i,r.startX=t,r.startY=i,ak(r.element,av,{x:t,y:i})}function aU(e,t,i,r){let a=r.dragging?"custom-pointer-drag-end-event":aL;r.actionStarted=!1,r.dragging=!1,r.distance=0,r.lastX=t,r.lastY=i,r.startX=t,r.startY=i,ak(r.element,a,{x:t,y:i})}function aH(e,t,i,r){let a=t-r.lastX,n=i-r.lastY;if(r.lastX=t,r.lastY=i,r.dragging){let e=new CustomEvent(a_,{detail:{x:t,y:i,dx:a,dy:n}});r.element.dispatchEvent(e)}else(Math.abs(t-r.startX)>10||Math.abs(i-r.startY)>10)&&(r.dragging=!0,r.suppressClickEvent=!0)}const aF=new Map([["BUTTON ABOUT","About"],["BUTTON BUY FOR GP","Buy for ${0}Â GP"],["BUTTON CANCEL","Cancel"],["BUTTON CAST SPELL","Cast spell"],["BUTTON CONSUME","Consume"],["BUTTON CONTINUE","Continue"],["BUTTON CLIMB OVER","Climb over"],["BUTTON BARGE","Barge past"],["BUTTON HALL OF FAME","Hall of fame"],["BUTTON DISCARD","Discard"],["BUTTON DO NOT SHOW AGAIN","Do not show again"],["BUTTON ENTER DUNGEON","Enter if you dare"],["BUTTON EQUIP","Equip"],["BUTTON FORGET","Forget"],["BUTTON GUIDES","About and Help"],["BUTTON HELP","Help"],["BUTTON INVENTORY","Inventory"],["BUTTON LEARN SPELL","Learn spell"],["BUTTON LEAVE ARTEFACT","Leave"],["BUTTON LEAVE IT","Leave it"],["BUTTON MAGIC","Magic"],["BUTTON MOVE","Move"],["BUTTON OK","OK"],["BUTTON PILLAGE","Pillage"],["BUTTON PLAY ADVENTURE","Play adventure"],["BUTTON PLAY CASUAL","Play casual"],["BUTTON PRIVACY","Privacy"],["BUTTON PREPARE SPELL","Prepare"],["BUTTON REST","Rest"],["BUTTON REST LONG","Long rest"],["BUTTON READY MAGIC","Ready Magic"],["BUTTON REST SHORT","Short rest"],["BUTTON SEARCH","Search"],["BUTTON SELL FOR GP","Sell for ${0}Â GP"],["BUTTON SETTINGS","Settings"],["BUTTON SHOW DEBUG LOG","The chronicles of Debug Loggerman"],["BUTTON START","Let's get started."],["BUTTON STASH","Stash"],["BUTTON STEAL","Steal"],["BUTTON TRAP DISABLE","Try to disable"],["BUTTON TRAP LEAVE","Leave it alone"],["BUTTON TAKE ARTEFACT","Take"],["BUTTON TRADE","Trade"],["BUTTON TRAITS","Traits"],["BUTTON TRY AGAIN","Try again"],["BUTTON TRY TO PICK","Pick lock"],["BUTTON TO NEXT FLOOR","To the next floor"],["BUTTON USE","Use"],["CONTROL EFFECTS VOLUME","Effect volume"],["CONTROL MUSIC VOLUME","Music volume"],["CONTROL SHOW QUICK TIPS","Show quick tips"],["CONTROL START IN FULLSCREEN","Start in fullscreen"],["DESCRIPTION ACID_SPLASH","Casting this spell hurls acid over your enemies."],["DESCRIPTION BARBARIAN1","You are a barbarian ready to battle to the end of this dungeon in search of wealth and glory."],["DESCRIPTION BLACK_FLASK","A black flask containing a clear, pungent liquid."],["DESCRIPTION BLACK_FLASK+SERPENT_VENOM","A black flask containing a clear, pungent liquid."],["DESCRIPTION BLUE_FLASK","A blue flask containing a clear, aromatic oil."],["DESCRIPTION BLUE_FLASK+LADY_OF_THE_MOON","A blue flask containing Lady of the Moon syrup."],["DESCRIPTION BURNING_HANDS","Casting this spell with your thumbs touching and fingers spread creates a thin sheet of flames enveloping your enemies."],["DESCRIPTION CHAIN_MAIL_ARMOUR","Armour comprising interlocking steel rings over a soft cushioning fabric. The suit includes gauntlets."],["DESCRIPTION CHILL_TOUCH","Casting this spell assails your victims with the chill of the grave."],["DESCRIPTION CLERIC1","You are a powerful cleric who can act as a conduit between divine powers and the mortal world."],["DESCRIPTION CLUB","A simple wooden club that's seen a lot of action."],["DESCRIPTION COINS","Various coins stamped with the image of latter day kings and queens."],["DESCRIPTION COPPER_COINS","Old copper coins of low value."],["DESCRIPTION DAGGER","A short and very sharp piercing weapon."],["DESCRIPTION ENGRAVED_PILLAR","A large stone pillar covered with mystical engravings."],["DESCRIPTION FIGHTER1","You are a fighter whose family have fallen out of favour. This is your chance to restore your family's good name."],["DESCRIPTION FIRE_BEETLE_PV","A giant fire beetle. Glowing gland radiate a fiery light across the dungeon."],["DESCRIPTION FIRE_BOLT","Casting this spell hurls fire at your victims."],["DESCRIPTION GOBLIN","Small humanoid creature.Treat with caution. They're small but vicious."],["DESCRIPTION GOLD_COINS","Gold coins stamped with the image of latter day kings and queens."],["DESCRIPTION HALF_PLATE_ARMOUR","Shaped metal plates covering most of the body. Simple greaves protect the legs."],["DESCRIPTION HANDAXE","A small, light axe. The blade is sharp and has been looked after with care."],["DESCRIPTION HIDDEN_ARTEFACT","The ground appears to have been disturbed."],["DESCRIPTION INFLICT_WOUNDS","Target any creature you can touch to inflict necrotic damage."],["DESCRIPTION IRON_RATIONS","Simple emergency rations. Crucial for resting between floors."],["DESCRIPTION KOBOLD","A small reptilian humanoid."],["DESCRIPTION LEATHER_ARMOUR","Simple armour comprising stiffened leather boiled in oil along with some more flexible sections."],["DESCRIPTION LIQUID_BLUE","A blue, viscous liquid covering the dungeon flagstones."],["DESCRIPTION LIQUID_BLUE+TOXIC_ACID","A blue, acidic liquid covering the dungeon flagstones."],["DESCRIPTION LOCK_PICK","Set of lock picks."],["DESCRIPTION MANHOLE_COVER","A small manhole cover set into the dungeon floor."],["DESCRIPTION NOXIOUS_GAS","A cloud of foul smelling gas. Poisonous and strength sapping"],["DESCRIPTION ORC","A monstrous creature with an intense hatred of humans."],["DESCRIPTION PADDED_ARMOUR","Simple quilted layers of cloth and batting."],["DESCRIPTION PURPLE_PLANT","A small herb with a purple flower."],["DESCRIPTION QUARTERSTAFF","A large quarterstaff capable of causing significant damage in the right hands."],["DESCRIPTION PURPLE_PLANT+HEDGEWORT","Purple hedgewort. Renowned for it's health giving properties."],["DESCRIPTION PLATE_ARMOUR","Full plate armour with interlocking steel plates covering the entire body. A visored helmet, gauntlets, boots, and padding are included."],["DESCRIPTION PLATINUM_COINS","Highly valued large platinum."],["DESCRIPTION RAT_PV","A giant rat, diseased and vicious."],["DESCRIPTION RANGER1","You are a ranger who is more at one with the forest. The dungeon is not your natural realm, but you are ready to take it on."],["DESCRIPTION RING_MAIL_ARMOUR","Leather armour reinforced with heavy steel rings sown into the material."],["DESCRIPTION ROGUE1","You are a rogue whose slippery character may help you creep your way through the depths of this dark and unforgiving dungeon."],["DESCRIPTION RUSTY_KEY","A large iron key, covered in rust. It's been lost a long time."],["DESCRIPTION SCALE_MAIL_ARMOUR","Leather coat and legging covered with overlapping steel scales."],["DESCRIPTION SHIELD","A wooden shield, carried in one hand and offering some protection."],["DESCRIPTION SHORTSWORD","A light and highly versatile sword."],["DESCRIPTION SILVER_COINS","Silver coins, worn and tarnished but still of value."],["DESCRIPTION SKELETON","A skeleton of someone who died here many years ago. It's intent on revenge."],["DESCRIPTION SLIME","A green sticky substance that seems to be growing."],["DESCRIPTION HELP_THE_DYING","An ancient cantrip that when performed restores a small amount of health to the very injured."],["DESCRIPTION SPIDER_PV","A giant spider with fangs dripping green venom."],["DESCRIPTION SPIKES","It's a trap. Sharp iron spikes shoot up from the ground."],["DESCRIPTION STUDDED_LEATHER_ARMOUR","Tough and flexible leather armour with the addition of steel spikes and rivets."],["DESCRIPTION TOMB_OF_ELDER","A large ancient shrine. It appears to be stone but with a magical gold lustre."],["DESCRIPTION TRADER1","A wandering trader selling all manner of things gathered during many months in the dungeon."],["DESCRIPTION TRADER2","A wandering trader with a wagon stacked high with a variety of artefacts found in the dungeon."],["DESCRIPTION TRAPDOOR","A small door in the floor. You can't tell what it hides."],["DESCRIPTION VEGETATION","A patch of vegetation managing to grow between the cracks in the flagstones."],["DESCRIPTION WATERSKIN","A leather drinking flask with fresh water. Crucial for resting between floors."],["DESCRIPTION WARHAMMER","A bludgeoning, versatile iron hammer favoured by many clerics."],["DESCRIPTION WIZARD1","You a wizard determined to find your way to the final level of this dungeon using your control of magical chaos."],["DESCRIPTION WRAITH","An undead, neutral evil creature with a touch of death."],["DIALOG TITLE DEBUG LOG","Chronicles of Debug Loggerman"],["DIALOG TITLE HALL OF FAME","Hall of Fame"],["DIALOG TITLE CHOICES","Decisions, decisions"],["DIALOG TITLE LOCKED","Locked"],["DIALOG TITLE PICK SPELL TO CAST","Pick spell to cast"],["DIALOG TITLE PILLAGE","Pillage corpse"],["DIALOG TITLE PREPARE SPELLS","Prepare spells"],["DIALOG TITLE SETTINGS","Adjust settings"],["DIALOG TITLE TRADE","Buy and sell with trader"],["DIALOG TITLE TRAP DETECTED","Trap detected!"],["DIALOG TITLE TRAP DISABLED","Trap disabled!"],["DIALOG TITLE TRAP TRIGGERED SURVIVED","Trap triggered!"],["DIALOG TITLE TRAP TRIGGERED INJURED","Trap triggered!"],["DIALOG TITLE UNKNOWN ITEM","Unidentified item"],["MENU TITLE MAIN","Click and Crawl"],["MENU TITLE GUIDES","Guides and information"],["MESSAGE CANNOT LOAD URL","Cannot load data from ${0}"],["MESSAGE CANNOT REST SHORT NEED LONG REST","You've had too many short rests. You need a long one first."],["MESSAGE CANNOT REST SHORT NEED RATIONS","You don't have enough rations for a short rest."],["MESSAGE CANNOT REST LONG NEED RATIONS","You don't have enough rations for a long rest."],["MESSAGE CANNOT STASH","You need to make space in your backpack to stash this."],["MESSAGE CANNOT STORE","You're carrying too much stuff to pick up what you've found."],["MESSAGE CANNOT UNDERSTAND MAGIC","There is strange magic written here, but it's beyond your comprehension."],["MESSAGE CONSUME BUT ALREADY FULL HP","Tastes good, but you're already in prime health. Perhaps you should've waited."],["MESSAGE CONSUME BUT NO HP GAIN","Tastes nice, but your health hasn`t improved."],["MESSAGE DEAD HERO HAS NO INVENTORY","Dead heroes have no use for material belongings. Your inventory is lost in the dungeon, perhaps to be rediscovered by the next intrepid explorer."],["MESSAGE DEFEAT","Despite your valiant efforts, you died. Your legend will live on."],["MESSAGE DUNGEON INTRO CONTINUE","Welcome back, ${0}. The adventure continues. You recognise the familiar smell of death."],["MESSAGE DUNGEON INTRO CASUAL","You enter the dungeon for a quick exploration and to check on what dangers might exist before starting a full adventure. You progress will not be saved and any achievements will be lost."],["MESSAGE ENTER FLOOR","You enter dungeon floor ${0}. The door slams shut behind you. There's no way back. Like it or not, your only path is to continue deeper into the depths of this stone hell."],["MESSAGE ENTRANCE STUCK",["The entrance is locked or jammed. You can't tell. Either way, you can't escape in that direction.","You can't open the entrance. It seems locked or jammed. There's no way back."]],["MESSAGE EXPLAIN SPELL PREP","After a long rest, you can prepare spells ready for use."],["MESSAGE EXIT LOCKED","The exit is locked. There must be a key somewhere."],["MESSAGE EXPLAIN REST","Trying to use the safety of the corridor to rest and eat?"],["MESSAGE EXPLAIN SPELL NEEDS REST","To use a spell you need to prepare it. Preparation can only be done between dungeon floors after a long rest."],["MESSAGE FOUND HIDDEN ARTEFACT",["Good fortune smiles upon you. You found something.","You find something hidden in the ground.","Buried beneath the surface, you find something."]],["MESSAGE FOUND ENGRAVING","You find strange words engraved on the cold stone surface."],["MESSAGE FOUND GENERIC","It 's your lucky day. You' found something."],["MESSAGE GENERIC EPITAPH","Here lies the corpse of one more defeated enemy."],["MESSAGE HALL OF FAME ENTRY","${3-startDate}: ${0-name}; level ${1-level} ${2-class}; ${4-gold} GP; floor ${5-floor}"],["MESSAGE HERO EPITAPH FOR","Here lies the body of ${0}. Rest in peace."],["MESSAGE INSUFFICIENT FUNDS","You don't have enough funds to purchase this item. The item costs ${0}Â GP but you only have ${1}Â GP."],["MESSAGE IT'S A HEALTHY DRINK","That tastes good. +${0}HP"],["MESSAGE IT'S HEALTHY","A bit chewy, but tastes good. +${0}HP"],["MESSAGE KILLED BY POISON","Yuk! Poison! You start to burn up, cough and vomit, before falling to the floor and dying."],["MESSAGE IT'S POISON","Yuk! It's poison. -${0}HP"],["MESSAGE KEY UNLOCKS EXIT","You use the key you found earlier to unlock the door."],["MESSAGE MAKE SPACE IN BACKPACK","You need to make space in your backpack by discarding or using something."],["MESSAGE MAKE SPACE IN EQUIP","This is too big to store. Sell or discard what you're wearing so you can wear this."],["MESSAGE NEED LOCK PICK","You can't pick a lock without a set of lock picks."],["MESSAGE NO SAVED ADVENTURE","No adventure has been saved yet."],["MESSAGE NOTHING HERE","There's nothing here."],["MESSAGE NOTHING MORE TO DISCOVER","There's nothing more for you to learn or discover here."],["MESSAGE RESISTED POISON","Yuk! It's poisonous, but you resist its toxic effects."],["MESSAGE REST DIALOG","You are on a dark staircase leading deeper into the dungeon, but safe for now. If you have enough food or drink, you can rest to restore some health if necessary. If you don't need to recover, save your rations."],["MESSAGE REST LONG HP GAIN","Your long rest recovered ${0} HP. You are also now cured of the toxic effects of any poisons you may have encountered."],["MESSAGE REST SHORT HP GAIN","Your short rest recovered ${0} HP."],["MESSAGE SEARCH CORPSE OR MOVE",["You have a choice. Do you want to search the body or climb on top?","You've found a corpse, but what should you do? Search for weapons and treasure or climb on top of the body?"]],["MESSAGE SEARCH HOLE OR MOVE",["You have a choice. Do you want to search this hole or move into it?","You've been here before. Do you want to search again or climb into the hole you dug?"]],["MESSAGE SEARCH OR MOVE","You have a choice. Do you want to search this tile or move onto it?"],["MESSAGE SPELL ALREADY KNOWN","You've found a spell, but you already know this incantation."],["MESSAGE STOLE GOLD","Success. You pick the trader's pocket undetected and steal ${0} gold coins."],["MESSAGE TRADE STEAL OR BARGE","Do you want to trade or barge past this guy?"],["MESSAGE TRADER ATTACKS BACK","The angry trader detects your clumsy attempt at robbery and strikes back at you."],["MESSAGE TRADER CANNOT STASH","The trader has no space for this."],["MESSAGE TRADER WILL NOT TRADE","The trader has had enough of your trickery and will not trade with you."],["MESSAGE TRADERS PROTECTED","Traders are protected from attack under the ancient law for the protection of travelling merchants."],["MESSAGE TRAP ATTEMPT DISABLE","You find a trap. You can't tell what it is though. Do you want to try to disable it?"],["MESSAGE TRAP TRIGGERED SURVIVED","Despite the trap triggering, you luckily avoid any injury."],["MESSAGE TRAP TRIGGERED INJURED","You're caught by surprise and sustain a number of injuries from the trap."],["MESSAGE TRAP DISABLED","Taking great care you manage to disable the trap."],["MESSAGE FAILED TO IDENTIFY","You tried to identify this, but you're not sure exactly what it is. You might remember later."],["MESSAGE YOU FAIL TO PICK THE LOCK","This lock is tricky. Your attempt to pick it fails."],["MESSAGE YOU PICK THE LOCK","Using your skill, you manage to pick the lock."],["MESSAGE WELCOME","Welcome to the Click and Crawl old-school dungeon crawler. How far will you get?"],["AC (including armour)","AC (+armour): ${0}"],["ACTS ON CASTER","Acts on caster"],["Backpack","Backpack"],["Body","Body"],["Cantrips","Cantrips"],["Consumables","Consumables"],["Character level:","Character level: ${0}"],["CHARACTER LEVEL:","level: ${0}"],["(DEAD)","(DEAD!)"],["Dungeon floor:","Dungeon floor: ${0}"],["Experience:","Experience: ${0}"],["Feet","Feet"],["Score:","Score: ${0}"],["Gold:","Gold: ${0}Â GP"],["GOLD PIECES"," gold pieces"],["Hands","Hands"],["Head","Head"],["(HP OUT OF VALUE)","(HP:Â ${0}/${1})"],["(HP VALUE)","(HP:Â ${0})"],["Known spells","Known spells"],["level","level"],["LEVEL UP","Level up to ${0}"],["Name:","Name: ${0}"],["Prepared spells","Prepared spells"],["Range:","Range: ${0-range}"],["Ready magic","Ready magic"],["Unknown","Unknown"],["Wagon","Wagon"]]);function a$(e){if(em.updateTimeNow(e),c){var t;let i=(e-c)/1e3;rX.update(i),aO.update(i),ec.showFps&&(t=1/i,eh(Q.getContext2D(),`FPS: ${Math.round(t)}`,{x:0,y:Q.getCanvasDimensions().height},{color:"green"}))}c=e,e4.isAnimationOn()&&window.requestAnimationFrame(a$)}var aW={TILE_SIZE:48,initialise:async function(e){Q.setOptions(e);let t=e5.popupElement(function(){let e=document.createElement("div"),t=document.createElement("img");t.src=rt.SPLASH_IMAGE,e.appendChild(t);let i=document.createElement("div");i.className="progress-indicator",e.appendChild(i);let r=document.createElement("p");return r.innerText="Loading",e.appendChild(r),e}());eQ.setMap(aF),function(e){let t=0;for(let i in aR){let r=e.measureText(aR[i]),a=r.fontBoundingBoxAscent+r.fontBoundingBoxDescent,n=.5*a-r.fontBoundingBoxDescent;e.fillText(aR[i],-.5*r.width,n),e.getImageData(0,0,1,1).data[3]<=0&&(m.debug(`Emoji ${i} not supported.`),aR[i]=`[${t++}]`),e.clearRect(0,0,r.width,a)}}(Q.getContext2D()),function(){let e;let t=Q.getCanvas();e={element:t,actionStarted:!1,dragging:!1,x:0,y:0,lastTouchStartPoint:null,suppressClickEvent:!1},t.addEventListener("mousedown",t=>aG(az.MOUSE,t.offsetX,t.offsetY,e),{passive:!0}),t.addEventListener("mouseup",t=>aU(az.MOUSE,t.offsetX,t.offsetY,e),{passive:!0}),t.addEventListener("mousemove",t=>{1&t.buttons&&aH(az.MOUSE,t.offsetX,t.offsetY,e)},{passive:!0}),t.addEventListener("touchstart",t=>{if(1===t.changedTouches.length){let i=aB(t);e.lastTouchStartPoint=new C(i.x,i.y),aG(az.TOUCH,i.x,i.y,e)}},{passive:!0}),t.addEventListener("touchend",t=>{1===t.changedTouches.length&&aU(az.TOUCH,e.lastTouchStartPoint?.x,e.lastTouchStartPoint?.y,e),e.lastTouchStartPoint=null,e.suppressClickEvent=!1},{passive:!0}),t.addEventListener("touchmove",t=>{if(1===t.changedTouches.length){let i=aB(t);aH(az.TOUCH,i.x,i.y,e),e.suppressClickEvent=!0}},{passive:!0}),t.addEventListener("touchcancel",t=>{var i,r;az.TOUCH,i=e.lastTouchStartPoint?.x,r=e.lastTouchStartPoint?.y,e.actionStarted=!1,e.dragging=!1,e.distance=0,e.lastX=i,e.lastY=r,e.startX=i,e.startY=r,ak(e.element,aD,{x:i,y:r}),e.lastTouchStartPoint=null},{passive:!0}),t.addEventListener("click",i=>{m.debug("click"),e.suppressClickEvent||ak(t,aM,{x:i.offsetX,y:i.offsetY}),e.suppressClickEvent=!1}),t.addEventListener("contextmenu",e=>{e.preventDefault(),ak(t,ab,{x:e.offsetX,y:e.offsetY})}),t.addEventListener(aM,e=>{let t=e.detail.x,i=e.detail.y,r=Q.uiCoordsToMappedPositions(t,i);aO.resolveClick(r)||el.resolveClick(r)}),t.addEventListener(av,e=>{let t=e.detail.x,i=e.detail.y,r=Q.uiCoordsToMappedPositions(t,i);aO.resolvePointerDown(r)}),t.addEventListener(aL,e=>{let t=e.detail.x,i=e.detail.y,r=Q.uiCoordsToMappedPositions(t,i);aO.resolvePointerUp(r)}),t.addEventListener(aD,e=>{let t=e.detail.x,i=e.detail.y,r=Q.uiCoordsToMappedPositions(t,i);aO.resolvePointerCancel(r)}),t.addEventListener(a_,e=>{rX.panCameraBy(-e.detail.dx,-e.detail.dy)}),t.addEventListener(ab,e=>{let t=e.detail.x,i=e.detail.y,r=Q.uiCoordsToMappedPositions(t,i);aO.resolveContextMenu(r)||el.resolveContextMenu(r),e.preventDefault()})}(),t6.forEach(e=>{if(e.label=eQ.getText(e.labelKey),e.persistent&&e.onChange){let t=eF.get(e.id,e.defValue);e.onChange(t)}}),e5.showOkDialog(eJ`MESSAGE WELCOME`,{okButtonLabel:eJ`BUTTON START`,className:"door"}).then(()=>(function(){let e=document.body;e.requestFullscreen&&eF.get("START_IN_FULLSCREEN")&&e.requestFullscreen({navigationUI:"hide"})})()).then(()=>e6.loadAndPlayMusic(rt.MUSIC)).then(()=>e6.loadEffects(rt.SOUND_EFFECTS_MAP)).then(()=>ep.loadSpriteMap(rr.data,rr.textureUrl)).then(()=>tv(rt.DUNGEON_SCRIPT)).then(e=>rX.setSceneList(new aP)).then(()=>(function(e){let t=[];return e.forEach((e,i)=>{let r=tv(e).then(e=>{tb.addAlmanac(i,function(e,t){let i=new tD;return e.split(/[\r\n]+/).forEach(e=>{if(""!==(e=e.trim())&&!e.startsWith("#")){let r=tM(e,t);if(r)switch(r.rarity){case tL.VERY_RARE:i.veryRare.push(r);break;case tL.RARE:i.rare.push(r);break;case tL.UNCOMMON:i.uncommon.push(r);break;case tL.COMMON:default:i.common.push(r)}}}),i}(e,i))});t.push(r)}),Promise.all(t)})(rt.ALMANAC_MAP)).then(()=>(t.remove(),rv.triggerEvent(rv.EventId.MAIN_MENU))).then(()=>{e4.onStartAnimation=()=>void window.requestAnimationFrame(a$),e4.setAnimationState(!0)}).catch(e=>{m.error(e),alert(`Fatal error in main game. ${e.message}`)})}};window.addEventListener("load",()=>{try{aW.initialise({width:800,height:600,maxScale:2.4,minScale:1,sizingMethod:"COVER",alpha:!1})}catch(e){m.fatal(e)}});
//# sourceMappingURL=index.6d31967d.js.map
