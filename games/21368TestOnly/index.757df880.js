let e,t,r,i,n,s,a,o,l,h,c,u;String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){if(!(e instanceof RegExp))return this.replace(RegExp(e,"g"),t);if(0>e.flags.indexOf("g"))throw TypeError("String.prototype.replaceAll called with a non-global RegExp argument");return this.replace(e,t)}),String.prototype.toWellFormed||(String.prototype.toWellFormed=function(){if(!this)return this;let e="";for(let t of this){let r=t.codePointAt(0);r>=55296&&r<=56319||r>=56320&&r<=57343?e+="ï¿½":e+=t}return e});let d=[];window.addEventListener("error",e=>{alert(`ERROR: ${e.filename}; line ${e.lineno}
${e.message}
:Stack:
${e.error.stack}`)});var p,m={log:function(...e){console.log(...e)},info:function(...e){console.debug(...e)},debug:function(...e){console.debug(...e)},error:function(...e){console.error(...e),d=d.concat(e)},fatal:function(e){let t;console.error(e),t=e.message?`${e.message}
Stack:
${e.stack}`:e,alert(`Fatal error: ${t}
Previous errors:
${d.join("\n")}`),d.push(t)}};const f="'UnifrakturCook', cursive",g={normal:{size:15,fontName:"'UnifrakturCook', cursive"},h1:{size:30,fontName:f},h2:{size:22,fontName:f},h3:{size:18,fontName:f},emojiSprite:{size:18,fontName:"'UnifrakturCook', cursive"}};function S(e){let t=g[e]??g.normal;return`${t.size}px ${t.fontName}`}const w={DEG_22_5:1/8*Math.PI,DEG_45:2/8*Math.PI,DEG_67_5:3/8*Math.PI,DEG_112_5:5/8*Math.PI,DEG_135:6/8*Math.PI,DEG_157_7:7/8*Math.PI};function E(e,t,r){return e<t?t:e>r?r:e}const y={NONE:-1,N:0,NE:1,E:2,SE:3,S:4,SW:5,W:6,NW:7};function T(e,t){let r=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-r)+r)}function x(e){let t=T(0,e.length);return e[t]}function A(e,t){let r=Math.ceil(e);return Math.floor(Math.random()*(Math.floor(t)-r+1)+r)}function C(e,t=0,r){let i=parseInt(e,r);return Number.isNaN(i)?t:i}function I(e,t=0){let r=parseFloat(e);return Number.isNaN(r)?t:r}class O{x;y;constructor(e,t){this.x=e,this.y=t}static copy(e){return new O(e.x,e.y)}coincident(e){return this.x===e.x&&this.y===e.y}getCartesianAngleTo(e){return Math.atan2(e.y-this.y,e.x-this.x)}getScreenAngleTo(e){return Math.atan2(this.y-e.y,e.x-this.x)}toString(){return`(${this.x},${this.y})`}isCoincident(e){return Math.round(this.x)===Math.round(e.x)&&Math.round(this.y)===Math.round(e.y)}isOtherClose(e,t){return Math.pow(this.x-e.x,2)+Math.pow(this.y-e.y,2)<=Math.pow(t,2)}getOrthoSeparation(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}}class R{x;y;rotation;constructor(e,t,r){this.x=e,this.y=t,this.rotation=r}getCartesianDirection(){return Math.atan2(this.y,this.x)}getScreenDirection(){return Math.atan2(-this.y,this.x)}isZero(e){return Math.abs(this.x)<e&&Math.abs(this.y)<e}}class N{x;y;rotation;constructor(e,t,r){this.x=e,this.y=t,this.rotation=r}}class P extends O{rotation;constructor(e,t,r){super(e,t),this.y=t,this.rotation=r}static fromPoint(e){return new P(e.x,e.y,0)}static copy(e){return new P(e.x,e.y,e.rotation)}getRelativeTo(e){return new P(this.x-e.x,this.y-e.y,this.rotation-e.rotation)}withinSquare(e,t){return Math.abs(e.x-this.x)<t&&Math.abs(e.y-this.y)<t}}class v{x;y;width;height;constructor(e,t,r,i){this.x=e,this.y=t,this.width=r,this.height=i}getBottomRight(){return new O(this.x+this.width,this.y+this.height)}getTopLeft(){return new O(this.x,this.y)}overlaps(e){let t=this.getBottomRight(),r=e.getBottomRight();return!(e.x>t.x||e.y>t.y||r.x<this.x||r.y<this.y)}containsPoint(e){return e.x>=this.x&&e.x<=this.x+this.width&&e.y>=this.y&&e.y<=this.y+this.height}containsCoordinate(e,t){return e>=this.x&&e<=this.x+this.width&&t>=this.y&&t<=this.y+this.height}equals(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height}}new O(Number.MIN_VALUE,Number.MIN_VALUE),new O(Number.MAX_VALUE,Number.MAX_VALUE);let L=null,M=null,b=null,D=0,_=0,B=!0,k=null,z=null,G=0,U=0,H=1,F=1,$=.1,W="COVER",V=new P(0,0,0);function K(){let e,t,r,i;let n={width:window.innerWidth,height:window.innerHeight},s=b.width/b.height,a=0,o=0,l=n.width/n.height;("COVER"===W?s>l:s<l)?o=(a=n.height)*s:a=(o=n.width)/s,(H=o/b.width)>F?(o=(H=F)*b.width,a=H*b.height):H<$&&(o=(H=$)*b.width,a=H*b.height),G=(n.width-o)/2,U=(n.height-a)/2,M.style.left=`${G}px`,M.style.top=`${U}px`,M.style.width=`${o}px`,M.style.height=`${a}px`,G<0?(r=-G/H,e=n.width/H):(r=0,e=b.width),U<0?(i=-U/H,t=n.height/H):(i=0,t=b.height),k=new v(r,i,e,t),m.debug(`Scale: ${H}`),m.debug(`Window: width: ${n.width}, height: ${n.height}`),m.debug(`Display: left: ${G}, top: ${U}, width: ${o}, height: ${a}`),m.debug(`Visible canvas: left: ${r}, top: ${i}, width: ${e}, height: ${t}`)}function Y(){let e=g.normal.size*H;document.documentElement.style.fontSize=`${e}px`}function q(){K(),Y()}function X(){return M.getContext("2d",{alpha:B})}function Z(e){return e.style.opacity=0,window.setTimeout(()=>{e.remove()},500),Promise.resolve()}function j(e){return new P(e.x+V.x,e.y+V.y,e.rotation)}window.addEventListener("resize",()=>{null===L&&(L=window.setTimeout(()=>{q(),L=null},200))});var Q={canvasPositionToWorld:j,centreCanvasOn:function(e){V.x=e.x-D,V.y=e.y-_},clearCanvas:function(){X().clearRect(0,0,b.width,b.height)},displayOnGlass:function(e,t){let r,i;t.replace&&(r=document.getElementsByClassName("glass")[0],r?.replaceChildren()),r||(r=document.createElement("div"),document.body.appendChild(r),r.className="glass");let n=document.createElement("div");r.appendChild(n),n.className="glass-content",n.appendChild(e),t.className&&r.classList.add(t.className),r.style.display="block",r.style.opacity=1;let s=n.getBoundingClientRect().height;n.scrollHeight>s&&n.classList.add("overflow");let a=[];if(t.closers&&t.closers.length>0)t.closers.forEach(e=>{let t=new Promise(t=>{e.element.addEventListener("click",async()=>{t(e.closes)})});a.push(t)});else{let e=new Promise(e=>n.addEventListener("click",()=>e()));a.push(e)}return Promise.race(a).then(e=>(i=e,Z(r))).then(()=>i)},getCanvas:()=>M,getContext2D:X,getCanvasDimensions:function(){return{width:b.width,height:b.height}},getWorldInCanvasBounds:function(){return new v(V.x,V.y,b.width,b.height)},getVisibleCanvasRect:function(){return k},glassPositionToWorld:function(e){let t=e.x<0?k.x+k.width:k.x,r=e.y<0?k.y+k.height:k.y;return j(new P(t+e.x,r+e.y,e.rotation))},isOnCanvas:function(e){return e.overlaps(b)},isOnScreen:function(e){return e.overlaps(b)},panCamera:function(e,t){V.x+=e,V.y+=t},resize:q,setOpacity:function(e){X().globalAlpha=e},setOptions:function(e){var t;if(M){m.error("Multiple calls to setScreen ignored.");return}z=document.getElementById("game-content"),t=e.width,g.normal.size=15+t/100*.390625,g.h1.size=2*g.normal.size,g.h2.size=1.5*g.normal.size,g.h3.size=1.2*g.normal.size,g.emojiSprite.size=t/10,(M=document.createElement("canvas")).id="game-canvas",M.setAttribute("width",e.width),M.setAttribute("height",e.height),M.innerText="Loading the app.",b=new v(0,0,e.width,e.height),D=e.width/2,_=e.height/2,z.appendChild(M),F=e.maxScale,$=e.minScale,W=e.sizingMethod,B=e.alpha,K(),Y()},wipeGlass:Z,worldPositionToCanvas:function(e){return new P(e.x-V.x,e.y-V.y,e.rotation)},worldToUi:function(e){return e*H},uiCoordsToMappedPositions:function(e,t){return{canvas:new P(Math.round(e/=H),Math.round(t/=H)),world:new P(Math.round(e+V.x),Math.round(t+V.y),-V.rotation)}},uiToWorld:function(e){return e/H}};const J=new Map,ee=new Map,et=new Map,er=new Map;function ei(t){let r=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,r),t.isOrganic()?er.delete(t):J.delete(t)}function en(t){let r=e.worldPointToGrid(t.position);e.deleteOccupancyOfGridPoint(t,r),ee.delete(t)}function es(e){et.delete(e)}function ea(){e=null}var eo={addActor:function(t){t.isOrganic()?er.set(t,t):J.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addArtefact:function(t){ee.set(t,t),e.moveTileOccupancyGridPoint(t,null,e.worldPointToGrid(t.position))},addPassiveSprite:function(e){et.set(e,e)},clearAll:function(){er.forEach(e=>ei(e)),J.forEach(e=>ei(e)),ee.forEach(e=>en(e)),et.forEach(e=>es(e)),ea()},getActors:function(){return J},getOrganicActors:function(){return er},getArtefacts:function(){return J},getTileMap:function(){return e},getWorldDims:function(){return e?e.getDimensions():Q.getCanvasDimensions()},removeTileMap:ea,resolveCancel:function(e){return!1},resolveClick:function(t){let r=e?.getTileAtWorldPoint(t.world);return!!r&&(r.actionClick(t.world),!0)},resolveContextMenu:function(t){let r=e.getTileAtWorldPoint(t.world);return!!r&&(r.actionContextClick(t.world),!0)},removeActor:ei,removeArtefact:en,removePassiveSprite:es,setTileMap:function(t){e=t},update:function(t){e?.update(t),er.forEach(r=>{let i=e.worldPointToGrid(r.position);r.visible=e.canHeroSeeGridPoint(i),r.update(t);let n=e.worldPointToGrid(r.position);e.moveTileOccupancyGridPoint(r,i,n)}),ee.forEach(r=>{let i=e.worldPointToGrid(r.position);r.visible=e.canHeroSeeGridPoint(i),r.update(t);let n=e.worldPointToGrid(r.position);e.moveTileOccupancyGridPoint(r,i,n)}),J.forEach(r=>{let i=e.worldPointToGrid(r.position);r.visible=e.canHeroSeeGridPoint(i),r.update(t);let n=e.worldPointToGrid(r.position);e.moveTileOccupancyGridPoint(r,i,n)}),et.forEach(e=>e.update(t))}};function el(e,t,r,i){if(e.font=S(i?.styleName),e.fillStyle=i?.color??"white",i?.wrapAtX){var n=t.split("\n");for(let t=0;t<n.length;t++)i.y=function(e,t,r,i){let n;let s=t.split(" "),a=r.x??0,o=r.y??0,l=i.xWrapPosition-a,h=i.lineSpacing??1,c="";for(let t=0;t<s.length;t++){let r=c+s[t]+" ",i=function(e,t){let r=e.measureText(void 0);return{width:r.width,height:r.fontBoundingBoxAscent+r.fontBoundingBoxDescent,offsetTop:-r.fontBoundingBoxAscent,offsetCentreY:.5*(r.fontBoundingBoxDescent-r.fontBoundingBoxAscent)}}(e);n||(n=h*i.height),i.width>l&&t>0?(e.fillText(c,a,o),c=s[t]+" ",o+=n):c=r}return e.fillText(c,a,o),o+n}(e,n[t],r,i)}else e.fillText(t,r.x??0,r.y??0)}const eh={spriteBoxes:!1,showFps:!0};let ec=new Map;function eu(e){return new Promise(t=>{let r=new Image;r.addEventListener("load",()=>{m.debug(`Image ${e} loaded.`),t(r)}),r.src=e})}var ed={getSpriteBitmap:function(e,t){let r=ec.get(e);return r||t?.quiet||m.debug(`Failed to find image ${e}.`),!(!r&&t?.fallback)||(r=ec.get(t.fallback))||m.debug(`Failed to find fallback image ${t.fallback}.`),r},getUndefinedBitmap:function(){return ec.get("undefined.png")},loadImage:eu,loadImages:function(e){let t=[];return e.forEach(e=>t.push(eu(e))),Promise.all(t)},loadSpriteMap:function(e,t){return eu(t).then(t=>(function(e,t){let r=[];return e.frames.forEach(e=>{r.push(createImageBitmap(t,e.frame.x,e.frame.y,e.frame.w,e.frame.h).then(t=>{let r={filename:e.filename,image:t,width:e.frame.w,height:e.frame.h,centreX:e.sourceSize.w/2-e.spriteSourceSize.x,centreY:e.sourceSize.h/2-e.spriteSourceSize.y};return ec.set(e.filename,r),e.filename}))}),Promise.all(r)})(e,t))}};let ep=0;var em={updateTimeNow:function(e){ep=e},getFrameCount:function(e,t=0){return Math.floor((ep+t)/e)}};const ef={WRAP:0,REVERSE:1,STOP:2};class eg{#e;#t;#r;#i;#n;constructor(e,t){this.#e=e,this.#t=e-1,this.#r=t,this.#i=1,this.#n=0}get index(){return this.#n}set index(e){this.#n=E(e,0,this.#e-1)}advanceBy(e){if(this.#e<1)return this.#n;switch(this.#r){case ef.WRAP:return this.#s(e);case ef.REVERSE:return this.#a(e);case ef.NONE:default:return this.#o(e)}}#s(e){return e%=this.#e,this.#n+=e%this.#e,this.#n>=this.#e&&(this.#n=this.#n-this.#e),this.#n}#a(e){if(Math.floor(e/this.#e)%2&&(this.#i=-this.#i),e%=this.#e,this.#i>0){this.#n+=e;let t=this.#n-this.#t;t>0&&(this.#n=this.#t-t,this.#i=-1)}else this.#i<0&&(this.#n-=e,this.#n<0&&(this.#n=-this.#n,this.#i=1));return this.#n}#o(e){return this.#i>0?this.#n=Math.min(this.#t,this.#n+e):this.#i<0&&(this.#n=Math.max(0,this.#n-e)),this.#n}}class eS{playing;#l;#h;#c;#u;#d;constructor(e,t){let r;if(this.#l=[],this.#c=0,this.#u=T(0,1e3),"string"==typeof e){this.#l.push(ed.getSpriteBitmap(e));return}this.#d=Math.max(1,t.framePeriodMs);let i=e.startIndex??0,n=e.padding??0,s=!0;do{let t=`${e.prefix}${i.toString().padStart(n,"0")}${e.suffix}`;s?(r=ed.getSpriteBitmap(t),s=!1):r=ed.getSpriteBitmap(t,{quiet:!0}),r&&this.#l.push(r),i++}while(r)this.#h=new eg(this.#l.length,t.loopMethod),this.playing=!0}getCurrentFrame(){if(!(this.#l.length>1))return this.#l[0];if(this.playing){let e=em.getFrameCount(this.#d,this.#u);e!==this.#c&&(this.#h.advanceBy(e-this.#c),this.#c=e)}return this.#l[this.#h.index]}setCurrentIndex(e){this.#l.length>1&&(this.playing=!1,this.#h.index=e)}getCurrentIndex(){return this.#l.length>1?this.#h.index:0}}class ew{#p;#m;constructor(e,t){this.#p={},this.#p[e]=t,this.#m=t}get image(){return this.#m}addAnimatedImage(e,t){this.#p[e]=t}setCurrentKey(e){this.#p.hasOwnProperty(e)?this.#m=this.#p[e]:m.error(`Attempt to set current key to nonexistent value of ${e}`)}getCurrentFrame(){return this.#m.getCurrentFrame()}}class eE{_context;_boundingBoxCanvas;constructor(e){this._context=e,this._boundingBoxCanvas=new v(0,0,0,0)}getImageFilename(){return null}getContext(){return this._context}getBoundingBoxCanvas(){return this._boundingBoxCanvas}render(e,t){if(e=Q.worldPositionToCanvas(e),!this.isOnCanvas(e))return;let r=this._context.globalAlpha;this._context.globalAlpha=r*t;let i=e.rotation;i&&(this._context.save(),this._context.translate(e.x,e.y),this._context.rotate(-e.rotation),this._context.translate(-e.x,-e.y)),this._doRender(e),i&&this._context.restore(),eh.spriteBoxes&&(this._context.strokeStyle="green",this._context.strokeRect(this._boundingBoxCanvas.x,this._boundingBoxCanvas.y,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height)),this._context.globalAlpha=r}_doRender(e){m.error("_doRender method should be overridden.")}isOnScreen(e){let t=new v(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return Q.isOnScreen(t)}isOnCanvas(e){let t=new v(e.x-this._boundingBoxCanvas.width/2,e.y-this._boundingBoxCanvas.height/2,this._boundingBoxCanvas.width,this._boundingBoxCanvas.height);return Q.isOnCanvas(t)}}class ey extends eE{#f;#g;#S;text;color;constructor(e,t,r={styleName:"normal",color:"white"}){super(e),this.text=t,this.color=r.color,this.#f=r.styleName}#w(e){this._context.font=S(this.#f);let t=this._context.measureText(e);this.#S={width:t.width,height:t.fontBoundingBoxAscent+t.fontBoundingBoxDescent,origin:{x:-.5*t.width,y:.5*(t.fontBoundingBoxAscent-t.fontBoundingBoxDescent)}},this.#g=e}_doRender(e){var t;this.text!==this.#g&&this.#w(this.text);let r={x:e.x+this.#S.origin.x,y:e.y+this.#S.origin.y,rotation:e.rotation};el(this._context,this.#g,r,{color:this.color,styleName:this.#f}),this._boundingBoxCanvas=(t=this.#S,new v(e.x-t.width/2,e.y-t.height/2,t.width,t.height))}}class eT extends eE{#E;#y;#T;#x;#A;#C;#I;constructor(e,t){super(e),this.#E=t.width??10,this.#y=t.height??10,this.#T=this.#E/2,this.#x=this.#y/2,this.#A=t.fillStyle,this.#C=t.strokeStyle,this.#I=t.lineWidth??2}_doRender(e){this._context.lineWidth=this.#I;let t=e.x-this.#T,r=e.y-this.#x;this.#A&&(this._context.fillStyle=this.#A,this._context.fillRect(t,r,this.#E,this.#y)),this.#C&&(this._context.strokeStyle=this.#C,this._context.strokeRect(t,r,this.#E,this.#y)),this._boundingBoxCanvas=new v(t,r,this.#E,this.#y)}}class ex extends eE{#y;#x;#E;#T;#A;#C;#O;#R;#N;#P;constructor(e,t){super(e),this.#y=t.height,this.#x=this.#y/2,this.#E=t.width,this.#T=this.#E/2,this.#A=t.fillStyle,this.#C=t.strokeStyle,this.#O=t.offsetX??0,this.#R=t.offsetY??0,this.setLevel(0)}setLevel(e){this.#N=Math.min(e,1)*this.#y,this.#P=.5*this.#N}_doRender(e){let t=e.y-this.#x+this.#R,r=e.y+this.#x-this.#N+this.#R,i=e.x-this.#T+this.#O;this.#A&&(this._context.fillStyle=this.#A,this._context.fillRect(i,r,this.#E,this.#N)),this.#C&&(this._context.strokeStyle=this.#C,this._context.strokeRect(i,t,this.#E,this.#y)),this._boundingBoxCanvas=new v(i,t,this.#E,this.#y)}}class eA extends eE{#v;constructor(e,t){super(e);let r=Math.max(t.fillStyles.length??0,t.strokeStyles.length??0);if(0===r){m.error("Attempt to create MultiGaugeTileRenderer with no gauges.");return}this.#v=[];let i=t.tileSize/r,n=-t.tileSize/2+i/2;for(let s=0;s<r;s++)this.#v.push(new ex(e,{width:i,height:t.tileSize,fillStyle:t.fillStyles?.[s],strokeStyle:t.strokeStyles?.[s],offsetX:n+i*s,offsetY:0}))}setLevel(e,t){this.#v[e]?.setLevel(t)}render(e){this.#v?.forEach(t=>t.render(e))}}class eC extends eE{#L;#M;constructor(e,t){super(e),t?.getCurrentFrame?(this.#M=t,this.#L=this.#M.getCurrentFrame()):this.#L=t,this.#L?(this._boundingBoxCanvas.width=this.#L?.width??0,this._boundingBoxCanvas.height=this.#L?.height??0):m.error("No image frame available for sprite.",t)}getImageFilename(){return this.#L.filename}_doRender(e){if(!this.#L)return;let t=this.#M?this.#M.getCurrentFrame():this.#L;this._boundingBoxCanvas.x=e.x-this._boundingBoxCanvas.width/2,this._boundingBoxCanvas.y=e.y-this._boundingBoxCanvas.height/2,this._context.drawImage(t.image,e.x-t.centreX,e.y-t.centreY)}}class eI{#b=new P(0,0,0);#D=new R(0,0,0);#_=new N(0,0,0);#B;modifier;visible;opacity;constructor(e){this.#B=e?.renderer,this.visible=!0,this.opacity=1}get position(){return this.#b}set position(e){this.#b.x=this.valueOrZero(e.x),this.#b.y=this.valueOrZero(e.y),this.#b.rotation=this.valueOrZero(e.rotation)}get velocity(){return this.#D}get acceleration(){return this.#_}set acceleration(e){this.#_=e}set velocity(e){this.#D.x=this.valueOrZero(e.x),this.#D.y=this.valueOrZero(e.y),this.#D.rotation=this.valueOrZero(e.rotation)}valueOrZero(e){return"number"==typeof e?e:0}update(e){this.modifier&&(this.modifier=this.modifier.update(this,e)),this.visible&&this.#k()}#k(){this.#B&&(this.#B.forEach?this.#B.forEach(e=>e.render(this.#b,this.opacity)):this.#B.render(this.#b,this.opacity))}getBoundingBox(){let e=this.#B.getBoundingBoxCanvas();return new v(this.position.x-e.width/2,this.position.y-e.height/2,e.width,e.height)}getImageFilename(){if(!this.#B.forEach)return this.#B.getImageFilename();for(let e of this.#B){let t=e.getImageFilename();if(t)return t}return null}}class eO{decoratedModifier;#z;#G;#U;constructor(e){this.#G=0,this.#U=0,this.decoratedModifier=e}applyAsTransientToSprite(e,t=10){return this.#U=t,new Promise(t=>{this.#z=t,e.modifier=this})}applyAsContinuousToSprite(e){e.modifier=this}update(e,t){this.#z&&(this.#G+=t),this.decoratedModifier&&(this.decoratedModifier=this.decoratedModifier?.update(e,t));let r=this.doUpdate(e,t);return!r||this.#G>this.#U?(this.#z?.(null),null):r}doUpdate(e,t){return m.error("doUpdate should be overridden."),this}}class eR extends eO{#H;#F;#$;constructor(e,t,r){super(r),this.#F=e,this.#H=1/Math.max(t-e,.5),this.#$=0}doUpdate(e,t){return this.#$+=t,this.#$>this.#F?e.opacity=Math.max(0,1-(this.#$-this.#F)*this.#H):e.opacity=1,e.opacity>0?this:null}}class eN{#W;#V;constructor(e,t){this.#W=e,this.#V=t}getSpeedBetweenPoints(e,t){return this.#V?this.#W:(1+.1*(Math.abs(e.x-t.x)+Math.abs(e.y-t.y)))*this.#W}}class eP extends eO{#K;#Y;constructor(e){super(e)}doUpdate(e,t){return e.position.x+=e.velocity.x*t,e.position.y+=e.velocity.y*t,e.acceleration&&(e.velocity.x+=e.acceleration.x*t,e.velocity.y+=e.acceleration.y*t),this}}class ev extends eO{#q;#X;#Z;constructor(e,t){super(t),this.#q=e.prey,this.#X=e.maxSeparation,this.#Z=new eN(e.speed,e.linear)}doUpdate(e,t){let r=this.#q.position,i=e.position,n=this.#Z.getSpeedBetweenPoints(r,i);if(!i.withinSquare(r,this.#X)){let s=i.getCartesianAngleTo(r);e.velocity.x=n*Math.cos(s),e.velocity.y=n*Math.sin(s);let a=e.velocity.x*t,o=e.velocity.y*t;e.position.x+=this.getMinMove(a,r.x,i.x),e.position.y+=this.getMinMove(o,r.y,i.y)}return this}getMinMove(e,t,r){let i=t-r;return 0>Math.sign(e)?Math.max(e,i):Math.min(e,i)}}class eL extends eO{#j;#n;#Q;#Z;constructor(e,t){super(t),this.#j=e.path,this.#n=0,this.#Q=e.path[0],this.#Z=new eN(e.speed,e.linear)}doUpdate(e,t){let r=e.position,i=this.#Z.getSpeedBetweenPoints(this.#Q,r),n=r.getCartesianAngleTo(this.#Q);e.velocity.x=i*Math.cos(n),e.velocity.y=i*Math.sin(n);let s=e.velocity.x*t,a=e.velocity.y*t;if(r.x+=this.getMinMove(s,this.#Q.x,r.x),r.y+=this.getMinMove(a,this.#Q.y,r.y),r.isCoincident(this.#Q)){if(++this.#n>=this.#j.length)return e.velocity.x=0,e.velocity.y=0,this.decoratedModifier;this.#Q=this.#j[this.#n]}return this}getMinMove(e,t,r){let i=t-r;return 0>Math.sign(e)?Math.max(e,i):Math.min(e,i)}}function eM(e,t){return new eL({path:[t],speed:100},e.sprite.modifier).applyAsTransientToSprite(e.sprite)}function eb(e,t){let r=new eI({renderer:e});r.position=t.position,r.velocity=t.velocity??new R(0,0,0),r.acceleration=t.acceleration??new N(0,0,0),eo.addPassiveSprite(r),new eR(t.delaySecs,t.lifetimeSecs,new eP).applyAsTransientToSprite(r,20).then(()=>eo.removePassiveSprite(r))}function eD(e,t){eb(new eC(Q.getContext2D(),e),t)}function e_(e,t){eb(new ey(Q.getContext2D(),e,{color:t.color}),t)}var eB={TILE_SIZE:48};const ek=new class{#J;constructor(){this.#J=new Map}set(e,t){this.#J.set(e,t);try{localStorage.setItem(e,JSON.stringify(t))}catch(e){m.error(`Cannot save setting. ${e.message}`)}}get(e,t){if(this.#J.has(e))return this.#J.get(e);let r=t;try{let t=localStorage.getItem(e);null!==t&&(r=JSON.parse(t))}catch(e){m.error(`Cannot parse value from local storage. ${e.message}`)}return this.#J.set(e,r),r}};class ez{#ee;_element;#et;#er;closes;constructor(e){if(e.closes&&e.action)throw Error("Attempt made to create control that is set to close forms and perform and action. These are mutually exclusive.");if(e.persistent&&!e.id)throw Error("Persistent controls must have an ID set in the options.");this.#ee=e.id,this.#er=e.persistent,e.persistent?this.#et=ek.get(this.#ee,e.defValue):this.#et=e.defValue,this.closes=e.closes,this.listeners=0}get element(){return this._element}get value(){return this.#et}set value(e){e!==this.#et&&(this.#er&&ek.set(this.#ee,e),this.#et=e)}}class eG extends ez{constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return t.appendChild(document.createTextNode(e.label)),t.className="text-button",t}}class eU extends ez{constructor(e){super(e),this._element=this.buildElement(e),e.action&&this._element.addEventListener("click",()=>e.action())}buildElement(e){let t=document.createElement("button");return e.leftLabel&&t.appendChild(document.createTextNode(e.leftLabel)),t.appendChild(eH(e.imageName,"button-icon")),e.rightLabel&&t.appendChild(document.createTextNode(e.rightLabel)),t.className="icon-button",t}}function eH(e,t){let r=ed.getSpriteBitmap(e??"undefined.png",{fallback:"undefined.png"}),i=document.createElement("canvas");i.setAttribute("width",eB.TILE_SIZE),i.setAttribute("height",eB.TILE_SIZE);let n=i.getContext("2d");return n.clearRect(0,0,eB.TILE_SIZE,eB.TILE_SIZE),n.drawImage(r.image,.5*(eB.TILE_SIZE-r.width),.5*(eB.TILE_SIZE-r.height)),i.className=t,i}class eF extends ez{#ei;constructor(e){super(e),this._element=this.buildElement(e.label),this.#ei.checked=this.value,this._element.addEventListener("change",t=>{this.value=this.#ei.checked,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-checkbox",this.#ei=document.createElement("input"),this.#ei.setAttribute("type","checkbox"),t.appendChild(this.#ei),t.appendChild(eH("ui-checkbox00.png","unchecked")),t.appendChild(eH("ui-checkbox01.png","checked"));let r=document.createElement("label");return r.appendChild(document.createTextNode(e)),r.appendChild(t),r}}class e$ extends ez{#en;constructor(e){super(e),this._element=this.buildElement(e.label),this.#en.value=this.value,this._element.addEventListener("change",t=>{this.value=this.#en.value,e.onChange&&e.onChange(this.value)})}buildElement(e){let t=document.createElement("span");t.className="styled-range",this.#en=document.createElement("input"),this.#en.setAttribute("type","range"),t.appendChild(this.#en);let r=document.createElement("label");return r.appendChild(document.createTextNode(e)),r.appendChild(t),r}}const eW={TEXT_BUTTON:"text button",CHECKBOX:"checkbox",RANGE:"range"};function eV(e,t={}){let r=document.createElement(e);return t.className&&(r.className=t.className),t.html?r.innerHTML=t.html:t.text&&(r.innerText=t.text),t.child&&r.appendChild(t.child),r}function eK(e){let r=t.get(e);return null==r?e:Array.isArray(r)?r[T(0,r.length)]:r}function eY(e,...t){let r,i="";for(let t of e){let e=t.trim();if(""!==e){r=e;break}}return r?(i=eK(r),t.forEach((e,t)=>{let r=`\${${t}}`;i=i.replace(r,e)}),i):t?t.join(" "):""}const eq={setMap:function(e){t=e},getText:eK},eX={OK:0,CANCEL:1};function eZ(e,t){return Q.displayOnGlass(e,t).then(e=>(i&&i(),e))}function ej(e){let t=eV("div",{className:"dialog-scroll-content"});return t.innerText=e,t.classList.add(["scrollable"]),t}function eQ(e,t={}){r&&r();let i=document.createElement("div"),n=eV("div",{className:"dialog-scroll-content"});i.appendChild(n),t.title&&n.appendChild(eV("p",{className:"dialog-title",text:t.title})),t.preamble&&n.appendChild(eV("p",{text:t.preamble})),e instanceof Element?n.appendChild(e):n.appendChild(ej(e));let s=eV("div",{className:t.row?"action-buttons-row":"action-buttons-col"});i.appendChild(s);let a=[];if(t?.actionButtons?.forEach(e=>{e.element.parentElement||s.appendChild(e.element),null!==e.closes&&void 0!==e.closes&&a.push({element:e.element,closes:e.closes})}),0===a.length){let e=new eG({id:eX.OK,label:t.okButtonLabel??eY`BUTTON OK`});s.appendChild(e.element),a.push(e)}return eZ(i,{closers:a,className:t?.className})}var eJ={setPreDialogFunction:function(e){r=e},setPostDialogFunction:function(e){i=e},showChoiceDialog:function(e,t,r){let i=document.createElement("div");e&&i.appendChild(eV("p",{className:"dialog-title",text:e})),i.appendChild(eV("p",{text:t}));let n=[];return r?.forEach((e,t)=>{let r=new eG({label:e,closes:t});n.push(r)}),eQ(t,{preamble:e,actionButtons:n,row:!0})},showMessage:function(e){let t=document.createElement("div");t.appendChild(document.createTextNode(e)),t.className="popup",t.style.opacity=1,document.body.appendChild(t),t.addEventListener("click",()=>t.remove())},showOkDialog:function(e,t){r&&r();let i=document.createElement("div");i.appendChild(ej(e));let n=document.createElement("button");return n.appendChild(document.createTextNode(t?.okButtonLabel??eY`BUTTON OK`)),i.appendChild(n),eZ(i,{className:t?.className,closers:[{element:n,closes:eX.OK}]})},showElementOkDialog:function(e,t,i=eY`BUTTON OK`,n){r&&r();let s=document.createElement("div"),a=eV("div",{className:"dialog-scroll-content"});s.appendChild(a),e&&a.appendChild(eV("p",{className:"dialog-title",text:e})),a.appendChild(t);let o=document.createElement("button");return o.appendChild(document.createTextNode(i)),s.appendChild(o),eZ(s,{closers:[{element:o,closes:eX.OK}],className:n})},showControlsDialog:eQ};const e4=new class{#es;#ea;#eo;#el;constructor(){this.#eo=.5,this.#el=.5,this.#es=new Map}loadAndPlayMusic(e){if(this.#ea)throw Error("Only one music track currently supported.");this.#ea=this.#eh(e),this.#ea&&this.#ea.addEventListener("canplay",e=>{this.#ea.volume=this.#eo,this.#ea.loop=!0,this.#ea.play(),window.addEventListener("blur",()=>{this.#ea.pause()}),window.addEventListener("focus",()=>{this.#ea.play()})})}loadEffects(e){let t=[];return e.forEach((e,r)=>{let i=new Promise(t=>{let i=this.#eh(e);i&&i.addEventListener("canplay",e=>{this.#es.set(r,i),t()})});t.push(i)}),Promise.all(t)}#eh(e){return e?new Audio(e):null}playEffect(e){let t=this.#es.get(e);t&&(t.volume=this.#el,t.play())}setMusicVolumePercent(e){this.#eo=e/100,this.#ea&&(this.#ea.volume=this.#eo)}setEffectsVolumePercent(e){this.#el=e/100}},e0=/^ *(\d+(?:\.\d*)?) *([a-zA-Z]+) *$/,e1=new Map([["PP",10],["GP",1],["SP",.1],["CP",.01]]);function e8(e){let t=0,r=0,i=e.match(e0);if(!i)return m.error(`Unrecognised coin "${e}". Value set to zero.`),{valueFace:0,valueGp:0,type:"GP"};{t=i[1];let e=e1.get(i[2])??0;r=parseFloat(i[1])*e}return{valueFace:t,valueGp:r,type:i[2]}}const e2=/(\d+)[dD](\d+)(?: *\+ *(\d+))?/;function e3(e=6){return A(1,e)}function e5(e){return e2.test(e)}function e6(e){if(!e)return 1;if(Number.isInteger(e))return e3(e);let t=e7(e);if(!t)return m.error(`String ${e} not recognised as a dice roll. Defaulting to 1D1.`),1;let r=0;for(let e=0;e<t.qty;e++)r+=e3(parseInt(t.sides))+t.offset;return r}function e9(e){let t=e7(e);return t?t.qty*(t.sides+t.offset):1}function e7(e){let t=e.match(e2);return t?{qty:parseInt(t[1]),sides:parseInt(t[2]),offset:t[3]?parseInt(t[3]):0}:(m.error(`Invalid dice format: ${e}`),null)}function te(e){return e.offset?`${e.qty}D${e.sides}+${e.offset}`:`${e.qty}D${e.sides}`}const tt=[10,200,450,700,1100,1800,2300,2900,3900,5e3,5900,7200,8400,1e4,11500,13e3,15e3,18e3,2e4,22e3,25e3,33e3,41e3,5e4,62e3,75e3,9e4,105e3,12e4,135e3,155e3],tr=[{exp:0,profBonus:2},{exp:300,profBonus:2},{exp:900,profBonus:2},{exp:2700,profBonus:2},{exp:6500,profBonus:3},{exp:14e3,profBonus:3},{exp:23e3,profBonus:3},{exp:34e3,profBonus:3},{exp:48e3,profBonus:4},{exp:64e3,profBonus:4},{exp:85e3,profBonus:4},{exp:1e5,profBonus:4},{exp:12e4,profBonus:5},{exp:14e4,profBonus:5},{exp:165e3,profBonus:5},{exp:195e3,profBonus:5},{exp:225e3,profBonus:6},{exp:265e3,profBonus:6},{exp:305e3,profBonus:6},{exp:355e3,profBonus:6}];function ti(e,t,r){return{centre:e[t]?.[r],tl:e[t-1]?.[r-1],above:e[t-1]?.[r],tr:e[t-1]?.[r+1],right:e[t]?.[r+1],br:e[t+1]?.[r+1],below:e[t+1]?.[r],bl:e[t+1]?.[r-1],left:e[t]?.[r-1]}}function tn(e){let t,r=e.length;for(;r>0;)t=Math.floor(Math.random()*r),r--,[e[r],e[t]]=[e[t],e[r]];return e}const ts=["STR","DEX","CON","INT","WIS","CHA"];function ta(e){return Math.floor((e-10)/2)}class to{damageDice;proficiencyBonus;abilityModifier;twoWeaponFighting;isSecondAttack;unarmed;constructor(e){this.damageDice=e.damageDice??"1D1";let t=e.weaponType??"";"UNARMED"===t?(this.unarmed=!0,this.twoWeaponFighting=!1):t.includes("SIMPLE")&&t.includes("LIGHT")?this.twoWeaponFighting=!0:this.twoWeaponFighting=!1,this.proficiencyBonus=e?.proficiencyBonus??0,this.abilityModifier=e?.abilityModifier??0,this.isSecondAttack=e.secondAttack}#ec(){return 1+this.abilityModifier}getMaxDamage(){return this.unarmed?this.#ec():e9(this.damageDice)+this.proficiencyBonus}rollForAttack(){return e3(20)+this.abilityModifier+this.proficiencyBonus}rollForDamage(){let e;return this.unarmed?this.#ec():(e=this.isSecondAttack&&this.abilityModifier>0?0:this.abilityModifier,e6(this.damageDice)+e)}clone(){let e=new to({});return e.abilityModifier=this.abilityModifier,e.damageDice=this.damageDice,e.isSecondAttack=this.isSecondAttack,e.proficiencyBonus=this.proficiencyBonus,e.twoWeaponFighting=this.twoWeaponFighting,e.unarmed=this.unarmed,e}}class tl{_traits;constructor(e){"string"==typeof e?(this._traits=new Map,this.#eu(e)):this._traits=new Map(e)}#eu(e){return e.split(",").forEach(e=>{let t=e.match(/^\s*(\w+)\s*[=: ]\s*(.+?)\s*$/);if(!t)return;let[r,i]=this.#ed(t[1],t[2]);if(t)this.#ep(r,i.trim());else throw Error(`Invalid property definition'${e}'`)}),this._compositeAc=this.getInt("AC",0),this}set(e,t){this._traits.set(e,t),this._refreshDerivedValues(e)}get(e,t){return this._traits.get(e)??this._traits.get("_"+e)??t}_refreshDerivedValues(e){}getInt(e,t){return C(this.get(e,t),t)}getValueInFeetInTiles(e,t){let r=this.getInt(e);return null==r?t:Math.round(r/7.5)}getFloat(e,t){return I(this.get(e,t),t)}getAsModifier(e,t){let r=this.getInt(e);return null==r?t:ta(r)}#ed(e,t){return"NAME"!==(e=e.toUpperCase())&&(t=t.toUpperCase()),[e,t]}#ep(e,t){switch(e){case"PROF":return this.#em(e,t);case"VALUE":return this.#ef(e,t);case"DMG":return this.#eg(e,t);case"HIT_DICE":return this.#eS(e,t);default:return this.#ew(e,t)}}#ef(e,t){let r=t.match(/^(.*)([a-zA-Z]{2})$/);if(r){let e;let i=r[1].trim();e=e5(i)?e6(i):C(r[1],0),t=`${e} ${r[2]}`}else m.error(`Invalid value for VALUE trait: ${t}`),t="0 GP";this.set(e,t)}#eS(e,t){e5(t)||(m.error(`Invalid trait value ${t} for ${e}. Dice definition required.`),t="1D6"),this.set(e,t)}#eg(e,t){!e5(t)&&isNaN(parseInt(t))&&(m.error(`Invalid trait value ${t} for ${e}. Integer or dice definition required.`),t="0"),this.set(e,t)}#ew(e,t){e5(t)&&"DMG"!==e&&(t=e6(t)),this.set(e,t)}#em(e,t){let r=t.split(/\s*&\s*/),i=[];r.forEach(e=>i.push(e.toUpperCase())),this._traits.set("PROF",i)}clone(){return new tl(this._traits)}getAllTraits(){return new Map([...this._traits.entries()])}getAllTraitsSorted(){return new Map([...this._traits.entries()].sort())}valuesToString(){let e="";return this._traits.forEach((t,r)=>{""!==e&&(e+=","),e+=`${r}:${t}`}),e}}class th extends tl{constructor(e){super(e??new Map)}getDamageDiceWhenCastBy(e){let t=this._traits.get("DMG"),r=function(e,t){let r=e7(e);return r?(r.qty=Math.max(r.qty+t,0),te(r)):e}(t,e.traits.getCharacterLevel()-1);return m.info(`Spell cast: base damage dice = ${t} raised to ${r} for level.`),r}}class tc extends tl{_compositeAc;_proficiencyBonus;_level;_attacks;_equippedWeapons;_equippedArmour;constructor(e){super(e??new Map([["NAME","mystery"]])),this._proficiencyBonus=0,this.#eE(ts),this.#ey(),this._refreshDerivedValues()}clone(){let e=super.clone();return e._compositeAc=this._compositeAc,e._proficiencyBonus=this._proficiencyBonus,e._level=this._level,e._attacks=this._attacks.map(e=>e.clone()),e._equippedWeapons=this._equippedWeapons,e._equippedArmour=this._equippedArmour,e}#eE(e){let t=tn([15,14,13,12,10,8]),r=0;e.forEach(e=>{if(!this.get(e)){let i=t[r++]??8;this.set(e,i)}})}#ey(){let e=this._traits.has("HP"),t=this._traits.has("HP_MAX");if(e&&t)return;let r=this.get("HIT_DICE");if(r){let i=ta(this.getInt("CON",0));t||this.set("HP_MAX",e9(r)+i),e||this.set("HP",e9(r)+i)}else e&&this.set("HP_MAX",this.get("HP"))}getEffectiveAc(){return this._compositeAc}getCharacterLevel(){return this._level}getNonMeleeSaveAbilityModifier(e){let t=e.traits.get("SAVE_ABILITY");return t?ta(this.getInt(t)??0):(m.error(`Non-melee ${e.id} has no SAVE_ABILITY set.`),0)}getCharacterPb(e){return this.isProficient(e)?this._proficiencyBonus:0}getAttacks(){return this._attacks}utiliseArtefacts(e){this._equippedWeapons=e.filter(e=>e.artefactType===ty.WEAPON),this._equippedArmour=e.filter(e=>e.artefactType===ty.ARMOUR),this._refreshDerivedValues()}_refreshDerivedValues(e){(!e||ts.includes(e))&&(this._setLevelAndProfBonusFromExp(),this._utiliseWeapons(this._equippedWeapons),this._utiliseArmour(this._equippedArmour))}_utiliseArmour(e){let t=this.getInt("AC",0);if(!e||0===e.length){this._compositeAc=t;return}let r=this.getInt("DEX",1),i=0,n=0;for(let s of e)switch(s.artefactType){case ty.ARMOUR:{let e=s.traits.get("AC",0),n=function(e,t){let r=ta(t),i=e.traits.get("TYPE","").toLowerCase(),n=e.traits.getInt("AC",0);return i.includes("HEAVY")?n:i.includes("MEDIUM")?n+Math.min(2,r):n+r}(s,r);e.startsWith("+")?i+=n:n>t&&(t=n)}break;case ty.SHIELD:n=Math.max(n,s.traits.getInt("AC",0))}this._compositeAc=t+i+n}_utiliseWeapons(e=[]){let t,r,i,n,s;this._attacks=[];let a=this.getInt("STR",1),o=ta(a);e.length>2&&m.error(`Unexpected number of equipped weapons. Expected 2; received ${e.length}`),0===e.length?(i="",r="UNARMED",n=!0):(i=e[0].traits.get("DMG","1D1")??"1D1",r=e[0].traits.get("TYPE")??"",n=this.isProficient(e[0])),t=new to({damageDice:i,weaponType:r,proficiencyBonus:n?this._proficiencyBonus:0,abilityModifier:o,secondAttack:!1}),e.length>1&&(s=new to({damageDice:e[1].traits.get("DMG","1D1")??"1D1",weaponType:e[1].traits.get("TYPE")??"",proficiencyBonus:this.isProficient(e[1])?this._proficiencyBonus:0,abilityModifier:a,secondAttack:!0})),s?.twoWeaponFighting&&t.twoWeaponFighting?(this._attacks.push(t),this._attacks.push(s)):s&&s.getMaxDamage()>t.getMaxDamage()?(s.isSecondAttack=!1,this._attacks.push(s)):this._attacks.push(t)}_setLevelAndProfBonusFromExp(){let e=function(e){let t=C(e,0),r=0,i=0;do if(t>=tr[i++].exp)r=i;else break;while(i<tr.length)return{level:r,profBonus:tr[r-1].profBonus}}(this._traits.get("EXP"));this._level=e.level,this._proficiencyBonus=e.profBonus}adjustForDefeatOfActor(e){let t;let r=(t=I(e.traits.get("CR")))<.124?10:t<.249?25:t<.499?50:t<.999?100:(t=Math.min(tt.length-1,parseInt(t)),tt[t]),i=this.getInt("EXP",0),n=i+r;m.info(`Experience increased from ${i} to ${n}.`),this.set("EXP",n);let s=this._level;return this._setLevelAndProfBonusFromExp(),{exp:{was:i,now:n},level:{was:s,now:this._level}}}isProficient(e){let t=this._traits.get("PROF"),r=e.traits.get("TYPE");if(!t||!r)return!1;for(let e of t){let t=e.split(" "),i=!0;for(let e of t)if(!r.includes(e)){i=!1;break}if(i)return!0}return!1}}function tu(e,t){let r,i;let n=t??e.traitsString;e.type===ty.SPELL?(r=new th(n),i="spell"):e.type===ty.CANTRIP?(r=new th(n),i="cantrip"):(r=new tl(n),i=e.imageName),r.set("NAME",e.name);let s=function(e,t,r){let i=new tC(e,"",`${t}.png`);return i.traits=r,i}(e,i,r);return s.description=e.description,s.isMagic()?s.interaction=new ik(s):s.isConsumable()&&(s.interaction=new iz(s)),s}function td(e="?"){if(e.len<2)return e;let t=e.replace(/_/g," "),r=t.charAt(0).toUpperCase()+t.substring(1);return eq.getText(r)}function tp(e){let t=`DESCRIPTION ${e.toUpperCase()}`,r=eq.getText(t);return t===r?(m.error(`No description set for ${t}.`),""):r}function tm(e){return fetch(e).then(e=>e.text()).then(e=>e).catch(t=>(m.error(`Error fetching ${e}: ${t}`),null))}const tf={COMMON:"COMMON",UNCOMMON:"UNCOMMON",RARE:"RARE",VERY_RARE:"VERY RARE"};class tg{static COMMON_CUTOFF=.7207207207207207;static UNCOMMON_CUTOFF=.9459459459459459;static RARE_CUTOFF=.990990990990991;static VERY_RARE_CUTOFF=1;common;uncommon;rare;veryRare;constructor(){this.common=[],this.uncommon=[],this.rare=[],this.veryRare=[]}mergeAlmanac(e){this.common.push(...e.common),this.uncommon.push(...e.uncommon),this.rare.push(...e.rare),this.veryRare.push(...e.veryRare)}find(e){let t=this.common.find(e);return t||(t=this.uncommon.find(e))||(t=this.rare.find(e))?t:this.veryRare.find(e)}filter(e){let t=new tg;return t.common=e?this.common.filter(e):[...this.common],t.uncommon=e?this.uncommon.filter(e):[...this.uncommon],t.rare=e?this.rare.filter(e):[...this.rare],t.veryRare=e?this.veryRare.filter(e):[...this.veryRare],t}getRandomEntry(){let e=Math.random();return e<tg.COMMON_CUTOFF?this.getRandomCommonEntry():e<tg.UNCOMMON_CUTOFF?this.getRandomUncommonEntry():e<tg.RARE_CUTOFF?this.getRandomRareEntry():this.getRandomVeryRareEntry()}getRandomCommonEntry(){return x(this.common)}getRandomUncommonEntry(){return 0===this.uncommon.length?this.getRandomCommonEntry():x(this.uncommon)}getRandomRareEntry(){return 0===this.rare.length?this.getRandomUncommonEntry():x(this.rare)}getRandomVeryRareEntry(){return 0===this.veryRare.length?this.getRandomRareEntry():x(this.veryRare)}}function tS(e,t){var r;let i=e.match(/^ *(\d+) *, *(\w+ ?\w+) *, *(\w*) *, *([\w+]*) *(?:\[ *([\w, ]*?)])? *\*(.*)$/);if(!i)return m.error(`Invalid almanac entry ${e}`),null;let n={};n.minLevel=parseInt(i[1]),n.rarity=i[2].toUpperCase(),n.typeId=i[3],n.type=tw.getItemType(t,n.typeId),n.id=i[4];let s=function(e="?"){let t=e.split("+");return e.len<2?e:{name:td(t[0]),imageName:t[0].toLowerCase(),description:tp(t[0])}}(n.id);return n.name=s.name,n.imageName=s.imageName,n.description=s.description,n.equipmentIds=(r=i[5])?r.trim().split(/\s*,\s*/):r,n.traitsString=i[6],n.challengeRating=function(e){let t=e?.match(/CR *[:=] *([\d.]+)/);return t?I(t[1],0):0}(n.traitsString),n}const tw=new class{#eT;constructor(){this.#eT=new Map}addAlmanac(e,t){this.#eT.set(e,t)}getAlmanac(e){let t=this.#eT.get(e);return t||m`Attempt to get non-existent almanac ${e}`,t}getRandomEntry(e,t){let r;r=Array.isArray(e)?x(e):e;let i=this.getAlmanac(r).filter(t);if(i)return i.getRandomEntry();m.error(`Failed to find almanac with key ${r}`)}findById(e,t){for(let r of(t||(t=this.#eT.keys()),t)){let t=this.#eT.get(r)?.find(t=>t.id===e);if(t)return t}m.error(`Failed to find almanac entry for '${e}' in ${t.join(", ")}`)}getPooledAlmanac(e,t){let r=new tg;return e.forEach(e=>{let i=this.getAlmanac(e).filter(t);r.mergeAlmanac(i)}),r}getItemType(e,t){switch(e){case"HEROES":case"ENEMIES":case"TRADERS":return iH(t);default:return tT(t)}}},tE={HEAD:{id:"HEAD",space:1,money:!1,spacesExpand:!1},BODY:{id:"BODY",space:1,money:!1,spacesExpand:!1},HANDS:{id:"HANDS",space:2,money:!1,spacesExpand:!1},FEET:{id:"FEET",space:2,money:!1,spacesExpand:!1},BACKPACK:{id:"BACKPACK",space:8,money:!1,spacesExpand:!0},WAGON:{id:"WAGON",space:8,money:!1,spacesExpand:!0},CANTRIPS:{id:"CANTRIPS",space:999,money:!1,spacesExpand:!0},SPELLS:{id:"SPELLS",space:9,money:!1,spacesExpand:!0},PREPARED_SPELLS:{id:"PREPARED SPELLS",space:9,money:!1,spacesExpand:!0},PURSE:{id:"PURSE",space:Number.MAX_SAFE_INTEGER,money:!0,spacesExpand:!1}},ty={ARMOUR:{storageSpace:1,storeType:{stash:tE.WAGON,equip:tE.BODY}},CONSUMABLE:{storageSpace:1,storeType:{stash:tE.BACKPACK}},CANTRIP:{storageSpace:1,storeType:{stash:null,equip:tE.CANTRIPS}},SPELL:{storageSpace:1,storeType:{stash:tE.SPELLS,equip:tE.PREPARED_SPELLS}},WEAPON:{storageSpace:1,storeType:{stash:tE.BACKPACK,equip:tE.HANDS}},SHIELD:{storageSpace:1,storeType:{stash:tE.BACKPACK,equip:tE.HANDS}},TWO_HANDED_WEAPON:{storageSpace:2,storeType:{stash:tE.BACKPACK,equip:tE.HANDS}},HEAD_GEAR:{storageSpace:1,storeType:{stash:tE.BACKPACK,equip:tE.HEAD}},COINS:{storageSpace:0,storeType:{stash:tE.PURSE}}};function tT(e){let t=ty[e];return null==t&&m.error(`Unrecognised artefact type: ${e}`),t}class tx{#ex;#eA;#eC;#eI;#eO;constructor(e,t,r){this.#ex=e,this.#eC=0,this.#eA=new Map,this.#eI=t,this.#eO=r}get storeTypeId(){return this.#eO.id}get storeType(){return this.#eO}get freeSpace(){return this.#ex-this.#eC}get maxSpace(){return this.#ex}isEmpty(){return 0===this.#eC}getRequiredSpace(e){return this.#eI?1:e.storageSpace}has(e){return this.#eA.has(e)}add(e){let t=this.#ex-this.#eC,r=this.getRequiredSpace(e);return t>=r&&(this.#eA.set(e,e),this.#eC+=r,!0)}take(e){let t=this.#eA.get(e),r=this.getRequiredSpace(e);return t&&(this.#eC-=r,this.#eA.delete(t)),t}takeFirst(){if(this.isEmpty())return null;let e=this.#eA.values().next().value;return this.take(e)}values(){return this.#eA.values()}canAdd(e){let t=this.getRequiredSpace(e);return this.#ex-this.#eC>=t}}class tA{#eR;#eN;constructor(){this.#eN=!1}get storeType(){return tE.PURSE}get storeTypeId(){return tE.PURSE.id}isEmpty(){return!this.#eR||0===this.#eR.costInGp}has(e){return this.#eR.costInGp>0}add(e){let t=e.costDetails;if(!this.#eR)return this.#eR=e.clone(),!0;let r=this.#eR.costDetails;return this.#eN||(this.#eR=tA.createGoldCoinArtefact(r.valueGp),this.#eN=!0),this.#eR.costInGp=r.valueGp+t.valueGp,!0}take(e){let t=Math.min(this.#eR.costInGp,e.costInGp);return this.#eR.costInGp=this.#eR.costInGp-t,e.costInGp=t,e}canAdd(e){return!0}values(){return this.#eR&&0!==this.#eR.costInGp?[this.#eR.clone()].values():[].values()}static createGoldCoinArtefact(e){let t=tu(tS(`0,COMMON,COINS,gold_coins * VALUE:${e}GP`));return t.costInGp=e,t}}class tC{id;iconImageName;description;artefactType;traits;interaction;almanacEntry;constructor(e,t,r){this.id=e.id,this.description=t,this.iconImageName=r,this.artefactType=e.type,this.almanacEntry=e}get costDetails(){return e8(this.traits?.get("VALUE"))}get costInGp(){return e8(this.traits?.get("VALUE")).valueGp}get sellBackPriceInGp(){return this.artefactType===ty.COINS?this.costInGp:Math.round(75*this.costInGp)/100}set costInGp(e){if(!this.traits)throw Error("Artefact has no traits so cannot set cost.");this.traits.set("VALUE",`${e.toFixed(2)} GP`)}get storageSpace(){return this.artefactType.storageSpace}get stashStoreType(){return this.artefactType.storeType.stash}get equipStoreType(){return this.artefactType.storeType.equip}get stashInWagon(){return this.stashStoreType===tE.WAGON}getDefaultStoreType(){return this.artefactType.storeType.stash??this.artefactType.storeType.equip}getStoreTypes(){let e=[];return this.artefactType.storeType.stash&&e.push(this.artefactType.storeType.stash),this.artefactType.storeType.equip&&e.push(this.artefactType.storeType.equip),e}clone(){let e=new tC(this.almanacEntry,this.description,this.iconImageName);return e.traits=this.traits.clone(),e.value=this.value,e}isMagic(){return this.artefactType===ty.SPELL||this.artefactType===ty.CANTRIP}isUsable(){return!!this.interaction?.canReact()}isConsumable(){return this.artefactType===ty.CONSUMABLE}}class tI{#eP;#ev;#eL;constructor(e,t){for(let t in this.#eP=new Map,this.#ev=e,tE){let e=tE[t];this.#eM(e)}this.#eL=t}get hasWagon(){return this.#ev}#eb(){this.#eL&&this.#eL()}#eM(e){if(e.money)return this.#eP.set(e,new tA(e.space,e.spacesExpand));let t=!0;this.#ev&&e===tE.BACKPACK?t=!1:this.#ev||e!==tE.WAGON||(t=!1),t&&this.#eP.set(e,new tx(e.space,e.spacesExpand,e))}getStore(e){return this.#ev&&e===tE.BACKPACK&&(e=tE.WAGON),this.#eP.get(e)}getStoreByTypeId(e){for(let t of this.#eP.values())if(t.storeTypeId===e)return t;return null}findSuitableStore(e){let t=e.stashStoreType;this.#eP.has(t)||(t=e.equipStoreType);let r=this.getStore(t);return r?.canAdd(e)?r:null}addArtefact(e){let t=this.getStore(e.getDefaultStoreType()),r=t?.add(e);return this.#eb(),r}getFirstStorageDetails(){for(let e of this.#eP.values()){let t=e.values(),r=t.next()?.value;if(r)return{store:e,artefact:r}}return null}hasArtefactWithSameId(e){for(let t of this.getAllStorageDetails())if(t.artefact.id===e.id)return!0;return!1}getAllEquippedArtefacts(){let e=[];for(let t of[this.#eP.get(tE.HEAD),this.#eP.get(tE.BODY),this.#eP.get(tE.HANDS),this.#eP.get(tE.FEET),this.#eP.get(tE.CANTRIPS),this.#eP.get(tE.PREPARED_SPELLS)])t.values().forEach(t=>e.push(t));return e}getAllStorageDetails(){let e=[];return this.#eP.values().forEach(t=>{t.values().forEach(r=>{e.push({store:t,artefact:r})})}),e}getPurseValue(){let e=this.getStore(tE.PURSE).values(),t=e.next()?.value;return t?t.costInGp:0}addToPurse(e){let t=tA.createGoldCoinArtefact(e);this.#eP.get(tE.PURSE).add(t),this.#eb()}takeFromPurse(e){let t=tA.createGoldCoinArtefact(e),r=this.#eP.get(tE.PURSE).take(t);return this.#eb(),r.costInGp}getStoreContents(e){let t=this.getStore(e);return!t||t.isEmpty()?null:t.values()}discard(e){return!!this.discardStashed(e,!0)||this.discardEquipped(e)}discardEquipped(e,t){let r=this.getStore(e.equipStoreType);return r?r.take(e)?(this.#eb(),!0):(t||m.error("Artefact could not be found so not discarded."),!1):(t||m.error("Cannot discard artefact as there isn't an equip store."),!1)}discardStashed(e,t){let r=this.getStore(e.stashStoreType);return r?r.take(e)?(this.#eb(),!0):(t||m.error("Artefact could not be found so not discarded."),!1):(t||m.error("Cannot discard artefact as there isn't a stash store."),!1)}equip(e,t={}){let r=this.getStore(e.stashStoreType),i=this.getStore(e.equipStoreType);if(!r&&!t.direct)return m.error("Cannot equip artefact as there isn`t a stash store to take it from."),!1;if(!i)return m.error("Cannot equip artefact as there isn't an equip store."),!1;let n=e.storageSpace;if(n>i.maxSpace)return m.error("The equip store cannot hold this item."),!1;if(!r?.take(e)&&!t.direct)return m.error("Could not find artefact in the stash."),!1;for(;i.freeSpace<n;){let e=i.takeFirst();r?.add(e)}let s=i.add(e);return this.#eb(),s}stash(e,t={}){let r=this.getStore(e.stashStoreType),i=this.getStore(e.equipStoreType);if(!r)return m.info("Cannot stash artefact as there isn`t a suitable stash store to put it in."),!1;if(!i&&!t.direct)return m.error("No suitable equip store found. If stashing a new artefact, the direct option should be set."),!1;if(e.storageSpace>r.freeSpace)return m.error("The stash store cannot hold this item."),!1;if(!i?.take(e)&&!t.direct)return m.error("The artefact hasn't been equipped so can't unequip it."),!1;let n=r.add(e);return this.#eb(),n}}const tO={WALL:["#","*","|"],DOOR_IN:["-"],DOOR_OUT:["="],GROUND:[".",":",",",";"],VOID:[" "]},tR={TOP_LEFT:"-TL",TOP_LEFT_INTERNAL:"-TLI",TOP:"-T",TOP_RIGHT:"-TR",TOP_RIGHT_INTERNAL:"-TRI",RIGHT:"-R",BOTTOM_RIGHT:"-BR",BOTTOM_RIGHT_INTERNAL:"-BRI",BOTTOM:"-B",BOTTOM_LEFT:"-BL",BOTTOM_LEFT_INTERNAL:"-BLI",LEFT:"-L",TOP_TEE:"-TTEE",RIGHT_TEE:"-RTEE",BOTTOM_TEE:"-BTEE",LEFT_TEE:"-LTEE",INTERNAL_CROSS:"-XI",INTERNAL_VERTICAL:"-VI",INTERNAL_HORIZONTAL:"-HI"},tN={BELOW_WALL:"-SBW",BELOW_END_WALL:"-SBE"};class tP{matrix;entryPointByDoor;exitPointByDoor;constructor(){this.entryPointByDoor=new O(0,0),this.exitPointByDoor=new O(0,0)}static generateTileMapPlan(e,t){let r=new tP,i=r.convertToMatrix(e);return i=r.clarifyMatrix(i),r.createPlan(i,t),r}convertToMatrix(e){let t=[],r=0;return e.forEach(e=>{r=Math.max(r,e.length)}),e.forEach(e=>{e.length<r&&(e+=" ".repeat(r-length)),t.push(e.split(""))}),t}clarifyMatrix(e){let t=[];return e.forEach((r,i)=>{let n=[];t.push(n),r.forEach((t,r)=>{var s,a,o,l;let h;let c=ti(e,i,r);(s=t,tO.VOID.includes(s))?t=" ":tM(t)?(a=t,tb(c.above)&&(tb(c.tl)?a+=tN.BELOW_WALL:a+=tN.BELOW_END_WALL),o=t=a,tv(c.left)||tv(c.above)||tv(c.right)||tv(c.below))?this.entryPointByDoor=new O(r,i):(tL(c.right)||tL(c.below)||tL(c.left)||tL(c.above))&&(this.exitPointByDoor=new O(r,i)):tb(t)&&(h=l=t,tb(c.above)&&tb(c.right)&&tb(c.below)&&tb(c.left)?h+=tR.INTERNAL_CROSS:tM(c.left)&&tM(c.right)?h+=tR.INTERNAL_VERTICAL:tM(c.above)&&tM(c.below)?h+=tR.INTERNAL_HORIZONTAL:tb(c.left)&&tb(c.right)&&tb(c.below)?h+=tR.TOP_TEE:tb(c.above)&&tb(c.below)&&tb(c.left)?h+=tR.RIGHT_TEE:tb(c.left)&&tb(c.right)&&tb(c.above)?h+=tR.BOTTOM_TEE:tb(c.above)&&tb(c.below)&&tb(c.right)?h+=tR.LEFT_TEE:tb(c.right)&&tb(c.below)?h+=tM(c.br)?tR.TOP_LEFT:tR.TOP_LEFT_INTERNAL:tb(c.left)&&tb(c.below)?h+=tM(c.bl)?tR.TOP_RIGHT:tR.TOP_RIGHT_INTERNAL:tb(c.left)&&tb(c.above)?h+=tM(c.tl)?tR.BOTTOM_RIGHT:tR.BOTTOM_RIGHT_INTERNAL:tb(c.right)&&tb(c.above)?h+=tM(c.tr)?tR.BOTTOM_LEFT:tR.BOTTOM_LEFT_INTERNAL:tb(c.above)&&tb(c.below)?h+=tM(c.right)?tR.LEFT:tR.RIGHT:tb(c.right)&&tb(c.left)&&(h+=tM(c.below)?tR.TOP:tR.BOTTOM),t=tb(c.above)?h+tN.BELOW_WALL:h),n.push(t)})}),t}createPlan(e,t){let r=[];e.forEach(e=>{let i=[];r.push(i),e.forEach(e=>{i.push(function e(t,r){if(" "===t)return null;let i=t.match(/(.)(-[^-]*)?(-[^-]*)?/),n=r.get(t);if(!n&&i[2]&&i[3]&&(n=r.get(`${i[1]}${i[2]}`)),!n&&i[2]&&(n=r.get(i[1])),!n){let n=function(e){for(let t in tO)if(tO[t].includes(e))return tO[t][0];return null}(i[1]);if(n&&n!==i[1]){var s,a;let t;return e((s=i[2],a=i[3],t=n,s&&(t+=s),a&&(t+=a),t),r)}m.error(`Failed to find symbol for ${t}`)}return n}(e,t))})}),this.matrix=r}}function tv(e){return tO.DOOR_IN.includes(e)}function tL(e){return tO.DOOR_OUT.includes(e)}function tM(e){return tO.GROUND.includes(e)}function tb(e){var t;return tO.WALL.includes(e)||tv(t=e)||tL(t)}class tD{#eD;#e_;#eB;#ek;setOnClick(e){this.#eD=e}setOnContextClick(e){this.#e_=e}setOnPointerDown(e){this.#eB=e}setOnPointerUp(e){this.#ek=e}actionClick(e){this.#eD?.(this,e)}actionContextClick(e){this.#e_?.(this,e)}actionPointerDown(e){this.#eB?.(this,e)}actionPointerUp(e){this.#ek?.(this,e)}}class t_{#ez;#eG;constructor(e){this.#eG=e,this.#ez=new Map}setRouteToCoords(e,t,r){this.#ez.set(this.coordsToKey(t,r),e)}getRouteToCoords(e,t){return this.#ez.get(this.coordsToKey(e,t))}hasRouteToCoords(e,t){return this.#ez.has(this.coordsToKey(e,t))}coordsToKey(e,t){return`${e}|${t}`}keyToGridPoint(e){let t=e.split("|");return new O(parseInt(t[0]),parseInt(t[1]))}forEach(e){this.#ez.forEach((t,r,i)=>e(t,r,i))}containsGridPoint(e){return this.#ez.has(this.coordsToKey(e.x,e.y))}getWaypointsAsGridPoints(e){let t=this.getRouteToCoords(e.x,e.y);return t&&t.length>1?t.slice(1):null}getWaypointsAsWorldPoints(e){let t=this.getWaypointsAsGridPoints(e);return t?t.map(e=>this.#eG.gridPointToWorldPoint(e)):t}}class tB{actor;#ez;#eG;#eU;constructor(e,t){this.#eG=e,this.actor=t}getDumbRouteNextTo(e,t,r){let i=this.#eH(e,t);if(i.coincident(e))return[];this.#eG.canGridPointBeOccupiedByActor(i,this.actor)||(i=this.#eF(i,t));let n=[],s=Math.sign(i.x-e.x),a=Math.sign(i.y-e.y),o=O.copy(e),l=.5>Math.random(),h=0;for(;r>0;){let t=O.copy(o),c=!1;if(l&&0!==s&&o.x!=i.x?(t.x+=s,c=!0):l||0===a||o.y==i.y||(t.y+=a,c=!0),c=c&&this.#eG.canGridPointBeOccupiedByActor(t,this.actor))h=0,o=t,r--;else{if(++h>=2)break;o.coincident(e)||n.push(this.#eG.gridPointToWorldPoint(o)),e=o,l=!l}}return o.coincident(e)||n.push(this.#eG.gridPointToWorldPoint(o)),n}getAllRoutesFrom(e,t){return this.#ez=new t_(this.#eG),this.#eU=e,this.#e$(e.x,e.y,t,null),this.#ez}#e$(e,t,r,i){if(i){if(e===this.#eU.x&&t===this.#eU.y||!this.#eW(e,t))return;let n=this.#ez.getRouteToCoords(e,t);if(n&&!(i.length<n.length-1))return;i.push(new O(e,t)),this.#eV(e,t)&&this.#ez.setRouteToCoords(i,e,t),r--}else i=[new O(e,t)];r>0&&(this.#e$(e,t-1,r,[...i]),this.#e$(e+1,t,r,[...i]),this.#e$(e,t+1,r,[...i]),this.#e$(e-1,t,r,[...i]))}#eW(e,t){return this.#eG.isGridPointPassableByActor(new O(e,t),this.actor)}#eV(e,t){return this.#eG.canGridPointBeOccupiedByActor(new O(e,t),this.actor)}#eH(e,t){let r=t.x-e.x,i=t.y-e.y,n=t.x,s=t.y;return Math.abs(r)>Math.abs(i)?n-=Math.sign(r):s-=Math.sign(i),new O(n,s)}#eF(e,t){return e.x===t.x&&e.y<t.y?new O(e.x+1,e.y+1):e.x>t.x&&e.y===t.y?new O(e.x-1,e.y+1):e.x===t.x&&e.y>t.y?new O(e.x-1,e.y-1):e.x<t.x&&e.y===t.y?new O(e.x+1,e.y-1):e}}class tk{#eK;#eY;#eG;#eq;#eX;#eZ;#ej;constructor(e,t){this.#eG=e,this.#eK=t}findReachedTiles(){return this.#eY=this.#eG.worldPointToGrid(this.#eK.position),this.#eZ=this.#eG.getMapGridPointRect(),this.#eX&&this.#eX.coincident(this.#eY)&&this.#eZ&&this.#eZ.equals(this.#ej)||(this.#eq=new Map,this.#eq.set(this.#eY.toString(),this.#eY),this.#eQ().forEach(e=>{this.#eJ(e)}),this.#eX=this.#eY,this.#ej=this.#eZ),this.#eq}isGridPointInRays(e){return!!this.#eq&&this.#eq.has(e.toString())}#eQ(){let e=[];for(let t=this.#eZ.x;t<=this.#eZ.x+this.#eZ.width;t++)e.push(new O(t,this.#eZ.y)),e.push(new O(t,this.#eZ.y+this.#eZ.height));for(let t=this.#eZ.y+1;t<=this.#eZ.y+this.#eZ.height-1;t++)e.push(new O(this.#eZ.x,t)),e.push(new O(this.#eZ.x+this.#eZ.width,t));return e}#eJ(e){let t,r,i;let n=function(e){let t=Math.abs(e);return t<=w.DEG_22_5?y.E:t<=w.DEG_67_5?Math.sign(e)>0?y.NE:y.SE:t<=w.DEG_112_5?Math.sign(e)>0?y.N:y.S:t<=w.DEG_157_7?Math.sign(e)>0?y.NW:y.SW:y.W}(this.#eY.getScreenAngleTo(e));Math.abs(e.x-this.#eY.x)>=Math.abs(e.y-this.#eY.y)?(t=Math.sign(e.x-this.#eY.x),r=(i=Math.abs(e.x-this.#eY.x))<1?0:(e.y-this.#eY.y)/i):(r=Math.sign(e.y-this.#eY.y),t=(i=Math.abs(e.y-this.#eY.y))<1?0:(e.x-this.#eY.x)/i);let s=this.#eY.x,a=this.#eY.y,o=!0;for(;i>=0;){let e=new O(Math.round(s),Math.round(a));if(o||this.#eG.isSeeThrough(e,this.#eK))this.#e4(e,n);else break;o=!1,s+=t,a+=r,i--}}#e4(e,t){switch(this.#eq.set(e.toString(),e),t){case y.N:this.#e0(new O(e.x-1,e.y-1)),this.#e0(new O(e.x,e.y-1)),this.#e0(new O(e.x+1,e.y-1));break;case y.NE:this.#e0(new O(e.x,e.y-1)),this.#e0(new O(e.x+1,e.y-1)),this.#e0(new O(e.x+1,e.y));break;case y.E:this.#e0(new O(e.x+1,e.y-1)),this.#e0(new O(e.x+1,e.y)),this.#e0(new O(e.x+1,e.y+1));break;case y.SE:this.#e0(new O(e.x+1,e.y)),this.#e0(new O(e.x+1,e.y+1)),this.#e0(new O(e.x,e.y+1));break;case y.S:this.#e0(new O(e.x-1,e.y+1)),this.#e0(new O(e.x,e.y+1)),this.#e0(new O(e.x+1,e.y+1));break;case y.SW:this.#e0(new O(e.x-1,e.y)),this.#e0(new O(e.x-1,e.y+1)),this.#e0(new O(e.x,e.y+1));break;case y.W:this.#e0(new O(e.x-1,e.y-1)),this.#e0(new O(e.x-1,e.y)),this.#e0(new O(e.x-1,e.y+1));break;case y.NW:this.#e0(new O(e.x-1,e.y)),this.#e0(new O(e.x-1,e.y-1)),this.#e0(new O(e.x,e.y-1))}}#e0(e){this.#eG.isSeeThrough(e)||this.#eq.set(e.toString(),e)}}const tz={DOOR_HIGHLIGHT_FILL:"rgba(0, 255, 0, 0.2)",HP_GAUGE:"rgba(204, 51, 0, 0.4)",HP_TRANSIENT_TEXT_HERO:"white",HP_TRANSIENT_TEXT_ENEMY:"black",INTERACT_HIGHLIGHT_FILL:"transparent",INTERACT_HIGHLIGHT_STROKE:"black",MOVE_HIGHLIGHT_FILL:"rgba(255, 255, 255, 0.2)",MOVE_HIGHLIGHT_STROKE:"white"},tG={MOVEMENT_TILE:0,INTERACT_TILE:1,OCCUPIED_TILE:2,MOVE_OR_INTERACT_TILE:4},tU={OBSTACLE:-1,GROUND:0,ENTRANCE:1,EXIT:2};class tH extends tD{sprite;obstacle;#e1;#e8;#e2;#e3;constructor(e,t){super(),this.sprite=e,this.#e1=new Map,this.obstacle=t.obstacle,this.#e8=t.gridPoint,this.#e2=t.worldPoint,this.#e3=t.role}get role(){return this.#e3}get gridPoint(){return this.#e8}get worldPoint(){return this.#e2}addOccupant(e){this.#e1.set(e,e)}deleteOccupant(e){this.#e1.delete(e)}getOccupants(){return this.#e1}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionClick(this.sprite.position)}isOccupied(){return this.#e1.size>0}isPassableByActor(e){if(this.#e3===tU.ENTRANCE||this.#e3===tU.EXIT||this.obstacle)return!1;for(let t of this.#e1.values())if(t!==e&&!t.isPassableByActor(e))return!1;return!0}canBeOccupiedByActor(e){if((this.#e3===tU.ENTRANCE||this.#e3===tU.EXIT)&&!e.isHero()||this.obstacle)return!1;for(let t of this.#e1.values())if(t!==e&&!t.canShareLocationWithActor(e))return!1;return!0}isSeeThrough(e){return!this.obstacle&&this.#e3!==tU.ENTRANCE&&this.#e3!==tU.EXIT}}class tF{#e5;#e6;#e9;#e7;#te;#E;#y;#tt;#tr;#ti;#tn;#ts;#ta;#to;#tl;#th;#tc;#tu;#td;#tp;#tm;constructor(e,t,r,i){this.#tm=i;let n=t.matrix;this.#tl=t.entryPointByDoor,this.#th=t.exitPointByDoor,this.#e5=e,this.#ti=new eI({renderer:new eT(e,{width:r,height:r,fillStyle:tz.MOVE_HIGHLIGHT_FILL,strokeStyle:tz.MOVE_HIGHLIGHT_STROKE})}),this.#tn=new eI({renderer:new eT(e,{width:r,height:r,fillStyle:tz.DOOR_HIGHLIGHT_FILL,strokeStyle:"green"})}),this.#tp=new eI({renderer:new eT(e,{width:r,height:r,fillStyle:tz.INTERACT_HIGHLIGHT_FILL,strokeStyle:tz.INTERACT_HIGHLIGHT_STROKE})}),this.#te=r,this.#e6=[],this.#e7=n.length,this.#e9=n[0].length,this.#E=r*this.tilesX,this.#y=r*this.tilesY,this.#tc=[],n.forEach((t,r)=>{let i=[];this.#e6.push(i),t.forEach((t,n)=>{if(t){let s=new eI({renderer:new eC(e,ed.getSpriteBitmap(t.image))}),a=new O(n,r),o=this.gridPointToWorldPoint(a),l=new tH(s,{obstacle:t.role===tU.OBSTACLE,gridPoint:a,worldPoint:o,role:t.role});t.onClick&&l.setOnClick((e,r)=>this.#tf(e,r,t.onClick)),this.processTileRole(l),i.push(l),s.position.x=n*this.#te+this.#te/2,s.position.y=r*this.#te+this.#te/2}else i.push(null)})}),this.#ta||(m.error("No entrance has been set. Setting to the first ground tile"),this.#ta=this.#tc[0])}getDimsInTiles(){return{width:this.#e9,height:this.#e7}}processTileRole(e){switch(e.role){case tU.ENTRANCE:if(this.#ta){let t=e.gridPoint;m.error(`Duplicate entrance found at (${t.x}, ${t.y}). Ignored.`)}else this.#ta=e;break;case tU.EXIT:if(this.#to){let t=e.gridPoint;m.error(`Duplicate exit found at (${t.x}, ${t.y}). Ignored.`)}else this.#to=e;break;case tU.GROUND:e.gridPoint.coincident(this.#tl)||this.#tc.push(e)}}update(e){this.#tg();let t=this.getVisibleGridPointRect();for(let r=t.y;r<=t.y+t.height;r++)for(let i=t.x;i<=t.x+t.width;i++)if(this.#tu?.isGridPointInRays(new O(i,r))){let t=this.#e6[r][i];t?.sprite.update(e)}this.#tS(e)}#tg(){if(this.#tm){this.#tu||(this.#tu=new tk(this,this.#tm));let e=this.getTileAtWorldPoint(this.#tm.position);if(e){let t=e.role;t!=tU.ENTRANCE&&t!=tU.EXIT&&this.#tu.findReachedTiles()}}}getMapGridPointRect(){return new v(0,0,this.#e9,this.#e7)}getVisibleGridPointRect(){let e=Q.getWorldInCanvasBounds(),t=this.worldPointToGrid(new O(e.x,e.y)),r=this.worldPointToGrid(new O(e.x+e.width,e.y+e.height)),i=Math.max(0,t.x),n=Math.min(this.#e9-1,r.x),s=Math.max(0,t.y);return new v(i,s,n-i,Math.min(this.#e7-1,r.y)-s)}getGridSize(){return this.#te}getDimensions(){return{width:this.#E,height:this.#y}}getTileAtWorldPoint(e){let t=this.worldPointToGrid(e);return this.getTileAtGridPoint(t)}getTileAtGridPoint(e){if(!e)return null;let t=e.y,r=e.x;return r>=0&&t>=0&&r<this.#e9&&t<this.#e7?this.#e6[t][r]:null}worldPointToGrid(e){return new O(Math.floor(e.x/this.#te),Math.floor(e.y/this.#te))}gridAlignedWorldPoint(e){let t=this.worldPointToGrid(e);return this.gridPointToWorldPoint(t)}gridPointToWorldPoint(e){let t=.5*this.#te;return new O(e.x*this.#te+t,e.y*this.#te+t)}getWorldPositionOfTileByEntry(){return this.gridPointToWorldPoint(this.#tl)}getGridPositionOfEntrance(){return this.#ta.gridPoint}setMovementRoutes(e){this.#tt=e,e?(this.#tr=new Map,this.#tt.forEach(e=>e.forEach(e=>{this.#tr.set(e,e)}))):this.#tr=null}setInteractActors(e){this.#td=[],e?.forEach(e=>{e.interaction.canReact()&&this.#td.push(this.worldPointToGrid(e.position))})}calcReachableDoors(e){this.#ts=[];let t=this.getSurroundingTiles(this.worldPointToGrid(e));[t.above,t.right,t.below,t.left].forEach(e=>{e.gridPoint.coincident(this.#to.gridPoint)?this.#ts.push(e.gridPoint):e.gridPoint.coincident(this.#ta.gridPoint)&&this.#ts.push(e.gridPoint)})}#tS(e){this.#tw(e),this.#tE(e),this.#ty(e)}#tw(e){this.#tr?.forEach(t=>{this.#ti.position=this.gridPointToWorldPoint(t),this.#ti.update(e)})}#tE(e){this.#td?.forEach(t=>{this.#tp.position=this.gridPointToWorldPoint(t),this.#tp.update(e)})}#ty(e){this.#ts?.forEach(t=>{this.#tn.position=this.gridPointToWorldPoint(t),this.#tn.update(e)})}#tf(e,t,r){let i;let n=this.worldPointToGrid(t),s=e.getOccupants();s.size>0&&(i=s.values().next().value);let a=this.#tt?.containsGridPoint(n),o=!1;if(this.#td){for(let e of this.#td)if(e.isCoincident(n)){o=!0;break}}let l=!i?.alive&&i?.isProp();if(a&&o||l){r(e,t,{filter:tG.MOVE_OR_INTERACT_TILE,occupant:i});return}if(a){r(e,t,{filter:tG.MOVEMENT_TILE,occupant:i});return}if(o){r(e,t,{filter:tG.INTERACT_TILE,occupant:i});return}if(this.#ts){for(let i of this.#ts)if(i.isCoincident(n)){r(e,t,{filter:tG.INTERACT_TILE});return}}let h=this.worldPointToGrid(this.#tm.position);if(n.coincident(h)){r(e,t,{occupant:this.#tm,filter:tG.OCCUPIED_TILE});return}i&&r(e,t,{occupant:i,filter:tG.OCCUPIED_TILE}),m.debug("Ignore click outside of highlighted area")}getWaypointsToWorldPoint(e){let t=this.worldPointToGrid(e);return this.#tt?.getWaypointsAsWorldPoints(t)}getRandomFreeGroundTile(){for(let e of(tn(this.#tc),this.#tc))if(!e.isOccupied())return e;return null}isGridPointPassableByActor(e,t){let r=this.getTileAtGridPoint(e);return!!r&&r.isPassableByActor(t)}canGridPointBeOccupiedByActor(e,t){let r=this.getTileAtGridPoint(e);return!!r&&r.canBeOccupiedByActor(t)}canHeroSeeGridPoint(e){return this.#tu?.isGridPointInRays(e)??!0}isSeeThrough(e,t){let r=this.getTileAtGridPoint(e);return!r||r.isSeeThrough(t)}getSurroundingTiles(e){return ti(this.#e6,e.y,e.x)}getRadiatingUpAndDown(e,t=1){return function(e,t){let r;let i=t.columnIndex,n=t.rowIndex,s=[],a=!0,o=!0,l=!0,h=!0,c=1,u=t.distance??1;for(;u-- >0;)h&&(r=e[n][i-c],t.filter&&!t.filter(r)?h=!1:s.push(r)),o&&(r=e[n][i+c],t.filter&&!t.filter(r)?o=!1:s.push(r)),a&&(r=e[n-c][i],t.filter&&!t.filter(r)?a=!1:s.push(r)),l&&(r=e[n+c][i],t.filter&&!t.filter(r)?l=!1:s.push(r)),c++;return s}(this.#e6,{rowIndex:e.y,columnIndex:e.x,distance:t,filter:e=>e.role===tU.GROUND})}deleteOccupancyOfGridPoint(e,t){this.getTileAtGridPoint(t)?.deleteOccupant(e)}moveTileOccupancyGridPoint(e,t,r){r!==t&&(this.getTileAtGridPoint(t)?.deleteOccupant(e),this.getTileAtGridPoint(r)?.addOccupant(e))}getCoincidentActors(e){return this.getTileAtWorldPoint(e.position).getOccupants()}getParticipants(e){let t=[],r=this.getSurroundingTiles(this.worldPointToGrid(e.position));return[r.above,r.right,r.below,r.left].forEach(e=>{let r=e?.getOccupants();r?.forEach(e=>{t.push(e)})}),t}}const t$=[{id:"MUSIC_VOLUME",labelKey:"CONTROL MUSIC VOLUME",defValue:50,controlType:eW.RANGE,persistent:!0,action:null,onChange:e=>e4.setMusicVolumePercent(e)},{id:"EFFECTS_VOLUME",labelKey:"CONTROL EFFECTS VOLUME",defValue:50,controlType:eW.RANGE,persistent:!0,action:null,onChange:e=>{e4.setEffectsVolumePercent(e),e4.playEffect("PUNCH")}}],tW={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:ef.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:ef.REVERSE}},WALK_NORTH:{keyName:"WALK_N",suffix:"walk-n",options:{framePeriodMs:100,loopMethod:ef.REVERSE}},WALK_EAST:{keyName:"WALK_E",suffix:"walk-e",options:{framePeriodMs:100,loopMethod:ef.REVERSE}},WALK_SOUTH:{keyName:"WALK_S",suffix:"walk-s",options:{framePeriodMs:100,loopMethod:ef.REVERSE}},WALK_WEST:{keyName:"WALK_W",suffix:"walk-w",options:{framePeriodMs:100,loopMethod:ef.REVERSE}}},tV={DEAD:{keyName:"DEAD",suffix:"dead",options:{framePeriodMs:100,loopMethod:ef.STOP}},IDLE:{keyName:"IDLE",suffix:"idle",options:{framePeriodMs:300,loopMethod:ef.REVERSE}}};class tK{#tT;constructor(e){this.#tT=e}#tx(e,t){let r=this.#tT[e]?.suffix;if(!r)throw Error(`Attempt made to use invalid standard animation key of '${e}'`);return`${t}-${r}`}getKeyName(e){return this.#tT[e].keyName}addAllToKeyedAnimation(e,t){for(let r in this.#tT){let i=this.#tT[r];e.addAnimatedImage(this.#tT[r].keyName,new eS({prefix:this.#tx(r,t),suffix:".png",startIndex:0,padding:2},i.options))}e.setCurrentKey(this.#tT.IDLE.keyName)}}const tY={peripatetic:new tK(tW),artefact:new tK(tV)},tq=["a","e","i","o","u","ee","oo"],tX=["b","br","c","ch","chr","cr","d","dr","f","fl","fr","g","gl","gr","h","j","k","kr","kl","l","m","n","p","pl","pr","qu","r","s","sch","sh","st","t","th","tr","v","w","y","z"],tZ=["b","bbey","bble","bboy","bby","c","ch","ck","cky","ct","d","f","ff","ffle","ffy","ffey","g","ge","gey","gle","k","l","ll","lly","lley","m","n","ngle","nny","p","r","s","sk","ss","ssy","st","sty","t","th","thy","v","w","y","z","zzle","zzy"];function tj(){let e=x(tX)+x(tq)+x(tX)+x(tq)+x(tZ);return e.charAt(0).toUpperCase()+e.substring(1)}class tQ extends eA{actor;constructor(e,t){super(e,t)}render(e){if(this.actor&&this.actor.traits){let e=this.actor.traits.getInt("HP",0),t=this.actor.traits.getInt("HP_MAX",1);this.setLevel(0,e/t)}super.render(e)}}class tJ extends ew{#eK;#tA;#tC;#tI;constructor(e,t){super(e,t),this.#tA=y.NONE,this.#tI=t}setActor(e){this.#eK=e,this.#tC=this.#eK.alive}getCurrentFrame(){let e=this.#tO();return(e!==this.#tA||this.#tC!=this.#eK?.alive)&&(this.#tA=e,this.#tC=this.#eK?.alive,this.#tR()),super.getCurrentFrame()??this.#tI.getCurrentFrame()??ed.getUndefinedBitmap()}#tO(){return!this.#eK||this.#eK.velocity.isZero(.1)?y.NONE:function(e){let t=Math.abs(e);return t<=w.DEG_45?y.E:t<=w.DEG_135?Math.sign(e)>0?y.N:y.S:y.W}(this.#eK.velocity.getScreenDirection())}#tR(){let e=this.#eK.disengaging;if(!this.#eK.alive)return this.setCurrentKey(tY.peripatetic.getKeyName("DEAD"));switch(this.#tA){case y.NONE:this.setCurrentKey(tY.peripatetic.getKeyName("IDLE"));break;case y.E:this.setCurrentKey(tY.peripatetic.getKeyName(e?"WALK_WEST":"WALK_EAST"));break;case y.N:case y.NW:case y.NE:this.setCurrentKey(tY.peripatetic.getKeyName(e?"WALK_SOUTH":"WALK_NORTH"));break;case y.W:this.setCurrentKey(tY.peripatetic.getKeyName(e?"WALK_EAST":"WALK_WEST"));break;default:this.setCurrentKey(tY.peripatetic.getKeyName(e?"WALK_NORTH":"WALK_SOUTH"))}}}function t4(e,t,r,i){let n;let s=function(e){let t=new tJ("still",new eS(`${e}.png`));return tY.peripatetic.addAllToKeyedAnimation(t,e),t}(e),a=new eC(Q.getContext2D(),s),o=new iF(new eI({renderer:r.get("MOVE")!==iU.ORGANIC?[n=new tQ(Q.getContext2D(),{tileSize:eB.TILE_SIZE-2,fillStyles:[tz.HP_GAUGE],strokeStyles:[]}),a]:[a]}),i.type);return s.setActor(o),n&&(n.actor=o),o.position=new P(eB.TILE_SIZE,eB.TILE_SIZE,0),o.almanacEntry=i,o.traits=r,o.maxTilesPerMove=r.getValueInFeetInTiles("SPEED",1),o.velocity={x:0,y:0,rotation:0},o.iconImageName=t?`${t}.png`:`${e}.png`,o}function t0(e,t){let r;let i=new tc(t??e.traitsString);switch(i.get("NAME")||i.set("NAME",e.name),e.type){case iG.HERO:(r=t4("hero",null,i,e)).type=iG.HERO,t||i.set("NAME",`${tj()} ${tj()}`);break;case iG.TRADER:r=function(e,t,r,i){let n=t4(e,null,r,i);return n.interaction=new iD(n),n}("trader",0,i,e);break;case iG.HIDDEN_ARTEFACT:r=function(e,t,r){let i=function(e){let t=new tJ("still",new eS(`${e}.png`));return tY.artefact.addAllToKeyedAnimation(t,e),t}(e),n=new iF(new eI({renderer:[new eC(Q.getContext2D(),i)]}),"SPELL"===r.type?iG.PROP:iG.HIDDEN_ARTEFACT);return i.setActor(n),n.position=new P(eB.TILE_SIZE,eB.TILE_SIZE,0),n.velocity={x:0,y:0,rotation:0},n.interaction=new i_(n),n.iconImageName=`${e}.png`,n.traits=new tc,n}("hidden-artefact",0,i,e);break;case iG.PROP:r=function(e,t,r,i){let n=t4(e,null,r,i);return n.interaction=new i_(n),n}(e.imageName,0,i,e);break;default:r=function(e,t,r,i){let n=t4(e,null,r,i);return n.isOrganic()?(n.interaction=new iB(n),n.obstacle=!1):n.interaction=new iM(n),n}(e.imageName,0,i,e)}return r.description=e.description,e.equipmentIds&&function(e,t){if(t)for(let r of t){let t=tw.findById(r,["MONEY","WEAPONS","ARMOUR"]);if(t){let r=tu(t);r.equipStoreType?e.storeManager.equip(r,{direct:!0}):e.storeManager.stash(r,{direct:!0})}else m.error(`Cannot find ${r} artefact in almanac to equip actor.`)}}(r,e.equipmentIds),r}function t1(){return ek.get("BEST_ADVENTURE")}function t8(e){!function(e){let t=function(e){let t={name:"unknown",gold:0,exp:0,characterLevel:0,dungeonLevel:0};return e&&(t.name=e.traits.get("NAME"),t.gold=e.storeManager.getPurseValue(),t.exp=e.traits.getInt("EXP",0),t.characterLevel=e.traits.getCharacterLevel(),t.dungeonLevel=io.getCurrentSceneLevel()),t}(e),r=t1(),i=r?r.gold:0;t.gold>i&&ek.set("BEST_ADVENTURE",t)}(e);let t=e.storeManager.getAllStorageDetails(),r=[];t.forEach(e=>r.push({storeTypeId:e.store.storeTypeId,almanacEntry:e.artefact.almanacEntry,traitsString:e.artefact.traits.valuesToString()}));let i={sceneLevel:io.getCurrentSceneLevel(),hero:{alive:e.alive,almanacEntry:e.almanacEntry,traitsString:e.traits.valuesToString(),artefactDetails:r}};ek.set("GAME_STATE",i)}class t2{#tN=new Map;constructor(){}clear(){this.#tN.clear()}#tP(e){return window.btoa(function(e){try{return encodeURIComponent(e)}catch(t){return console.error(t),encodeURIComponent(e.toWellFormed())}}(e)).replace(/=/g,":")}protect(e){if(!e)return e;let t=`???${this.#tN.size}${this.#tP(e)}???`;return this.#tN.set(t,e),t}retrieve(e){let t=this.#tN.get(e);return(this.#tN.delete(e),t)?t:(console.error(`Could not find ${e} in protected data.`),e)}reinstate(e){return e.replace(/[?]{3}\d+[a-zA-Z0-9+/]+:{0,2}[?]{3}/g,e=>this.retrieve(e))}}const t3=new t2;function t5(e,t){return`<span class="printable-link for-print-only">${t?"(":""}${e}${t?")":""}</span>`}const t6=[{re:/(?:(.+)\n=+\n)/g,rep:"\n\n<h1>$1</h1>\n\n"},{re:/(?:(.+)\n-+\n)/g,rep:"\n\n<h2>$1</h2>\n\n"},{re:/^(#+)(?: *)(.+?)(?:#*)[ \t]*$/gm,rep:(e,t,r)=>{let i=Math.min(t.length,6);return`

<h${i}>${r.trim()}</h${i}>
`}},rs(">[ 	]*",{blockPrefix:"<blockquote>",blockSuffix:"</blockquote>"}),rs("(?: {4}|	)",{blockPrefix:"<pre><code>",blockSuffix:"</code></pre>",trimContents:!0,useWarden:!0}),{re:/^(?:[*_-] *){3,}\s*$/gm,rep:"\n\n<hr>\n\n"},rs(" {0,3}[*+-][ 	]+",{blockPrefix:"<ul>",blockSuffix:"</ul>",linePrefix:"<li>",lineSuffix:"</li>"}),rs(" {0,3}\\d+\\.[ 	]+",{blockPrefix:"<ol>",blockSuffix:"</ol>",linePrefix:"<li>",lineSuffix:"</li>"})],t9=[{re:/(?:(?:^|\n{2,})(?!<\w+>))((?:.(?:\n(?!\n))?)+)/g,rep:"\n\n<p>$1</p>\n\n"},{re:/\n{2,}/g,rep:"\n\n"}],t7=[{re:/!(&lt;)?\[(.*?)\]\((https?:\/\/[-\w@:%.+~#=/]+?)(?: +"(.*?)")?\)/gm,rep:(e,t,r,i,n)=>{let s=`<img alt="${r??""}" class="${t?"floatable":""}" src="${i}" title="${n??""}"/>`;return t3.protect(s)}},{re:/\[(.*?)\]\((https?:\/\/[-\w@:%.+~#=/]+?)(?: +"(.*?)")?\)/gm,rep:(e,t,r,i)=>{var n;let s;n=t,s="",/^https:\/\/vimeo.com\//.test(r)?s='<i class="fa-brands fa-vimeo"></i>':/^https:\/\/(www\.)?youtube.com\//.test(r)&&(s='<i class="fa-brands fa-youtube"></i>'),s&&(s=`<span class='link-icon'>${s}</span>`),t=`${n}${s}`;let a=`<a target="_blank" href="${r}" title="${i??""}">${t??""}</a>${t5(r,!0)}`;return t3.protect(a)}},{re:/(?:&lt;|<)(https?:\/\/[-\w@:%.+~#=/]+?)>/gm,rep:(e,t)=>{let r=`<a target="_blank" href="${t}">${t}</a>${t5(t,!0)}`;return t3.protect(r)}},{re:/(?:&lt;|<)([\w.-]+@(?:[\w-]+\.)+[\w-]+)/gm,rep:(e,t)=>{let r=function(e){let t="";for(let r of e)t+=ra(r);return t}(t),i=`<a href="${r}">${r}</a>`;return t3.protect(i)}},{re:/(?:`{2,}(.*?)`{2,}|`(.*?)`)/gm,rep:(e,t,r)=>{let i=`<code>${t??r}</code>`;return t3.protect(i)}},{re:/\*\*([^\s])\*\*/gm,rep:"<strong>$1</strong>"},{re:/__([^\s])__/gm,rep:"<strong>$1</strong>"},{re:/\*([^\s])\*/gm,rep:"<em>$1</em>"},{re:/_([^\s])_/gm,rep:"<em>$1</em>"},{re:/\*\*([^\s])(.*?)([^\s])\*\*/gm,rep:"<strong>$1$2$3</strong>"},{re:/__([^\s])(.*?)([^\s])__/gm,rep:"<strong>$1$2$3</strong>"},{re:/\*([^\s])(.*?)([^\s])\*/gm,rep:"<em>$1$2$3</em>"},{re:/_([^\s])(.*?)([^\s])_/gm,rep:"<em>$1$2$3</em>"}],re=[{re:/\\([\\`*_{}[\]()#+.!-])/g,rep:(e,t)=>ra(t)}],rt=[{re:"\x00",rep:"ï¿½"}],rr=[{re:/&(?![\w#]+?;)/gm,rep:"&amp;"},{re:/<(?!\/?(?:br|sub|sup)>)/gim,rep:"&lt;"}],ri=[{re:/^\s*$/gm,rep:""},{re:/<(?:p|div)>\s*?<\/(?:p|div)>/gim,rep:""}];function rn(e,t){return e&&t.forEach(t=>{e=e.replaceAll(t.re,t.rep)}),e}function rs(e,t){let r=RegExp(`(?:^|\\n)${e}(?:.|\\n)*?(?:(\\n(?!${e}))|$)`,"g"),i=RegExp(`^${e}([ \\t]*.*)$`,"gm"),n=`${t?.linePrefix??""}$1${t?.lineSuffix??""}`;return{re:r,rep:e=>{let r=e.replaceAll(i,n);return t.trimContents&&(r=r.replace(/^[\n\r]*/,"").trimEnd()),t.useWarden&&(r=t3.protect(r)),`

${t?.blockPrefix??""}${r}${t?.blockSuffix??""}

`}}}function ra(e){return`&#${e.charCodeAt(0).toString()};`}var ro={};ro=JSON.parse('{"frames":[{"filename":"acid00.png","frame":{"x":99,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"axe.png","frame":{"x":100,"y":191,"w":42,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":42,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"black_flask.png","frame":{"x":623,"y":202,"w":28,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":1,"w":28,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"blank.png","frame":{"x":96,"y":362,"w":3,"h":3},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":3,"h":3},"sourceSize":{"w":48,"h":48}},{"filename":"block.png","frame":{"x":1,"y":293,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"blood-splat-twice.png","frame":{"x":1,"y":1,"w":96,"h":94},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":96,"h":94},"sourceSize":{"w":96,"h":96}},{"filename":"blood-splat.png","frame":{"x":1,"y":97,"w":94,"h":92},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":4,"w":94,"h":92},"sourceSize":{"w":96,"h":96}},{"filename":"blue_crystal.png","frame":{"x":429,"y":298,"w":42,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"blue_flask.png","frame":{"x":186,"y":388,"w":28,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":1,"w":28,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"cantrip.png","frame":{"x":289,"y":201,"w":44,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"coins.png","frame":{"x":1,"y":343,"w":47,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"copper_coins.png","frame":{"x":383,"y":297,"w":44,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":46},"sourceSize":{"w":48,"h":49}},{"filename":"door-B.png","frame":{"x":303,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-L.png","frame":{"x":831,"y":251,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-R.png","frame":{"x":429,"y":248,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"door-T.png","frame":{"x":353,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"engraved_pillar.png","frame":{"x":703,"y":246,"w":44,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":3,"w":44,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"fire00.png","frame":{"x":403,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"fire01.png","frame":{"x":1,"y":191,"w":48,"h":49},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"floor-SBE.png","frame":{"x":453,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor-SBW.png","frame":{"x":503,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor.png","frame":{"x":553,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBE.png","frame":{"x":603,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2-SBW.png","frame":{"x":653,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"floor2.png","frame":{"x":703,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-dead00.png","frame":{"x":96,"y":467,"w":42,"h":30},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":9,"w":42,"h":30},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle00.png","frame":{"x":216,"y":394,"w":39,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":39,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle01.png","frame":{"x":504,"y":387,"w":40,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":40,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle02.png","frame":{"x":652,"y":403,"w":39,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":4,"w":39,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-idle03.png","frame":{"x":693,"y":413,"w":37,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":4,"w":37,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-walk-e00.png","frame":{"x":726,"y":455,"w":31,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":4,"w":31,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-walk-n00.png","frame":{"x":748,"y":297,"w":35,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":7,"y":4,"w":35,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-walk-s00.png","frame":{"x":648,"y":445,"w":37,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":3,"w":37,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"goblin-walk-w00.png","frame":{"x":687,"y":455,"w":37,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":3,"w":37,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"goblin.png","frame":{"x":1,"y":445,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"gold_coins.png","frame":{"x":1,"y":394,"w":47,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"helmet.png","frame":{"x":192,"y":341,"w":38,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":1,"w":38,"h":45},"sourceSize":{"w":48,"h":49}},{"filename":"hero-dead00.png","frame":{"x":653,"y":246,"w":48,"h":33},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":7,"w":48,"h":33},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle00.png","frame":{"x":735,"y":101,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle01.png","frame":{"x":753,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle02.png","frame":{"x":783,"y":101,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-idle03.png","frame":{"x":51,"y":191,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e00.png","frame":{"x":749,"y":198,"w":34,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":1,"w":34,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e01.png","frame":{"x":831,"y":152,"w":35,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":1,"w":35,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e02.png","frame":{"x":184,"y":436,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-e03.png","frame":{"x":225,"y":436,"w":30,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":0,"w":30,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n00.png","frame":{"x":100,"y":292,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n01.png","frame":{"x":51,"y":241,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n02.png","frame":{"x":100,"y":292,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-n03.png","frame":{"x":363,"y":345,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s00.png","frame":{"x":335,"y":151,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s01.png","frame":{"x":803,"y":1,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s02.png","frame":{"x":335,"y":151,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-s03.png","frame":{"x":100,"y":242,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w00.png","frame":{"x":343,"y":395,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w01.png","frame":{"x":147,"y":241,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w02.png","frame":{"x":299,"y":444,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hero-walk-w03.png","frame":{"x":569,"y":295,"w":37,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":37,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hero.png","frame":{"x":383,"y":151,"w":46,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"hidden-artefact-dead00.png","frame":{"x":148,"y":341,"w":42,"h":45},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":42,"h":45},"sourceSize":{"w":48,"h":48}},{"filename":"hidden-artefact-idle00.png","frame":{"x":142,"y":388,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"hidden-artefact.png","frame":{"x":142,"y":388,"w":42,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":2,"w":42,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down00.png","frame":{"x":431,"y":151,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-down01.png","frame":{"x":479,"y":151,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left00.png","frame":{"x":527,"y":151,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-left01.png","frame":{"x":575,"y":151,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right00.png","frame":{"x":241,"y":201,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-right01.png","frame":{"x":335,"y":200,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up00.png","frame":{"x":383,"y":200,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-arrow-up01.png","frame":{"x":431,"y":199,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre00.png","frame":{"x":479,"y":199,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-auto-centre01.png","frame":{"x":527,"y":199,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen00.png","frame":{"x":97,"y":99,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"hud-fullscreen01.png","frame":{"x":575,"y":199,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"iron_rations.png","frame":{"x":702,"y":333,"w":44,"h":36},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":7,"w":44,"h":36},"sourceSize":{"w":49,"h":49}},{"filename":"miss.png","frame":{"x":608,"y":299,"w":44,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":2,"w":44,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"orc-dead00.png","frame":{"x":473,"y":343,"w":48,"h":34},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":11,"w":48,"h":34},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle00.png","frame":{"x":51,"y":291,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle01.png","frame":{"x":197,"y":101,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle02.png","frame":{"x":246,"y":101,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-idle03.png","frame":{"x":295,"y":101,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e00.png","frame":{"x":384,"y":395,"w":38,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":38,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e01.png","frame":{"x":831,"y":102,"w":36,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":36,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e02.png","frame":{"x":831,"y":301,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-e03.png","frame":{"x":340,"y":445,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n00.png","frame":{"x":144,"y":191,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n01.png","frame":{"x":344,"y":101,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n02.png","frame":{"x":589,"y":101,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-n03.png","frame":{"x":257,"y":442,"w":40,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":40,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s00.png","frame":{"x":637,"y":101,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s01.png","frame":{"x":393,"y":101,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s02.png","frame":{"x":637,"y":101,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-s03.png","frame":{"x":148,"y":291,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w00.png","frame":{"x":320,"y":345,"w":41,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":41,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w01.png","frame":{"x":195,"y":290,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w02.png","frame":{"x":442,"y":101,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc-walk-w03.png","frame":{"x":96,"y":417,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"orc.png","frame":{"x":491,"y":101,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":47,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"platinum_coins.png","frame":{"x":540,"y":101,"w":47,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":47,"h":48},"sourceSize":{"w":48,"h":49}},{"filename":"poleaxe.png","frame":{"x":1,"y":242,"w":48,"h":49},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"rat-dead00.png","frame":{"x":652,"y":356,"w":48,"h":24},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":12,"w":48,"h":24},"sourceSize":{"w":48,"h":48}},{"filename":"rat-idle00.png","frame":{"x":502,"y":476,"w":37,"h":24},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":12,"w":37,"h":24},"sourceSize":{"w":48,"h":48}},{"filename":"rat-idle01.png","frame":{"x":541,"y":476,"w":37,"h":24},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":12,"w":37,"h":24},"sourceSize":{"w":49,"h":48}},{"filename":"rat-idle02.png","frame":{"x":546,"y":403,"w":37,"h":25},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":12,"w":37,"h":25},"sourceSize":{"w":49,"h":49}},{"filename":"rat-walk-e00.png","frame":{"x":101,"y":341,"w":45,"h":25},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":12,"w":45,"h":25},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-n00.png","frame":{"x":616,"y":445,"w":30,"h":28},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":8,"w":30,"h":28},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-s00.png","frame":{"x":585,"y":393,"w":30,"h":34},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":2,"w":30,"h":34},"sourceSize":{"w":48,"h":48}},{"filename":"rat-walk-w00.png","frame":{"x":654,"y":329,"w":46,"h":25},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":12,"w":46,"h":25},"sourceSize":{"w":49,"h":49}},{"filename":"rat.png","frame":{"x":580,"y":476,"w":37,"h":24},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":12,"w":37,"h":24},"sourceSize":{"w":48,"h":48}},{"filename":"red_crystal.png","frame":{"x":232,"y":345,"w":42,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":47},"sourceSize":{"w":48,"h":49}},{"filename":"RIP.png","frame":{"x":99,"y":51,"w":48,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":2,"w":48,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"silver_coins.png","frame":{"x":191,"y":151,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":46,"h":48},"sourceSize":{"w":48,"h":49}},{"filename":"skull.png","frame":{"x":686,"y":101,"w":47,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":47,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"slime-dead00.png","frame":{"x":149,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"slime-idle00.png","frame":{"x":150,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-idle01.png","frame":{"x":201,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-idle02.png","frame":{"x":252,"y":1,"w":49,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":49,"h":48},"sourceSize":{"w":49,"h":48}},{"filename":"slime-walk-e00.png","frame":{"x":652,"y":382,"w":48,"h":19},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":13,"w":48,"h":19},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-n00.png","frame":{"x":849,"y":51,"w":18,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":14,"y":0,"w":18,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-s00.png","frame":{"x":623,"y":151,"w":17,"h":49},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":14,"y":0,"w":17,"h":49},"sourceSize":{"w":48,"h":49}},{"filename":"slime-walk-w00.png","frame":{"x":51,"y":341,"w":48,"h":19},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":13,"w":48,"h":19},"sourceSize":{"w":48,"h":49}},{"filename":"slime.png","frame":{"x":239,"y":249,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"spell.png","frame":{"x":257,"y":394,"w":42,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":1,"w":42,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"spider-dead00.png","frame":{"x":143,"y":151,"w":46,"h":38},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":5,"w":46,"h":38},"sourceSize":{"w":48,"h":48}},{"filename":"spider-idle00.png","frame":{"x":97,"y":149,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"spider-idle01.png","frame":{"x":702,"y":290,"w":44,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"spider-idle02.png","frame":{"x":785,"y":298,"w":44,"h":41},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":41},"sourceSize":{"w":48,"h":48}},{"filename":"spider-idle03.png","frame":{"x":523,"y":343,"w":44,"h":42},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":42},"sourceSize":{"w":48,"h":48}},{"filename":"spider-walk-e00.png","frame":{"x":502,"y":430,"w":40,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":40,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"spider-walk-n00.png","frame":{"x":702,"y":371,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"spider-walk-s00.png","frame":{"x":50,"y":460,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"spider-walk-w00.png","frame":{"x":544,"y":430,"w":40,"h":44},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":2,"w":40,"h":44},"sourceSize":{"w":48,"h":48}},{"filename":"spider.png","frame":{"x":97,"y":149,"w":44,"h":40},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":4,"w":44,"h":40},"sourceSize":{"w":48,"h":48}},{"filename":"trader-dead00.png","frame":{"x":191,"y":201,"w":48,"h":37},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":5,"w":48,"h":37},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle-s03.png","frame":{"x":239,"y":151,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle00.png","frame":{"x":785,"y":200,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle01.png","frame":{"x":786,"y":150,"w":43,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":43,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-idle02.png","frame":{"x":785,"y":249,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e00.png","frame":{"x":463,"y":428,"w":37,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":37,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e01.png","frame":{"x":301,"y":395,"w":40,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":1,"w":40,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e02.png","frame":{"x":831,"y":201,"w":34,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":0,"w":34,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-e03.png","frame":{"x":424,"y":395,"w":37,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":37,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n00.png","frame":{"x":50,"y":362,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n01.png","frame":{"x":140,"y":434,"w":42,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":4,"y":0,"w":42,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n02.png","frame":{"x":50,"y":411,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-n03.png","frame":{"x":381,"y":445,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s00.png","frame":{"x":335,"y":248,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":45,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s01.png","frame":{"x":192,"y":240,"w":45,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":3,"y":0,"w":45,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s02.png","frame":{"x":382,"y":248,"w":45,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":45,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-s03.png","frame":{"x":287,"y":151,"w":46,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":0,"w":46,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w00.png","frame":{"x":422,"y":445,"w":39,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":8,"y":0,"w":39,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w01.png","frame":{"x":608,"y":250,"w":43,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":1,"w":43,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w02.png","frame":{"x":405,"y":346,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader-walk-w03.png","frame":{"x":463,"y":379,"w":39,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":9,"y":1,"w":39,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"trader.png","frame":{"x":96,"y":368,"w":44,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":2,"y":1,"w":44,"h":47},"sourceSize":{"w":48,"h":48}},{"filename":"ui-best-adventure00.png","frame":{"x":287,"y":249,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-best-adventure01.png","frame":{"x":239,"y":297,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox00.png","frame":{"x":287,"y":297,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-checkbox01.png","frame":{"x":335,"y":297,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-guides00.png","frame":{"x":642,"y":150,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-guides01.png","frame":{"x":690,"y":150,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play00.png","frame":{"x":738,"y":150,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-play01.png","frame":{"x":653,"y":198,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings00.png","frame":{"x":701,"y":198,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-settings01.png","frame":{"x":464,"y":247,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down00.png","frame":{"x":512,"y":247,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-down01.png","frame":{"x":560,"y":247,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left00.png","frame":{"x":473,"y":295,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-left01.png","frame":{"x":521,"y":295,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right00.png","frame":{"x":654,"y":281,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-right01.png","frame":{"x":783,"y":341,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up00.png","frame":{"x":569,"y":345,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"ui-spinner-up01.png","frame":{"x":748,"y":389,"w":46,"h":46},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":1,"y":1,"w":46,"h":46},"sourceSize":{"w":48,"h":48}},{"filename":"undefined.png","frame":{"x":586,"y":429,"w":28,"h":43},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":10,"y":3,"w":28,"h":43},"sourceSize":{"w":48,"h":49}},{"filename":"wall-B.png","frame":{"x":199,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BL.png","frame":{"x":748,"y":339,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BLI.png","frame":{"x":249,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BR.png","frame":{"x":749,"y":247,"w":34,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":34,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BRI.png","frame":{"x":299,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-BTEE.png","frame":{"x":349,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-HI.png","frame":{"x":399,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-L.png","frame":{"x":831,"y":351,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-LTEE.png","frame":{"x":617,"y":345,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-R.png","frame":{"x":796,"y":389,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-RTEE.png","frame":{"x":831,"y":401,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-T.png","frame":{"x":449,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TL.png","frame":{"x":617,"y":395,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":15,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TLI.png","frame":{"x":499,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TR.png","frame":{"x":759,"y":437,"w":33,"h":48},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":0,"y":0,"w":33,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TRI.png","frame":{"x":549,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-TTEE.png","frame":{"x":599,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-VI.png","frame":{"x":649,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall-XI.png","frame":{"x":699,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-B.png","frame":{"x":749,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-HI.png","frame":{"x":799,"y":51,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"wall2-T.png","frame":{"x":147,"y":101,"w":48,"h":48},"rotated":false,"trimmed":false,"spriteSourceSize":{"x":0,"y":0,"w":48,"h":48},"sourceSize":{"w":48,"h":48}},{"filename":"waterskin.png","frame":{"x":276,"y":345,"w":42,"h":47},"rotated":false,"trimmed":true,"spriteSourceSize":{"x":5,"y":2,"w":42,"h":47},"sourceSize":{"w":49,"h":49}}],"meta":{"app":"https://www.codeandweb.com/texturepacker","version":"1.0","image":"dungeon.png","format":"RGBA8888","size":{"w":868,"h":501},"scale":"1","smartupdate":"$TexturePacker:SmartUpdate:94658cd81a5aeb0ba4c4b81be5cebb39:deac94a193445edcf54606c9a41efa30:9c0fba27a8a0c106083a8713f6c67b32$"}}');var rl={};rl=new URL("about.167275cc.md",import.meta.url).toString();var rh={};rh=new URL("armour.698e2b94.txt",import.meta.url).toString();var rc={};rc=new URL("artefacts.07825358.txt",import.meta.url).toString();var ru={};ru=new URL("magic.d01e3398.txt",import.meta.url).toString();var rd={};rd=new URL("monsters.36f9886e.txt",import.meta.url).toString();var rp={};rp=new URL("heroes.6da9b27a.txt",import.meta.url).toString();var rm={};rm=new URL("money.8a4afea3.txt",import.meta.url).toString();var rf={};rf=new URL("traders.5b2d56dc.txt",import.meta.url).toString();var rg={};rg=new URL("weapons.470aeefb.txt",import.meta.url).toString();var rS={};rS=new URL("dungeon_script.34f994bb.txt",import.meta.url).toString();var rw={};rw=new URL("help.29d4aacb.md",import.meta.url).toString();var rE={};rE=new URL("do-alto-do-trono-da-desolacao-trimmed.18cbfbbb.mp3",import.meta.url).toString();var ry={};ry=new URL("privacy.9596e717.md",import.meta.url).toString();var rT={};rT=new URL("quickStart.76062113.md",import.meta.url).toString();var rx={};rx=new URL("punch-trimmed.d5ee82fe.mp3",import.meta.url).toString();var rA={};rA=new URL("punch-trimmed-double.7756f095.mp3",import.meta.url).toString();var rC={};rC=new URL("long-medium-swish-trimmed.69cad07b.mp3",import.meta.url).toString();var rI={};rI=new URL("bubbling-trimmed.361718fa.mp3",import.meta.url).toString();var rO={};rO=new URL("male-hurt-sound-trimmed.76fa38ed.mp3",import.meta.url).toString();const rR={ABOUT_MD:new URL(rl),ALMANAC_MAP:new Map([["ARMOUR",new URL(rh)],["ARTEFACTS",new URL(rc)],["MAGIC",new URL(ru)],["ENEMIES",new URL(rd)],["HEROES",new URL(rp)],["MONEY",new URL(rm)],["TRADERS",new URL(rf)],["WEAPONS",new URL(rg)]]),DUNGEON_SCRIPT:new URL(rS),HELP_MD:new URL(rw),MUSIC:new URL(rE),PRIVACY_MD:new URL(ry),QUICK_START_MD:new URL(rT),SOUND_EFFECTS_MAP:new Map([["PUNCH",new URL(rx)],["DOUBLE PUNCH",new URL(rA)],["MISS",new URL(rC)],["POISONED",new URL(rI)],["DIE",new URL(rO)]])};var rN={};rN=new URL("dungeon.8eed0f9b.png",import.meta.url).toString();const rP={data:(p=ro)&&p.__esModule?p.default:p,textureUrl:new URL(rN)};function rv(e,t){return tm(e).then(r=>{let i,n;if(r){var s,a;t3.clear(),a=rn(a=r.replaceAll(/\r/g,""),rt),s?.pre&&(a=rn(a,s.pre)),a=rn(a,rr),a=rn(a,re),a=rn(a,t6),a=rn(a,t9),a=rn(a,t7),a=rn(a,ri),s?.post&&(a=rn(a,s.post)),i=t3.reinstate(a)}else n=eY`MESSAGE CANNOT LOAD URL ${e.toString()}`;let o=eV("div",{className:"parsed-markdown",text:n,html:i});return eJ.showControlsDialog(o,{actionButtons:t,row:!0})})}const rL={MAIN_MENU:0,CLICKED_FREE_GROUND:1,CLICKED_ENTRANCE:2,CLICKED_EXIT:3};let rM=!0;class rb{#eK;#tv;#tL;#eG;#tM;#tb;constructor(e,t,r,i){this.#eK=e,this.#eG=t,this.#tM=r,this.#tb=i}#tD(e){if(this.#eK.moveType===iU.HUNT){if(this.#tb)return e;{let t=this.#eG.worldPointToGrid(n.position);if(e.getOrthoSeparation(t)-1<=1.5*this.#eK.maxTilesPerMove)return this.#eG.worldPointToGrid(n.position)}}return this.#t_(e,this.#eK.maxTilesPerMove)}moveInstantly(){this.#tL=P.copy(this.#eK.position);let e=this.#eG.worldPointToGrid(this.#eK.position),t=this.#tD(e);if(!t.coincident(e)&&this.#eG.canHeroSeeGridPoint(e)){this.#tM.actor=this.#eK;let r=this.#tM.getDumbRouteNextTo(e,t,this.#eK.maxTilesPerMove);r.length>0&&(this.#tv=new eL({path:r,speed:100},this.#eK.sprite.modifier),this.#tB(r[r.length-1]))}}#t_(e,t){let r=A(e.x-t,e.x+t),i=A(e.y-t,e.y+t),n=this.#eG.getDimsInTiles();return new O(E(r,0,n.width-1),E(i,0,n.height-1))}#tB(e){let t=this.#eG.worldPointToGrid(this.#eK.position);this.#eK.position=e;let r=this.#eG.worldPointToGrid(this.#eK.position);this.#eG.moveTileOccupancyGridPoint(this.#eK,t,r)}#tk(){this.#tB(this.#tL)}replay(){return(this.#tk(),this.#tz(),this.#tv)?this.#tv.applyAsTransientToSprite(this.#eK.sprite):Promise.resolve()}#tz(){if(this.#eK.isOrganic()){let e=t0(this.#eK.almanacEntry);e.position=this.#tL,e.maxTilesPerMove=0,eo.addActor(e)}}}class rD{#eG;#tM;#tG;#tb;constructor(e,t,r){this.#tG=[],this.#eG=e,this.#tM=t,this.#tb=r}addAndMoveActor(e){if(0===e.maxTilesPerMove)return;let t=new rb(e,this.#eG,this.#tM,this.#tb);t.moveInstantly(),this.#tG.push(t)}replay(){let e=[];return this.#tG.forEach(t=>e.push(t.replay())),Promise.all(e)}}class r_{constructor(){}async transitionTo(e){await this.onExit().then(()=>(rj=e,e.onEntry()))}onEntry(){return Promise.resolve()}onEvent(e){return Promise.resolve(null)}onExit(){return Promise.resolve(null)}}class rB extends r_{onEntry(){return(function(){let e=new eU({leftLabel:eY`BUTTON PLAY ADVENTURE`,imageName:"ui-play00.png",internalLabel:!0,closes:"PLAY ADVENTURE"}),t=new eU({leftLabel:eY`BUTTON PLAY CASUAL`,imageName:"ui-play00.png",internalLabel:!0,closes:"PLAY CASUAL"}),r=new eU({leftLabel:eY`BUTTON SETTINGS`,imageName:"ui-settings00.png",internalLabel:!0,action:()=>(function(){let e=[];return t$.forEach(t=>{e.push(function(e){let t;switch(e.controlType){case eW.CHECKBOX:t=new eF(e);break;case eW.RANGE:t=new e$(e);break;case eW.TEXT_BUTTON:t=new eG(e);break;default:throw Error(`Attempt to create unrecognised control type ${e.controlType}`)}return t}(t))}),eJ.showControlsDialog(eY`DIALOG TITLE SETTINGS`,{actionButtons:e,className:"door"})})()}),i=new eU({leftLabel:eY`BUTTON BEST ADVENTURE`,imageName:"ui-best-adventure00.png",internalLabel:!0,action:()=>(function(){let e=t1(),t=eV("div",{className:"best-adventure"});if(e){let r=document.createElement("ul");t.appendChild(r),r.appendChild(eV("li",{text:eY`Name:${e.name}`})),r.appendChild(eV("li",{text:eY`Gold:${e.gold.toFixed(2)}`})),r.appendChild(eV("li",{text:eY`Character level:${e.characterLevel}`})),r.appendChild(eV("li",{text:eY`Experience:${e.exp}`})),r.appendChild(eV("li",{text:eY`Dungeon level:${e.dungeonLevel}`}))}else t.appendChild(eV("p",{text:eY`MESSAGE NO SAVED ADVENTURE`}));return eJ.showElementOkDialog(eY`DIALOG TITLE BEST ADVENTURE`,t)})()}),n=new eU({leftLabel:eY`BUTTON GUIDES`,imageName:"ui-guides00.png",internalLabel:!0,action:()=>(function(){let e=new eG({label:eY`BUTTON ABOUT`,action:()=>rv(rR.ABOUT_MD)}),t=new eG({label:eY`BUTTON HELP`,action:()=>rv(rR.HELP_MD)}),r=new eG({label:eY`BUTTON PRIVACY`,action:()=>rv(rR.PRIVACY_MD)});return rv(rR.QUICK_START_MD,[t,e,r])})()});return eJ.showControlsDialog(eY`MENU TITLE MAIN`,{actionButtons:[n,r,i,e,t],className:"door"})})().then(e=>(rM="PLAY CASUAL"!==e,this.transitionTo(new rk)))}}class rk extends r_{onEntry(){return m.log("Enter AtStart"),this.#tU().then(e=>{let t;let r=n.traits.get("NAME");return t=rM?e?eY`MESSAGE DUNGEON INTRO CONTINUE ${r}`:eY`MESSAGE DUNGEON INTRO ${r}`:eY`MESSAGE DUNGEON INTRO CASUAL ${r}')}`,eJ.showOkDialog(t,{okButtonLabel:eY`BUTTON ENTER DUNGEON`,className:"wall"})}).then(e=>(n.sprite.position=eo.getTileMap().getWorldPositionOfTileByEntry(),e)).then(e=>e.intro?eJ.showOkDialog(e.intro,{className:"mask"}):void 0).then(()=>rj.transitionTo(new rU))}#tU(){let e=rM?function(){let e=ek.get("GAME_STATE");if(!e){m.info("No saved game state to restore.");return}if(!e.hero.alive){m.info("Last hero state was dead, so not restoring.");return}e.hero.almanacEntry.equipmentIds=[],e.hero.almanacEntry.type=iH(e.hero.almanacEntry.typeId);let t=t0(e.hero.almanacEntry,e.hero.traitsString);return e.hero.artefactDetails.forEach(e=>{e.almanacEntry.type=tT(e.almanacEntry.typeId);let r=tu(e.almanacEntry,e.traitsString),i=t.storeManager.getStoreByTypeId(e.storeTypeId);if(!i){m.error(`Unable to find store matching ${e.storeTypeId}. Game restore abandoned.`);return}i.add(r)}),{hero:t,sceneLevel:e.sceneLevel}}():null;return e?io.continueFromSavedScene(e.sceneLevel,e.hero).then(()=>!0):io.switchToFirstScene().then(()=>!1)}}class rz extends r_{async onEntry(){m.log("Enter AtGameOver"),rM&&t8(n),e_("YOU DIED!",{delaySecs:1,lifetimeSecs:2,position:n.position,velocity:new R(0,-100,0)}),await new Promise(e=>{setTimeout(()=>e(),2e3)}).then(()=>eJ.showOkDialog(eY`MESSAGE DEFEAT`,{okButtonLabel:eY`BUTTON TRY AGAIN`})).then(()=>io.unloadCurrentScene()).then(()=>this.transitionTo(new rB))}}class rG extends r_{async onEntry(){m.log("Enter AtGameCompleted"),rM&&t8(n),await eJ.showOkDialog(eY`MESSAGE VICTORY`,{okButtonLabel:eY`BUTTON TRY AGAIN`}).then(()=>io.unloadCurrentScene()).then(()=>this.transitionTo(new rB))}}class rU extends r_{constructor(){super()}async onEntry(){await super.onEntry(),m.log("Enter HeroTurnIdle"),await rW()}async onEvent(e,t,r={}){switch(e){case rL.CLICKED_FREE_GROUND:{let e=await rZ(r.filter,r.occupant);e===tG.INTERACT_TILE?await rY(t):e===tG.OCCUPIED_TILE?await rX(r.occupant):await rV(t,{usePathFinder:r.filter!==tG.MOVE_OR_INTERACT_TILE}),0===n.traits.get("HP",0)?this.transitionTo(new rz):this.transitionTo(new rF)}break;case rL.CLICKED_ENTRANCE:await eJ.showOkDialog(eY`MESSAGE ENTRANCE STUCK`);break;case rL.CLICKED_EXIT:m.log("Escaping"),await rV(t,{usePathFinder:!1}).then(()=>eJ.showOkDialog(eY`MESSAGE OPEN EXIT`)).then(()=>rq(this))}return Promise.resolve(null)}}class rH extends r_{constructor(){super()}async onEntry(){await super.onEntry(),m.log("Enter HeroTurnInteracting"),await rW()}async onEvent(e,t,r={}){switch(e){case rL.CLICKED_FREE_GROUND:{let e=await rZ(r.filter,r.occupant);e===tG.INTERACT_TILE?await rY(t):e===tG.OCCUPIED_TILE?await rX(r.occupant):await this.#tH(t,{usePathFinder:r.filter!==tG.MOVE_OR_INTERACT_TILE}),0===n.traits.get("HP",0)?this.transitionTo(new rz):0===eo.getTileMap().getParticipants(n).length?this.transitionTo(new rF):this.transitionTo(new r$)}break;case rL.CLICKED_ENTRANCE:eJ.showOkDialog(eY`MESSAGE ENTRANCE STUCK`);break;case rL.CLICKED_EXIT:await this.#tH(t,{usePathFinder:!1}).then(e=>e?eJ.showOkDialog(eY`MESSAGE OPEN EXIT WHILE FIGHTING`).then(()=>rq(this)):Promise.resolve())}return Promise.resolve(null)}#tH(e,t={usePathFinder:!0}){let r=eo.getTileMap(),i=r.getParticipants(n),s=!1;for(let e of i)if(e.alive&&e.interaction.respectDisengage(n)){s=!0;break}let a=r.worldPointToGrid(n.position),o=r.worldPointToGrid(e),l=a.getOrthoSeparation(o);return s&&l<=2&&(n.disengaging=!0),rV(e,t).then(()=>!0)}}class rF extends r_{constructor(){super()}async onEntry(){await super.onEntry(),m.log("Enter ComputerTurnIdle"),await rK();let e=eo.getTileMap(),t=new tB(e),r=new rD(e,t,n.disengaging);for(let e of eo.getActors().values())e!==n&&e.alive&&(!e.isWandering()||e3(6)>3)&&r.addAndMoveActor(e);for(let e of eo.getOrganicActors().values())e.alive&&r.addAndMoveActor(e);for(let t of(await r.replay(),e.getParticipants(n)))if(t.isEnemy())return this.transitionTo(new rH),Promise.resolve(null);this.transitionTo(new rU)}}class r$ extends r_{constructor(){super()}async onEntry(){await super.onEntry(),m.log("Enter ComputerTurnInteracting"),await rK();let e=eo.getTileMap(),t=new tB(e),r=new rD(e,t,n.disengaging),i=e.getParticipants(n);for(let e of eo.getActors().values())e!==n&&e.alive&&e.interaction&&(i.includes(e)&&e.willInteract()?await e.interaction.enact(n):r.addAndMoveActor(e));for(let e of eo.getOrganicActors().values())e.alive&&r.addAndMoveActor(e);return await r.replay(),0===n.traits.get("HP",0)?this.transitionTo(new rz):0===i.length?this.transitionTo(new rU):this.transitionTo(new rH),Promise.resolve(null)}}function rW(){n.disengaging=!1;let e=eo.getTileMap(),t=new tB(e,n).getAllRoutesFrom(e.worldPointToGrid(n.sprite.position),n.maxTilesPerMove);return e.setMovementRoutes(t),e.setInteractActors(e.getParticipants(n)),e.calcReachableDoors(n.position),Promise.resolve(null)}function rV(e,t={usePathFinder:!0}){let r;let i=eo.getTileMap();return(r=t.usePathFinder?i.getWaypointsToWorldPoint(e):[n.position,e],i.setMovementRoutes(null),i.setInteractActors(null),r)?new eL({path:r,speed:100},n.sprite.modifier).applyAsTransientToSprite(n.sprite):Promise.resolve()}function rK(){let e=eo.getTileMap(),t=[];return eo.getOrganicActors().forEach(r=>{e.getCoincidentActors(r).forEach(e=>{e.alive&&!e.isOrganic()&&r.interaction&&t.push(r.interaction.enact(e))})}),Promise.all(t)}function rY(e){let t=eo.getTileMap().getTileAtWorldPoint(e).getOccupants(),r=[];for(let e of t.values())e.interaction&&r.push(e.interaction.react(n));return Promise.all(r)}function rq(e){return(rM&&t8(n),io.areThereMoreScenes())?io.unloadCurrentScene().then(()=>(function(e){let t=eV("div");t.appendChild(eV("p",{text:eY`MESSAGE REST DIALOG`}));let r=eV("ul");return t.appendChild(r),r.appendChild(eV("li",{text:eY`SHORT REST REQ ${1} ${1}`})),r.appendChild(eV("li",{text:eY`LONG REST REQ ${1} ${3}`})),iO(e,{allowConsumption:!0,allowRest:!0,description:t,okButtonLabel:eY`BUTTON TO NEXT ROOM`})})(n)).then(()=>io.switchToNextScene()).then(e=>(n.sprite.position=eo.getTileMap().getWorldPositionOfTileByEntry(),e)).then(e=>e.intro?eJ.showOkDialog(e.intro,{className:"mask"}):void 0).then(()=>e.transitionTo(new rU)):e.transitionTo(new rG)}function rX(e){return e?e.isHiddenArtefact()?eJ.showOkDialog(eY`MESSAGE GROUND DISTURBED`):iO(e,{allowConsumption:e.isHero(),allowMagicUse:e.isHero()}):(m.error("Clicked on tile but no occupant to view."),Promise.resolve())}function rZ(e,t){if(e===tG.MOVE_OR_INTERACT_TILE){if(t?.isHiddenArtefact()){let e=t.storeManager.getFirstStorageDetails();return e?.artefact?tG.INTERACT_TILE:tG.MOVEMENT_TILE}return eJ.showChoiceDialog(eY`DIALOG TITLE CHOICES`,eY`MESSAGE SEARCH OR MOVE`,[eY`BUTTON CLIMB OVER`,eY`BUTTON SEARCH`]).then(e=>0===e?tG.MOVEMENT_TILE:tG.INTERACT_TILE)}return e}let rj=new class extends r_{onEntry(){m.log("WaitingToStart state")}async onEvent(e,t,r){e===rL.MAIN_MENU&&this.transitionTo(new rB)}},rQ=!1;var rJ={EventId:rL,getHeroActor:function(){return n},setHero:function(e){n=e},triggerEvent:function(e,t,r){if(rQ){m.debug(`Ignoring event ${e} as still processing earlier event.`);return}rQ=!0,rj.onEvent(e,t,r).then(()=>{rQ=!1})}};function r4(e){return{role:tU.GROUND,onClick:(e,t,r)=>rJ.triggerEvent(rJ.EventId.CLICKED_FREE_GROUND,t,r),image:e}}function r0(e){return{role:tU.ENTRANCE,onClick:(e,t,r)=>rJ.triggerEvent(rJ.EventId.CLICKED_ENTRANCE,t,r),image:e}}function r1(e){return{role:tU.EXIT,onClick:(e,t,r)=>rJ.triggerEvent(rJ.EventId.CLICKED_EXIT,t,r),image:e}}const r8=new Map([["x",{role:tU.OBSTACLE,image:"block.png"}],["#-TL",{role:tU.OBSTACLE,image:"wall-TL.png"}],["#-TLI",{role:tU.OBSTACLE,image:"wall-TLI.png"}],["#-T",{role:tU.OBSTACLE,image:"wall-T.png"}],["#-TR",{role:tU.OBSTACLE,image:"wall-TR.png"}],["#-TRI",{role:tU.OBSTACLE,image:"wall-TRI.png"}],["#-R",{role:tU.OBSTACLE,image:"wall-R.png"}],["#-BR",{role:tU.OBSTACLE,image:"wall-BR.png"}],["#-BRI",{role:tU.OBSTACLE,image:"wall-BRI.png"}],["#-B",{role:tU.OBSTACLE,image:"wall-B.png"}],["#-BL",{role:tU.OBSTACLE,image:"wall-BL.png"}],["#-BLI",{role:tU.OBSTACLE,image:"wall-BLI.png"}],["#-L",{role:tU.OBSTACLE,image:"wall-L.png"}],["#-XI",{role:tU.OBSTACLE,image:"wall-XI.png"}],["#-VI",{role:tU.OBSTACLE,image:"wall-VI.png"}],["#-HI",{role:tU.OBSTACLE,image:"wall-HI.png"}],["#-TTEE",{role:tU.OBSTACLE,image:"wall-TTEE.png"}],["#-RTEE",{role:tU.OBSTACLE,image:"wall-RTEE.png"}],["#-BTEE",{role:tU.OBSTACLE,image:"wall-BTEE.png"}],["#-LTEE",{role:tU.OBSTACLE,image:"wall-LTEE.png"}],["#",{role:tU.OBSTACLE,image:"block.png"}],["=-T",r1("door-T.png")],["=-R",r1("door-R.png")],["=-B",r1("door-B.png")],["=-L",r1("door-L.png")],["--T",r0("door-T.png")],["--R",r0("door-R.png")],["--B",r0("door-B.png")],["--L",r0("door-L.png")],["=",{role:tU.OBSTACLE,image:"block.png"}],["-",{role:tU.OBSTACLE,image:"block.png"}],[".",r4("floor.png")],[".-SBW",r4("floor-SBW.png")],[".-SBE",r4("floor-SBE.png")],[",-SBE",r4("floor2-SBE.png")],[",-SBW",r4("floor2-SBW.png")],[",",r4("floor2.png")]]);class r2{#tF;#H;#t$;#tW;#tV;heroActor;intro;constructor(e=2,t=2){e>0?(this.#tF=0,this.#H=1/e):this.#H=1,this.#t$=e,this.#tW=t}getOpacity(){return this.#tF}load(){return this.doLoad()}initialise(){return this.doInitialise()}update(e){Q.clearCanvas(),Q.setOpacity(this.#tF),eo.update(e),this.doUpdate(e),Q.setOpacity(1),0!==this.#H&&(this.#tF+=e*this.#H,this.#tF>1?(this.#H=0,this.#tF=1):this.#tF<0&&(this.#H=0,this.#tF=0)),this.#tV&&0===this.#tF&&(this.#tV(),this.#tV=null)}unload(){return this.#tK().then(()=>this.doUnload())}#tK(){return this.#tW>0?(this.#H=-1/this.#tW,new Promise(e=>{this.#tV=e})):Promise.resolve()}doLoad(){return Promise.resolve()}doInitialise(){return Promise.resolve()}doUpdate(e){return Promise.resolve()}doUnload(){return Promise.resolve()}}const r3=eB.TILE_SIZE;function r5(e,t,r){if(t){let i=tu(t);r.equip&&i.equipStoreType?e.storeManager?.equip(i,{direct:!0}):e.storeManager?.stash(i,{direct:!0})}}class r6 extends r2{#tY;constructor(e){super(),this.#tY=e,this.intro=e.intro}doLoad(){return Promise.resolve()}doInitialise(){let e=tP.generateTileMapPlan(this.#tY.mapDesign,r8);this.heroActor=function(e){if(e.hero instanceof iF)s=e.hero;else if(e.hero)s=t0(e.hero);else if(!s)throw Error("No hero has been defined.");return s}(this.#tY);let t=new tF(Q.getContext2D(),e,r3,this.heroActor);eo.setTileMap(t);let r=tw.getPooledAlmanac(["ARTEFACTS","ARMOUR","WEAPONS"],e=>e.minLevel<=io.getCurrentSceneLevel()),i=r.find(e=>"waterskin"===e.id),n=r.find(e=>"iron_rations"===e.id);return(function(e){let t=[];return e.enemies.forEach(e=>{let r=t0(e);t.push(r)}),t})(this.#tY).forEach(e=>{if(e.position=t.getRandomFreeGroundTile().worldPoint,eo.addActor(e),e.isTrader()){let t=7;e3(6)>3&&(r5(e,i,{equip:!1}),t--),e3(6)>3&&(r5(e,n,{equip:!1}),t--),function(e,t,r){for(;r.qty-- >0;)r5(e,t.getRandomEntry(),r)}(e,r,{qty:t,equip:!1})}}),(function(e){let t=[];return e.artefacts.forEach(e=>{let r,i;e.type===ty.SPELL||e.type===ty.CANTRIP?(r="engraved_pillar",i=iG.PROP):(r="hidden_artefact",i=iG.HIDDEN_ARTEFACT);let n=t0({id:r,name:td(r),description:tp(r),imageName:r,type:i,traitsString:""}),s=tu(e);n.storeManager.addArtefact(s),t.push(n)}),t})(this.#tY).forEach(e=>{e.position=t.getRandomFreeGroundTile().worldPoint,eo.addArtefact(e)}),io.setCameraToTrack(this.heroActor.sprite,200,0),eo.addActor(this.heroActor),rJ.setHero(this.heroActor),Promise.resolve()}doUpdate(e){}doUnload(){return Promise.resolve(null)}}const r9={OFF:0,HERO:1,VELOCITY:2};class r7{#tq;#tX;#tZ;#tj;constructor(e,t,r=0){let i=Q.getCanvasDimensions(),n=r*Math.min(i.width,i.height);this.#tq=new eI,this.#tX=new ev({prey:e,speed:t,maxSeparation:n}),this.#tZ=new eP,this.#tX.applyAsContinuousToSprite(this.#tq)}update(e){this.#tj!==r9.OFF&&(this.#tq.update(e),Q.centreCanvasOn(this.#tq.position))}setVelocity(e,t){this.setTrackingMethod(r9.VELOCITY),this.#tq.velocity.x=e,this.#tq.velocity.y=t}panBy(e,t){this.#tq.position.x+=e,this.#tq.position.y+=t,Q.centreCanvasOn(this.#tq.position)}setTrackingMethod(e){if(e!==this.#tj)switch(this.#tj=e,e){case r9.HERO:this.#tX.applyAsContinuousToSprite(this.#tq);break;case r9.VELOCITY:this.#tZ.applyAsContinuousToSprite(this.#tq);break;case r9.OFF:break;default:m.error(`Attempt to set invalid tracking method of ${e} ignored.`)}}}const ie={TR:0,BR:1,BL:2,TL:3};class it{#tQ;#tJ;#t4;#t0;#t1;constructor(e,t,r,i){this.#tQ=e,this.#t8(t,r,!1),this.#t2(t,i)}#t2(e,t){this.#t1=new eS({prefix:"hud-fullscreen",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:ef.STOP}),this.#t3(),this.#t0=iY.addButton(this.#t1,()=>{this.#t5(document.body,{navigationUI:"hide"})},()=>{document.exitFullscreen()});let r=this.#t6(e,t,1);this.#t0.position.x=r.x,this.#t0.position.y=r.y,addEventListener("fullscreenchange",()=>{this.#t3()})}#t3(){document.fullscreenElement?this.#t1.setCurrentIndex(1):this.#t1.setCurrentIndex(0)}#t5(e,t){return e.requestFullscreen?e.requestFullscreen(t):Promise.reject(Error("Fullscreen requests not supported by browser"))}#t6(e,t,r){let i=new O(0,0);switch(t){case ie.TL:i.x=r*e,i.y=r*e;break;case ie.TR:i.x=-r*e,i.y=r*e;break;case ie.BR:i.x=-r*e,i.y=-r*e;break;case ie.BL:i.x=r*e,i.y=-r*e}return i}#t8(e,t,r){let i=this.#t6(e,t,r?2:1);this.#t9(i.x,i.y),r&&this.#t7(i.x,i.y,e)}#t9(e,t){this.#t4=new eS({prefix:"hud-auto-centre",startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:ef.STOP}),this.#tJ=iY.addButton(this.#t4,()=>{this.setTrackingState(!0)},()=>{this.setTrackingState(!1)}),this.#tJ.position.x=e,this.#tJ.position.y=t,this.#tJ.actionClick(null)}setTrackingState(e){e?(this.#t4.setCurrentIndex(1),this.#tQ.setTrackingMethod(r9.HERO)):(this.#t4.setCurrentIndex(0),this.#tQ.setTrackingMethod(r9.OFF))}#t7(e,t,r){let i=3*r;this.#re("hud-arrow-up",e,t-r,()=>{this.setTrackingState(!1),this.#tQ.setVelocity(0,-i)},()=>this.#tQ.setTrackingMethod(r9.OFF)),this.#re("hud-arrow-right",e+r,t,()=>{this.setTrackingState(!1),this.#tQ.setVelocity(i,0)},()=>this.#tQ.setTrackingMethod(r9.OFF)),this.#re("hud-arrow-down",e,t+r,()=>{this.setTrackingState(!1),this.#tQ.setVelocity(0,i)},()=>this.#tQ.setTrackingMethod(r9.OFF)),this.#re("hud-arrow-left",e-r,t,()=>{this.setTrackingState(!1),this.#tQ.setVelocity(-i,0)},()=>this.#tQ.setTrackingMethod(r9.OFF))}#re(e,t,r,i,n){let s=new eS({prefix:e,startIndex:0,padding:2,suffix:".png"},{framePeriodMs:1,loopMethod:ef.STOP}),a=iY.addMomentaryButton(s,i,n);a.position.x=t,a.position.y=r,s.setCurrentIndex(0)}}class ir{intro;hero;enemies;artefacts;mapDesign;constructor(){this.hero=null,this.enemies=[],this.artefacts=[],this.mapDesign=[]}}function ii(e){return e?is(l).then(()=>e.load().then(()=>e.initialise()).then(()=>{h=new it(a,48,ie.BR,ie.BL),iY.setVisible(!0),l=e})).then(()=>e):(m.error("Attempt made to switch to the next scene when there are no more."),Promise.reject())}function is(e){return e?e.unload().then(()=>(eo.clearAll(),l=null,h=null,iY.clear(),iY.setVisible(!1),Promise.resolve())):Promise.resolve(null)}function ia(){return new r6(o.getNext())}var io={areThereMoreScenes:function(){return o.hasNext()},continueFromSavedScene:function(e,t){return o.restore(e,t),ii(ia())},getCurrentSceneLevel:function(){return o.getIndex()},panCameraBy:function(e,t){a.panBy(e,t),a.setTrackingMethod(r9.OFF),h.setTrackingState(!1)},setCameraToTrack:function(e,t,r){a=new r7(e,t,r)},setSceneList:function(e){(o=e).reset()},switchToFirstScene:function(){return o.reset(),ii(ia())},switchToNextScene:function(){return ii(ia())},unloadCurrentScene:function(){return is(l)},update:function(e){l?.update(e),a?.update(e)}};function il(e,t){let r=e6(e.traits.get("DMG","1D4")),i=t.traits.getNonMeleeSaveAbilityModifier(e),n=e.traits.getInt("DC");return n?e3(20)+i>=n?0:r:(m.error(`Poisoner ${e.traits.get("NAME")} has no DC set.`),r)}function ih(e,t,r){switch(e){case"SHORT":return t>=1&&r>=1;case"LONG":return t>=3&&r>=1}return m.error(`Attempt to rest for unknown length of ${e}`),!1}function ic(e,t){switch(t){case"SHORT":{let t=e.traits.get("HIT_DICE"),r=e.traits.getInt("HP",0),i=e.traits.getInt("HP_MAX",r),n=e.traits.getAsModifier("CON"),s=e7(t);s.qty>0&&(s.qty--,r+=e3(s.sides)+n,e.traits.set("HP",Math.min(r,i)),e.traits.set("HIT_DICE",te(s)))}break;case"LONG":{let t=e.traits.getCharacterLevel(),r=e7(e.traits.get("HIT_DICE")),i=Math.max(1,Math.ceil(.5*r.qty));r.qty=Math.min(t,r.qty+i),e.traits.set("HIT_DICE",te(r)),e.traits.set("HP",e.traits.getInt("HP_MAX",0))}break;default:m.error(`Attempt to rest for unknown length of ${t}`)}}const iu={VIEW:0,SELL:1,PILLAGE:2,FIND:3},id={CONTINUE:"continue",CONSUME:"consume",LEAVE:"leave",LEARN_SPELL:"learn",DISCARD:"discard",EQUIP:"equip",PREPARE_SPELL:"prepare",STASH:"stash",TAKE:"take",SELL:"sell",PILLAGE:"pillage",USE:"use"},ip={STANDARD:"standard",STASH_ONLY:"stash",SPELLS:"spells",MAGIC:"magic",READY_MAGIC:"ready magic",CANTRIPS:"cantrips"};class im{#rt;#rr;#ri;linkedInventory;#rn;constructor(e,t={}){this.#rt=e,this.#rr=t,this.#ri=eV("div",{className:"stores"}),this.refresh()}get element(){return this.#ri}get actionButtons(){return this.#rn}refresh(e){this.#rn=[],!e&&this.linkedInventory&&this.linkedInventory.refresh(!0),this.#ri.replaceChildren(),(!this.#rt.currentOwner.isHero()||this.#rt.currentOwner.alive)&&this.#rs().forEach(e=>{let t=this.#rt.currentOwner.storeManager.getStoreContents(e.storeType);if(t){let r=this.#ra(e.label,e.storeType,t);this.#ri.appendChild(r)}}),this.#rr.onRefresh&&this.#rr.onRefresh()}#rs(){let e;switch(this.#rr.limitation){case ip.SPELLS:e=[{label:eY`Prepared spells`,storeType:tE.PREPARED_SPELLS},{label:eY`Known spells`,storeType:tE.SPELLS}];break;case ip.MAGIC:e=[{label:eY`Cantrips`,storeType:tE.CANTRIPS},{label:eY`Prepared spells`,storeType:tE.PREPARED_SPELLS},{label:eY`Known spells`,storeType:tE.SPELLS}];break;case ip.READY_MAGIC:e=[{label:eY`Ready magic`,storeType:tE.PREPARED_SPELLS},{label:eY`Cantrips`,storeType:tE.CANTRIPS}];break;case ip.CANTRIPS:tE.CANTRIPS;break;case ip.STASH_ONLY:e=[this.#ro()];break;case ip.STANDARD:default:e=[{label:eY`Purse`,storeType:tE.PURSE},{label:eY`Head`,storeType:tE.HEAD},{label:eY`Body`,storeType:tE.BODY},{label:eY`Hands`,storeType:tE.HANDS},{label:eY`Feet`,storeType:tE.FEET},this.#ro()]}return e}#ro(){return this.#rt.currentOwner.isTrader()?{label:eY`Wagon`,storeType:tE.WAGON}:{label:eY`Backpack`,storeType:tE.BACKPACK}}#ra(e,t,r){let i=eV("div",{className:"store"});i.appendChild(eV("span",{className:"store-label",text:e}));let n=eV("div",{className:"store-contents"});return i.appendChild(n),[...r].sort((e,t)=>e.id<t.id).forEach(e=>{let r={...this.#rt};r.refresh=this.refresh.bind(this),r.storeType=t,r.artefact=e;let i=this.#rl(r);null!==i.closes&&void 0!==i.closes&&this.#rn.push(i),n.appendChild(i.element)}),i}#rl(e){let t,r;let i=function(e){let t=e.artefact.traits,r=t.get("NAME");if(e.showDamage){let i=t.getDamageDiceWhenCastBy?t.getDamageDiceWhenCastBy(e.currentOwner):t.get("DMG"),n=t.get("RANGE");i&&(r=`${r} DMG: ${i}`),n&&(r=`${r} RANGE: ${n}`)}if(e.showPrice||e.artefact.artefactType===ty.COINS){let t=e.currentOwner.isTrader()?e.artefact.costInGp:e.artefact.sellBackPriceInGp;r=`${r} ${t.toFixed(2)} GP`}return r}(e);return e.customAction?(t=()=>e.customAction(e.currentOwner,e.artefact),r=eX.OK):t=async()=>{await iR(e).then(()=>e.refresh?.())},new eU({rightLabel:i,imageName:e.artefact.iconImageName,action:t,closes:r})}}function ig(e,t,r){r>t.length&&m.error("Attempt being made to discard more items than provided in array.");for(let i=0;i<r&&i<t.length;i++)e.take(t[i])||m.error(`Trying to take artefact ${t[i]}, but none found.`)}function iS(e,t={}){let r=eV("div",{className:"inventory"}),i=eV("div",{className:"actor-container"});r.appendChild(i),i.appendChild(iC(e,{hideDescription:!0,hideTraits:!0}));let n=new im({currentOwner:e,prospectiveOwner:e,allowMagicUse:t.allowMagicUse,allowConsumption:t.allowConsumption},{limitation:t.limitation,onRefresh:()=>i.replaceChildren(iC(e,{hideDescription:!0,hideTraits:!0}))});return r.appendChild(n.element),eJ.showControlsDialog(r)}function iw(e,t){if(t.artefact.artefactType===ty.COINS)return;let r=[];switch(t.artefact.artefactType){case ty.SPELL:r=function(e){let t=[],r=e.artefact;return e.allowMagicUse?t.push(new eG({label:iy(e.artefact),closes:id.USE})):e.storeType===r.stashStoreType&&e.allowSpellPrep&&t.push(new eG({label:eY`BUTTON PREPARE SPELL`,closes:id.PREPARE_SPELL})),e.allowSpellPrep&&t.push(new eG({label:eY`BUTTON FORGET`,closes:id.DISCARD})),t}(t);break;case ty.CANTRIP:r=function(e){let t=[];return e.allowMagicUse&&t.push(new eG({label:iy(e.artefact),closes:id.USE})),t.push(new eG({label:eY`Forget`,closes:id.DISCARD})),t}(t);break;case ty.CONSUMABLE:r=function(e){let t=[];return iE(e)&&t.push(new eG({label:iy(e.artefact),closes:id.CONSUME})),t.push(new eG({label:eY`BUTTON DISCARD`,closes:id.DISCARD})),t}(t);break;default:r=function(e){let t=[];return iE(e)?t.push(new eG({label:iy(e.artefact),closes:id.USE})):e.storeType===e.artefact.stashStoreType&&e.artefact.equipStoreType?t.push(new eG({label:eY`BUTTON EQUIP`,closes:id.EQUIP})):e.storeType===e.artefact.equipStoreType&&(!e.artefact.stashInWagon||e.currentOwner.storeManager.hasWagon)&&t.push(new eG({label:eY`BUTTON STASH`,closes:id.STASH})),t.push(new eG({label:e.artefact.isMagic()?eY`Forget`:eY`BUTTON DISCARD`,closes:id.DISCARD})),t}(t)}return r.push(new eG({label:eY`BUTTON CONTINUE`,closes:id.CONTINUE})),r}function iE(e){let t=e.artefact;return!!t.isUsable()&&(t.isMagic()?e.allowMagicUse:t.isConsumable()?e.allowConsumption:void 0)}function iy(e){switch(e.artefactType){case ty.CONSUMABLE:return eY`BUTTON CONSUME`;case ty.SPELL:case ty.CANTRIP:return eY`BUTTON CAST SPELL`;default:return eY`BUTTON USE`}}function iT(e){return eV("p",{className:"guidance",text:e.artefact.stashInWagon?eY`MESSAGE MAKE SPACE IN EQUIP`:eY`MESSAGE MAKE SPACE IN BACKPACK`})}function ix(e){let t=e.artefact,r=eV("div",{className:"use-weapon-dialog"});r.appendChild(iC(t));let i=function(e,t){if(t.currentOwner===t.prospectiveOwner||!t.prospectiveOwner)return iw(e,t);switch(t.actionType){case iu.FIND:return function(e,t){let r;let i=[],n=t.prospectiveOwner.storeManager.findSuitableStore(t.artefact);if(n){let e,t;n.storeType===tE.CANTRIPS||n.storeType===tE.SPELLS||n.storeType===tE.READY_SPELLS?(e=eY`BUTTON LEARN SPELL`,t=id.LEARN_SPELL):(e=eY`BUTTON TAKE ARTEFACT`,t=id.TAKE),r=new eG({label:e,closes:t}),i.push(r)}else e.appendChild(iT(t));return r=new eG({label:eY`BUTTON LEAVE ARTEFACT`,closes:id.LEAVE}),i.push(r),i}(e,t);case iu.SELL:return function(e,t){let r;if(t.artefact.artefactType===ty.COINS)return;let i=[],n=t.artefact.costInGp;if(r=t.prospectiveOwner.isTrader()?Number.MAX_SAFE_INTEGER:t.prospectiveOwner.storeManager.getPurseValue(),!t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)){e.appendChild(iT(t)),t.currentOwner.isTrader()||iw(e,t);return}if(r<t.artefact.costInGp){e.appendChild(eV("p",{className:"guidance",text:eY`MESSAGE INSUFFICIENT FUNDS ${n} ${r}`})),t.currentOwner.isTrader()||iw(e,t);return}return i.push(new eG({label:t.currentOwner.isTrader()?eY`BUTTON BUY FOR GP ${t.artefact.costInGp.toFixed(2)}`:eY`BUTTON SELL FOR GP ${t.artefact.sellBackPriceInGp.toFixed(2)}`,closes:id.SELL})),i.push(new eG({label:eY`BUTTON CONTINUE`,closes:id.CONTINUE})),i}(e,t);case iu.PILLAGE:return function(e,t){if(t.currentOwner.alive)return iw(e,t);let r=[];if(!t.prospectiveOwner.storeManager.findSuitableStore(t.artefact)){e.appendChild(iT(t)),t.currentOwner.alive&&iw(e,t);return}let i=new eG({label:eY`BUTTON PILLAGE`,closes:id.PILLAGE});return r.push(i),r.push(i=new eG({label:eY`BUTTON LEAVE ARTEFACT`,closes:id.CONTINUE})),r}(e,t);case iu.VIEW:default:return[]}}(r,e);return eJ.showControlsDialog(r,{preamble:e.preamble,actionButtons:i,row:!0})}function iA(e){let t=eV("div",{className:"actor-id-card"});t.appendChild(eH(e.iconImageName)),t.appendChild(eV("span",{text:e.traits?.get("NAME")??eY`Unknown`}));let r=e.traits.getInt("HP");if(r){let i;let n=e.traits.getInt("HP_MAX");i=0===r?eY`(DEAD)`:n?eY`(HP OUT OF VALUE) ${r} ${n}`:eY`(HP VALUE) ${r}`,t.appendChild(eV("span",{text:i}))}return e.traits.getCharacterLevel&&t.appendChild(eV("span",{text:eY`CHARACTER LEVEL: ${e.traits.getCharacterLevel()}`})),t}function iC(e,t={}){let r;let i=eV("div",{className:"actor-detail"}),n=iA(e);return i.appendChild(n),!t.hideDescription&&(t.description?r=t.description instanceof Element?t.description:eV("p",{text:t.description}):e.description&&(r=eV("p",{text:e.description}))),r&&i.appendChild(r),t.hideTraits||i.appendChild(function(e,t,r){let i=document.createElement("ul");if(e.traits.getEffectiveAc&&i.appendChild(eV("li",{text:eY`AC (including armour)${e.traits.getEffectiveAc()}`})),r){let t=e.storeManager?.getPurseValue();t&&i.appendChild(eV("li",{text:`${t.toFixed(2)}\u{00A0}GP`}))}return e.traits?.getAllTraitsSorted().forEach((e,r)=>{if(e&&"0"!==e){let n=Array.isArray(e)?e.join(", "):e;if(!t.includes(r)&&!r.startsWith("_")){let e=r?.replace("_"," "),t=document.createElement("li"),s=eV("span",{text:`${e}: `}),a=eV("span",{text:n});i.appendChild(t),t.appendChild(s),t.appendChild(a)}}}),i}(e,["NAME"],!0)),i}function iI(e,t,r){let i=eV("div",{className:"trade"}),n=eV("div",{className:"side-by-side"});i.appendChild(n);let s=eV("div",{}),a=eV("div",{});n.appendChild(s),n.appendChild(a),s.appendChild(iA(e)),a.appendChild(iA(t));let o=r?iu.PILLAGE:iu.SELL,l=new im({currentOwner:e,prospectiveOwner:t,actionType:o,showPrice:!0}),h=new im({currentOwner:t,prospectiveOwner:e,actionType:o,showPrice:!0},{limitation:r?ip.STANDARD:ip.STASH_ONLY});l.linkedInventory=h,h.linkedInventory=l,s.appendChild(l.element),a.appendChild(h.element);let c=new eG({label:eY`BUTTON CONTINUE`});c.closes=eX.CANCEL;let u=[];return u.push(c),eJ.showControlsDialog(i,{preamble:r?eY`DIALOG TITLE PILLAGE`:eY`DIALOG TITLE TRADE`,actionButtons:u})}function iO(e,t={}){let r,i;let n=document.createElement("div");n.appendChild(eV("span",{text:eY`Dungeon level: ${io.getCurrentSceneLevel()}`}));let s=eV("div",{className:"actor-container"});n.appendChild(s);let a=iC(e,{hideTraits:!0,description:t.description});return s.appendChild(a),!e.isProp()&&(r=new eG({label:eY`BUTTON INVENTORY`,action:()=>iS(e,{allowConsumption:t.allowConsumption,allowMagicUse:t.allowMagicUse}).then(()=>s.replaceChildren(iC(e,{hideTraits:!0,description:t.description})))}),n.appendChild(r.element),r=new eG({label:eY`BUTTON TRAITS`,action:()=>(function(e){let t=document.createElement("div");return t.appendChild(iC(e,{hideDescription:!0})),eJ.showControlsDialog(t)})(e)}),n.appendChild(r.element),r=new eG({label:eY`BUTTON MAGIC`,action:()=>iS(e,{allowMagicUse:!1,limitation:ip.MAGIC})}),n.appendChild(r.element),t.allowRest&&(r=new eG({label:eY`BUTTON REST`,action:()=>(function(e){let t;let r=e.storeManager.getStore(tE.BACKPACK),i=[],n=[];r.values().forEach(e=>{if(e.artefactType===ty.CONSUMABLE){let t=e.traits.get("TYPE");"MEAL"===t?i.push(e):"DRINK"===t&&n.push(e)}});let s=document.createElement("div");s.appendChild(iA(e));let a=ih("LONG",i.length,n.length),o=ih("SHORT",i.length,n.length),l=[];s.appendChild(eV("p",{text:eY`MESSAGE EXPLAIN REST`})),a||o?a||(t=eY`MESSAGE CANNOT REST LONG`):t=eY`MESSAGE CANNOT REST`,s.appendChild(eV("p",{text:t}));let h=-1,c=-1;return o&&(h=l.length,l.push(eY`BUTTON REST SHORT`)),a&&(c=l.length,l.push(eY`BUTTON REST LONG`)),l.push(eY`BUTTON CONTINUE`),eJ.showChoiceDialog(eY`DIALOG TITLE CHOICES`,s,l).then(t=>{if(t===h)ig(r,i,1),ig(r,n,1),ic(e,"SHORT");else if(t===c)return ig(r,i,3),ig(r,n,1),ic(e,"LONG"),function(e){let t=eV("div",{className:"inventory"});t.appendChild(iC(e,{hideDescription:!0,hideTraits:!0}));let r=new im({currentOwner:e,prospectiveOwner:e,allowSpellPrep:!0},{limitation:ip.SPELLS});return t.appendChild(r.element),eJ.showControlsDialog(t,{title:eY`DIALOG TITLE PREPARE SPELLS`,preamble:eY`MESSAGE EXPLAIN SPELL PREP`})}(e)})})(e).then(()=>a.replaceWith(iC(e,{hideTraits:!0})))}),n.appendChild(r.element)),t.allowMagicUse&&(i=i??[],(r=new eG({label:eY`BUTTON CAST SPELL`})).closes="CAST SPELL",i.push(r))),i&&((r=new eG({label:eY`BUTTON CONTINUE`})).closes=eX.CANCEL,i.push(r)),eJ.showControlsDialog(n,{okButtonLabel:t.okButtonLabel,actionButtons:i}).then(t=>"CAST SPELL"===t?function(e){let t=eV("div",{className:"inventory"}),r=new im({currentOwner:e,prospectiveOwner:e,allowMagicUse:!0,showDamage:!0,customAction:(e,t)=>t.interaction.react(e)},{limitation:ip.READY_MAGIC});t.appendChild(r.element);let i=new eG({label:eY`BUTTON CONTINUE`,closes:eX.CANCEL});return eJ.showControlsDialog(t,{title:eY`DIALOG TITLE PICK SPELL TO CAST`,actionButtons:[...r.actionButtons,i]})}(e):Promise.resolve())}function iR(e){let t;e.prospectiveOwner||(e.prospectiveOwner=e.currentOwner);let r=e.currentOwner.storeManager,i=e.prospectiveOwner.storeManager,n=e.artefact;switch(e.artefact.artefactType){case ty.WEAPON:case ty.TWO_HANDED_WEAPON:case ty.HEAD_GEAR:case ty.ARMOUR:case ty.SHIELD:case ty.COINS:case ty.CONSUMABLE:case ty.SPELL:case ty.CANTRIP:t=ix}return t(e).then(t=>{switch(t){case id.CONSUME:return r.discard(n),n.interaction.react(e.currentOwner);case id.DISCARD:r.discard(n);break;case id.PREPARE_SPELL:case id.EQUIP:i.equip(n);break;case id.LEARN_SPELL:if(n.isMagic()&&i.hasArtefactWithSameId(n))return eJ.showOkDialog(eY`MESSAGE SPELL ALREADY KNOWN`);r.discard(n),i.findSuitableStore(n).add(n);break;case id.PILLAGE:r.discard(n),i.findSuitableStore(n).add(n);break;case id.SELL:{let t=e.currentOwner.isTrader()?n.costInGp:n.sellBackPriceInGp;r.addToPurse(t),e.prospectiveOwner.isTrader()||i.takeFromPurse(t),r.discard(n),n.stashInWagon&&!i.hasWagon?i.equip(n,{direct:!0}):i.stash(n,{direct:!0})}break;case id.STASH:i.stash(n);break;case id.TAKE:r.discard(n),n.stashInWagon&&!i.hasWagon?i.equip(n,{direct:!0}):i.stash(n,{direct:!0});break;case id.USE:return n.interaction.react(e.currentOwner)}return Promise.resolve()})}function iN(e,t,r="white"){e_(e,{color:r,delaySecs:2,lifetimeSecs:3,position:new O(t.x,t.y),velocity:new R(0,-48,0),acceleration:new N(0,-96,0)})}function iP(e,t,r){if(e4.playEffect("POISONED"),r>=0)return eD(ed.getSpriteBitmap("skull.png"),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new R(0,0,0)}),iv(e,t,r)}function iv(e,t,r){if(!r||!t.alive||t.isProp()||t.isHiddenArtefact())return 0;let i=t.traits.get("HP",0);if(i=Math.max(0,i-r),t.traits.set("HP",i),0===i){if(e4.playEffect("DIE"),m.info("Killed actor."),t.interaction=new ib(t),t.alive=!1,e.isHero?.()){let r;let i=e.traits.adjustForDefeatOfActor(t);i.level.now>i.level.was?r=eY`LEVEL UP ${i.level.now}`:i.exp.now>i.exp.was&&(r=`+${i.exp.now-i.exp.was} EXP`),r&&iN(r,e.position,tz.HP_TRANSIENT_TEXT_HERO)}}else{let e=t.isHero()?tz.HP_TRANSIENT_TEXT_HERO:tz.HP_TRANSIENT_TEXT_ENEMY;iN(`-${r} HP`,t.position,e)}return i}class iL{owner;constructor(e){this.owner=e}enact(e){return Promise.resolve()}react(e){return Promise.resolve()}canReact(){return!1}canEnact(){return!1}respectDisengage(e){return!1}}class iM extends iL{constructor(e){super(e)}canEnact(){return!0}canReact(){return!0}enact(e){return this.#rh(this.owner,e)}react(e){return this.#rh(e,this.owner)}respectDisengage(e){return!0}#rc(e,t){let r=O.copy(e.position);return new eL({path:[new O(e.position.x+.2*(t.position.x-e.position.x),e.position.y+.2*(t.position.y-e.position.y)),r],speed:100}).applyAsTransientToSprite(e.sprite)}#ru(e,t){let r=0,i=0;return e.traits.getAttacks().forEach(e=>{let n=function(e,t){let r=e3(20);if(1===r)return m.debug("Attack dice rolled 0: cursed."),0;if(20===r)return m.debug("Attack dice rolled 20: critical hit."),2*e.rollForDamage();let i=r+e.abilityModifier+e.proficiencyBonus,n=t.traits.getEffectiveAc();return(m.debug(`Attack: dice: ${r}, ability modifier: ${e.abilityModifier}, proficiency bonus: ${e.proficiencyBonus}, target AC: ${n}`),i>=n)?e.rollForDamage():0}(e,t);n>0&&(i++,r+=n)}),new Promise(n=>{if(r<=0){e4.playEffect("MISS"),eD(ed.getSpriteBitmap("miss.png"),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new R(0,0,0)}),n();return}let s=i>1?"DOUBLE PUNCH":"PUNCH",a=i>1?"blood-splat-twice.png":"blood-splat.png";e4.playEffect(s),eD(ed.getSpriteBitmap(a),{delaySecs:0,lifetimeSecs:1,position:t.position,velocity:new R(0,0,0)}),n(iv(e,t,r))})}#rh(e,t){return this.#rc(e,t).then(()=>this.#ru(e,t))}}class ib extends iL{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){return iI(e,this.owner,!0)}}class iD extends iL{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}react(e){return eJ.showChoiceDialog(eY`DIALOG TITLE CHOICES`,eY`MESSAGE TRADE OR BARGE`,[eY`BUTTON TRADE`,eY`BUTTON BARGE`]).then(t=>0!==t?this.#rd(e):iI(e,this.owner,!1))}#rd(e){let t=O.copy(this.owner.position),r=O.copy(e.position);return Promise.all([eM(e,t),eM(this.owner,r)])}}class i_ extends iL{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){this.owner.alive=!1;let t=this.owner.storeManager.getFirstStorageDetails();if(!t)return eJ.showOkDialog(eY`MESSAGE NOTHING MORE TO DISCOVER`);{let r=t.artefact;return iR({preamble:this.#rp(r),currentOwner:this.owner,prospectiveOwner:e,storeType:t.store.storeType,artefact:r,actionType:iu.FIND})}}#rp(e){return this.owner.type===iG.HIDDEN_ARTEFACT?eY`MESSAGE FOUND HIDDEN ARTEFACT`:e.artefactType===ty.SPELL?eY`MESSAGE FOUND ENGRAVING`:eY`MESSAGE FOUND GENERIC`}}class iB extends iL{constructor(e){super(e)}canEnact(){return!0}canReact(){return!1}enact(e){let t=il(this.owner,e);return iP(this.owner,e,t),Promise.resolve()}}class ik extends iL{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){let t=eo.getTileMap(),r=t.worldPointToGrid(e.position),i=this.owner.traits.getValueInFeetInTiles("RANGE",1),n=this.owner.traits.getInt("MAX_TARGETS",999),s=0;for(let a of t.getRadiatingUpAndDown(r,i)){if(s>n)break;this.#rm(a.worldPoint),a.getOccupants().forEach(t=>{if(t.isEnemy()||t.isTrader()){s++;let r=function(e,t,r){let i=e.traits.get("INT",1),n=t.traits.getNonMeleeSaveAbilityModifier(r),s=r.traits.getInt("DC");null==s&&(m.error(`Magic ${e.id} has no DC set.`),s=0);let a=s+(e.traits.getCharacterPb(r)+ta(i)),o=e3(20)+n,l=e6(r.traits.getDamageDiceWhenCastBy(e));return o>=a?Math.round(r.traits.getFloat("DMG_SAVED",0)*l):l}(e,t,this.owner);iv(e,t,r)}})}return this.owner.artefactType===ty.SPELL&&e.storeManager.stash(this.owner),Promise.resolve()}#rm(e){!function(e,t){let r=new eS({prefix:e,suffix:".png",startIndex:0,padding:2},{framePeriodMs:300,loopMethod:ef.REVERSE});eb(new eC(Q.getContext2D(),r),t)}(this.owner.traits.get("EFFECT").toLowerCase(),{position:e,delaySecs:0,lifetimeSecs:1})}}class iz extends iL{constructor(e){super(e)}canEnact(){return!1}canReact(){return!0}async react(e){let t=this.owner.traits.get("TYPE");if("POISON"===t){let t=il(this.owner,e);return 0===t?eJ.showOkDialog(eY`MESSAGE RESISTED POISON`):0>=iP(this.owner,e,t)?eJ.showOkDialog(eY`MESSAGE KILLED BY POISON`):eJ.showOkDialog(eY`MESSAGE IT'S POISON ${t}`)}{let r=this.owner.traits.getInt("HP",0);if(0===r)return eJ.showOkDialog(eY`MESSAGE CONSUME BUT NO HP GAIN`);let i=e.traits.getInt("HP"),n=e.traits.getInt("HP_MAX");if(!n)return m.error(`Actor ${e.traits.get("NAME")} has no HP_MAX set`),Promise.resolve();let s=n-i;if(s<0)return m.error(`Actor ${e.traits.get("NAME")} has HP higher than HP_MAX`),Promise.resolve();if(0===(r=Math.min(s,r)))return eJ.showOkDialog(eY`MESSAGE CONSUME BUT ALREADY FULL HP`);let a=i+r,o="POTION"===t?eY`MESSAGE IT'S A HEALTHY DRINK ${r}`:eY`MESSAGE IT'S HEALTHY ${r}`;return eJ.showOkDialog(o).then(()=>e.traits.set("HP",a))}}}const iG={HERO:0,ENEMY:1,ARTEFACT:2,HIDDEN_ARTEFACT:3,TRADER:4,PROP:5},iU={WANDER:"WANDER",HUNT:"HUNT",ORGANIC:"ORGANIC"};function iH(e){let t=iG[e];return null==t&&m.error(`Unrecognised actor type: ${e}`),t}class iF extends tD{almanacEntry;maxTilesPerMove;sprite;traits;interaction;alive;disengaging;description;iconImageName;storeManager;type;constructor(e,t=iG.ENEMY){super(),this.interaction=new iL,this.sprite=e,this.sprite.obstacle=!0,this.maxTilesPerMove=1,this.alive=!0,this.disengaging=!1,this.type=t,this.storeManager=new tI(t===iG.TRADER||t===iG.HIDDEN_ARTEFACT,()=>this.#rf())}#rf(){let e=this.storeManager.getAllEquippedArtefacts();this.traits.utiliseArtefacts(e)}isHero(){return this.type===iG.HERO}isEnemy(){return this.type===iG.ENEMY}isTrader(){return this.type===iG.TRADER}isHiddenArtefact(){return this.type===iG.HIDDEN_ARTEFACT}set visible(e){this.sprite.visible=e}get visible(){return this.sprite.visible}get obstacle(){return this.sprite.obstacle}set obstacle(e){this.sprite.obstacle=e}get position(){return this.sprite.position}set position(e){this.sprite.position=e}get velocity(){return this.sprite.velocity}set velocity(e){this.sprite.velocity=e}getImageFilename(){return this.sprite.getImageFilename()}isWandering(){return this?.traits.get("MOVE")===iU.WANDER}isOrganic(){return this?.traits.get("MOVE")===iU.ORGANIC}isProp(){return this?.type===iG.PROP}get moveType(){return this?.traits.get("MOVE")}willInteract(){return!!this.interaction&&(!this.isWandering()||e3(6)>3)}isPassableByActor(e){return!!(e.isHero()&&this.isHiddenArtefact())||!this.alive&&!this.isProp()||!this.obstacle}canShareLocationWithActor(e){return this.isOrganic()?!e.isOrganic()&&!e.isTrader():this.isHiddenArtefact()?e.isHero():!!(!this.alive&&e.isHero())||!this.obstacle}update(e){this.sprite.update(e)}actionClick(e){super.actionClick(this.sprite.position)}actionContextClick(e){super.actionContextClick(this.sprite.position)}actionPointerUp(e){super.actionPointerUp(this.sprite.position)}actionPointerDown(e){super.actionPointerDown(this.sprite.position)}}const i$=new Map;let iW=!1;function iV(e,t){let r=Q.glassPositionToWorld(t.position),i=t.sprite.getBoundingBox();return new v(r.x-i.width/2,r.y-i.height/2,i.width,i.height).containsCoordinate(e.world.x,e.world.y)}function iK(e){if(!iW||!iW)return!1;for(let[t,r]of i$)if(iV(e,r))return r.actionPointerUp(r,e.canvas),!0;return!1}var iY={addButton:function(e,t,r){let i=new iF(new eI({renderer:new eC(Q.getContext2D(),e)}));return i$.set(i,i),i.setOnClick(()=>{r?0===e.getCurrentIndex()?(e.setCurrentIndex(1),t()):(e.setCurrentIndex(0),r()):t()}),e.setCurrentIndex(0),i},addMomentaryButton:function(e,t,r){let i=new iF(new eI({renderer:new eC(Q.getContext2D(),e)}));return i$.set(i,i),i.setOnPointerDown(()=>{e.setCurrentIndex(1),t?.()}),i.setOnPointerUp(()=>{e.setCurrentIndex(0),r?.()}),i},clear:function(){i$.clear()},removeButton:function(e){i$.delete(e)},update:function(e){iW&&i$.forEach(t=>{let r=P.copy(t.position);t.position=Q.glassPositionToWorld(t.position),t.update(e),t.position=r})},resolvePointerCancel:function(e){return iK(e)},resolveClick:function(e){if(!iW)return!1;for(let[t,r]of i$)if(iV(e,r))return r.actionClick(r,e.canvas),!0;return!1},resolveContextMenu:function(e){return!1},resolvePointerDown:function(e){if(!iW||!iW)return!1;for(let[t,r]of i$)if(iV(e,r))return r.actionPointerDown(r,e.canvas),!0;return!1},resolvePointerUp:iK,setVisible:function(e){iW=e}};const iq={GRINNING:"\uD83D\uDE00",SANTA:"\uD83C\uDF85",SHAKING:"\uD83E\uDEE8"};class iX{#rg;#rS;#rw;#rE;#ry;constructor(e){this.#rg=A(e.minCols,e.maxCols),this.#rS=A(e.minRows,e.maxRows),this.#rw=e.maxRoomCols,this.#rE=e.maxRoomRows}#rT(e=1){let t="";for(;e-- >0;)t+=x(tO.WALL);return t}#rx(e=1){let t="";for(;e-- >0;)t+=x(tO.GROUND);return t}#rA(e=1){let t="";for(;e-- >0;)t+=x(tO.VOID);return t}#rC(e=1){let t="";for(;e-- >0;)t+=x(tO.DOOR_IN);return t}#rI(e=1){let t="";for(;e-- >0;)t+=x(tO.DOOR_OUT);return t}#rO(e){return tO.WALL.includes(e)}#rR(e){return tO.GROUND.includes(e)}#rN(e){return tO.VOID.includes(e)}#rP(e){return tO.DOOR_IN.includes(e)}#rv(e){return tO.DOOR_OUT.includes(e)}generate(){this.#ry=[];let e=0,t=this.#rg;for(;this.#ry.length<this.#rS-4;){let r=e+t-4-2,i=r>0?T(0,r):0,n=Math.max(e-i+4,4),s=Math.min(this.#rw,this.#rg-i),a=s>n?T(n,s):n,o=this.#rg-i-a,l=T(4,Math.min(this.#rE,this.#rS-this.#ry.length));this.#rL(i,a,o,l),e=i,t=a}return this.#rM(),this.#rb(),this.getMatrixAsStrings()}getMatrixAsStrings(){return this.#ry.map(e=>e.join(""))}#rL(e,t,r,i){m.log(`Create room ${e} ${t} ${r} ${i}`);let n="";n+=this.#rA(e)+this.#rT(t)+this.#rA(r),this.#ry.push(n.split(""));for(let s=0;s<i-2;s++)n=""+this.#rA(e)+this.#rT(1)+this.#rx(t-2)+this.#rT(1)+this.#rA(r),this.#ry.push(n.split(""));n=""+this.#rA(e)+this.#rT(t)+this.#rA(r),this.#ry.push(n.split(""))}#rM(){for(let e=1;e<this.#ry.length-1;e++)for(let t=1;t<this.#ry[0].length-2;t++)this.#rO(this.#ry[e][t])&&this.#rO(this.#ry[e+1][t])&&this.#rR(this.#ry[e-1][t])&&this.#rR(this.#ry[e+2][t])&&(this.#ry[e][t]=this.#rx(1),this.#ry[e+1][t]=this.#rx(1))}#rD(e){return this.#rO(e.above)&&this.#rO(e.centre)&&this.#rO(e.below)}#r_(e){return this.#rO(e.left)&&this.#rO(e.centre)&&this.#rO(e.right)}#rb(){let e=[];this.#ry.forEach((t,r)=>t.forEach((t,i)=>{let n=ti(this.#ry,r,i);(this.#r_(n)||this.#rD(n))&&e.push({row:r,col:i})}));let t=tn(e),r=t[0];this.#ry[r.row][r.col]=this.#rC(),r=t[1],this.#ry[r.row][r.col]=this.#rI()}}const iZ={MEDIUM:.25};class ij{#n;#tY;constructor(){this.reset()}getIndex(){return this.#n}getNext(){return this.#n++,0===this.#n&&(c=null),this.#rB(),this.#tY}hasNext(){return!0}reset(){this.#n=-1}restore(e,t){c=t,this.#n=e}#rB(){this.#tY=new ir,this.#rk(),this.#rz(),this.#rG(),this.#rU(),this.#rH(),this.#rF()}#rz(){this.#tY.intro=eY`MESSAGE ENTER LEVEL ${this.#n}`}#rk(){if(!c){let e=tw.findById("hero",["HEROES"]);if(!e)throw Error("Could not find hero in almanacs.");c=t0(e)}this.#tY.hero=c}#rG(e=iZ.MEDIUM){let t=function(e){let t=e*(c?.traits.getCharacterLevel()??1)+.001;return tw.getAlmanac("ENEMIES").filter(e=>e.challengeRating<=t)}(e),r=0,i=0;for(;r<e&&i<8;){let e=t.getRandomEntry();r+=e.challengeRating,i++,this.#tY.enemies.push(e)}}#rU(){for(let e=0;e<1;e++){let e=tw.getRandomEntry("TRADERS",e=>e.minLevel<=this.#n);this.#tY.enemies.push(e)}}#rH(){let e=tw.getPooledAlmanac(["ARTEFACTS","MAGIC","MONEY","WEAPONS"],e=>e.minLevel<=this.#n),t=A(10,10);for(;t-- >0;){let t=e.getRandomEntry();t&&this.#tY.artefacts.push(t)}}#rF(){let e=new iX({minCols:12,maxCols:40,maxRoomCols:10,minRows:12,maxRows:40,maxRoomRows:6});this.#tY.mapDesign=e.generate(),m.debug("Random map"),this.#tY.mapDesign.forEach(e=>m.debug(e))}}const iQ="custom-pointer-down-event",iJ="custom-pointer-up-event",i4="custom-pointer-cancel-event",i0="custom-click-event",i1="custom-conext-click-event",i8="custom-pointer-drag-event",i2={MOUSE:0,TOUCH:1};function i3(e,t,r){let i=new CustomEvent(t,{detail:r});e.dispatchEvent(i)}function i5(e){let t=e.target.getBoundingClientRect();return{x:e.touches[0].pageX-t.left,y:e.touches[0].pageY-t.top}}function i6(e,t,r,i){i.actionStarted=!0,i.dragging=!1,i.distance=0,i.lastX=t,i.lastY=r,i.startX=t,i.startY=r,i3(i.element,iQ,{x:t,y:r})}function i9(e,t,r,i){let n=i.dragging?"custom-pointer-drag-end-event":iJ;i.actionStarted=!1,i.dragging=!1,i.distance=0,i.lastX=t,i.lastY=r,i.startX=t,i.startY=r,i3(i.element,n,{x:t,y:r})}function i7(e,t,r,i){let n=t-i.lastX,s=r-i.lastY;if(i.lastX=t,i.lastY=r,i.dragging){let e=new CustomEvent(i8,{detail:{x:t,y:r,dx:n,dy:s}});i.element.dispatchEvent(e)}else(Math.abs(t-i.startX)>10||Math.abs(r-i.startY)>10)&&(i.dragging=!0,i.suppressClickEvent=!0)}const ne=new Map([["BUTTON ABOUT","About"],["BUTTON BUY FOR GP","Buy for ${0}Â GP"],["BUTTON CANCEL","Cancel"],["BUTTON CAST SPELL","Cast spell"],["BUTTON CONSUME","Consume"],["BUTTON CONTINUE","Continue"],["BUTTON CLIMB OVER","Climb over"],["BUTTON BARGE","Barge past"],["BUTTON BEST ADVENTURE","Best adventure"],["BUTTON DISCARD","Discard"],["BUTTON ENTER DUNGEON","Enter if you dare"],["BUTTON EQUIP","Equip"],["BUTTON FORGET","Forget"],["BUTTON GUIDES","About and Help"],["BUTTON HELP","Help"],["BUTTON INVENTORY","Inventory"],["BUTTON LEARN SPELL","Learn spell"],["BUTTON LEAVE ARTEFACT","Leave"],["BUTTON MAGIC","Magic"],["BUTTON MOVE","Move"],["BUTTON OK","OK"],["BUTTON PILLAGE","Pillage"],["BUTTON PLAY ADVENTURE","Play adventure"],["BUTTON PLAY CASUAL","Play casual"],["BUTTON PRIVACY","Privacy"],["BUTTON PREPARE SPELL","Prepare"],["BUTTON REST","Rest"],["BUTTON REST LONG","Long rest"],["BUTTON READY MAGIC","Ready Magic"],["BUTTON REST SHORT","Short rest"],["BUTTON SEARCH","Search"],["BUTTON SELL FOR GP","Sell for ${0}Â GP"],["BUTTON SETTINGS","Settings"],["BUTTON START","Let's get started."],["BUTTON STASH","Stash"],["BUTTON TAKE ARTEFACT","Take"],["BUTTON TRADE","Trade"],["BUTTON TRAITS","Traits"],["BUTTON TRY AGAIN","Try again"],["BUTTON TO NEXT ROOM","To the next room"],["BUTTON USE","Use"],["CONTROL EFFECTS VOLUME","Effect volume"],["CONTROL MUSIC VOLUME","Music volume"],["DESCRIPTION ACID_SPLASH","Casting this spell hurls acid over your enemies."],["DESCRIPTION CHAIN_MAIL_ARMOUR","Armour comprising interlocking steel rings over a soft cushioning fabric. The suit includes gauntlets."],["DESCRIPTION HALF_PLATE_ARMOUR","Shaped metal plates covering most of the body. Simple greaves protect the legs."],["DESCRIPTION LEATHER_ARMOUR","Simple armour comprising stiffened leather boiled in oil along with some more flexible sections."],["DESCRIPTION PADDED_ARMOUR","Simple quilted layers of cloth and batting."],["DESCRIPTION PLATE_ARMOUR","Full plate armour with interlocking steel plates covering the entire body. A visored helmet, gauntlets, boots, and padding are included."],["DESCRIPTION RING_MAIL_ARMOUR","Leather armour reinforced with heavy steel rings sown into the material."],["DESCRIPTION SCALE_MAIL_ARMOUR","Leather coat and legging covered with overlapping steel scales."],["DESCRIPTION STUDDED_LEATHER_ARMOUR","Tough and flexible leather armour with the addition of steel spikes and rivets."],["DESCRIPTION BURNING_HANDS","Casting this spell with your thumbs touching and fingers spread creates a thin sheet of flames enveloping your enemies."],["DESCRIPTION CLUB","A simple wooden club that's seen a lot of action."],["DESCRIPTION COINS","Various coins stamped with the image of latter day kings and queens."],["DESCRIPTION COPPER_COINS","Old copper coins of low value."],["DESCRIPTION DAGGER","A short and very sharp piercing weapon."],["DESCRIPTION ENGRAVED_PILLAR","A large stone pillar covered with mystical engravings."],["DESCRIPTION BLACK_FLASK","A black flask containing a clear, pungent liquid."],["DESCRIPTION GOBLIN","Small humanoid creature.Treat with caution. They're small but vicious."],["DESCRIPTION GOLD_COINS","Gold coins stamped with the image of latter day kings and queens."],["DESCRIPTION HERO","You are a warrior whose family have fallen out of favour. You have been sent on a quest to recover the Chalice of Dark Sight. If found, your family's good name will be restored."],["DESCRIPTION HIDDEN_ARTEFACT","There might be something hidden here."],["DESCRIPTION IRON_RATIONS","Simple emergency rations. Crucial for resting between rooms."],["DESCRIPTION ORC","A monstrous creature with an intense hatred of humans."],["DESCRIPTION PLATINUM_COINS","Highly valued large platinum."],["DESCRIPTION RAT","A giant rat, diseased and vicious."],["DESCRIPTION SHIELD","A wooden shield, carried in one hand and offering some protection."],["DESCRIPTION SHORTSWORD","A light and highly versatile sword."],["DESCRIPTION SILVER_COINS","Silver coins, worn and tarnished but still of value."],["DESCRIPTION SLIME","A green sticky substance that seems to be growing."],["DESCRIPTION SPIDER","A giant spider with fangs dripping green venom."],["DESCRIPTION TRADER","A wandering trader selling all manner of things gathered during many months in the dungeon."],["DESCRIPTION WATERSKIN","A leather drinking flask with fresh water. Crucial for resting between rooms."],["DIALOG TITLE BEST ADVENTURE","The most lucrative adventure so far"],["DIALOG TITLE CHOICES","Decisions, decisions"],["DIALOG TITLE PICK SPELL TO CAST","Pick spell to cast"],["DIALOG TITLE PREPARE SPELLS","Prepare spells"],["DIALOG TITLE SETTINGS","Adjust settings"],["DIALOG TITLE TRADE","Buy and sell with trader"],["DIALOG TITLE PILLAGE","Pillage corpse"],["MENU TITLE MAIN","Click and Crawl"],["MENU TITLE GUIDES","Guides and information"],["MESSAGE CANNOT LOAD URL","Cannot load data from ${0}"],["MESSAGE CANNOT STORE","You're carrying too much stuff to pick up what you've found."],["MESSAGE CANNOT REST","You try to rest, but you don't have enough resources to restore your health."],["MESSAGE CANNOT REST LONG","You have enough resource for a short rest, but not a long one."],["MESSAGE CONSUME BUT ALREADY FULL HP","Tastes good, but you're already in prime health. Perhaps you should've waited."],["MESSAGE CONSUME BUT NO HP GAIN","Tastes nice, but your health hasn`t improved."],["MESSAGE ENTER LEVEL","You enter level ${0}. The door slams shut behind you. There's no way back."],["MESSAGE EXPLAIN REST","Trying to use the safety of the corridor to rest and eat?"],["MESSAGE DUNGEON INTRO","Welcome, ${0}. You enter a dark and dingy dungeon. Water runs down the wall and the smell of rotting corpses fills the air"],["MESSAGE DUNGEON INTRO CONTINUE","Welcome back, ${0}. The adventure continues, and you enter a dark and dingy dungeon. Water runs down the wall and the smell of rotting corpses fills the air."],["MESSAGE DUNGEON INTRO CASUAL","Welcome, ${0}. You enter a dark and dingy dungeon. Explore as far as you can but remember your progress will not be saved."],["MESSAGE DEFEAT","Despite your valiant efforts, you died. Your legend will live on."],["MESSAGE INSUFFICIENT FUNDS","You don't have enough funds to purchase this item. The item costs ${0}Â GP but you only have ${1}Â GP."],["MESSAGE IT'S A HEALTHY DRINK","That tastes good. +${0}HP"],["MESSAGE IT'S HEALTHY","A bit chewy, but tastes good. +${0}HP"],["MESSAGE KILLED BY POISON","Yuk! Poison! You start to burn up, cough and vomit, before falling to the floor and dying."],["MESSAGE IT'S POISON","Yuk! It's poison. -${0}HP"],["MESSAGE MAKE SPACE IN BACKPACK","You need to make space in your backpack by discarding or using something."],["MESSAGE MAKE SPACE IN EQUIP","This is too big to store. Sell or discard what you're wearing so you can wear this."],["MESSAGE NOTHING MORE TO DISCOVER","There's nothing more for you to learn or discover here."],["MESSAGE RESISTED POISON","Yuk! It's poisonous, but you resist its toxic effects."],["MESSAGE REST DIALOG","You are on a dark staircase leading deeper into the dungeon, but safe for now. If you have enough food or drink, you can rest to restore some health. If you don't need to recover, save your rations. These are the requirements:"],["MESSAGE SEARCH CORPSE OR MOVE",["You have a choice. Do you want to search the body or climb on top?","You've found a corpse, but what should you do? Search for weapons and treasure or climb on top of the body?"]],["MESSAGE SEARCH HOLE OR MOVE",["You have a choice. Do you want to search this hole or move into it?","You've been here before. Do you want to search again or climb into the hole you dug?"]],["MESSAGE SEARCH OR MOVE","You have a choice. Do you want to search this tile or move onto it?"],["MESSAGE SPELL ALREADY KNOWN","You've found a spell, but you already know this incantation."],["MESSAGE TRADE OR BARGE","Do you want to trade or barge past this guy?"],["MESSAGE ENTRANCE STUCK",["The entrance is locked or jammed. You can't tell. Either way, you can't escape in that direction.","You can't open the door. It seems locked or jammed. There's no way back."]],["MESSAGE EXIT STUCK",["The exit is locked. You will need to find the key if you are ever to leave this dungeon.","The door will not move. It appears to be locked. There must be a key here somewhere."]],["MESSAGE EXPLAIN SPELL PREP","After a long rest, you can prepare spells ready for use."],["MESSAGE FOUND HIDDEN ARTEFACT",["Good fortune smiles upon you. You found something.","You find something hidden in the ground.","Buried beneath the surface, you find something."]],["MESSAGE FOUND ENGRAVING","You find strange word engraved on the cold stone surface."],["MESSAGE FOUND GENERIC","It 's your lucky day. You' found something."],["MESSAGE GROUND DISTURBED",["The ground appears to have been disturbed.","There's been some recent digging here."]],["MESSAGE NO SAVED ADVENTURE","No adventure has been saved yet."],["MESSAGE OPEN EXIT",["The door opens and you slip away.","You decide that's enough exploring this dungeon and slip away into the darkness."]],["MESSAGE OPEN EXIT WHILE FIGHTING",["A dangerous move, but despite the fighting, you manage to escape.","Dodging a blow, you manage to open the door and make your escape."]],["MESSAGE WELCOME","Welcome to the Click and Crawl old-school dungeon crawler. How far will you get?"],["MESSAGE VICTORY","You have conquered the dungeon. Your name will live on forever and generations will sing of your great achievements."],["LONG REST REQ","Long rest: drinks: ${0}; meals: ${1}"],["SHORT REST REQ","Short rest: drinks: ${0}; meals: ${1}; hit dice: 1"],["AC (including armour)","AC (+armour): ${0}"],["Backpack","Backpack"],["Body","Body"],["Cantrips","Cantrips"],["Consumables","Consumables"],["Character level:","Character level: ${0}"],["CHARACTER LEVEL:","level: ${0}"],["(DEAD)","(DEAD!)"],["Dungeon level:","Dungeon level: ${0}"],["Experience:","Experience: ${0}"],["Feet","Feet"],["Gold:","Gold: ${0}Â GP"],["GOLD PIECES"," gold pieces"],["Hands","Hands"],["Head","Head"],["(HP OUT OF VALUE)","(HP:Â ${0}/${1})"],["(HP VALUE)","(HP:Â ${0})"],["Known spells","Known spells"],["LEVEL UP","Level up to ${0}"],["Name:","Name: ${0}"],["Prepared spells","Prepared spells"],["Ready magic","Ready magic"],["Unknown","Unknown"],["Wagon","Wagon"]]);let nt=!0,nr=!0;function ni(e){e!==nt&&(nt=e,m.info(`Set animation state to ${nt}`),nt&&nn())}function nn(){m.info("Start animations"),window.requestAnimationFrame(ns)}function ns(e){if(em.updateTimeNow(e),u){var t;let r=(e-u)/1e3;io.update(r),iY.update(r),eh.showFps&&(t=1/r,el(Q.getContext2D(),`FPS: ${Math.round(t)}`,{x:0,y:Q.getCanvasDimensions().height},{color:"green"}))}u=e,nt?window.requestAnimationFrame(ns):m.info("Animation paused")}var na={TILE_SIZE:48,initialise:async function(e){Q.setOptions(e),eq.setMap(ne),function(e){let t=0;for(let r in iq){let i=e.measureText(iq[r]),n=i.fontBoundingBoxAscent+i.fontBoundingBoxDescent,s=.5*n-i.fontBoundingBoxDescent;e.fillText(iq[r],-.5*i.width,s),e.getImageData(0,0,1,1).data[3]<=0&&(m.debug(`Emoji ${r} not supported.`),iq[r]=`[${t++}]`),e.clearRect(0,0,i.width,n)}}(Q.getContext2D()),function(){let e;let t=Q.getCanvas();e={element:t,actionStarted:!1,dragging:!1,x:0,y:0,lastTouchStartPoint:null,suppressClickEvent:!1},t.addEventListener("mousedown",t=>i6(i2.MOUSE,t.offsetX,t.offsetY,e),{passive:!0}),t.addEventListener("mouseup",t=>i9(i2.MOUSE,t.offsetX,t.offsetY,e),{passive:!0}),t.addEventListener("mousemove",t=>{1&t.buttons&&i7(i2.MOUSE,t.offsetX,t.offsetY,e)},{passive:!0}),t.addEventListener("touchstart",t=>{if(1===t.changedTouches.length){let r=i5(t);e.lastTouchStartPoint=new O(r.x,r.y),i6(i2.TOUCH,r.x,r.y,e)}},{passive:!0}),t.addEventListener("touchend",t=>{1===t.changedTouches.length&&i9(i2.TOUCH,e.lastTouchStartPoint?.x,e.lastTouchStartPoint?.y,e),e.lastTouchStartPoint=null,e.suppressClickEvent=!1},{passive:!0}),t.addEventListener("touchmove",t=>{if(1===t.changedTouches.length){let r=i5(t);i7(i2.TOUCH,r.x,r.y,e),e.suppressClickEvent=!0}},{passive:!0}),t.addEventListener("touchcancel",t=>{var r,i;i2.TOUCH,r=e.lastTouchStartPoint?.x,i=e.lastTouchStartPoint?.y,e.actionStarted=!1,e.dragging=!1,e.distance=0,e.lastX=r,e.lastY=i,e.startX=r,e.startY=i,i3(e.element,i4,{x:r,y:i}),e.lastTouchStartPoint=null},{passive:!0}),t.addEventListener("click",r=>{m.debug("click"),e.suppressClickEvent||i3(t,i0,{x:r.offsetX,y:r.offsetY}),e.suppressClickEvent=!1}),t.addEventListener("contextmenu",e=>{e.preventDefault(),i3(t,i1,{x:e.offsetX,y:e.offsetY})}),t.addEventListener(i0,e=>{let t=e.detail.x,r=e.detail.y,i=Q.uiCoordsToMappedPositions(t,r);iY.resolveClick(i)||eo.resolveClick(i)}),t.addEventListener(iQ,e=>{let t=e.detail.x,r=e.detail.y,i=Q.uiCoordsToMappedPositions(t,r);iY.resolvePointerDown(i)}),t.addEventListener(iJ,e=>{let t=e.detail.x,r=e.detail.y,i=Q.uiCoordsToMappedPositions(t,r);iY.resolvePointerUp(i)}),t.addEventListener(i4,e=>{let t=e.detail.x,r=e.detail.y,i=Q.uiCoordsToMappedPositions(t,r);iY.resolvePointerCancel(i)}),t.addEventListener(i8,e=>{io.panCameraBy(-e.detail.dx,-e.detail.dy)}),t.addEventListener(i1,e=>{let t=e.detail.x,r=e.detail.y,i=Q.uiCoordsToMappedPositions(t,r);iY.resolveContextMenu(i)||eo.resolveContextMenu(i),e.preventDefault()})}(),eJ.setPreDialogFunction(()=>ni(!1)),eJ.setPostDialogFunction(()=>ni(!0)),t$.forEach(e=>{if(e.label=eq.getText(e.labelKey),e.persistent&e.onChange){let t=ek.get(e.id,e.defValue);e.onChange(t)}}),eJ.showOkDialog(eY`MESSAGE WELCOME`,{okButtonLabel:eY`BUTTON START`,className:"door"}).then(()=>e4.loadAndPlayMusic(rR.MUSIC)).then(()=>e4.loadEffects(rR.SOUND_EFFECTS_MAP)).then(()=>ed.loadSpriteMap(rP.data,rP.textureUrl)).then(()=>tm(rR.DUNGEON_SCRIPT)).then(e=>io.setSceneList(new ij)).then(()=>(function(e){let t=[];return e.forEach((e,r)=>{let i=tm(e).then(e=>{tw.addAlmanac(r,function(e,t){let r=new tg;return e.split(/[\r\n]+/).forEach(e=>{if(""!==(e=e.trim())&&!e.startsWith("#")){let i=tS(e,t);if(i)switch(i.rarity){case tf.VERY_RARE:r.veryRare.push(i);break;case tf.RARE:r.rare.push(i);break;case tf.UNCOMMON:r.uncommon.push(i);break;case tf.COMMON:default:r.common.push(i)}}}),r}(e,r))});t.push(i)}),Promise.all(t)})(rR.ALMANAC_MAP)).then(()=>rJ.triggerEvent(rJ.EventId.MAIN_MENU)).then(()=>nn()).then(()=>{window.addEventListener("blur",()=>{nr=nt,ni(!1)}),window.addEventListener("focus",()=>{ni(nr??!0)})}).catch(e=>{m.error(e),alert(`Fatal error in main game. ${e.message}`)})},setAnimationState:ni};window.addEventListener("load",()=>{try{na.initialise({width:800,height:600,maxScale:2.4,minScale:1,sizingMethod:"COVER",alpha:!1})}catch(e){m.fatal(e)}});
//# sourceMappingURL=index.757df880.js.map
